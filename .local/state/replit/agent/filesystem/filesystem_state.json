{"file_contents":{"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport session from \"express-session\";\nimport MemoryStore from \"memorystore\";\nimport { registerRoutes } from \"./routes\";\nimport { serveStatic } from \"./static\";\nimport { createServer } from \"http\";\n\nconst app = express();\nconst httpServer = createServer(app);\n\nconst MemStore = MemoryStore(session);\n\ndeclare module \"http\" {\n  interface IncomingMessage {\n    rawBody: unknown;\n  }\n}\n\napp.use(\n  express.json({\n    verify: (req, _res, buf) => {\n      req.rawBody = buf;\n    },\n  }),\n);\n\napp.use(express.urlencoded({ extended: false }));\n\napp.use(\n  session({\n    secret: process.env.SESSION_SECRET || \"mnetifi-secret-key-change-in-production\",\n    resave: false,\n    saveUninitialized: false,\n    store: new MemStore({\n      checkPeriod: 86400000,\n    }),\n    cookie: {\n      secure: process.env.NODE_ENV === \"production\",\n      httpOnly: true,\n      maxAge: 24 * 60 * 60 * 1000,\n      sameSite: \"lax\",\n    },\n  })\n);\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  await registerRoutes(httpServer, app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (process.env.NODE_ENV === \"production\") {\n    serveStatic(app);\n  } else {\n    const { setupVite } = await import(\"./vite\");\n    await setupVite(httpServer, app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || \"5000\", 10);\n  httpServer.listen(\n    {\n      port,\n      host: \"0.0.0.0\",\n      reusePort: true,\n    },\n    () => {\n      log(`serving on port ${port}`);\n    },\n  );\n})();\n","path":null,"size_bytes":3059,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/components/glass-panel.tsx":{"content":"import { cn } from \"@/lib/utils\";\nimport { motion, type HTMLMotionProps } from \"framer-motion\";\nimport { forwardRef } from \"react\";\n\ninterface GlassPanelProps extends HTMLMotionProps<\"div\"> {\n  hover?: boolean;\n  glow?: \"cyan\" | \"purple\" | \"magenta\" | \"mpesa\" | \"none\";\n  size?: \"sm\" | \"md\" | \"lg\";\n}\n\nexport const GlassPanel = forwardRef<HTMLDivElement, GlassPanelProps>(\n  ({ className, children, hover = false, glow = \"none\", size = \"md\", ...props }, ref) => {\n    const sizeClasses = {\n      sm: \"p-4 rounded-xl\",\n      md: \"p-6 rounded-2xl\",\n      lg: \"p-8 rounded-3xl\",\n    };\n\n    const glowClasses = {\n      none: \"\",\n      cyan: \"shadow-glow\",\n      purple: \"shadow-glow-purple\",\n      magenta: \"shadow-glow-magenta\",\n      mpesa: \"shadow-glow-mpesa\",\n    };\n\n    return (\n      <motion.div\n        ref={ref}\n        className={cn(\n          \"glass-panel\",\n          sizeClasses[size],\n          glowClasses[glow],\n          hover && \"glass-panel-hover cursor-pointer\",\n          className\n        )}\n        whileHover={hover ? { y: -4 } : undefined}\n        transition={{ type: \"spring\", stiffness: 400, damping: 25 }}\n        {...props}\n      >\n        {children}\n      </motion.div>\n    );\n  }\n);\n\nGlassPanel.displayName = \"GlassPanel\";\n\n// Glass Card variant for plan cards with gradient top border\ninterface GlassCardProps extends GlassPanelProps {\n  gradient?: \"primary\" | \"accent\" | \"mpesa\";\n  selected?: boolean;\n}\n\nexport const GlassCard = forwardRef<HTMLDivElement, GlassCardProps>(\n  ({ className, children, gradient, selected = false, ...props }, ref) => {\n    const gradientClasses = {\n      primary: \"before:bg-gradient-primary\",\n      accent: \"before:bg-gradient-accent\",\n      mpesa: \"before:bg-gradient-mpesa\",\n    };\n\n    return (\n      <GlassPanel\n        ref={ref}\n        className={cn(\n          \"relative overflow-visible\",\n          gradient && [\n            \"before:absolute before:inset-x-0 before:top-0 before:h-1 before:rounded-t-2xl\",\n            gradientClasses[gradient],\n          ],\n          selected && \"ring-2 ring-primary ring-offset-2 ring-offset-background\",\n          className\n        )}\n        hover\n        {...props}\n      >\n        {children}\n      </GlassPanel>\n    );\n  }\n);\n\nGlassCard.displayName = \"GlassCard\";\n","path":null,"size_bytes":2271,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1202,"size_tokens":null},"client/src/components/transaction-list.tsx":{"content":"import { motion, AnimatePresence } from \"framer-motion\";\nimport { Phone, Calendar, Receipt, MapPin } from \"lucide-react\";\nimport { StatusBadge, StatusDot } from \"./status-badge\";\nimport { cn } from \"@/lib/utils\";\nimport type { Transaction, Plan } from \"@shared/schema\";\n\ninterface TransactionItemProps {\n  transaction: Transaction;\n  plan?: Plan;\n  showDetails?: boolean;\n}\n\nexport function TransactionItem({ transaction, plan, showDetails = false }: TransactionItemProps) {\n  const formatPhone = (phone: string) => {\n    if (phone.startsWith(\"254\")) {\n      return `+${phone.slice(0, 3)} ${phone.slice(3, 6)} ${phone.slice(6)}`;\n    }\n    return phone;\n  };\n\n  const formatDate = (date: Date | string | null) => {\n    if (!date) return \"N/A\";\n    const d = new Date(date);\n    return d.toLocaleDateString(\"en-KE\", {\n      month: \"short\",\n      day: \"numeric\",\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n    });\n  };\n\n  const formatAmount = (amount: number) => {\n    return new Intl.NumberFormat(\"en-KE\", {\n      style: \"currency\",\n      currency: \"KES\",\n      minimumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  return (\n    <motion.div\n      className={cn(\n        \"rounded-xl bg-white/5 backdrop-blur-sm border border-white/10\",\n        \"hover:bg-white/8 hover:border-white/15 transition-all duration-200\",\n        \"p-4\"\n      )}\n      initial={{ opacity: 0, y: 10 }}\n      animate={{ opacity: 1, y: 0 }}\n      exit={{ opacity: 0, y: -10 }}\n      whileHover={{ scale: 1.01 }}\n      data-testid={`transaction-item-${transaction.id}`}\n    >\n      <div className=\"flex items-start justify-between gap-4\">\n        <div className=\"flex items-start gap-3\">\n          {/* Status indicator */}\n          <div className=\"mt-1\">\n            <StatusDot status={transaction.status as \"PENDING\" | \"COMPLETED\" | \"FAILED\"} />\n          </div>\n\n          <div className=\"space-y-1\">\n            {/* Phone number */}\n            <div className=\"flex items-center gap-2\">\n              <Phone size={14} className=\"text-muted-foreground\" />\n              <span className=\"text-white font-medium\">\n                {formatPhone(transaction.userPhone)}\n              </span>\n            </div>\n\n            {/* Date */}\n            <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n              <Calendar size={12} />\n              <span>{formatDate(transaction.createdAt)}</span>\n            </div>\n\n            {showDetails && (\n              <>\n                {/* Receipt number */}\n                {transaction.mpesaReceiptNumber && (\n                  <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                    <Receipt size={12} />\n                    <span className=\"font-mono text-xs\">\n                      {transaction.mpesaReceiptNumber}\n                    </span>\n                  </div>\n                )}\n\n                {/* NAS IP */}\n                {transaction.nasIp && (\n                  <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                    <MapPin size={12} />\n                    <span className=\"font-mono text-xs\">{transaction.nasIp}</span>\n                  </div>\n                )}\n              </>\n            )}\n          </div>\n        </div>\n\n        <div className=\"text-right space-y-2\">\n          {/* Amount */}\n          <span className=\"text-lg font-semibold gradient-text\">\n            {formatAmount(transaction.amount)}\n          </span>\n\n          {/* Status badge */}\n          <div>\n            <StatusBadge\n              status={transaction.status as \"PENDING\" | \"COMPLETED\" | \"FAILED\"}\n              size=\"sm\"\n            />\n          </div>\n        </div>\n      </div>\n\n      {/* Plan info */}\n      {plan && (\n        <div className=\"mt-3 pt-3 border-t border-white/5\">\n          <span className=\"text-sm text-muted-foreground\">\n            Plan: <span className=\"text-white\">{plan.name}</span>\n          </span>\n        </div>\n      )}\n    </motion.div>\n  );\n}\n\n// Transaction list component\ninterface TransactionListProps {\n  transactions: Transaction[];\n  plans?: Map<string, Plan>;\n  showDetails?: boolean;\n  emptyMessage?: string;\n}\n\nexport function TransactionList({\n  transactions,\n  plans,\n  showDetails = false,\n  emptyMessage = \"No transactions yet\",\n}: TransactionListProps) {\n  if (transactions.length === 0) {\n    return (\n      <div\n        className=\"text-center py-12 text-muted-foreground\"\n        data-testid=\"transactions-empty\"\n      >\n        <Receipt size={48} className=\"mx-auto mb-4 opacity-50\" />\n        <p>{emptyMessage}</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-3\" data-testid=\"transaction-list\">\n      <AnimatePresence mode=\"popLayout\">\n        {transactions.map((transaction) => (\n          <TransactionItem\n            key={transaction.id}\n            transaction={transaction}\n            plan={plans?.get(transaction.planId || \"\")}\n            showDetails={showDetails}\n          />\n        ))}\n      </AnimatePresence>\n    </div>\n  );\n}\n\n// Transaction list skeleton\nexport function TransactionListSkeleton({ count = 3 }: { count?: number }) {\n  return (\n    <div className=\"space-y-3\" data-testid=\"transaction-list-skeleton\">\n      {Array.from({ length: count }).map((_, i) => (\n        <div\n          key={i}\n          className=\"rounded-xl bg-white/5 border border-white/10 p-4 animate-pulse\"\n        >\n          <div className=\"flex items-start justify-between gap-4\">\n            <div className=\"flex items-start gap-3\">\n              <div className=\"w-3 h-3 rounded-full bg-white/10 mt-1\" />\n              <div className=\"space-y-2\">\n                <div className=\"h-5 w-32 bg-white/10 rounded\" />\n                <div className=\"h-4 w-24 bg-white/10 rounded\" />\n              </div>\n            </div>\n            <div className=\"text-right space-y-2\">\n              <div className=\"h-6 w-20 bg-white/10 rounded\" />\n              <div className=\"h-6 w-16 bg-white/10 rounded-full\" />\n            </div>\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n}\n","path":null,"size_bytes":6068,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"client/src/components/plan-card.tsx":{"content":"import { motion } from \"framer-motion\";\nimport { Clock, Download, Upload, Users, Check } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport type { Plan } from \"@shared/schema\";\n\ninterface BrandingColors {\n  primary?: string;\n  secondary?: string;\n}\n\ninterface PlanCardProps {\n  plan: Plan;\n  selected?: boolean;\n  onSelect?: (plan: Plan) => void;\n  showDetails?: boolean;\n  brandingColor?: string | BrandingColors;\n}\n\nexport function PlanCard({ plan, selected = false, onSelect, showDetails = true, brandingColor }: PlanCardProps) {\n  const getBrandingColors = (): { primary: string; secondary: string } => {\n    if (typeof brandingColor === 'string') {\n      return { primary: brandingColor, secondary: \"#3b82f6\" };\n    }\n    if (brandingColor && typeof brandingColor === 'object') {\n      return { \n        primary: brandingColor.primary || \"#06b6d4\", \n        secondary: brandingColor.secondary || \"#3b82f6\" \n      };\n    }\n    return { primary: \"#06b6d4\", secondary: \"#3b82f6\" };\n  };\n  \n  const { primary: primaryColor, secondary: secondaryColor } = getBrandingColors();\n  // Format duration for display\n  const formatDuration = (seconds: number) => {\n    if (seconds < 3600) {\n      return `${Math.floor(seconds / 60)} min`;\n    } else if (seconds < 86400) {\n      const hours = Math.floor(seconds / 3600);\n      return `${hours} hour${hours > 1 ? \"s\" : \"\"}`;\n    } else {\n      const days = Math.floor(seconds / 86400);\n      return `${days} day${days > 1 ? \"s\" : \"\"}`;\n    }\n  };\n\n  // Format price for display (KES)\n  const formatPrice = (amount: number) => {\n    return new Intl.NumberFormat(\"en-KE\", {\n      style: \"currency\",\n      currency: \"KES\",\n      minimumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  return (\n    <motion.div\n      className={cn(\n        \"relative overflow-hidden rounded-2xl cursor-pointer\",\n        \"bg-white/5 backdrop-blur-xl border transition-all duration-300\",\n        selected\n          ? \"ring-2\"\n          : \"border-white/10 hover:border-white/20\",\n        \"group\"\n      )}\n      style={{\n        borderColor: selected ? `${primaryColor}80` : undefined,\n        boxShadow: selected ? `0 0 0 2px ${primaryColor}30` : undefined,\n      }}\n      onClick={() => onSelect?.(plan)}\n      whileHover={{ y: -4, scale: 1.02 }}\n      whileTap={{ scale: 0.98 }}\n      transition={{ type: \"spring\", stiffness: 400, damping: 25 }}\n      data-testid={`plan-card-${plan.id}`}\n    >\n      <div\n        className={cn(\n          \"absolute inset-x-0 top-0 h-1 transition-opacity duration-300\",\n          selected ? \"opacity-100\" : \"opacity-0 group-hover:opacity-100\"\n        )}\n        style={{\n          background: `linear-gradient(90deg, ${primaryColor} 0%, ${secondaryColor} 100%)`,\n        }}\n      />\n\n      {selected && (\n        <motion.div\n          className=\"absolute top-3 right-3 w-6 h-6 rounded-full flex items-center justify-center\"\n          style={{ backgroundColor: primaryColor }}\n          initial={{ scale: 0 }}\n          animate={{ scale: 1 }}\n          transition={{ type: \"spring\", stiffness: 500, damping: 25 }}\n        >\n          <Check size={14} className=\"text-white\" strokeWidth={3} />\n        </motion.div>\n      )}\n\n      <div className=\"p-6\">\n        {/* Plan name */}\n        <h3 className=\"text-lg font-semibold text-white mb-2\">{plan.name}</h3>\n\n        {/* Price */}\n        <div className=\"mb-4\">\n          <span className=\"text-3xl font-bold gradient-text\">\n            {formatPrice(plan.price)}\n          </span>\n        </div>\n\n        {/* Duration */}\n        <div className=\"flex items-center gap-2 text-muted-foreground mb-4\">\n          <Clock size={16} />\n          <span className=\"text-sm\">{formatDuration(plan.durationSeconds)}</span>\n        </div>\n\n        {showDetails && (\n          <div className=\"space-y-2 pt-4 border-t border-white/10\">\n            {/* Upload limit */}\n            {plan.uploadLimit && (\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                <Upload size={14} className=\"text-cyan-400\" />\n                <span>Upload: {plan.uploadLimit}</span>\n              </div>\n            )}\n\n            {/* Download limit */}\n            {plan.downloadLimit && (\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                <Download size={14} className=\"text-blue-400\" />\n                <span>Download: {plan.downloadLimit}</span>\n              </div>\n            )}\n\n            {/* Simultaneous use */}\n            {plan.simultaneousUse && (\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                <Users size={14} className=\"text-purple-400\" />\n                <span>{plan.simultaneousUse} device{plan.simultaneousUse > 1 ? \"s\" : \"\"}</span>\n              </div>\n            )}\n          </div>\n        )}\n\n        {/* Description */}\n        {plan.description && (\n          <p className=\"mt-4 text-sm text-muted-foreground\">{plan.description}</p>\n        )}\n      </div>\n    </motion.div>\n  );\n}\n\n// Plan card skeleton for loading state\nexport function PlanCardSkeleton() {\n  return (\n    <div\n      className=\"rounded-2xl bg-white/5 backdrop-blur-xl border border-white/10 p-6 animate-pulse\"\n      data-testid=\"plan-card-skeleton\"\n    >\n      <div className=\"h-6 w-24 bg-white/10 rounded mb-2\" />\n      <div className=\"h-10 w-20 bg-white/10 rounded mb-4\" />\n      <div className=\"h-4 w-16 bg-white/10 rounded mb-4\" />\n      <div className=\"space-y-2 pt-4 border-t border-white/10\">\n        <div className=\"h-4 w-32 bg-white/10 rounded\" />\n        <div className=\"h-4 w-28 bg-white/10 rounded\" />\n      </div>\n    </div>\n  );\n}\n\n// Compact plan card for transaction display\ninterface CompactPlanCardProps {\n  plan: Plan;\n}\n\nexport function CompactPlanCard({ plan }: CompactPlanCardProps) {\n  const formatDuration = (seconds: number) => {\n    if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;\n    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;\n    return `${Math.floor(seconds / 86400)}d`;\n  };\n\n  return (\n    <div\n      className=\"inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 border border-white/10\"\n      data-testid={`compact-plan-${plan.id}`}\n    >\n      <span className=\"text-sm font-medium text-white\">{plan.name}</span>\n      <span className=\"text-xs text-muted-foreground\">\n        {formatDuration(plan.durationSeconds)}\n      </span>\n    </div>\n  );\n}\n","path":null,"size_bytes":6450,"size_tokens":null},"client/src/pages/settings.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { motion } from \"framer-motion\";\nimport { Building2, Key, Palette, Save, Eye, EyeOff, Upload, Wifi, MessageSquare, Globe, Mail, Phone } from \"lucide-react\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Tenant } from \"@shared/schema\";\n\nconst defaultColors = {\n  cyan: \"#22d3ee\",\n  purple: \"#a855f7\",\n  green: \"#22c55e\",\n  blue: \"#3b82f6\",\n  orange: \"#f97316\",\n  pink: \"#ec4899\",\n};\n\nexport default function SettingsPage() {\n  const { toast } = useToast();\n  const [showSecrets, setShowSecrets] = useState(false);\n\n  const { data: tenant, isLoading } = useQuery<Tenant>({\n    queryKey: [\"/api/tenant\"],\n  });\n\n  const [formData, setFormData] = useState({\n    name: \"\",\n    subdomain: \"\",\n    website: \"\",\n    email: \"\",\n    phone: \"\",\n    mpesaShortcode: \"\",\n    mpesaPasskey: \"\",\n    mpesaConsumerKey: \"\",\n    mpesaConsumerSecret: \"\",\n    smsProvider: \"mock\",\n    smsApiKey: \"\",\n    smsUsername: \"\",\n    smsSenderId: \"\",\n  });\n\n  const [brandingData, setBrandingData] = useState({\n    logo: \"\",\n    primaryColor: \"#22d3ee\",\n    secondaryColor: \"#a855f7\",\n  });\n\n  useEffect(() => {\n    if (tenant) {\n      setFormData({\n        name: tenant.name || \"\",\n        subdomain: tenant.subdomain || \"\",\n        website: tenant.website || \"\",\n        email: tenant.email || \"\",\n        phone: tenant.phone || \"\",\n        mpesaShortcode: tenant.mpesaShortcode || \"\",\n        mpesaPasskey: tenant.mpesaPasskey || \"\",\n        mpesaConsumerKey: tenant.mpesaConsumerKey || \"\",\n        mpesaConsumerSecret: tenant.mpesaConsumerSecret || \"\",\n        smsProvider: tenant.smsProvider || \"mock\",\n        smsApiKey: tenant.smsApiKey || \"\",\n        smsUsername: tenant.smsUsername || \"\",\n        smsSenderId: tenant.smsSenderId || \"\",\n      });\n      const branding = tenant.brandingConfig || {};\n      setBrandingData({\n        logo: branding.logo || \"\",\n        primaryColor: branding.primaryColor || \"#22d3ee\",\n        secondaryColor: branding.secondaryColor || \"#a855f7\",\n      });\n    }\n  }, [tenant]);\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: { formData: typeof formData; brandingData: typeof brandingData }) => {\n      return apiRequest(\"PATCH\", \"/api/tenant\", {\n        ...data.formData,\n        brandingConfig: data.brandingData,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tenant\"] });\n      toast({\n        title: \"Settings Saved\",\n        description: \"Your settings have been updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save settings\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    saveMutation.mutate({ formData, brandingData });\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"settings-page\">\n      <div>\n        <h1 className=\"text-2xl font-bold text-white\">Settings</h1>\n        <p className=\"text-muted-foreground\">\n          Configure your organization, branding, and M-Pesa integration\n        </p>\n      </div>\n\n      <form onSubmit={handleSubmit} className=\"space-y-6\">\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center gap-3 mb-6\">\n            <div className=\"p-2 rounded-lg bg-cyan-500/20\">\n              <Building2 size={20} className=\"text-cyan-400\" />\n            </div>\n            <div>\n              <h2 className=\"text-lg font-semibold text-white\">Organization</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Basic information about your organization\n              </p>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            <GlassInput\n              label=\"Organization Name\"\n              placeholder=\"Your Company Name\"\n              value={formData.name}\n              onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n              data-testid=\"input-org-name\"\n            />\n            <div className=\"space-y-2\">\n              <GlassInput\n                label=\"Subdomain\"\n                placeholder=\"yourcompany\"\n                value={formData.subdomain}\n                onChange={(e) => setFormData({ ...formData, subdomain: e.target.value })}\n                data-testid=\"input-subdomain\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Your portal will be: <span className=\"text-cyan-400\">{formData.subdomain || 'yourcompany'}.mnetifi.com</span>\n              </p>\n            </div>\n            <GlassInput\n              label=\"Website\"\n              placeholder=\"https://www.yourcompany.com\"\n              value={formData.website}\n              onChange={(e) => setFormData({ ...formData, website: e.target.value })}\n              icon={<Globe size={16} />}\n              data-testid=\"input-website\"\n            />\n            <GlassInput\n              label=\"Email Address\"\n              placeholder=\"info@yourcompany.com\"\n              value={formData.email}\n              onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n              icon={<Mail size={16} />}\n              data-testid=\"input-email\"\n            />\n            <GlassInput\n              label=\"Phone Number\"\n              placeholder=\"+254 700 123 456\"\n              value={formData.phone}\n              onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n              icon={<Phone size={16} />}\n              data-testid=\"input-phone\"\n            />\n          </div>\n        </GlassPanel>\n\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center gap-3 mb-6\">\n            <div className=\"p-2 rounded-lg bg-purple-500/20\">\n              <Palette size={20} className=\"text-purple-400\" />\n            </div>\n            <div>\n              <h2 className=\"text-lg font-semibold text-white\">Branding & Customization</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Customize how your captive portal appears to customers\n              </p>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            <div className=\"space-y-2\">\n              <Label className=\"text-muted-foreground\">Logo URL</Label>\n              <GlassInput\n                placeholder=\"https://example.com/logo.png\"\n                value={brandingData.logo}\n                onChange={(e) => setBrandingData({ ...brandingData, logo: e.target.value })}\n                icon={<Upload size={16} />}\n                data-testid=\"input-logo-url\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Enter a URL to your logo image (recommended: 200x60px PNG)\n              </p>\n            </div>\n\n            <div className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label className=\"text-muted-foreground\">Primary Color</Label>\n                <div className=\"flex items-center gap-3\">\n                  <input\n                    type=\"color\"\n                    value={brandingData.primaryColor}\n                    onChange={(e) => setBrandingData({ ...brandingData, primaryColor: e.target.value })}\n                    className=\"w-12 h-9 rounded-md border border-white/10 bg-transparent cursor-pointer\"\n                    data-testid=\"input-primary-color\"\n                  />\n                  <div className=\"flex gap-2\">\n                    {Object.entries(defaultColors).map(([name, color]) => (\n                      <button\n                        key={name}\n                        type=\"button\"\n                        onClick={() => setBrandingData({ ...brandingData, primaryColor: color })}\n                        className=\"w-6 h-6 rounded-full border-2 border-white/20 transition-transform hover:scale-110\"\n                        style={{ backgroundColor: color }}\n                        title={name}\n                        data-testid={`color-preset-${name}`}\n                      />\n                    ))}\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label className=\"text-muted-foreground\">Secondary Color</Label>\n                <div className=\"flex items-center gap-3\">\n                  <input\n                    type=\"color\"\n                    value={brandingData.secondaryColor}\n                    onChange={(e) => setBrandingData({ ...brandingData, secondaryColor: e.target.value })}\n                    className=\"w-12 h-9 rounded-md border border-white/10 bg-transparent cursor-pointer\"\n                    data-testid=\"input-secondary-color\"\n                  />\n                  <div className=\"flex gap-2\">\n                    {Object.entries(defaultColors).map(([name, color]) => (\n                      <button\n                        key={name}\n                        type=\"button\"\n                        onClick={() => setBrandingData({ ...brandingData, secondaryColor: color })}\n                        className=\"w-6 h-6 rounded-full border-2 border-white/20 transition-transform hover:scale-110\"\n                        style={{ backgroundColor: color }}\n                        title={name}\n                        data-testid={`color-secondary-preset-${name}`}\n                      />\n                    ))}\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"mt-6 p-6 rounded-xl bg-mesh-navy/50 border border-white/5\">\n            <p className=\"text-xs text-muted-foreground mb-4 text-center\">Captive Portal Preview</p>\n            <motion.div\n              className=\"text-center\"\n              initial={{ opacity: 0, scale: 0.95 }}\n              animate={{ opacity: 1, scale: 1 }}\n            >\n              {brandingData.logo ? (\n                <img\n                  src={brandingData.logo}\n                  alt=\"Logo\"\n                  className=\"h-12 mx-auto mb-4 object-contain\"\n                  onError={(e) => {\n                    e.currentTarget.style.display = 'none';\n                  }}\n                />\n              ) : (\n                <div className=\"flex items-center justify-center gap-2 mb-4\">\n                  <div\n                    className=\"w-10 h-10 rounded-xl flex items-center justify-center\"\n                    style={{ backgroundColor: `${brandingData.primaryColor}20` }}\n                  >\n                    <Wifi size={24} style={{ color: brandingData.primaryColor }} />\n                  </div>\n                  <span\n                    className=\"text-2xl font-bold\"\n                    style={{\n                      background: `linear-gradient(135deg, ${brandingData.primaryColor}, ${brandingData.secondaryColor})`,\n                      WebkitBackgroundClip: 'text',\n                      WebkitTextFillColor: 'transparent',\n                    }}\n                  >\n                    {formData.name || \"Your ISP\"}\n                  </span>\n                </div>\n              )}\n              <p className=\"text-muted-foreground text-sm\">\n                Connect to {formData.name || \"Your Organization\"} Wi-Fi\n              </p>\n              <button\n                type=\"button\"\n                className=\"mt-4 px-6 py-2 rounded-xl text-white font-medium transition-all\"\n                style={{\n                  background: `linear-gradient(135deg, ${brandingData.primaryColor}, ${brandingData.secondaryColor})`,\n                }}\n              >\n                Select Plan\n              </button>\n            </motion.div>\n          </div>\n        </GlassPanel>\n\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center justify-between mb-6\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 rounded-lg bg-green-500/20\">\n                <Key size={20} className=\"text-green-400\" />\n              </div>\n              <div>\n                <h2 className=\"text-lg font-semibold text-white\">M-Pesa Integration</h2>\n                <p className=\"text-sm text-muted-foreground\">\n                  Safaricom Daraja API credentials\n                </p>\n              </div>\n            </div>\n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => setShowSecrets(!showSecrets)}\n              data-testid=\"button-toggle-secrets\"\n            >\n              {showSecrets ? (\n                <>\n                  <EyeOff size={16} className=\"mr-2\" />\n                  Hide\n                </>\n              ) : (\n                <>\n                  <Eye size={16} className=\"mr-2\" />\n                  Show\n                </>\n              )}\n            </Button>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            <GlassInput\n              label=\"Business Shortcode\"\n              placeholder=\"174379\"\n              value={formData.mpesaShortcode}\n              onChange={(e) => setFormData({ ...formData, mpesaShortcode: e.target.value })}\n              data-testid=\"input-shortcode\"\n            />\n            <GlassInput\n              label=\"Passkey\"\n              type={showSecrets ? \"text\" : \"password\"}\n              placeholder=\"Your Passkey\"\n              value={formData.mpesaPasskey}\n              onChange={(e) => setFormData({ ...formData, mpesaPasskey: e.target.value })}\n              data-testid=\"input-passkey\"\n            />\n            <GlassInput\n              label=\"Consumer Key\"\n              type={showSecrets ? \"text\" : \"password\"}\n              placeholder=\"Your Consumer Key\"\n              value={formData.mpesaConsumerKey}\n              onChange={(e) => setFormData({ ...formData, mpesaConsumerKey: e.target.value })}\n              data-testid=\"input-consumer-key\"\n            />\n            <GlassInput\n              label=\"Consumer Secret\"\n              type={showSecrets ? \"text\" : \"password\"}\n              placeholder=\"Your Consumer Secret\"\n              value={formData.mpesaConsumerSecret}\n              onChange={(e) => setFormData({ ...formData, mpesaConsumerSecret: e.target.value })}\n              data-testid=\"input-consumer-secret\"\n            />\n          </div>\n\n          <div className=\"mt-4 p-4 rounded-xl bg-purple-500/10 border border-purple-500/20\">\n            <p className=\"text-sm text-muted-foreground\">\n              Get your M-Pesa credentials from the{\" \"}\n              <a\n                href=\"https://developer.safaricom.co.ke/\"\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"text-cyan-400 hover:text-cyan-300\"\n              >\n                Safaricom Developer Portal\n              </a>\n              . Use sandbox credentials for testing.\n            </p>\n          </div>\n        </GlassPanel>\n\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center justify-between mb-6\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 rounded-lg bg-orange-500/20\">\n                <MessageSquare size={20} className=\"text-orange-400\" />\n              </div>\n              <div>\n                <h2 className=\"text-lg font-semibold text-white\">SMS Integration</h2>\n                <p className=\"text-sm text-muted-foreground\">\n                  Configure SMS provider for customer notifications and campaigns\n                </p>\n              </div>\n            </div>\n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => setShowSecrets(!showSecrets)}\n              data-testid=\"button-toggle-sms-secrets\"\n            >\n              {showSecrets ? (\n                <>\n                  <EyeOff size={16} className=\"mr-2\" />\n                  Hide\n                </>\n              ) : (\n                <>\n                  <Eye size={16} className=\"mr-2\" />\n                  Show\n                </>\n              )}\n            </Button>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            <div className=\"space-y-2\">\n              <Label className=\"text-muted-foreground\">SMS Provider</Label>\n              <Select \n                value={formData.smsProvider} \n                onValueChange={(value) => setFormData({ ...formData, smsProvider: value })}\n              >\n                <SelectTrigger className=\"glass-input\" data-testid=\"select-sms-provider\">\n                  <SelectValue placeholder=\"Select provider\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"mock\">Mock (Testing)</SelectItem>\n                  <SelectItem value=\"africas_talking\">Africa's Talking</SelectItem>\n                  <SelectItem value=\"twilio\">Twilio</SelectItem>\n                </SelectContent>\n              </Select>\n              <p className=\"text-xs text-muted-foreground\">\n                Use Mock for testing, Africa's Talking for production in Kenya\n              </p>\n            </div>\n\n            <GlassInput\n              label=\"Sender ID\"\n              placeholder=\"YOURCOMPANY\"\n              value={formData.smsSenderId}\n              onChange={(e) => setFormData({ ...formData, smsSenderId: e.target.value })}\n              data-testid=\"input-sms-sender-id\"\n            />\n\n            <GlassInput\n              label=\"API Key\"\n              type={showSecrets ? \"text\" : \"password\"}\n              placeholder=\"Your SMS API Key\"\n              value={formData.smsApiKey}\n              onChange={(e) => setFormData({ ...formData, smsApiKey: e.target.value })}\n              data-testid=\"input-sms-api-key\"\n            />\n\n            <GlassInput\n              label=\"Username\"\n              placeholder=\"sandbox or your username\"\n              value={formData.smsUsername}\n              onChange={(e) => setFormData({ ...formData, smsUsername: e.target.value })}\n              data-testid=\"input-sms-username\"\n            />\n          </div>\n\n          <div className=\"mt-4 p-4 rounded-xl bg-orange-500/10 border border-orange-500/20\">\n            <p className=\"text-sm text-muted-foreground\">\n              For Africa's Talking, get your credentials from the{\" \"}\n              <a\n                href=\"https://africastalking.com/\"\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"text-cyan-400 hover:text-cyan-300\"\n              >\n                Africa's Talking Dashboard\n              </a>\n              . Use \"sandbox\" as username for testing. SMS campaigns are available for Tier 2 subscribers.\n            </p>\n          </div>\n        </GlassPanel>\n\n        <div className=\"flex justify-end\">\n          <Button\n            type=\"submit\"\n            className=\"gradient-btn px-8\"\n            disabled={saveMutation.isPending}\n            data-testid=\"button-save-settings\"\n          >\n            <Save size={18} className=\"mr-2\" />\n            {saveMutation.isPending ? \"Saving...\" : \"Save Settings\"}\n          </Button>\n        </div>\n      </form>\n    </div>\n  );\n}\n","path":null,"size_bytes":19690,"size_tokens":null},"client/src/components/metric-card.tsx":{"content":"import { motion } from \"framer-motion\";\nimport { cn } from \"@/lib/utils\";\nimport { TrendingUp, TrendingDown, Minus } from \"lucide-react\";\n\ninterface MetricCardProps {\n  title: string;\n  value: string | number;\n  subtitle?: string;\n  icon: React.ReactNode;\n  trend?: {\n    value: number;\n    label?: string;\n  };\n  gradient?: \"primary\" | \"accent\" | \"mpesa\";\n  className?: string;\n}\n\nexport function MetricCard({\n  title,\n  value,\n  subtitle,\n  icon,\n  trend,\n  gradient,\n  className,\n}: MetricCardProps) {\n  const gradientClasses = {\n    primary: \"from-cyan-500/20 to-blue-500/20\",\n    accent: \"from-purple-500/20 to-pink-500/20\",\n    mpesa: \"from-green-500/20 to-emerald-500/20\",\n  };\n\n  const getTrendIcon = () => {\n    if (!trend) return null;\n    if (trend.value > 0) return <TrendingUp size={14} className=\"text-cyan-400\" />;\n    if (trend.value < 0) return <TrendingDown size={14} className=\"text-pink-400\" />;\n    return <Minus size={14} className=\"text-muted-foreground\" />;\n  };\n\n  const getTrendColor = () => {\n    if (!trend) return \"\";\n    if (trend.value > 0) return \"text-cyan-400\";\n    if (trend.value < 0) return \"text-pink-400\";\n    return \"text-muted-foreground\";\n  };\n\n  return (\n    <motion.div\n      className={cn(\n        \"rounded-2xl bg-white/5 backdrop-blur-xl border border-white/10 p-6\",\n        \"hover:bg-white/8 hover:border-white/15 transition-all duration-300\",\n        gradient && `bg-gradient-to-br ${gradientClasses[gradient]}`,\n        className\n      )}\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      whileHover={{ y: -2 }}\n      data-testid={`metric-card-${title.toLowerCase().replace(/\\s+/g, \"-\")}`}\n    >\n      <div className=\"flex items-start justify-between\">\n        <div className=\"space-y-3\">\n          <span className=\"text-sm font-medium text-muted-foreground\">{title}</span>\n          <div>\n            <span className=\"text-3xl font-bold text-white\">{value}</span>\n            {subtitle && (\n              <span className=\"ml-2 text-sm text-muted-foreground\">{subtitle}</span>\n            )}\n          </div>\n          {trend && (\n            <div className={cn(\"flex items-center gap-1 text-sm\", getTrendColor())}>\n              {getTrendIcon()}\n              <span>{Math.abs(trend.value)}%</span>\n              {trend.label && (\n                <span className=\"text-muted-foreground ml-1\">{trend.label}</span>\n              )}\n            </div>\n          )}\n        </div>\n        <div className=\"p-3 rounded-xl bg-white/5 text-muted-foreground\">\n          {icon}\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\n// Metric card skeleton\nexport function MetricCardSkeleton() {\n  return (\n    <div\n      className=\"rounded-2xl bg-white/5 border border-white/10 p-6 animate-pulse\"\n      data-testid=\"metric-card-skeleton\"\n    >\n      <div className=\"flex items-start justify-between\">\n        <div className=\"space-y-3\">\n          <div className=\"h-4 w-24 bg-white/10 rounded\" />\n          <div className=\"h-8 w-32 bg-white/10 rounded\" />\n          <div className=\"h-4 w-20 bg-white/10 rounded\" />\n        </div>\n        <div className=\"w-12 h-12 rounded-xl bg-white/10\" />\n      </div>\n    </div>\n  );\n}\n\n// Compact metric for sidebar or header\ninterface CompactMetricProps {\n  label: string;\n  value: string | number;\n  icon?: React.ReactNode;\n}\n\nexport function CompactMetric({ label, value, icon }: CompactMetricProps) {\n  return (\n    <div\n      className=\"flex items-center gap-3 px-4 py-3 rounded-xl bg-white/5\"\n      data-testid={`compact-metric-${label.toLowerCase().replace(/\\s+/g, \"-\")}`}\n    >\n      {icon && <span className=\"text-muted-foreground\">{icon}</span>}\n      <div className=\"flex-1 min-w-0\">\n        <p className=\"text-xs text-muted-foreground truncate\">{label}</p>\n        <p className=\"text-sm font-semibold text-white\">{value}</p>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":3874,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"replit.md":{"content":"# MnetiFi - Wi-Fi Billing SaaS Platform\n\n## Overview\nMnetiFi is a multi-tenant Wi-Fi hotspot billing system designed for ISPs with M-Pesa (Safaricom Daraja) integration. The platform features a premium \"Vaultic\" Glassmorphism design aesthetic with animated mesh gradient backgrounds.\n\n## Project Status\n- **Current Phase**: All Core Stages Complete (1-7) + Authentication + Landing Page + Tech Portal + Security & Customer Experience Features + Captive Portal Designer\n- **Last Updated**: December 10, 2025\n\n## Recent Updates\n\n### Centralized SMS Management (December 10, 2025)\n- SMS functionality moved to SuperAdmin level using Mobitech Technologies API\n- Platform SMS Settings page at `/superadmin/sms-settings`\n- Features: SMS balance check, test SMS, delivery report webhook\n- Sender ID: \"MNETIFI\" for all platform SMS\n- API key stored securely as Replit secret (MOBITECH_API_KEY)\n- Webhook endpoint: `POST /api/webhooks/sms/delivery` for delivery reports\n- SMS used for: SuperAdmin OTP, ISP account notifications, expiry reminders\n- Removed SMS configuration from ISP admin settings (security measure)\n- SMS messages include ISP branding where appropriate (e.g., \"Your ISP Name - OTP: 123456\")\n\n### Captive Portal Designer (December 10, 2025)\n- Visual portal customization at `/dashboard/portal-designer`\n- Tabbed interface: Branding, Design, Support settings\n- Live preview panel showing real-time changes\n- Extended brandingConfig with: tagline, welcomeMessage, supportEmail, supportPhone, footerText, showPoweredBy, cardStyle (solid/glass/gradient), animationsEnabled, backgroundGradient\n- Accessible from Hotspot Plans page via \"Design Portal\" button\n- Captive portal dynamically renders all new branding fields with safe fallbacks\n\n### Security & Customer Experience Enhancements (December 7, 2025)\n\n#### Chat UI\n- Admin-customer messaging system at `/dashboard/chat`\n- Real-time message display with unread indicators\n- Message history and conversation management\n- API endpoints: GET/POST `/api/chat-messages`\n\n#### Loyalty Points System\n- Points display and transaction history at `/dashboard/loyalty`\n- Point awards and redemption functionality\n- Balance tracking and tier display\n- API endpoints: GET/POST `/api/loyalty-points`\n\n#### Two-Factor Authentication (2FA)\n- Optional TOTP-based 2FA using authenticator apps\n- QR code setup with manual secret entry fallback\n- Login flow with 2FA verification step\n- Security settings page at `/dashboard/security`\n- API endpoints: \n  - `POST /api/auth/2fa/setup` - Generate secret and QR code\n  - `POST /api/auth/2fa/verify` - Verify and enable 2FA\n  - `POST /api/auth/2fa/disable` - Disable 2FA (requires password + code)\n  - `GET /api/auth/2fa/status` - Check 2FA status\n  - `POST /api/auth/2fa/login-verify` - Verify 2FA code during login\n\n#### Password Strength Validation\n- Enforces 8+ characters, uppercase, lowercase, numbers, and special characters\n- Both frontend and backend validation to prevent bypass\n- Applied to ISP registration and Super Admin registration\n\n#### Automated Expiry Warnings\n- SMS reminders at 24 hours, 6 hours, and 1 hour before subscription expires\n- Integrated into payment worker background process\n- Runs every 5 minutes to check for expiring users\n\n\n\n### Landing Page\n- Public-facing website at `/` showcasing MnetiFi platform\n- Features section highlighting hotspot, PPPoE, static IP, M-Pesa integration\n- Pricing tiers: Trial (24h free), Tier 1 (Ksh 500/mo), Tier 2 (Ksh 1,500/mo)\n- Testimonials and call-to-action sections\n\n### Registration with Payment Options\n- 3-step registration wizard\n- Step 1: Business name and subdomain\n- Step 2: Admin credentials (username, email, password)\n- Step 3: Payment method selection (M-Pesa, Bank Transfer, PayPal)\n- Schema updated with registration payment fields\n\n### Tech Portal\n- Dedicated dashboard for Technician role at `/tech`\n- Sidebar navigation: Dashboard, PPPoE Users, Static IP Users, All Customers\n- User management for PPPoE and Static IP customers\n- Metrics display for active and expiring users\n\n### PPPoE/Static Plan Management\n- Speed-based monthly pricing model\n- Example tiers: 5 Mbps (Ksh 1,500), 8 Mbps (Ksh 2,000), 15 Mbps (Ksh 3,000)\n- Separate management pages for PPPoE and Static IP plans\n- Schema updated with `planType` and `speedMbps` fields\n\n## Authentication\n- **Password Security**: bcrypt hashing with automatic legacy password migration\n- **Registration**: Multi-step wizard for new ISP accounts with 24-hour free trial\n- **Password Reset**: Token-based password recovery system (1-hour expiry)\n- **Default Admin**: admin/admin123 (password auto-migrates to bcrypt on first login)\n\n## Architecture\n\n### Tech Stack\n- **Frontend**: React + TypeScript, Tailwind CSS, Framer Motion, Shadcn UI\n- **Backend**: Express.js + TypeScript\n- **Database**: Supabase PostgreSQL with Drizzle ORM\n- **Styling**: Glassmorphism design with animated mesh gradients\n- **Background Jobs**: Database-backed job queue with exponential backoff\n- **Router Integration**: MikroTik RouterOS API service\n- **AAA**: RADIUS service with CoA (Change of Authorization) support\n- **Notifications**: SMS service (Africa's Talking ready)\n\n### Key Features\n1. **Captive Portal** - Mobile-first glassmorphic login/payment interface\n2. **Plan Management** - Create and manage Wi-Fi subscription plans with bursting\n3. **Hotspot Management** - Configure NAS devices and locations\n4. **Transaction Tracking** - Real-time payment status monitoring\n5. **Walled Garden** - Configure pre-auth accessible domains\n6. **M-Pesa Integration** - STK Push with resilient polling fallback\n7. **WiFi Users** - Manage Hotspot, PPPoE, and Static IP customer accounts\n8. **Support Tickets** - Track customer support requests with priority levels\n9. **Reconciliation Reports** - Match M-Pesa transactions with system records\n10. **Expiring Users Widget** - Dashboard widget showing users expiring in 5 days\n11. **MikroTik Router Management** - Direct API for user/session control\n12. **RADIUS with CoA** - Session management and rate limit updates\n13. **SaaS Billing Enforcement** - Block tenant traffic if unpaid\n14. **Advanced Reporting** - Financial, reconciliation, user activity reports\n\n## Project Structure\n```\n client/                 # React frontend\n    src/\n       components/     # Reusable UI components\n       pages/          # Page components\n       layouts/        # Layout components\n       hooks/          # Custom hooks\n server/                 # Express backend\n    db.ts              # Database connection\n    storage.ts         # Data access layer\n    routes.ts          # API endpoints\n shared/                 # Shared code\n    schema.ts          # Drizzle schemas & types\n```\n\n## API Endpoints\n\n### Core CRUD\n- `GET/PATCH /api/tenant` - Tenant settings\n- `GET /api/dashboard/stats` - Dashboard statistics (includes expiringUsers)\n- `GET/POST/PATCH/DELETE /api/plans` - Plan CRUD\n- `GET/POST/PATCH/DELETE /api/hotspots` - Hotspot CRUD\n- `GET/POST /api/transactions` - Transaction management\n- `POST /api/transactions/initiate` - Start M-Pesa payment\n- `GET/POST/DELETE /api/walled-gardens` - Walled garden config\n- `GET/POST/PATCH/DELETE /api/wifi-users` - WiFi user CRUD\n\n### WiFi User Admin Actions\n- `GET /api/wifi-users/:id/details` - Get detailed customer profile with payment history\n- `POST /api/wifi-users/:id/recharge` - Manual recharge user\n- `POST /api/wifi-users/:id/suspend` - Suspend user\n- `POST /api/wifi-users/:id/activate` - Activate user\n- `POST /api/wifi-users/:id/change-hotspot` - Move user to different NAS\n\n### Authentication\n- `POST /api/auth/login` - Admin login\n- `POST /api/auth/logout` - Admin logout\n- `POST /api/auth/register` - ISP registration\n- `POST /api/auth/forgot-password` - Request password reset\n- `POST /api/auth/reset-password` - Complete password reset\n- `POST /api/auth/register-superadmin` - Super Admin registration (requires setup key)\n\n### Tickets\n- `GET/POST/PATCH /api/tickets` - Support ticket management\n- `POST /api/tickets/:id/close` - Close ticket with resolution\n\n### Reports\n- `GET /api/reports/reconciliation` - M-Pesa transaction reconciliation\n- `GET /api/reports/financial` - Revenue reports with daily breakdown\n- `GET /api/reports/user-activity` - User status and expiry forecasts\n- `GET /api/reports/expiring-users` - Users expiring in next N days\n\n### MikroTik Router Management\n- `POST /api/hotspots/:id/test-connection` - Test router connectivity\n- `GET /api/hotspots/:id/active-sessions` - List active sessions on router\n- `POST /api/hotspots/:id/disconnect-user` - Disconnect user from router\n\n### SaaS Admin (Billing Enforcement)\n- `GET /api/admin/tenants` - List all tenants\n- `POST /api/admin/tenants/:id/billing-status` - Update billing status\n- `POST /api/admin/tenants/:id/block-traffic` - Block ISP traffic\n- `POST /api/admin/tenants/:id/unblock-traffic` - Restore ISP traffic\n\n### Job Queue\n- `GET /api/jobs/pending` - View pending background jobs\n- `GET /api/jobs/recent` - View recent job history\n\n## Design System\n- **Primary Color**: Cyan (#06b6d4) to Blue (#3b82f6) gradient\n- **Accent**: Purple (#7c3aed) to Magenta (#ec4899)\n- **M-Pesa**: Green (#4BB617)\n- **Background**: Deep Navy (#0f172a) with mesh gradients\n- **Glass Surfaces**: rgba(255, 255, 255, 0.05) with 16px blur\n\n## Default Demo Data\n- Demo tenant with sample plans (30min, 1hr, Daily, Weekly)\n- Pre-configured walled garden for M-Pesa domains\n- Resilient payment flow with job queue and retry logic\n\n## Payment Resilience Architecture (Phase 1)\n- **Job Queue**: Database-backed queue with atomic job claiming (FOR UPDATE SKIP LOCKED)\n- **Payment Worker**: Polls every 5 seconds, processes jobs sequentially\n- **Retry Logic**: Exponential backoff (2^attempts * 10 seconds), max 5 attempts\n- **Stuck Job Detection**: Automatic reset of jobs stuck in PROCESSING > 15 minutes\n- **Automatic User Activation**: Creates/updates WiFi user after successful payment\n- **Reconciliation Status**: Tracks PENDING/MATCHED/UNMATCHED for each transaction\n\n## Routes\n\n### Public Routes\n- `/` - Landing Page (official website)\n- `/portal` - Captive Portal (WiFi login)\n- `/login` - Admin Login\n- `/register` - ISP Registration Wizard (3-step with payment options)\n- `/forgot-password` - Password Reset Request\n- `/reset-password/:token` - Password Reset Form\n\n### ISP Admin Routes\n- `/dashboard` - Admin Dashboard\n- `/dashboard/wifi-users` - WiFi Users Management\n- `/dashboard/wifi-users/:id` - Customer Details Page (individual customer profile)\n- `/dashboard/plans` - Hotspot Plan Management\n- `/dashboard/pppoe-plans` - PPPoE Plan Management (speed-based)\n- `/dashboard/static-plans` - Static IP Plan Management (speed-based)\n- `/dashboard/hotspots` - Hotspot Management\n- `/dashboard/transactions` - Transaction History\n- `/dashboard/tickets` - Support Tickets\n- `/dashboard/reconciliation` - Reconciliation Reports\n- `/dashboard/walled-garden` - Walled Garden Config\n- `/dashboard/settings` - Tenant Settings\n\n### Technician Routes\n- `/tech` - Technician Dashboard\n- `/tech/pppoe-users` - PPPoE User Management\n- `/tech/static-users` - Static IP User Management\n- `/tech/customers` - All Customers View\n\n### Super Admin Routes\n- `/superadmin/login` - Super Admin Login\n- `/superadmin/register` - Super Admin Registration (requires setup key)\n- `/superadmin/forgot-password` - Super Admin Password Reset\n- `/superadmin` - Super Admin Dashboard\n- `/superadmin/tenants` - Tenant Management\n- `/superadmin/tenants/:id` - Tenant Details\n- `/superadmin/users` - Platform User Management\n\n## Backend Services (server/services/)\n- **mikrotik.ts** - MikroTik RouterOS API integration for direct router management\n- **radius.ts** - RADIUS service with CoA support for session management\n- **sms.ts** - SMS notification service (Africa's Talking ready, mock mode available)\n- **mpesa.ts** - M-Pesa Daraja API for STK Push payments\n- **job-queue.ts** - Database-backed job queue with exponential backoff\n- **payment-worker.ts** - Background worker for payment status polling\n\n## Upcoming Features\n- WhatsApp Business API integration for automated notifications\n- VPN tunnel generation for NAS devices without public IPs\n- Email invoice automation\n- FreeRADIUS database sync for network access control\n","path":null,"size_bytes":12413,"size_tokens":null},"server/services/job-queue.ts":{"content":"import { db } from \"../db\";\nimport { jobs, JobStatus, JobType } from \"@shared/schema\";\nimport { eq, and, lte, or, sql } from \"drizzle-orm\";\nimport type { InsertJob, Job } from \"@shared/schema\";\n\nexport class JobQueue {\n  private isRunning = false;\n  private pollInterval: ReturnType<typeof setInterval> | null = null;\n\n  async enqueue(job: InsertJob): Promise<Job> {\n    const [created] = await db.insert(jobs).values({\n      ...job,\n      status: JobStatus.PENDING,\n    }).returning();\n    return created;\n  }\n\n  async schedulePaymentCheck(tenantId: string, transactionId: string, checkoutRequestId: string, delaySeconds: number = 20): Promise<Job> {\n    const scheduledFor = new Date(Date.now() + delaySeconds * 1000);\n    return this.enqueue({\n      tenantId,\n      type: JobType.PAYMENT_STATUS_CHECK,\n      payload: { transactionId, checkoutRequestId },\n      priority: 10,\n      maxAttempts: 5,\n      scheduledFor,\n    });\n  }\n\n  async scheduleUserExpiryCheck(tenantId: string, userId: string): Promise<Job> {\n    return this.enqueue({\n      tenantId,\n      type: JobType.USER_EXPIRY_CHECK,\n      payload: { userId },\n      priority: 5,\n      maxAttempts: 3,\n    });\n  }\n\n  async scheduleReconciliation(tenantId: string): Promise<Job> {\n    return this.enqueue({\n      tenantId,\n      type: JobType.RECONCILIATION,\n      payload: {},\n      priority: 1,\n      maxAttempts: 1,\n    });\n  }\n\n  async scheduleSmsNotification(tenantId: string, phoneNumber: string, message: string): Promise<Job> {\n    return this.enqueue({\n      tenantId,\n      type: JobType.SMS_NOTIFICATION,\n      payload: { phoneNumber, message },\n      priority: 8,\n      maxAttempts: 3,\n    });\n  }\n\n  async getNextJob(): Promise<Job | null> {\n    const now = new Date();\n    \n    const result = await db.execute(sql`\n      UPDATE jobs\n      SET \n        status = ${JobStatus.PROCESSING},\n        started_at = ${now},\n        attempts = COALESCE(attempts, 0) + 1\n      WHERE id = (\n        SELECT id FROM jobs\n        WHERE (status = ${JobStatus.PENDING} OR status = ${JobStatus.RETRY})\n          AND scheduled_for <= ${now}\n        ORDER BY priority DESC, scheduled_for ASC\n        LIMIT 1\n        FOR UPDATE SKIP LOCKED\n      )\n      RETURNING *\n    `);\n\n    if (result.rows.length === 0) {\n      return null;\n    }\n\n    const row = result.rows[0] as any;\n    return {\n      id: row.id,\n      tenantId: row.tenant_id,\n      type: row.type,\n      payload: row.payload,\n      status: row.status,\n      priority: row.priority,\n      attempts: row.attempts,\n      maxAttempts: row.max_attempts,\n      scheduledFor: row.scheduled_for ? new Date(row.scheduled_for) : null,\n      startedAt: row.started_at ? new Date(row.started_at) : null,\n      completedAt: row.completed_at ? new Date(row.completed_at) : null,\n      lastError: row.last_error,\n      createdAt: row.created_at ? new Date(row.created_at) : null,\n    };\n  }\n\n  async resetStuckJobs(timeoutMinutes: number = 15): Promise<number> {\n    const timeout = new Date(Date.now() - timeoutMinutes * 60 * 1000);\n    \n    const result = await db\n      .update(jobs)\n      .set({\n        status: JobStatus.RETRY,\n        lastError: 'Job stuck in processing - automatically reset',\n      })\n      .where(\n        and(\n          eq(jobs.status, JobStatus.PROCESSING),\n          lte(jobs.startedAt, timeout)\n        )\n      )\n      .returning();\n    \n    return result.length;\n  }\n\n  async markCompleted(jobId: string): Promise<void> {\n    await db\n      .update(jobs)\n      .set({\n        status: JobStatus.COMPLETED,\n        completedAt: new Date(),\n      })\n      .where(eq(jobs.id, jobId));\n  }\n\n  async markFailed(jobId: string, error: string): Promise<void> {\n    const [job] = await db.select().from(jobs).where(eq(jobs.id, jobId));\n    \n    if (!job) return;\n\n    const attempts = job.attempts ?? 0;\n    const maxAttempts = job.maxAttempts ?? 3;\n    const shouldRetry = attempts < maxAttempts;\n    const nextSchedule = new Date(Date.now() + Math.pow(2, attempts) * 1000 * 10);\n\n    await db\n      .update(jobs)\n      .set({\n        status: shouldRetry ? JobStatus.RETRY : JobStatus.FAILED,\n        lastError: error,\n        scheduledFor: shouldRetry ? nextSchedule : undefined,\n        completedAt: shouldRetry ? undefined : new Date(),\n      })\n      .where(eq(jobs.id, jobId));\n  }\n\n  async getPendingJobs(tenantId?: string): Promise<Job[]> {\n    const conditions = [\n      or(\n        eq(jobs.status, JobStatus.PENDING),\n        eq(jobs.status, JobStatus.RETRY),\n        eq(jobs.status, JobStatus.PROCESSING)\n      )\n    ];\n    \n    if (tenantId) {\n      conditions.push(eq(jobs.tenantId, tenantId));\n    }\n\n    return db.select().from(jobs).where(and(...conditions));\n  }\n\n  async getRecentJobs(limit: number = 50): Promise<Job[]> {\n    return db\n      .select()\n      .from(jobs)\n      .orderBy(sql`${jobs.createdAt} DESC`)\n      .limit(limit);\n  }\n}\n\nexport const jobQueue = new JobQueue();\n","path":null,"size_bytes":4923,"size_tokens":null},"design_guidelines.md":{"content":"# MnetiFi SaaS Platform - Design Guidelines\n\n## Design Approach\n**Glassmorphism System** - Inspired by Vaultic.framer.website, this design emphasizes frosted glass effects, depth through blur, and floating radial gradients to create a premium, modern aesthetic for a multi-tenant Wi-Fi billing platform.\n\n## Core Design Principles\n1. **Mobile-First Performance** - Optimize all glass effects for mobile devices with fallbacks\n2. **Depth Through Blur** - Create visual hierarchy using backdrop-filter blur layers\n3. **Brand Prominence** - MnetiFi branding must be immediately visible and memorable\n4. **Tenant Customization** - Support white-label branding overlays while maintaining core aesthetic\n\n---\n\n## Typography\n\n**Primary Font:** Inter or Plus Jakarta Sans (via Google Fonts CDN)\n\n**Hierarchy:**\n- Hero/Display: 48px (mobile: 32px) / Bold / Letter-spacing: -0.02em\n- Section Headers: 36px (mobile: 24px) / Semibold\n- Card Titles: 20px / Semibold\n- Body Text: 16px / Regular / Line-height: 1.6\n- Input Labels: 14px / Medium / Uppercase / Letter-spacing: 0.05em\n- Captions/Meta: 12px / Regular\n\n**Colors:**\n- Primary Text: #FFFFFF\n- Secondary Text: #94a3b8\n- Input Placeholder: rgba(255, 255, 255, 0.3)\n\n---\n\n## Color Palette\n\n**Background System:**\n- Base: Deep Navy #0f172a\n- Mesh Gradients: Floating radial overlays using Neon Purple (#7c3aed), Cyan (#06b6d4), Magenta (#ec4899)\n- Gradient positions: Scattered asymmetrically, animated subtle movement\n\n**Glass Surfaces:**\n- Fill: rgba(255, 255, 255, 0.05)\n- Border Top: rgba(255, 255, 255, 0.2)\n- Border Bottom: rgba(255, 255, 255, 0.05)\n- Backdrop Blur: 16px with 180% saturation\n\n**Accents:**\n- Primary CTAs: Linear gradient Cyan (#06b6d4) to Blue (#3b82f6)\n- M-Pesa Integration: #4BB617 (maintain brand color, adapt to glass aesthetic)\n- Success States: Cyan gradient\n- Error States: Magenta (#ec4899)\n- Warning: Purple (#7c3aed)\n\n---\n\n## Layout System\n\n**Spacing Scale:** Tailwind units of 4, 6, 8, 12, 16, 24\n- Container padding: px-4 (mobile), px-8 (desktop)\n- Section spacing: py-16 (mobile), py-24 (desktop)\n- Card internal padding: p-6 (mobile), p-8 (desktop)\n- Component gaps: gap-4 (mobile), gap-6 (desktop)\n\n**Grid System:**\n- Dashboard: 12-column grid, glass card containers\n- Captive Portal: Single-column centered (max-w-md)\n- Admin Panels: 2-column sidebar + content (sidebar w-64)\n\n**Breakpoints:**\n- Mobile: Base\n- Tablet: md: (768px)\n- Desktop: lg: (1024px)\n\n---\n\n## Component Library\n\n**Glass Panels:**\n- Border-radius: 24px\n- Backdrop-filter: blur(16px) saturate(180%)\n- Box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1)\n- Border: 1px solid gradient (top: brighter, bottom: subtle)\n- Mobile fallback: background: rgba(15, 23, 42, 0.95) when backdrop-filter unsupported\n\n**Buttons:**\n- Primary: Glass surface + gradient overlay, rounded-xl, px-8 py-4\n- Secondary: Glass border only, rounded-xl, px-6 py-3\n- Icon buttons: Circular (w-12 h-12), glass surface\n- Hover state: Increase glass opacity to 0.1, subtle scale transform\n- On images: Backdrop blur background\n\n**Input Fields (Recessed Style):**\n- Background: rgba(0, 0, 0, 0.3) - darker than surface to appear \"inset\"\n- Border: 1px solid rgba(255, 255, 255, 0.1)\n- Rounded: rounded-lg\n- Padding: px-4 py-3\n- Focus: Border brightens to rgba(255, 255, 255, 0.3), cyan glow\n\n**Cards:**\n- Plan Cards: Glass panel with hover lift effect, gradient accent on top edge\n- Transaction Cards: Compact glass rows with status indicators\n- Hotspot Cards: Location icon + details, glass surface\n\n**Navigation:**\n- Top Nav: Fixed glass bar, blur background content behind\n- Sidebar (Admin): Persistent glass panel, w-64, icons + labels\n- Mobile: Slide-in drawer with glass backdrop\n\n**Modals:**\n- Overlay: rgba(0, 0, 0, 0.6) with backdrop blur\n- Content: Large glass panel, centered, smooth Framer Motion entrance\n\n**Status Indicators:**\n- PENDING: Pulsing purple glow\n- COMPLETED: Cyan checkmark with glass circle\n- FAILED: Magenta X with glass circle\n\n---\n\n## Page-Specific Guidelines\n\n**Captive Portal (Critical - User-Facing):**\n- Full-screen animated mesh background\n- Centered glass card (max-w-md)\n- Large MnetiFi logo/wordmark at top\n- Plan selection: Stacked glass cards, price prominent (gradient text)\n- Phone input: Recessed style, Kenya flag prefix\n- CTA: Full-width gradient button \"Pay with M-Pesa\" with M-Pesa logo\n- Walled garden notice: Small glass footer with allowed domains\n- Tenant branding: Logo overlay option in top-right corner\n\n**Dashboard (Admin):**\n- Glass sidebar navigation with icons\n- Main content: Grid of metric cards (revenue, active users, transactions)\n- Transaction table: Glass panel with row hover states\n- Charts: Subtle glass containers with gradient data lines\n\n**Plan Management:**\n- Create/Edit: Modal with glass panel form\n- List view: Grid of plan cards (3 columns desktop, 1 mobile)\n- Each card: Bandwidth icons, duration, price in gradient text\n\n---\n\n## Animations\n\nUse sparingly with Framer Motion:\n- Page transitions: Fade + subtle scale (duration: 0.3s)\n- Modal entrance: Scale from 0.95 to 1, opacity 0 to 1\n- Mesh gradients: Slow drift animation (30-60s loop)\n- Button interactions: Scale 0.98 on press\n- Card hover: translateY(-4px), duration 0.2s\n\n**Do NOT animate:** Input focus, text, constant UI elements\n\n---\n\n## Images\n\n**Hero Section:** No traditional hero image. The animated mesh gradient background IS the hero visual element.\n\n**Icons:** Use Heroicons via CDN for UI elements (payment, wifi, location, user icons)\n\n**Logos:**\n- MnetiFi: Minimal wordmark, likely white with gradient accent\n- M-Pesa: Official logo maintained at 24px height\n- Tenant logos: Support for custom upload (max 120px width)\n\n**Illustrations:** None required - glass aesthetic is visual focus\n\n---\n\n## Accessibility\n\n- Maintain 4.5:1 contrast for text on glass surfaces\n- Focus states: Visible cyan outline on all interactive elements\n- Keyboard navigation: Logical tab order\n- Input labels: Always present, never placeholder-only\n- Status announcements: Use ARIA live regions for transaction updates\n\n---\n\n## Mobile Optimization\n\n- Touch targets: Minimum 44x44px\n- Reduced blur on low-end devices (8px instead of 16px)\n- Simplified gradients: 2 instead of 3 colors\n- Sticky CTAs on payment flow\n- Bottom sheet modals instead of centered","path":null,"size_bytes":6288,"size_tokens":null},"README.md":{"content":"# MnetiFi\n","path":null,"size_bytes":10,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { motion } from \"framer-motion\";\nimport { Link } from \"wouter\";\nimport { Home, ArrowLeft } from \"lucide-react\";\nimport { MeshBackground } from \"@/components/mesh-background\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { MnetiFiLogo } from \"@/components/mnetifi-logo\";\nimport { Button } from \"@/components/ui/button\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen flex items-center justify-center p-4 relative overflow-hidden\">\n      <MeshBackground />\n\n      <motion.div\n        className=\"text-center\"\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.5 }}\n      >\n        <GlassPanel size=\"lg\" className=\"max-w-md mx-auto\">\n          <MnetiFiLogo size=\"lg\" className=\"justify-center mb-8\" />\n          \n          <motion.div\n            initial={{ scale: 0.8, opacity: 0 }}\n            animate={{ scale: 1, opacity: 1 }}\n            transition={{ delay: 0.2 }}\n          >\n            <span className=\"text-8xl font-bold gradient-text\">404</span>\n          </motion.div>\n\n          <h1 className=\"text-2xl font-semibold text-white mt-4 mb-2\">\n            Page Not Found\n          </h1>\n          <p className=\"text-muted-foreground mb-8\">\n            The page you're looking for doesn't exist or has been moved.\n          </p>\n\n          <div className=\"flex flex-col sm:flex-row gap-3 justify-center\">\n            <Link href=\"/\">\n              <Button className=\"gradient-btn w-full sm:w-auto\" data-testid=\"button-go-home\">\n                <Home size={18} className=\"mr-2\" />\n                Go to Portal\n              </Button>\n            </Link>\n            <Link href=\"/dashboard\">\n              <Button variant=\"ghost\" className=\"w-full sm:w-auto\" data-testid=\"button-go-dashboard\">\n                <ArrowLeft size={18} className=\"mr-2\" />\n                Dashboard\n              </Button>\n            </Link>\n          </div>\n        </GlassPanel>\n      </motion.div>\n    </div>\n  );\n}\n","path":null,"size_bytes":2020,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2359,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5741,"size_tokens":null},"server/services/mikrotik.ts":{"content":"import type { Hotspot, Plan, WifiUser } from \"@shared/schema\";\n\ninterface MikrotikResponse {\n  success: boolean;\n  data?: any;\n  error?: string;\n}\n\ninterface HotspotUser {\n  \".id\": string;\n  name: string;\n  password?: string;\n  profile?: string;\n  disabled?: string;\n  comment?: string;\n}\n\ninterface ActiveSession {\n  \".id\": string;\n  user: string;\n  address: string;\n  macAddress: string;\n  uptime: string;\n  bytesIn: string;\n  bytesOut: string;\n}\n\nexport class MikrotikService {\n  private hotspot: Hotspot;\n  private baseUrl: string;\n\n  constructor(hotspot: Hotspot) {\n    this.hotspot = hotspot;\n    const ip = hotspot.routerApiIp || hotspot.nasIp;\n    const port = hotspot.routerApiPort || 8728;\n    this.baseUrl = `http://${ip}:${port}`;\n  }\n\n  private async makeRequest(endpoint: string, method: \"GET\" | \"POST\" | \"PUT\" | \"DELETE\" = \"GET\", body?: any): Promise<MikrotikResponse> {\n    try {\n      const url = `${this.baseUrl}${endpoint}`;\n      const auth = Buffer.from(`${this.hotspot.routerApiUser || \"admin\"}:${this.hotspot.routerApiPass || \"\"}`).toString(\"base64\");\n\n      const response = await fetch(url, {\n        method,\n        headers: {\n          \"Authorization\": `Basic ${auth}`,\n          \"Content-Type\": \"application/json\",\n        },\n        body: body ? JSON.stringify(body) : undefined,\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        return { success: false, error: `API error: ${response.status} - ${errorText}` };\n      }\n\n      const data = await response.json();\n      return { success: true, data };\n    } catch (error) {\n      const message = error instanceof Error ? error.message : \"Unknown error\";\n      console.error(`[Mikrotik] Request failed for ${this.hotspot.locationName}:`, message);\n      return { success: false, error: message };\n    }\n  }\n\n  async addHotspotUser(username: string, password: string, profile: string, comment?: string): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Adding hotspot user ${username} to ${this.hotspot.locationName}`);\n    \n    const user = {\n      name: username,\n      password,\n      profile,\n      comment: comment || `Created by MnetiFi at ${new Date().toISOString()}`,\n    };\n\n    return this.makeRequest(\"/rest/ip/hotspot/user\", \"POST\", user);\n  }\n\n  async removeHotspotUser(username: string): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Removing hotspot user ${username} from ${this.hotspot.locationName}`);\n    \n    const users = await this.getHotspotUser(username);\n    if (!users.success || !users.data?.[0]) {\n      return { success: false, error: \"User not found\" };\n    }\n\n    const userId = users.data[0][\".id\"];\n    return this.makeRequest(`/rest/ip/hotspot/user/${userId}`, \"DELETE\");\n  }\n\n  async getHotspotUser(username: string): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/ip/hotspot/user?name=${encodeURIComponent(username)}`);\n  }\n\n  async updateHotspotUser(username: string, updates: Partial<HotspotUser>): Promise<MikrotikResponse> {\n    const users = await this.getHotspotUser(username);\n    if (!users.success || !users.data?.[0]) {\n      return { success: false, error: \"User not found\" };\n    }\n\n    const userId = users.data[0][\".id\"];\n    return this.makeRequest(`/rest/ip/hotspot/user/${userId}`, \"PUT\", updates);\n  }\n\n  async disableUser(username: string): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Disabling user ${username} on ${this.hotspot.locationName}`);\n    return this.updateHotspotUser(username, { disabled: \"true\" });\n  }\n\n  async enableUser(username: string): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Enabling user ${username} on ${this.hotspot.locationName}`);\n    return this.updateHotspotUser(username, { disabled: \"false\" });\n  }\n\n  async getActiveSessions(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/hotspot/active\");\n  }\n\n  async disconnectSession(sessionId: string): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Disconnecting session ${sessionId} on ${this.hotspot.locationName}`);\n    return this.makeRequest(`/rest/ip/hotspot/active/${sessionId}`, \"DELETE\");\n  }\n\n  async disconnectUser(username: string): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Disconnecting user ${username} from ${this.hotspot.locationName}`);\n    \n    const sessions = await this.getActiveSessions();\n    if (!sessions.success || !sessions.data) {\n      return sessions;\n    }\n\n    const userSessions = sessions.data.filter((s: ActiveSession) => s.user === username);\n    \n    for (const session of userSessions) {\n      await this.disconnectSession(session[\".id\"]);\n    }\n\n    return { success: true, data: { disconnected: userSessions.length } };\n  }\n\n  async createUserProfile(name: string, rateLimit: string, sessionTimeout?: number): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Creating user profile ${name} on ${this.hotspot.locationName}`);\n    \n    const profile: any = {\n      name,\n      \"rate-limit\": rateLimit,\n    };\n\n    if (sessionTimeout) {\n      profile[\"session-timeout\"] = `${sessionTimeout}s`;\n    }\n\n    return this.makeRequest(\"/rest/ip/hotspot/user/profile\", \"POST\", profile);\n  }\n\n  async getSystemResources(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/system/resource\");\n  }\n\n  async getInterfaceStats(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/interface\");\n  }\n\n  async getHotspotProfiles(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/hotspot/user/profile\");\n  }\n\n  async addPPPoEUser(username: string, password: string, service: string, profile?: string): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Adding PPPoE user ${username} to ${this.hotspot.locationName}`);\n    \n    const secret = {\n      name: username,\n      password,\n      service,\n      profile: profile || \"default\",\n      comment: `PPPoE user created by MnetiFi at ${new Date().toISOString()}`,\n    };\n\n    return this.makeRequest(\"/rest/ppp/secret\", \"POST\", secret);\n  }\n\n  async removePPPoEUser(username: string): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Removing PPPoE user ${username} from ${this.hotspot.locationName}`);\n    \n    const users = await this.makeRequest(`/rest/ppp/secret?name=${encodeURIComponent(username)}`);\n    if (!users.success || !users.data?.[0]) {\n      return { success: false, error: \"PPPoE user not found\" };\n    }\n\n    const userId = users.data[0][\".id\"];\n    return this.makeRequest(`/rest/ppp/secret/${userId}`, \"DELETE\");\n  }\n\n  async disconnectPPPoESession(username: string): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Disconnecting PPPoE session for ${username} on ${this.hotspot.locationName}`);\n    \n    const sessions = await this.makeRequest(`/rest/ppp/active?name=${encodeURIComponent(username)}`);\n    if (!sessions.success || !sessions.data?.[0]) {\n      return { success: true, data: { message: \"No active session\" } };\n    }\n\n    const sessionId = sessions.data[0][\".id\"];\n    return this.makeRequest(`/rest/ppp/active/${sessionId}`, \"DELETE\");\n  }\n\n  async addStaticBinding(macAddress: string, ipAddress: string, comment?: string): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Adding static binding ${macAddress} -> ${ipAddress} on ${this.hotspot.locationName}`);\n    \n    const binding = {\n      \"mac-address\": macAddress,\n      address: ipAddress,\n      comment: comment || `Static binding by MnetiFi at ${new Date().toISOString()}`,\n    };\n\n    return this.makeRequest(\"/rest/ip/arp\", \"POST\", binding);\n  }\n\n  async removeStaticBinding(macAddress: string): Promise<MikrotikResponse> {\n    const bindings = await this.makeRequest(`/rest/ip/arp?mac-address=${encodeURIComponent(macAddress)}`);\n    if (!bindings.success || !bindings.data?.[0]) {\n      return { success: false, error: \"Binding not found\" };\n    }\n\n    const bindingId = bindings.data[0][\".id\"];\n    return this.makeRequest(`/rest/ip/arp/${bindingId}`, \"DELETE\");\n  }\n\n  static buildRateLimit(plan: Plan): string {\n    const upload = plan.uploadLimit || \"1M\";\n    const download = plan.downloadLimit || \"2M\";\n    \n    if (plan.burstRateUp && plan.burstRateDown && plan.burstThreshold && plan.burstTime) {\n      return `${upload}/${download} ${plan.burstRateUp}/${plan.burstRateDown} ${plan.burstThreshold}/${plan.burstThreshold} ${plan.burstTime}/${plan.burstTime}`;\n    }\n    \n    return `${upload}/${download}`;\n  }\n\n  async blockTenantTraffic(message: string = \"Service temporarily suspended\"): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Blocking all traffic on ${this.hotspot.locationName}`);\n    \n    const rule = {\n      chain: \"forward\",\n      action: \"reject\",\n      \"reject-with\": \"icmp-admin-prohibited\",\n      comment: `MnetiFi Block: ${message}`,\n      disabled: \"false\",\n    };\n\n    return this.makeRequest(\"/rest/ip/firewall/filter\", \"POST\", rule);\n  }\n\n  async unblockTenantTraffic(): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Unblocking traffic on ${this.hotspot.locationName}`);\n    \n    const rules = await this.makeRequest(\"/rest/ip/firewall/filter?comment~MnetiFi%20Block\");\n    if (!rules.success || !rules.data) {\n      return rules;\n    }\n\n    for (const rule of rules.data) {\n      await this.makeRequest(`/rest/ip/firewall/filter/${rule[\".id\"]}`, \"DELETE\");\n    }\n\n    return { success: true, data: { removed: rules.data.length } };\n  }\n\n  async testConnection(): Promise<MikrotikResponse> {\n    try {\n      const result = await this.getSystemResources();\n      if (result.success) {\n        console.log(`[Mikrotik] Connection test successful for ${this.hotspot.locationName}`);\n      }\n      return result;\n    } catch (error) {\n      const message = error instanceof Error ? error.message : \"Connection failed\";\n      return { success: false, error: message };\n    }\n  }\n\n  // Execute arbitrary command via REST API (for terminal emulator)\n  async executeCommand(restPath: string, method: \"GET\" | \"POST\" | \"DELETE\" = \"GET\", body?: any): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Executing command: ${method} ${restPath}`);\n    return this.makeRequest(restPath, method, body);\n  }\n\n  async rebootRouter(): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Rebooting router ${this.hotspot.locationName}`);\n    return this.makeRequest(\"/rest/system/reboot\", \"POST\");\n  }\n\n  async getTrafficStats(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/interface/ethernet\");\n  }\n\n  async getBandwidthUsage(interfaceName: string = \"ether1\"): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/interface/monitor-traffic?interface=${encodeURIComponent(interfaceName)}&once=`);\n  }\n\n  async getActiveConnections(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/firewall/connection\");\n  }\n\n  async getDHCPLeases(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/dhcp-server/lease\");\n  }\n\n  async getRouterIdentity(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/system/identity\");\n  }\n\n  async getRouterHealth(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/system/health\");\n  }\n\n  async getQueueStats(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/queue/simple\");\n  }\n\n  // ============== FIREWALL RULES ==============\n  async getFirewallFilterRules(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/firewall/filter\");\n  }\n\n  async getFirewallNatRules(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/firewall/nat\");\n  }\n\n  async getFirewallMangleRules(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/firewall/mangle\");\n  }\n\n  async enableFirewallRule(ruleId: string, type: \"filter\" | \"nat\" | \"mangle\" = \"filter\"): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/ip/firewall/${type}/${ruleId}`, \"PUT\", { disabled: \"false\" });\n  }\n\n  async disableFirewallRule(ruleId: string, type: \"filter\" | \"nat\" | \"mangle\" = \"filter\"): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/ip/firewall/${type}/${ruleId}`, \"PUT\", { disabled: \"true\" });\n  }\n\n  async deleteFirewallRule(ruleId: string, type: \"filter\" | \"nat\" | \"mangle\" = \"filter\"): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/ip/firewall/${type}/${ruleId}`, \"DELETE\");\n  }\n\n  async addFirewallRule(type: \"filter\" | \"nat\" | \"mangle\", rule: Record<string, any>): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/ip/firewall/${type}`, \"POST\", rule);\n  }\n\n  // ============== IP POOL MANAGEMENT ==============\n  async getIpPools(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/pool\");\n  }\n\n  async addIpPool(name: string, ranges: string): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/pool\", \"POST\", { name, ranges });\n  }\n\n  async deleteIpPool(poolId: string): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/ip/pool/${poolId}`, \"DELETE\");\n  }\n\n  async updateIpPool(poolId: string, updates: { name?: string; ranges?: string }): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/ip/pool/${poolId}`, \"PUT\", updates);\n  }\n\n  // ============== DHCP SERVER ==============\n  async getDhcpServers(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/dhcp-server\");\n  }\n\n  async getDhcpNetworks(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/dhcp-server/network\");\n  }\n\n  async releaseDhcpLease(leaseId: string): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/ip/dhcp-server/lease/${leaseId}`, \"DELETE\");\n  }\n\n  async makeLeaseStatic(leaseId: string): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/ip/dhcp-server/lease/${leaseId}`, \"PUT\", { dynamic: \"false\" });\n  }\n\n  // ============== HOTSPOT SERVER MANAGEMENT ==============\n  async getHotspotServers(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/hotspot\");\n  }\n\n  async getHotspotServerProfiles(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/hotspot/profile\");\n  }\n\n  async updateHotspotServerProfile(profileId: string, updates: Record<string, any>): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/ip/hotspot/profile/${profileId}`, \"PUT\", updates);\n  }\n\n  async getHotspotIpBindings(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/hotspot/ip-binding\");\n  }\n\n  async addHotspotIpBinding(address: string, type: \"bypassed\" | \"blocked\" | \"regular\", comment?: string): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/hotspot/ip-binding\", \"POST\", {\n      address,\n      type,\n      comment: comment || `MnetiFi binding at ${new Date().toISOString()}`,\n    });\n  }\n\n  async deleteHotspotIpBinding(bindingId: string): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/ip/hotspot/ip-binding/${bindingId}`, \"DELETE\");\n  }\n\n  // ============== WALLED GARDEN SYNC ==============\n  async getWalledGardenEntries(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/hotspot/walled-garden\");\n  }\n\n  async getWalledGardenIpEntries(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/hotspot/walled-garden/ip\");\n  }\n\n  async addWalledGardenEntry(dstHost: string, action: \"allow\" | \"deny\" = \"allow\", comment?: string): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/hotspot/walled-garden\", \"POST\", {\n      \"dst-host\": dstHost,\n      action,\n      comment: comment || `MnetiFi at ${new Date().toISOString()}`,\n    });\n  }\n\n  async addWalledGardenIpEntry(dstAddress: string, action: \"accept\" | \"drop\" = \"accept\", comment?: string): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/hotspot/walled-garden/ip\", \"POST\", {\n      \"dst-address\": dstAddress,\n      action,\n      comment: comment || `MnetiFi at ${new Date().toISOString()}`,\n    });\n  }\n\n  async deleteWalledGardenEntry(entryId: string): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/ip/hotspot/walled-garden/${entryId}`, \"DELETE\");\n  }\n\n  async deleteWalledGardenIpEntry(entryId: string): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/ip/hotspot/walled-garden/ip/${entryId}`, \"DELETE\");\n  }\n\n  async syncWalledGarden(entries: { domain: string; description?: string }[]): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Syncing ${entries.length} walled garden entries to ${this.hotspot.locationName}`);\n    \n    const results = { added: 0, failed: 0, errors: [] as string[] };\n    \n    for (const entry of entries) {\n      const result = await this.addWalledGardenEntry(entry.domain, \"allow\", entry.description);\n      if (result.success) {\n        results.added++;\n      } else {\n        results.failed++;\n        results.errors.push(`${entry.domain}: ${result.error}`);\n      }\n    }\n    \n    return { success: results.failed === 0, data: results };\n  }\n\n  // ============== SIMPLE QUEUES ==============\n  async getSimpleQueues(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/queue/simple\");\n  }\n\n  async addSimpleQueue(name: string, target: string, maxLimit: string, comment?: string): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/queue/simple\", \"POST\", {\n      name,\n      target,\n      \"max-limit\": maxLimit,\n      comment: comment || `MnetiFi queue at ${new Date().toISOString()}`,\n    });\n  }\n\n  async updateSimpleQueue(queueId: string, updates: Record<string, any>): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/queue/simple/${queueId}`, \"PUT\", updates);\n  }\n\n  async deleteSimpleQueue(queueId: string): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/queue/simple/${queueId}`, \"DELETE\");\n  }\n\n  // ============== ARP TABLE ==============\n  async getArpTable(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/arp\");\n  }\n\n  async addArpEntry(address: string, macAddress: string, interfaceName: string, comment?: string): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/arp\", \"POST\", {\n      address,\n      \"mac-address\": macAddress,\n      interface: interfaceName,\n      comment: comment || `MnetiFi at ${new Date().toISOString()}`,\n    });\n  }\n\n  async deleteArpEntry(entryId: string): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/ip/arp/${entryId}`, \"DELETE\");\n  }\n\n  // ============== ROUTES ==============\n  async getRoutes(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/route\");\n  }\n\n  async addRoute(dstAddress: string, gateway: string, comment?: string): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/route\", \"POST\", {\n      \"dst-address\": dstAddress,\n      gateway,\n      comment: comment || `MnetiFi route at ${new Date().toISOString()}`,\n    });\n  }\n\n  async deleteRoute(routeId: string): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/ip/route/${routeId}`, \"DELETE\");\n  }\n\n  // ============== IP ADDRESSES ==============\n  async getIpAddresses(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/address\");\n  }\n\n  async addIpAddress(address: string, interfaceName: string, comment?: string): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/address\", \"POST\", {\n      address,\n      interface: interfaceName,\n      comment: comment || `MnetiFi at ${new Date().toISOString()}`,\n    });\n  }\n\n  async deleteIpAddress(addressId: string): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/ip/address/${addressId}`, \"DELETE\");\n  }\n\n  // ============== DNS ==============\n  async getDnsSettings(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/dns\");\n  }\n\n  async getDnsStaticEntries(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/dns/static\");\n  }\n\n  async setDnsServers(servers: string): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ip/dns\", \"PUT\", { servers });\n  }\n\n  // ============== ROUTER BACKUP ==============\n  async createBackup(name?: string): Promise<MikrotikResponse> {\n    const backupName = name || `mnetifi_backup_${Date.now()}`;\n    console.log(`[Mikrotik] Creating backup ${backupName} on ${this.hotspot.locationName}`);\n    return this.makeRequest(\"/rest/system/backup/save\", \"POST\", { name: backupName });\n  }\n\n  async exportConfig(): Promise<MikrotikResponse> {\n    console.log(`[Mikrotik] Exporting config from ${this.hotspot.locationName}`);\n    return this.makeRequest(\"/rest/export\");\n  }\n\n  async getFiles(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/file\");\n  }\n\n  async getFileContent(fileName: string): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/file/${encodeURIComponent(fileName)}`);\n  }\n\n  async deleteFile(fileName: string): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/file/${encodeURIComponent(fileName)}`, \"DELETE\");\n  }\n\n  // ============== SCRIPTS & SCHEDULER ==============\n  async getScripts(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/system/script\");\n  }\n\n  async getScheduler(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/system/scheduler\");\n  }\n\n  // ============== LOGS ==============\n  async getLogs(topics?: string): Promise<MikrotikResponse> {\n    const endpoint = topics ? `/rest/log?topics=${encodeURIComponent(topics)}` : \"/rest/log\";\n    return this.makeRequest(endpoint);\n  }\n\n  // ============== INTERFACE MANAGEMENT ==============\n  async getWirelessInterfaces(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/interface/wireless\");\n  }\n\n  async getEthernetInterfaces(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/interface/ethernet\");\n  }\n\n  async getBridges(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/interface/bridge\");\n  }\n\n  async getBridgePorts(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/interface/bridge/port\");\n  }\n\n  async enableInterface(interfaceId: string): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/interface/${interfaceId}`, \"PUT\", { disabled: \"false\" });\n  }\n\n  async disableInterface(interfaceId: string): Promise<MikrotikResponse> {\n    return this.makeRequest(`/rest/interface/${interfaceId}`, \"PUT\", { disabled: \"true\" });\n  }\n\n  // ============== PPP PROFILES ==============\n  async getPppProfiles(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ppp/profile\");\n  }\n\n  async addPppProfile(name: string, localAddress: string, remoteAddress: string, rateLimit?: string): Promise<MikrotikResponse> {\n    const profile: Record<string, any> = {\n      name,\n      \"local-address\": localAddress,\n      \"remote-address\": remoteAddress,\n    };\n    if (rateLimit) {\n      profile[\"rate-limit\"] = rateLimit;\n    }\n    return this.makeRequest(\"/rest/ppp/profile\", \"POST\", profile);\n  }\n\n  async getPppSecrets(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ppp/secret\");\n  }\n\n  async getActivePppSessions(): Promise<MikrotikResponse> {\n    return this.makeRequest(\"/rest/ppp/active\");\n  }\n\n  // ============== COMPREHENSIVE CONNECTION TEST ==============\n  async fullConnectionTest(): Promise<MikrotikResponse> {\n    try {\n      const [identity, resources, health] = await Promise.all([\n        this.getRouterIdentity(),\n        this.getSystemResources(),\n        this.getRouterHealth(),\n      ]);\n\n      if (!identity.success && !resources.success) {\n        return { success: false, error: \"Cannot connect to router\" };\n      }\n\n      return {\n        success: true,\n        data: {\n          identity: identity.data,\n          resources: resources.data,\n          health: health.data,\n          connectionTime: new Date().toISOString(),\n        },\n      };\n    } catch (error) {\n      const message = error instanceof Error ? error.message : \"Connection test failed\";\n      return { success: false, error: message };\n    }\n  }\n}\n\nexport async function createMikrotikService(hotspot: Hotspot): Promise<MikrotikService | null> {\n  if (!hotspot.routerApiIp && !hotspot.nasIp) {\n    console.warn(`[Mikrotik] No API IP configured for hotspot ${hotspot.id}`);\n    return null;\n  }\n\n  const service = new MikrotikService(hotspot);\n  return service;\n}\n","path":null,"size_bytes":24141,"size_tokens":null},"server/vite.ts":{"content":"import { type Express } from \"express\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport async function setupVite(server: Server, app: Express) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server, path: \"/vite-hmr\" },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n","path":null,"size_bytes":1534,"size_tokens":null},"client/src/pages/walled-garden-page.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { WalledGardenList } from \"@/components/walled-garden\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { WalledGarden } from \"@shared/schema\";\nimport { Globe, Info } from \"lucide-react\";\n\nexport default function WalledGardenPage() {\n  const { toast } = useToast();\n\n  // Fetch walled garden domains\n  const { data: domains, isLoading } = useQuery<WalledGarden[]>({\n    queryKey: [\"/api/walled-gardens\"],\n  });\n\n  // Add domain mutation\n  const addMutation = useMutation({\n    mutationFn: async (domain: string) => {\n      return apiRequest(\"POST\", \"/api/walled-gardens\", { domain });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/walled-gardens\"] });\n      toast({\n        title: \"Domain Added\",\n        description: \"The domain has been added to the walled garden.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to add domain\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Remove domain mutation\n  const removeMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/walled-gardens/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/walled-gardens\"] });\n      toast({\n        title: \"Domain Removed\",\n        description: \"The domain has been removed from the walled garden.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to remove domain\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"walled-garden-page\">\n      {/* Header */}\n      <div>\n        <h1 className=\"text-2xl font-bold text-white\">Walled Garden</h1>\n        <p className=\"text-muted-foreground\">\n          Configure domains accessible before user authentication\n        </p>\n      </div>\n\n      {/* Info Card */}\n      <GlassPanel size=\"sm\" className=\"flex items-start gap-4 bg-cyan-500/5 border-cyan-500/20\">\n        <div className=\"p-2 rounded-lg bg-cyan-500/20\">\n          <Info size={20} className=\"text-cyan-400\" />\n        </div>\n        <div>\n          <h3 className=\"font-medium text-white mb-1\">About Walled Garden</h3>\n          <p className=\"text-sm text-muted-foreground\">\n            The walled garden allows users to access specific websites before authenticating\n            to the hotspot. This is essential for M-Pesa payment processing, as users need\n            to access Safaricom services to complete transactions.\n          </p>\n        </div>\n      </GlassPanel>\n\n      {/* Default Domains Info */}\n      <GlassPanel size=\"sm\" className=\"bg-purple-500/5 border-purple-500/20\">\n        <h3 className=\"font-medium text-white mb-3\">Recommended Domains</h3>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n          <div className=\"flex items-center gap-2 text-sm\">\n            <Globe size={14} className=\"text-purple-400\" />\n            <span className=\"text-muted-foreground\">safaricom.co.ke</span>\n            <span className=\"text-xs px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-300\">\n              M-Pesa\n            </span>\n          </div>\n          <div className=\"flex items-center gap-2 text-sm\">\n            <Globe size={14} className=\"text-purple-400\" />\n            <span className=\"text-muted-foreground\">sandbox.safaricom.co.ke</span>\n            <span className=\"text-xs px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-300\">\n              Testing\n            </span>\n          </div>\n          <div className=\"flex items-center gap-2 text-sm\">\n            <Globe size={14} className=\"text-purple-400\" />\n            <span className=\"text-muted-foreground\">api.safaricom.co.ke</span>\n            <span className=\"text-xs px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-300\">\n              API\n            </span>\n          </div>\n          <div className=\"flex items-center gap-2 text-sm\">\n            <Globe size={14} className=\"text-purple-400\" />\n            <span className=\"text-muted-foreground\">mpesa.co.ke</span>\n            <span className=\"text-xs px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-300\">\n              Payments\n            </span>\n          </div>\n        </div>\n      </GlassPanel>\n\n      {/* Domain List */}\n      <GlassPanel size=\"md\">\n        {isLoading ? (\n          <div className=\"animate-pulse space-y-4\">\n            <div className=\"h-6 w-32 bg-white/10 rounded\" />\n            <div className=\"h-4 w-48 bg-white/10 rounded\" />\n            <div className=\"space-y-2\">\n              {[1, 2, 3].map((i) => (\n                <div key={i} className=\"h-12 bg-white/5 rounded-xl\" />\n              ))}\n            </div>\n          </div>\n        ) : (\n          <WalledGardenList\n            domains={domains || []}\n            onAdd={(domain) => addMutation.mutate(domain)}\n            onRemove={(domain) => removeMutation.mutate(domain.id)}\n          />\n        )}\n      </GlassPanel>\n    </div>\n  );\n}\n","path":null,"size_bytes":5262,"size_tokens":null},"client/src/pages/hotspots.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Plus, Wifi, Server, Shield } from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput, GlassTextarea } from \"@/components/glass-input\";\nimport { HotspotCard, HotspotCardSkeleton, AddHotspotButton } from \"@/components/hotspot-card\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Hotspot, InsertHotspot } from \"@shared/schema\";\n\nexport default function HotspotsPage() {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingHotspot, setEditingHotspot] = useState<Hotspot | null>(null);\n  const [deletingHotspot, setDeletingHotspot] = useState<Hotspot | null>(null);\n\n  // Form state\n  const [formData, setFormData] = useState<Partial<InsertHotspot>>({\n    locationName: \"\",\n    description: \"\",\n    nasIp: \"\",\n    secret: \"\",\n  });\n\n  // Fetch hotspots\n  const { data: hotspots, isLoading } = useQuery<Hotspot[]>({\n    queryKey: [\"/api/hotspots\"],\n  });\n\n  // Create/Update mutation\n  const saveMutation = useMutation({\n    mutationFn: async (data: Partial<InsertHotspot>) => {\n      if (editingHotspot) {\n        return apiRequest(\"PATCH\", `/api/hotspots/${editingHotspot.id}`, data);\n      }\n      return apiRequest(\"POST\", \"/api/hotspots\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/hotspots\"] });\n      toast({\n        title: editingHotspot ? \"Hotspot Updated\" : \"Hotspot Created\",\n        description: `The hotspot has been ${editingHotspot ? \"updated\" : \"created\"} successfully.`,\n      });\n      handleCloseDialog();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save hotspot\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Delete mutation\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/hotspots/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/hotspots\"] });\n      toast({\n        title: \"Hotspot Deleted\",\n        description: \"The hotspot has been deleted successfully.\",\n      });\n      setDeletingHotspot(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to delete hotspot\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Toggle active mutation\n  const toggleMutation = useMutation({\n    mutationFn: async (hotspot: Hotspot) => {\n      return apiRequest(\"PATCH\", `/api/hotspots/${hotspot.id}`, {\n        isActive: !hotspot.isActive,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/hotspots\"] });\n      toast({\n        title: \"Hotspot Updated\",\n        description: \"The hotspot status has been updated.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update hotspot\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleOpenDialog = (hotspot?: Hotspot) => {\n    if (hotspot) {\n      setEditingHotspot(hotspot);\n      setFormData({\n        locationName: hotspot.locationName,\n        description: hotspot.description || \"\",\n        nasIp: hotspot.nasIp,\n        secret: hotspot.secret,\n      });\n    } else {\n      setEditingHotspot(null);\n      setFormData({\n        locationName: \"\",\n        description: \"\",\n        nasIp: \"\",\n        secret: \"\",\n      });\n    }\n    setIsDialogOpen(true);\n  };\n\n  const handleCloseDialog = () => {\n    setIsDialogOpen(false);\n    setEditingHotspot(null);\n    setFormData({\n      locationName: \"\",\n      description: \"\",\n      nasIp: \"\",\n      secret: \"\",\n    });\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    saveMutation.mutate(formData);\n  };\n\n  // Generate random secret\n  const generateSecret = () => {\n    const chars = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\";\n    let secret = \"\";\n    for (let i = 0; i < 16; i++) {\n      secret += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    setFormData({ ...formData, secret });\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"hotspots-page\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">Hotspots</h1>\n          <p className=\"text-muted-foreground\">\n            Manage your hotspot locations and NAS devices\n          </p>\n        </div>\n        <Button\n          className=\"gradient-btn\"\n          onClick={() => handleOpenDialog()}\n          data-testid=\"button-add-hotspot\"\n        >\n          <Plus size={18} className=\"mr-2\" />\n          Add Hotspot\n        </Button>\n      </div>\n\n      {/* Hotspots Grid */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n        {isLoading ? (\n          <>\n            <HotspotCardSkeleton />\n            <HotspotCardSkeleton />\n            <HotspotCardSkeleton />\n          </>\n        ) : hotspots && hotspots.length > 0 ? (\n          <AnimatePresence mode=\"popLayout\">\n            {hotspots.map((hotspot) => (\n              <HotspotCard\n                key={hotspot.id}\n                hotspot={hotspot}\n                onEdit={handleOpenDialog}\n                onDelete={setDeletingHotspot}\n                onToggleActive={(h) => toggleMutation.mutate(h)}\n              />\n            ))}\n            <AddHotspotButton onClick={() => handleOpenDialog()} />\n          </AnimatePresence>\n        ) : (\n          <GlassPanel className=\"col-span-full text-center py-12\">\n            <Wifi size={48} className=\"mx-auto mb-4 text-muted-foreground opacity-50\" />\n            <p className=\"text-muted-foreground mb-4\">No hotspots configured yet</p>\n            <Button\n              className=\"gradient-btn\"\n              onClick={() => handleOpenDialog()}\n              data-testid=\"button-create-first-hotspot\"\n            >\n              Add Your First Hotspot\n            </Button>\n          </GlassPanel>\n        )}\n      </div>\n\n      {/* Create/Edit Dialog */}\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"glass-panel border-white/10 max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"text-xl font-bold text-white\">\n              {editingHotspot ? \"Edit Hotspot\" : \"Add New Hotspot\"}\n            </DialogTitle>\n          </DialogHeader>\n\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\n            <GlassInput\n              label=\"Location Name\"\n              placeholder=\"e.g., Main Lobby, Cafe Area\"\n              value={formData.locationName}\n              onChange={(e) => setFormData({ ...formData, locationName: e.target.value })}\n              required\n              data-testid=\"input-hotspot-name\"\n            />\n\n            <GlassTextarea\n              label=\"Description\"\n              placeholder=\"Brief description of this location\"\n              value={formData.description || \"\"}\n              onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n              data-testid=\"input-hotspot-description\"\n            />\n\n            <GlassInput\n              label=\"NAS IP Address\"\n              placeholder=\"e.g., 192.168.1.1\"\n              value={formData.nasIp}\n              onChange={(e) => setFormData({ ...formData, nasIp: e.target.value })}\n              icon={<Server size={16} />}\n              required\n              data-testid=\"input-hotspot-ip\"\n            />\n\n            <div className=\"space-y-2\">\n              <GlassInput\n                label=\"RADIUS Secret\"\n                placeholder=\"Enter secret or generate one\"\n                value={formData.secret}\n                onChange={(e) => setFormData({ ...formData, secret: e.target.value })}\n                icon={<Shield size={16} />}\n                required\n                data-testid=\"input-hotspot-secret\"\n              />\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={generateSecret}\n                className=\"text-cyan-400 hover:text-cyan-300\"\n                data-testid=\"button-generate-secret\"\n              >\n                Generate Random Secret\n              </Button>\n            </div>\n\n            <div className=\"flex gap-3 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                onClick={handleCloseDialog}\n                className=\"flex-1\"\n                data-testid=\"button-cancel\"\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                className=\"flex-1 gradient-btn\"\n                disabled={saveMutation.isPending}\n                data-testid=\"button-save-hotspot\"\n              >\n                {saveMutation.isPending ? \"Saving...\" : editingHotspot ? \"Update Hotspot\" : \"Add Hotspot\"}\n              </Button>\n            </div>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Confirmation */}\n      <AlertDialog open={!!deletingHotspot} onOpenChange={() => setDeletingHotspot(null)}>\n        <AlertDialogContent className=\"glass-panel border-white/10\">\n          <AlertDialogHeader>\n            <AlertDialogTitle className=\"text-white\">Delete Hotspot</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to delete \"{deletingHotspot?.locationName}\"? This action cannot be undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete\">Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => deletingHotspot && deleteMutation.mutate(deletingHotspot.id)}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete\"\n            >\n              Delete\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":10792,"size_tokens":null},"client/src/components/mnetifi-logo.tsx":{"content":"import { motion } from \"framer-motion\";\nimport { Wifi } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface MnetiFiLogoProps {\n  size?: \"sm\" | \"md\" | \"lg\" | \"xl\";\n  showText?: boolean;\n  className?: string;\n}\n\nexport function MnetiFiLogo({ size = \"md\", showText = true, className }: MnetiFiLogoProps) {\n  const sizeConfig = {\n    sm: { icon: 20, text: \"text-lg\", gap: \"gap-2\" },\n    md: { icon: 28, text: \"text-2xl\", gap: \"gap-2\" },\n    lg: { icon: 36, text: \"text-3xl\", gap: \"gap-3\" },\n    xl: { icon: 48, text: \"text-4xl\", gap: \"gap-4\" },\n  };\n\n  const config = sizeConfig[size];\n\n  return (\n    <motion.div\n      className={cn(\"flex items-center\", config.gap, className)}\n      initial={{ opacity: 0, y: -10 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.5 }}\n      data-testid=\"mnetifi-logo\"\n    >\n      <motion.div\n        className=\"relative\"\n        whileHover={{ scale: 1.05 }}\n        transition={{ type: \"spring\", stiffness: 400 }}\n      >\n        {/* Gradient glow behind icon */}\n        <div\n          className=\"absolute inset-0 rounded-full blur-lg opacity-60\"\n          style={{\n            background: \"linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%)\",\n          }}\n        />\n        <div\n          className=\"relative flex items-center justify-center rounded-xl p-2\"\n          style={{\n            background: \"linear-gradient(135deg, rgba(6, 182, 212, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%)\",\n            border: \"1px solid rgba(6, 182, 212, 0.3)\",\n          }}\n        >\n          <Wifi\n            size={config.icon}\n            className=\"text-cyan-400\"\n            strokeWidth={2.5}\n          />\n        </div>\n      </motion.div>\n      \n      {showText && (\n        <div className=\"flex flex-col\">\n          <span\n            className={cn(\n              \"font-bold tracking-tight gradient-text\",\n              config.text\n            )}\n          >\n            MnetiFi\n          </span>\n          {size !== \"sm\" && (\n            <span className=\"text-xs text-muted-foreground tracking-wide uppercase\">\n              Wi-Fi Billing\n            </span>\n          )}\n        </div>\n      )}\n    </motion.div>\n  );\n}\n\n// M-Pesa Logo component\nexport function MpesaLogo({ size = 24 }: { size?: number }) {\n  return (\n    <svg\n      width={size}\n      height={size}\n      viewBox=\"0 0 24 24\"\n      fill=\"none\"\n      xmlns=\"http://www.w3.org/2000/svg\"\n      data-testid=\"mpesa-logo\"\n    >\n      <circle cx=\"12\" cy=\"12\" r=\"11\" fill=\"#4BB617\" />\n      <path\n        d=\"M7 12L10 15L17 8\"\n        stroke=\"white\"\n        strokeWidth=\"2.5\"\n        strokeLinecap=\"round\"\n        strokeLinejoin=\"round\"\n      />\n    </svg>\n  );\n}\n","path":null,"size_bytes":2681,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/pages/tickets.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Plus, \n  Ticket,\n  Clock,\n  Search,\n  MoreVertical,\n  MessageSquare,\n  CheckCircle,\n  AlertCircle,\n  AlertTriangle,\n  User,\n} from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput, GlassTextarea } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n  DropdownMenuSeparator,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { cn } from \"@/lib/utils\";\nimport type { Ticket as TicketType, InsertTicket, WifiUser } from \"@shared/schema\";\nimport { formatDistanceToNow, format } from \"date-fns\";\n\nconst statusLabels = {\n  OPEN: \"Open\",\n  IN_PROGRESS: \"In Progress\",\n  RESOLVED: \"Resolved\",\n  CLOSED: \"Closed\",\n};\n\nconst statusColors = {\n  OPEN: \"bg-blue-500/20 text-blue-400 border-blue-500/30\",\n  IN_PROGRESS: \"bg-amber-500/20 text-amber-400 border-amber-500/30\",\n  RESOLVED: \"bg-emerald-500/20 text-emerald-400 border-emerald-500/30\",\n  CLOSED: \"bg-gray-500/20 text-gray-400 border-gray-500/30\",\n};\n\nconst priorityLabels = {\n  LOW: \"Low\",\n  MEDIUM: \"Medium\",\n  HIGH: \"High\",\n  URGENT: \"Urgent\",\n};\n\nconst priorityColors = {\n  LOW: \"bg-gray-500/20 text-gray-400 border-gray-500/30\",\n  MEDIUM: \"bg-blue-500/20 text-blue-400 border-blue-500/30\",\n  HIGH: \"bg-amber-500/20 text-amber-400 border-amber-500/30\",\n  URGENT: \"bg-red-500/20 text-red-400 border-red-500/30\",\n};\n\nconst priorityIcons = {\n  LOW: AlertCircle,\n  MEDIUM: AlertCircle,\n  HIGH: AlertTriangle,\n  URGENT: AlertTriangle,\n};\n\nexport default function TicketsPage() {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [isCloseDialogOpen, setIsCloseDialogOpen] = useState(false);\n  const [editingTicket, setEditingTicket] = useState<TicketType | null>(null);\n  const [closingTicket, setClosingTicket] = useState<TicketType | null>(null);\n  const [resolutionNotes, setResolutionNotes] = useState(\"\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [filterStatus, setFilterStatus] = useState<string>(\"all\");\n  const [filterPriority, setFilterPriority] = useState<string>(\"all\");\n\n  const [formData, setFormData] = useState<Partial<InsertTicket>>({\n    subject: \"\",\n    issueDetails: \"\",\n    priority: \"MEDIUM\",\n    wifiUserId: \"\",\n  });\n\n  const { data: ticketsList, isLoading } = useQuery<TicketType[]>({\n    queryKey: [\"/api/tickets\"],\n  });\n\n  const { data: wifiUsers } = useQuery<WifiUser[]>({\n    queryKey: [\"/api/wifi-users\"],\n  });\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: Partial<InsertTicket>) => {\n      if (editingTicket) {\n        return apiRequest(\"PATCH\", `/api/tickets/${editingTicket.id}`, data);\n      }\n      return apiRequest(\"POST\", \"/api/tickets\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tickets\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/stats\"] });\n      toast({\n        title: editingTicket ? \"Ticket Updated\" : \"Ticket Created\",\n        description: `Ticket has been ${editingTicket ? \"updated\" : \"created\"} successfully.`,\n      });\n      handleCloseDialog();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save ticket\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const closeMutation = useMutation({\n    mutationFn: async ({ id, resolutionNotes }: { id: string; resolutionNotes: string }) => {\n      return apiRequest(\"POST\", `/api/tickets/${id}/close`, { resolutionNotes });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tickets\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/stats\"] });\n      toast({\n        title: \"Ticket Closed\",\n        description: \"Ticket has been closed successfully.\",\n      });\n      setIsCloseDialogOpen(false);\n      setClosingTicket(null);\n      setResolutionNotes(\"\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to close ticket\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async ({ id, status }: { id: string; status: string }) => {\n      return apiRequest(\"PATCH\", `/api/tickets/${id}`, { status });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tickets\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/stats\"] });\n      toast({\n        title: \"Status Updated\",\n        description: \"Ticket status has been updated.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update status\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleOpenDialog = (ticket?: TicketType) => {\n    if (ticket) {\n      setEditingTicket(ticket);\n      setFormData({\n        subject: ticket.subject,\n        issueDetails: ticket.issueDetails,\n        priority: ticket.priority,\n        wifiUserId: ticket.wifiUserId || \"\",\n      });\n    } else {\n      setEditingTicket(null);\n      setFormData({\n        subject: \"\",\n        issueDetails: \"\",\n        priority: \"MEDIUM\",\n        wifiUserId: \"\",\n      });\n    }\n    setIsDialogOpen(true);\n  };\n\n  const handleCloseDialog = () => {\n    setIsDialogOpen(false);\n    setEditingTicket(null);\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    const dataToSubmit = {\n      ...formData,\n      wifiUserId: formData.wifiUserId || null,\n    };\n    saveMutation.mutate(dataToSubmit);\n  };\n\n  const handleOpenCloseDialog = (ticket: TicketType) => {\n    setClosingTicket(ticket);\n    setResolutionNotes(ticket.resolutionNotes || \"\");\n    setIsCloseDialogOpen(true);\n  };\n\n  const filteredTickets = ticketsList?.filter((ticket) => {\n    const matchesSearch = \n      ticket.subject.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      ticket.issueDetails.toLowerCase().includes(searchQuery.toLowerCase());\n    \n    const matchesStatus = filterStatus === \"all\" || ticket.status === filterStatus;\n    const matchesPriority = filterPriority === \"all\" || ticket.priority === filterPriority;\n    \n    return matchesSearch && matchesStatus && matchesPriority;\n  });\n\n  const wifiUsersMap = new Map(wifiUsers?.map((u) => [u.id, u]) || []);\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"tickets-page\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">Support Tickets</h1>\n          <p className=\"text-muted-foreground\">\n            Track and manage customer support requests\n          </p>\n        </div>\n        <Button\n          className=\"gradient-btn\"\n          onClick={() => handleOpenDialog()}\n          data-testid=\"button-add-ticket\"\n        >\n          <Plus size={18} className=\"mr-2\" />\n          New Ticket\n        </Button>\n      </div>\n\n      <GlassPanel size=\"sm\" className=\"flex flex-wrap gap-4 items-center\">\n        <div className=\"relative flex-1 min-w-[200px]\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" size={18} />\n          <input\n            type=\"text\"\n            placeholder=\"Search tickets...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"w-full pl-10 pr-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-cyan-500/50\"\n            data-testid=\"input-search-tickets\"\n          />\n        </div>\n        \n        <Select value={filterStatus} onValueChange={setFilterStatus}>\n          <SelectTrigger className=\"w-[150px] bg-white/5 border-white/10\" data-testid=\"select-ticket-status\">\n            <SelectValue placeholder=\"Status\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Status</SelectItem>\n            <SelectItem value=\"OPEN\">Open</SelectItem>\n            <SelectItem value=\"IN_PROGRESS\">In Progress</SelectItem>\n            <SelectItem value=\"RESOLVED\">Resolved</SelectItem>\n            <SelectItem value=\"CLOSED\">Closed</SelectItem>\n          </SelectContent>\n        </Select>\n\n        <Select value={filterPriority} onValueChange={setFilterPriority}>\n          <SelectTrigger className=\"w-[130px] bg-white/5 border-white/10\" data-testid=\"select-ticket-priority\">\n            <SelectValue placeholder=\"Priority\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Priority</SelectItem>\n            <SelectItem value=\"LOW\">Low</SelectItem>\n            <SelectItem value=\"MEDIUM\">Medium</SelectItem>\n            <SelectItem value=\"HIGH\">High</SelectItem>\n            <SelectItem value=\"URGENT\">Urgent</SelectItem>\n          </SelectContent>\n        </Select>\n      </GlassPanel>\n\n      <div className=\"space-y-4\">\n        {isLoading ? (\n          <div className=\"space-y-4\">\n            {[1, 2, 3].map((i) => (\n              <GlassPanel key={i} className=\"animate-pulse\">\n                <div className=\"space-y-3\">\n                  <div className=\"h-5 bg-white/10 rounded w-1/3\" />\n                  <div className=\"h-4 bg-white/10 rounded w-2/3\" />\n                </div>\n              </GlassPanel>\n            ))}\n          </div>\n        ) : filteredTickets && filteredTickets.length > 0 ? (\n          <AnimatePresence mode=\"popLayout\">\n            {filteredTickets.map((ticket) => {\n              const PriorityIcon = priorityIcons[ticket.priority as keyof typeof priorityIcons];\n              const wifiUser = ticket.wifiUserId ? wifiUsersMap.get(ticket.wifiUserId) : null;\n              \n              return (\n                <motion.div\n                  key={ticket.id}\n                  layout\n                  initial={{ opacity: 0, y: 10 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  exit={{ opacity: 0, y: -10 }}\n                >\n                  <GlassPanel className=\"hover:bg-white/[0.03] transition-colors\">\n                    <div className=\"flex flex-col md:flex-row md:items-start gap-4\">\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2 flex-wrap mb-2\">\n                          <h3 className=\"font-semibold text-white\" data-testid={`text-ticket-subject-${ticket.id}`}>\n                            {ticket.subject}\n                          </h3>\n                          <Badge \n                            variant=\"outline\" \n                            className={cn(\"text-xs\", statusColors[ticket.status as keyof typeof statusColors])}\n                          >\n                            {statusLabels[ticket.status as keyof typeof statusLabels]}\n                          </Badge>\n                          <Badge \n                            variant=\"outline\" \n                            className={cn(\"text-xs flex items-center gap-1\", priorityColors[ticket.priority as keyof typeof priorityColors])}\n                          >\n                            <PriorityIcon size={12} />\n                            {priorityLabels[ticket.priority as keyof typeof priorityLabels]}\n                          </Badge>\n                        </div>\n                        \n                        <p className=\"text-sm text-muted-foreground line-clamp-2 mb-2\">\n                          {ticket.issueDetails}\n                        </p>\n                        \n                        <div className=\"flex items-center gap-4 text-xs text-muted-foreground\">\n                          {wifiUser && (\n                            <span className=\"flex items-center gap-1\">\n                              <User size={12} />\n                              {wifiUser.fullName || wifiUser.phoneNumber}\n                            </span>\n                          )}\n                          <span className=\"flex items-center gap-1\">\n                            <Clock size={12} />\n                            Created {formatDistanceToNow(new Date(ticket.createdAt!), { addSuffix: true })}\n                          </span>\n                          {ticket.closedAt && (\n                            <span className=\"flex items-center gap-1\">\n                              <CheckCircle size={12} />\n                              Closed {formatDistanceToNow(new Date(ticket.closedAt), { addSuffix: true })}\n                            </span>\n                          )}\n                        </div>\n                        \n                        {ticket.resolutionNotes && (\n                          <div className=\"mt-3 p-3 bg-white/5 rounded-lg border border-white/10\">\n                            <p className=\"text-xs text-muted-foreground mb-1\">Resolution Notes:</p>\n                            <p className=\"text-sm text-white\">{ticket.resolutionNotes}</p>\n                          </div>\n                        )}\n                      </div>\n\n                      <div className=\"flex items-center gap-2\">\n                        {ticket.status !== \"CLOSED\" && (\n                          <Select \n                            value={ticket.status} \n                            onValueChange={(status) => updateStatusMutation.mutate({ id: ticket.id, status })}\n                          >\n                            <SelectTrigger className=\"w-[130px] bg-white/5 border-white/10 text-xs h-8\">\n                              <SelectValue />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"OPEN\">Open</SelectItem>\n                              <SelectItem value=\"IN_PROGRESS\">In Progress</SelectItem>\n                              <SelectItem value=\"RESOLVED\">Resolved</SelectItem>\n                            </SelectContent>\n                          </Select>\n                        )}\n                        \n                        <DropdownMenu>\n                          <DropdownMenuTrigger asChild>\n                            <Button variant=\"ghost\" size=\"icon\" data-testid={`button-ticket-actions-${ticket.id}`}>\n                              <MoreVertical size={18} />\n                            </Button>\n                          </DropdownMenuTrigger>\n                          <DropdownMenuContent align=\"end\" className=\"w-48\">\n                            <DropdownMenuItem onClick={() => handleOpenDialog(ticket)}>\n                              <MessageSquare size={16} className=\"mr-2\" />\n                              Edit Ticket\n                            </DropdownMenuItem>\n                            {ticket.status !== \"CLOSED\" && (\n                              <>\n                                <DropdownMenuSeparator />\n                                <DropdownMenuItem \n                                  onClick={() => handleOpenCloseDialog(ticket)}\n                                  className=\"text-emerald-400\"\n                                >\n                                  <CheckCircle size={16} className=\"mr-2\" />\n                                  Close Ticket\n                                </DropdownMenuItem>\n                              </>\n                            )}\n                          </DropdownMenuContent>\n                        </DropdownMenu>\n                      </div>\n                    </div>\n                  </GlassPanel>\n                </motion.div>\n              );\n            })}\n          </AnimatePresence>\n        ) : (\n          <GlassPanel className=\"text-center py-12\">\n            <Ticket size={48} className=\"mx-auto mb-4 text-muted-foreground opacity-50\" />\n            <p className=\"text-muted-foreground mb-4\">\n              {searchQuery || filterStatus !== \"all\" || filterPriority !== \"all\"\n                ? \"No tickets match your search criteria\"\n                : \"No support tickets yet\"}\n            </p>\n            {!searchQuery && filterStatus === \"all\" && filterPriority === \"all\" && (\n              <Button\n                className=\"gradient-btn\"\n                onClick={() => handleOpenDialog()}\n                data-testid=\"button-create-first-ticket\"\n              >\n                Create Your First Ticket\n              </Button>\n            )}\n          </GlassPanel>\n        )}\n      </div>\n\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"glass-panel border-white/10 max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"text-xl font-bold text-white\">\n              {editingTicket ? \"Edit Ticket\" : \"Create New Ticket\"}\n            </DialogTitle>\n          </DialogHeader>\n\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <GlassInput\n              label=\"Subject\"\n              placeholder=\"Brief description of the issue\"\n              value={formData.subject}\n              onChange={(e) => setFormData({ ...formData, subject: e.target.value })}\n              required\n              data-testid=\"input-ticket-subject\"\n            />\n\n            <GlassTextarea\n              label=\"Issue Details\"\n              placeholder=\"Describe the issue in detail...\"\n              value={formData.issueDetails || \"\"}\n              onChange={(e) => setFormData({ ...formData, issueDetails: e.target.value })}\n              required\n              data-testid=\"input-ticket-details\"\n            />\n\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium uppercase tracking-wider text-muted-foreground\">\n                Priority\n              </label>\n              <div className=\"flex gap-2\">\n                {([\"LOW\", \"MEDIUM\", \"HIGH\", \"URGENT\"] as const).map((priority) => (\n                  <button\n                    key={priority}\n                    type=\"button\"\n                    onClick={() => setFormData({ ...formData, priority })}\n                    className={cn(\n                      \"flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all\",\n                      formData.priority === priority\n                        ? priorityColors[priority]\n                        : \"bg-white/5 text-muted-foreground border border-white/10 hover:bg-white/10\"\n                    )}\n                    data-testid={`button-priority-${priority}`}\n                  >\n                    {priorityLabels[priority]}\n                  </button>\n                ))}\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium uppercase tracking-wider text-muted-foreground\">\n                Related Customer (Optional)\n              </label>\n              <Select \n                value={formData.wifiUserId || \"\"} \n                onValueChange={(value) => setFormData({ ...formData, wifiUserId: value || undefined })}\n              >\n                <SelectTrigger className=\"bg-white/5 border-white/10\" data-testid=\"select-ticket-user\">\n                  <SelectValue placeholder=\"Select a customer (optional)\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"\">None</SelectItem>\n                  {wifiUsers?.map((user) => (\n                    <SelectItem key={user.id} value={user.id}>\n                      {user.fullName || user.phoneNumber}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"flex gap-3 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                onClick={handleCloseDialog}\n                className=\"flex-1\"\n                data-testid=\"button-cancel-ticket\"\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                className=\"flex-1 gradient-btn\"\n                disabled={saveMutation.isPending}\n                data-testid=\"button-save-ticket\"\n              >\n                {saveMutation.isPending ? \"Saving...\" : editingTicket ? \"Update Ticket\" : \"Create Ticket\"}\n              </Button>\n            </div>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={isCloseDialogOpen} onOpenChange={setIsCloseDialogOpen}>\n        <DialogContent className=\"glass-panel border-white/10 max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"text-xl font-bold text-white\">\n              Close Ticket\n            </DialogTitle>\n          </DialogHeader>\n\n          <div className=\"space-y-4\">\n            <p className=\"text-muted-foreground\">\n              You are about to close ticket: <strong className=\"text-white\">{closingTicket?.subject}</strong>\n            </p>\n\n            <GlassTextarea\n              label=\"Resolution Notes\"\n              placeholder=\"Describe how the issue was resolved...\"\n              value={resolutionNotes}\n              onChange={(e) => setResolutionNotes(e.target.value)}\n              data-testid=\"input-resolution-notes\"\n            />\n\n            <div className=\"flex gap-3 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                onClick={() => setIsCloseDialogOpen(false)}\n                className=\"flex-1\"\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={() => closingTicket && closeMutation.mutate({ \n                  id: closingTicket.id, \n                  resolutionNotes \n                })}\n                className=\"flex-1 gradient-btn\"\n                disabled={closeMutation.isPending}\n                data-testid=\"button-confirm-close\"\n              >\n                {closeMutation.isPending ? \"Closing...\" : \"Close Ticket\"}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":22565,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, integer, boolean, timestamp, jsonb, inet } from \"drizzle-orm/pg-core\";\nimport { relations } from \"drizzle-orm\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Account types for WiFi users\nexport const AccountType = {\n  HOTSPOT: \"HOTSPOT\",\n  PPPOE: \"PPPOE\",\n  STATIC: \"STATIC\",\n} as const;\nexport type AccountTypeValue = typeof AccountType[keyof typeof AccountType];\n\n// Ticket status\nexport const TicketStatus = {\n  OPEN: \"OPEN\",\n  IN_PROGRESS: \"IN_PROGRESS\",\n  RESOLVED: \"RESOLVED\",\n  CLOSED: \"CLOSED\",\n} as const;\nexport type TicketStatusValue = typeof TicketStatus[keyof typeof TicketStatus];\n\n// Ticket priority\nexport const TicketPriority = {\n  LOW: \"LOW\",\n  MEDIUM: \"MEDIUM\",\n  HIGH: \"HIGH\",\n  URGENT: \"URGENT\",\n} as const;\nexport type TicketPriorityValue = typeof TicketPriority[keyof typeof TicketPriority];\n\n// SaaS billing status for tenant\nexport const SaaSBillingStatus = {\n  ACTIVE: \"ACTIVE\",\n  TRIAL: \"TRIAL\",\n  SUSPENDED: \"SUSPENDED\",\n  BLOCKED: \"BLOCKED\",\n} as const;\nexport type SaaSBillingStatusValue = typeof SaaSBillingStatus[keyof typeof SaaSBillingStatus];\n\n// Tenant subscription tier\nexport const SubscriptionTier = {\n  BASIC: \"BASIC\",      // Free 24hr trial - Hotspot features only\n  PREMIUM: \"PREMIUM\",  // Full features - PPPoE, Static IP, Technicians, etc.\n} as const;\nexport type SubscriptionTierValue = typeof SubscriptionTier[keyof typeof SubscriptionTier];\n\n// Feature sets for each tier\nexport const TierFeatures = {\n  BASIC: [\n    \"dashboard\",\n    \"wifi-users\", \n    \"hotspot-plans\",\n    \"transactions\",\n    \"hotspots\",\n    \"vouchers\",\n    \"zones\",\n    \"settings\",\n    \"walled-garden\",\n    \"portal\",\n    \"tickets\",\n  ],\n  PREMIUM: [\n    \"dashboard\",\n    \"wifi-users\",\n    \"hotspot-plans\", \n    \"pppoe-plans\",\n    \"static-plans\",\n    \"transactions\",\n    \"hotspots\",\n    \"vouchers\",\n    \"zones\",\n    \"settings\",\n    \"walled-garden\",\n    \"portal\",\n    \"technicians\",\n    \"sms-campaigns\",\n    \"network-monitoring\",\n    \"chat\",\n    \"loyalty\",\n    \"security\",\n    \"reconciliation\",\n    \"tickets\",\n    \"reports\",\n  ]\n} as const;\n\n// User roles for RBAC\nexport const UserRole = {\n  SUPERADMIN: \"superadmin\",\n  ADMIN: \"admin\",\n  TECH: \"tech\",\n} as const;\nexport type UserRoleValue = typeof UserRole[keyof typeof UserRole];\n\n// WiFi User status\nexport const WifiUserStatus = {\n  ACTIVE: \"ACTIVE\",\n  SUSPENDED: \"SUSPENDED\",\n  EXPIRED: \"EXPIRED\",\n} as const;\nexport type WifiUserStatusValue = typeof WifiUserStatus[keyof typeof WifiUserStatus];\n\n// Reconciliation status for transactions\nexport const ReconciliationStatus = {\n  MATCHED: \"MATCHED\",\n  UNMATCHED: \"UNMATCHED\",\n  MANUAL_REVIEW: \"MANUAL_REVIEW\",\n  PENDING: \"PENDING\",\n} as const;\nexport type ReconciliationStatusValue = typeof ReconciliationStatus[keyof typeof ReconciliationStatus];\n\n// ISP Payment Method for registration\nexport const ISPPaymentMethod = {\n  MPESA: \"MPESA\",\n  BANK: \"BANK\",\n  PAYPAL: \"PAYPAL\",\n} as const;\nexport type ISPPaymentMethodValue = typeof ISPPaymentMethod[keyof typeof ISPPaymentMethod];\n\n// ISP Registration Payment Status\nexport const ISPPaymentStatus = {\n  PENDING: \"PENDING\",\n  COMPLETED: \"COMPLETED\",\n  FAILED: \"FAILED\",\n} as const;\nexport type ISPPaymentStatusValue = typeof ISPPaymentStatus[keyof typeof ISPPaymentStatus];\n\n// Tenant - Multi-tenant SaaS organization\nexport const tenants = pgTable(\"tenants\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  subdomain: text(\"subdomain\").notNull().unique(),\n  website: text(\"website\"),\n  email: text(\"email\"),\n  phone: text(\"phone\"),\n  brandingConfig: jsonb(\"branding_config\").$type<{\n    logo?: string;\n    primaryColor?: string;\n    secondaryColor?: string;\n    tagline?: string;\n    welcomeMessage?: string;\n    supportEmail?: string;\n    supportPhone?: string;\n    footerText?: string;\n    showPoweredBy?: boolean;\n    cardStyle?: 'glass' | 'solid' | 'gradient';\n    animationsEnabled?: boolean;\n    backgroundGradient?: string;\n  }>().default({}),\n  mpesaShortcode: text(\"mpesa_shortcode\"),\n  mpesaPasskey: text(\"mpesa_passkey\"),\n  mpesaConsumerKey: text(\"mpesa_consumer_key\"),\n  mpesaConsumerSecret: text(\"mpesa_consumer_secret\"),\n  smsProvider: text(\"sms_provider\").default(\"mock\"), // mock, africas_talking, twilio\n  smsApiKey: text(\"sms_api_key\"),\n  smsUsername: text(\"sms_username\"),\n  smsSenderId: text(\"sms_sender_id\"),\n  // WhatsApp Business API configuration\n  whatsappProvider: text(\"whatsapp_provider\").default(\"mock\"), // mock, meta, twilio\n  whatsappApiKey: text(\"whatsapp_api_key\"),\n  whatsappPhoneNumberId: text(\"whatsapp_phone_number_id\"),\n  whatsappBusinessAccountId: text(\"whatsapp_business_account_id\"),\n  subscriptionTier: text(\"subscription_tier\").default(\"BASIC\"),\n  trialExpiresAt: timestamp(\"trial_expires_at\"),\n  subscriptionExpiresAt: timestamp(\"subscription_expires_at\"),\n  monthlyRevenue: integer(\"monthly_revenue\").default(0),\n  totalUsers: integer(\"total_users\").default(0),\n  saasBillingStatus: text(\"saas_billing_status\").default(\"TRIAL\"),\n  isActive: boolean(\"is_active\").default(true),\n  registrationPaymentMethod: text(\"registration_payment_method\"), // MPESA, BANK, PAYPAL\n  registrationPaymentStatus: text(\"registration_payment_status\").default(\"PENDING\"), // PENDING, COMPLETED, FAILED\n  registrationPaymentRef: text(\"registration_payment_ref\"), // Reference number for payment\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const tenantsRelations = relations(tenants, ({ many }) => ({\n  hotspots: many(hotspots),\n  plans: many(plans),\n  transactions: many(transactions),\n  walledGardens: many(walledGardens),\n  wifiUsers: many(wifiUsers),\n  tickets: many(tickets),\n}));\n\n// Hotspot - NAS device locations\nexport const hotspots = pgTable(\"hotspots\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  nasIp: text(\"nas_ip\").notNull(),\n  secret: text(\"secret\").notNull(),\n  locationName: text(\"location_name\").notNull(),\n  description: text(\"description\"),\n  routerApiIp: text(\"router_api_ip\"),\n  routerApiUser: text(\"router_api_user\"),\n  routerApiPass: text(\"router_api_pass\"),\n  routerApiPort: integer(\"router_api_port\").default(8728),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const hotspotsRelations = relations(hotspots, ({ one }) => ({\n  tenant: one(tenants, {\n    fields: [hotspots.tenantId],\n    references: [tenants.id],\n  }),\n}));\n\n// Plan type\nexport const PlanType = {\n  HOTSPOT: \"HOTSPOT\",\n  PPPOE: \"PPPOE\",\n  STATIC: \"STATIC\",\n} as const;\nexport type PlanTypeValue = typeof PlanType[keyof typeof PlanType];\n\n// Plan - WiFi subscription plans\nexport const plans = pgTable(\"plans\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  price: integer(\"price\").notNull(), // In smallest currency unit (cents/shillings)\n  durationSeconds: integer(\"duration_seconds\").notNull(),\n  planType: text(\"plan_type\").notNull().default(\"HOTSPOT\"), // HOTSPOT, PPPOE, STATIC\n  speedMbps: integer(\"speed_mbps\"), // Speed in Mbps for PPPoE/Static plans\n  uploadLimit: text(\"upload_limit\"), // e.g., \"2M\" for MikroTik\n  downloadLimit: text(\"download_limit\"), // e.g., \"5M\" for MikroTik\n  burstRateUp: text(\"burst_rate_up\"), // e.g., \"4M\" burst upload\n  burstRateDown: text(\"burst_rate_down\"), // e.g., \"10M\" burst download\n  burstThreshold: text(\"burst_threshold\"), // e.g., \"1M\"\n  burstTime: integer(\"burst_time\"), // in seconds\n  simultaneousUse: integer(\"simultaneous_use\").default(1),\n  maxDevices: integer(\"max_devices\").default(1), // Maximum devices allowed per voucher\n  isActive: boolean(\"is_active\").default(true),\n  sortOrder: integer(\"sort_order\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const plansRelations = relations(plans, ({ one, many }) => ({\n  tenant: one(tenants, {\n    fields: [plans.tenantId],\n    references: [tenants.id],\n  }),\n  transactions: many(transactions),\n}));\n\n// Transaction - Payment records\nexport const transactions = pgTable(\"transactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  planId: varchar(\"plan_id\").references(() => plans.id),\n  wifiUserId: varchar(\"wifi_user_id\"),\n  userPhone: text(\"user_phone\").notNull(),\n  voucherCode: text(\"voucher_code\"), // Voucher code associated with transaction\n  amount: integer(\"amount\").notNull(),\n  mpesaReceiptNumber: text(\"mpesa_receipt_number\"),\n  checkoutRequestId: text(\"checkout_request_id\"),\n  merchantRequestId: text(\"merchant_request_id\"),\n  status: text(\"status\").notNull().default(\"PENDING\"), // PENDING, COMPLETED, FAILED\n  reconciliationStatus: text(\"reconciliation_status\").default(\"PENDING\"), // MATCHED, UNMATCHED, MANUAL_REVIEW, PENDING\n  statusDescription: text(\"status_description\"),\n  macAddress: text(\"mac_address\"),\n  nasIp: text(\"nas_ip\"),\n  radiusSessionId: text(\"radius_session_id\"),\n  expiresAt: timestamp(\"expires_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const transactionsRelations = relations(transactions, ({ one }) => ({\n  tenant: one(tenants, {\n    fields: [transactions.tenantId],\n    references: [tenants.id],\n  }),\n  plan: one(plans, {\n    fields: [transactions.planId],\n    references: [plans.id],\n  }),\n}));\n\n// Walled Garden - Allowed domains before authentication\nexport const walledGardens = pgTable(\"walled_gardens\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  domain: text(\"domain\").notNull(),\n  description: text(\"description\"),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const walledGardensRelations = relations(walledGardens, ({ one }) => ({\n  tenant: one(tenants, {\n    fields: [walledGardens.tenantId],\n    references: [tenants.id],\n  }),\n}));\n\n// Users - Admin users for dashboard access\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").references(() => tenants.id),\n  username: text(\"username\").notNull().unique(),\n  password: text(\"password\").notNull(),\n  email: text(\"email\"),\n  role: text(\"role\").notNull().default(\"admin\"), // superadmin, admin, tech\n  isActive: boolean(\"is_active\").default(true),\n  emailVerified: boolean(\"email_verified\").default(false),\n  emailVerificationToken: text(\"email_verification_token\"),\n  emailVerificationExpiry: timestamp(\"email_verification_expiry\"),\n  resetToken: text(\"reset_token\"),\n  resetTokenExpiry: timestamp(\"reset_token_expiry\"),\n  twoFactorEnabled: boolean(\"two_factor_enabled\").default(false),\n  twoFactorSecret: text(\"two_factor_secret\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const usersRelations = relations(users, ({ one }) => ({\n  tenant: one(tenants, {\n    fields: [users.tenantId],\n    references: [tenants.id],\n  }),\n}));\n\n// WifiUser - End customers who use the WiFi service\nexport const wifiUsers = pgTable(\"wifi_users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  phoneNumber: text(\"phone_number\").notNull(),\n  email: text(\"email\"),\n  fullName: text(\"full_name\"),\n  accountType: text(\"account_type\").notNull().default(\"HOTSPOT\"), // HOTSPOT, PPPOE, STATIC\n  voucherCode: text(\"voucher_code\"), // Voucher code for hotspot users\n  currentPlanId: varchar(\"current_plan_id\").references(() => plans.id),\n  currentHotspotId: varchar(\"current_hotspot_id\").references(() => hotspots.id),\n  technicianId: varchar(\"technician_id\").references(() => users.id), // Assigned technician\n  zoneId: varchar(\"zone_id\"), // Assigned zone (references zones table)\n  expiryTime: timestamp(\"expiry_time\"),\n  macAddress: text(\"mac_address\"),\n  ipAddress: text(\"ip_address\"),\n  username: text(\"username\"),\n  password: text(\"password\"),\n  status: text(\"status\").notNull().default(\"ACTIVE\"), // ACTIVE, SUSPENDED, EXPIRED\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const wifiUsersRelations = relations(wifiUsers, ({ one, many }) => ({\n  tenant: one(tenants, {\n    fields: [wifiUsers.tenantId],\n    references: [tenants.id],\n  }),\n  currentPlan: one(plans, {\n    fields: [wifiUsers.currentPlanId],\n    references: [plans.id],\n  }),\n  currentHotspot: one(hotspots, {\n    fields: [wifiUsers.currentHotspotId],\n    references: [hotspots.id],\n  }),\n  technician: one(users, {\n    fields: [wifiUsers.technicianId],\n    references: [users.id],\n  }),\n  tickets: many(tickets),\n}));\n\n// Ticket - Support tickets for customer issues\nexport const tickets = pgTable(\"tickets\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  wifiUserId: varchar(\"wifi_user_id\").references(() => wifiUsers.id),\n  subject: text(\"subject\").notNull(),\n  issueDetails: text(\"issue_details\").notNull(),\n  status: text(\"status\").notNull().default(\"OPEN\"), // OPEN, IN_PROGRESS, RESOLVED, CLOSED\n  priority: text(\"priority\").notNull().default(\"MEDIUM\"), // LOW, MEDIUM, HIGH, URGENT\n  resolutionNotes: text(\"resolution_notes\"),\n  assignedTo: varchar(\"assigned_to\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  closedAt: timestamp(\"closed_at\"),\n});\n\nexport const ticketsRelations = relations(tickets, ({ one }) => ({\n  tenant: one(tenants, {\n    fields: [tickets.tenantId],\n    references: [tenants.id],\n  }),\n  wifiUser: one(wifiUsers, {\n    fields: [tickets.wifiUserId],\n    references: [wifiUsers.id],\n  }),\n  assignee: one(users, {\n    fields: [tickets.assignedTo],\n    references: [users.id],\n  }),\n}));\n\n// Insert Schemas\nexport const insertTenantSchema = createInsertSchema(tenants).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertHotspotSchema = createInsertSchema(hotspots).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertPlanSchema = createInsertSchema(plans).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertTransactionSchema = createInsertSchema(transactions).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertWalledGardenSchema = createInsertSchema(walledGardens).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertUserSchema = createInsertSchema(users).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertWifiUserSchema = createInsertSchema(wifiUsers).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertTicketSchema = createInsertSchema(tickets).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  closedAt: true,\n});\n\n// Types\nexport type Tenant = typeof tenants.$inferSelect;\nexport type InsertTenant = z.infer<typeof insertTenantSchema>;\n\nexport type Hotspot = typeof hotspots.$inferSelect;\nexport type InsertHotspot = z.infer<typeof insertHotspotSchema>;\n\nexport type Plan = typeof plans.$inferSelect;\nexport type InsertPlan = z.infer<typeof insertPlanSchema>;\n\nexport type Transaction = typeof transactions.$inferSelect;\nexport type InsertTransaction = z.infer<typeof insertTransactionSchema>;\n\nexport type WalledGarden = typeof walledGardens.$inferSelect;\nexport type InsertWalledGarden = z.infer<typeof insertWalledGardenSchema>;\n\nexport type User = typeof users.$inferSelect;\nexport type InsertUser = z.infer<typeof insertUserSchema>;\n\nexport type WifiUser = typeof wifiUsers.$inferSelect;\nexport type InsertWifiUser = z.infer<typeof insertWifiUserSchema>;\n\nexport type Ticket = typeof tickets.$inferSelect;\nexport type InsertTicket = z.infer<typeof insertTicketSchema>;\n\n// Transaction status enum for type safety\nexport const TransactionStatus = {\n  PENDING: \"PENDING\",\n  COMPLETED: \"COMPLETED\",\n  FAILED: \"FAILED\",\n} as const;\n\nexport type TransactionStatusType = typeof TransactionStatus[keyof typeof TransactionStatus];\n\n// Job status for background queue\nexport const JobStatus = {\n  PENDING: \"PENDING\",\n  PROCESSING: \"PROCESSING\",\n  COMPLETED: \"COMPLETED\",\n  FAILED: \"FAILED\",\n  RETRY: \"RETRY\",\n} as const;\nexport type JobStatusType = typeof JobStatus[keyof typeof JobStatus];\n\n// Job types\nexport const JobType = {\n  PAYMENT_STATUS_CHECK: \"PAYMENT_STATUS_CHECK\",\n  USER_EXPIRY_CHECK: \"USER_EXPIRY_CHECK\",\n  RECONCILIATION: \"RECONCILIATION\",\n  SMS_NOTIFICATION: \"SMS_NOTIFICATION\",\n  EMAIL_NOTIFICATION: \"EMAIL_NOTIFICATION\",\n} as const;\nexport type JobTypeValue = typeof JobType[keyof typeof JobType];\n\n// Background Jobs - Database-backed job queue for resilience\nexport const jobs = pgTable(\"jobs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").references(() => tenants.id),\n  type: text(\"type\").notNull(), // PAYMENT_STATUS_CHECK, USER_EXPIRY_CHECK, etc.\n  payload: jsonb(\"payload\").$type<Record<string, unknown>>().notNull(),\n  status: text(\"status\").notNull().default(\"PENDING\"), // PENDING, PROCESSING, COMPLETED, FAILED, RETRY\n  priority: integer(\"priority\").default(0), // Higher = more urgent\n  attempts: integer(\"attempts\").default(0),\n  maxAttempts: integer(\"max_attempts\").default(3),\n  lastError: text(\"last_error\"),\n  scheduledFor: timestamp(\"scheduled_for\").defaultNow(),\n  startedAt: timestamp(\"started_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const jobsRelations = relations(jobs, ({ one }) => ({\n  tenant: one(tenants, {\n    fields: [jobs.tenantId],\n    references: [tenants.id],\n  }),\n}));\n\nexport const insertJobSchema = createInsertSchema(jobs).omit({\n  id: true,\n  attempts: true,\n  startedAt: true,\n  completedAt: true,\n  createdAt: true,\n});\n\nexport type Job = typeof jobs.$inferSelect;\nexport type InsertJob = z.infer<typeof insertJobSchema>;\n\n// SMS Campaigns - Bulk SMS message tracking\nexport const SmsCampaignStatus = {\n  PENDING: \"pending\",\n  SENDING: \"sending\",\n  COMPLETED: \"completed\",\n  FAILED: \"failed\",\n} as const;\nexport type SmsCampaignStatusValue = typeof SmsCampaignStatus[keyof typeof SmsCampaignStatus];\n\nexport const smsCampaigns = pgTable(\"sms_campaigns\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  name: text(\"name\").notNull(),\n  message: text(\"message\").notNull(),\n  recipientCount: integer(\"recipient_count\").notNull().default(0),\n  sentCount: integer(\"sent_count\").default(0),\n  failedCount: integer(\"failed_count\").default(0),\n  status: text(\"status\").notNull().default(\"pending\"), // pending, sending, completed, failed\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const smsCampaignsRelations = relations(smsCampaigns, ({ one }) => ({\n  tenant: one(tenants, {\n    fields: [smsCampaigns.tenantId],\n    references: [tenants.id],\n  }),\n}));\n\nexport const insertSmsCampaignSchema = createInsertSchema(smsCampaigns).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type SmsCampaign = typeof smsCampaigns.$inferSelect;\nexport type InsertSmsCampaign = z.infer<typeof insertSmsCampaignSchema>;\n\n// Guest Pass Status\nexport const GuestPassStatus = {\n  ACTIVE: \"ACTIVE\",\n  EXPIRED: \"EXPIRED\",\n  EXHAUSTED: \"EXHAUSTED\",\n} as const;\nexport type GuestPassStatusValue = typeof GuestPassStatus[keyof typeof GuestPassStatus];\n\n// Guest Passes - Free trial/guest access vouchers\nexport const guestPasses = pgTable(\"guest_passes\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  code: text(\"code\").notNull(), // Unique voucher code for redemption\n  name: text(\"name\").notNull(), // Descriptive name like \"Weekend Trial\"\n  durationSeconds: integer(\"duration_seconds\").notNull(), // How long access lasts\n  usageLimit: integer(\"usage_limit\").notNull().default(1), // How many times can be redeemed\n  usedCount: integer(\"used_count\").notNull().default(0), // Times already used\n  speedLimitUp: text(\"speed_limit_up\"), // Optional upload limit e.g. \"1M\"\n  speedLimitDown: text(\"speed_limit_down\"), // Optional download limit e.g. \"2M\"\n  validFrom: timestamp(\"valid_from\").defaultNow(), // When pass becomes valid\n  validUntil: timestamp(\"valid_until\"), // When pass expires (null = never)\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const guestPassesRelations = relations(guestPasses, ({ one }) => ({\n  tenant: one(tenants, {\n    fields: [guestPasses.tenantId],\n    references: [tenants.id],\n  }),\n}));\n\nexport const insertGuestPassSchema = createInsertSchema(guestPasses).omit({\n  id: true,\n  usedCount: true,\n  createdAt: true,\n});\n\nexport type GuestPass = typeof guestPasses.$inferSelect;\nexport type InsertGuestPass = z.infer<typeof insertGuestPassSchema>;\n\n// Guest Pass Redemptions - Track when passes are used\nexport const guestPassRedemptions = pgTable(\"guest_pass_redemptions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  guestPassId: varchar(\"guest_pass_id\").notNull().references(() => guestPasses.id),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  macAddress: text(\"mac_address\"), // Device that redeemed\n  ipAddress: text(\"ip_address\"),\n  expiresAt: timestamp(\"expires_at\").notNull(), // When this session expires\n  redeemedAt: timestamp(\"redeemed_at\").defaultNow(),\n});\n\nexport const guestPassRedemptionsRelations = relations(guestPassRedemptions, ({ one }) => ({\n  guestPass: one(guestPasses, {\n    fields: [guestPassRedemptions.guestPassId],\n    references: [guestPasses.id],\n  }),\n  tenant: one(tenants, {\n    fields: [guestPassRedemptions.tenantId],\n    references: [tenants.id],\n  }),\n}));\n\nexport const insertGuestPassRedemptionSchema = createInsertSchema(guestPassRedemptions).omit({\n  id: true,\n  redeemedAt: true,\n});\n\nexport type GuestPassRedemption = typeof guestPassRedemptions.$inferSelect;\nexport type InsertGuestPassRedemption = z.infer<typeof insertGuestPassRedemptionSchema>;\n\n// Wallet Transaction Type\nexport const WalletTransactionType = {\n  DEPOSIT: \"DEPOSIT\",           // Money added to wallet (top-up)\n  PAYMENT: \"PAYMENT\",           // Money used for plan purchase\n  REFUND: \"REFUND\",             // Money refunded to wallet\n  EXCESS: \"EXCESS\",             // Excess payment credited to wallet\n  WITHDRAWAL: \"WITHDRAWAL\",     // Money withdrawn from wallet\n  BONUS: \"BONUS\",               // Promotional bonus credit\n} as const;\nexport type WalletTransactionTypeValue = typeof WalletTransactionType[keyof typeof WalletTransactionType];\n\n// Wallet - Customer balance tracking\nexport const wallets = pgTable(\"wallets\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  wifiUserId: varchar(\"wifi_user_id\").notNull().references(() => wifiUsers.id),\n  balance: integer(\"balance\").notNull().default(0), // In smallest currency unit\n  totalDeposited: integer(\"total_deposited\").notNull().default(0),\n  totalSpent: integer(\"total_spent\").notNull().default(0),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const walletsRelations = relations(wallets, ({ one, many }) => ({\n  tenant: one(tenants, {\n    fields: [wallets.tenantId],\n    references: [tenants.id],\n  }),\n  wifiUser: one(wifiUsers, {\n    fields: [wallets.wifiUserId],\n    references: [wifiUsers.id],\n  }),\n  transactions: many(walletTransactions),\n}));\n\nexport const insertWalletSchema = createInsertSchema(wallets).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type Wallet = typeof wallets.$inferSelect;\nexport type InsertWallet = z.infer<typeof insertWalletSchema>;\n\n// Wallet Transactions - Track all wallet movements\nexport const walletTransactions = pgTable(\"wallet_transactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  walletId: varchar(\"wallet_id\").notNull().references(() => wallets.id),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  type: text(\"type\").notNull(), // DEPOSIT, PAYMENT, REFUND, EXCESS, WITHDRAWAL, BONUS\n  amount: integer(\"amount\").notNull(), // Positive for credits, negative for debits\n  balanceAfter: integer(\"balance_after\").notNull(), // Balance after this transaction\n  description: text(\"description\"),\n  referenceId: varchar(\"reference_id\"), // Link to payment transaction or M-Pesa receipt\n  referenceType: text(\"reference_type\"), // 'transaction', 'mpesa', 'manual'\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const walletTransactionsRelations = relations(walletTransactions, ({ one }) => ({\n  wallet: one(wallets, {\n    fields: [walletTransactions.walletId],\n    references: [wallets.id],\n  }),\n  tenant: one(tenants, {\n    fields: [walletTransactions.tenantId],\n    references: [tenants.id],\n  }),\n}));\n\nexport const insertWalletTransactionSchema = createInsertSchema(walletTransactions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type WalletTransaction = typeof walletTransactions.$inferSelect;\nexport type InsertWalletTransaction = z.infer<typeof insertWalletTransactionSchema>;\n\n// Voucher Status\nexport const VoucherStatus = {\n  AVAILABLE: \"AVAILABLE\",\n  USED: \"USED\",\n  EXPIRED: \"EXPIRED\",\n  DISABLED: \"DISABLED\",\n} as const;\nexport type VoucherStatusValue = typeof VoucherStatus[keyof typeof VoucherStatus];\n\n// Voucher Batches - Groups of vouchers created together\nexport const voucherBatches = pgTable(\"voucher_batches\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  planId: varchar(\"plan_id\").notNull().references(() => plans.id),\n  name: text(\"name\").notNull(),\n  prefix: text(\"prefix\"),\n  quantity: integer(\"quantity\").notNull(),\n  usedCount: integer(\"used_count\").notNull().default(0),\n  validFrom: timestamp(\"valid_from\").defaultNow(),\n  validUntil: timestamp(\"valid_until\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const voucherBatchesRelations = relations(voucherBatches, ({ one, many }) => ({\n  tenant: one(tenants, {\n    fields: [voucherBatches.tenantId],\n    references: [tenants.id],\n  }),\n  plan: one(plans, {\n    fields: [voucherBatches.planId],\n    references: [plans.id],\n  }),\n  vouchers: many(vouchers),\n}));\n\nexport const insertVoucherBatchSchema = createInsertSchema(voucherBatches).omit({\n  id: true,\n  usedCount: true,\n  createdAt: true,\n});\n\nexport type VoucherBatch = typeof voucherBatches.$inferSelect;\nexport type InsertVoucherBatch = z.infer<typeof insertVoucherBatchSchema>;\n\n// Vouchers - Individual access codes\nexport const vouchers = pgTable(\"vouchers\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  batchId: varchar(\"batch_id\").references(() => voucherBatches.id),\n  planId: varchar(\"plan_id\").notNull().references(() => plans.id),\n  code: text(\"code\").notNull(),\n  status: text(\"status\").notNull().default(\"AVAILABLE\"),\n  usedBy: varchar(\"used_by\").references(() => wifiUsers.id),\n  usedAt: timestamp(\"used_at\"),\n  macAddress: text(\"mac_address\"),\n  expiresAt: timestamp(\"expires_at\"),\n  validFrom: timestamp(\"valid_from\").defaultNow(),\n  validUntil: timestamp(\"valid_until\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const vouchersRelations = relations(vouchers, ({ one }) => ({\n  tenant: one(tenants, {\n    fields: [vouchers.tenantId],\n    references: [tenants.id],\n  }),\n  batch: one(voucherBatches, {\n    fields: [vouchers.batchId],\n    references: [voucherBatches.id],\n  }),\n  plan: one(plans, {\n    fields: [vouchers.planId],\n    references: [plans.id],\n  }),\n  usedByUser: one(wifiUsers, {\n    fields: [vouchers.usedBy],\n    references: [wifiUsers.id],\n  }),\n}));\n\nexport const insertVoucherSchema = createInsertSchema(vouchers).omit({\n  id: true,\n  usedAt: true,\n  createdAt: true,\n});\n\nexport type Voucher = typeof vouchers.$inferSelect;\nexport type InsertVoucher = z.infer<typeof insertVoucherSchema>;\n\n// Zones - Geographic/logical areas for organizing customers and techs\nexport const zones = pgTable(\"zones\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  color: text(\"color\").default(\"#22d3ee\"),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const zonesRelations = relations(zones, ({ one, many }) => ({\n  tenant: one(tenants, {\n    fields: [zones.tenantId],\n    references: [tenants.id],\n  }),\n}));\n\nexport const insertZoneSchema = createInsertSchema(zones).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type Zone = typeof zones.$inferSelect;\nexport type InsertZone = z.infer<typeof insertZoneSchema>;\n\n// Audit Logs - Track user actions\nexport const auditLogs = pgTable(\"audit_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  userId: varchar(\"user_id\").references(() => users.id),\n  action: text(\"action\").notNull(),\n  entityType: text(\"entity_type\"),\n  entityId: text(\"entity_id\"),\n  details: jsonb(\"details\").$type<Record<string, unknown>>().default({}),\n  ipAddress: text(\"ip_address\"),\n  userAgent: text(\"user_agent\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const auditLogsRelations = relations(auditLogs, ({ one }) => ({\n  tenant: one(tenants, {\n    fields: [auditLogs.tenantId],\n    references: [tenants.id],\n  }),\n  user: one(users, {\n    fields: [auditLogs.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const insertAuditLogSchema = createInsertSchema(auditLogs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type AuditLog = typeof auditLogs.$inferSelect;\nexport type InsertAuditLog = z.infer<typeof insertAuditLogSchema>;\n\n// Chat Messages - Customer to ISP communication\nexport const chatMessages = pgTable(\"chat_messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  wifiUserId: varchar(\"wifi_user_id\").references(() => wifiUsers.id),\n  userId: varchar(\"user_id\").references(() => users.id),\n  message: text(\"message\").notNull(),\n  isFromCustomer: boolean(\"is_from_customer\").default(true),\n  isRead: boolean(\"is_read\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const chatMessagesRelations = relations(chatMessages, ({ one }) => ({\n  tenant: one(tenants, {\n    fields: [chatMessages.tenantId],\n    references: [tenants.id],\n  }),\n  wifiUser: one(wifiUsers, {\n    fields: [chatMessages.wifiUserId],\n    references: [wifiUsers.id],\n  }),\n  user: one(users, {\n    fields: [chatMessages.userId],\n    references: [users.id],\n  }),\n}));\n\nexport const insertChatMessageSchema = createInsertSchema(chatMessages).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type ChatMessage = typeof chatMessages.$inferSelect;\nexport type InsertChatMessage = z.infer<typeof insertChatMessageSchema>;\n\n// Loyalty Points - Customer rewards tracking\nexport const loyaltyPoints = pgTable(\"loyalty_points\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  wifiUserId: varchar(\"wifi_user_id\").notNull().references(() => wifiUsers.id),\n  points: integer(\"points\").notNull().default(0),\n  totalEarned: integer(\"total_earned\").notNull().default(0),\n  totalRedeemed: integer(\"total_redeemed\").notNull().default(0),\n  lastEarnedAt: timestamp(\"last_earned_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const loyaltyPointsRelations = relations(loyaltyPoints, ({ one }) => ({\n  tenant: one(tenants, {\n    fields: [loyaltyPoints.tenantId],\n    references: [tenants.id],\n  }),\n  wifiUser: one(wifiUsers, {\n    fields: [loyaltyPoints.wifiUserId],\n    references: [wifiUsers.id],\n  }),\n}));\n\nexport const insertLoyaltyPointsSchema = createInsertSchema(loyaltyPoints).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type LoyaltyPoints = typeof loyaltyPoints.$inferSelect;\nexport type InsertLoyaltyPoints = z.infer<typeof insertLoyaltyPointsSchema>;\n\n// Loyalty Transactions - Point earning/redemption history\nexport const loyaltyTransactions = pgTable(\"loyalty_transactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  loyaltyId: varchar(\"loyalty_id\").notNull().references(() => loyaltyPoints.id),\n  type: text(\"type\").notNull(), // EARNED, REDEEMED\n  points: integer(\"points\").notNull(),\n  description: text(\"description\"),\n  referenceId: text(\"reference_id\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const loyaltyTransactionsRelations = relations(loyaltyTransactions, ({ one }) => ({\n  tenant: one(tenants, {\n    fields: [loyaltyTransactions.tenantId],\n    references: [tenants.id],\n  }),\n  loyalty: one(loyaltyPoints, {\n    fields: [loyaltyTransactions.loyaltyId],\n    references: [loyaltyPoints.id],\n  }),\n}));\n\nexport const insertLoyaltyTransactionSchema = createInsertSchema(loyaltyTransactions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type LoyaltyTransaction = typeof loyaltyTransactions.$inferSelect;\nexport type InsertLoyaltyTransaction = z.infer<typeof insertLoyaltyTransactionSchema>;\n\n// Login Attempts - Track failed logins for security\nexport const loginAttempts = pgTable(\"login_attempts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  username: text(\"username\").notNull(),\n  ipAddress: text(\"ip_address\"),\n  success: boolean(\"success\").default(false),\n  userAgent: text(\"user_agent\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertLoginAttemptSchema = createInsertSchema(loginAttempts).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type LoginAttempt = typeof loginAttempts.$inferSelect;\nexport type InsertLoginAttempt = z.infer<typeof insertLoginAttemptSchema>;\n\n// Router Backups - Store MikroTik router config backups\nexport const routerBackups = pgTable(\"router_backups\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  hotspotId: varchar(\"hotspot_id\").notNull().references(() => hotspots.id),\n  name: text(\"name\").notNull(),\n  type: text(\"type\").notNull().default(\"backup\"), // backup, export\n  fileSize: integer(\"file_size\"),\n  routerVersion: text(\"router_version\"),\n  routerIdentity: text(\"router_identity\"),\n  configData: text(\"config_data\"), // Base64 encoded for .backup or plain text for .rsc export\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const routerBackupsRelations = relations(routerBackups, ({ one }) => ({\n  tenant: one(tenants, {\n    fields: [routerBackups.tenantId],\n    references: [tenants.id],\n  }),\n  hotspot: one(hotspots, {\n    fields: [routerBackups.hotspotId],\n    references: [hotspots.id],\n  }),\n}));\n\nexport const insertRouterBackupSchema = createInsertSchema(routerBackups).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type RouterBackup = typeof routerBackups.$inferSelect;\nexport type InsertRouterBackup = z.infer<typeof insertRouterBackupSchema>;\n\n// Login Page Templates - Customizable hotspot login pages\nexport const loginPageTemplates = pgTable(\"login_page_templates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\").notNull().references(() => tenants.id),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  isDefault: boolean(\"is_default\").default(false),\n  config: jsonb(\"config\").$type<{\n    logo?: string;\n    logoWidth?: number;\n    logoHeight?: number;\n    title?: string;\n    subtitle?: string;\n    welcomeMessage?: string;\n    termsAndConditions?: string;\n    backgroundColor?: string;\n    primaryColor?: string;\n    secondaryColor?: string;\n    textColor?: string;\n    buttonColor?: string;\n    buttonTextColor?: string;\n    fontFamily?: string;\n    borderRadius?: number;\n    showSocialLogin?: boolean;\n    showPoweredBy?: boolean;\n    customCss?: string;\n    customJs?: string;\n    footerText?: string;\n    redirectUrl?: string;\n    sessionTimeout?: number;\n  }>().default({}),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const loginPageTemplatesRelations = relations(loginPageTemplates, ({ one }) => ({\n  tenant: one(tenants, {\n    fields: [loginPageTemplates.tenantId],\n    references: [tenants.id],\n  }),\n}));\n\nexport const insertLoginPageTemplateSchema = createInsertSchema(loginPageTemplates).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type LoginPageTemplate = typeof loginPageTemplates.$inferSelect;\nexport type InsertLoginPageTemplate = z.infer<typeof insertLoginPageTemplateSchema>;\n","path":null,"size_bytes":37538,"size_tokens":null},"server/db.ts":{"content":"import { Pool } from 'pg';\nimport { drizzle } from 'drizzle-orm/node-postgres';\nimport * as schema from \"@shared/schema\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle(pool, { schema });\n","path":null,"size_bytes":379,"size_tokens":null},"client/src/layouts/dashboard-layout.tsx":{"content":"import { useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { AppSidebar } from \"@/components/app-sidebar\";\nimport { MeshBackground } from \"@/components/mesh-background\";\nimport { useRequireAuth } from \"@/hooks/use-session\";\nimport { Loader2, Crown } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface DashboardLayoutProps {\n  children: React.ReactNode;\n}\n\nexport function DashboardLayout({ children }: DashboardLayoutProps) {\n  const { user, isLoading, logout, subscriptionTier, trialExpiresAt } = useRequireAuth();\n  const [location, setLocation] = useLocation();\n\n  const style = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  } as React.CSSProperties;\n\n  const isTrialExpired = trialExpiresAt && new Date(trialExpiresAt) < new Date();\n  const isBasicTier = subscriptionTier === \"BASIC\";\n\n  useEffect(() => {\n    if (!isLoading && !user) {\n      setLocation(\"/login\");\n    }\n  }, [user, isLoading, setLocation]);\n\n  useEffect(() => {\n    if (!isLoading && user && isBasicTier && isTrialExpired && location !== \"/dashboard/upgrade\") {\n      setLocation(\"/dashboard/upgrade\");\n    }\n  }, [isLoading, user, isBasicTier, isTrialExpired, location, setLocation]);\n\n  if (isLoading) {\n    return (\n      <>\n        <MeshBackground />\n        <div className=\"min-h-screen flex items-center justify-center\">\n          <Loader2 className=\"w-8 h-8 animate-spin text-cyan-400\" />\n        </div>\n      </>\n    );\n  }\n\n  if (!user) {\n    return null;\n  }\n\n  const getTrialTimeRemaining = () => {\n    if (!trialExpiresAt || !isBasicTier) return null;\n    const now = new Date();\n    const expiry = new Date(trialExpiresAt);\n    const diff = expiry.getTime() - now.getTime();\n    if (diff <= 0) return \"Expired\";\n    const hours = Math.floor(diff / (1000 * 60 * 60));\n    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));\n    return `${hours}h ${minutes}m remaining`;\n  };\n\n  const trialTime = getTrialTimeRemaining();\n\n  return (\n    <>\n      <MeshBackground />\n      <SidebarProvider style={style}>\n        <div className=\"flex h-screen w-full relative z-10\">\n          <AppSidebar onLogout={logout} subscriptionTier={subscriptionTier} />\n          <div className=\"flex flex-col flex-1 overflow-hidden\">\n            <header className=\"flex items-center gap-4 p-4 border-b border-white/10 bg-background/50 backdrop-blur-sm\">\n              <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n              <div className=\"flex-1\" />\n              {isBasicTier && trialTime && (\n                <Badge \n                  variant=\"outline\" \n                  className={`text-xs ${trialTime === \"Expired\" ? \"border-red-500/50 text-red-400\" : \"border-cyan-500/50 text-cyan-400\"}`}\n                  data-testid=\"badge-trial-time\"\n                >\n                  Trial: {trialTime}\n                </Badge>\n              )}\n              {!isBasicTier && (\n                <Badge className=\"bg-gradient-to-r from-purple-500/20 to-pink-500/20 text-purple-400 border-0\">\n                  <Crown size={12} className=\"mr-1\" />\n                  Premium\n                </Badge>\n              )}\n              <span className=\"text-sm text-muted-foreground\">\n                {user.username}\n              </span>\n            </header>\n            <main className=\"flex-1 overflow-auto\">\n              {children}\n            </main>\n          </div>\n        </div>\n      </SidebarProvider>\n    </>\n  );\n}\n","path":null,"size_bytes":3557,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"server/services/mpesa.ts":{"content":"import type { Tenant } from \"@shared/schema\";\n\ninterface StkPushResponse {\n  MerchantRequestID: string;\n  CheckoutRequestID: string;\n  ResponseCode: string;\n  ResponseDescription: string;\n  CustomerMessage: string;\n}\n\ninterface QueryStatusResponse {\n  ResponseCode: string;\n  ResponseDescription: string;\n  MerchantRequestID: string;\n  CheckoutRequestID: string;\n  ResultCode: string;\n  ResultDesc: string;\n}\n\ninterface DarajaTokenResponse {\n  access_token: string;\n  expires_in: string;\n}\n\nexport class MpesaService {\n  private baseUrl: string;\n  private tenant: Tenant;\n\n  constructor(tenant: Tenant, sandbox: boolean = true) {\n    this.tenant = tenant;\n    this.baseUrl = sandbox\n      ? \"https://sandbox.safaricom.co.ke\"\n      : \"https://api.safaricom.co.ke\";\n  }\n\n  private async getAccessToken(): Promise<string> {\n    const consumerKey = this.tenant.mpesaConsumerKey;\n    const consumerSecret = this.tenant.mpesaConsumerSecret;\n\n    if (!consumerKey || !consumerSecret) {\n      throw new Error(\"M-Pesa credentials not configured for this tenant\");\n    }\n\n    const credentials = Buffer.from(`${consumerKey}:${consumerSecret}`).toString(\"base64\");\n\n    const response = await fetch(\n      `${this.baseUrl}/oauth/v1/generate?grant_type=client_credentials`,\n      {\n        method: \"GET\",\n        headers: {\n          Authorization: `Basic ${credentials}`,\n        },\n      }\n    );\n\n    if (!response.ok) {\n      throw new Error(`Failed to get M-Pesa access token: ${response.statusText}`);\n    }\n\n    const data: DarajaTokenResponse = await response.json();\n    return data.access_token;\n  }\n\n  private generatePassword(): { password: string; timestamp: string } {\n    const shortcode = this.tenant.mpesaShortcode;\n    const passkey = this.tenant.mpesaPasskey;\n\n    if (!shortcode || !passkey) {\n      throw new Error(\"M-Pesa shortcode or passkey not configured\");\n    }\n\n    const timestamp = new Date()\n      .toISOString()\n      .replace(/[-:T.Z]/g, \"\")\n      .slice(0, 14);\n    const password = Buffer.from(`${shortcode}${passkey}${timestamp}`).toString(\"base64\");\n\n    return { password, timestamp };\n  }\n\n  async initiateSTKPush(\n    phoneNumber: string,\n    amount: number,\n    accountReference: string,\n    transactionDesc: string,\n    callbackUrl: string\n  ): Promise<StkPushResponse> {\n    const accessToken = await this.getAccessToken();\n    const { password, timestamp } = this.generatePassword();\n    const shortcode = this.tenant.mpesaShortcode;\n\n    const formattedPhone = this.formatPhoneNumber(phoneNumber);\n\n    const payload = {\n      BusinessShortCode: shortcode,\n      Password: password,\n      Timestamp: timestamp,\n      TransactionType: \"CustomerPayBillOnline\",\n      Amount: amount,\n      PartyA: formattedPhone,\n      PartyB: shortcode,\n      PhoneNumber: formattedPhone,\n      CallBackURL: callbackUrl,\n      AccountReference: accountReference,\n      TransactionDesc: transactionDesc,\n    };\n\n    const response = await fetch(\n      `${this.baseUrl}/mpesa/stkpush/v1/processrequest`,\n      {\n        method: \"POST\",\n        headers: {\n          Authorization: `Bearer ${accessToken}`,\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(payload),\n      }\n    );\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`STK Push failed: ${errorText}`);\n    }\n\n    return response.json();\n  }\n\n  async queryTransactionStatus(checkoutRequestId: string): Promise<QueryStatusResponse> {\n    const accessToken = await this.getAccessToken();\n    const { password, timestamp } = this.generatePassword();\n    const shortcode = this.tenant.mpesaShortcode;\n\n    const payload = {\n      BusinessShortCode: shortcode,\n      Password: password,\n      Timestamp: timestamp,\n      CheckoutRequestID: checkoutRequestId,\n    };\n\n    const response = await fetch(\n      `${this.baseUrl}/mpesa/stkpushquery/v1/query`,\n      {\n        method: \"POST\",\n        headers: {\n          Authorization: `Bearer ${accessToken}`,\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(payload),\n      }\n    );\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`Query status failed: ${errorText}`);\n    }\n\n    return response.json();\n  }\n\n  private formatPhoneNumber(phone: string): string {\n    let cleaned = phone.replace(/\\D/g, \"\");\n    \n    if (cleaned.startsWith(\"0\")) {\n      cleaned = \"254\" + cleaned.slice(1);\n    } else if (cleaned.startsWith(\"+\")) {\n      cleaned = cleaned.slice(1);\n    } else if (!cleaned.startsWith(\"254\")) {\n      cleaned = \"254\" + cleaned;\n    }\n\n    return cleaned;\n  }\n\n  static verifyCallbackSignature(\n    body: string,\n    signature: string,\n    secret: string\n  ): boolean {\n    return true;\n  }\n}\n","path":null,"size_bytes":4784,"size_tokens":null},"server/services/radius.ts":{"content":"import * as dgram from \"dgram\";\nimport * as crypto from \"crypto\";\nimport type { Hotspot, Plan, WifiUser } from \"@shared/schema\";\n\nconst RADIUS_PORT = 1812;\nconst RADIUS_ACCT_PORT = 1813;\nconst COA_PORT = 3799;\n\nconst RADIUS_CODES = {\n  ACCESS_REQUEST: 1,\n  ACCESS_ACCEPT: 2,\n  ACCESS_REJECT: 3,\n  ACCOUNTING_REQUEST: 4,\n  ACCOUNTING_RESPONSE: 5,\n  ACCESS_CHALLENGE: 11,\n  COA_REQUEST: 43,\n  COA_ACK: 44,\n  COA_NAK: 45,\n  DISCONNECT_REQUEST: 40,\n  DISCONNECT_ACK: 41,\n  DISCONNECT_NAK: 42,\n} as const;\n\nconst RADIUS_ATTRIBUTES = {\n  USER_NAME: 1,\n  USER_PASSWORD: 2,\n  CHAP_PASSWORD: 3,\n  NAS_IP_ADDRESS: 4,\n  NAS_PORT: 5,\n  SERVICE_TYPE: 6,\n  FRAMED_PROTOCOL: 7,\n  FRAMED_IP_ADDRESS: 8,\n  FRAMED_IP_NETMASK: 9,\n  FRAMED_ROUTING: 10,\n  FILTER_ID: 11,\n  FRAMED_MTU: 12,\n  FRAMED_COMPRESSION: 13,\n  LOGIN_IP_HOST: 14,\n  LOGIN_SERVICE: 15,\n  LOGIN_TCP_PORT: 16,\n  REPLY_MESSAGE: 18,\n  CALLBACK_NUMBER: 19,\n  CALLBACK_ID: 20,\n  FRAMED_ROUTE: 22,\n  FRAMED_IPX_NETWORK: 23,\n  STATE: 24,\n  CLASS: 25,\n  VENDOR_SPECIFIC: 26,\n  SESSION_TIMEOUT: 27,\n  IDLE_TIMEOUT: 28,\n  TERMINATION_ACTION: 29,\n  CALLED_STATION_ID: 30,\n  CALLING_STATION_ID: 31,\n  NAS_IDENTIFIER: 32,\n  PROXY_STATE: 33,\n  ACCT_STATUS_TYPE: 40,\n  ACCT_DELAY_TIME: 41,\n  ACCT_INPUT_OCTETS: 42,\n  ACCT_OUTPUT_OCTETS: 43,\n  ACCT_SESSION_ID: 44,\n  ACCT_AUTHENTIC: 45,\n  ACCT_SESSION_TIME: 46,\n  ACCT_INPUT_PACKETS: 47,\n  ACCT_OUTPUT_PACKETS: 48,\n  ACCT_TERMINATE_CAUSE: 49,\n  ACCT_MULTI_SESSION_ID: 50,\n  ACCT_LINK_COUNT: 51,\n  CHAP_CHALLENGE: 60,\n  NAS_PORT_TYPE: 61,\n  PORT_LIMIT: 62,\n  LOGIN_LAT_PORT: 63,\n  MIKROTIK_RATE_LIMIT: 8, // Vendor-specific under MIKROTIK vendor ID\n} as const;\n\nconst MIKROTIK_VENDOR_ID = 14988;\n\ninterface RadiusPacket {\n  code: number;\n  identifier: number;\n  authenticator: Buffer;\n  attributes: Map<number, Buffer>;\n}\n\ninterface CoAResult {\n  success: boolean;\n  code?: number;\n  message?: string;\n  error?: string;\n}\n\nexport class RadiusService {\n  private secret: string;\n  private nasIp: string;\n\n  constructor(hotspot: Hotspot) {\n    this.secret = hotspot.secret;\n    this.nasIp = hotspot.nasIp;\n  }\n\n  private createPacket(code: number, attributes: Map<number, Buffer>): Buffer {\n    const identifier = Math.floor(Math.random() * 256);\n    const authenticator = crypto.randomBytes(16);\n    \n    let attributesBuffer = Buffer.alloc(0);\n    \n    attributes.forEach((value, type) => {\n      const attrLength = 2 + value.length;\n      const attrBuffer = Buffer.alloc(attrLength);\n      attrBuffer.writeUInt8(type, 0);\n      attrBuffer.writeUInt8(attrLength, 1);\n      value.copy(attrBuffer, 2);\n      attributesBuffer = Buffer.concat([attributesBuffer, attrBuffer]);\n    });\n\n    const length = 20 + attributesBuffer.length;\n    const header = Buffer.alloc(20);\n    header.writeUInt8(code, 0);\n    header.writeUInt8(identifier, 1);\n    header.writeUInt16BE(length, 2);\n    authenticator.copy(header, 4);\n\n    const packet = Buffer.concat([header, attributesBuffer]);\n\n    if (code === RADIUS_CODES.COA_REQUEST || code === RADIUS_CODES.DISCONNECT_REQUEST) {\n      const authInput = Buffer.concat([packet, Buffer.from(this.secret)]);\n      const newAuth = crypto.createHash(\"md5\").update(authInput).digest();\n      newAuth.copy(packet, 4);\n    }\n\n    return packet;\n  }\n\n  private parsePacket(data: Buffer): RadiusPacket {\n    const code = data.readUInt8(0);\n    const identifier = data.readUInt8(1);\n    const length = data.readUInt16BE(2);\n    const authenticator = data.subarray(4, 20);\n    \n    const attributes = new Map<number, Buffer>();\n    let offset = 20;\n    \n    while (offset < length) {\n      const attrType = data.readUInt8(offset);\n      const attrLength = data.readUInt8(offset + 1);\n      const attrValue = data.subarray(offset + 2, offset + attrLength);\n      attributes.set(attrType, attrValue);\n      offset += attrLength;\n    }\n\n    return { code, identifier, authenticator, attributes };\n  }\n\n  private async sendPacket(packet: Buffer, port: number, timeout: number = 5000): Promise<Buffer> {\n    return new Promise((resolve, reject) => {\n      const socket = dgram.createSocket(\"udp4\");\n      \n      const timer = setTimeout(() => {\n        socket.close();\n        reject(new Error(\"RADIUS request timeout\"));\n      }, timeout);\n\n      socket.on(\"message\", (msg) => {\n        clearTimeout(timer);\n        socket.close();\n        resolve(msg);\n      });\n\n      socket.on(\"error\", (err) => {\n        clearTimeout(timer);\n        socket.close();\n        reject(err);\n      });\n\n      socket.send(packet, port, this.nasIp);\n    });\n  }\n\n  async sendCoA(sessionId: string, newRateLimit?: string): Promise<CoAResult> {\n    console.log(`[RADIUS] Sending CoA to ${this.nasIp} for session ${sessionId}`);\n    \n    try {\n      const attributes = new Map<number, Buffer>();\n      \n      attributes.set(RADIUS_ATTRIBUTES.ACCT_SESSION_ID, Buffer.from(sessionId));\n      attributes.set(RADIUS_ATTRIBUTES.NAS_IP_ADDRESS, this.encodeIpAddress(this.nasIp));\n\n      if (newRateLimit) {\n        const vendorAttr = this.encodeVendorSpecific(\n          MIKROTIK_VENDOR_ID,\n          RADIUS_ATTRIBUTES.MIKROTIK_RATE_LIMIT,\n          Buffer.from(newRateLimit)\n        );\n        attributes.set(RADIUS_ATTRIBUTES.VENDOR_SPECIFIC, vendorAttr);\n      }\n\n      const packet = this.createPacket(RADIUS_CODES.COA_REQUEST, attributes);\n      const response = await this.sendPacket(packet, COA_PORT);\n      const parsed = this.parsePacket(response);\n\n      if (parsed.code === RADIUS_CODES.COA_ACK) {\n        console.log(`[RADIUS] CoA accepted for session ${sessionId}`);\n        return { success: true, code: parsed.code, message: \"CoA accepted\" };\n      } else if (parsed.code === RADIUS_CODES.COA_NAK) {\n        console.log(`[RADIUS] CoA rejected for session ${sessionId}`);\n        return { success: false, code: parsed.code, message: \"CoA rejected by NAS\" };\n      }\n\n      return { success: false, error: `Unexpected response code: ${parsed.code}` };\n    } catch (error) {\n      const message = error instanceof Error ? error.message : \"Unknown error\";\n      console.error(`[RADIUS] CoA failed for session ${sessionId}:`, message);\n      return { success: false, error: message };\n    }\n  }\n\n  async disconnectUser(sessionId: string, username?: string): Promise<CoAResult> {\n    console.log(`[RADIUS] Sending Disconnect-Request to ${this.nasIp} for session ${sessionId}`);\n    \n    try {\n      const attributes = new Map<number, Buffer>();\n      \n      attributes.set(RADIUS_ATTRIBUTES.ACCT_SESSION_ID, Buffer.from(sessionId));\n      attributes.set(RADIUS_ATTRIBUTES.NAS_IP_ADDRESS, this.encodeIpAddress(this.nasIp));\n      \n      if (username) {\n        attributes.set(RADIUS_ATTRIBUTES.USER_NAME, Buffer.from(username));\n      }\n\n      const packet = this.createPacket(RADIUS_CODES.DISCONNECT_REQUEST, attributes);\n      const response = await this.sendPacket(packet, COA_PORT);\n      const parsed = this.parsePacket(response);\n\n      if (parsed.code === RADIUS_CODES.DISCONNECT_ACK) {\n        console.log(`[RADIUS] Disconnect successful for session ${sessionId}`);\n        return { success: true, code: parsed.code, message: \"User disconnected\" };\n      } else if (parsed.code === RADIUS_CODES.DISCONNECT_NAK) {\n        console.log(`[RADIUS] Disconnect rejected for session ${sessionId}`);\n        return { success: false, code: parsed.code, message: \"Disconnect rejected by NAS\" };\n      }\n\n      return { success: false, error: `Unexpected response code: ${parsed.code}` };\n    } catch (error) {\n      const message = error instanceof Error ? error.message : \"Unknown error\";\n      console.error(`[RADIUS] Disconnect failed for session ${sessionId}:`, message);\n      return { success: false, error: message };\n    }\n  }\n\n  async updateSessionRateLimit(sessionId: string, plan: Plan): Promise<CoAResult> {\n    const rateLimit = this.buildMikrotikRateLimit(plan);\n    return this.sendCoA(sessionId, rateLimit);\n  }\n\n  private buildMikrotikRateLimit(plan: Plan): string {\n    const upload = plan.uploadLimit || \"1M\";\n    const download = plan.downloadLimit || \"2M\";\n    \n    if (plan.burstRateUp && plan.burstRateDown && plan.burstThreshold && plan.burstTime) {\n      return `${upload}/${download} ${plan.burstRateUp}/${plan.burstRateDown} ${plan.burstThreshold}/${plan.burstThreshold} ${plan.burstTime}/${plan.burstTime}`;\n    }\n    \n    return `${upload}/${download}`;\n  }\n\n  private encodeIpAddress(ip: string): Buffer {\n    const parts = ip.split(\".\").map(Number);\n    return Buffer.from(parts);\n  }\n\n  private encodeVendorSpecific(vendorId: number, attrType: number, value: Buffer): Buffer {\n    const vendorAttrLength = 2 + value.length;\n    const totalLength = 4 + vendorAttrLength;\n    \n    const buffer = Buffer.alloc(totalLength);\n    buffer.writeUInt32BE(vendorId, 0);\n    buffer.writeUInt8(attrType, 4);\n    buffer.writeUInt8(vendorAttrLength, 5);\n    value.copy(buffer, 6);\n    \n    return buffer;\n  }\n\n  static buildRadiusAttributes(user: WifiUser, plan: Plan | null): Record<string, string> {\n    const attrs: Record<string, string> = {\n      \"Simultaneous-Use\": String(plan?.simultaneousUse || 1),\n    };\n\n    if (plan) {\n      const upload = plan.uploadLimit || \"1M\";\n      const download = plan.downloadLimit || \"2M\";\n      let rateLimit = `${upload}/${download}`;\n      \n      if (plan.burstRateUp && plan.burstRateDown && plan.burstThreshold && plan.burstTime) {\n        rateLimit = `${upload}/${download} ${plan.burstRateUp}/${plan.burstRateDown} ${plan.burstThreshold}/${plan.burstThreshold} ${plan.burstTime}/${plan.burstTime}`;\n      }\n      \n      attrs[\"Mikrotik-Rate-Limit\"] = rateLimit;\n      \n      if (plan.durationSeconds) {\n        attrs[\"Session-Timeout\"] = String(plan.durationSeconds);\n      }\n    }\n\n    if (user.accountType === \"PPPOE\") {\n      attrs[\"Framed-Protocol\"] = \"PPP\";\n      attrs[\"Service-Type\"] = \"Framed-User\";\n    } else if (user.accountType === \"STATIC\" && user.ipAddress) {\n      attrs[\"Framed-IP-Address\"] = user.ipAddress;\n      attrs[\"Service-Type\"] = \"Framed-User\";\n    }\n\n    return attrs;\n  }\n}\n\nexport function createRadiusService(hotspot: Hotspot): RadiusService {\n  return new RadiusService(hotspot);\n}\n","path":null,"size_bytes":10152,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"script/build.ts":{"content":"import { build as esbuild } from \"esbuild\";\nimport { build as viteBuild } from \"vite\";\nimport { rm, readFile } from \"fs/promises\";\n\n// server deps to bundle to reduce openat(2) syscalls\n// which helps cold start times\nconst allowlist = [\n  \"@google/generative-ai\",\n  \"@neondatabase/serverless\",\n  \"axios\",\n  \"connect-pg-simple\",\n  \"cors\",\n  \"date-fns\",\n  \"drizzle-orm\",\n  \"drizzle-zod\",\n  \"express\",\n  \"express-rate-limit\",\n  \"express-session\",\n  \"jsonwebtoken\",\n  \"memorystore\",\n  \"multer\",\n  \"nanoid\",\n  \"nodemailer\",\n  \"openai\",\n  \"passport\",\n  \"passport-local\",\n  \"stripe\",\n  \"uuid\",\n  \"ws\",\n  \"xlsx\",\n  \"zod\",\n  \"zod-validation-error\",\n];\n\nasync function buildAll() {\n  await rm(\"dist\", { recursive: true, force: true });\n\n  console.log(\"building client...\");\n  await viteBuild();\n\n  console.log(\"building server...\");\n  const pkg = JSON.parse(await readFile(\"package.json\", \"utf-8\"));\n  const allDeps = [\n    ...Object.keys(pkg.dependencies || {}),\n    ...Object.keys(pkg.devDependencies || {}),\n  ];\n  const externals = allDeps.filter((dep) => !allowlist.includes(dep));\n\n  await esbuild({\n    entryPoints: [\"server/index.ts\"],\n    platform: \"node\",\n    bundle: true,\n    format: \"cjs\",\n    outfile: \"dist/index.cjs\",\n    define: {\n      \"process.env.NODE_ENV\": '\"production\"',\n    },\n    minify: true,\n    external: externals,\n    logLevel: \"info\",\n  });\n}\n\nbuildAll().catch((err) => {\n  console.error(err);\n  process.exit(1);\n});\n","path":null,"size_bytes":1439,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"client/src/pages/transactions.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { motion } from \"framer-motion\";\nimport { Search, Filter, Download, Receipt, RefreshCw } from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { TransactionList, TransactionListSkeleton } from \"@/components/transaction-list\";\nimport { StatusBadge } from \"@/components/status-badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { cn } from \"@/lib/utils\";\nimport type { Transaction, Plan, TransactionStatusType } from \"@shared/schema\";\nimport { format } from \"date-fns\";\nimport { exportToCSV } from \"@/lib/export-utils\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ntype FilterStatus = TransactionStatusType | \"ALL\";\n\nexport default function TransactionsPage() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState<FilterStatus>(\"ALL\");\n\n  // Fetch transactions\n  const { data: transactions, isLoading, isFetching } = useQuery<Transaction[]>({\n    queryKey: [\"/api/transactions\"],\n    refetchInterval: 30000, // Refresh every 30 seconds\n  });\n\n  // Fetch plans for display\n  const { data: plans } = useQuery<Plan[]>({\n    queryKey: [\"/api/plans\"],\n  });\n\n  const plansMap = new Map(plans?.map((p) => [p.id, p]) || []);\n\n  // Filter transactions\n  const filteredTransactions = transactions?.filter((t) => {\n    const matchesSearch =\n      t.userPhone.includes(searchQuery) ||\n      t.mpesaReceiptNumber?.toLowerCase().includes(searchQuery.toLowerCase());\n    const matchesStatus = statusFilter === \"ALL\" || t.status === statusFilter;\n    return matchesSearch && matchesStatus;\n  });\n\n  const handleRefresh = () => {\n    queryClient.invalidateQueries({ queryKey: [\"/api/transactions\"] });\n  };\n\n  const handleExport = () => {\n    if (!filteredTransactions || filteredTransactions.length === 0) {\n      toast({\n        title: \"No Data\",\n        description: \"No transactions to export with current filters.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    exportToCSV(\n      filteredTransactions,\n      [\n        { key: \"userPhone\", header: \"Phone Number\" },\n        { key: \"amount\", header: \"Amount (KES)\" },\n        { key: \"status\", header: \"Status\" },\n        { key: \"mpesaReceiptNumber\", header: \"M-Pesa Receipt\" },\n        { key: \"planId\", header: \"Plan\", formatter: (val) => val ? plansMap.get(val)?.name || \"\" : \"\" },\n        { key: \"reconciliationStatus\", header: \"Reconciliation Status\" },\n        { key: \"createdAt\", header: \"Date\", formatter: (val) => val ? format(new Date(val), \"yyyy-MM-dd HH:mm:ss\") : \"\" },\n      ],\n      \"transactions\"\n    );\n\n    toast({\n      title: \"Export Complete\",\n      description: `Exported ${filteredTransactions.length} transaction(s) to CSV.`,\n    });\n  };\n\n  const statusFilters: { label: string; value: FilterStatus }[] = [\n    { label: \"All\", value: \"ALL\" },\n    { label: \"Completed\", value: \"COMPLETED\" },\n    { label: \"Pending\", value: \"PENDING\" },\n    { label: \"Failed\", value: \"FAILED\" },\n  ];\n\n  // Calculate stats\n  const stats = {\n    total: transactions?.length || 0,\n    completed: transactions?.filter((t) => t.status === \"COMPLETED\").length || 0,\n    pending: transactions?.filter((t) => t.status === \"PENDING\").length || 0,\n    failed: transactions?.filter((t) => t.status === \"FAILED\").length || 0,\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"transactions-page\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">Transactions</h1>\n          <p className=\"text-muted-foreground\">\n            View and manage payment transactions\n          </p>\n        </div>\n        <div className=\"flex gap-3\">\n          <Button\n            variant=\"ghost\"\n            onClick={handleRefresh}\n            disabled={isFetching}\n            data-testid=\"button-refresh\"\n          >\n            <RefreshCw size={18} className={cn(\"mr-2\", isFetching && \"animate-spin\")} />\n            Refresh\n          </Button>\n          <Button variant=\"ghost\" onClick={handleExport} data-testid=\"button-export\">\n            <Download size={18} className=\"mr-2\" />\n            Export\n          </Button>\n        </div>\n      </div>\n\n      {/* Stats Bar */}\n      <div className=\"grid grid-cols-4 gap-4\">\n        <motion.div\n          className=\"p-4 rounded-xl bg-white/5 border border-white/10 text-center\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n        >\n          <p className=\"text-2xl font-bold text-white\">{stats.total}</p>\n          <p className=\"text-sm text-muted-foreground\">Total</p>\n        </motion.div>\n        <motion.div\n          className=\"p-4 rounded-xl bg-cyan-500/10 border border-cyan-500/20 text-center\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.1 }}\n        >\n          <p className=\"text-2xl font-bold text-cyan-400\">{stats.completed}</p>\n          <p className=\"text-sm text-muted-foreground\">Completed</p>\n        </motion.div>\n        <motion.div\n          className=\"p-4 rounded-xl bg-purple-500/10 border border-purple-500/20 text-center\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.2 }}\n        >\n          <p className=\"text-2xl font-bold text-purple-400\">{stats.pending}</p>\n          <p className=\"text-sm text-muted-foreground\">Pending</p>\n        </motion.div>\n        <motion.div\n          className=\"p-4 rounded-xl bg-pink-500/10 border border-pink-500/20 text-center\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.3 }}\n        >\n          <p className=\"text-2xl font-bold text-pink-400\">{stats.failed}</p>\n          <p className=\"text-sm text-muted-foreground\">Failed</p>\n        </motion.div>\n      </div>\n\n      {/* Filters */}\n      <GlassPanel size=\"sm\" className=\"flex flex-col sm:flex-row gap-4\">\n        {/* Search */}\n        <div className=\"flex-1\">\n          <GlassInput\n            placeholder=\"Search by phone or receipt number...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            icon={<Search size={16} />}\n            data-testid=\"input-search\"\n          />\n        </div>\n\n        {/* Status Filter */}\n        <div className=\"flex items-center gap-2\">\n          <Filter size={16} className=\"text-muted-foreground\" />\n          <div className=\"flex gap-1\">\n            {statusFilters.map((filter) => (\n              <button\n                key={filter.value}\n                onClick={() => setStatusFilter(filter.value)}\n                className={cn(\n                  \"px-3 py-1.5 rounded-lg text-sm font-medium transition-all\",\n                  statusFilter === filter.value\n                    ? \"bg-white/10 text-white\"\n                    : \"text-muted-foreground hover:text-white hover:bg-white/5\"\n                )}\n                data-testid={`filter-${filter.value.toLowerCase()}`}\n              >\n                {filter.label}\n              </button>\n            ))}\n          </div>\n        </div>\n      </GlassPanel>\n\n      {/* Transactions List */}\n      <GlassPanel size=\"md\">\n        {isLoading ? (\n          <TransactionListSkeleton count={10} />\n        ) : filteredTransactions && filteredTransactions.length > 0 ? (\n          <TransactionList\n            transactions={filteredTransactions}\n            plans={plansMap}\n            showDetails\n          />\n        ) : (\n          <div className=\"text-center py-12 text-muted-foreground\">\n            <Receipt size={48} className=\"mx-auto mb-4 opacity-50\" />\n            <p>\n              {searchQuery || statusFilter !== \"ALL\"\n                ? \"No transactions match your filters\"\n                : \"No transactions yet\"}\n            </p>\n          </div>\n        )}\n      </GlassPanel>\n    </div>\n  );\n}\n","path":null,"size_bytes":8135,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":844,"size_tokens":null},"client/src/components/glass-input.tsx":{"content":"import { cn } from \"@/lib/utils\";\nimport { forwardRef, type InputHTMLAttributes } from \"react\";\nimport { motion } from \"framer-motion\";\n\ninterface GlassInputProps extends InputHTMLAttributes<HTMLInputElement> {\n  label?: string;\n  error?: string;\n  icon?: React.ReactNode;\n  prefix?: React.ReactNode;\n}\n\nexport const GlassInput = forwardRef<HTMLInputElement, GlassInputProps>(\n  ({ className, label, error, icon, prefix, ...props }, ref) => {\n    return (\n      <div className=\"space-y-2\">\n        {label && (\n          <label className=\"text-sm font-medium uppercase tracking-wider text-muted-foreground\">\n            {label}\n          </label>\n        )}\n        <div className=\"relative\">\n          {icon && (\n            <div className=\"absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground\">\n              {icon}\n            </div>\n          )}\n          {prefix && (\n            <div className=\"absolute left-4 top-1/2 -translate-y-1/2 flex items-center gap-2 text-muted-foreground\">\n              {prefix}\n            </div>\n          )}\n          <motion.input\n            ref={ref}\n            className={cn(\n              \"w-full glass-input px-4 py-3 text-white placeholder:text-white/30\",\n              \"focus:ring-2 focus:ring-primary/20 focus:border-white/30\",\n              \"transition-all duration-200\",\n              icon && \"pl-12\",\n              prefix && \"pl-24\",\n              error && \"border-destructive focus:ring-destructive/20\",\n              className\n            )}\n            whileFocus={{ scale: 1.01 }}\n            transition={{ type: \"spring\", stiffness: 400, damping: 25 }}\n            {...props}\n          />\n        </div>\n        {error && (\n          <motion.p\n            className=\"text-sm text-destructive\"\n            initial={{ opacity: 0, y: -5 }}\n            animate={{ opacity: 1, y: 0 }}\n          >\n            {error}\n          </motion.p>\n        )}\n      </div>\n    );\n  }\n);\n\nGlassInput.displayName = \"GlassInput\";\n\n// Phone input with Kenya flag prefix - digits only validation\ninterface PhoneInputProps extends Omit<GlassInputProps, \"prefix\" | \"onChange\"> {\n  countryCode?: string;\n  onChange?: (e: React.ChangeEvent<HTMLInputElement>) => void;\n}\n\nexport const PhoneInput = forwardRef<HTMLInputElement, PhoneInputProps>(\n  ({ countryCode = \"+254\", className, onChange, ...props }, ref) => {\n    const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n      // Only allow digits\n      const value = e.target.value.replace(/[^\\d]/g, \"\");\n      // Limit to 9 digits (after 254 prefix) or 10 if starting with 0\n      const maxLen = value.startsWith(\"0\") ? 10 : 9;\n      const truncated = value.slice(0, maxLen);\n      \n      // Create a new event with the sanitized value\n      const newEvent = {\n        ...e,\n        target: {\n          ...e.target,\n          value: truncated,\n        },\n      } as React.ChangeEvent<HTMLInputElement>;\n      \n      if (onChange) {\n        onChange(newEvent);\n      }\n    };\n\n    return (\n      <GlassInput\n        ref={ref}\n        type=\"tel\"\n        inputMode=\"numeric\"\n        pattern=\"[0-9]*\"\n        prefix={\n          <>\n            <span className=\"text-lg\" role=\"img\" aria-label=\"Kenya flag\">KE</span>\n            <span className=\"text-sm font-medium text-white/60\">{countryCode}</span>\n          </>\n        }\n        placeholder=\"7XX XXX XXX\"\n        className={className}\n        onChange={handleChange}\n        {...props}\n      />\n    );\n  }\n);\n\nPhoneInput.displayName = \"PhoneInput\";\n\n// Glass Textarea\ninterface GlassTextareaProps extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {\n  label?: string;\n  error?: string;\n}\n\nexport const GlassTextarea = forwardRef<HTMLTextAreaElement, GlassTextareaProps>(\n  ({ className, label, error, ...props }, ref) => {\n    return (\n      <div className=\"space-y-2\">\n        {label && (\n          <label className=\"text-sm font-medium uppercase tracking-wider text-muted-foreground\">\n            {label}\n          </label>\n        )}\n        <motion.textarea\n          ref={ref}\n          className={cn(\n            \"w-full glass-input px-4 py-3 text-white placeholder:text-white/30 min-h-[100px] resize-none\",\n            \"focus:ring-2 focus:ring-primary/20 focus:border-white/30\",\n            \"transition-all duration-200\",\n            error && \"border-destructive focus:ring-destructive/20\",\n            className\n          )}\n          whileFocus={{ scale: 1.01 }}\n          transition={{ type: \"spring\", stiffness: 400, damping: 25 }}\n          {...props}\n        />\n        {error && (\n          <motion.p\n            className=\"text-sm text-destructive\"\n            initial={{ opacity: 0, y: -5 }}\n            animate={{ opacity: 1, y: 0 }}\n          >\n            {error}\n          </motion.p>\n        )}\n      </div>\n    );\n  }\n);\n\nGlassTextarea.displayName = \"GlassTextarea\";\n","path":null,"size_bytes":4850,"size_tokens":null},"client/src/components/mesh-background.tsx":{"content":"import { motion } from \"framer-motion\";\n\nexport function MeshBackground() {\n  return (\n    <div className=\"mesh-bg\" data-testid=\"mesh-background\">\n      <motion.div\n        className=\"absolute inset-0\"\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        transition={{ duration: 1 }}\n      >\n        {/* Animated gradient orbs */}\n        <motion.div\n          className=\"absolute w-[600px] h-[600px] rounded-full\"\n          style={{\n            background: \"radial-gradient(circle, rgba(124, 58, 237, 0.4) 0%, transparent 70%)\",\n            top: \"10%\",\n            left: \"10%\",\n            filter: \"blur(60px)\",\n          }}\n          animate={{\n            x: [0, 50, -30, 0],\n            y: [0, -40, 20, 0],\n          }}\n          transition={{\n            duration: 20,\n            repeat: Infinity,\n            ease: \"easeInOut\",\n          }}\n        />\n        <motion.div\n          className=\"absolute w-[500px] h-[500px] rounded-full\"\n          style={{\n            background: \"radial-gradient(circle, rgba(6, 182, 212, 0.35) 0%, transparent 70%)\",\n            top: \"5%\",\n            right: \"15%\",\n            filter: \"blur(50px)\",\n          }}\n          animate={{\n            x: [0, -40, 30, 0],\n            y: [0, 30, -20, 0],\n          }}\n          transition={{\n            duration: 25,\n            repeat: Infinity,\n            ease: \"easeInOut\",\n          }}\n        />\n        <motion.div\n          className=\"absolute w-[550px] h-[550px] rounded-full\"\n          style={{\n            background: \"radial-gradient(circle, rgba(236, 72, 153, 0.35) 0%, transparent 70%)\",\n            bottom: \"10%\",\n            right: \"20%\",\n            filter: \"blur(55px)\",\n          }}\n          animate={{\n            x: [0, 30, -50, 0],\n            y: [0, -30, 40, 0],\n          }}\n          transition={{\n            duration: 22,\n            repeat: Infinity,\n            ease: \"easeInOut\",\n          }}\n        />\n        <motion.div\n          className=\"absolute w-[450px] h-[450px] rounded-full\"\n          style={{\n            background: \"radial-gradient(circle, rgba(59, 130, 246, 0.3) 0%, transparent 70%)\",\n            bottom: \"20%\",\n            left: \"5%\",\n            filter: \"blur(45px)\",\n          }}\n          animate={{\n            x: [0, -30, 40, 0],\n            y: [0, 40, -30, 0],\n          }}\n          transition={{\n            duration: 18,\n            repeat: Infinity,\n            ease: \"easeInOut\",\n          }}\n        />\n      </motion.div>\n    </div>\n  );\n}\n","path":null,"size_bytes":2509,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"render.yaml":{"content":"services:\n  - type: web\n    name: mnetifi-wifi-billing\n    runtime: node\n    region: oregon\n    plan: free\n    buildCommand: npm install && npm run build\n    startCommand: npm run start\n    healthCheckPath: /api/health\n    envVars:\n      - key: NODE_ENV\n        value: production\n      - key: DATABASE_URL\n        fromDatabase:\n          name: mnetifi-db\n          property: connectionString\n      - key: SESSION_SECRET\n        generateValue: true\n      - key: SUPERADMIN_SETUP_KEY\n        sync: false\n      - key: MPESA_CONSUMER_KEY\n        sync: false\n      - key: MPESA_CONSUMER_SECRET\n        sync: false\n      - key: MPESA_PASSKEY\n        sync: false\n      - key: MPESA_SHORTCODE\n        sync: false\n      - key: MPESA_CALLBACK_URL\n        sync: false\n      - key: SMS_PROVIDER\n        value: mock\n      - key: SMS_API_KEY\n        sync: false\n      - key: SMS_USERNAME\n        sync: false\n\ndatabases:\n  - name: mnetifi-db\n    databaseName: mnetifi\n    user: mnetifi_user\n    plan: free\n    region: oregon\n","path":null,"size_bytes":1010,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/pages/reconciliation.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { motion } from \"framer-motion\";\nimport { \n  Search,\n  FileCheck,\n  FileX,\n  FileQuestion,\n  Clock,\n  CheckCircle,\n  XCircle,\n  AlertTriangle,\n  Download,\n  Filter,\n  Calendar,\n} from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { cn } from \"@/lib/utils\";\nimport type { Transaction, Plan } from \"@shared/schema\";\nimport { format, subDays, startOfDay, endOfDay } from \"date-fns\";\n\nconst reconciliationStatusLabels = {\n  MATCHED: \"Matched\",\n  UNMATCHED: \"Unmatched\",\n  MANUAL_REVIEW: \"Manual Review\",\n  PENDING: \"Pending\",\n};\n\nconst reconciliationStatusColors = {\n  MATCHED: \"bg-emerald-500/20 text-emerald-400 border-emerald-500/30\",\n  UNMATCHED: \"bg-red-500/20 text-red-400 border-red-500/30\",\n  MANUAL_REVIEW: \"bg-amber-500/20 text-amber-400 border-amber-500/30\",\n  PENDING: \"bg-blue-500/20 text-blue-400 border-blue-500/30\",\n};\n\nconst transactionStatusColors = {\n  COMPLETED: \"bg-emerald-500/20 text-emerald-400 border-emerald-500/30\",\n  PENDING: \"bg-purple-500/20 text-purple-400 border-purple-500/30\",\n  FAILED: \"bg-red-500/20 text-red-400 border-red-500/30\",\n};\n\nexport default function ReconciliationPage() {\n  const [filterReconciliationStatus, setFilterReconciliationStatus] = useState<string>(\"all\");\n  const [filterTransactionStatus, setFilterTransactionStatus] = useState<string>(\"all\");\n  const [filterPeriod, setFilterPeriod] = useState<string>(\"7d\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const { data: transactions, isLoading } = useQuery<Transaction[]>({\n    queryKey: [\"/api/transactions\"],\n  });\n\n  const { data: plans } = useQuery<Plan[]>({\n    queryKey: [\"/api/plans\"],\n  });\n\n  const plansMap = new Map(plans?.map((p) => [p.id, p]) || []);\n\n  const getDateRange = () => {\n    const now = new Date();\n    switch (filterPeriod) {\n      case \"1d\":\n        return { start: startOfDay(now), end: endOfDay(now) };\n      case \"7d\":\n        return { start: startOfDay(subDays(now, 7)), end: endOfDay(now) };\n      case \"30d\":\n        return { start: startOfDay(subDays(now, 30)), end: endOfDay(now) };\n      case \"90d\":\n        return { start: startOfDay(subDays(now, 90)), end: endOfDay(now) };\n      default:\n        return { start: startOfDay(subDays(now, 7)), end: endOfDay(now) };\n    }\n  };\n\n  const dateRange = getDateRange();\n\n  const filteredTransactions = transactions?.filter((tx) => {\n    const txDate = tx.createdAt ? new Date(tx.createdAt) : new Date();\n    const inDateRange = txDate >= dateRange.start && txDate <= dateRange.end;\n    \n    const matchesSearch = \n      tx.userPhone.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      tx.mpesaReceiptNumber?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      tx.checkoutRequestId?.toLowerCase().includes(searchQuery.toLowerCase());\n    \n    const matchesReconciliation = \n      filterReconciliationStatus === \"all\" || \n      tx.reconciliationStatus === filterReconciliationStatus;\n    \n    const matchesStatus = \n      filterTransactionStatus === \"all\" || \n      tx.status === filterTransactionStatus;\n    \n    return inDateRange && matchesSearch && matchesReconciliation && matchesStatus;\n  });\n\n  const stats = {\n    total: filteredTransactions?.length || 0,\n    matched: filteredTransactions?.filter(t => t.reconciliationStatus === \"MATCHED\").length || 0,\n    unmatched: filteredTransactions?.filter(t => t.reconciliationStatus === \"UNMATCHED\").length || 0,\n    manualReview: filteredTransactions?.filter(t => t.reconciliationStatus === \"MANUAL_REVIEW\").length || 0,\n    pending: filteredTransactions?.filter(t => t.reconciliationStatus === \"PENDING\").length || 0,\n    totalAmount: filteredTransactions?.reduce((sum, t) => sum + t.amount, 0) || 0,\n    matchedAmount: filteredTransactions?.filter(t => t.reconciliationStatus === \"MATCHED\").reduce((sum, t) => sum + t.amount, 0) || 0,\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat(\"en-KE\", {\n      style: \"currency\",\n      currency: \"KES\",\n      minimumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"reconciliation-page\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">Reconciliation Reports</h1>\n          <p className=\"text-muted-foreground\">\n            M-Pesa transaction matching and financial reports\n          </p>\n        </div>\n        <Button variant=\"outline\" data-testid=\"button-export-report\">\n          <Download size={18} className=\"mr-2\" />\n          Export Report\n        </Button>\n      </div>\n\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n        <motion.div\n          className=\"p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/20\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0 }}\n        >\n          <div className=\"flex items-center gap-3 mb-2\">\n            <div className=\"p-2 rounded-lg bg-emerald-500/20\">\n              <FileCheck size={18} className=\"text-emerald-400\" />\n            </div>\n            <span className=\"text-sm text-muted-foreground\">Matched</span>\n          </div>\n          <p className=\"text-2xl font-bold text-white\">{stats.matched}</p>\n          <p className=\"text-sm text-emerald-400\">{formatCurrency(stats.matchedAmount)}</p>\n        </motion.div>\n\n        <motion.div\n          className=\"p-4 rounded-xl bg-red-500/10 border border-red-500/20\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.1 }}\n        >\n          <div className=\"flex items-center gap-3 mb-2\">\n            <div className=\"p-2 rounded-lg bg-red-500/20\">\n              <FileX size={18} className=\"text-red-400\" />\n            </div>\n            <span className=\"text-sm text-muted-foreground\">Unmatched</span>\n          </div>\n          <p className=\"text-2xl font-bold text-white\">{stats.unmatched}</p>\n          <p className=\"text-xs text-muted-foreground\">Require attention</p>\n        </motion.div>\n\n        <motion.div\n          className=\"p-4 rounded-xl bg-amber-500/10 border border-amber-500/20\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.2 }}\n        >\n          <div className=\"flex items-center gap-3 mb-2\">\n            <div className=\"p-2 rounded-lg bg-amber-500/20\">\n              <FileQuestion size={18} className=\"text-amber-400\" />\n            </div>\n            <span className=\"text-sm text-muted-foreground\">Manual Review</span>\n          </div>\n          <p className=\"text-2xl font-bold text-white\">{stats.manualReview}</p>\n          <p className=\"text-xs text-muted-foreground\">Needs review</p>\n        </motion.div>\n\n        <motion.div\n          className=\"p-4 rounded-xl bg-blue-500/10 border border-blue-500/20\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.3 }}\n        >\n          <div className=\"flex items-center gap-3 mb-2\">\n            <div className=\"p-2 rounded-lg bg-blue-500/20\">\n              <Clock size={18} className=\"text-blue-400\" />\n            </div>\n            <span className=\"text-sm text-muted-foreground\">Pending</span>\n          </div>\n          <p className=\"text-2xl font-bold text-white\">{stats.pending}</p>\n          <p className=\"text-xs text-muted-foreground\">Awaiting response</p>\n        </motion.div>\n      </div>\n\n      <GlassPanel size=\"sm\" className=\"flex flex-wrap gap-4 items-center\">\n        <div className=\"relative flex-1 min-w-[200px]\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" size={18} />\n          <input\n            type=\"text\"\n            placeholder=\"Search by phone, receipt number...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"w-full pl-10 pr-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-cyan-500/50\"\n            data-testid=\"input-search-transactions\"\n          />\n        </div>\n        \n        <Select value={filterPeriod} onValueChange={setFilterPeriod}>\n          <SelectTrigger className=\"w-[130px] bg-white/5 border-white/10\" data-testid=\"select-period\">\n            <Calendar size={14} className=\"mr-2\" />\n            <SelectValue placeholder=\"Period\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"1d\">Today</SelectItem>\n            <SelectItem value=\"7d\">Last 7 days</SelectItem>\n            <SelectItem value=\"30d\">Last 30 days</SelectItem>\n            <SelectItem value=\"90d\">Last 90 days</SelectItem>\n          </SelectContent>\n        </Select>\n        \n        <Select value={filterReconciliationStatus} onValueChange={setFilterReconciliationStatus}>\n          <SelectTrigger className=\"w-[150px] bg-white/5 border-white/10\" data-testid=\"select-reconciliation-status\">\n            <SelectValue placeholder=\"Reconciliation\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Status</SelectItem>\n            <SelectItem value=\"MATCHED\">Matched</SelectItem>\n            <SelectItem value=\"UNMATCHED\">Unmatched</SelectItem>\n            <SelectItem value=\"MANUAL_REVIEW\">Manual Review</SelectItem>\n            <SelectItem value=\"PENDING\">Pending</SelectItem>\n          </SelectContent>\n        </Select>\n\n        <Select value={filterTransactionStatus} onValueChange={setFilterTransactionStatus}>\n          <SelectTrigger className=\"w-[140px] bg-white/5 border-white/10\" data-testid=\"select-transaction-status\">\n            <SelectValue placeholder=\"Tx Status\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Transactions</SelectItem>\n            <SelectItem value=\"COMPLETED\">Completed</SelectItem>\n            <SelectItem value=\"PENDING\">Pending</SelectItem>\n            <SelectItem value=\"FAILED\">Failed</SelectItem>\n          </SelectContent>\n        </Select>\n      </GlassPanel>\n\n      <GlassPanel>\n        <div className=\"flex items-center justify-between mb-4\">\n          <h2 className=\"text-lg font-semibold text-white\">Transaction Log</h2>\n          <p className=\"text-sm text-muted-foreground\">\n            Showing {filteredTransactions?.length || 0} transactions\n          </p>\n        </div>\n\n        {isLoading ? (\n          <div className=\"space-y-3\">\n            {[1, 2, 3, 4, 5].map((i) => (\n              <div key={i} className=\"animate-pulse flex items-center gap-4 p-4 rounded-lg bg-white/5\">\n                <div className=\"w-10 h-10 rounded-full bg-white/10\" />\n                <div className=\"flex-1 space-y-2\">\n                  <div className=\"h-4 bg-white/10 rounded w-1/4\" />\n                  <div className=\"h-3 bg-white/10 rounded w-1/3\" />\n                </div>\n              </div>\n            ))}\n          </div>\n        ) : filteredTransactions && filteredTransactions.length > 0 ? (\n          <div className=\"space-y-2\">\n            <div className=\"grid grid-cols-12 gap-4 px-4 py-2 text-xs font-medium text-muted-foreground uppercase tracking-wider border-b border-white/10\">\n              <div className=\"col-span-2\">Phone</div>\n              <div className=\"col-span-2\">Amount</div>\n              <div className=\"col-span-2\">Receipt</div>\n              <div className=\"col-span-2\">Plan</div>\n              <div className=\"col-span-2\">Status</div>\n              <div className=\"col-span-2\">Reconciliation</div>\n            </div>\n\n            {filteredTransactions.map((tx, index) => {\n              const plan = tx.planId ? plansMap.get(tx.planId) : null;\n              const StatusIcon = tx.status === \"COMPLETED\" ? CheckCircle : tx.status === \"FAILED\" ? XCircle : Clock;\n              \n              return (\n                <motion.div\n                  key={tx.id}\n                  initial={{ opacity: 0, y: 10 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ delay: index * 0.02 }}\n                  className=\"grid grid-cols-12 gap-4 items-center px-4 py-3 rounded-lg bg-white/[0.02] hover:bg-white/[0.05] transition-colors border border-transparent hover:border-white/10\"\n                  data-testid={`transaction-row-${tx.id}`}\n                >\n                  <div className=\"col-span-2\">\n                    <p className=\"font-medium text-white text-sm\">{tx.userPhone}</p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {tx.createdAt ? format(new Date(tx.createdAt), \"MMM d, HH:mm\") : \"N/A\"}\n                    </p>\n                  </div>\n                  <div className=\"col-span-2\">\n                    <p className=\"font-semibold text-white\">{formatCurrency(tx.amount)}</p>\n                  </div>\n                  <div className=\"col-span-2\">\n                    <p className=\"text-sm text-white truncate\">\n                      {tx.mpesaReceiptNumber || \"-\"}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground truncate\">\n                      {tx.checkoutRequestId?.slice(0, 15) || \"-\"}...\n                    </p>\n                  </div>\n                  <div className=\"col-span-2\">\n                    <p className=\"text-sm text-white truncate\">\n                      {plan?.name || \"-\"}\n                    </p>\n                  </div>\n                  <div className=\"col-span-2\">\n                    <Badge \n                      variant=\"outline\" \n                      className={cn(\"text-xs flex items-center gap-1 w-fit\", transactionStatusColors[tx.status as keyof typeof transactionStatusColors])}\n                    >\n                      <StatusIcon size={12} />\n                      {tx.status}\n                    </Badge>\n                  </div>\n                  <div className=\"col-span-2\">\n                    <Badge \n                      variant=\"outline\" \n                      className={cn(\"text-xs\", reconciliationStatusColors[tx.reconciliationStatus as keyof typeof reconciliationStatusColors])}\n                    >\n                      {reconciliationStatusLabels[tx.reconciliationStatus as keyof typeof reconciliationStatusLabels] || tx.reconciliationStatus}\n                    </Badge>\n                  </div>\n                </motion.div>\n              );\n            })}\n          </div>\n        ) : (\n          <div className=\"text-center py-12 text-muted-foreground\">\n            <Filter size={48} className=\"mx-auto mb-4 opacity-50\" />\n            <p>No transactions found</p>\n            <p className=\"text-xs mt-1\">Try adjusting your filters</p>\n          </div>\n        )}\n      </GlassPanel>\n    </div>\n  );\n}\n","path":null,"size_bytes":15105,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"client/src/components/walled-garden.tsx":{"content":"import { motion, AnimatePresence } from \"framer-motion\";\nimport { Globe, Plus, X, Shield } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport type { WalledGarden } from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { GlassInput } from \"./glass-input\";\nimport { useState } from \"react\";\n\ninterface WalledGardenListProps {\n  domains: WalledGarden[];\n  onAdd?: (domain: string, description?: string) => void;\n  onRemove?: (domain: WalledGarden) => void;\n  readOnly?: boolean;\n}\n\nexport function WalledGardenList({\n  domains,\n  onAdd,\n  onRemove,\n  readOnly = false,\n}: WalledGardenListProps) {\n  const [newDomain, setNewDomain] = useState(\"\");\n  const [isAdding, setIsAdding] = useState(false);\n\n  const handleAdd = () => {\n    if (newDomain.trim()) {\n      onAdd?.(newDomain.trim());\n      setNewDomain(\"\");\n      setIsAdding(false);\n    }\n  };\n\n  return (\n    <div className=\"space-y-4\" data-testid=\"walled-garden-list\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-2\">\n          <Shield size={20} className=\"text-cyan-400\" />\n          <h3 className=\"text-lg font-semibold text-white\">Walled Garden</h3>\n        </div>\n        {!readOnly && !isAdding && (\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => setIsAdding(true)}\n            className=\"text-cyan-400 hover:text-cyan-300\"\n            data-testid=\"button-add-domain\"\n          >\n            <Plus size={16} className=\"mr-1\" />\n            Add Domain\n          </Button>\n        )}\n      </div>\n\n      <p className=\"text-sm text-muted-foreground\">\n        Domains that users can access before authentication (e.g., for M-Pesa payments)\n      </p>\n\n      {/* Add domain form */}\n      <AnimatePresence>\n        {isAdding && (\n          <motion.div\n            initial={{ opacity: 0, height: 0 }}\n            animate={{ opacity: 1, height: \"auto\" }}\n            exit={{ opacity: 0, height: 0 }}\n            className=\"flex gap-2\"\n          >\n            <div className=\"flex-1\">\n              <GlassInput\n                placeholder=\"e.g., safaricom.co.ke\"\n                value={newDomain}\n                onChange={(e) => setNewDomain(e.target.value)}\n                onKeyDown={(e) => e.key === \"Enter\" && handleAdd()}\n                data-testid=\"input-new-domain\"\n              />\n            </div>\n            <Button onClick={handleAdd} className=\"gradient-btn\" data-testid=\"button-confirm-domain\">\n              Add\n            </Button>\n            <Button\n              variant=\"ghost\"\n              onClick={() => {\n                setIsAdding(false);\n                setNewDomain(\"\");\n              }}\n              data-testid=\"button-cancel-domain\"\n            >\n              Cancel\n            </Button>\n          </motion.div>\n        )}\n      </AnimatePresence>\n\n      {/* Domain list */}\n      <div className=\"space-y-2\">\n        <AnimatePresence mode=\"popLayout\">\n          {domains.length === 0 ? (\n            <motion.div\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              className=\"text-center py-8 text-muted-foreground\"\n              data-testid=\"walled-garden-empty\"\n            >\n              <Globe size={32} className=\"mx-auto mb-2 opacity-50\" />\n              <p>No domains configured</p>\n            </motion.div>\n          ) : (\n            domains.map((domain) => (\n              <WalledGardenItem\n                key={domain.id}\n                domain={domain}\n                onRemove={onRemove}\n                readOnly={readOnly}\n              />\n            ))\n          )}\n        </AnimatePresence>\n      </div>\n    </div>\n  );\n}\n\ninterface WalledGardenItemProps {\n  domain: WalledGarden;\n  onRemove?: (domain: WalledGarden) => void;\n  readOnly?: boolean;\n}\n\nfunction WalledGardenItem({ domain, onRemove, readOnly }: WalledGardenItemProps) {\n  return (\n    <motion.div\n      className={cn(\n        \"flex items-center justify-between gap-4 p-3 rounded-xl\",\n        \"bg-white/5 border border-white/10\",\n        !domain.isActive && \"opacity-50\"\n      )}\n      initial={{ opacity: 0, x: -10 }}\n      animate={{ opacity: 1, x: 0 }}\n      exit={{ opacity: 0, x: 10 }}\n      layout\n      data-testid={`walled-garden-item-${domain.id}`}\n    >\n      <div className=\"flex items-center gap-3\">\n        <Globe size={16} className=\"text-muted-foreground\" />\n        <div>\n          <span className=\"text-white font-medium\">{domain.domain}</span>\n          {domain.description && (\n            <p className=\"text-xs text-muted-foreground\">{domain.description}</p>\n          )}\n        </div>\n      </div>\n\n      {!readOnly && (\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => onRemove?.(domain)}\n          className=\"h-8 w-8 text-muted-foreground hover:text-destructive\"\n          data-testid={`button-remove-domain-${domain.id}`}\n        >\n          <X size={14} />\n        </Button>\n      )}\n    </motion.div>\n  );\n}\n\n// Compact walled garden display for captive portal\ninterface WalledGardenFooterProps {\n  domains: WalledGarden[];\n}\n\nexport function WalledGardenFooter({ domains }: WalledGardenFooterProps) {\n  if (domains.length === 0) return null;\n\n  return (\n    <div\n      className=\"mt-6 pt-4 border-t border-white/10 text-center\"\n      data-testid=\"walled-garden-footer\"\n    >\n      <p className=\"text-xs text-muted-foreground mb-2\">\n        You can access these sites before connecting:\n      </p>\n      <div className=\"flex flex-wrap justify-center gap-2\">\n        {domains.slice(0, 5).map((domain) => (\n          <span\n            key={domain.id}\n            className=\"px-2 py-1 rounded-full bg-white/5 text-xs text-muted-foreground\"\n          >\n            {domain.domain}\n          </span>\n        ))}\n        {domains.length > 5 && (\n          <span className=\"px-2 py-1 rounded-full bg-white/5 text-xs text-muted-foreground\">\n            +{domains.length - 5} more\n          </span>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":6075,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"server/services/sms.ts":{"content":"import type { Tenant, WifiUser, Plan, Transaction } from \"@shared/schema\";\n\ninterface SmsResult {\n  success: boolean;\n  messageId?: string;\n  error?: string;\n  cost?: string;\n  balance?: string;\n}\n\ninterface MobitechResponse {\n  status_code: string;\n  status_desc: string;\n  message_id: number | string;\n  mobile_number: string;\n  network_id: string;\n  message_cost: string;\n  credit_balance: string;\n}\n\ninterface MobitechBalanceResponse {\n  status_code: string;\n  status_desc: string;\n  credit_balance: string;\n}\n\ninterface DeliveryReport {\n  messageId: string;\n  dlrTime: string;\n  dlrStatus: number;\n  dlrDesc: string;\n  tat?: number;\n  network?: number;\n  destaddr: string;\n  sourceaddr: string;\n  origin?: string;\n}\n\nconst MOBITECH_BASE_URL = \"https://app.mobitechtechnologies.com\";\nconst SENDER_NAME = \"MNETIFI\";\n\nexport class SmsService {\n  private apiKey: string;\n\n  constructor() {\n    this.apiKey = process.env.MOBITECH_API_KEY || \"\";\n  }\n\n  async sendSms(phoneNumber: string, message: string): Promise<SmsResult> {\n    const formattedPhone = this.formatPhoneNumber(phoneNumber);\n    \n    console.log(`[SMS] Sending to ${formattedPhone}: ${message.substring(0, 50)}...`);\n\n    if (!this.apiKey) {\n      console.log(\"[SMS] No API key configured, using mock mode\");\n      return this.sendMock(formattedPhone, message);\n    }\n\n    return this.sendViaMobitech(formattedPhone, message);\n  }\n\n  private async sendViaMobitech(phone: string, message: string): Promise<SmsResult> {\n    try {\n      const response = await fetch(`${MOBITECH_BASE_URL}/sms/sendsms`, {\n        method: \"POST\",\n        headers: {\n          \"h_api_key\": this.apiKey,\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({\n          mobile: phone,\n          response_type: \"json\",\n          sender_name: SENDER_NAME,\n          service_id: 0,\n          message: message,\n        }),\n      });\n\n      const data = await response.json() as MobitechResponse[];\n      \n      if (Array.isArray(data) && data.length > 0) {\n        const result = data[0];\n        \n        if (result.status_code === \"1000\") {\n          console.log(`[SMS] Mobitech message sent: ${result.message_id}, cost: ${result.message_cost}`);\n          return {\n            success: true,\n            messageId: String(result.message_id),\n            cost: result.message_cost,\n            balance: result.credit_balance,\n          };\n        }\n\n        console.error(`[SMS] Mobitech error: ${result.status_code} - ${result.status_desc}`);\n        return {\n          success: false,\n          error: `${result.status_code}: ${result.status_desc}`,\n        };\n      }\n\n      return { success: false, error: \"Invalid response from Mobitech\" };\n    } catch (error) {\n      console.error(\"[SMS] Mobitech request error:\", error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : \"Mobitech request failed\",\n      };\n    }\n  }\n\n  private async sendMock(phone: string, message: string): Promise<SmsResult> {\n    console.log(`[SMS Mock] To: ${phone}`);\n    console.log(`[SMS Mock] Message: ${message}`);\n    \n    return { \n      success: true, \n      messageId: `MOCK_${Date.now()}_${Math.random().toString(36).substring(7)}` \n    };\n  }\n\n  async getBalance(): Promise<{ success: boolean; balance?: string; error?: string }> {\n    if (!this.apiKey) {\n      return { success: false, error: \"API key not configured\" };\n    }\n\n    try {\n      const response = await fetch(`${MOBITECH_BASE_URL}/sms/getbalance`, {\n        method: \"GET\",\n        headers: {\n          \"h_api_key\": this.apiKey,\n          \"Content-Type\": \"application/json\",\n        },\n      });\n\n      const data = await response.json() as MobitechBalanceResponse;\n      \n      if (data.status_code === \"1000\") {\n        return { success: true, balance: data.credit_balance };\n      }\n\n      return { success: false, error: data.status_desc };\n    } catch (error) {\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : \"Failed to get balance\",\n      };\n    }\n  }\n\n  async validatePhoneNumber(phone: string): Promise<{ valid: boolean; network?: string; formatted?: string }> {\n    const formatted = this.formatPhoneNumber(phone);\n    \n    if (!this.apiKey) {\n      return { valid: true, formatted };\n    }\n\n    try {\n      const response = await fetch(\n        `${MOBITECH_BASE_URL}/sms/mobile?mobile=${formatted.replace('+', '')}&return=json`,\n        {\n          method: \"GET\",\n          headers: {\n            \"h_api_key\": this.apiKey,\n          },\n        }\n      );\n\n      const data = await response.json();\n      return {\n        valid: true,\n        network: data.network_name || \"Unknown\",\n        formatted,\n      };\n    } catch (error) {\n      return { valid: false };\n    }\n  }\n\n  private formatPhoneNumber(phone: string): string {\n    let cleaned = phone.replace(/\\D/g, \"\");\n    \n    if (cleaned.startsWith(\"0\")) {\n      cleaned = \"254\" + cleaned.slice(1);\n    } else if (cleaned.startsWith(\"+\")) {\n      cleaned = cleaned.slice(1);\n    } else if (!cleaned.startsWith(\"254\")) {\n      cleaned = \"254\" + cleaned;\n    }\n\n    return \"+\" + cleaned;\n  }\n\n  async sendOtp(phoneNumber: string, otp: string): Promise<SmsResult> {\n    const message = `MnetiFi: Your verification code is ${otp}. Valid for 5 minutes. Do not share this code with anyone.`;\n    return this.sendSms(phoneNumber, message);\n  }\n\n  async sendPaymentConfirmation(user: WifiUser, transaction: Transaction, plan: Plan): Promise<SmsResult> {\n    const message = `MnetiFi: Payment of Ksh ${transaction.amount} received! Your ${plan.name} plan is now active. Expires in ${this.formatDuration(plan.durationSeconds)}. Receipt: ${transaction.mpesaReceiptNumber || \"Processing\"}`;\n    return this.sendSms(user.phoneNumber, message);\n  }\n\n  async sendExpiryReminder(user: WifiUser, hoursRemaining: number): Promise<SmsResult> {\n    const message = `MnetiFi: Your WiFi plan expires in ${hoursRemaining} hours. Recharge now to stay connected! Visit our portal or dial *123# to purchase a new plan.`;\n    return this.sendSms(user.phoneNumber, message);\n  }\n\n  async sendExpiryNotification(user: WifiUser): Promise<SmsResult> {\n    const message = `MnetiFi: Your WiFi plan has expired. Recharge now to restore your connection. Visit our portal or dial *123# to purchase a new plan.`;\n    return this.sendSms(user.phoneNumber, message);\n  }\n\n  async sendWelcome(user: WifiUser): Promise<SmsResult> {\n    const message = `Welcome to MnetiFi WiFi! Your account has been created. Connect to our hotspot and select a plan to get started. Need help? Call support.`;\n    return this.sendSms(user.phoneNumber, message);\n  }\n\n  async sendSuspensionNotice(user: WifiUser, reason: string): Promise<SmsResult> {\n    const message = `MnetiFi: Your WiFi account has been suspended. Reason: ${reason}. Please contact support for assistance.`;\n    return this.sendSms(user.phoneNumber, message);\n  }\n\n  async sendReactivationNotice(user: WifiUser): Promise<SmsResult> {\n    const message = `MnetiFi: Your WiFi account has been reactivated. You can now connect and browse. Thank you for your patience!`;\n    return this.sendSms(user.phoneNumber, message);\n  }\n\n  async sendIspOtp(phoneNumber: string, otp: string, ispName: string): Promise<SmsResult> {\n    const message = `MnetiFi Platform: Your verification code for ${ispName} is ${otp}. Valid for 5 minutes. Do not share this code.`;\n    return this.sendSms(phoneNumber, message);\n  }\n\n  async sendIspPaymentConfirmation(phoneNumber: string, amount: number, ispName: string, planName: string): Promise<SmsResult> {\n    const message = `MnetiFi: Payment of Ksh ${amount} received for ${ispName}. Your ${planName} subscription is now active. Thank you!`;\n    return this.sendSms(phoneNumber, message);\n  }\n\n  async sendIspExpiryReminder(phoneNumber: string, ispName: string, daysRemaining: number): Promise<SmsResult> {\n    const message = `MnetiFi Platform: ${ispName}, your subscription expires in ${daysRemaining} days. Renew now to avoid service interruption.`;\n    return this.sendSms(phoneNumber, message);\n  }\n\n  async sendIspSuspensionNotice(phoneNumber: string, ispName: string): Promise<SmsResult> {\n    const message = `MnetiFi Platform: ${ispName}, your account has been suspended due to non-payment. Please contact support to reactivate.`;\n    return this.sendSms(phoneNumber, message);\n  }\n\n  private formatDuration(seconds: number): string {\n    if (seconds < 3600) {\n      return `${Math.round(seconds / 60)} minutes`;\n    } else if (seconds < 86400) {\n      return `${Math.round(seconds / 3600)} hours`;\n    } else if (seconds < 604800) {\n      return `${Math.round(seconds / 86400)} days`;\n    } else {\n      return `${Math.round(seconds / 604800)} weeks`;\n    }\n  }\n\n  static processDeliveryReport(report: DeliveryReport): {\n    messageId: string;\n    status: \"delivered\" | \"failed\" | \"pending\";\n    description: string;\n    deliveredAt?: Date;\n  } {\n    const statusMap: Record<number, \"delivered\" | \"failed\" | \"pending\"> = {\n      1: \"delivered\",\n      2: \"failed\",\n      3: \"pending\",\n    };\n\n    return {\n      messageId: String(report.messageId),\n      status: statusMap[report.dlrStatus] || \"pending\",\n      description: report.dlrDesc,\n      deliveredAt: report.dlrStatus === 1 ? new Date(report.dlrTime) : undefined,\n    };\n  }\n}\n\nlet smsServiceInstance: SmsService | null = null;\n\nexport function getSmsService(): SmsService {\n  if (!smsServiceInstance) {\n    smsServiceInstance = new SmsService();\n  }\n  return smsServiceInstance;\n}\n\nexport function createSmsService(): SmsService {\n  return new SmsService();\n}\n\nexport const SmsTemplates = {\n  otp: (code: string) =>\n    `MnetiFi: Your verification code is ${code}. Valid for 5 minutes.`,\n  \n  paymentConfirmation: (amount: number, planName: string, duration: string, receipt: string) =>\n    `MnetiFi: Payment of Ksh ${amount} received! Your ${planName} plan is now active. Expires in ${duration}. Receipt: ${receipt}`,\n  \n  expiryReminder: (hours: number) =>\n    `MnetiFi: Your WiFi plan expires in ${hours} hours. Recharge now to stay connected!`,\n  \n  expiryNotification: () =>\n    `MnetiFi: Your WiFi plan has expired. Recharge now to restore your connection.`,\n  \n  welcome: () =>\n    `Welcome to MnetiFi WiFi! Connect to our hotspot and select a plan to get started.`,\n\n  ispOtp: (code: string, ispName: string) =>\n    `MnetiFi Platform: Your verification code for ${ispName} is ${code}. Valid for 5 minutes.`,\n  \n  ispPaymentConfirmation: (amount: number, ispName: string, plan: string) =>\n    `MnetiFi: Payment of Ksh ${amount} received for ${ispName}. Your ${plan} subscription is now active.`,\n  \n  ispExpiryReminder: (ispName: string, days: number) =>\n    `MnetiFi Platform: ${ispName}, your subscription expires in ${days} days. Renew now.`,\n};\n","path":null,"size_bytes":10849,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"server/static.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(__dirname, \"public\");\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":547,"size_tokens":null},"client/src/components/hotspot-card.tsx":{"content":"import { motion } from \"framer-motion\";\nimport { Wifi, MapPin, Server, Shield, MoreVertical, Power, PowerOff, Edit, Trash2 } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport type { Hotspot } from \"@shared/schema\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface HotspotCardProps {\n  hotspot: Hotspot;\n  onEdit?: (hotspot: Hotspot) => void;\n  onDelete?: (hotspot: Hotspot) => void;\n  onToggleActive?: (hotspot: Hotspot) => void;\n}\n\nexport function HotspotCard({ hotspot, onEdit, onDelete, onToggleActive }: HotspotCardProps) {\n  return (\n    <motion.div\n      className={cn(\n        \"rounded-2xl bg-white/5 backdrop-blur-xl border transition-all duration-300\",\n        hotspot.isActive ? \"border-white/10\" : \"border-white/5 opacity-60\",\n        \"hover:border-white/20 group\"\n      )}\n      initial={{ opacity: 0, scale: 0.95 }}\n      animate={{ opacity: 1, scale: 1 }}\n      exit={{ opacity: 0, scale: 0.95 }}\n      whileHover={{ y: -2 }}\n      data-testid={`hotspot-card-${hotspot.id}`}\n    >\n      <div className=\"p-5\">\n        <div className=\"flex items-start justify-between\">\n          {/* Icon and status */}\n          <div className=\"flex items-start gap-3\">\n            <div\n              className={cn(\n                \"p-3 rounded-xl\",\n                hotspot.isActive\n                  ? \"bg-cyan-500/20 text-cyan-400\"\n                  : \"bg-white/5 text-muted-foreground\"\n              )}\n            >\n              <Wifi size={24} />\n            </div>\n\n            <div>\n              <h3 className=\"text-lg font-semibold text-white\">{hotspot.locationName}</h3>\n              {hotspot.description && (\n                <p className=\"text-sm text-muted-foreground mt-1\">{hotspot.description}</p>\n              )}\n            </div>\n          </div>\n\n          {/* Actions menu */}\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"opacity-0 group-hover:opacity-100 transition-opacity\"\n                data-testid={`hotspot-menu-${hotspot.id}`}\n              >\n                <MoreVertical size={18} />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\" className=\"bg-popover border-white/10\">\n              <DropdownMenuItem\n                onClick={() => onEdit?.(hotspot)}\n                className=\"cursor-pointer\"\n                data-testid={`hotspot-edit-${hotspot.id}`}\n              >\n                <Edit size={14} className=\"mr-2\" />\n                Edit\n              </DropdownMenuItem>\n              <DropdownMenuItem\n                onClick={() => onToggleActive?.(hotspot)}\n                className=\"cursor-pointer\"\n                data-testid={`hotspot-toggle-${hotspot.id}`}\n              >\n                {hotspot.isActive ? (\n                  <>\n                    <PowerOff size={14} className=\"mr-2\" />\n                    Disable\n                  </>\n                ) : (\n                  <>\n                    <Power size={14} className=\"mr-2\" />\n                    Enable\n                  </>\n                )}\n              </DropdownMenuItem>\n              <DropdownMenuSeparator />\n              <DropdownMenuItem\n                onClick={() => onDelete?.(hotspot)}\n                className=\"cursor-pointer text-destructive focus:text-destructive\"\n                data-testid={`hotspot-delete-${hotspot.id}`}\n              >\n                <Trash2 size={14} className=\"mr-2\" />\n                Delete\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n\n        {/* Details */}\n        <div className=\"mt-4 pt-4 border-t border-white/5 grid grid-cols-2 gap-4\">\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <Server size={14} className=\"text-blue-400\" />\n            <span className=\"font-mono text-xs\">{hotspot.nasIp}</span>\n          </div>\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <Shield size={14} className=\"text-purple-400\" />\n            <span className=\"font-mono text-xs\">\n              {hotspot.secret.slice(0, 4)}****\n            </span>\n          </div>\n        </div>\n\n        {/* Status indicator */}\n        <div className=\"mt-4 flex items-center gap-2\">\n          <span\n            className={cn(\n              \"w-2 h-2 rounded-full\",\n              hotspot.isActive ? \"bg-cyan-400\" : \"bg-gray-500\"\n            )}\n          />\n          <span className=\"text-xs text-muted-foreground\">\n            {hotspot.isActive ? \"Active\" : \"Inactive\"}\n          </span>\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\n// Hotspot card skeleton\nexport function HotspotCardSkeleton() {\n  return (\n    <div\n      className=\"rounded-2xl bg-white/5 border border-white/10 p-5 animate-pulse\"\n      data-testid=\"hotspot-card-skeleton\"\n    >\n      <div className=\"flex items-start gap-3\">\n        <div className=\"w-12 h-12 rounded-xl bg-white/10\" />\n        <div className=\"flex-1 space-y-2\">\n          <div className=\"h-6 w-32 bg-white/10 rounded\" />\n          <div className=\"h-4 w-48 bg-white/10 rounded\" />\n        </div>\n      </div>\n      <div className=\"mt-4 pt-4 border-t border-white/5 grid grid-cols-2 gap-4\">\n        <div className=\"h-4 w-24 bg-white/10 rounded\" />\n        <div className=\"h-4 w-20 bg-white/10 rounded\" />\n      </div>\n    </div>\n  );\n}\n\n// Add hotspot button\ninterface AddHotspotButtonProps {\n  onClick?: () => void;\n}\n\nexport function AddHotspotButton({ onClick }: AddHotspotButtonProps) {\n  return (\n    <motion.button\n      className={cn(\n        \"w-full rounded-2xl border-2 border-dashed border-white/10 p-8\",\n        \"hover:border-cyan-500/30 hover:bg-white/5 transition-all duration-200\",\n        \"flex flex-col items-center justify-center gap-3 text-muted-foreground hover:text-white\"\n      )}\n      onClick={onClick}\n      whileHover={{ scale: 1.02 }}\n      whileTap={{ scale: 0.98 }}\n      data-testid=\"button-add-hotspot\"\n    >\n      <div className=\"w-12 h-12 rounded-full bg-white/5 flex items-center justify-center\">\n        <MapPin size={24} />\n      </div>\n      <span className=\"font-medium\">Add Hotspot Location</span>\n    </motion.button>\n  );\n}\n","path":null,"size_bytes":6467,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/pages/wifi-users.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation, Link } from \"wouter\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Plus, \n  Users, \n  Phone, \n  Mail, \n  Wifi, \n  Router,\n  Clock,\n  Search,\n  MoreVertical,\n  RefreshCw,\n  Ban,\n  Play,\n  ArrowRightLeft,\n  UserCircle,\n  Eye,\n  Download,\n} from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput, GlassTextarea } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n  DropdownMenuSeparator,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { cn } from \"@/lib/utils\";\nimport type { WifiUser, InsertWifiUser, Plan, Hotspot, User } from \"@shared/schema\";\nimport { formatDistanceToNow, format } from \"date-fns\";\nimport { exportToCSV } from \"@/lib/export-utils\";\n\nconst accountTypeLabels = {\n  HOTSPOT: \"Hotspot\",\n  PPPOE: \"PPPoE\",\n  STATIC: \"Static IP\",\n};\n\nconst statusColors = {\n  ACTIVE: \"bg-emerald-500/20 text-emerald-400 border-emerald-500/30\",\n  SUSPENDED: \"bg-amber-500/20 text-amber-400 border-amber-500/30\",\n  EXPIRED: \"bg-red-500/20 text-red-400 border-red-500/30\",\n};\n\nexport default function WifiUsersPage() {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingUser, setEditingUser] = useState<WifiUser | null>(null);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [filterAccountType, setFilterAccountType] = useState<string>(\"all\");\n  const [filterStatus, setFilterStatus] = useState<string>(\"all\");\n\n  const [formData, setFormData] = useState<Partial<InsertWifiUser>>({\n    phoneNumber: \"\",\n    email: \"\",\n    fullName: \"\",\n    accountType: \"HOTSPOT\",\n    username: \"\",\n    password: \"\",\n    macAddress: \"\",\n    ipAddress: \"\",\n    notes: \"\",\n    technicianId: \"\",\n  });\n\n  const { data: wifiUsers, isLoading } = useQuery<WifiUser[]>({\n    queryKey: [\"/api/wifi-users\"],\n  });\n\n  const { data: plans } = useQuery<Plan[]>({\n    queryKey: [\"/api/plans\"],\n  });\n\n  const { data: hotspots } = useQuery<Hotspot[]>({\n    queryKey: [\"/api/hotspots\"],\n  });\n\n  const { data: technicians } = useQuery<User[]>({\n    queryKey: [\"/api/users/technicians\"],\n  });\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: Partial<InsertWifiUser>) => {\n      if (editingUser) {\n        return apiRequest(\"PATCH\", `/api/wifi-users/${editingUser.id}`, data);\n      }\n      return apiRequest(\"POST\", \"/api/wifi-users\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/wifi-users\"] });\n      toast({\n        title: editingUser ? \"User Updated\" : \"User Created\",\n        description: `WiFi user has been ${editingUser ? \"updated\" : \"created\"} successfully.`,\n      });\n      handleCloseDialog();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save user\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/wifi-users/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/wifi-users\"] });\n      toast({\n        title: \"User Deleted\",\n        description: \"WiFi user has been deleted successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to delete user\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const actionMutation = useMutation({\n    mutationFn: async ({ id, action, data }: { id: string; action: string; data?: any }) => {\n      return apiRequest(\"POST\", `/api/wifi-users/${id}/${action}`, data || {});\n    },\n    onSuccess: (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/wifi-users\"] });\n      const actionLabels: Record<string, string> = {\n        suspend: \"User suspended\",\n        activate: \"User activated\",\n        recharge: \"Account recharged\",\n        \"change-hotspot\": \"Hotspot changed\",\n      };\n      toast({\n        title: \"Success\",\n        description: actionLabels[variables.action] || \"Action completed successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to perform action\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleOpenDialog = (user?: WifiUser) => {\n    if (user) {\n      setEditingUser(user);\n      setFormData({\n        phoneNumber: user.phoneNumber,\n        email: user.email || \"\",\n        fullName: user.fullName || \"\",\n        accountType: user.accountType,\n        username: user.username || \"\",\n        password: \"\",\n        macAddress: user.macAddress || \"\",\n        ipAddress: user.ipAddress || \"\",\n        notes: user.notes || \"\",\n        currentPlanId: user.currentPlanId || undefined,\n        currentHotspotId: user.currentHotspotId || undefined,\n        technicianId: user.technicianId || undefined,\n      });\n    } else {\n      setEditingUser(null);\n      setFormData({\n        phoneNumber: \"\",\n        email: \"\",\n        fullName: \"\",\n        accountType: \"HOTSPOT\",\n        username: \"\",\n        password: \"\",\n        macAddress: \"\",\n        ipAddress: \"\",\n        notes: \"\",\n      });\n    }\n    setIsDialogOpen(true);\n  };\n\n  const handleCloseDialog = () => {\n    setIsDialogOpen(false);\n    setEditingUser(null);\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    saveMutation.mutate(formData);\n  };\n\n  const filteredUsers = wifiUsers?.filter((user) => {\n    const matchesSearch = \n      user.phoneNumber.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      user.fullName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      user.email?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      user.username?.toLowerCase().includes(searchQuery.toLowerCase());\n    \n    const matchesAccountType = filterAccountType === \"all\" || user.accountType === filterAccountType;\n    const matchesStatus = filterStatus === \"all\" || user.status === filterStatus;\n    \n    return matchesSearch && matchesAccountType && matchesStatus;\n  });\n\n  const plansMap = new Map(plans?.map((p) => [p.id, p]) || []);\n  const hotspotsMap = new Map(hotspots?.map((h) => [h.id, h]) || []);\n\n  const handleExport = () => {\n    if (!filteredUsers || filteredUsers.length === 0) {\n      toast({\n        title: \"No Data\",\n        description: \"No users to export with current filters.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    exportToCSV(\n      filteredUsers,\n      [\n        { key: \"fullName\", header: \"Full Name\" },\n        { key: \"phoneNumber\", header: \"Phone Number\" },\n        { key: \"email\", header: \"Email\" },\n        { key: \"accountType\", header: \"Account Type\", formatter: (val) => accountTypeLabels[val as keyof typeof accountTypeLabels] || val },\n        { key: \"status\", header: \"Status\" },\n        { key: \"username\", header: \"Username\" },\n        { key: \"macAddress\", header: \"MAC Address\" },\n        { key: \"ipAddress\", header: \"IP Address\" },\n        { key: \"currentPlanId\", header: \"Plan\", formatter: (val) => val ? plansMap.get(val)?.name || \"\" : \"\" },\n        { key: \"currentHotspotId\", header: \"Hotspot\", formatter: (val) => val ? hotspotsMap.get(val)?.locationName || \"\" : \"\" },\n        { key: \"expiryTime\", header: \"Expiry Date\", formatter: (val) => val ? format(new Date(val), \"yyyy-MM-dd HH:mm\") : \"\" },\n        { key: \"createdAt\", header: \"Created\", formatter: (val) => val ? format(new Date(val), \"yyyy-MM-dd HH:mm\") : \"\" },\n      ],\n      \"wifi_users\"\n    );\n\n    toast({\n      title: \"Export Complete\",\n      description: `Exported ${filteredUsers.length} user(s) to CSV.`,\n    });\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"wifi-users-page\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">Customers</h1>\n          <p className=\"text-muted-foreground\">\n            Manage customer accounts - Hotspot, PPPoE, and Static IP users\n          </p>\n        </div>\n        <div className=\"flex gap-3\">\n          <Button\n            variant=\"ghost\"\n            onClick={handleExport}\n            data-testid=\"button-export-users\"\n          >\n            <Download size={18} className=\"mr-2\" />\n            Export\n          </Button>\n          <Button\n            className=\"gradient-btn\"\n            onClick={() => handleOpenDialog()}\n            data-testid=\"button-add-user\"\n          >\n            <Plus size={18} className=\"mr-2\" />\n            Add User\n          </Button>\n        </div>\n      </div>\n\n      <GlassPanel size=\"sm\" className=\"flex flex-wrap gap-4 items-center\">\n        <div className=\"relative flex-1 min-w-[200px]\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" size={18} />\n          <input\n            type=\"text\"\n            placeholder=\"Search by phone, name, email, or username...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"w-full pl-10 pr-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-cyan-500/50\"\n            data-testid=\"input-search-users\"\n          />\n        </div>\n        \n        <Select value={filterAccountType} onValueChange={setFilterAccountType}>\n          <SelectTrigger className=\"w-[150px] bg-white/5 border-white/10\" data-testid=\"select-account-type\">\n            <SelectValue placeholder=\"Account Type\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Types</SelectItem>\n            <SelectItem value=\"HOTSPOT\">Hotspot</SelectItem>\n            <SelectItem value=\"PPPOE\">PPPoE</SelectItem>\n            <SelectItem value=\"STATIC\">Static IP</SelectItem>\n          </SelectContent>\n        </Select>\n\n        <Select value={filterStatus} onValueChange={setFilterStatus}>\n          <SelectTrigger className=\"w-[130px] bg-white/5 border-white/10\" data-testid=\"select-status\">\n            <SelectValue placeholder=\"Status\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Status</SelectItem>\n            <SelectItem value=\"ACTIVE\">Active</SelectItem>\n            <SelectItem value=\"SUSPENDED\">Suspended</SelectItem>\n            <SelectItem value=\"EXPIRED\">Expired</SelectItem>\n          </SelectContent>\n        </Select>\n      </GlassPanel>\n\n      <div className=\"space-y-4\">\n        {isLoading ? (\n          <div className=\"space-y-4\">\n            {[1, 2, 3].map((i) => (\n              <GlassPanel key={i} className=\"animate-pulse\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 rounded-full bg-white/10\" />\n                  <div className=\"flex-1 space-y-2\">\n                    <div className=\"h-4 bg-white/10 rounded w-1/4\" />\n                    <div className=\"h-3 bg-white/10 rounded w-1/3\" />\n                  </div>\n                </div>\n              </GlassPanel>\n            ))}\n          </div>\n        ) : filteredUsers && filteredUsers.length > 0 ? (\n          <AnimatePresence mode=\"popLayout\">\n            {filteredUsers.map((user) => (\n              <motion.div\n                key={user.id}\n                layout\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -10 }}\n              >\n                <GlassPanel className=\"flex flex-col md:flex-row md:items-center gap-4 hover:bg-white/[0.03] transition-colors\">\n                  <div className=\"flex items-center gap-4 flex-1\">\n                    <div className=\"w-12 h-12 rounded-full bg-gradient-to-br from-cyan-500/20 to-purple-500/20 flex items-center justify-center\">\n                      <UserCircle size={28} className=\"text-cyan-400\" />\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 flex-wrap\">\n                        <h3 className=\"font-semibold text-white truncate\" data-testid={`text-user-name-${user.id}`}>\n                          {user.fullName || user.phoneNumber}\n                        </h3>\n                        <Badge \n                          variant=\"outline\" \n                          className={cn(\"text-xs\", statusColors[user.status as keyof typeof statusColors])}\n                          data-testid={`badge-status-${user.id}`}\n                        >\n                          {user.status}\n                        </Badge>\n                        <Badge \n                          variant=\"outline\" \n                          className=\"text-xs bg-blue-500/20 text-blue-400 border-blue-500/30\"\n                        >\n                          {accountTypeLabels[user.accountType as keyof typeof accountTypeLabels]}\n                        </Badge>\n                      </div>\n                      <div className=\"flex items-center gap-4 text-sm text-muted-foreground mt-1 flex-wrap\">\n                        <span className=\"flex items-center gap-1\">\n                          <Phone size={14} />\n                          {user.phoneNumber}\n                        </span>\n                        {user.email && (\n                          <span className=\"flex items-center gap-1\">\n                            <Mail size={14} />\n                            {user.email}\n                          </span>\n                        )}\n                        {user.currentPlanId && plansMap.get(user.currentPlanId) && (\n                          <span className=\"flex items-center gap-1\">\n                            <Wifi size={14} />\n                            {plansMap.get(user.currentPlanId)?.name}\n                          </span>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n\n                  <div className=\"flex items-center gap-4 flex-wrap\">\n                    {user.expiryTime && (\n                      <div className=\"text-sm\">\n                        <span className=\"text-muted-foreground\">Expires: </span>\n                        <span className={cn(\n                          \"font-medium\",\n                          new Date(user.expiryTime) < new Date() ? \"text-red-400\" : \"text-white\"\n                        )}>\n                          {format(new Date(user.expiryTime), \"MMM d, yyyy HH:mm\")}\n                        </span>\n                      </div>\n                    )}\n                    \n                    {user.currentHotspotId && hotspotsMap.get(user.currentHotspotId) && (\n                      <div className=\"flex items-center gap-1 text-sm text-muted-foreground\">\n                        <Router size={14} />\n                        {hotspotsMap.get(user.currentHotspotId)?.locationName}\n                      </div>\n                    )}\n\n                    <DropdownMenu>\n                      <DropdownMenuTrigger asChild>\n                        <Button variant=\"ghost\" size=\"icon\" data-testid={`button-user-actions-${user.id}`}>\n                          <MoreVertical size={18} />\n                        </Button>\n                      </DropdownMenuTrigger>\n                      <DropdownMenuContent align=\"end\" className=\"w-48\">\n                        <DropdownMenuItem asChild>\n                          <Link href={`/dashboard/wifi-users/${user.id}`} className=\"flex items-center cursor-pointer\">\n                            <Eye size={16} className=\"mr-2\" />\n                            View Details\n                          </Link>\n                        </DropdownMenuItem>\n                        <DropdownMenuItem onClick={() => handleOpenDialog(user)}>\n                          <UserCircle size={16} className=\"mr-2\" />\n                          Edit Details\n                        </DropdownMenuItem>\n                        <DropdownMenuSeparator />\n                        <DropdownMenuItem \n                          onClick={() => actionMutation.mutate({ id: user.id, action: \"recharge\" })}\n                        >\n                          <RefreshCw size={16} className=\"mr-2\" />\n                          Quick Recharge\n                        </DropdownMenuItem>\n                        {user.status === \"ACTIVE\" ? (\n                          <DropdownMenuItem \n                            onClick={() => actionMutation.mutate({ id: user.id, action: \"suspend\" })}\n                            className=\"text-amber-400\"\n                          >\n                            <Ban size={16} className=\"mr-2\" />\n                            Suspend Account\n                          </DropdownMenuItem>\n                        ) : (\n                          <DropdownMenuItem \n                            onClick={() => actionMutation.mutate({ id: user.id, action: \"activate\" })}\n                            className=\"text-emerald-400\"\n                          >\n                            <Play size={16} className=\"mr-2\" />\n                            Activate Account\n                          </DropdownMenuItem>\n                        )}\n                        <DropdownMenuSeparator />\n                        <DropdownMenuItem \n                          onClick={() => {\n                            if (confirm(\"Are you sure you want to delete this user?\")) {\n                              deleteMutation.mutate(user.id);\n                            }\n                          }}\n                          className=\"text-destructive\"\n                        >\n                          Delete User\n                        </DropdownMenuItem>\n                      </DropdownMenuContent>\n                    </DropdownMenu>\n                  </div>\n                </GlassPanel>\n              </motion.div>\n            ))}\n          </AnimatePresence>\n        ) : (\n          <GlassPanel className=\"text-center py-12\">\n            <Users size={48} className=\"mx-auto mb-4 text-muted-foreground opacity-50\" />\n            <p className=\"text-muted-foreground mb-4\">\n              {searchQuery || filterAccountType !== \"all\" || filterStatus !== \"all\"\n                ? \"No customers match your search criteria\"\n                : \"No customers yet\"}\n            </p>\n            {!searchQuery && filterAccountType === \"all\" && filterStatus === \"all\" && (\n              <Button\n                className=\"gradient-btn\"\n                onClick={() => handleOpenDialog()}\n                data-testid=\"button-create-first-user\"\n              >\n                Add Your First User\n              </Button>\n            )}\n          </GlassPanel>\n        )}\n      </div>\n\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"glass-panel border-white/10 max-w-lg max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"text-xl font-bold text-white\">\n              {editingUser ? \"Edit Customer\" : \"Add New Customer\"}\n            </DialogTitle>\n          </DialogHeader>\n\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <GlassInput\n              label=\"Phone Number\"\n              placeholder=\"e.g., 254712345678\"\n              value={formData.phoneNumber}\n              onChange={(e) => setFormData({ ...formData, phoneNumber: e.target.value })}\n              required\n              icon={<Phone size={16} />}\n              data-testid=\"input-phone\"\n            />\n\n            <GlassInput\n              label=\"Full Name\"\n              placeholder=\"Customer name\"\n              value={formData.fullName || \"\"}\n              onChange={(e) => setFormData({ ...formData, fullName: e.target.value })}\n              icon={<UserCircle size={16} />}\n              data-testid=\"input-fullname\"\n            />\n\n            <GlassInput\n              label=\"Email\"\n              type=\"email\"\n              placeholder=\"customer@example.com\"\n              value={formData.email || \"\"}\n              onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n              icon={<Mail size={16} />}\n              data-testid=\"input-email\"\n            />\n\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium uppercase tracking-wider text-muted-foreground\">\n                Account Type\n              </label>\n              <div className=\"flex gap-2\">\n                {([\"HOTSPOT\", \"PPPOE\", \"STATIC\"] as const).map((type) => (\n                  <button\n                    key={type}\n                    type=\"button\"\n                    onClick={() => setFormData({ ...formData, accountType: type })}\n                    className={cn(\n                      \"flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all\",\n                      formData.accountType === type\n                        ? \"bg-cyan-500/20 text-cyan-400 border border-cyan-500/30\"\n                        : \"bg-white/5 text-muted-foreground border border-white/10 hover:bg-white/10\"\n                    )}\n                    data-testid={`button-account-type-${type}`}\n                  >\n                    {accountTypeLabels[type]}\n                  </button>\n                ))}\n              </div>\n            </div>\n\n            {(formData.accountType === \"PPPOE\" || formData.accountType === \"STATIC\") && (\n              <div className=\"grid grid-cols-2 gap-4\">\n                <GlassInput\n                  label=\"Username\"\n                  placeholder=\"PPPoE/Login username\"\n                  value={formData.username || \"\"}\n                  onChange={(e) => setFormData({ ...formData, username: e.target.value })}\n                  data-testid=\"input-username\"\n                />\n                <GlassInput\n                  label=\"Password\"\n                  type=\"password\"\n                  placeholder=\"Account password\"\n                  value={formData.password || \"\"}\n                  onChange={(e) => setFormData({ ...formData, password: e.target.value })}\n                  data-testid=\"input-password\"\n                />\n              </div>\n            )}\n\n            {formData.accountType === \"STATIC\" && (\n              <GlassInput\n                label=\"Static IP Address\"\n                placeholder=\"e.g., 192.168.1.100\"\n                value={formData.ipAddress || \"\"}\n                onChange={(e) => setFormData({ ...formData, ipAddress: e.target.value })}\n                data-testid=\"input-ip\"\n              />\n            )}\n\n            <GlassInput\n              label=\"MAC Address\"\n              placeholder=\"e.g., AA:BB:CC:DD:EE:FF\"\n              value={formData.macAddress || \"\"}\n              onChange={(e) => setFormData({ ...formData, macAddress: e.target.value })}\n              data-testid=\"input-mac\"\n            />\n\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium uppercase tracking-wider text-muted-foreground\">\n                Assigned Plan\n              </label>\n              <Select \n                value={formData.currentPlanId || \"\"} \n                onValueChange={(value) => setFormData({ ...formData, currentPlanId: value || undefined })}\n              >\n                <SelectTrigger className=\"bg-white/5 border-white/10\" data-testid=\"select-plan\">\n                  <SelectValue placeholder=\"Select a plan (optional)\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {plans?.map((plan) => (\n                    <SelectItem key={plan.id} value={plan.id}>\n                      {plan.name} - KES {plan.price}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium uppercase tracking-wider text-muted-foreground\">\n                Assigned Hotspot\n              </label>\n              <Select \n                value={formData.currentHotspotId || \"\"} \n                onValueChange={(value) => setFormData({ ...formData, currentHotspotId: value || undefined })}\n              >\n                <SelectTrigger className=\"bg-white/5 border-white/10\" data-testid=\"select-hotspot\">\n                  <SelectValue placeholder=\"Select a hotspot (optional)\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {hotspots?.map((hotspot) => (\n                    <SelectItem key={hotspot.id} value={hotspot.id}>\n                      {hotspot.locationName}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium uppercase tracking-wider text-muted-foreground\">\n                Assigned Technician\n              </label>\n              <Select \n                value={formData.technicianId || \"\"} \n                onValueChange={(value) => setFormData({ ...formData, technicianId: value || undefined })}\n              >\n                <SelectTrigger className=\"bg-white/5 border-white/10\" data-testid=\"select-technician\">\n                  <SelectValue placeholder=\"Select a technician (optional)\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {technicians?.map((tech) => (\n                    <SelectItem key={tech.id} value={tech.id}>\n                      {tech.username} {tech.email ? `(${tech.email})` : \"\"}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <GlassTextarea\n              label=\"Notes\"\n              placeholder=\"Additional notes about this user\"\n              value={formData.notes || \"\"}\n              onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n              data-testid=\"input-notes\"\n            />\n\n            <div className=\"flex gap-3 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                onClick={handleCloseDialog}\n                className=\"flex-1\"\n                data-testid=\"button-cancel\"\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                className=\"flex-1 gradient-btn\"\n                disabled={saveMutation.isPending}\n                data-testid=\"button-save-user\"\n              >\n                {saveMutation.isPending ? \"Saving...\" : editingUser ? \"Update User\" : \"Add User\"}\n              </Button>\n            </div>\n          </form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":27320,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\",\n        md: \".375rem\",\n        sm: \".1875rem\",\n        \"2xl\": \"1rem\",\n        \"3xl\": \"1.5rem\",\n      },\n      colors: {\n        // MnetiFi Glassmorphism Color System\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        \n        // Glass colors\n        glass: {\n          DEFAULT: \"rgba(255, 255, 255, 0.05)\",\n          surface: \"rgba(255, 255, 255, 0.05)\",\n          border: \"rgba(255, 255, 255, 0.1)\",\n          \"border-top\": \"rgba(255, 255, 255, 0.2)\",\n          \"border-bottom\": \"rgba(255, 255, 255, 0.05)\",\n          hover: \"rgba(255, 255, 255, 0.1)\",\n          active: \"rgba(255, 255, 255, 0.15)\",\n        },\n        \n        // Mesh gradient colors\n        mesh: {\n          navy: \"#0f172a\",\n          purple: \"#7c3aed\",\n          cyan: \"#06b6d4\",\n          magenta: \"#ec4899\",\n          blue: \"#3b82f6\",\n        },\n        \n        // M-Pesa brand color\n        mpesa: {\n          DEFAULT: \"#4BB617\",\n          dark: \"#3a9112\",\n          light: \"#5fd423\",\n        },\n        \n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n          pending: \"#7c3aed\",\n          completed: \"#06b6d4\",\n          failed: \"#ec4899\",\n        },\n      },\n      fontFamily: {\n        sans: [\"Inter\", \"Plus Jakarta Sans\", \"sans-serif\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      backdropBlur: {\n        glass: \"16px\",\n        \"glass-heavy\": \"24px\",\n      },\n      backgroundImage: {\n        \"gradient-radial\": \"radial-gradient(var(--tw-gradient-stops))\",\n        \"gradient-conic\": \"conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))\",\n        \"gradient-mesh\": \"linear-gradient(135deg, rgba(124, 58, 237, 0.3) 0%, rgba(6, 182, 212, 0.2) 50%, rgba(236, 72, 153, 0.3) 100%)\",\n        \"gradient-primary\": \"linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%)\",\n        \"gradient-accent\": \"linear-gradient(135deg, #7c3aed 0%, #ec4899 100%)\",\n        \"gradient-mpesa\": \"linear-gradient(135deg, #4BB617 0%, #5fd423 100%)\",\n      },\n      boxShadow: {\n        glass: \"0 4px 30px rgba(0, 0, 0, 0.1)\",\n        \"glass-lg\": \"0 8px 32px rgba(0, 0, 0, 0.15)\",\n        \"glass-xl\": \"0 16px 48px rgba(0, 0, 0, 0.2)\",\n        glow: \"0 0 20px rgba(6, 182, 212, 0.3)\",\n        \"glow-purple\": \"0 0 20px rgba(124, 58, 237, 0.3)\",\n        \"glow-magenta\": \"0 0 20px rgba(236, 72, 153, 0.3)\",\n        \"glow-mpesa\": \"0 0 20px rgba(75, 182, 23, 0.3)\",\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n        \"mesh-gradient\": {\n          \"0%, 100%\": {\n            backgroundPosition: \"0% 50%\",\n          },\n          \"50%\": {\n            backgroundPosition: \"100% 50%\",\n          },\n        },\n        \"float\": {\n          \"0%, 100%\": {\n            transform: \"translateY(0px)\",\n          },\n          \"50%\": {\n            transform: \"translateY(-10px)\",\n          },\n        },\n        \"pulse-glow\": {\n          \"0%, 100%\": {\n            boxShadow: \"0 0 20px rgba(124, 58, 237, 0.3)\",\n          },\n          \"50%\": {\n            boxShadow: \"0 0 40px rgba(124, 58, 237, 0.5)\",\n          },\n        },\n        \"gradient-shift\": {\n          \"0%\": {\n            backgroundPosition: \"0% 50%\",\n          },\n          \"50%\": {\n            backgroundPosition: \"100% 50%\",\n          },\n          \"100%\": {\n            backgroundPosition: \"0% 50%\",\n          },\n        },\n        \"spin-slow\": {\n          from: { transform: \"rotate(0deg)\" },\n          to: { transform: \"rotate(360deg)\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n        \"mesh-gradient\": \"mesh-gradient 15s ease infinite\",\n        \"float\": \"float 6s ease-in-out infinite\",\n        \"pulse-glow\": \"pulse-glow 2s ease-in-out infinite\",\n        \"gradient-shift\": \"gradient-shift 8s ease infinite\",\n        \"spin-slow\": \"spin-slow 20s linear infinite\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":7301,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/pages/dashboard.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { motion } from \"framer-motion\";\nimport { Link } from \"wouter\";\nimport {\n  DollarSign,\n  Users,\n  Wifi,\n  TrendingUp,\n  Receipt,\n  CheckCircle,\n  XCircle,\n  Clock,\n  AlertTriangle,\n  Ticket,\n  Phone,\n  Calendar,\n} from \"lucide-react\";\nimport { MetricCard, MetricCardSkeleton } from \"@/components/metric-card\";\nimport { TransactionList, TransactionListSkeleton } from \"@/components/transaction-list\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport type { Transaction, Plan, WifiUser } from \"@shared/schema\";\nimport { format, formatDistanceToNow } from \"date-fns\";\n\ninterface DashboardStats {\n  totalRevenue: number;\n  totalTransactions: number;\n  successfulTransactions: number;\n  pendingTransactions: number;\n  failedTransactions: number;\n  activeHotspots: number;\n  activeWifiUsers: number;\n  openTickets: number;\n  expiringUsers: WifiUser[];\n  recentTransactions: Transaction[];\n}\n\nexport default function Dashboard() {\n  // Fetch dashboard stats\n  const { data: stats, isLoading: statsLoading } = useQuery<DashboardStats>({\n    queryKey: [\"/api/dashboard/stats\"],\n  });\n\n  // Fetch plans for transaction display\n  const { data: plans } = useQuery<Plan[]>({\n    queryKey: [\"/api/plans\"],\n  });\n\n  const plansMap = new Map(plans?.map((p) => [p.id, p]) || []);\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat(\"en-KE\", {\n      style: \"currency\",\n      currency: \"KES\",\n      minimumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"dashboard-page\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">Dashboard</h1>\n          <p className=\"text-muted-foreground\">\n            Welcome back! Here's an overview of your hotspot network.\n          </p>\n        </div>\n      </div>\n\n      {/* Metrics Grid */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4\">\n        {statsLoading ? (\n          <>\n            <MetricCardSkeleton />\n            <MetricCardSkeleton />\n            <MetricCardSkeleton />\n            <MetricCardSkeleton />\n            <MetricCardSkeleton />\n            <MetricCardSkeleton />\n          </>\n        ) : (\n          <>\n            <MetricCard\n              title=\"Total Revenue\"\n              value={formatCurrency(stats?.totalRevenue || 0)}\n              icon={<DollarSign size={24} />}\n              trend={{ value: 12, label: \"vs last week\" }}\n              gradient=\"primary\"\n            />\n            <MetricCard\n              title=\"Active Users\"\n              value={stats?.activeWifiUsers || 0}\n              icon={<Users size={24} />}\n              gradient=\"accent\"\n            />\n            <MetricCard\n              title=\"Transactions\"\n              value={stats?.totalTransactions || 0}\n              subtitle=\"total\"\n              icon={<Receipt size={24} />}\n              trend={{ value: 8, label: \"vs last week\" }}\n            />\n            <MetricCard\n              title=\"Success Rate\"\n              value={\n                stats?.totalTransactions\n                  ? `${Math.round((stats.successfulTransactions / stats.totalTransactions) * 100)}%`\n                  : \"0%\"\n              }\n              icon={<TrendingUp size={24} />}\n            />\n            <MetricCard\n              title=\"Active Hotspots\"\n              value={stats?.activeHotspots || 0}\n              icon={<Wifi size={24} />}\n            />\n            <MetricCard\n              title=\"Open Tickets\"\n              value={stats?.openTickets || 0}\n              icon={<Ticket size={24} />}\n            />\n          </>\n        )}\n      </div>\n\n      {/* Transaction Status Summary */}\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n        <motion.div\n          className=\"flex items-center gap-4 p-4 rounded-xl bg-cyan-500/10 border border-cyan-500/20\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.1 }}\n        >\n          <div className=\"p-3 rounded-full bg-cyan-500/20\">\n            <CheckCircle size={24} className=\"text-cyan-400\" />\n          </div>\n          <div>\n            <p className=\"text-sm text-muted-foreground\">Successful</p>\n            <p className=\"text-2xl font-bold text-white\">\n              {stats?.successfulTransactions || 0}\n            </p>\n          </div>\n        </motion.div>\n\n        <motion.div\n          className=\"flex items-center gap-4 p-4 rounded-xl bg-purple-500/10 border border-purple-500/20\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.2 }}\n        >\n          <div className=\"p-3 rounded-full bg-purple-500/20\">\n            <Clock size={24} className=\"text-purple-400\" />\n          </div>\n          <div>\n            <p className=\"text-sm text-muted-foreground\">Pending</p>\n            <p className=\"text-2xl font-bold text-white\">\n              {stats?.pendingTransactions || 0}\n            </p>\n          </div>\n        </motion.div>\n\n        <motion.div\n          className=\"flex items-center gap-4 p-4 rounded-xl bg-pink-500/10 border border-pink-500/20\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.3 }}\n        >\n          <div className=\"p-3 rounded-full bg-pink-500/20\">\n            <XCircle size={24} className=\"text-pink-400\" />\n          </div>\n          <div>\n            <p className=\"text-sm text-muted-foreground\">Failed</p>\n            <p className=\"text-2xl font-bold text-white\">\n              {stats?.failedTransactions || 0}\n            </p>\n          </div>\n        </motion.div>\n      </div>\n\n      {/* Two-column grid for Transactions and Expiring Users */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Recent Transactions */}\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <h2 className=\"text-lg font-semibold text-white\">Recent Transactions</h2>\n            <Link\n              href=\"/dashboard/transactions\"\n              className=\"text-sm text-cyan-400 hover:text-cyan-300 transition-colors\"\n              data-testid=\"link-view-all-transactions\"\n            >\n              View All\n            </Link>\n          </div>\n\n          {statsLoading ? (\n            <TransactionListSkeleton count={5} />\n          ) : stats?.recentTransactions && stats.recentTransactions.length > 0 ? (\n            <TransactionList\n              transactions={stats.recentTransactions}\n              plans={plansMap}\n            />\n          ) : (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Receipt size={48} className=\"mx-auto mb-4 opacity-50\" />\n              <p>No transactions yet</p>\n            </div>\n          )}\n        </GlassPanel>\n\n        {/* Expiring Users Widget - Next 5-Day Expiry Report */}\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"p-2 rounded-lg bg-amber-500/20\">\n                <AlertTriangle size={18} className=\"text-amber-400\" />\n              </div>\n              <h2 className=\"text-lg font-semibold text-white\">Expiring Soon</h2>\n            </div>\n            <Link\n              href=\"/dashboard/wifi-users\"\n              className=\"text-sm text-cyan-400 hover:text-cyan-300 transition-colors\"\n              data-testid=\"link-view-all-users\"\n            >\n              View All Users\n            </Link>\n          </div>\n\n          {statsLoading ? (\n            <div className=\"space-y-3\">\n              {[1, 2, 3].map((i) => (\n                <div key={i} className=\"animate-pulse flex items-center gap-3 p-3 rounded-lg bg-white/5\">\n                  <div className=\"w-10 h-10 rounded-full bg-white/10\" />\n                  <div className=\"flex-1 space-y-2\">\n                    <div className=\"h-4 bg-white/10 rounded w-1/3\" />\n                    <div className=\"h-3 bg-white/10 rounded w-1/2\" />\n                  </div>\n                </div>\n              ))}\n            </div>\n          ) : stats?.expiringUsers && stats.expiringUsers.length > 0 ? (\n            <div className=\"space-y-3\">\n              {stats.expiringUsers.slice(0, 5).map((user) => {\n                const expiryDate = user.expiryTime ? new Date(user.expiryTime) : null;\n                const daysUntilExpiry = expiryDate \n                  ? Math.ceil((expiryDate.getTime() - Date.now()) / (1000 * 60 * 60 * 24))\n                  : 0;\n                const isUrgent = daysUntilExpiry <= 1;\n                const isWarning = daysUntilExpiry <= 3 && daysUntilExpiry > 1;\n\n                return (\n                  <motion.div\n                    key={user.id}\n                    initial={{ opacity: 0, x: -10 }}\n                    animate={{ opacity: 1, x: 0 }}\n                    className={`flex items-center gap-3 p-3 rounded-lg border transition-colors ${\n                      isUrgent \n                        ? \"bg-red-500/10 border-red-500/20\" \n                        : isWarning \n                          ? \"bg-amber-500/10 border-amber-500/20\"\n                          : \"bg-white/5 border-white/10\"\n                    }`}\n                    data-testid={`expiring-user-${user.id}`}\n                  >\n                    <div className={`w-10 h-10 rounded-full flex items-center justify-center ${\n                      isUrgent \n                        ? \"bg-red-500/20\" \n                        : isWarning \n                          ? \"bg-amber-500/20\"\n                          : \"bg-cyan-500/20\"\n                    }`}>\n                      <Phone size={18} className={\n                        isUrgent \n                          ? \"text-red-400\" \n                          : isWarning \n                            ? \"text-amber-400\"\n                            : \"text-cyan-400\"\n                      } />\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"font-medium text-white truncate\">\n                        {user.fullName || user.phoneNumber}\n                      </p>\n                      <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                        <Phone size={12} />\n                        <span>{user.phoneNumber}</span>\n                      </div>\n                    </div>\n                    <div className=\"text-right\">\n                      <Badge \n                        variant=\"outline\" \n                        className={`text-xs ${\n                          isUrgent \n                            ? \"bg-red-500/20 text-red-400 border-red-500/30\" \n                            : isWarning \n                              ? \"bg-amber-500/20 text-amber-400 border-amber-500/30\"\n                              : \"bg-cyan-500/20 text-cyan-400 border-cyan-500/30\"\n                        }`}\n                      >\n                        {daysUntilExpiry <= 0 ? \"Today\" : `${daysUntilExpiry}d left`}\n                      </Badge>\n                      {expiryDate && (\n                        <p className=\"text-xs text-muted-foreground mt-1\">\n                          {format(expiryDate, \"MMM d, HH:mm\")}\n                        </p>\n                      )}\n                    </div>\n                  </motion.div>\n                );\n              })}\n              {stats.expiringUsers.length > 5 && (\n                <p className=\"text-sm text-center text-muted-foreground pt-2\">\n                  +{stats.expiringUsers.length - 5} more users expiring soon\n                </p>\n              )}\n            </div>\n          ) : (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Calendar size={48} className=\"mx-auto mb-4 opacity-50\" />\n              <p>No users expiring in the next 5 days</p>\n              <p className=\"text-xs mt-1\">All accounts are in good standing</p>\n            </div>\n          )}\n        </GlassPanel>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":12335,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1592,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","path":null,"size_bytes":1904,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/pages/captive-portal.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Phone, Loader2, CheckCircle, XCircle, ArrowRight, Wifi, Ticket, CreditCard } from \"lucide-react\";\nimport { MeshBackground } from \"@/components/mesh-background\";\nimport { MnetiFiLogo, MpesaLogo } from \"@/components/mnetifi-logo\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { PhoneInput, GlassInput } from \"@/components/glass-input\";\nimport { PlanCard, PlanCardSkeleton } from \"@/components/plan-card\";\nimport { WalledGardenFooter } from \"@/components/walled-garden\";\nimport { Button } from \"@/components/ui/button\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Plan, WalledGarden, Transaction, Tenant } from \"@shared/schema\";\n\ntype PaymentStep = \"select-plan\" | \"enter-phone\" | \"enter-voucher\" | \"lookup-vouchers\" | \"processing\" | \"success\" | \"failed\" | \"voucher-success\";\n\ninterface BrandingConfig {\n  logo?: string;\n  primaryColor?: string;\n  secondaryColor?: string;\n  tagline?: string;\n  welcomeMessage?: string;\n  supportEmail?: string;\n  supportPhone?: string;\n  footerText?: string;\n  showPoweredBy?: boolean;\n  cardStyle?: 'glass' | 'solid' | 'gradient';\n  animationsEnabled?: boolean;\n  backgroundGradient?: string;\n}\n\ninterface VoucherRedemptionResult {\n  success: boolean;\n  message: string;\n  plan: {\n    name: string;\n    durationSeconds: number;\n  };\n  expiresAt: string;\n  credentials?: {\n    username: string;\n    password: string;\n  };\n  autoLoginUrl: string | null;\n  hotspotName: string | null;\n}\n\ninterface VoucherLookupResult {\n  id: string;\n  code: string;\n  planName: string | null;\n  status: string;\n  expiresAt: string | null;\n  usedAt: string | null;\n}\n\ninterface WiFiCredentials {\n  username: string;\n  password: string | null;\n  expiresAt: string | null;\n  planName: string;\n  planDuration: number | null;\n  autoLoginUrl: string | null;\n  hotspotName: string | null;\n}\n\nexport default function CaptivePortal() {\n  const { toast } = useToast();\n  const [step, setStep] = useState<PaymentStep>(\"select-plan\");\n  const [selectedPlan, setSelectedPlan] = useState<Plan | null>(null);\n  const [phoneNumber, setPhoneNumber] = useState(\"\");\n  const [voucherCode, setVoucherCode] = useState(\"\");\n  const [transaction, setTransaction] = useState<Transaction | null>(null);\n  const [voucherResult, setVoucherResult] = useState<VoucherRedemptionResult | null>(null);\n  const [lookupPhone, setLookupPhone] = useState(\"\");\n  const [lookedUpVouchers, setLookedUpVouchers] = useState<VoucherLookupResult[]>([]);\n  const [isLookingUp, setIsLookingUp] = useState(false);\n  const [credentials, setCredentials] = useState<WiFiCredentials | null>(null);\n  const [isLoadingCredentials, setIsLoadingCredentials] = useState(false);\n\n  const { data: tenant } = useQuery<Tenant>({\n    queryKey: [\"/api/portal/tenant\"],\n  });\n\n  const branding: BrandingConfig = useMemo(() => {\n    const config = tenant?.brandingConfig || {};\n    return {\n      logo: config.logo || \"\",\n      primaryColor: config.primaryColor || \"#22d3ee\",\n      secondaryColor: config.secondaryColor || \"#a855f7\",\n      tagline: config.tagline || \"\",\n      welcomeMessage: config.welcomeMessage || \"Connect to Wi-Fi\",\n      supportEmail: config.supportEmail || \"\",\n      supportPhone: config.supportPhone || \"\",\n      footerText: config.footerText || \"\",\n      showPoweredBy: config.showPoweredBy ?? true,\n      cardStyle: config.cardStyle || \"glass\",\n      animationsEnabled: config.animationsEnabled ?? true,\n      backgroundGradient: config.backgroundGradient || \"linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #0f172a 100%)\",\n    };\n  }, [tenant]);\n\n  const gradientStyle = useMemo(() => ({\n    background: `linear-gradient(135deg, ${branding.primaryColor}, ${branding.secondaryColor})`,\n  }), [branding]);\n\n  const { data: plans, isLoading: plansLoading } = useQuery<Plan[]>({\n    queryKey: [\"/api/plans\"],\n  });\n\n  const { data: walledGardens } = useQuery<WalledGarden[]>({\n    queryKey: [\"/api/walled-gardens\"],\n  });\n\n  const paymentMutation = useMutation({\n    mutationFn: async (data: { planId: string; phone: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/transactions/initiate\", data);\n      return await response.json() as Transaction;\n    },\n    onSuccess: (data) => {\n      setTransaction(data);\n      setStep(\"processing\");\n      pollTransactionStatus(data.id);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Payment Failed\",\n        description: error.message || \"Unable to initiate payment. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const voucherMutation = useMutation({\n    mutationFn: async (data: { code: string; phoneNumber: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/portal/redeem-voucher\", data);\n      return await response.json() as VoucherRedemptionResult;\n    },\n    onSuccess: (data) => {\n      setVoucherResult(data);\n      setStep(\"voucher-success\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Invalid Voucher\",\n        description: error.message || \"Unable to redeem voucher. Please check the code and try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const fetchCredentials = async (transactionId: string) => {\n    setIsLoadingCredentials(true);\n    try {\n      const response = await fetch(`/api/transactions/${transactionId}/credentials`);\n      if (response.ok) {\n        const creds = await response.json() as WiFiCredentials;\n        setCredentials(creds);\n      }\n    } catch (error) {\n      console.error(\"Failed to fetch credentials:\", error);\n    } finally {\n      setIsLoadingCredentials(false);\n    }\n  };\n\n  const pollTransactionStatus = async (transactionId: string) => {\n    const maxAttempts = 30;\n    let attempts = 0;\n\n    const poll = async () => {\n      if (attempts >= maxAttempts) {\n        setStep(\"failed\");\n        return;\n      }\n\n      try {\n        const response = await fetch(`/api/transactions/${transactionId}`);\n        const data = await response.json() as Transaction;\n\n        if (data.status === \"COMPLETED\") {\n          setTransaction(data);\n          setStep(\"success\");\n          queryClient.invalidateQueries({ queryKey: [\"/api/transactions\"] });\n          // Fetch WiFi credentials for auto-connect\n          await fetchCredentials(transactionId);\n          return;\n        } else if (data.status === \"FAILED\") {\n          setTransaction(data);\n          setStep(\"failed\");\n          return;\n        }\n\n        attempts++;\n        setTimeout(poll, 3000);\n      } catch {\n        attempts++;\n        setTimeout(poll, 3000);\n      }\n    };\n\n    poll();\n  };\n\n  const handlePlanSelect = (plan: Plan) => {\n    setSelectedPlan(plan);\n    setStep(\"enter-phone\");\n  };\n\n  const handlePhoneSubmit = () => {\n    if (!selectedPlan) return;\n\n    const cleanPhone = phoneNumber.replace(/\\D/g, \"\");\n    if (cleanPhone.length < 9) {\n      toast({\n        title: \"Invalid Phone Number\",\n        description: \"Please enter a valid phone number\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    let formattedPhone = cleanPhone;\n    if (cleanPhone.startsWith(\"0\")) {\n      formattedPhone = \"254\" + cleanPhone.slice(1);\n    } else if (!cleanPhone.startsWith(\"254\")) {\n      formattedPhone = \"254\" + cleanPhone;\n    }\n\n    paymentMutation.mutate({\n      planId: selectedPlan.id,\n      phone: formattedPhone,\n    });\n  };\n\n  const handleVoucherSubmit = () => {\n    const cleanPhone = phoneNumber.replace(/\\D/g, \"\");\n    if (cleanPhone.length < 9) {\n      toast({\n        title: \"Invalid Phone Number\",\n        description: \"Please enter a valid phone number\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    let formattedPhone = cleanPhone;\n    if (cleanPhone.startsWith(\"0\")) {\n      formattedPhone = \"254\" + cleanPhone.slice(1);\n    } else if (!cleanPhone.startsWith(\"254\")) {\n      formattedPhone = \"254\" + cleanPhone;\n    }\n\n    if (!voucherCode.trim()) {\n      toast({\n        title: \"Missing Voucher Code\",\n        description: \"Please enter a voucher code\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    voucherMutation.mutate({\n      code: voucherCode.trim().toUpperCase(),\n      phoneNumber: formattedPhone,\n    });\n  };\n\n  const handleLookupVouchers = async () => {\n    const cleanPhone = lookupPhone.replace(/\\D/g, \"\");\n    if (cleanPhone.length < 9) {\n      toast({\n        title: \"Invalid Phone Number\",\n        description: \"Please enter a valid phone number\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    let formattedPhone = cleanPhone;\n    if (cleanPhone.startsWith(\"0\")) {\n      formattedPhone = \"254\" + cleanPhone.slice(1);\n    } else if (!cleanPhone.startsWith(\"254\")) {\n      formattedPhone = \"254\" + cleanPhone;\n    }\n\n    setIsLookingUp(true);\n    try {\n      const response = await fetch(`/api/portal/vouchers?phone=${formattedPhone}`);\n      const data = await response.json() as VoucherLookupResult[];\n      setLookedUpVouchers(data);\n      if (data.length === 0) {\n        toast({\n          title: \"No Vouchers Found\",\n          description: \"No vouchers found for this phone number. You can purchase a plan or enter a voucher code.\",\n        });\n      }\n    } catch {\n      toast({\n        title: \"Lookup Failed\",\n        description: \"Unable to lookup vouchers. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLookingUp(false);\n    }\n  };\n\n  const handleRetry = () => {\n    setStep(\"select-plan\");\n    setSelectedPlan(null);\n    setPhoneNumber(\"\");\n    setVoucherCode(\"\");\n    setTransaction(null);\n    setVoucherResult(null);\n    setLookupPhone(\"\");\n    setLookedUpVouchers([]);\n  };\n\n  const formatPrice = (amount: number) => {\n    return new Intl.NumberFormat(\"en-KE\", {\n      style: \"currency\",\n      currency: \"KES\",\n      minimumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  const formatDuration = (seconds: number): string => {\n    if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes`;\n    if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours`;\n    return `${Math.floor(seconds / 86400)} days`;\n  };\n\n  const BrandedLogo = () => {\n    if (branding.logo) {\n      return (\n        <img\n          src={branding.logo}\n          alt={tenant?.name || \"Logo\"}\n          className=\"h-12 mx-auto object-contain\"\n          onError={(e) => {\n            e.currentTarget.style.display = 'none';\n          }}\n        />\n      );\n    }\n    \n    if (tenant?.name) {\n      return (\n        <div className=\"flex items-center justify-center gap-2\">\n          <div\n            className=\"w-10 h-10 rounded-xl flex items-center justify-center\"\n            style={{ backgroundColor: `${branding.primaryColor}20` }}\n          >\n            <Wifi size={24} style={{ color: branding.primaryColor }} />\n          </div>\n          <span\n            className=\"text-2xl font-bold\"\n            style={{\n              background: `linear-gradient(135deg, ${branding.primaryColor}, ${branding.secondaryColor})`,\n              WebkitBackgroundClip: 'text',\n              WebkitTextFillColor: 'transparent',\n            }}\n          >\n            {tenant.name}\n          </span>\n        </div>\n      );\n    }\n\n    return <MnetiFiLogo size=\"lg\" className=\"justify-center\" />;\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center p-4 relative overflow-hidden\">\n      <MeshBackground />\n\n      <motion.div\n        className=\"w-full max-w-md\"\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.5 }}\n      >\n        <GlassPanel size=\"lg\" className=\"relative\">\n          <div className=\"text-center mb-8\">\n            <BrandedLogo />\n            {branding.tagline && (\n              <p className=\"mt-1 text-muted-foreground text-xs\">{branding.tagline}</p>\n            )}\n            <p className=\"mt-2 text-muted-foreground text-sm\">\n              {branding.welcomeMessage || \"Connect to Wi-Fi\"}\n            </p>\n          </div>\n\n          <AnimatePresence mode=\"wait\">\n            {step === \"select-plan\" && (\n              <motion.div\n                key=\"select-plan\"\n                initial={{ opacity: 0, x: 20 }}\n                animate={{ opacity: 1, x: 0 }}\n                exit={{ opacity: 0, x: -20 }}\n              >\n                <div className=\"flex items-center justify-between gap-2 mb-4 flex-wrap\">\n                  <h2 className=\"text-lg font-semibold text-white\">\n                    Choose Your Plan\n                  </h2>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => {\n                      setSelectedPlan(null);\n                      setStep(\"enter-voucher\");\n                    }}\n                    className=\"gap-1\"\n                    data-testid=\"button-have-voucher\"\n                  >\n                    <Ticket size={16} />\n                    Have a Voucher?\n                  </Button>\n                </div>\n\n                {plansLoading ? (\n                  <div className=\"space-y-4\">\n                    <PlanCardSkeleton />\n                    <PlanCardSkeleton />\n                  </div>\n                ) : plans && plans.length > 0 ? (\n                  <div className=\"space-y-4\" data-testid=\"plan-list\">\n                    {plans.filter(p => p.isActive).map((plan) => (\n                      <PlanCard\n                        key={plan.id}\n                        plan={plan}\n                        onSelect={handlePlanSelect}\n                        showDetails={false}\n                        brandingColor={{ primary: branding.primaryColor, secondary: branding.secondaryColor }}\n                      />\n                    ))}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <p>No plans available</p>\n                  </div>\n                )}\n\n                <div className=\"text-center pt-4 border-t border-white/10 mt-4\">\n                  <p className=\"text-sm text-muted-foreground mb-2\">\n                    Already purchased?\n                  </p>\n                  <Button\n                    variant=\"ghost\"\n                    onClick={() => setStep(\"lookup-vouchers\")}\n                    className=\"text-sm\"\n                    style={{ color: branding.primaryColor }}\n                    data-testid=\"button-find-vouchers\"\n                  >\n                    <Phone size={16} className=\"mr-1\" />\n                    Find My Vouchers\n                  </Button>\n                </div>\n              </motion.div>\n            )}\n\n            {step === \"enter-phone\" && selectedPlan && (\n              <motion.div\n                key=\"enter-phone\"\n                initial={{ opacity: 0, x: 20 }}\n                animate={{ opacity: 1, x: 0 }}\n                exit={{ opacity: 0, x: -20 }}\n                className=\"space-y-6\"\n              >\n                <div className=\"p-4 rounded-xl bg-white/5 border border-white/10\">\n                  <div className=\"flex items-center justify-between gap-2\">\n                    <div>\n                      <span className=\"text-sm text-muted-foreground\">Selected Plan</span>\n                      <h3 className=\"text-lg font-semibold text-white\">{selectedPlan.name}</h3>\n                    </div>\n                    <span\n                      className=\"text-2xl font-bold\"\n                      style={{\n                        background: `linear-gradient(135deg, ${branding.primaryColor}, ${branding.secondaryColor})`,\n                        WebkitBackgroundClip: 'text',\n                        WebkitTextFillColor: 'transparent',\n                      }}\n                    >\n                      {formatPrice(selectedPlan.price)}\n                    </span>\n                  </div>\n                </div>\n\n                <div>\n                  <PhoneInput\n                    label=\"M-Pesa Phone Number\"\n                    value={phoneNumber}\n                    onChange={(e) => setPhoneNumber(e.target.value)}\n                    data-testid=\"input-phone\"\n                  />\n                  <p className=\"mt-2 text-xs text-muted-foreground\">\n                    You will receive an M-Pesa prompt on this number\n                  </p>\n                </div>\n\n                <div className=\"flex gap-3\">\n                  <Button\n                    variant=\"ghost\"\n                    onClick={() => setStep(\"select-plan\")}\n                    className=\"flex-1\"\n                    data-testid=\"button-back\"\n                  >\n                    Back\n                  </Button>\n                  <Button\n                    className=\"flex-1 mpesa-btn\"\n                    onClick={handlePhoneSubmit}\n                    disabled={paymentMutation.isPending}\n                    data-testid=\"button-pay\"\n                  >\n                    <MpesaLogo size={20} />\n                    <span className=\"ml-2\">Pay with M-Pesa</span>\n                  </Button>\n                </div>\n              </motion.div>\n            )}\n\n            {step === \"enter-voucher\" && (\n              <motion.div\n                key=\"enter-voucher\"\n                initial={{ opacity: 0, x: 20 }}\n                animate={{ opacity: 1, x: 0 }}\n                exit={{ opacity: 0, x: -20 }}\n                className=\"space-y-6\"\n              >\n                <div className=\"text-center\">\n                  <div\n                    className=\"w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center\"\n                    style={{ backgroundColor: `${branding.primaryColor}20` }}\n                  >\n                    <Ticket size={32} style={{ color: branding.primaryColor }} />\n                  </div>\n                  <h2 className=\"text-lg font-semibold text-white mb-1\">\n                    Redeem Voucher\n                  </h2>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Enter your voucher code to connect\n                  </p>\n                </div>\n\n                <div className=\"space-y-4\">\n                  <div>\n                    <label className=\"text-sm font-medium text-white mb-2 block\">Voucher Code</label>\n                    <GlassInput\n                      placeholder=\"Enter voucher code (e.g., WIFI-XXXXXXXX)\"\n                      value={voucherCode}\n                      onChange={(e) => setVoucherCode(e.target.value.toUpperCase())}\n                      className=\"text-center font-mono text-lg tracking-wider\"\n                      data-testid=\"input-voucher-code\"\n                    />\n                  </div>\n\n                  <div>\n                    <PhoneInput\n                      label=\"Your Phone Number\"\n                      value={phoneNumber}\n                      onChange={(e) => setPhoneNumber(e.target.value)}\n                      data-testid=\"input-voucher-phone\"\n                    />\n                    <p className=\"mt-2 text-xs text-muted-foreground\">\n                      This number will be linked to your account\n                    </p>\n                  </div>\n                </div>\n\n                <div className=\"flex gap-3\">\n                  <Button\n                    variant=\"ghost\"\n                    onClick={() => {\n                      setVoucherCode(\"\");\n                      setStep(\"select-plan\");\n                    }}\n                    className=\"flex-1\"\n                    data-testid=\"button-voucher-back\"\n                  >\n                    Back\n                  </Button>\n                  <Button\n                    className=\"flex-1\"\n                    style={gradientStyle}\n                    onClick={handleVoucherSubmit}\n                    disabled={voucherMutation.isPending}\n                    data-testid=\"button-redeem-voucher\"\n                  >\n                    {voucherMutation.isPending ? (\n                      <Loader2 size={18} className=\"animate-spin mr-2\" />\n                    ) : (\n                      <Ticket size={18} className=\"mr-2\" />\n                    )}\n                    Redeem Voucher\n                  </Button>\n                </div>\n\n                <div className=\"text-center pt-4 border-t border-white/10\">\n                  <p className=\"text-sm text-muted-foreground mb-2\">\n                    Don't have a voucher?\n                  </p>\n                  <Button\n                    variant=\"ghost\"\n                    onClick={() => setStep(\"select-plan\")}\n                    className=\"text-sm\"\n                    style={{ color: branding.primaryColor }}\n                    data-testid=\"button-buy-plan\"\n                  >\n                    <CreditCard size={16} className=\"mr-1\" />\n                    Buy a plan with M-Pesa\n                  </Button>\n                </div>\n              </motion.div>\n            )}\n\n            {step === \"lookup-vouchers\" && (\n              <motion.div\n                key=\"lookup-vouchers\"\n                initial={{ opacity: 0, x: 20 }}\n                animate={{ opacity: 1, x: 0 }}\n                exit={{ opacity: 0, x: -20 }}\n                className=\"space-y-6\"\n              >\n                <div className=\"text-center\">\n                  <div\n                    className=\"w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center\"\n                    style={{ backgroundColor: `${branding.primaryColor}20` }}\n                  >\n                    <Phone size={32} style={{ color: branding.primaryColor }} />\n                  </div>\n                  <h2 className=\"text-lg font-semibold text-white mb-1\">\n                    Find My Vouchers\n                  </h2>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Enter your phone number to find your existing vouchers\n                  </p>\n                </div>\n\n                <div>\n                  <PhoneInput\n                    label=\"Phone Number\"\n                    value={lookupPhone}\n                    onChange={(e) => setLookupPhone(e.target.value)}\n                    data-testid=\"input-lookup-phone\"\n                  />\n                </div>\n\n                <Button\n                  className=\"w-full\"\n                  style={gradientStyle}\n                  onClick={handleLookupVouchers}\n                  disabled={isLookingUp}\n                  data-testid=\"button-lookup\"\n                >\n                  {isLookingUp ? (\n                    <Loader2 size={18} className=\"animate-spin mr-2\" />\n                  ) : (\n                    <Phone size={18} className=\"mr-2\" />\n                  )}\n                  Find Vouchers\n                </Button>\n\n                {lookedUpVouchers.length > 0 && (\n                  <div className=\"space-y-3\">\n                    <h3 className=\"text-sm font-medium text-white\">Your Vouchers</h3>\n                    {lookedUpVouchers.map((v) => (\n                      <div\n                        key={v.id}\n                        className=\"p-3 rounded-xl bg-white/5 border border-white/10\"\n                      >\n                        <div className=\"flex items-center justify-between gap-2 mb-2\">\n                          <span className=\"font-mono text-sm text-white\">{v.code}</span>\n                          <span\n                            className={`text-xs px-2 py-0.5 rounded-full ${\n                              v.status === \"USED\"\n                                ? \"bg-green-500/20 text-green-400\"\n                                : v.status === \"EXPIRED\"\n                                ? \"bg-red-500/20 text-red-400\"\n                                : \"bg-yellow-500/20 text-yellow-400\"\n                            }`}\n                          >\n                            {v.status}\n                          </span>\n                        </div>\n                        <div className=\"text-xs text-muted-foreground space-y-1\">\n                          {v.planName && <p>Plan: {v.planName}</p>}\n                          {v.expiresAt && (\n                            <p>Expires: {new Date(v.expiresAt).toLocaleString()}</p>\n                          )}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                )}\n\n                <div className=\"flex gap-3\">\n                  <Button\n                    variant=\"ghost\"\n                    onClick={() => {\n                      setLookupPhone(\"\");\n                      setLookedUpVouchers([]);\n                      setStep(\"select-plan\");\n                    }}\n                    className=\"flex-1\"\n                    data-testid=\"button-lookup-back\"\n                  >\n                    Back\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => setStep(\"enter-voucher\")}\n                    className=\"flex-1\"\n                    data-testid=\"button-enter-code\"\n                  >\n                    <Ticket size={16} className=\"mr-1\" />\n                    Enter Code\n                  </Button>\n                </div>\n              </motion.div>\n            )}\n\n            {step === \"processing\" && (\n              <motion.div\n                key=\"processing\"\n                initial={{ opacity: 0, scale: 0.95 }}\n                animate={{ opacity: 1, scale: 1 }}\n                exit={{ opacity: 0, scale: 0.95 }}\n                className=\"text-center py-8\"\n              >\n                <motion.div\n                  animate={{ rotate: 360 }}\n                  transition={{ duration: 2, repeat: Infinity, ease: \"linear\" }}\n                  className=\"w-16 h-16 mx-auto mb-6 rounded-full flex items-center justify-center\"\n                  style={gradientStyle}\n                >\n                  <Loader2 size={32} className=\"text-white\" />\n                </motion.div>\n                <h3 className=\"text-xl font-semibold text-white mb-2\">\n                  Processing Payment\n                </h3>\n                <p className=\"text-muted-foreground\">\n                  Please check your phone for the M-Pesa prompt\n                </p>\n                <p className=\"text-sm text-muted-foreground mt-4\">\n                  Enter your PIN to complete the payment\n                </p>\n              </motion.div>\n            )}\n\n            {step === \"success\" && (\n              <motion.div\n                key=\"success\"\n                initial={{ opacity: 0, scale: 0.95 }}\n                animate={{ opacity: 1, scale: 1 }}\n                exit={{ opacity: 0, scale: 0.95 }}\n                className=\"text-center py-8\"\n              >\n                <motion.div\n                  initial={{ scale: 0 }}\n                  animate={{ scale: 1 }}\n                  transition={{ type: \"spring\", stiffness: 500, damping: 25 }}\n                  className=\"w-16 h-16 mx-auto mb-6 rounded-full flex items-center justify-center\"\n                  style={{ backgroundColor: `${branding.primaryColor}20` }}\n                >\n                  <CheckCircle size={40} style={{ color: branding.primaryColor }} />\n                </motion.div>\n                <h3 className=\"text-xl font-semibold text-white mb-2\">\n                  Payment Successful\n                </h3>\n                <p className=\"text-muted-foreground mb-4\">\n                  {credentials ? \"Your WiFi credentials are ready\" : \"You are now connected to the internet\"}\n                </p>\n\n                {isLoadingCredentials ? (\n                  <div className=\"flex items-center justify-center gap-2 text-muted-foreground\">\n                    <Loader2 size={16} className=\"animate-spin\" />\n                    <span>Loading credentials...</span>\n                  </div>\n                ) : credentials ? (\n                  <div className=\"p-4 rounded-xl bg-white/5 border border-white/10 mb-4 text-left\">\n                    <div className=\"space-y-3 text-sm\">\n                      <div className=\"flex justify-between gap-2\">\n                        <span className=\"text-muted-foreground\">Username:</span>\n                        <span className=\"font-mono font-medium text-white\" data-testid=\"text-username\">{credentials.username}</span>\n                      </div>\n                      {credentials.password && (\n                        <div className=\"flex justify-between gap-2\">\n                          <span className=\"text-muted-foreground\">Password:</span>\n                          <span className=\"font-mono font-medium text-white\" data-testid=\"text-password\">{credentials.password}</span>\n                        </div>\n                      )}\n                      <div className=\"flex justify-between gap-2\">\n                        <span className=\"text-muted-foreground\">Plan:</span>\n                        <span className=\"font-medium text-white\">{credentials.planName}</span>\n                      </div>\n                      {credentials.expiresAt && (\n                        <div className=\"flex justify-between gap-2\">\n                          <span className=\"text-muted-foreground\">Expires:</span>\n                          <span className=\"font-medium text-white\">\n                            {new Date(credentials.expiresAt).toLocaleString()}\n                          </span>\n                        </div>\n                      )}\n                      {credentials.hotspotName && (\n                        <div className=\"flex justify-between gap-2\">\n                          <span className=\"text-muted-foreground\">Hotspot:</span>\n                          <span className=\"font-medium text-white\">{credentials.hotspotName}</span>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                ) : null}\n\n                {transaction?.mpesaReceiptNumber && (\n                  <p className=\"text-xs text-muted-foreground font-mono mb-4\">\n                    Receipt: {transaction.mpesaReceiptNumber}\n                  </p>\n                )}\n\n                {credentials?.autoLoginUrl ? (\n                  <Button\n                    className=\"w-full\"\n                    style={gradientStyle}\n                    onClick={() => {\n                      window.location.href = credentials.autoLoginUrl!;\n                    }}\n                    data-testid=\"button-auto-connect\"\n                  >\n                    <Wifi size={16} className=\"mr-2\" />\n                    Connect Now\n                  </Button>\n                ) : (\n                  <Button\n                    className=\"w-full\"\n                    style={gradientStyle}\n                    data-testid=\"button-browse\"\n                  >\n                    Start Browsing\n                    <ArrowRight size={16} className=\"ml-2\" />\n                  </Button>\n                )}\n              </motion.div>\n            )}\n\n            {step === \"voucher-success\" && voucherResult && (\n              <motion.div\n                key=\"voucher-success\"\n                initial={{ opacity: 0, scale: 0.95 }}\n                animate={{ opacity: 1, scale: 1 }}\n                exit={{ opacity: 0, scale: 0.95 }}\n                className=\"text-center py-8\"\n              >\n                <motion.div\n                  initial={{ scale: 0 }}\n                  animate={{ scale: 1 }}\n                  transition={{ type: \"spring\", stiffness: 500, damping: 25 }}\n                  className=\"w-16 h-16 mx-auto mb-6 rounded-full flex items-center justify-center\"\n                  style={{ backgroundColor: `${branding.primaryColor}20` }}\n                >\n                  <CheckCircle size={40} style={{ color: branding.primaryColor }} />\n                </motion.div>\n                <h3 className=\"text-xl font-semibold text-white mb-2\">\n                  Voucher Redeemed\n                </h3>\n                <p className=\"text-muted-foreground mb-4\">\n                  {voucherResult.credentials ? \"Your WiFi credentials are ready\" : \"You are now connected to the internet\"}\n                </p>\n                <div className=\"p-4 rounded-xl bg-white/5 border border-white/10 mb-6 text-left\">\n                  <div className=\"space-y-3 text-sm\">\n                    {voucherResult.credentials && (\n                      <>\n                        <div className=\"flex justify-between gap-2\">\n                          <span className=\"text-muted-foreground\">Username:</span>\n                          <span className=\"font-mono font-medium text-white\" data-testid=\"text-voucher-username\">{voucherResult.credentials.username}</span>\n                        </div>\n                        <div className=\"flex justify-between gap-2\">\n                          <span className=\"text-muted-foreground\">Password:</span>\n                          <span className=\"font-mono font-medium text-white\" data-testid=\"text-voucher-password\">{voucherResult.credentials.password}</span>\n                        </div>\n                      </>\n                    )}\n                    <div className=\"flex justify-between gap-2\">\n                      <span className=\"text-muted-foreground\">Plan:</span>\n                      <span className=\"font-medium text-white\">{voucherResult.plan.name}</span>\n                    </div>\n                    <div className=\"flex justify-between gap-2\">\n                      <span className=\"text-muted-foreground\">Duration:</span>\n                      <span className=\"font-medium text-white\">{formatDuration(voucherResult.plan.durationSeconds)}</span>\n                    </div>\n                    <div className=\"flex justify-between gap-2\">\n                      <span className=\"text-muted-foreground\">Expires:</span>\n                      <span className=\"font-medium text-white\">\n                        {new Date(voucherResult.expiresAt).toLocaleString()}\n                      </span>\n                    </div>\n                    {voucherResult.hotspotName && (\n                      <div className=\"flex justify-between gap-2\">\n                        <span className=\"text-muted-foreground\">Hotspot:</span>\n                        <span className=\"font-medium text-white\">{voucherResult.hotspotName}</span>\n                      </div>\n                    )}\n                  </div>\n                </div>\n                {voucherResult.autoLoginUrl ? (\n                  <Button\n                    className=\"w-full\"\n                    style={gradientStyle}\n                    onClick={() => {\n                      window.location.href = voucherResult.autoLoginUrl!;\n                    }}\n                    data-testid=\"button-voucher-auto-connect\"\n                  >\n                    <Wifi size={16} className=\"mr-2\" />\n                    Connect Now\n                  </Button>\n                ) : (\n                  <Button\n                    className=\"w-full\"\n                    style={gradientStyle}\n                    data-testid=\"button-browse-voucher\"\n                  >\n                    Start Browsing\n                    <ArrowRight size={16} className=\"ml-2\" />\n                  </Button>\n                )}\n              </motion.div>\n            )}\n\n            {step === \"failed\" && (\n              <motion.div\n                key=\"failed\"\n                initial={{ opacity: 0, scale: 0.95 }}\n                animate={{ opacity: 1, scale: 1 }}\n                exit={{ opacity: 0, scale: 0.95 }}\n                className=\"text-center py-8\"\n              >\n                <motion.div\n                  initial={{ scale: 0 }}\n                  animate={{ scale: 1 }}\n                  transition={{ type: \"spring\", stiffness: 500, damping: 25 }}\n                  className=\"w-16 h-16 mx-auto mb-6 rounded-full bg-pink-500/20 flex items-center justify-center\"\n                >\n                  <XCircle size={40} className=\"text-pink-400\" />\n                </motion.div>\n                <h3 className=\"text-xl font-semibold text-white mb-2\">\n                  Payment Failed\n                </h3>\n                <p className=\"text-muted-foreground mb-6\">\n                  {transaction?.statusDescription || \"The payment could not be completed\"}\n                </p>\n                <Button\n                  onClick={handleRetry}\n                  style={gradientStyle}\n                  data-testid=\"button-retry\"\n                >\n                  Try Again\n                </Button>\n              </motion.div>\n            )}\n          </AnimatePresence>\n\n          {walledGardens && walledGardens.length > 0 && step === \"select-plan\" && (\n            <WalledGardenFooter domains={walledGardens} />\n          )}\n\n          {(branding.supportEmail || branding.supportPhone) && step === \"select-plan\" && (\n            <div className=\"mt-4 pt-4 border-t border-white/10 text-center\">\n              <p className=\"text-xs text-muted-foreground mb-1\">Need help?</p>\n              <div className=\"flex items-center justify-center gap-3 text-xs flex-wrap\">\n                {branding.supportEmail && (\n                  <a \n                    href={`mailto:${branding.supportEmail}`} \n                    className=\"text-white/60 hover:text-white transition-colors\"\n                  >\n                    {branding.supportEmail}\n                  </a>\n                )}\n                {branding.supportPhone && (\n                  <a \n                    href={`tel:${branding.supportPhone}`}\n                    className=\"text-white/60 hover:text-white transition-colors\"\n                  >\n                    {branding.supportPhone}\n                  </a>\n                )}\n              </div>\n            </div>\n          )}\n\n          {branding.footerText && step === \"select-plan\" && (\n            <p className=\"mt-4 text-center text-xs text-muted-foreground\">\n              {branding.footerText}\n            </p>\n          )}\n        </GlassPanel>\n\n        {branding.showPoweredBy && (\n          <p className=\"text-center mt-6 text-xs text-muted-foreground\">\n            Powered by <span className=\"gradient-text font-semibold\">MnetiFi</span>\n          </p>\n        )}\n      </motion.div>\n    </div>\n  );\n}\n","path":null,"size_bytes":38453,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport crypto from \"crypto\";\nimport bcrypt from \"bcryptjs\";\nimport { storage } from \"./storage\";\nimport { \n  insertPlanSchema, \n  insertHotspotSchema, \n  insertTransactionSchema,\n  insertWalledGardenSchema,\n  insertTenantSchema,\n  insertWifiUserSchema,\n  insertTicketSchema,\n  insertVoucherBatchSchema,\n  ReconciliationStatus,\n  TransactionStatus,\n  UserRole,\n  VoucherStatus,\n  type UserRoleValue,\n} from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { jobQueue } from \"./services/job-queue\";\nimport { paymentWorker } from \"./services/payment-worker\";\nimport { getSmsService } from \"./services/sms\";\nimport { MikrotikService, createMikrotikService } from \"./services/mikrotik\";\nimport { \n  requireAuth, \n  requireSuperAdmin, \n  requireAdmin, \n  requireTech,\n  requireTenantAccess,\n  requireAuthWithTenant,\n  getSessionTenantId,\n  type AuthenticatedRequest \n} from \"./middleware/rbac\";\n\n// Password hashing utility\nconst SALT_ROUNDS = 10;\nasync function hashPassword(password: string): Promise<string> {\n  return bcrypt.hash(password, SALT_ROUNDS);\n}\nasync function verifyPassword(password: string, hash: string): Promise<boolean> {\n  return bcrypt.compare(password, hash);\n}\n\n// Module-level default tenant ID for public/captive portal routes\n// This is used ONLY for unauthenticated routes that need a fallback tenant\n// Authenticated routes should ALWAYS use getSessionTenantId(req)\nlet defaultTenantId: string = \"\";\n\n// Helper function to generate MikroTik hotspot login page HTML\nfunction generateLoginPageHtml(config: any, tenant: any): string {\n  const {\n    logo = \"\",\n    title = \"Welcome\",\n    subtitle = \"\",\n    welcomeMessage = \"Connect to our WiFi network\",\n    termsAndConditions = \"\",\n    backgroundColor = \"#ffffff\",\n    primaryColor = \"#3b82f6\",\n    secondaryColor = \"#64748b\",\n    textColor = \"#1f2937\",\n    buttonColor = \"#3b82f6\",\n    buttonTextColor = \"#ffffff\",\n    fontFamily = \"Inter, system-ui, sans-serif\",\n    borderRadius = 8,\n    showPoweredBy = true,\n    customCss = \"\",\n    footerText = \"\",\n  } = config || {};\n\n  const tenantName = tenant?.name || \"MnetiFi WiFi\";\n\n  return `<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${title} - ${tenantName}</title>\n  <style>\n    * {\n      margin: 0;\n      padding: 0;\n      box-sizing: border-box;\n    }\n    body {\n      font-family: ${fontFamily};\n      background-color: ${backgroundColor};\n      color: ${textColor};\n      min-height: 100vh;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      padding: 20px;\n    }\n    .container {\n      width: 100%;\n      max-width: 400px;\n      background: white;\n      border-radius: ${borderRadius}px;\n      box-shadow: 0 10px 40px rgba(0,0,0,0.1);\n      padding: 40px 30px;\n      text-align: center;\n    }\n    .logo {\n      max-width: 150px;\n      max-height: 80px;\n      margin-bottom: 20px;\n    }\n    h1 {\n      color: ${primaryColor};\n      font-size: 24px;\n      margin-bottom: 8px;\n    }\n    .subtitle {\n      color: ${secondaryColor};\n      font-size: 14px;\n      margin-bottom: 20px;\n    }\n    .welcome {\n      color: ${textColor};\n      font-size: 16px;\n      margin-bottom: 30px;\n      line-height: 1.5;\n    }\n    .form-group {\n      margin-bottom: 16px;\n      text-align: left;\n    }\n    label {\n      display: block;\n      font-size: 14px;\n      font-weight: 500;\n      color: ${textColor};\n      margin-bottom: 6px;\n    }\n    input {\n      width: 100%;\n      padding: 12px 16px;\n      border: 1px solid #e2e8f0;\n      border-radius: ${borderRadius}px;\n      font-size: 16px;\n      transition: border-color 0.2s;\n    }\n    input:focus {\n      outline: none;\n      border-color: ${primaryColor};\n    }\n    .btn {\n      width: 100%;\n      padding: 14px;\n      background: ${buttonColor};\n      color: ${buttonTextColor};\n      border: none;\n      border-radius: ${borderRadius}px;\n      font-size: 16px;\n      font-weight: 600;\n      cursor: pointer;\n      transition: opacity 0.2s;\n    }\n    .btn:hover {\n      opacity: 0.9;\n    }\n    .terms {\n      font-size: 12px;\n      color: ${secondaryColor};\n      margin-top: 20px;\n      line-height: 1.5;\n    }\n    .terms a {\n      color: ${primaryColor};\n      text-decoration: none;\n    }\n    .powered-by {\n      font-size: 11px;\n      color: ${secondaryColor};\n      margin-top: 30px;\n    }\n    .powered-by a {\n      color: ${primaryColor};\n      text-decoration: none;\n    }\n    .footer {\n      font-size: 12px;\n      color: ${secondaryColor};\n      margin-top: 20px;\n    }\n    .error-message {\n      background: #fee2e2;\n      color: #b91c1c;\n      padding: 12px;\n      border-radius: ${borderRadius}px;\n      font-size: 14px;\n      margin-bottom: 16px;\n      display: none;\n    }\n    ${customCss}\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    ${logo ? `<img src=\"${logo}\" alt=\"Logo\" class=\"logo\">` : \"\"}\n    <h1>${title}</h1>\n    ${subtitle ? `<p class=\"subtitle\">${subtitle}</p>` : \"\"}\n    <p class=\"welcome\">${welcomeMessage}</p>\n    \n    <div class=\"error-message\" id=\"errorMsg\">\n      $(if error)<span>$(error)</span>$(endif)\n    </div>\n    \n    <form method=\"post\" action=\"$(link-login-only)\">\n      <input type=\"hidden\" name=\"dst\" value=\"$(link-orig)\">\n      <input type=\"hidden\" name=\"popup\" value=\"true\">\n      \n      <div class=\"form-group\">\n        <label for=\"username\">Phone Number / Username</label>\n        <input type=\"text\" id=\"username\" name=\"username\" placeholder=\"0712345678\" required>\n      </div>\n      \n      <div class=\"form-group\">\n        <label for=\"password\">Password / Voucher Code</label>\n        <input type=\"password\" id=\"password\" name=\"password\" placeholder=\"Enter password or voucher\" required>\n      </div>\n      \n      <button type=\"submit\" class=\"btn\">Connect to WiFi</button>\n    </form>\n    \n    ${termsAndConditions ? `<p class=\"terms\">${termsAndConditions}</p>` : \"\"}\n    ${footerText ? `<p class=\"footer\">${footerText}</p>` : \"\"}\n    ${showPoweredBy ? `<p class=\"powered-by\">Powered by <a href=\"https://mnetifi.com\" target=\"_blank\">MnetiFi</a></p>` : \"\"}\n  </div>\n  \n  <script>\n    // Show error message if present\n    var errorEl = document.getElementById('errorMsg');\n    if (errorEl.textContent.trim()) {\n      errorEl.style.display = 'block';\n    }\n  </script>\n</body>\n</html>`;\n}\n\n// Helper to get tenant ID from request context (for public routes)\n// Priority: 1. Query param tenantId, 2. Subdomain lookup, 3. Default demo tenant\nasync function getPublicTenantId(req: any): Promise<string> {\n  // Check query parameter first\n  if (req.query.tenantId && typeof req.query.tenantId === 'string') {\n    return req.query.tenantId;\n  }\n  \n  // Check subdomain from host header\n  const host = req.get('host') || '';\n  const subdomain = host.split('.')[0];\n  if (subdomain && subdomain !== 'www' && subdomain !== 'localhost' && subdomain !== 'mnetifi') {\n    const tenant = await storage.getTenantBySubdomain(subdomain);\n    if (tenant) {\n      return tenant.id;\n    }\n  }\n  \n  // Fall back to default tenant\n  return defaultTenantId;\n}\n\nexport async function registerRoutes(\n  httpServer: Server,\n  app: Express\n): Promise<Server> {\n  \n  // Health check endpoint for Render.com\n  app.get(\"/api/health\", (req, res) => {\n    res.status(200).json({ status: \"healthy\", timestamp: new Date().toISOString() });\n  });\n\n  // Initialize default tenant for demo purposes and set module-level variable\n  defaultTenantId = await initializeDefaultTenant();\n\n  // ============== AUTHENTICATION ROUTES ==============\n  \n  // Login attempt rate limiting settings\n  const MAX_FAILED_ATTEMPTS = 5;\n  const LOCKOUT_DURATION_MINUTES = 15;\n\n  app.post(\"/api/auth/login\", async (req, res) => {\n    try {\n      const { username, password } = req.body;\n      \n      if (!username || !password) {\n        return res.status(400).json({ error: \"Username and password are required\" });\n      }\n\n      // Get client IP and user agent for logging\n      const ipAddress = req.headers['x-forwarded-for'] as string || req.socket.remoteAddress || 'unknown';\n      const userAgent = req.headers['user-agent'] || 'unknown';\n\n      // Check for account lockout due to too many failed attempts\n      const failedAttempts = await storage.countFailedLoginAttempts(username, LOCKOUT_DURATION_MINUTES);\n      if (failedAttempts >= MAX_FAILED_ATTEMPTS) {\n        console.log(`[Auth] Account locked for ${username} - too many failed attempts (${failedAttempts})`);\n        return res.status(429).json({ \n          error: \"Account temporarily locked due to too many failed login attempts. Please try again later.\",\n          lockedUntil: new Date(Date.now() + LOCKOUT_DURATION_MINUTES * 60 * 1000).toISOString(),\n        });\n      }\n\n      const user = await storage.getUserByUsername(username);\n      \n      if (!user) {\n        // Record failed attempt for non-existent user (prevents user enumeration timing attacks)\n        await storage.recordLoginAttempt({\n          username,\n          ipAddress,\n          success: false,\n          userAgent,\n        });\n        return res.status(401).json({ error: \"Invalid username or password\" });\n      }\n\n      // Support both hashed and legacy plaintext passwords for backward compatibility\n      let passwordValid = false;\n      if (user.password.startsWith('$2a$') || user.password.startsWith('$2b$')) {\n        // Password is hashed\n        passwordValid = await verifyPassword(password, user.password);\n      } else {\n        // Legacy plaintext password - migrate to hashed on successful login\n        passwordValid = user.password === password;\n        if (passwordValid) {\n          const hashedPassword = await hashPassword(password);\n          await storage.updateUser(user.id, { password: hashedPassword });\n          console.log(`[Auth] Migrated password to bcrypt for user: ${username}`);\n        }\n      }\n\n      if (!passwordValid) {\n        // Record failed login attempt\n        await storage.recordLoginAttempt({\n          username,\n          ipAddress,\n          success: false,\n          userAgent,\n        });\n        const remainingAttempts = MAX_FAILED_ATTEMPTS - failedAttempts - 1;\n        console.log(`[Auth] Failed login for ${username} - ${remainingAttempts} attempts remaining`);\n        return res.status(401).json({ \n          error: \"Invalid username or password\",\n          remainingAttempts: remainingAttempts > 0 ? remainingAttempts : 0,\n        });\n      }\n\n      if (!user.isActive) {\n        return res.status(403).json({ error: \"Account is disabled\" });\n      }\n\n      // Record successful login attempt\n      await storage.recordLoginAttempt({\n        username,\n        ipAddress,\n        success: true,\n        userAgent,\n      });\n\n      // Check if 2FA is enabled\n      if (user.twoFactorEnabled) {\n        console.log(`[Auth] 2FA required for ${username} from ${ipAddress}`);\n        return res.json({\n          requiresTwoFactor: true,\n          userId: user.id,\n          message: \"Two-factor authentication required\",\n        });\n      }\n\n      // Fetch tenant data for subscription info\n      const tenant = user.tenantId ? await storage.getTenant(user.tenantId) : null;\n      const subscriptionTier = tenant?.subscriptionTier || \"BASIC\";\n      const trialExpiresAt = tenant?.trialExpiresAt ? tenant.trialExpiresAt.toISOString() : null;\n\n      req.session.user = {\n        id: user.id,\n        username: user.username,\n        role: user.role as UserRoleValue,\n        tenantId: user.tenantId,\n        email: user.email,\n      };\n      req.session.subscriptionTier = subscriptionTier;\n      req.session.trialExpiresAt = trialExpiresAt;\n\n      console.log(`[Auth] Successful login for ${username} from ${ipAddress}`);\n\n      res.json({\n        user: {\n          id: user.id,\n          username: user.username,\n          role: user.role,\n          email: user.email,\n          tenantId: user.tenantId,\n        },\n        subscriptionTier,\n        trialExpiresAt,\n      });\n    } catch (error) {\n      console.error(\"Error during login:\", error);\n      res.status(500).json({ error: \"Failed to authenticate\" });\n    }\n  });\n\n  app.get(\"/api/auth/me\", (req, res) => {\n    if (!req.session?.user) {\n      return res.status(401).json({ error: \"Not authenticated\" });\n    }\n    res.json({ \n      user: req.session.user,\n      subscriptionTier: req.session.subscriptionTier || \"BASIC\",\n      trialExpiresAt: req.session.trialExpiresAt || null,\n    });\n  });\n\n  app.post(\"/api/auth/logout\", async (req, res) => {\n    req.session.destroy((err) => {\n      if (err) {\n        console.error(\"Error destroying session:\", err);\n        return res.status(500).json({ error: \"Failed to logout\" });\n      }\n      res.json({ message: \"Logged out successfully\" });\n    });\n  });\n\n  // ============== TWO-FACTOR AUTHENTICATION ROUTES ==============\n  \n  // Generate 2FA secret and QR code\n  app.post(\"/api/auth/2fa/setup\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const userId = req.session?.user?.id;\n      if (!userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      if (user.twoFactorEnabled) {\n        return res.status(400).json({ error: \"2FA is already enabled\" });\n      }\n\n      // Generate TOTP secret\n      const { authenticator } = await import(\"otplib\");\n      const secret = authenticator.generateSecret();\n      \n      // Generate QR code URL\n      const qrcode = await import(\"qrcode\");\n      const otpAuthUrl = authenticator.keyuri(user.username, \"MnetiFi\", secret);\n      const qrCodeDataUrl = await qrcode.toDataURL(otpAuthUrl);\n\n      // Store secret temporarily (not enabled yet until verified)\n      await storage.updateUser(userId, { twoFactorSecret: secret });\n\n      res.json({\n        secret,\n        qrCode: qrCodeDataUrl,\n        message: \"Scan the QR code with your authenticator app, then verify with a code\",\n      });\n    } catch (error) {\n      console.error(\"Error setting up 2FA:\", error);\n      res.status(500).json({ error: \"Failed to set up 2FA\" });\n    }\n  });\n\n  // Verify and enable 2FA\n  app.post(\"/api/auth/2fa/verify\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const userId = req.session?.user?.id;\n      const { code } = req.body;\n\n      if (!userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      if (!code) {\n        return res.status(400).json({ error: \"Verification code is required\" });\n      }\n\n      const user = await storage.getUser(userId);\n      if (!user || !user.twoFactorSecret) {\n        return res.status(400).json({ error: \"2FA setup not initiated\" });\n      }\n\n      // Verify the TOTP code\n      const { authenticator } = await import(\"otplib\");\n      const isValid = authenticator.verify({ token: code, secret: user.twoFactorSecret });\n\n      if (!isValid) {\n        return res.status(400).json({ error: \"Invalid verification code\" });\n      }\n\n      // Enable 2FA\n      await storage.updateUser(userId, { twoFactorEnabled: true });\n\n      console.log(`[Auth] 2FA enabled for user ${user.username}`);\n      res.json({ success: true, message: \"2FA enabled successfully\" });\n    } catch (error) {\n      console.error(\"Error verifying 2FA:\", error);\n      res.status(500).json({ error: \"Failed to verify 2FA\" });\n    }\n  });\n\n  // Disable 2FA\n  app.post(\"/api/auth/2fa/disable\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const userId = req.session?.user?.id;\n      const { password, code } = req.body;\n\n      if (!userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      if (!user.twoFactorEnabled) {\n        return res.status(400).json({ error: \"2FA is not enabled\" });\n      }\n\n      // Verify password\n      const passwordValid = await verifyPassword(password, user.password);\n      if (!passwordValid) {\n        return res.status(401).json({ error: \"Invalid password\" });\n      }\n\n      // Verify the TOTP code\n      const { authenticator } = await import(\"otplib\");\n      const isValid = authenticator.verify({ token: code, secret: user.twoFactorSecret || \"\" });\n      if (!isValid) {\n        return res.status(400).json({ error: \"Invalid verification code\" });\n      }\n\n      // Disable 2FA\n      await storage.updateUser(userId, { twoFactorEnabled: false, twoFactorSecret: null });\n\n      console.log(`[Auth] 2FA disabled for user ${user.username}`);\n      res.json({ success: true, message: \"2FA disabled successfully\" });\n    } catch (error) {\n      console.error(\"Error disabling 2FA:\", error);\n      res.status(500).json({ error: \"Failed to disable 2FA\" });\n    }\n  });\n\n  // Check 2FA status\n  app.get(\"/api/auth/2fa/status\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const userId = req.session?.user?.id;\n      if (!userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      res.json({ enabled: user.twoFactorEnabled || false });\n    } catch (error) {\n      console.error(\"Error checking 2FA status:\", error);\n      res.status(500).json({ error: \"Failed to check 2FA status\" });\n    }\n  });\n\n  // Verify 2FA code during login\n  app.post(\"/api/auth/2fa/login-verify\", async (req, res) => {\n    try {\n      const { userId, code } = req.body;\n\n      if (!userId || !code) {\n        return res.status(400).json({ error: \"User ID and code are required\" });\n      }\n\n      const user = await storage.getUser(userId);\n      if (!user || !user.twoFactorEnabled || !user.twoFactorSecret) {\n        return res.status(400).json({ error: \"Invalid request\" });\n      }\n\n      // Verify the TOTP code\n      const { authenticator } = await import(\"otplib\");\n      const isValid = authenticator.verify({ token: code, secret: user.twoFactorSecret });\n\n      if (!isValid) {\n        return res.status(401).json({ error: \"Invalid verification code\" });\n      }\n\n      // Fetch tenant data for subscription info\n      const tenant = user.tenantId ? await storage.getTenant(user.tenantId) : null;\n      const subscriptionTier = tenant?.subscriptionTier || \"BASIC\";\n      const trialExpiresAt = tenant?.trialExpiresAt ? tenant.trialExpiresAt.toISOString() : null;\n\n      // Create session with subscription data\n      req.session.user = {\n        id: user.id,\n        username: user.username,\n        role: user.role as UserRoleValue,\n        tenantId: user.tenantId,\n        email: user.email,\n      };\n      req.session.subscriptionTier = subscriptionTier;\n      req.session.trialExpiresAt = trialExpiresAt;\n\n      console.log(`[Auth] 2FA login verified for ${user.username}`);\n      res.json({\n        success: true,\n        user: {\n          id: user.id,\n          username: user.username,\n          role: user.role,\n          email: user.email,\n          tenantId: user.tenantId,\n        },\n        subscriptionTier,\n        trialExpiresAt,\n      });\n    } catch (error) {\n      console.error(\"Error verifying 2FA login:\", error);\n      res.status(500).json({ error: \"Failed to verify 2FA\" });\n    }\n  });\n\n  // Registration endpoint for new ISPs\n  app.post(\"/api/auth/register\", async (req, res) => {\n    try {\n      const { businessName, subdomain, username, email, password, subscriptionTier, paymentMethod, phoneNumber } = req.body;\n      \n      if (!businessName || !subdomain || !username || !email || !password) {\n        return res.status(400).json({ error: \"All fields are required\" });\n      }\n\n      // Validate subscription tier\n      const tier = subscriptionTier || \"BASIC\";\n      if (![\"BASIC\", \"PREMIUM\"].includes(tier)) {\n        return res.status(400).json({ error: \"Invalid subscription tier\" });\n      }\n\n      // Payment method only required for PREMIUM tier\n      if (tier === \"PREMIUM\" && (!paymentMethod || ![\"MPESA\", \"BANK\", \"PAYPAL\"].includes(paymentMethod))) {\n        return res.status(400).json({ error: \"Valid payment method is required for premium tier\" });\n      }\n\n      // Validate password strength on server side\n      const hasMinLength = password.length >= 8;\n      const hasUppercase = /[A-Z]/.test(password);\n      const hasLowercase = /[a-z]/.test(password);\n      const hasNumber = /[0-9]/.test(password);\n      const hasSpecial = /[!@#$%^&*(),.?\":{}|<>]/.test(password);\n      \n      if (!hasMinLength || !hasUppercase || !hasLowercase || !hasNumber || !hasSpecial) {\n        return res.status(400).json({ \n          error: \"Password must be at least 8 characters and include uppercase, lowercase, number, and special character\" \n        });\n      }\n\n      // Check if subdomain already exists\n      const existingTenant = await storage.getTenantBySubdomain(subdomain);\n      if (existingTenant) {\n        return res.status(409).json({ error: \"Subdomain already taken\" });\n      }\n\n      // Check if username already exists\n      const existingUser = await storage.getUserByUsername(username);\n      if (existingUser) {\n        return res.status(409).json({ error: \"Username already taken\" });\n      }\n\n      // Check if email already exists\n      const existingEmail = await storage.getUserByEmail(email);\n      if (existingEmail) {\n        return res.status(409).json({ error: \"Email already registered\" });\n      }\n\n      // Calculate trial expiration (24 hours from now) for BASIC tier\n      const trialExpiresAt = tier === \"BASIC\" ? new Date(Date.now() + 24 * 60 * 60 * 1000) : null;\n\n      // Determine payment status based on method (only for PREMIUM)\n      let registrationPaymentStatus = tier === \"BASIC\" ? \"NOT_REQUIRED\" : \"PENDING\";\n      if (tier === \"PREMIUM\") {\n        if (paymentMethod === \"MPESA\") {\n          registrationPaymentStatus = \"PENDING\"; // Will be updated after STK push\n        } else if (paymentMethod === \"BANK\") {\n          registrationPaymentStatus = \"AWAITING_CONFIRMATION\"; // Manual verification needed\n        } else if (paymentMethod === \"PAYPAL\") {\n          registrationPaymentStatus = \"PENDING\"; // Will redirect to PayPal\n        }\n      }\n\n      // Create the tenant (ISP)\n      const tenant = await storage.createTenant({\n        name: businessName,\n        subdomain: subdomain.toLowerCase(),\n        subscriptionTier: tier,\n        saasBillingStatus: tier === \"BASIC\" ? \"TRIAL\" : \"PENDING\",\n        trialExpiresAt: trialExpiresAt,\n        isActive: true,\n        registrationPaymentMethod: tier === \"PREMIUM\" ? paymentMethod : null,\n        registrationPaymentStatus: registrationPaymentStatus,\n      });\n\n      // Hash password and create the admin user for this tenant\n      const hashedPassword = await hashPassword(password);\n      \n      // For BASIC tier: Skip email verification, auto-activate and allow immediate login\n      // For PREMIUM tier: Require email verification first\n      const isBasicTier = tier === \"BASIC\";\n      \n      const user = await storage.createUser({\n        tenantId: tenant.id,\n        username,\n        password: hashedPassword,\n        email,\n        role: \"admin\",\n        isActive: isBasicTier, // BASIC tier is immediately active\n      });\n\n      if (isBasicTier) {\n        // For BASIC tier: Mark email as verified and return user for auto-login\n        await storage.updateUser(user.id, {\n          emailVerified: true,\n        });\n        \n        console.log(`[Registration] BASIC tier account created for ${username} - trial expires at ${trialExpiresAt}`);\n        \n        return res.status(201).json({\n          message: \"Welcome to MnetiFi! Your 24-hour free trial has started.\",\n          tenant: {\n            id: tenant.id,\n            name: tenant.name,\n            subdomain: tenant.subdomain,\n          },\n          user: {\n            id: user.id,\n            username: user.username,\n            email: user.email,\n            role: user.role,\n            tenantId: tenant.id,\n          },\n          subscriptionTier: tier,\n          trialExpiresAt: trialExpiresAt,\n        });\n      }\n\n      // For PREMIUM tier: Generate email verification token\n      const emailVerificationToken = crypto.randomUUID();\n      const emailVerificationExpiry = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 hours\n\n      // Update user with email verification token\n      await storage.updateUser(user.id, {\n        emailVerificationToken,\n        emailVerificationExpiry,\n        emailVerified: false,\n      });\n\n      // Log verification link (in production, send via email)\n      const verificationLink = `/verify-email?token=${emailVerificationToken}`;\n      console.log(`[Registration] PREMIUM tier - Email verification required for ${email}`);\n      console.log(`[Registration] Verification token: ${emailVerificationToken}`);\n      console.log(`[Registration] Verification link: ${verificationLink}`);\n\n      let responseMessage = \"Account created! Please check your email to verify your account.\";\n      let additionalInfo: Record<string, unknown> = {\n        requiresEmailVerification: true,\n        verificationEmailSentTo: email,\n      };\n\n      if (paymentMethod === \"MPESA\" && phoneNumber) {\n        responseMessage = \"Account created! Please verify your email, then check your phone for M-Pesa payment prompt.\";\n        console.log(`[Registration] M-Pesa STK push to be sent to ${phoneNumber} for tenant ${tenant.id} after verification`);\n      } else if (paymentMethod === \"BANK\") {\n        responseMessage = \"Account created! Please verify your email, then complete bank transfer to activate.\";\n        additionalInfo = {\n          ...additionalInfo,\n          bankDetails: {\n            bank: \"Kenya Commercial Bank\",\n            accountNumber: \"1234567890\",\n            accountName: \"MnetiFi Ltd\",\n            branch: \"Nairobi\",\n            reference: tenant.id,\n          },\n        };\n      } else if (paymentMethod === \"PAYPAL\") {\n        responseMessage = \"Account created! Please verify your email, then you will be redirected to PayPal.\";\n        additionalInfo = {\n          ...additionalInfo,\n          paypalRedirect: `https://www.paypal.com/checkoutnow?token=${tenant.id}`,\n        };\n      }\n\n      res.status(201).json({\n        message: responseMessage,\n        tenant: {\n          id: tenant.id,\n          name: tenant.name,\n          subdomain: tenant.subdomain,\n        },\n        user: {\n          id: user.id,\n          username: user.username,\n          email: user.email,\n          emailVerified: false,\n        },\n        subscriptionTier: tier,\n        paymentMethod,\n        ...additionalInfo,\n      });\n    } catch (error) {\n      console.error(\"Error during registration:\", error);\n      res.status(500).json({ error: \"Failed to create account\" });\n    }\n  });\n\n  // Email verification endpoint\n  app.post(\"/api/auth/verify-email\", async (req, res) => {\n    try {\n      const { token } = req.body;\n      \n      if (!token) {\n        return res.status(400).json({ error: \"Verification token is required\" });\n      }\n\n      const user = await storage.getUserByEmailVerificationToken(token);\n      \n      if (!user) {\n        return res.status(400).json({ error: \"Invalid or expired verification token\" });\n      }\n\n      if (user.emailVerificationExpiry && new Date(user.emailVerificationExpiry) < new Date()) {\n        return res.status(400).json({ error: \"Verification token has expired. Please request a new one.\" });\n      }\n\n      if (user.emailVerified) {\n        return res.status(400).json({ error: \"Email is already verified\" });\n      }\n\n      // Activate the user account and mark email as verified\n      await storage.updateUser(user.id, {\n        emailVerified: true,\n        isActive: true,\n        emailVerificationToken: null,\n        emailVerificationExpiry: null,\n      });\n\n      console.log(`[Auth] Email verified for user: ${user.username}`);\n\n      res.json({ \n        message: \"Email verified successfully! You can now log in.\",\n        verified: true,\n      });\n    } catch (error) {\n      console.error(\"Error during email verification:\", error);\n      res.status(500).json({ error: \"Failed to verify email\" });\n    }\n  });\n\n  // Resend verification email endpoint\n  app.post(\"/api/auth/resend-verification\", async (req, res) => {\n    try {\n      const { email } = req.body;\n      \n      if (!email) {\n        return res.status(400).json({ error: \"Email is required\" });\n      }\n\n      const user = await storage.getUserByEmail(email);\n      \n      // Always return success to prevent email enumeration\n      if (!user) {\n        return res.json({ message: \"If the email exists, a new verification link has been sent\" });\n      }\n\n      if (user.emailVerified) {\n        return res.status(400).json({ error: \"Email is already verified\" });\n      }\n\n      // Generate new verification token\n      const emailVerificationToken = crypto.randomUUID();\n      const emailVerificationExpiry = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 hours\n\n      await storage.updateUser(user.id, {\n        emailVerificationToken,\n        emailVerificationExpiry,\n      });\n\n      // Log verification link (in production, send via email)\n      const verificationLink = `/verify-email?token=${emailVerificationToken}`;\n      console.log(`[Auth] Resending verification email for ${email}`);\n      console.log(`[Auth] New verification token: ${emailVerificationToken}`);\n      console.log(`[Auth] Verification link: ${verificationLink}`);\n\n      res.json({ message: \"If the email exists, a new verification link has been sent\" });\n    } catch (error) {\n      console.error(\"Error resending verification email:\", error);\n      res.status(500).json({ error: \"Failed to resend verification email\" });\n    }\n  });\n\n  // Forgot password endpoint\n  app.post(\"/api/auth/forgot-password\", async (req, res) => {\n    try {\n      const { email } = req.body;\n      \n      if (!email) {\n        return res.status(400).json({ error: \"Email is required\" });\n      }\n\n      const user = await storage.getUserByEmail(email);\n      \n      // Always return success to prevent email enumeration\n      if (!user) {\n        return res.json({ message: \"If the email exists, a reset link has been sent\" });\n      }\n\n      // Generate a reset token\n      const resetToken = crypto.randomUUID();\n      const resetTokenExpiry = new Date(Date.now() + 60 * 60 * 1000); // 1 hour\n\n      await storage.updateUser(user.id, {\n        resetToken,\n        resetTokenExpiry,\n      });\n\n      // In production, send an email with the reset link\n      // For now, just log it\n      console.log(`[Auth] Password reset requested for ${email}`);\n      console.log(`[Auth] Reset token: ${resetToken}`);\n      console.log(`[Auth] Reset link: /reset-password?token=${resetToken}`);\n\n      res.json({ message: \"If the email exists, a reset link has been sent\" });\n    } catch (error) {\n      console.error(\"Error during password reset request:\", error);\n      res.status(500).json({ error: \"Failed to process request\" });\n    }\n  });\n\n  // Reset password endpoint\n  app.post(\"/api/auth/reset-password\", async (req, res) => {\n    try {\n      const { token, newPassword } = req.body;\n      \n      if (!token || !newPassword) {\n        return res.status(400).json({ error: \"Token and new password are required\" });\n      }\n\n      const user = await storage.getUserByResetToken(token);\n      \n      if (!user) {\n        return res.status(400).json({ error: \"Invalid or expired reset token\" });\n      }\n\n      if (user.resetTokenExpiry && new Date(user.resetTokenExpiry) < new Date()) {\n        return res.status(400).json({ error: \"Reset token has expired\" });\n      }\n\n      // Hash the new password and update user, clear reset token\n      const hashedNewPassword = await hashPassword(newPassword);\n      await storage.updateUser(user.id, {\n        password: hashedNewPassword,\n        resetToken: null,\n        resetTokenExpiry: null,\n      });\n\n      res.json({ message: \"Password has been reset successfully\" });\n    } catch (error) {\n      console.error(\"Error during password reset:\", error);\n      res.status(500).json({ error: \"Failed to reset password\" });\n    }\n  });\n\n  // Super Admin Registration endpoint (requires setup key from environment)\n  app.post(\"/api/auth/register-superadmin\", async (req, res) => {\n    try {\n      const { username, email, password, setupKey } = req.body;\n      \n      if (!username || !email || !password || !setupKey) {\n        return res.status(400).json({ error: \"All fields are required\" });\n      }\n\n      // Verify setup key from environment - fail if not configured\n      const SUPERADMIN_SETUP_KEY = process.env.SUPERADMIN_SETUP_KEY;\n      if (!SUPERADMIN_SETUP_KEY) {\n        console.error(\"[Auth] SUPERADMIN_SETUP_KEY environment variable is not configured\");\n        return res.status(503).json({ error: \"Super admin registration is not configured on this server\" });\n      }\n\n      if (setupKey !== SUPERADMIN_SETUP_KEY) {\n        return res.status(403).json({ error: \"Invalid setup key\" });\n      }\n\n      // Validate password strength on server side\n      const hasMinLength = password.length >= 8;\n      const hasUppercase = /[A-Z]/.test(password);\n      const hasLowercase = /[a-z]/.test(password);\n      const hasNumber = /[0-9]/.test(password);\n      const hasSpecial = /[!@#$%^&*(),.?\":{}|<>]/.test(password);\n      \n      if (!hasMinLength || !hasUppercase || !hasLowercase || !hasNumber || !hasSpecial) {\n        return res.status(400).json({ \n          error: \"Password must be at least 8 characters and include uppercase, lowercase, number, and special character\" \n        });\n      }\n\n      // Check if username already exists\n      const existingUser = await storage.getUserByUsername(username);\n      if (existingUser) {\n        return res.status(409).json({ error: \"Username already taken\" });\n      }\n\n      // Check if email already exists\n      const existingEmail = await storage.getUserByEmail(email);\n      if (existingEmail) {\n        return res.status(409).json({ error: \"Email already registered\" });\n      }\n\n      // Hash password and create the super admin user\n      const hashedPassword = await hashPassword(password);\n      const user = await storage.createUser({\n        username,\n        password: hashedPassword,\n        email,\n        role: \"superadmin\",\n        isActive: true,\n      });\n\n      console.log(`[Auth] Super admin created: ${username}`);\n\n      res.status(201).json({\n        message: \"Super admin account created successfully\",\n        user: {\n          id: user.id,\n          username: user.username,\n          email: user.email,\n          role: user.role,\n        },\n      });\n    } catch (error) {\n      console.error(\"Error during super admin registration:\", error);\n      res.status(500).json({ error: \"Failed to create super admin account\" });\n    }\n  });\n\n  // Start the payment worker for background job processing\n  paymentWorker.start();\n  console.log(\"[Server] Payment worker started\");\n\n  // ============== TENANT ROUTES ==============\n  \n  app.get(\"/api/tenant\", requireAuthWithTenant, async (req, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const tenant = await storage.getTenant(tenantId);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n      res.json(tenant);\n    } catch (error) {\n      console.error(\"Error fetching tenant:\", error);\n      res.status(500).json({ error: \"Failed to fetch tenant\" });\n    }\n  });\n\n  app.patch(\"/api/tenant\", requireAuthWithTenant, requireAdmin, async (req, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const tenant = await storage.updateTenant(tenantId, req.body);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n      res.json(tenant);\n    } catch (error) {\n      console.error(\"Error updating tenant:\", error);\n      res.status(500).json({ error: \"Failed to update tenant\" });\n    }\n  });\n\n  // ============== OTP VERIFICATION FOR SETTINGS ==============\n  \n  // In-memory OTP storage with 5-minute expiry\n  const otpStore = new Map<string, { otp: string; expiresAt: number; tenantId: string }>();\n  const otpTokenStore = new Map<string, { tenantId: string; expiresAt: number }>();\n\n  // Clean up expired OTPs periodically\n  setInterval(() => {\n    const now = Date.now();\n    for (const [key, value] of otpStore.entries()) {\n      if (value.expiresAt < now) {\n        otpStore.delete(key);\n      }\n    }\n    for (const [key, value] of otpTokenStore.entries()) {\n      if (value.expiresAt < now) {\n        otpTokenStore.delete(key);\n      }\n    }\n  }, 60000); // Clean up every minute\n\n  // Send OTP to admin phone\n  app.post(\"/api/settings/otp/send\", requireAuthWithTenant, requireAdmin, async (req, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n\n      const tenant = await storage.getTenant(tenantId);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n\n      // Get admin phone from tenant\n      const adminPhone = tenant.phone;\n      if (!adminPhone) {\n        return res.status(400).json({ error: \"Admin phone number not configured. Please update your profile first.\" });\n      }\n\n      // Generate 6-digit OTP\n      const otp = Math.floor(100000 + Math.random() * 900000).toString();\n      const expiresAt = Date.now() + 5 * 60 * 1000; // 5 minutes\n\n      // Store OTP\n      const storeKey = `${tenantId}_settings`;\n      otpStore.set(storeKey, { otp, expiresAt, tenantId });\n\n      // Send OTP via SMS using platform SMS service\n      const smsService = getSmsService();\n      const result = await smsService.sendIspOtp(adminPhone, otp, tenant.name || \"Your ISP\");\n      \n      if (!result.success) {\n        console.error(\"[OTP] Failed to send OTP:\", result.error);\n        return res.status(500).json({ error: \"Failed to send OTP. Please try again.\" });\n      }\n\n      console.log(`[OTP] Sent to ${adminPhone.substring(0, 6)}*** for tenant ${tenantId}`);\n\n      res.json({ \n        success: true, \n        message: \"OTP sent successfully\",\n        phoneHint: adminPhone.substring(0, 6) + \"****\" + adminPhone.substring(adminPhone.length - 2)\n      });\n    } catch (error) {\n      console.error(\"Error sending OTP:\", error);\n      res.status(500).json({ error: \"Failed to send OTP\" });\n    }\n  });\n\n  // Verify OTP and return temporary token\n  app.post(\"/api/settings/otp/verify\", requireAuthWithTenant, requireAdmin, async (req, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n\n      const { otp } = req.body;\n      if (!otp || typeof otp !== \"string\") {\n        return res.status(400).json({ error: \"OTP is required\" });\n      }\n\n      const storeKey = `${tenantId}_settings`;\n      const stored = otpStore.get(storeKey);\n\n      if (!stored) {\n        return res.status(400).json({ error: \"No OTP found. Please request a new one.\" });\n      }\n\n      if (stored.expiresAt < Date.now()) {\n        otpStore.delete(storeKey);\n        return res.status(400).json({ error: \"OTP has expired. Please request a new one.\" });\n      }\n\n      if (stored.otp !== otp) {\n        return res.status(400).json({ error: \"Invalid OTP. Please check and try again.\" });\n      }\n\n      // OTP verified, remove it and create a temporary token\n      otpStore.delete(storeKey);\n\n      const token = crypto.randomBytes(32).toString(\"hex\");\n      const tokenExpiry = Date.now() + 15 * 60 * 1000; // 15 minutes\n\n      otpTokenStore.set(token, { tenantId, expiresAt: tokenExpiry });\n\n      console.log(`[OTP] Verified successfully for tenant ${tenantId}`);\n\n      res.json({ \n        success: true, \n        token,\n        message: \"OTP verified. You can now edit payment settings.\" \n      });\n    } catch (error) {\n      console.error(\"Error verifying OTP:\", error);\n      res.status(500).json({ error: \"Failed to verify OTP\" });\n    }\n  });\n\n  // Public tenant info for captive portal (limited info, no auth required)\n  app.get(\"/api/portal/tenant\", async (req, res) => {\n    try {\n      const tenantId = await getPublicTenantId(req);\n      const tenant = await storage.getTenant(tenantId);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n      // Return only public/branding info\n      res.json({\n        id: tenant.id,\n        name: tenant.name,\n        brandingConfig: tenant.brandingConfig,\n      });\n    } catch (error) {\n      console.error(\"Error fetching tenant:\", error);\n      res.status(500).json({ error: \"Failed to fetch tenant\" });\n    }\n  });\n\n  // ============== DASHBOARD ROUTES ==============\n  \n  app.get(\"/api/dashboard/stats\", requireAuthWithTenant, async (req, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const stats = await storage.getDashboardStats(tenantId);\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching dashboard stats:\", error);\n      res.status(500).json({ error: \"Failed to fetch dashboard stats\" });\n    }\n  });\n\n  // ============== PLAN ROUTES ==============\n  \n  app.get(\"/api/plans\", async (req, res) => {\n    try {\n      const planType = req.query.type as string | undefined;\n      let plans = await storage.getPlans(defaultTenantId);\n      \n      // Filter by plan type if specified\n      if (planType && [\"HOTSPOT\", \"PPPOE\", \"STATIC\"].includes(planType)) {\n        plans = plans.filter(p => p.planType === planType);\n      }\n      \n      res.json(plans);\n    } catch (error) {\n      console.error(\"Error fetching plans:\", error);\n      res.status(500).json({ error: \"Failed to fetch plans\" });\n    }\n  });\n\n  app.get(\"/api/plans/:id\", async (req, res) => {\n    try {\n      const plan = await storage.getPlan(req.params.id);\n      if (!plan) {\n        return res.status(404).json({ error: \"Plan not found\" });\n      }\n      res.json(plan);\n    } catch (error) {\n      console.error(\"Error fetching plan:\", error);\n      res.status(500).json({ error: \"Failed to fetch plan\" });\n    }\n  });\n\n  app.post(\"/api/plans\", async (req, res) => {\n    try {\n      const data = insertPlanSchema.parse({\n        ...req.body,\n        tenantId: defaultTenantId,\n      });\n      const plan = await storage.createPlan(data);\n      res.status(201).json(plan);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error creating plan:\", error);\n      res.status(500).json({ error: \"Failed to create plan\" });\n    }\n  });\n\n  app.patch(\"/api/plans/:id\", async (req, res) => {\n    try {\n      const plan = await storage.updatePlan(req.params.id, req.body);\n      if (!plan) {\n        return res.status(404).json({ error: \"Plan not found\" });\n      }\n      res.json(plan);\n    } catch (error) {\n      console.error(\"Error updating plan:\", error);\n      res.status(500).json({ error: \"Failed to update plan\" });\n    }\n  });\n\n  app.delete(\"/api/plans/:id\", async (req, res) => {\n    try {\n      const deleted = await storage.deletePlan(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Plan not found\" });\n      }\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting plan:\", error);\n      res.status(500).json({ error: \"Failed to delete plan\" });\n    }\n  });\n\n  // ============== HOTSPOT ROUTES ==============\n  \n  // Helper function to get tenant-scoped hotspot with proper error handling\n  type TenantHotspotResult = \n    | { error: string; status: number }\n    | { hotspot: Awaited<ReturnType<typeof storage.getHotspotForTenant>> & object; tenantId: string };\n  \n  async function getTenantHotspot(req: AuthenticatedRequest, hotspotId: string): Promise<TenantHotspotResult> {\n    const tenantId = getSessionTenantId(req) || defaultTenantId;\n    if (!tenantId) {\n      return { error: \"Tenant context required\", status: 400 };\n    }\n    const hotspot = await storage.getHotspotForTenant(hotspotId, tenantId);\n    if (!hotspot) {\n      return { error: \"Hotspot not found\", status: 404 };\n    }\n    return { hotspot, tenantId };\n  }\n  \n  app.get(\"/api/hotspots\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = getSessionTenantId(req) || defaultTenantId;\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      const hotspots = await storage.getHotspots(tenantId);\n      res.json(hotspots);\n    } catch (error) {\n      console.error(\"Error fetching hotspots:\", error);\n      res.status(500).json({ error: \"Failed to fetch hotspots\" });\n    }\n  });\n\n  app.get(\"/api/hotspots/:id\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const result = await getTenantHotspot(req, req.params.id);\n      if ('error' in result) {\n        return res.status(result.status).json({ error: result.error });\n      }\n      res.json(result.hotspot);\n    } catch (error) {\n      console.error(\"Error fetching hotspot:\", error);\n      res.status(500).json({ error: \"Failed to fetch hotspot\" });\n    }\n  });\n\n  app.post(\"/api/hotspots\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = getSessionTenantId(req) || defaultTenantId;\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      const data = insertHotspotSchema.parse({\n        ...req.body,\n        tenantId,\n      });\n      const hotspot = await storage.createHotspot(data);\n      res.status(201).json(hotspot);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error creating hotspot:\", error);\n      res.status(500).json({ error: \"Failed to create hotspot\" });\n    }\n  });\n\n  app.patch(\"/api/hotspots/:id\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const result = await getTenantHotspot(req, req.params.id);\n      if ('error' in result) {\n        return res.status(result.status).json({ error: result.error });\n      }\n      const hotspot = await storage.updateHotspot(req.params.id, req.body);\n      if (!hotspot) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      res.json(hotspot);\n    } catch (error) {\n      console.error(\"Error updating hotspot:\", error);\n      res.status(500).json({ error: \"Failed to update hotspot\" });\n    }\n  });\n\n  app.delete(\"/api/hotspots/:id\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const result = await getTenantHotspot(req, req.params.id);\n      if ('error' in result) {\n        return res.status(result.status).json({ error: result.error });\n      }\n      const deleted = await storage.deleteHotspot(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting hotspot:\", error);\n      res.status(500).json({ error: \"Failed to delete hotspot\" });\n    }\n  });\n\n  // ============== TECHNICIAN ROUTES ==============\n  \n  app.get(\"/api/users/technicians\", async (req, res) => {\n    try {\n      const tenantId = getSessionTenantId(req) || defaultTenantId;\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const technicians = await storage.getTechnicians(tenantId);\n      res.json(technicians);\n    } catch (error) {\n      console.error(\"Error fetching technicians:\", error);\n      res.status(500).json({ error: \"Failed to fetch technicians\" });\n    }\n  });\n\n  // ============== TRANSACTION ROUTES ==============\n  \n  app.get(\"/api/transactions\", async (req, res) => {\n    try {\n      const transactions = await storage.getTransactions(defaultTenantId);\n      res.json(transactions);\n    } catch (error) {\n      console.error(\"Error fetching transactions:\", error);\n      res.status(500).json({ error: \"Failed to fetch transactions\" });\n    }\n  });\n\n  app.get(\"/api/transactions/:id\", async (req, res) => {\n    try {\n      const transaction = await storage.getTransaction(req.params.id);\n      if (!transaction) {\n        return res.status(404).json({ error: \"Transaction not found\" });\n      }\n      res.json(transaction);\n    } catch (error) {\n      console.error(\"Error fetching transaction:\", error);\n      res.status(500).json({ error: \"Failed to fetch transaction\" });\n    }\n  });\n\n  // Initiate payment (STK Push with resilient job queue)\n  app.post(\"/api/transactions/initiate\", async (req, res) => {\n    try {\n      const { planId, phone, macAddress, nasIp } = req.body;\n      \n      if (!planId || !phone) {\n        return res.status(400).json({ error: \"Plan ID and phone number are required\" });\n      }\n\n      const plan = await storage.getPlan(planId);\n      if (!plan) {\n        return res.status(404).json({ error: \"Plan not found\" });\n      }\n\n      const checkoutRequestId = `ws_CO_${Date.now()}_${Math.random().toString(36).substring(7)}`;\n      const merchantRequestId = `MR_${Date.now()}`;\n\n      const transaction = await storage.createTransaction({\n        tenantId: defaultTenantId,\n        planId,\n        userPhone: phone,\n        amount: plan.price,\n        checkoutRequestId,\n        merchantRequestId,\n        status: TransactionStatus.PENDING,\n        reconciliationStatus: ReconciliationStatus.PENDING,\n        statusDescription: \"Awaiting M-Pesa confirmation\",\n        macAddress: macAddress || null,\n        nasIp: nasIp || null,\n      });\n\n      await jobQueue.schedulePaymentCheck(\n        defaultTenantId,\n        transaction.id,\n        checkoutRequestId,\n        10\n      );\n\n      console.log(`[Payment] Initiated STK Push for ${phone}, scheduled status check job`);\n\n      res.status(201).json(transaction);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error initiating transaction:\", error);\n      res.status(500).json({ error: \"Failed to initiate transaction\" });\n    }\n  });\n\n  // M-Pesa callback webhook (simulation)\n  app.post(\"/api/transactions/callback\", async (req, res) => {\n    try {\n      const { Body } = req.body;\n      \n      if (!Body?.stkCallback) {\n        return res.status(400).json({ error: \"Invalid callback format\" });\n      }\n\n      const { CheckoutRequestID, ResultCode, ResultDesc } = Body.stkCallback;\n\n      const transaction = await storage.getTransactionByCheckoutRequestId(CheckoutRequestID);\n      if (!transaction) {\n        return res.status(404).json({ error: \"Transaction not found\" });\n      }\n\n      if (ResultCode === 0) {\n        // Extract receipt number from callback items\n        const callbackMetadata = Body.stkCallback.CallbackMetadata?.Item || [];\n        const receiptItem = callbackMetadata.find((item: any) => item.Name === \"MpesaReceiptNumber\");\n        const receiptNumber = receiptItem?.Value || `QK${Date.now().toString().slice(-10)}`;\n\n        await storage.updateTransaction(transaction.id, {\n          status: \"COMPLETED\",\n          mpesaReceiptNumber: receiptNumber,\n          statusDescription: \"Payment received successfully\",\n        });\n      } else {\n        await storage.updateTransaction(transaction.id, {\n          status: \"FAILED\",\n          statusDescription: ResultDesc || \"Payment failed\",\n        });\n      }\n\n      res.json({ ResultCode: 0, ResultDesc: \"Callback received\" });\n    } catch (error) {\n      console.error(\"Error processing callback:\", error);\n      res.status(500).json({ error: \"Failed to process callback\" });\n    }\n  });\n\n  // Get WiFi credentials for a completed transaction (for auto-connect)\n  app.get(\"/api/transactions/:id/credentials\", async (req, res) => {\n    try {\n      const transaction = await storage.getTransaction(req.params.id);\n      if (!transaction) {\n        return res.status(404).json({ error: \"Transaction not found\" });\n      }\n\n      // Only return credentials for completed transactions\n      if (transaction.status !== TransactionStatus.COMPLETED) {\n        return res.status(400).json({ error: \"Transaction is not completed yet\" });\n      }\n\n      // Get WiFi user by phone or ID\n      let wifiUser = transaction.wifiUserId \n        ? await storage.getWifiUser(transaction.wifiUserId)\n        : await storage.getWifiUserByPhone(transaction.tenantId, transaction.userPhone);\n\n      if (!wifiUser) {\n        return res.status(404).json({ error: \"WiFi user not found\" });\n      }\n\n      // Get the plan details\n      const plan = transaction.planId ? await storage.getPlan(transaction.planId) : null;\n\n      // Get hotspot for login URL\n      const hotspots = await storage.getHotspots(transaction.tenantId);\n      const hotspot = wifiUser.currentHotspotId \n        ? hotspots.find(h => h.id === wifiUser!.currentHotspotId) \n        : hotspots[0];\n\n      // Build auto-login URL for MikroTik hotspot\n      let autoLoginUrl = null;\n      if (hotspot && wifiUser.username && wifiUser.password) {\n        // MikroTik hotspot auto-login URL format\n        const hotspotIp = hotspot.nasIp || hotspot.routerApiIp;\n        if (hotspotIp) {\n          autoLoginUrl = `http://${hotspotIp}/login?username=${encodeURIComponent(wifiUser.username)}&password=${encodeURIComponent(wifiUser.password)}`;\n        }\n      }\n\n      res.json({\n        username: wifiUser.username || wifiUser.phoneNumber,\n        password: wifiUser.password,\n        expiresAt: wifiUser.expiryTime,\n        planName: plan?.name || \"WiFi Access\",\n        planDuration: plan?.durationSeconds,\n        autoLoginUrl,\n        hotspotName: hotspot?.locationName,\n      });\n    } catch (error) {\n      console.error(\"Error fetching credentials:\", error);\n      res.status(500).json({ error: \"Failed to fetch credentials\" });\n    }\n  });\n\n  // ============== WALLED GARDEN ROUTES ==============\n  \n  app.get(\"/api/walled-gardens\", async (req, res) => {\n    try {\n      const walledGardens = await storage.getWalledGardens(defaultTenantId);\n      res.json(walledGardens);\n    } catch (error) {\n      console.error(\"Error fetching walled gardens:\", error);\n      res.status(500).json({ error: \"Failed to fetch walled gardens\" });\n    }\n  });\n\n  app.post(\"/api/walled-gardens\", async (req, res) => {\n    try {\n      const data = insertWalledGardenSchema.parse({\n        ...req.body,\n        tenantId: defaultTenantId,\n      });\n      const walledGarden = await storage.createWalledGarden(data);\n      res.status(201).json(walledGarden);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error creating walled garden:\", error);\n      res.status(500).json({ error: \"Failed to create walled garden\" });\n    }\n  });\n\n  app.delete(\"/api/walled-gardens/:id\", async (req, res) => {\n    try {\n      const deleted = await storage.deleteWalledGarden(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Walled garden entry not found\" });\n      }\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting walled garden:\", error);\n      res.status(500).json({ error: \"Failed to delete walled garden entry\" });\n    }\n  });\n\n  // ============== WIFI USER ROUTES ==============\n  \n  app.get(\"/api/wifi-users\", async (req, res) => {\n    try {\n      const wifiUsers = await storage.getWifiUsers(defaultTenantId);\n      res.json(wifiUsers);\n    } catch (error) {\n      console.error(\"Error fetching wifi users:\", error);\n      res.status(500).json({ error: \"Failed to fetch wifi users\" });\n    }\n  });\n\n  app.get(\"/api/wifi-users/expiring\", async (req, res) => {\n    try {\n      const days = parseInt(req.query.days as string) || 5;\n      const expiringUsers = await storage.getExpiringWifiUsers(defaultTenantId, days);\n      res.json(expiringUsers);\n    } catch (error) {\n      console.error(\"Error fetching expiring wifi users:\", error);\n      res.status(500).json({ error: \"Failed to fetch expiring wifi users\" });\n    }\n  });\n\n  app.get(\"/api/wifi-users/:id\", async (req, res) => {\n    try {\n      const wifiUser = await storage.getWifiUser(req.params.id);\n      if (!wifiUser) {\n        return res.status(404).json({ error: \"Wifi user not found\" });\n      }\n      res.json(wifiUser);\n    } catch (error) {\n      console.error(\"Error fetching wifi user:\", error);\n      res.status(500).json({ error: \"Failed to fetch wifi user\" });\n    }\n  });\n\n  app.post(\"/api/wifi-users\", async (req, res) => {\n    try {\n      const data = insertWifiUserSchema.parse({\n        ...req.body,\n        tenantId: defaultTenantId,\n      });\n      const wifiUser = await storage.createWifiUser(data);\n      res.status(201).json(wifiUser);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error creating wifi user:\", error);\n      res.status(500).json({ error: \"Failed to create wifi user\" });\n    }\n  });\n\n  app.patch(\"/api/wifi-users/:id\", async (req, res) => {\n    try {\n      const wifiUser = await storage.updateWifiUser(req.params.id, req.body);\n      if (!wifiUser) {\n        return res.status(404).json({ error: \"Wifi user not found\" });\n      }\n      res.json(wifiUser);\n    } catch (error) {\n      console.error(\"Error updating wifi user:\", error);\n      res.status(500).json({ error: \"Failed to update wifi user\" });\n    }\n  });\n\n  app.delete(\"/api/wifi-users/:id\", async (req, res) => {\n    try {\n      const deleted = await storage.deleteWifiUser(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Wifi user not found\" });\n      }\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting wifi user:\", error);\n      res.status(500).json({ error: \"Failed to delete wifi user\" });\n    }\n  });\n\n  // Get detailed customer information with payment history\n  app.get(\"/api/wifi-users/:id/details\", requireAuth, async (req, res) => {\n    try {\n      const authReq = req as AuthenticatedRequest;\n      const tenantId = authReq.user?.tenantId || defaultTenantId;\n      \n      const details = await storage.getCustomerDetails(req.params.id);\n      if (!details) {\n        return res.status(404).json({ error: \"Customer not found\" });\n      }\n\n      // Verify the customer belongs to the current tenant (prevent cross-tenant access)\n      if (details.customer.tenantId !== tenantId) {\n        return res.status(403).json({ error: \"Access denied\" });\n      }\n\n      res.json({\n        id: details.customer.id,\n        phoneNumber: details.customer.phoneNumber,\n        email: details.customer.email,\n        fullName: details.customer.fullName,\n        accountType: details.customer.accountType,\n        status: details.customer.status,\n        macAddress: details.customer.macAddress,\n        ipAddress: details.customer.ipAddress,\n        username: details.customer.username,\n        expiryTime: details.customer.expiryTime,\n        notes: details.customer.notes,\n        createdAt: details.customer.createdAt,\n        updatedAt: details.customer.updatedAt,\n        currentPlan: details.currentPlan ? {\n          id: details.currentPlan.id,\n          name: details.currentPlan.name,\n          price: details.currentPlan.price,\n          durationSeconds: details.currentPlan.durationSeconds,\n          uploadLimit: details.currentPlan.uploadLimit,\n          downloadLimit: details.currentPlan.downloadLimit,\n        } : null,\n        currentHotspot: details.currentHotspot ? {\n          id: details.currentHotspot.id,\n          locationName: details.currentHotspot.locationName,\n          nasIp: details.currentHotspot.nasIp,\n        } : null,\n        transactions: details.transactions.map(tx => ({\n          id: tx.id,\n          amount: tx.amount,\n          status: tx.status,\n          mpesaReceiptNumber: tx.mpesaReceiptNumber,\n          createdAt: tx.createdAt,\n          planName: tx.planName,\n        })),\n        stats: details.stats,\n      });\n    } catch (error) {\n      console.error(\"Error fetching customer details:\", error);\n      res.status(500).json({ error: \"Failed to fetch customer details\" });\n    }\n  });\n\n  // Admin manual actions for WiFi users\n  app.post(\"/api/wifi-users/:id/recharge\", async (req, res) => {\n    try {\n      const { planId, durationSeconds } = req.body;\n      const wifiUser = await storage.getWifiUser(req.params.id);\n      if (!wifiUser) {\n        return res.status(404).json({ error: \"Wifi user not found\" });\n      }\n      \n      const plan = planId ? await storage.getPlan(planId) : null;\n      const duration = durationSeconds || (plan?.durationSeconds || 3600);\n      \n      const now = new Date();\n      const currentExpiry = wifiUser.expiryTime && new Date(wifiUser.expiryTime) > now \n        ? new Date(wifiUser.expiryTime) \n        : now;\n      const newExpiry = new Date(currentExpiry.getTime() + duration * 1000);\n      \n      const updated = await storage.updateWifiUser(req.params.id, {\n        currentPlanId: planId || wifiUser.currentPlanId,\n        expiryTime: newExpiry,\n        status: \"ACTIVE\",\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error recharging wifi user:\", error);\n      res.status(500).json({ error: \"Failed to recharge wifi user\" });\n    }\n  });\n\n  app.post(\"/api/wifi-users/:id/suspend\", async (req, res) => {\n    try {\n      const wifiUser = await storage.updateWifiUser(req.params.id, {\n        status: \"SUSPENDED\",\n      });\n      if (!wifiUser) {\n        return res.status(404).json({ error: \"Wifi user not found\" });\n      }\n      res.json(wifiUser);\n    } catch (error) {\n      console.error(\"Error suspending wifi user:\", error);\n      res.status(500).json({ error: \"Failed to suspend wifi user\" });\n    }\n  });\n\n  app.post(\"/api/wifi-users/:id/activate\", async (req, res) => {\n    try {\n      const wifiUser = await storage.updateWifiUser(req.params.id, {\n        status: \"ACTIVE\",\n      });\n      if (!wifiUser) {\n        return res.status(404).json({ error: \"Wifi user not found\" });\n      }\n      res.json(wifiUser);\n    } catch (error) {\n      console.error(\"Error activating wifi user:\", error);\n      res.status(500).json({ error: \"Failed to activate wifi user\" });\n    }\n  });\n\n  app.post(\"/api/wifi-users/:id/change-hotspot\", async (req, res) => {\n    try {\n      const { hotspotId } = req.body;\n      if (!hotspotId) {\n        return res.status(400).json({ error: \"Hotspot ID is required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(hotspotId);\n      if (!hotspot) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const wifiUser = await storage.updateWifiUser(req.params.id, {\n        currentHotspotId: hotspotId,\n      });\n      if (!wifiUser) {\n        return res.status(404).json({ error: \"Wifi user not found\" });\n      }\n      res.json(wifiUser);\n    } catch (error) {\n      console.error(\"Error changing hotspot for wifi user:\", error);\n      res.status(500).json({ error: \"Failed to change hotspot\" });\n    }\n  });\n\n  // ============== TICKET ROUTES ==============\n  \n  app.get(\"/api/tickets\", async (req, res) => {\n    try {\n      const { status } = req.query;\n      let ticketsList;\n      if (status === \"open\") {\n        ticketsList = await storage.getOpenTickets(defaultTenantId);\n      } else {\n        ticketsList = await storage.getTickets(defaultTenantId);\n      }\n      res.json(ticketsList);\n    } catch (error) {\n      console.error(\"Error fetching tickets:\", error);\n      res.status(500).json({ error: \"Failed to fetch tickets\" });\n    }\n  });\n\n  app.get(\"/api/tickets/:id\", async (req, res) => {\n    try {\n      const ticket = await storage.getTicket(req.params.id);\n      if (!ticket) {\n        return res.status(404).json({ error: \"Ticket not found\" });\n      }\n      res.json(ticket);\n    } catch (error) {\n      console.error(\"Error fetching ticket:\", error);\n      res.status(500).json({ error: \"Failed to fetch ticket\" });\n    }\n  });\n\n  app.get(\"/api/wifi-users/:wifiUserId/tickets\", async (req, res) => {\n    try {\n      const tickets = await storage.getTicketsByWifiUser(req.params.wifiUserId);\n      res.json(tickets);\n    } catch (error) {\n      console.error(\"Error fetching tickets for wifi user:\", error);\n      res.status(500).json({ error: \"Failed to fetch tickets\" });\n    }\n  });\n\n  app.post(\"/api/tickets\", async (req, res) => {\n    try {\n      const data = insertTicketSchema.parse({\n        ...req.body,\n        tenantId: defaultTenantId,\n      });\n      const ticket = await storage.createTicket(data);\n      res.status(201).json(ticket);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error creating ticket:\", error);\n      res.status(500).json({ error: \"Failed to create ticket\" });\n    }\n  });\n\n  app.patch(\"/api/tickets/:id\", async (req, res) => {\n    try {\n      const ticket = await storage.updateTicket(req.params.id, req.body);\n      if (!ticket) {\n        return res.status(404).json({ error: \"Ticket not found\" });\n      }\n      res.json(ticket);\n    } catch (error) {\n      console.error(\"Error updating ticket:\", error);\n      res.status(500).json({ error: \"Failed to update ticket\" });\n    }\n  });\n\n  app.post(\"/api/tickets/:id/close\", async (req, res) => {\n    try {\n      const { resolutionNotes } = req.body;\n      const ticket = await storage.closeTicket(req.params.id, resolutionNotes || \"\");\n      if (!ticket) {\n        return res.status(404).json({ error: \"Ticket not found\" });\n      }\n      res.json(ticket);\n    } catch (error) {\n      console.error(\"Error closing ticket:\", error);\n      res.status(500).json({ error: \"Failed to close ticket\" });\n    }\n  });\n\n  // ============== VOUCHER ROUTES ==============\n  \n  // Generate random voucher code\n  function generateVoucherCode(prefix: string = \"\"): string {\n    const chars = \"ABCDEFGHJKLMNPQRSTUVWXYZ23456789\";\n    let code = \"\";\n    for (let i = 0; i < 8; i++) {\n      code += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    return prefix ? `${prefix}-${code}` : code;\n  }\n\n  app.get(\"/api/vouchers\", requireAuthWithTenant, async (req, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const vouchersList = await storage.getVouchers(tenantId);\n      res.json(vouchersList);\n    } catch (error) {\n      console.error(\"Error fetching vouchers:\", error);\n      res.status(500).json({ error: \"Failed to fetch vouchers\" });\n    }\n  });\n\n  app.get(\"/api/voucher-batches\", requireAuthWithTenant, async (req, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const batches = await storage.getVoucherBatches(tenantId);\n      res.json(batches);\n    } catch (error) {\n      console.error(\"Error fetching voucher batches:\", error);\n      res.status(500).json({ error: \"Failed to fetch voucher batches\" });\n    }\n  });\n\n  app.get(\"/api/voucher-batches/:id\", requireAuthWithTenant, async (req, res) => {\n    try {\n      const batch = await storage.getVoucherBatch(req.params.id);\n      if (!batch) {\n        return res.status(404).json({ error: \"Voucher batch not found\" });\n      }\n      res.json(batch);\n    } catch (error) {\n      console.error(\"Error fetching voucher batch:\", error);\n      res.status(500).json({ error: \"Failed to fetch voucher batch\" });\n    }\n  });\n\n  app.get(\"/api/voucher-batches/:id/vouchers\", requireAuthWithTenant, async (req, res) => {\n    try {\n      const vouchersList = await storage.getVouchersByBatch(req.params.id);\n      res.json(vouchersList);\n    } catch (error) {\n      console.error(\"Error fetching vouchers for batch:\", error);\n      res.status(500).json({ error: \"Failed to fetch vouchers\" });\n    }\n  });\n\n  app.post(\"/api/voucher-batches\", requireAuthWithTenant, requireAdmin, async (req, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      \n      const { name, planId, quantity, prefix, validFrom, validUntil } = req.body;\n      \n      if (!name || !planId || !quantity || quantity < 1) {\n        return res.status(400).json({ error: \"Name, plan ID, and quantity are required\" });\n      }\n\n      // Generate unique voucher codes\n      const voucherCodes: string[] = [];\n      const usedCodes = new Set<string>();\n      \n      for (let i = 0; i < quantity; i++) {\n        let code: string;\n        do {\n          code = generateVoucherCode(prefix || \"\");\n        } while (usedCodes.has(code));\n        usedCodes.add(code);\n        voucherCodes.push(code);\n      }\n\n      const batchData = insertVoucherBatchSchema.parse({\n        tenantId,\n        planId,\n        name,\n        prefix: prefix || null,\n        quantity,\n        validFrom: validFrom ? new Date(validFrom) : new Date(),\n        validUntil: validUntil ? new Date(validUntil) : null,\n      });\n\n      const result = await storage.createVoucherBatch(batchData, voucherCodes);\n      res.status(201).json(result);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid data\", details: error.errors });\n      }\n      console.error(\"Error creating voucher batch:\", error);\n      res.status(500).json({ error: \"Failed to create voucher batch\" });\n    }\n  });\n\n  app.get(\"/api/vouchers/:id\", requireAuthWithTenant, async (req, res) => {\n    try {\n      const voucher = await storage.getVoucher(req.params.id);\n      if (!voucher) {\n        return res.status(404).json({ error: \"Voucher not found\" });\n      }\n      res.json(voucher);\n    } catch (error) {\n      console.error(\"Error fetching voucher:\", error);\n      res.status(500).json({ error: \"Failed to fetch voucher\" });\n    }\n  });\n\n  app.patch(\"/api/vouchers/:id\", requireAuthWithTenant, requireAdmin, async (req, res) => {\n    try {\n      const voucher = await storage.updateVoucher(req.params.id, req.body);\n      if (!voucher) {\n        return res.status(404).json({ error: \"Voucher not found\" });\n      }\n      res.json(voucher);\n    } catch (error) {\n      console.error(\"Error updating voucher:\", error);\n      res.status(500).json({ error: \"Failed to update voucher\" });\n    }\n  });\n\n  app.delete(\"/api/vouchers/:id\", requireAuthWithTenant, requireAdmin, async (req, res) => {\n    try {\n      const deleted = await storage.deleteVoucher(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Voucher not found\" });\n      }\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting voucher:\", error);\n      res.status(500).json({ error: \"Failed to delete voucher\" });\n    }\n  });\n\n  // Public voucher lookup by phone for captive portal\n  app.get(\"/api/portal/vouchers\", async (req, res) => {\n    try {\n      const phone = req.query.phone as string;\n      const tenantId = await getPublicTenantId(req);\n      \n      if (!phone) {\n        return res.status(400).json({ error: \"Phone number is required\" });\n      }\n\n      // Normalize phone number\n      let normalizedPhone = phone.replace(/\\D/g, \"\");\n      if (normalizedPhone.startsWith(\"0\")) {\n        normalizedPhone = \"254\" + normalizedPhone.slice(1);\n      } else if (!normalizedPhone.startsWith(\"254\")) {\n        normalizedPhone = \"254\" + normalizedPhone;\n      }\n\n      const userVouchers = await storage.getVouchersByPhone(tenantId, normalizedPhone);\n      \n      // Return only relevant info for portal display\n      const vouchersWithDetails = userVouchers.map(v => ({\n        id: v.id,\n        code: v.code,\n        planName: v.planName,\n        status: v.status,\n        expiresAt: v.expiresAt,\n        usedAt: v.usedAt,\n      }));\n\n      res.json(vouchersWithDetails);\n    } catch (error) {\n      console.error(\"Error looking up vouchers:\", error);\n      res.status(500).json({ error: \"Failed to lookup vouchers\" });\n    }\n  });\n\n  // Public voucher redemption endpoint for captive portal\n  app.post(\"/api/portal/redeem-voucher\", async (req, res) => {\n    try {\n      const { code, phoneNumber, macAddress } = req.body;\n      const tenantId = await getPublicTenantId(req);\n      \n      if (!code) {\n        return res.status(400).json({ error: \"Voucher code is required\" });\n      }\n\n      // Find voucher by code\n      const voucher = await storage.getVoucherByCode(tenantId, code.toUpperCase().trim());\n      \n      if (!voucher) {\n        return res.status(404).json({ error: \"Invalid voucher code\" });\n      }\n\n      if (voucher.status !== VoucherStatus.AVAILABLE) {\n        return res.status(400).json({ error: \"This voucher has already been used or is no longer valid\" });\n      }\n\n      // Check validity dates\n      const now = new Date();\n      if (voucher.validFrom && new Date(voucher.validFrom) > now) {\n        return res.status(400).json({ error: \"This voucher is not yet valid\" });\n      }\n      if (voucher.validUntil && new Date(voucher.validUntil) < now) {\n        return res.status(400).json({ error: \"This voucher has expired\" });\n      }\n\n      // Get or create WiFi user\n      let wifiUser = phoneNumber ? await storage.getWifiUserByPhone(tenantId, phoneNumber) : null;\n      \n      if (!wifiUser && phoneNumber) {\n        wifiUser = await storage.createWifiUser({\n          tenantId,\n          phoneNumber,\n          accountType: \"HOTSPOT\",\n          currentPlanId: voucher.planId,\n          macAddress,\n          status: \"ACTIVE\",\n        });\n      }\n\n      if (!wifiUser) {\n        return res.status(400).json({ error: \"Phone number is required for new users\" });\n      }\n\n      // Redeem the voucher\n      const plan = await storage.getPlan(voucher.planId);\n      if (!plan) {\n        return res.status(500).json({ error: \"Plan not found\" });\n      }\n\n      const redeemed = await storage.redeemVoucher(voucher.id, wifiUser.id, macAddress);\n      \n      if (!redeemed) {\n        return res.status(500).json({ error: \"Failed to redeem voucher\" });\n      }\n\n      // Update user with expiry time\n      const expiresAt = new Date(now.getTime() + plan.durationSeconds * 1000);\n      \n      // Always ensure user has valid credentials for auto-connect\n      const needsUsername = !wifiUser.username;\n      const needsPassword = !wifiUser.password;\n      const username = wifiUser.username || wifiUser.phoneNumber.replace(/\\+/g, '');\n      const password = wifiUser.password || Math.random().toString(36).substring(2, 10);\n      \n      const updateData: any = {\n        currentPlanId: plan.id,\n        expiryTime: expiresAt,\n        macAddress,\n        status: \"ACTIVE\",\n      };\n      \n      // Update credentials if missing (for existing users without complete credentials)\n      if (needsUsername) {\n        updateData.username = username;\n      }\n      if (needsPassword) {\n        updateData.password = password;\n      }\n      \n      await storage.updateWifiUser(wifiUser.id, updateData);\n\n      // Activate user on MikroTik router and get auto-login URL\n      let routerActivated = false;\n      let autoLoginUrl: string | null = null;\n      let hotspotName: string | null = null;\n      try {\n        const hotspots = await storage.getHotspots(tenantId);\n        if (hotspots && hotspots.length > 0) {\n          const hotspot = hotspots[0];\n          hotspotName = hotspot.locationName;\n          \n          // Build auto-login URL for MikroTik hotspot\n          const hotspotIp = hotspot.nasIp || hotspot.routerApiIp;\n          if (hotspotIp) {\n            autoLoginUrl = `http://${hotspotIp}/login?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;\n          }\n          \n          const mikrotik = await createMikrotikService(hotspot);\n          if (mikrotik) {\n            const result = await mikrotik.addHotspotUser(\n              username,\n              password,\n              plan.name,\n              `Voucher: ${code}, Phone: ${phoneNumber}`\n            );\n            if (result.success) {\n              console.log(`[Voucher] Activated ${username} on router ${hotspot.locationName}`);\n              routerActivated = true;\n            } else {\n              console.warn(`[Voucher] Router activation failed: ${result.error}`);\n            }\n          }\n        }\n      } catch (routerError) {\n        console.error(\"[Voucher] Error activating on router:\", routerError);\n      }\n\n      res.json({\n        success: true,\n        message: \"Voucher redeemed successfully\",\n        plan: {\n          name: plan.name,\n          durationSeconds: plan.durationSeconds,\n        },\n        expiresAt,\n        user: {\n          id: wifiUser.id,\n          phoneNumber: wifiUser.phoneNumber,\n        },\n        credentials: {\n          username,\n          password,\n        },\n        autoLoginUrl,\n        hotspotName,\n        routerActivated,\n      });\n    } catch (error) {\n      console.error(\"Error redeeming voucher:\", error);\n      res.status(500).json({ error: \"Failed to redeem voucher\" });\n    }\n  });\n\n  // Public voucher verification endpoint - check voucher status without redeeming\n  app.get(\"/api/portal/verify-voucher/:code\", async (req, res) => {\n    try {\n      const { code } = req.params;\n      const tenantId = await getPublicTenantId(req);\n      \n      if (!code) {\n        return res.status(400).json({ error: \"Voucher code is required\" });\n      }\n\n      const voucher = await storage.getVoucherByCode(tenantId, code.toUpperCase().trim());\n      \n      if (!voucher) {\n        return res.status(404).json({ \n          valid: false,\n          error: \"Voucher not found\",\n          code: code.toUpperCase().trim()\n        });\n      }\n\n      const plan = voucher.planId ? await storage.getPlan(voucher.planId) : null;\n      const now = new Date();\n      \n      let status: \"available\" | \"used\" | \"expired\" | \"not_yet_valid\" = \"available\";\n      let statusMessage = \"Voucher is valid and ready to use\";\n      \n      if (voucher.status !== \"AVAILABLE\") {\n        status = \"used\";\n        statusMessage = \"This voucher has already been used\";\n      } else if (voucher.validFrom && new Date(voucher.validFrom) > now) {\n        status = \"not_yet_valid\";\n        statusMessage = `This voucher will be valid from ${new Date(voucher.validFrom).toLocaleDateString()}`;\n      } else if (voucher.validUntil && new Date(voucher.validUntil) < now) {\n        status = \"expired\";\n        statusMessage = \"This voucher has expired\";\n      }\n\n      res.json({\n        valid: status === \"available\",\n        code: voucher.code,\n        status,\n        statusMessage,\n        plan: plan ? {\n          name: plan.name,\n          price: plan.price,\n          durationSeconds: plan.durationSeconds,\n          speedLimit: plan.downloadLimit ? `${plan.downloadLimit}/${plan.uploadLimit}` : undefined,\n        } : null,\n        validFrom: voucher.validFrom,\n        validUntil: voucher.validUntil,\n        usedAt: voucher.usedAt,\n        usedBy: voucher.usedBy,\n      });\n    } catch (error) {\n      console.error(\"Error verifying voucher:\", error);\n      res.status(500).json({ error: \"Failed to verify voucher\" });\n    }\n  });\n\n  // ============== TECH ROUTES ==============\n  // These routes are for technicians to manage PPPoE and Static IP users\n  \n  app.get(\"/api/tech/stats\", requireTech, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = req.session?.user?.tenantId || defaultTenantId;\n      \n      // Get all WiFi users for this tenant\n      const allUsers = await storage.getWifiUsers(tenantId);\n      \n      // Filter by account type\n      const pppoeUsers = allUsers.filter(u => u.accountType === \"PPPOE\");\n      const staticUsers = allUsers.filter(u => u.accountType === \"STATIC\");\n      const activeUsers = allUsers.filter(u => \n        (u.accountType === \"PPPOE\" || u.accountType === \"STATIC\") && \n        u.status === \"ACTIVE\"\n      );\n      \n      // Get users expiring in the next 5 days\n      const now = new Date();\n      const fiveDaysFromNow = new Date(now.getTime() + 5 * 24 * 60 * 60 * 1000);\n      const expiringUsers = allUsers.filter(u => {\n        if (!u.expiryTime || (u.accountType !== \"PPPOE\" && u.accountType !== \"STATIC\")) {\n          return false;\n        }\n        const expiry = new Date(u.expiryTime);\n        return expiry > now && expiry <= fiveDaysFromNow;\n      });\n      \n      res.json({\n        totalPppoeUsers: pppoeUsers.length,\n        totalStaticUsers: staticUsers.length,\n        activeUsers: activeUsers.length,\n        expiringUsers,\n      });\n    } catch (error) {\n      console.error(\"Error fetching tech stats:\", error);\n      res.status(500).json({ error: \"Failed to fetch tech stats\" });\n    }\n  });\n\n  app.get(\"/api/tech/customers\", requireTech, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = req.session?.user?.tenantId || defaultTenantId;\n      const { type, search, status } = req.query;\n      \n      let users = await storage.getWifiUsers(tenantId);\n      \n      // Filter by account type (PPPoE or Static only for tech)\n      if (type) {\n        users = users.filter(u => u.accountType === type);\n      } else {\n        users = users.filter(u => u.accountType === \"PPPOE\" || u.accountType === \"STATIC\");\n      }\n      \n      // Filter by status\n      if (status) {\n        users = users.filter(u => u.status === status);\n      }\n      \n      // Search filter\n      if (search) {\n        const searchLower = String(search).toLowerCase();\n        users = users.filter(u => \n          u.fullName?.toLowerCase().includes(searchLower) ||\n          u.phoneNumber.toLowerCase().includes(searchLower) ||\n          u.username?.toLowerCase().includes(searchLower) ||\n          u.email?.toLowerCase().includes(searchLower)\n        );\n      }\n      \n      res.json(users);\n    } catch (error) {\n      console.error(\"Error fetching tech customers:\", error);\n      res.status(500).json({ error: \"Failed to fetch customers\" });\n    }\n  });\n\n  // ============== REPORTS ROUTES ==============\n  \n  app.get(\"/api/reports/reconciliation\", async (req, res) => {\n    try {\n      const { startDate, endDate } = req.query;\n      const start = startDate ? new Date(startDate as string) : undefined;\n      const end = endDate ? new Date(endDate as string) : undefined;\n      \n      const report = await storage.getReconciliationReport(defaultTenantId, start, end);\n      res.json(report);\n    } catch (error) {\n      console.error(\"Error generating reconciliation report:\", error);\n      res.status(500).json({ error: \"Failed to generate reconciliation report\" });\n    }\n  });\n\n  app.get(\"/api/reports/financial\", async (req, res) => {\n    try {\n      const { startDate, endDate } = req.query;\n      const start = startDate ? new Date(startDate as string) : undefined;\n      const end = endDate ? new Date(endDate as string) : undefined;\n      \n      const report = await storage.getFinancialReport(defaultTenantId, start, end);\n      res.json(report);\n    } catch (error) {\n      console.error(\"Error generating financial report:\", error);\n      res.status(500).json({ error: \"Failed to generate financial report\" });\n    }\n  });\n\n  app.get(\"/api/reports/user-activity\", async (req, res) => {\n    try {\n      const report = await storage.getUserActivityReport(defaultTenantId);\n      res.json(report);\n    } catch (error) {\n      console.error(\"Error generating user activity report:\", error);\n      res.status(500).json({ error: \"Failed to generate user activity report\" });\n    }\n  });\n\n  app.get(\"/api/reports/expiring-users\", async (req, res) => {\n    try {\n      const days = parseInt(req.query.days as string) || 5;\n      const expiringUsers = await storage.getExpiringWifiUsers(defaultTenantId, days);\n      res.json({\n        count: expiringUsers.length,\n        users: expiringUsers,\n      });\n    } catch (error) {\n      console.error(\"Error fetching expiring users:\", error);\n      res.status(500).json({ error: \"Failed to fetch expiring users\" });\n    }\n  });\n\n  // ============== MIKROTIK ROUTER MANAGEMENT ROUTES ==============\n  \n  app.post(\"/api/hotspots/:id/test-connection\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const result = await getTenantHotspot(req, req.params.id);\n      if ('error' in result) {\n        return res.status(result.status).json({ error: result.error });\n      }\n\n      const { MikrotikService } = await import(\"./services/mikrotik\");\n      const mikrotik = new MikrotikService(result.hotspot);\n      const testResult = await mikrotik.testConnection();\n      \n      res.json(testResult);\n    } catch (error) {\n      console.error(\"Error testing connection:\", error);\n      res.status(500).json({ error: \"Failed to test connection\" });\n    }\n  });\n\n  app.get(\"/api/hotspots/:id/active-sessions\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const result = await getTenantHotspot(req, req.params.id);\n      if ('error' in result) {\n        return res.status(result.status).json({ error: result.error });\n      }\n\n      const { MikrotikService } = await import(\"./services/mikrotik\");\n      const mikrotik = new MikrotikService(result.hotspot);\n      const sessions = await mikrotik.getActiveSessions();\n      \n      res.json(sessions);\n    } catch (error) {\n      console.error(\"Error fetching active sessions:\", error);\n      res.status(500).json({ error: \"Failed to fetch active sessions\" });\n    }\n  });\n\n  app.post(\"/api/hotspots/:id/disconnect-user\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { username } = req.body;\n      if (!username) {\n        return res.status(400).json({ error: \"Username is required\" });\n      }\n\n      const result = await getTenantHotspot(req, req.params.id);\n      if ('error' in result) {\n        return res.status(result.status).json({ error: result.error });\n      }\n\n      const { MikrotikService } = await import(\"./services/mikrotik\");\n      const mikrotik = new MikrotikService(result.hotspot);\n      const disconnectResult = await mikrotik.disconnectUser(username);\n      \n      res.json(disconnectResult);\n    } catch (error) {\n      console.error(\"Error disconnecting user:\", error);\n      res.status(500).json({ error: \"Failed to disconnect user\" });\n    }\n  });\n\n  // ============== SAAS BILLING ENFORCEMENT ROUTES ==============\n  \n  app.get(\"/api/admin/tenants\", async (req, res) => {\n    try {\n      const allTenants = await storage.getAllTenants();\n      res.json(allTenants);\n    } catch (error) {\n      console.error(\"Error fetching tenants:\", error);\n      res.status(500).json({ error: \"Failed to fetch tenants\" });\n    }\n  });\n\n  app.post(\"/api/admin/tenants/:id/billing-status\", async (req, res) => {\n    try {\n      const { status } = req.body;\n      if (![\"ACTIVE\", \"TRIAL\", \"SUSPENDED\", \"BLOCKED\"].includes(status)) {\n        return res.status(400).json({ error: \"Invalid billing status\" });\n      }\n\n      const tenant = await storage.updateTenantBillingStatus(req.params.id, status);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n\n      if (status === \"BLOCKED\") {\n        console.log(`[SaaS] Tenant ${tenant.name} has been BLOCKED - should disable hotspots`);\n      }\n\n      res.json(tenant);\n    } catch (error) {\n      console.error(\"Error updating tenant billing status:\", error);\n      res.status(500).json({ error: \"Failed to update billing status\" });\n    }\n  });\n\n  app.post(\"/api/admin/tenants/:id/block-traffic\", async (req, res) => {\n    try {\n      const tenant = await storage.getTenant(req.params.id);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n\n      const hotspotsList = await storage.getHotspots(req.params.id);\n      const results = [];\n\n      const { MikrotikService } = await import(\"./services/mikrotik\");\n      \n      for (const hotspot of hotspotsList) {\n        try {\n          const mikrotik = new MikrotikService(hotspot);\n          const result = await mikrotik.blockTenantTraffic(\"ISP subscription suspended\");\n          results.push({ hotspot: hotspot.locationName, ...result });\n        } catch (e) {\n          results.push({ hotspot: hotspot.locationName, success: false, error: String(e) });\n        }\n      }\n\n      await storage.updateTenantBillingStatus(req.params.id, \"BLOCKED\");\n      \n      res.json({ tenant: tenant.name, blocked: true, results });\n    } catch (error) {\n      console.error(\"Error blocking tenant traffic:\", error);\n      res.status(500).json({ error: \"Failed to block tenant traffic\" });\n    }\n  });\n\n  app.post(\"/api/admin/tenants/:id/unblock-traffic\", async (req, res) => {\n    try {\n      const tenant = await storage.getTenant(req.params.id);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n\n      const hotspotsList = await storage.getHotspots(req.params.id);\n      const results = [];\n\n      const { MikrotikService } = await import(\"./services/mikrotik\");\n      \n      for (const hotspot of hotspotsList) {\n        try {\n          const mikrotik = new MikrotikService(hotspot);\n          const result = await mikrotik.unblockTenantTraffic();\n          results.push({ hotspot: hotspot.locationName, ...result });\n        } catch (e) {\n          results.push({ hotspot: hotspot.locationName, success: false, error: String(e) });\n        }\n      }\n\n      await storage.updateTenantBillingStatus(req.params.id, \"ACTIVE\");\n      \n      res.json({ tenant: tenant.name, blocked: false, results });\n    } catch (error) {\n      console.error(\"Error unblocking tenant traffic:\", error);\n      res.status(500).json({ error: \"Failed to unblock tenant traffic\" });\n    }\n  });\n\n  // ============== SUPER ADMIN ROUTES ==============\n  // All superadmin routes require superadmin role\n\n  // Get platform analytics for super admin dashboard\n  app.get(\"/api/superadmin/analytics\", requireSuperAdmin, async (req, res) => {\n    try {\n      const analytics = await storage.getPlatformAnalytics();\n      res.json(analytics);\n    } catch (error) {\n      console.error(\"Error fetching platform analytics:\", error);\n      res.status(500).json({ error: \"Failed to fetch platform analytics\" });\n    }\n  });\n\n  // Get all tenants with enhanced stats\n  app.get(\"/api/superadmin/tenants\", requireSuperAdmin, async (req, res) => {\n    try {\n      const tenantsWithStats = await storage.getAllTenantsWithStats();\n      res.json(tenantsWithStats);\n    } catch (error) {\n      console.error(\"Error fetching tenants with stats:\", error);\n      res.status(500).json({ error: \"Failed to fetch tenants\" });\n    }\n  });\n\n  // Get single tenant details\n  app.get(\"/api/superadmin/tenants/:id\", requireSuperAdmin, async (req, res) => {\n    try {\n      const tenant = await storage.getTenant(req.params.id);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n\n      const wifiUsersList = await storage.getWifiUsers(req.params.id);\n      const transactionsList = await storage.getTransactions(req.params.id);\n      const hotspotsList = await storage.getHotspots(req.params.id);\n      const plansList = await storage.getPlans(req.params.id);\n\n      const now = new Date();\n      const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);\n      const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);\n      const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);\n\n      const completedTransactions = transactionsList.filter(t => t.status === 'COMPLETED');\n      const thisMonthRevenue = completedTransactions\n        .filter(t => t.createdAt && new Date(t.createdAt) >= thisMonthStart)\n        .reduce((sum, t) => sum + t.amount, 0);\n      const lastMonthRevenue = completedTransactions\n        .filter(t => t.createdAt && new Date(t.createdAt) >= lastMonthStart && new Date(t.createdAt) <= lastMonthEnd)\n        .reduce((sum, t) => sum + t.amount, 0);\n\n      res.json({\n        ...tenant,\n        userCount: wifiUsersList.length,\n        transactionCount: transactionsList.length,\n        hotspotCount: hotspotsList.length,\n        planCount: plansList.length,\n        revenueThisMonth: thisMonthRevenue,\n        revenueLastMonth: lastMonthRevenue,\n      });\n    } catch (error) {\n      console.error(\"Error fetching tenant details:\", error);\n      res.status(500).json({ error: \"Failed to fetch tenant details\" });\n    }\n  });\n\n  // Update tenant subscription tier\n  app.patch(\"/api/superadmin/tenants/:id/subscription\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { tier, saasBillingStatus, trialExpiresAt, subscriptionExpiresAt } = req.body;\n      \n      const updateData: {\n        tier?: string;\n        saasBillingStatus?: string;\n        trialExpiresAt?: Date | null;\n        subscriptionExpiresAt?: Date | null;\n      } = {};\n\n      if (tier) updateData.tier = tier;\n      if (saasBillingStatus) updateData.saasBillingStatus = saasBillingStatus;\n      if (trialExpiresAt !== undefined) {\n        updateData.trialExpiresAt = trialExpiresAt ? new Date(trialExpiresAt) : null;\n      }\n      if (subscriptionExpiresAt !== undefined) {\n        updateData.subscriptionExpiresAt = subscriptionExpiresAt ? new Date(subscriptionExpiresAt) : null;\n      }\n\n      const tenant = await storage.updateTenantSubscription(req.params.id, updateData);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n\n      res.json(tenant);\n    } catch (error) {\n      console.error(\"Error updating tenant subscription:\", error);\n      res.status(500).json({ error: \"Failed to update tenant subscription\" });\n    }\n  });\n\n  // ============== SUPERADMIN SMS ROUTES ==============\n  \n  // Get SMS balance\n  app.get(\"/api/superadmin/sms/balance\", requireSuperAdmin, async (req, res) => {\n    try {\n      const smsService = getSmsService();\n      const result = await smsService.getBalance();\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error getting SMS balance:\", error);\n      res.status(500).json({ success: false, error: \"Failed to get SMS balance\" });\n    }\n  });\n\n  // Send test SMS\n  app.post(\"/api/superadmin/sms/test\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { phone } = req.body;\n      if (!phone) {\n        return res.status(400).json({ success: false, error: \"Phone number is required\" });\n      }\n\n      const smsService = getSmsService();\n      const result = await smsService.sendOtp(phone, Math.floor(100000 + Math.random() * 900000).toString());\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error sending test SMS:\", error);\n      res.status(500).json({ success: false, error: \"Failed to send test SMS\" });\n    }\n  });\n\n  // SMS Delivery Report Webhook (public endpoint for Mobitech)\n  app.post(\"/api/webhooks/sms/delivery\", async (req, res) => {\n    try {\n      const { \n        messageId, \n        dlrTime, \n        dlrStatus, \n        dlrDesc, \n        tat, \n        network, \n        destaddr, \n        sourceaddr, \n        origin \n      } = req.body;\n\n      console.log(`[SMS DLR] Message ${messageId} - Status: ${dlrStatus} (${dlrDesc}) - To: ${destaddr}`);\n      \n      // Process the delivery report\n      const { SmsService } = await import(\"./services/sms\");\n      const report = SmsService.processDeliveryReport({\n        messageId: String(messageId),\n        dlrTime,\n        dlrStatus: Number(dlrStatus),\n        dlrDesc,\n        tat,\n        network,\n        destaddr,\n        sourceaddr,\n        origin,\n      });\n\n      console.log(`[SMS DLR] Processed: ${report.messageId} - ${report.status}`);\n\n      // Return success to Mobitech\n      res.json({ success: true, received: true });\n    } catch (error) {\n      console.error(\"Error processing SMS delivery report:\", error);\n      // Still return 200 to prevent retries\n      res.json({ success: false, error: \"Failed to process delivery report\" });\n    }\n  });\n\n  // ============== SUBSCRIPTION MANAGEMENT (User-facing) ==============\n  \n  // Upgrade subscription (tenant admin)\n  app.post(\"/api/subscription/upgrade\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const { durationMonths, paymentMethod, phoneNumber, amount } = req.body;\n\n      // Validate inputs\n      if (!durationMonths || !paymentMethod) {\n        return res.status(400).json({ error: \"Duration and payment method are required\" });\n      }\n\n      if (![\"MPESA\", \"BANK\", \"PAYPAL\"].includes(paymentMethod)) {\n        return res.status(400).json({ error: \"Invalid payment method\" });\n      }\n\n      const validDurations = [1, 3, 6, 12];\n      if (!validDurations.includes(durationMonths)) {\n        return res.status(400).json({ error: \"Invalid subscription duration\" });\n      }\n\n      // Get current tenant\n      const tenant = await storage.getTenant(tenantId);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n\n      // Calculate subscription expiry\n      const now = new Date();\n      let startDate = now;\n      \n      // If currently premium with valid subscription, extend from current expiry\n      if (tenant.subscriptionTier === \"PREMIUM\" && tenant.subscriptionExpiresAt && new Date(tenant.subscriptionExpiresAt) > now) {\n        startDate = new Date(tenant.subscriptionExpiresAt);\n      }\n      \n      const subscriptionExpiresAt = new Date(startDate);\n      subscriptionExpiresAt.setMonth(subscriptionExpiresAt.getMonth() + durationMonths);\n\n      // Determine payment status based on method\n      let paymentStatus = \"PENDING\";\n      let responseMessage = \"Processing payment...\";\n\n      if (paymentMethod === \"MPESA\" && phoneNumber) {\n        paymentStatus = \"PENDING\";\n        responseMessage = \"M-Pesa payment request sent to your phone. Please complete the payment.\";\n        console.log(`[Subscription] M-Pesa STK push to be sent to ${phoneNumber} for tenant ${tenantId}`);\n      } else if (paymentMethod === \"BANK\") {\n        paymentStatus = \"AWAITING_CONFIRMATION\";\n        responseMessage = \"Please complete the bank transfer. Your subscription will be activated after payment confirmation.\";\n      } else if (paymentMethod === \"PAYPAL\") {\n        paymentStatus = \"PENDING\";\n        responseMessage = \"Redirecting to PayPal for payment...\";\n      }\n\n      // For demo purposes, auto-activate the subscription immediately\n      // In production, this would be triggered after payment confirmation\n      const updatedTenant = await storage.updateTenantSubscription(tenantId, {\n        tier: \"PREMIUM\",\n        saasBillingStatus: \"ACTIVE\",\n        subscriptionExpiresAt,\n        trialExpiresAt: null, // Clear trial when upgrading\n      });\n\n      console.log(`[Subscription] Tenant ${tenant.name} upgraded to PREMIUM until ${subscriptionExpiresAt.toISOString()}`);\n\n      res.json({\n        success: true,\n        message: responseMessage,\n        subscription: {\n          tier: \"PREMIUM\",\n          expiresAt: subscriptionExpiresAt,\n          durationMonths,\n        },\n        paymentStatus,\n        paymentMethod,\n      });\n    } catch (error) {\n      console.error(\"Error upgrading subscription:\", error);\n      res.status(500).json({ error: \"Failed to upgrade subscription\" });\n    }\n  });\n\n  // Get current subscription status\n  app.get(\"/api/subscription/status\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const tenant = await storage.getTenant(tenantId);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n\n      const now = new Date();\n      const isTrialExpired = tenant.trialExpiresAt && new Date(tenant.trialExpiresAt) < now;\n      const isSubscriptionExpired = tenant.subscriptionExpiresAt && new Date(tenant.subscriptionExpiresAt) < now;\n      \n      let trialTimeRemaining = null;\n      if (tenant.trialExpiresAt && !isTrialExpired) {\n        trialTimeRemaining = new Date(tenant.trialExpiresAt).getTime() - now.getTime();\n      }\n\n      res.json({\n        subscriptionTier: tenant.subscriptionTier || \"BASIC\",\n        saasBillingStatus: tenant.saasBillingStatus,\n        trialExpiresAt: tenant.trialExpiresAt,\n        subscriptionExpiresAt: tenant.subscriptionExpiresAt,\n        isTrialExpired,\n        isSubscriptionExpired,\n        trialTimeRemaining,\n        isActive: tenant.isActive,\n      });\n    } catch (error) {\n      console.error(\"Error fetching subscription status:\", error);\n      res.status(500).json({ error: \"Failed to fetch subscription status\" });\n    }\n  });\n\n  // Activate/Suspend tenant\n  app.patch(\"/api/superadmin/tenants/:id/status\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { isActive, saasBillingStatus } = req.body;\n      \n      const updateData: Partial<{ isActive: boolean; saasBillingStatus: string }> = {};\n      if (isActive !== undefined) updateData.isActive = isActive;\n      if (saasBillingStatus) updateData.saasBillingStatus = saasBillingStatus;\n\n      const tenant = await storage.updateTenant(req.params.id, updateData);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n\n      console.log(`[SuperAdmin] Tenant ${tenant.name} status updated: active=${isActive}, billing=${saasBillingStatus}`);\n      res.json(tenant);\n    } catch (error) {\n      console.error(\"Error updating tenant status:\", error);\n      res.status(500).json({ error: \"Failed to update tenant status\" });\n    }\n  });\n\n  // Create admin user (protected - only existing superadmins can create new ones)\n  app.post(\"/api/superadmin/create-superadmin\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { username, email, password, role } = req.body;\n      \n      if (!username || !email || !password) {\n        return res.status(400).json({ error: \"Username, email, and password are required\" });\n      }\n\n      const validRoles = [\"superadmin\", \"admin\", \"tech\"];\n      const userRole = validRoles.includes(role) ? role : \"superadmin\";\n\n      const existingUser = await storage.getUserByUsername(username);\n      if (existingUser) {\n        return res.status(409).json({ error: \"Username already exists\" });\n      }\n\n      const hashedPassword = await hashPassword(password);\n      const user = await storage.createUser({\n        username,\n        email,\n        password: hashedPassword,\n        role: userRole,\n        isActive: true,\n      });\n\n      res.json({\n        id: user.id,\n        username: user.username,\n        email: user.email,\n        role: user.role,\n      });\n    } catch (error) {\n      console.error(\"Error creating admin user:\", error);\n      res.status(500).json({ error: \"Failed to create admin user\" });\n    }\n  });\n\n  // List all admin users\n  app.get(\"/api/superadmin/users\", requireSuperAdmin, async (req, res) => {\n    try {\n      const adminUsers = await storage.getAllAdminUsers();\n      res.json(adminUsers.map(u => ({\n        id: u.id,\n        username: u.username,\n        email: u.email,\n        role: u.role,\n        isActive: u.isActive,\n        tenantId: u.tenantId,\n        tenantName: u.tenantName,\n        createdAt: u.createdAt,\n      })));\n    } catch (error) {\n      console.error(\"Error fetching admin users:\", error);\n      res.status(500).json({ error: \"Failed to fetch admin users\" });\n    }\n  });\n\n  // Update admin user status\n  app.patch(\"/api/superadmin/users/:id/status\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { isActive } = req.body;\n      const user = await storage.updateUser(req.params.id, { isActive });\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      res.json({ id: user.id, username: user.username, isActive: user.isActive });\n    } catch (error) {\n      console.error(\"Error updating user status:\", error);\n      res.status(500).json({ error: \"Failed to update user status\" });\n    }\n  });\n\n  // Delete admin user\n  app.delete(\"/api/superadmin/users/:id\", requireSuperAdmin, async (req, res) => {\n    try {\n      const deleted = await storage.deleteUser(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting user:\", error);\n      res.status(500).json({ error: \"Failed to delete user\" });\n    }\n  });\n\n  // ============== JOB QUEUE STATUS ROUTES ==============\n  \n  app.get(\"/api/jobs/pending\", async (req, res) => {\n    try {\n      const pendingJobs = await jobQueue.getPendingJobs(defaultTenantId);\n      res.json(pendingJobs);\n    } catch (error) {\n      console.error(\"Error fetching pending jobs:\", error);\n      res.status(500).json({ error: \"Failed to fetch pending jobs\" });\n    }\n  });\n\n  app.get(\"/api/jobs/recent\", async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 50;\n      const recentJobs = await jobQueue.getRecentJobs(limit);\n      res.json(recentJobs);\n    } catch (error) {\n      console.error(\"Error fetching recent jobs:\", error);\n      res.status(500).json({ error: \"Failed to fetch recent jobs\" });\n    }\n  });\n\n  // ============== SMS CAMPAIGNS ROUTES ==============\n\n  app.get(\"/api/sms/campaigns\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = req.session.user?.tenantId || defaultTenantId;\n      const campaigns = await storage.getSmsCampaigns(tenantId);\n      res.json(campaigns);\n    } catch (error) {\n      console.error(\"Error fetching SMS campaigns:\", error);\n      res.status(500).json({ error: \"Failed to fetch campaigns\" });\n    }\n  });\n\n  const smsCampaignSchema = z.object({\n    name: z.string().min(1, \"Campaign name is required\").max(100, \"Campaign name too long\"),\n    message: z.string().min(1, \"Message is required\").max(480, \"Message too long (max 480 chars for 3 SMS)\"),\n    recipients: z.array(z.string().uuid()).min(1, \"At least one recipient required\"),\n  });\n\n  app.post(\"/api/sms/campaigns\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = req.session.user?.tenantId || defaultTenantId;\n      \n      // Validate input with Zod\n      const validationResult = smsCampaignSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: validationResult.error.errors[0].message \n        });\n      }\n      \n      const { name, message, recipients } = validationResult.data;\n\n      // Get tenant for SMS configuration\n      const tenant = await storage.getTenant(tenantId);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n\n      // Verify all recipients belong to this tenant\n      const users = await storage.getWifiUsersByIds(tenantId, recipients);\n      if (users.length !== recipients.length) {\n        return res.status(400).json({ \n          error: \"Some recipients do not belong to your organization\" \n        });\n      }\n\n      // Calculate cost estimate\n      const smsCount = Math.ceil(message.length / 160);\n      const estimatedCost = users.length * smsCount * 0.7; // 0.70 KES per SMS\n\n      // Create campaign record with fixed status\n      const campaign = await storage.createSmsCampaign({\n        tenantId,\n        name,\n        message,\n        recipientCount: recipients.length,\n        status: \"sending\",\n      });\n\n      // Initialize SMS service using platform configuration\n      const smsService = getSmsService();\n\n      // Send SMS to each recipient\n      let sentCount = 0;\n      let failedCount = 0;\n\n      for (const user of users) {\n        try {\n          const result = await smsService.sendSms(user.phoneNumber, message);\n          if (result.success) {\n            console.log(`[SMS Campaign] Sent to ${user.phoneNumber}: ${result.messageId}`);\n            sentCount++;\n          } else {\n            console.error(`[SMS Campaign] Failed to send to ${user.phoneNumber}: ${result.error}`);\n            failedCount++;\n          }\n        } catch (error) {\n          console.error(`[SMS Campaign] Error sending to ${user.phoneNumber}:`, error);\n          failedCount++;\n        }\n      }\n\n      // Update campaign status (only allowed fields)\n      await storage.updateSmsCampaignStatus(campaign.id, sentCount, failedCount);\n\n      res.status(201).json({\n        ...campaign,\n        sentCount,\n        failedCount,\n        estimatedCost,\n        status: failedCount === recipients.length ? \"failed\" : \"completed\",\n      });\n    } catch (error) {\n      console.error(\"Error creating SMS campaign:\", error);\n      res.status(500).json({ error: \"Failed to create campaign\" });\n    }\n  });\n\n  // ============== WHATSAPP CAMPAIGNS ROUTES ==============\n  \n  const { WhatsAppService } = await import(\"./services/whatsapp\");\n  \n  const whatsappCampaignSchema = z.object({\n    name: z.string().min(1, \"Campaign name is required\").max(100, \"Campaign name too long\"),\n    message: z.string().min(1, \"Message is required\").max(1000, \"Message too long\"),\n    recipients: z.array(z.string().uuid()).min(1, \"At least one recipient required\"),\n  });\n\n  app.post(\"/api/whatsapp/send\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = req.session.user?.tenantId || defaultTenantId;\n      \n      const validationResult = whatsappCampaignSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: validationResult.error.errors[0].message \n        });\n      }\n      \n      const { name, message, recipients } = validationResult.data;\n\n      const tenant = await storage.getTenant(tenantId);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n\n      const users = await storage.getWifiUsersByIds(tenantId, recipients);\n      if (users.length !== recipients.length) {\n        return res.status(400).json({ \n          error: \"Some recipients do not belong to your organization\" \n        });\n      }\n\n      const whatsappService = new WhatsAppService(tenant, {\n        provider: (tenant.whatsappProvider as \"meta\" | \"twilio\" | \"mock\") || \"mock\",\n        apiKey: tenant.whatsappApiKey || undefined,\n        phoneNumberId: tenant.whatsappPhoneNumberId || undefined,\n        businessAccountId: tenant.whatsappBusinessAccountId || undefined,\n      });\n\n      let sentCount = 0;\n      let failedCount = 0;\n\n      for (const user of users) {\n        try {\n          const result = await whatsappService.sendMessage(user.phoneNumber, message);\n          if (result.success) {\n            console.log(`[WhatsApp Campaign] Sent to ${user.phoneNumber}: ${result.messageId}`);\n            sentCount++;\n          } else {\n            console.error(`[WhatsApp Campaign] Failed to send to ${user.phoneNumber}: ${result.error}`);\n            failedCount++;\n          }\n        } catch (error) {\n          console.error(`[WhatsApp Campaign] Error sending to ${user.phoneNumber}:`, error);\n          failedCount++;\n        }\n      }\n\n      res.status(201).json({\n        name,\n        sentCount,\n        failedCount,\n        recipientCount: recipients.length,\n        status: failedCount === recipients.length ? \"failed\" : \"completed\",\n      });\n    } catch (error) {\n      console.error(\"Error sending WhatsApp campaign:\", error);\n      res.status(500).json({ error: \"Failed to send WhatsApp messages\" });\n    }\n  });\n\n  // ============== CUSTOMER PORTAL ROUTES ==============\n  \n  const customerOtpStore = new Map<string, { code: string; expiresAt: Date }>();\n  \n  // Customer session tokens for authenticated API access\n  const customerSessionStore = new Map<string, { userId: string; phoneNumber: string; expiresAt: Date }>();\n  \n  // Helper to generate session token\n  const generateSessionToken = (): string => {\n    return Math.random().toString(36).substring(2) + Date.now().toString(36);\n  };\n  \n  // Helper to verify customer session\n  const verifyCustomerSession = (token: string | undefined, userId: string): boolean => {\n    if (!token) return false;\n    const session = customerSessionStore.get(token);\n    if (!session) return false;\n    if (session.expiresAt < new Date()) {\n      customerSessionStore.delete(token);\n      return false;\n    }\n    return session.userId === userId;\n  };\n\n  app.post(\"/api/customer/request-otp\", async (req, res) => {\n    try {\n      const { phoneNumber } = req.body;\n      \n      if (!phoneNumber) {\n        return res.status(400).json({ error: \"Phone number is required\" });\n      }\n\n      // Find user by phone number (check all tenants for now)\n      const allTenants = await storage.getAllTenants();\n      let foundUser = null;\n      let foundTenant = null;\n      \n      for (const tenant of allTenants) {\n        const users = await storage.getWifiUsers(tenant.id);\n        const user = users.find(u => u.phoneNumber === phoneNumber || u.phoneNumber === phoneNumber.replace(/^0/, \"+254\"));\n        if (user) {\n          foundUser = user;\n          foundTenant = tenant;\n          break;\n        }\n      }\n\n      if (!foundUser) {\n        return res.status(404).json({ error: \"No account found with this phone number\" });\n      }\n\n      // Generate OTP\n      const otp = Math.floor(1000 + Math.random() * 9000).toString();\n      customerOtpStore.set(phoneNumber, {\n        code: otp,\n        expiresAt: new Date(Date.now() + 5 * 60 * 1000), // 5 minutes\n      });\n\n      // Send OTP via SMS using platform SMS service\n      if (foundTenant) {\n        const smsService = getSmsService();\n        await smsService.sendSms(\n          phoneNumber,\n          `Your WiFi Portal verification code is: ${otp}. Valid for 5 minutes.`\n        );\n      }\n\n      console.log(`[Customer Portal] OTP sent to ${phoneNumber}: ${otp}`);\n      res.json({ success: true, message: \"Verification code sent\" });\n    } catch (error) {\n      console.error(\"Error requesting OTP:\", error);\n      res.status(500).json({ error: \"Failed to send verification code\" });\n    }\n  });\n\n  app.post(\"/api/customer/verify-otp\", async (req, res) => {\n    try {\n      const { phoneNumber, code } = req.body;\n      \n      if (!phoneNumber || !code) {\n        return res.status(400).json({ error: \"Phone number and code are required\" });\n      }\n\n      const storedOtp = customerOtpStore.get(phoneNumber);\n      \n      if (!storedOtp) {\n        return res.status(400).json({ error: \"No verification code found. Please request a new one.\" });\n      }\n\n      if (storedOtp.expiresAt < new Date()) {\n        customerOtpStore.delete(phoneNumber);\n        return res.status(400).json({ error: \"Verification code expired. Please request a new one.\" });\n      }\n\n      if (storedOtp.code !== code) {\n        return res.status(400).json({ error: \"Invalid verification code\" });\n      }\n\n      // Clear OTP after successful verification\n      customerOtpStore.delete(phoneNumber);\n\n      // Find user by phone number\n      const allTenants = await storage.getAllTenants();\n      let foundUser = null;\n      let foundTenant = null;\n      let foundHotspot = null;\n      \n      for (const tenant of allTenants) {\n        const users = await storage.getWifiUsers(tenant.id);\n        const user = users.find(u => u.phoneNumber === phoneNumber || u.phoneNumber === phoneNumber.replace(/^0/, \"+254\"));\n        if (user) {\n          foundUser = user;\n          foundTenant = tenant;\n          if (user.currentHotspotId) {\n            foundHotspot = await storage.getHotspot(user.currentHotspotId);\n          }\n          break;\n        }\n      }\n\n      if (!foundUser || !foundTenant) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      // Get user's current plan\n      let plan = null;\n      if (foundUser.currentPlanId) {\n        const plans = await storage.getPlans(foundTenant.id);\n        plan = plans.find(p => p.id === foundUser.currentPlanId);\n      }\n\n      // Get user's transactions\n      const transactions = await storage.getTransactionsByWifiUserId(foundUser.id);\n\n      // Generate session token for authenticated API access\n      const sessionToken = generateSessionToken();\n      customerSessionStore.set(sessionToken, {\n        userId: foundUser.id,\n        phoneNumber,\n        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24 hours\n      });\n\n      res.json({\n        user: foundUser,\n        plan,\n        transactions: transactions.slice(0, 20),\n        hotspotName: foundHotspot?.locationName || \"WiFi Network\",\n        tenantId: foundTenant.id,\n        sessionToken, // Return session token for authenticated API calls\n      });\n    } catch (error) {\n      console.error(\"Error verifying OTP:\", error);\n      res.status(500).json({ error: \"Failed to verify code\" });\n    }\n  });\n\n  app.post(\"/api/customer/renew\", async (req, res) => {\n    try {\n      const { planId, userId, tenantId } = req.body;\n      \n      if (!planId) {\n        return res.status(400).json({ error: \"Plan ID is required\" });\n      }\n\n      // For now, return a message about M-Pesa initiation\n      // In a full implementation, this would integrate with the M-Pesa STK push\n      res.json({\n        success: true,\n        message: \"M-Pesa payment initiated. Please check your phone.\",\n      });\n    } catch (error) {\n      console.error(\"Error initiating renewal:\", error);\n      res.status(500).json({ error: \"Failed to initiate payment\" });\n    }\n  });\n\n  // Customer settings - update profile\n  app.patch(\"/api/customer/settings\", async (req, res) => {\n    try {\n      const { userId, phoneNumber, email, fullName, paymentPhone, autoRenew, sessionToken } = req.body;\n      \n      if (!userId) {\n        return res.status(400).json({ error: \"User ID is required\" });\n      }\n\n      // Verify session token\n      if (!verifyCustomerSession(sessionToken, userId)) {\n        return res.status(401).json({ error: \"Unauthorized. Please log in again.\" });\n      }\n\n      const wifiUser = await storage.getWifiUser(userId);\n      if (!wifiUser) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      // Build update object with only provided fields\n      const updateData: Partial<{\n        phoneNumber: string;\n        email: string;\n        fullName: string;\n        notes: string;\n      }> = {};\n\n      if (email !== undefined) updateData.email = email;\n      if (fullName !== undefined) updateData.fullName = fullName;\n      \n      // Store payment preferences in notes field as JSON (temporary solution)\n      // In a full implementation, these would be separate database columns\n      let preferences: Record<string, unknown> = {};\n      try {\n        if (wifiUser.notes) {\n          preferences = JSON.parse(wifiUser.notes);\n        }\n      } catch {\n        preferences = {};\n      }\n      \n      if (paymentPhone !== undefined) preferences.paymentPhone = paymentPhone;\n      if (autoRenew !== undefined) preferences.autoRenew = autoRenew;\n      \n      updateData.notes = JSON.stringify(preferences);\n\n      const updatedUser = await storage.updateWifiUser(userId, updateData);\n\n      res.json({\n        success: true,\n        message: \"Settings updated successfully\",\n        user: updatedUser,\n      });\n    } catch (error) {\n      console.error(\"Error updating customer settings:\", error);\n      res.status(500).json({ error: \"Failed to update settings\" });\n    }\n  });\n\n  // Customer settings - get payment preferences\n  app.get(\"/api/customer/settings/:userId\", async (req, res) => {\n    try {\n      const { userId } = req.params;\n      const sessionToken = req.query.sessionToken as string | undefined;\n      \n      // Verify session token\n      if (!verifyCustomerSession(sessionToken, userId)) {\n        return res.status(401).json({ error: \"Unauthorized. Please log in again.\" });\n      }\n      \n      const wifiUser = await storage.getWifiUser(userId);\n      if (!wifiUser) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      // Parse preferences from notes field\n      let preferences: Record<string, unknown> = {\n        paymentPhone: wifiUser.phoneNumber,\n        autoRenew: false,\n      };\n      \n      try {\n        if (wifiUser.notes) {\n          const parsed = JSON.parse(wifiUser.notes);\n          preferences = { ...preferences, ...parsed };\n        }\n      } catch {\n        // Notes is not JSON, keep defaults\n      }\n\n      res.json({\n        email: wifiUser.email || \"\",\n        fullName: wifiUser.fullName || \"\",\n        phoneNumber: wifiUser.phoneNumber,\n        paymentPhone: preferences.paymentPhone || wifiUser.phoneNumber,\n        autoRenew: preferences.autoRenew || false,\n      });\n    } catch (error) {\n      console.error(\"Error fetching customer settings:\", error);\n      res.status(500).json({ error: \"Failed to fetch settings\" });\n    }\n  });\n\n  // ============== ROUTER MONITORING ROUTES ==============\n\n  app.get(\"/api/hotspots/:id/stats\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = req.session.user?.tenantId || defaultTenantId;\n      const hotspot = await storage.getHotspot(req.params.id);\n      \n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n\n      // Try to fetch real stats from MikroTik\n      const mikrotik = await createMikrotikService(hotspot);\n      if (mikrotik) {\n        const resourceResult = await mikrotik.getSystemResources();\n        if (resourceResult.success && resourceResult.data) {\n          const resource = resourceResult.data;\n          const stats = {\n            uptime: resource.uptime || \"Unknown\",\n            cpuLoad: parseInt(resource[\"cpu-load\"] || \"0\"),\n            freeMemory: parseInt(resource[\"free-memory\"] || \"0\"),\n            totalMemory: parseInt(resource[\"total-memory\"] || \"0\"),\n            freeDisk: parseInt(resource[\"free-hdd-space\"] || \"0\"),\n            totalDisk: parseInt(resource[\"total-hdd-space\"] || \"0\"),\n            boardName: resource[\"board-name\"] || \"Unknown\",\n            version: resource.version || \"Unknown\",\n            architecture: resource[\"architecture-name\"] || \"Unknown\",\n          };\n          return res.json(stats);\n        }\n      }\n\n      // Fallback to mock stats if router connection fails\n      const stats = {\n        uptime: \"3d 14h 22m\",\n        cpuLoad: Math.floor(Math.random() * 40) + 10,\n        freeMemory: 128 * 1024 * 1024 + Math.floor(Math.random() * 64 * 1024 * 1024),\n        totalMemory: 256 * 1024 * 1024,\n        freeDisk: 32 * 1024 * 1024 + Math.floor(Math.random() * 16 * 1024 * 1024),\n        totalDisk: 64 * 1024 * 1024,\n        boardName: \"hAP ac2 (Demo)\",\n        version: \"7.12.1\",\n        architecture: \"arm\",\n      };\n\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching router stats:\", error);\n      res.status(500).json({ error: \"Failed to fetch router stats\" });\n    }\n  });\n\n  app.get(\"/api/hotspots/:id/interfaces\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = req.session.user?.tenantId || defaultTenantId;\n      const hotspot = await storage.getHotspot(req.params.id);\n      \n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n\n      // Try to fetch real interface data from MikroTik\n      const mikrotik = await createMikrotikService(hotspot);\n      if (mikrotik) {\n        const interfaceResult = await mikrotik.getInterfaceStats();\n        if (interfaceResult.success && Array.isArray(interfaceResult.data)) {\n          const interfaces = interfaceResult.data.map((iface: any) => ({\n            name: iface.name || \"Unknown\",\n            type: iface.type || \"ethernet\",\n            rxBytes: parseInt(iface[\"rx-byte\"] || \"0\"),\n            txBytes: parseInt(iface[\"tx-byte\"] || \"0\"),\n            rxPackets: parseInt(iface[\"rx-packet\"] || \"0\"),\n            txPackets: parseInt(iface[\"tx-packet\"] || \"0\"),\n            running: iface.running === \"true\" || iface.running === true,\n            disabled: iface.disabled === \"true\" || iface.disabled === true,\n          }));\n          return res.json(interfaces);\n        }\n      }\n\n      // Fallback to mock interface data\n      const interfaces = [\n        {\n          name: \"ether1\",\n          type: \"ethernet\",\n          rxBytes: Math.floor(Math.random() * 1024 * 1024 * 1024),\n          txBytes: Math.floor(Math.random() * 512 * 1024 * 1024),\n          rxPackets: Math.floor(Math.random() * 1000000),\n          txPackets: Math.floor(Math.random() * 500000),\n          running: true,\n          disabled: false,\n        },\n        {\n          name: \"wlan1\",\n          type: \"wireless\",\n          rxBytes: Math.floor(Math.random() * 2 * 1024 * 1024 * 1024),\n          txBytes: Math.floor(Math.random() * 1024 * 1024 * 1024),\n          rxPackets: Math.floor(Math.random() * 2000000),\n          txPackets: Math.floor(Math.random() * 1000000),\n          running: true,\n          disabled: false,\n        },\n        {\n          name: \"bridge1\",\n          type: \"bridge\",\n          rxBytes: Math.floor(Math.random() * 3 * 1024 * 1024 * 1024),\n          txBytes: Math.floor(Math.random() * 1.5 * 1024 * 1024 * 1024),\n          rxPackets: Math.floor(Math.random() * 3000000),\n          txPackets: Math.floor(Math.random() * 1500000),\n          running: true,\n          disabled: false,\n        },\n      ];\n\n      res.json(interfaces);\n    } catch (error) {\n      console.error(\"Error fetching interfaces:\", error);\n      res.status(500).json({ error: \"Failed to fetch interfaces\" });\n    }\n  });\n\n  app.get(\"/api/hotspots/:id/sessions\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = req.session.user?.tenantId || defaultTenantId;\n      const hotspot = await storage.getHotspot(req.params.id);\n      \n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n\n      // Try to fetch real sessions from MikroTik\n      const mikrotik = await createMikrotikService(hotspot);\n      if (mikrotik) {\n        const sessionResult = await mikrotik.getActiveSessions();\n        if (sessionResult.success && Array.isArray(sessionResult.data)) {\n          const sessions = sessionResult.data.map((session: any) => ({\n            user: session.user || \"Unknown\",\n            address: session.address || \"0.0.0.0\",\n            macAddress: session[\"mac-address\"] || \"00:00:00:00:00:00\",\n            uptime: session.uptime || \"0s\",\n            bytesIn: parseInt(session[\"bytes-in\"] || \"0\"),\n            bytesOut: parseInt(session[\"bytes-out\"] || \"0\"),\n          }));\n          return res.json(sessions);\n        }\n      }\n\n      // Fallback to mock active sessions\n      const sessions = [\n        {\n          user: \"user001\",\n          address: \"192.168.88.101\",\n          macAddress: \"AA:BB:CC:DD:EE:01\",\n          uptime: \"1h 23m\",\n          bytesIn: Math.floor(Math.random() * 100 * 1024 * 1024),\n          bytesOut: Math.floor(Math.random() * 50 * 1024 * 1024),\n        },\n        {\n          user: \"user002\",\n          address: \"192.168.88.102\",\n          macAddress: \"AA:BB:CC:DD:EE:02\",\n          uptime: \"45m\",\n          bytesIn: Math.floor(Math.random() * 75 * 1024 * 1024),\n          bytesOut: Math.floor(Math.random() * 25 * 1024 * 1024),\n        },\n        {\n          user: \"user003\",\n          address: \"192.168.88.103\",\n          macAddress: \"AA:BB:CC:DD:EE:03\",\n          uptime: \"2h 10m\",\n          bytesIn: Math.floor(Math.random() * 200 * 1024 * 1024),\n          bytesOut: Math.floor(Math.random() * 100 * 1024 * 1024),\n        },\n      ];\n\n      res.json(sessions);\n    } catch (error) {\n      console.error(\"Error fetching sessions:\", error);\n      res.status(500).json({ error: \"Failed to fetch sessions\" });\n    }\n  });\n\n  // Add bandwidth endpoint for real-time data\n  app.get(\"/api/hotspots/:id/bandwidth\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = req.session.user?.tenantId || defaultTenantId;\n      const hotspot = await storage.getHotspot(req.params.id);\n      \n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n\n      const interfaceName = req.query.interface as string || \"ether1\";\n      \n      // Try to fetch real bandwidth from MikroTik\n      const mikrotik = await createMikrotikService(hotspot);\n      if (mikrotik) {\n        const bandwidthResult = await mikrotik.getBandwidthUsage(interfaceName);\n        if (bandwidthResult.success && bandwidthResult.data) {\n          return res.json({\n            upload: parseInt(bandwidthResult.data[\"tx-bits-per-second\"] || \"0\") / 1000000,\n            download: parseInt(bandwidthResult.data[\"rx-bits-per-second\"] || \"0\") / 1000000,\n          });\n        }\n      }\n\n      // Fallback to mock bandwidth data\n      res.json({\n        upload: Math.random() * 50 + 10,\n        download: Math.random() * 100 + 20,\n      });\n    } catch (error) {\n      console.error(\"Error fetching bandwidth:\", error);\n      res.status(500).json({ error: \"Failed to fetch bandwidth\" });\n    }\n  });\n\n  app.post(\"/api/hotspots/:id/reboot\", requireAdmin, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = req.session.user?.tenantId || defaultTenantId;\n      const hotspot = await storage.getHotspot(req.params.id);\n      \n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n\n      // Try to reboot using MikroTik API\n      const mikrotik = await createMikrotikService(hotspot);\n      if (mikrotik) {\n        const rebootResult = await mikrotik.rebootRouter();\n        if (rebootResult.success) {\n          console.log(`[Router] Reboot successful for ${hotspot.locationName} (${hotspot.nasIp})`);\n          return res.json({ \n            success: true, \n            message: `Reboot initiated for ${hotspot.locationName}. Router will be back online in 1-3 minutes.` \n          });\n        } else {\n          console.error(`[Router] Reboot failed for ${hotspot.locationName}: ${rebootResult.error}`);\n        }\n      }\n\n      // Log and return success even if MikroTik connection fails (for demo purposes)\n      console.log(`[Router] Reboot request for ${hotspot.locationName} (no connection or demo mode)`);\n      res.json({ \n        success: true, \n        message: `Reboot initiated for ${hotspot.locationName}. Router will be back online in 1-3 minutes.` \n      });\n    } catch (error) {\n      console.error(\"Error rebooting router:\", error);\n      res.status(500).json({ error: \"Failed to reboot router\" });\n    }\n  });\n\n  // ============== WALLET ROUTES ==============\n\n  // Get wallet balance for a WiFi user\n  app.get(\"/api/wallet/:wifiUserId\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { wifiUserId } = req.params;\n      const tenantId = req.session?.user?.tenantId || defaultTenantId;\n      \n      const wallet = await storage.getWalletByTenantAndUser(tenantId, wifiUserId);\n      \n      if (!wallet) {\n        return res.json({ \n          balance: 0, \n          totalDeposited: 0, \n          totalSpent: 0,\n          hasWallet: false \n        });\n      }\n      \n      res.json({\n        ...wallet,\n        hasWallet: true,\n      });\n    } catch (error) {\n      console.error(\"Error fetching wallet:\", error);\n      res.status(500).json({ error: \"Failed to fetch wallet\" });\n    }\n  });\n\n  // Get wallet transactions for a WiFi user\n  app.get(\"/api/wallet/:wifiUserId/transactions\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { wifiUserId } = req.params;\n      const tenantId = req.session?.user?.tenantId || defaultTenantId;\n      \n      const wallet = await storage.getWalletByTenantAndUser(tenantId, wifiUserId);\n      \n      if (!wallet) {\n        return res.json([]);\n      }\n      \n      const transactions = await storage.getWalletTransactions(wallet.id, 50);\n      res.json(transactions);\n    } catch (error) {\n      console.error(\"Error fetching wallet transactions:\", error);\n      res.status(500).json({ error: \"Failed to fetch wallet transactions\" });\n    }\n  });\n\n  // Deposit to wallet (admin only)\n  app.post(\"/api/wallet/:wifiUserId/deposit\", requireAdmin, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { wifiUserId } = req.params;\n      const { amount, description } = req.body;\n      const tenantId = req.session?.user?.tenantId || defaultTenantId;\n      \n      if (!amount || amount <= 0) {\n        return res.status(400).json({ error: \"Amount must be greater than 0\" });\n      }\n      \n      const result = await storage.depositToWallet(\n        tenantId,\n        wifiUserId,\n        amount,\n        description || \"Manual deposit by admin\",\n        undefined,\n        \"manual\"\n      );\n      \n      res.json({\n        success: true,\n        wallet: result.wallet,\n        transaction: result.transaction,\n      });\n    } catch (error) {\n      console.error(\"Error depositing to wallet:\", error);\n      res.status(500).json({ error: \"Failed to deposit to wallet\" });\n    }\n  });\n\n  // Pay using wallet balance\n  app.post(\"/api/wallet/:wifiUserId/pay\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { wifiUserId } = req.params;\n      const { planId, amount } = req.body;\n      const tenantId = req.session?.user?.tenantId || defaultTenantId;\n      \n      if (!amount || amount <= 0) {\n        return res.status(400).json({ error: \"Amount must be greater than 0\" });\n      }\n      \n      const plan = await storage.getPlan(planId);\n      if (!plan) {\n        return res.status(404).json({ error: \"Plan not found\" });\n      }\n      \n      const result = await storage.deductFromWallet(\n        tenantId,\n        wifiUserId,\n        amount,\n        `Payment for ${plan.name}`,\n        planId,\n        \"plan_purchase\"\n      );\n      \n      if (!result.success) {\n        return res.status(400).json({ error: result.error });\n      }\n      \n      // Activate the user after successful wallet payment\n      const wifiUser = await storage.getWifiUser(wifiUserId);\n      if (wifiUser) {\n        const expiryTime = new Date(Date.now() + plan.durationSeconds * 1000);\n        await storage.updateWifiUser(wifiUserId, {\n          currentPlanId: planId,\n          expiryTime,\n          status: \"ACTIVE\",\n        });\n      }\n      \n      res.json({\n        success: true,\n        wallet: result.wallet,\n        transaction: result.transaction,\n        message: `Successfully activated ${plan.name} using wallet balance`,\n      });\n    } catch (error) {\n      console.error(\"Error processing wallet payment:\", error);\n      res.status(500).json({ error: \"Failed to process wallet payment\" });\n    }\n  });\n\n  // Get all wallets for a tenant (admin view)\n  app.get(\"/api/wallets\", requireAdmin, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = req.session?.user?.tenantId || defaultTenantId;\n      const wallets = await storage.getWalletsByTenant(tenantId);\n      res.json(wallets);\n    } catch (error) {\n      console.error(\"Error fetching wallets:\", error);\n      res.status(500).json({ error: \"Failed to fetch wallets\" });\n    }\n  });\n\n  // Customer portal - Get own wallet (using phone number auth)\n  app.get(\"/api/customer/wallet\", async (req, res) => {\n    try {\n      const phoneNumber = req.query.phone as string;\n      const tenantId = req.query.tenantId as string || defaultTenantId;\n      \n      if (!phoneNumber) {\n        return res.status(400).json({ error: \"Phone number is required\" });\n      }\n      \n      const wifiUser = await storage.getWifiUserByPhone(tenantId, phoneNumber);\n      if (!wifiUser) {\n        return res.json({ balance: 0, hasWallet: false });\n      }\n      \n      const wallet = await storage.getWalletByTenantAndUser(tenantId, wifiUser.id);\n      \n      if (!wallet) {\n        return res.json({ balance: 0, hasWallet: false });\n      }\n      \n      res.json({\n        balance: wallet.balance,\n        totalDeposited: wallet.totalDeposited,\n        totalSpent: wallet.totalSpent,\n        hasWallet: true,\n      });\n    } catch (error) {\n      console.error(\"Error fetching customer wallet:\", error);\n      res.status(500).json({ error: \"Failed to fetch wallet\" });\n    }\n  });\n\n  // Customer portal - Get wallet transaction history\n  app.get(\"/api/customer/wallet/transactions\", async (req, res) => {\n    try {\n      const phoneNumber = req.query.phone as string;\n      const tenantId = req.query.tenantId as string || defaultTenantId;\n      \n      if (!phoneNumber) {\n        return res.status(400).json({ error: \"Phone number is required\" });\n      }\n      \n      const wifiUser = await storage.getWifiUserByPhone(tenantId, phoneNumber);\n      if (!wifiUser) {\n        return res.json([]);\n      }\n      \n      const wallet = await storage.getWalletByTenantAndUser(tenantId, wifiUser.id);\n      if (!wallet) {\n        return res.json([]);\n      }\n      \n      const transactions = await storage.getWalletTransactions(wallet.id, 20);\n      res.json(transactions);\n    } catch (error) {\n      console.error(\"Error fetching customer wallet transactions:\", error);\n      res.status(500).json({ error: \"Failed to fetch wallet transactions\" });\n    }\n  });\n\n  // ============== ZONE ROUTES ==============\n  \n  app.get(\"/api/zones\", requireAuthWithTenant, async (req, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const zones = await storage.getZones(tenantId);\n      res.json(zones);\n    } catch (error) {\n      console.error(\"Error fetching zones:\", error);\n      res.status(500).json({ error: \"Failed to fetch zones\" });\n    }\n  });\n\n  app.get(\"/api/zones/:id\", requireAuthWithTenant, async (req, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const zone = await storage.getZone(req.params.id);\n      if (!zone || zone.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Zone not found\" });\n      }\n      res.json(zone);\n    } catch (error) {\n      console.error(\"Error fetching zone:\", error);\n      res.status(500).json({ error: \"Failed to fetch zone\" });\n    }\n  });\n\n  // Zone create/update schema for validation\n  const zoneCreateSchema = z.object({\n    name: z.string().min(1, \"Zone name is required\").max(100),\n    description: z.string().max(500).optional(),\n    isActive: z.boolean().optional(),\n  });\n\n  const zoneUpdateSchema = zoneCreateSchema.partial();\n\n  app.post(\"/api/zones\", requireAuthWithTenant, requireAdmin, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const parsed = zoneCreateSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid data\", details: parsed.error.errors });\n      }\n      const zone = await storage.createZone({\n        ...parsed.data,\n        tenantId,\n      });\n      res.status(201).json(zone);\n    } catch (error) {\n      console.error(\"Error creating zone:\", error);\n      res.status(500).json({ error: \"Failed to create zone\" });\n    }\n  });\n\n  app.patch(\"/api/zones/:id\", requireAuthWithTenant, requireAdmin, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      // Verify zone belongs to tenant\n      const existingZone = await storage.getZone(req.params.id);\n      if (!existingZone || existingZone.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Zone not found\" });\n      }\n      const parsed = zoneUpdateSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Invalid data\", details: parsed.error.errors });\n      }\n      const zone = await storage.updateZone(req.params.id, parsed.data);\n      res.json(zone);\n    } catch (error) {\n      console.error(\"Error updating zone:\", error);\n      res.status(500).json({ error: \"Failed to update zone\" });\n    }\n  });\n\n  app.delete(\"/api/zones/:id\", requireAuthWithTenant, requireAdmin, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      // Verify zone belongs to tenant\n      const existingZone = await storage.getZone(req.params.id);\n      if (!existingZone || existingZone.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Zone not found\" });\n      }\n      const deleted = await storage.deleteZone(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Zone not found\" });\n      }\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting zone:\", error);\n      res.status(500).json({ error: \"Failed to delete zone\" });\n    }\n  });\n\n  // ============== AUDIT LOG ROUTES ==============\n  \n  app.get(\"/api/audit-logs\", requireAuthWithTenant, requireAdmin, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const limit = parseInt(req.query.limit as string) || 100;\n      const logs = await storage.getAuditLogs(tenantId, limit);\n      res.json(logs);\n    } catch (error) {\n      console.error(\"Error fetching audit logs:\", error);\n      res.status(500).json({ error: \"Failed to fetch audit logs\" });\n    }\n  });\n\n  // ============== CHAT ROUTES ==============\n  \n  // Get chat messages for a specific customer\n  app.get(\"/api/chat/:wifiUserId\", requireAuthWithTenant, async (req, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const messages = await storage.getChatMessages(tenantId, req.params.wifiUserId);\n      // Mark messages as read when admin/tech views them\n      await storage.markMessagesAsRead(tenantId, req.params.wifiUserId);\n      res.json(messages);\n    } catch (error) {\n      console.error(\"Error fetching chat messages:\", error);\n      res.status(500).json({ error: \"Failed to fetch chat messages\" });\n    }\n  });\n\n  // Get all unread chats\n  app.get(\"/api/chat-unread\", requireAuthWithTenant, async (req, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const unread = await storage.getUnreadChats(tenantId);\n      res.json(unread);\n    } catch (error) {\n      console.error(\"Error fetching unread chats:\", error);\n      res.status(500).json({ error: \"Failed to fetch unread chats\" });\n    }\n  });\n\n  // Send a message (admin/tech reply)\n  app.post(\"/api/chat/:wifiUserId\", requireAuthWithTenant, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const { message } = req.body;\n      if (!message) {\n        return res.status(400).json({ error: \"Message is required\" });\n      }\n      const chatMessage = await storage.createChatMessage({\n        tenantId,\n        wifiUserId: req.params.wifiUserId,\n        message,\n        isFromCustomer: false,\n        userId: req.session?.user?.id,\n      });\n      res.status(201).json(chatMessage);\n    } catch (error) {\n      console.error(\"Error sending chat message:\", error);\n      res.status(500).json({ error: \"Failed to send chat message\" });\n    }\n  });\n\n  // Customer portal - send a message\n  app.post(\"/api/customer/chat\", async (req, res) => {\n    try {\n      const { phoneNumber, message, tenantId: reqTenantId } = req.body;\n      const tenantId = reqTenantId || defaultTenantId;\n      \n      if (!phoneNumber || !message) {\n        return res.status(400).json({ error: \"Phone number and message are required\" });\n      }\n      \n      const wifiUser = await storage.getWifiUserByPhone(tenantId, phoneNumber);\n      if (!wifiUser) {\n        return res.status(404).json({ error: \"Customer not found\" });\n      }\n      \n      const chatMessage = await storage.createChatMessage({\n        tenantId,\n        wifiUserId: wifiUser.id,\n        message,\n        isFromCustomer: true,\n      });\n      res.status(201).json(chatMessage);\n    } catch (error) {\n      console.error(\"Error sending customer chat message:\", error);\n      res.status(500).json({ error: \"Failed to send message\" });\n    }\n  });\n\n  // Customer portal - get own chat messages\n  app.get(\"/api/customer/chat\", async (req, res) => {\n    try {\n      const phoneNumber = req.query.phone as string;\n      const tenantId = req.query.tenantId as string || defaultTenantId;\n      \n      if (!phoneNumber) {\n        return res.status(400).json({ error: \"Phone number is required\" });\n      }\n      \n      const wifiUser = await storage.getWifiUserByPhone(tenantId, phoneNumber);\n      if (!wifiUser) {\n        return res.json([]);\n      }\n      \n      const messages = await storage.getChatMessages(tenantId, wifiUser.id);\n      res.json(messages);\n    } catch (error) {\n      console.error(\"Error fetching customer chat messages:\", error);\n      res.status(500).json({ error: \"Failed to fetch messages\" });\n    }\n  });\n\n  // ============== LOYALTY POINTS ROUTES ==============\n  \n  // Get loyalty points for a customer\n  app.get(\"/api/loyalty/:wifiUserId\", requireAuthWithTenant, async (req, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const loyalty = await storage.getLoyaltyPoints(tenantId, req.params.wifiUserId);\n      res.json(loyalty || { points: 0, totalEarned: 0, totalRedeemed: 0 });\n    } catch (error) {\n      console.error(\"Error fetching loyalty points:\", error);\n      res.status(500).json({ error: \"Failed to fetch loyalty points\" });\n    }\n  });\n\n  // Get loyalty transactions for a customer\n  app.get(\"/api/loyalty/:wifiUserId/transactions\", requireAuthWithTenant, async (req, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const loyalty = await storage.getLoyaltyPoints(tenantId, req.params.wifiUserId);\n      if (!loyalty) {\n        return res.json([]);\n      }\n      const transactions = await storage.getLoyaltyTransactions(loyalty.id);\n      res.json(transactions);\n    } catch (error) {\n      console.error(\"Error fetching loyalty transactions:\", error);\n      res.status(500).json({ error: \"Failed to fetch loyalty transactions\" });\n    }\n  });\n\n  // Add loyalty points (admin action)\n  app.post(\"/api/loyalty/:wifiUserId/add\", requireAdmin, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const { points, description } = req.body;\n      if (!points || points <= 0) {\n        return res.status(400).json({ error: \"Valid points amount is required\" });\n      }\n      const loyalty = await storage.addLoyaltyPoints(tenantId, req.params.wifiUserId, points, description);\n      res.json(loyalty);\n    } catch (error) {\n      console.error(\"Error adding loyalty points:\", error);\n      res.status(500).json({ error: \"Failed to add loyalty points\" });\n    }\n  });\n\n  // Redeem loyalty points (admin action)\n  app.post(\"/api/loyalty/:wifiUserId/redeem\", requireAdmin, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(401).json({ error: \"Authentication required\" });\n      }\n      const { points, description } = req.body;\n      if (!points || points <= 0) {\n        return res.status(400).json({ error: \"Valid points amount is required\" });\n      }\n      const loyalty = await storage.redeemLoyaltyPoints(tenantId, req.params.wifiUserId, points, description);\n      if (!loyalty) {\n        return res.status(400).json({ error: \"Insufficient points balance\" });\n      }\n      res.json(loyalty);\n    } catch (error) {\n      console.error(\"Error redeeming loyalty points:\", error);\n      res.status(500).json({ error: \"Failed to redeem loyalty points\" });\n    }\n  });\n\n  // Customer portal - get own loyalty points\n  app.get(\"/api/customer/loyalty\", async (req, res) => {\n    try {\n      const phoneNumber = req.query.phone as string;\n      const tenantId = req.query.tenantId as string || defaultTenantId;\n      \n      if (!phoneNumber) {\n        return res.status(400).json({ error: \"Phone number is required\" });\n      }\n      \n      const wifiUser = await storage.getWifiUserByPhone(tenantId, phoneNumber);\n      if (!wifiUser) {\n        return res.json({ points: 0, totalEarned: 0, totalRedeemed: 0 });\n      }\n      \n      const loyalty = await storage.getLoyaltyPoints(tenantId, wifiUser.id);\n      res.json(loyalty || { points: 0, totalEarned: 0, totalRedeemed: 0 });\n    } catch (error) {\n      console.error(\"Error fetching customer loyalty points:\", error);\n      res.status(500).json({ error: \"Failed to fetch loyalty points\" });\n    }\n  });\n\n  // ============== NETWORK MANAGEMENT ROUTES ==============\n\n  // Test router connection\n  app.post(\"/api/hotspots/:id/test-connection\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured for this hotspot\" });\n      }\n      \n      const result = await mikrotik.fullConnectionTest();\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error testing router connection:\", error);\n      res.status(500).json({ error: \"Failed to test router connection\" });\n    }\n  });\n\n  // Get router system resources\n  app.get(\"/api/hotspots/:id/stats\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const resources = await mikrotik.getSystemResources();\n      if (!resources.success) {\n        return res.status(500).json({ error: resources.error });\n      }\n      \n      const data = Array.isArray(resources.data) ? resources.data[0] : resources.data;\n      res.json({\n        uptime: data?.uptime || \"unknown\",\n        cpuLoad: parseInt(data?.[\"cpu-load\"] || \"0\"),\n        freeMemory: parseInt(data?.[\"free-memory\"] || \"0\"),\n        totalMemory: parseInt(data?.[\"total-memory\"] || \"0\"),\n        freeDisk: parseInt(data?.[\"free-hdd-space\"] || \"0\"),\n        totalDisk: parseInt(data?.[\"total-hdd-space\"] || \"0\"),\n        boardName: data?.[\"board-name\"] || \"unknown\",\n        version: data?.version || \"unknown\",\n        architecture: data?.[\"architecture-name\"] || \"unknown\",\n      });\n    } catch (error) {\n      console.error(\"Error fetching router stats:\", error);\n      res.status(500).json({ error: \"Failed to fetch router stats\" });\n    }\n  });\n\n  // Get router interfaces\n  app.get(\"/api/hotspots/:id/interfaces\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.getInterfaceStats();\n      if (!result.success) {\n        return res.status(500).json({ error: result.error });\n      }\n      \n      const interfaces = (result.data || []).map((iface: any) => ({\n        name: iface.name,\n        type: iface.type,\n        rxBytes: parseInt(iface[\"rx-byte\"] || \"0\"),\n        txBytes: parseInt(iface[\"tx-byte\"] || \"0\"),\n        rxPackets: parseInt(iface[\"rx-packet\"] || \"0\"),\n        txPackets: parseInt(iface[\"tx-packet\"] || \"0\"),\n        running: iface.running === \"true\",\n        disabled: iface.disabled === \"true\",\n      }));\n      \n      res.json(interfaces);\n    } catch (error) {\n      console.error(\"Error fetching interfaces:\", error);\n      res.status(500).json({ error: \"Failed to fetch interfaces\" });\n    }\n  });\n\n  // Get active sessions\n  app.get(\"/api/hotspots/:id/sessions\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.getActiveSessions();\n      if (!result.success) {\n        return res.status(500).json({ error: result.error });\n      }\n      \n      const sessions = (result.data || []).map((session: any) => ({\n        id: session[\".id\"],\n        user: session.user,\n        address: session.address,\n        macAddress: session[\"mac-address\"],\n        uptime: session.uptime,\n        bytesIn: parseInt(session[\"bytes-in\"] || \"0\"),\n        bytesOut: parseInt(session[\"bytes-out\"] || \"0\"),\n      }));\n      \n      res.json(sessions);\n    } catch (error) {\n      console.error(\"Error fetching sessions:\", error);\n      res.status(500).json({ error: \"Failed to fetch sessions\" });\n    }\n  });\n\n  // Disconnect session\n  app.delete(\"/api/hotspots/:id/sessions/:sessionId\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id, sessionId } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.disconnectSession(sessionId);\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error disconnecting session:\", error);\n      res.status(500).json({ error: \"Failed to disconnect session\" });\n    }\n  });\n\n  // Get firewall rules\n  app.get(\"/api/hotspots/:id/firewall/:type\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id, type } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      let result;\n      switch (type) {\n        case \"filter\":\n          result = await mikrotik.getFirewallFilterRules();\n          break;\n        case \"nat\":\n          result = await mikrotik.getFirewallNatRules();\n          break;\n        case \"mangle\":\n          result = await mikrotik.getFirewallMangleRules();\n          break;\n        default:\n          return res.status(400).json({ error: \"Invalid firewall type\" });\n      }\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching firewall rules:\", error);\n      res.status(500).json({ error: \"Failed to fetch firewall rules\" });\n    }\n  });\n\n  // Toggle firewall rule\n  app.patch(\"/api/hotspots/:id/firewall/:type/:ruleId\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id, type, ruleId } = req.params;\n      const { action } = req.body;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const firewallType = type as \"filter\" | \"nat\" | \"mangle\";\n      let result;\n      if (action === \"enable\") {\n        result = await mikrotik.enableFirewallRule(ruleId, firewallType);\n      } else if (action === \"disable\") {\n        result = await mikrotik.disableFirewallRule(ruleId, firewallType);\n      } else {\n        return res.status(400).json({ error: \"Invalid action\" });\n      }\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"Error toggling firewall rule:\", error);\n      res.status(500).json({ error: \"Failed to toggle firewall rule\" });\n    }\n  });\n\n  // Get IP pools\n  app.get(\"/api/hotspots/:id/ip-pools\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.getIpPools();\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching IP pools:\", error);\n      res.status(500).json({ error: \"Failed to fetch IP pools\" });\n    }\n  });\n\n  // Add IP pool\n  app.post(\"/api/hotspots/:id/ip-pools\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const { name, ranges } = req.body;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.addIpPool(name, ranges);\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error adding IP pool:\", error);\n      res.status(500).json({ error: \"Failed to add IP pool\" });\n    }\n  });\n\n  // Delete IP pool\n  app.delete(\"/api/hotspots/:id/ip-pools/:poolId\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id, poolId } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.deleteIpPool(poolId);\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error deleting IP pool:\", error);\n      res.status(500).json({ error: \"Failed to delete IP pool\" });\n    }\n  });\n\n  // Get DHCP leases\n  app.get(\"/api/hotspots/:id/dhcp-leases\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.getDHCPLeases();\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching DHCP leases:\", error);\n      res.status(500).json({ error: \"Failed to fetch DHCP leases\" });\n    }\n  });\n\n  // Release DHCP lease\n  app.delete(\"/api/hotspots/:id/dhcp-leases/:leaseId\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id, leaseId } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.releaseDhcpLease(leaseId);\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error releasing DHCP lease:\", error);\n      res.status(500).json({ error: \"Failed to release DHCP lease\" });\n    }\n  });\n\n  // Get ARP table\n  app.get(\"/api/hotspots/:id/arp\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.getArpTable();\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching ARP table:\", error);\n      res.status(500).json({ error: \"Failed to fetch ARP table\" });\n    }\n  });\n\n  // Get routes\n  app.get(\"/api/hotspots/:id/routes\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.getRoutes();\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching routes:\", error);\n      res.status(500).json({ error: \"Failed to fetch routes\" });\n    }\n  });\n\n  // Get simple queues\n  app.get(\"/api/hotspots/:id/queues\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.getSimpleQueues();\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching queues:\", error);\n      res.status(500).json({ error: \"Failed to fetch queues\" });\n    }\n  });\n\n  // Get walled garden from router\n  app.get(\"/api/hotspots/:id/walled-garden-router\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.getWalledGardenEntries();\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching walled garden:\", error);\n      res.status(500).json({ error: \"Failed to fetch walled garden\" });\n    }\n  });\n\n  // Sync walled garden to router\n  app.post(\"/api/hotspots/:id/sync-walled-garden\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const walledGardens = await storage.getWalledGardens(tenantId);\n      const entries = walledGardens.map(wg => ({\n        domain: wg.domain,\n        description: wg.description || undefined,\n      }));\n      \n      const result = await mikrotik.syncWalledGarden(entries);\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error syncing walled garden:\", error);\n      res.status(500).json({ error: \"Failed to sync walled garden\" });\n    }\n  });\n\n  // Create router backup\n  app.post(\"/api/hotspots/:id/backup\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const { name, notes } = req.body;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const [identityResult, resourceResult, exportResult] = await Promise.all([\n        mikrotik.getRouterIdentity(),\n        mikrotik.getSystemResources(),\n        mikrotik.exportConfig(),\n      ]);\n      \n      const identity = identityResult.data?.[0]?.name || identityResult.data?.name || \"unknown\";\n      const version = resourceResult.data?.[0]?.version || resourceResult.data?.version || \"unknown\";\n      const configData = typeof exportResult.data === \"string\" ? exportResult.data : JSON.stringify(exportResult.data);\n      \n      const backup = await storage.createRouterBackup({\n        tenantId,\n        hotspotId: id,\n        name: name || `Backup ${new Date().toISOString()}`,\n        type: \"export\",\n        routerVersion: version,\n        routerIdentity: identity,\n        configData,\n        notes,\n      });\n      \n      res.json({ success: true, backup });\n    } catch (error) {\n      console.error(\"Error creating backup:\", error);\n      res.status(500).json({ error: \"Failed to create backup\" });\n    }\n  });\n\n  // Get router backups\n  app.get(\"/api/hotspots/:id/backups\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const backups = await storage.getRouterBackups(tenantId, id);\n      res.json(backups);\n    } catch (error) {\n      console.error(\"Error fetching backups:\", error);\n      res.status(500).json({ error: \"Failed to fetch backups\" });\n    }\n  });\n\n  // Download backup\n  app.get(\"/api/router-backups/:backupId/download\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { backupId } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const backup = await storage.getRouterBackup(backupId);\n      if (!backup || backup.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Backup not found\" });\n      }\n      \n      const filename = `${backup.name.replace(/[^a-z0-9]/gi, \"_\")}_${backup.routerIdentity}.rsc`;\n      res.setHeader(\"Content-Type\", \"text/plain\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"${filename}\"`);\n      res.send(backup.configData || \"\");\n    } catch (error) {\n      console.error(\"Error downloading backup:\", error);\n      res.status(500).json({ error: \"Failed to download backup\" });\n    }\n  });\n\n  // Delete backup\n  app.delete(\"/api/router-backups/:backupId\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { backupId } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const backup = await storage.getRouterBackup(backupId);\n      if (!backup || backup.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Backup not found\" });\n      }\n      \n      await storage.deleteRouterBackup(backupId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting backup:\", error);\n      res.status(500).json({ error: \"Failed to delete backup\" });\n    }\n  });\n\n  // Reboot router\n  app.post(\"/api/hotspots/:id/reboot\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.rebootRouter();\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error rebooting router:\", error);\n      res.status(500).json({ error: \"Failed to reboot router\" });\n    }\n  });\n\n  // Get hotspot servers on router\n  app.get(\"/api/hotspots/:id/hotspot-servers\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.getHotspotServers();\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching hotspot servers:\", error);\n      res.status(500).json({ error: \"Failed to fetch hotspot servers\" });\n    }\n  });\n\n  // Get user profiles on router\n  app.get(\"/api/hotspots/:id/user-profiles\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.getHotspotProfiles();\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching user profiles:\", error);\n      res.status(500).json({ error: \"Failed to fetch user profiles\" });\n    }\n  });\n\n  // Get router logs\n  app.get(\"/api/hotspots/:id/logs\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const { topics } = req.query;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.getLogs(topics as string | undefined);\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching logs:\", error);\n      res.status(500).json({ error: \"Failed to fetch logs\" });\n    }\n  });\n\n  // Get DNS settings\n  app.get(\"/api/hotspots/:id/dns\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const hotspot = await storage.getHotspot(id);\n      if (!hotspot || hotspot.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Hotspot not found\" });\n      }\n      \n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        return res.status(400).json({ error: \"Router API not configured\" });\n      }\n      \n      const result = await mikrotik.getDnsSettings();\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching DNS settings:\", error);\n      res.status(500).json({ error: \"Failed to fetch DNS settings\" });\n    }\n  });\n\n  // ============== LOGIN PAGE TEMPLATES ==============\n\n  // Get login page templates\n  app.get(\"/api/login-templates\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const templates = await storage.getLoginPageTemplates(tenantId);\n      res.json(templates);\n    } catch (error) {\n      console.error(\"Error fetching login templates:\", error);\n      res.status(500).json({ error: \"Failed to fetch login templates\" });\n    }\n  });\n\n  // Create login page template\n  app.post(\"/api/login-templates\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const template = await storage.createLoginPageTemplate({\n        ...req.body,\n        tenantId,\n      });\n      res.json(template);\n    } catch (error) {\n      console.error(\"Error creating login template:\", error);\n      res.status(500).json({ error: \"Failed to create login template\" });\n    }\n  });\n\n  // Update login page template\n  app.patch(\"/api/login-templates/:id\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const template = await storage.updateLoginPageTemplate(id, req.body);\n      res.json(template);\n    } catch (error) {\n      console.error(\"Error updating login template:\", error);\n      res.status(500).json({ error: \"Failed to update login template\" });\n    }\n  });\n\n  // Delete login page template\n  app.delete(\"/api/login-templates/:id\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      await storage.deleteLoginPageTemplate(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting login template:\", error);\n      res.status(500).json({ error: \"Failed to delete login template\" });\n    }\n  });\n\n  // RouterOS Terminal - Execute command on router\n  app.post(\"/api/terminal/execute\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const { hotspotId, command } = req.body;\n      \n      if (!hotspotId || !command) {\n        return res.status(400).json({ error: \"Hotspot ID and command are required\" });\n      }\n      \n      // Security: Block dangerous commands\n      const blockedCommands = [\n        '/system reset-configuration',\n        '/system package update install',\n        '/file remove',\n        '/user remove',\n        '/user set',\n        '/password',\n        '/system identity set',\n      ];\n      \n      const lowerCommand = command.toLowerCase().trim();\n      for (const blocked of blockedCommands) {\n        if (lowerCommand.includes(blocked.toLowerCase())) {\n          return res.status(403).json({ \n            error: `Command blocked for security reasons: ${blocked}` \n          });\n        }\n      }\n      \n      // Get hotspot and verify tenant ownership\n      const hotspot = await storage.getHotspotByTenant(hotspotId, tenantId);\n      if (!hotspot) {\n        return res.status(404).json({ error: \"Router not found or access denied\" });\n      }\n      \n      const mikrotik = createMikrotikService(hotspot);\n      \n      // Parse command and execute via REST API\n      // Commands are in format: /path/to/resource [action] [params]\n      // Convert to REST API format\n      let apiPath = command.trim();\n      let method: \"GET\" | \"POST\" | \"DELETE\" = \"GET\";\n      let body: any = undefined;\n      \n      // Handle print commands (GET)\n      if (apiPath.includes(' print') || apiPath.endsWith(' print')) {\n        apiPath = apiPath.replace(' print', '');\n        method = \"GET\";\n      }\n      // Handle add commands (POST)\n      else if (apiPath.includes(' add ')) {\n        const parts = apiPath.split(' add ');\n        apiPath = parts[0];\n        method = \"POST\";\n        // Parse key=value pairs\n        const params = parts[1].split(' ');\n        body = {};\n        for (const param of params) {\n          if (param.includes('=')) {\n            const [key, value] = param.split('=');\n            body[key] = value.replace(/\"/g, '');\n          }\n        }\n      }\n      // Handle remove commands (DELETE)\n      else if (apiPath.includes(' remove ')) {\n        const parts = apiPath.split(' remove ');\n        apiPath = parts[0] + '/' + parts[1];\n        method = \"DELETE\";\n      }\n      \n      // Convert CLI path to REST path\n      // /ip/hotspot/user -> /rest/ip/hotspot/user\n      apiPath = apiPath.replace(/^\\//, '');\n      const restPath = '/rest/' + apiPath.replace(/ /g, '/');\n      \n      // Execute via MikroTik API\n      const result = await mikrotik.executeCommand(restPath, method, body);\n      \n      if (result.success) {\n        res.json({\n          success: true,\n          output: result.data,\n          command,\n          timestamp: new Date().toISOString(),\n        });\n      } else {\n        res.json({\n          success: false,\n          error: result.error,\n          command,\n          timestamp: new Date().toISOString(),\n        });\n      }\n    } catch (error) {\n      console.error(\"Error executing terminal command:\", error);\n      res.status(500).json({ error: \"Failed to execute command\" });\n    }\n  });\n\n  // Get predefined RouterOS commands\n  app.get(\"/api/terminal/commands\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    const predefinedCommands = [\n      { category: \"System\", commands: [\n        { label: \"System Resources\", command: \"/system/resource\", description: \"View CPU, memory, uptime\" },\n        { label: \"System Identity\", command: \"/system/identity\", description: \"View router identity\" },\n        { label: \"System Clock\", command: \"/system/clock\", description: \"View system time\" },\n        { label: \"System History\", command: \"/system/history\", description: \"View change history\" },\n      ]},\n      { category: \"Interfaces\", commands: [\n        { label: \"All Interfaces\", command: \"/interface\", description: \"List all interfaces\" },\n        { label: \"Interface Stats\", command: \"/interface/ethernet\", description: \"Ethernet interfaces\" },\n        { label: \"Wireless Interfaces\", command: \"/interface/wireless\", description: \"Wireless interfaces\" },\n        { label: \"Bridge\", command: \"/interface/bridge\", description: \"Bridge interfaces\" },\n      ]},\n      { category: \"IP\", commands: [\n        { label: \"IP Addresses\", command: \"/ip/address\", description: \"View IP addresses\" },\n        { label: \"DHCP Leases\", command: \"/ip/dhcp-server/lease\", description: \"Active DHCP leases\" },\n        { label: \"ARP Table\", command: \"/ip/arp\", description: \"ARP entries\" },\n        { label: \"Routes\", command: \"/ip/route\", description: \"Routing table\" },\n        { label: \"DNS Cache\", command: \"/ip/dns/cache\", description: \"DNS cache entries\" },\n      ]},\n      { category: \"Hotspot\", commands: [\n        { label: \"Hotspot Users\", command: \"/ip/hotspot/user\", description: \"All hotspot users\" },\n        { label: \"Active Sessions\", command: \"/ip/hotspot/active\", description: \"Active hotspot sessions\" },\n        { label: \"User Profiles\", command: \"/ip/hotspot/user/profile\", description: \"Hotspot profiles\" },\n        { label: \"Hotspot Hosts\", command: \"/ip/hotspot/host\", description: \"Connected hosts\" },\n        { label: \"Hotspot Servers\", command: \"/ip/hotspot\", description: \"Hotspot server config\" },\n      ]},\n      { category: \"PPPoE\", commands: [\n        { label: \"PPP Secrets\", command: \"/ppp/secret\", description: \"PPP/PPPoE users\" },\n        { label: \"Active PPPoE\", command: \"/ppp/active\", description: \"Active PPPoE sessions\" },\n        { label: \"PPP Profiles\", command: \"/ppp/profile\", description: \"PPP profiles\" },\n      ]},\n      { category: \"Firewall\", commands: [\n        { label: \"Filter Rules\", command: \"/ip/firewall/filter\", description: \"Firewall filter rules\" },\n        { label: \"NAT Rules\", command: \"/ip/firewall/nat\", description: \"NAT rules\" },\n        { label: \"Mangle Rules\", command: \"/ip/firewall/mangle\", description: \"Mangle rules\" },\n        { label: \"Address Lists\", command: \"/ip/firewall/address-list\", description: \"Address lists\" },\n      ]},\n      { category: \"Queues\", commands: [\n        { label: \"Simple Queues\", command: \"/queue/simple\", description: \"Simple queues\" },\n        { label: \"Queue Tree\", command: \"/queue/tree\", description: \"Queue tree\" },\n        { label: \"Queue Types\", command: \"/queue/type\", description: \"Queue types\" },\n      ]},\n      { category: \"Logs\", commands: [\n        { label: \"System Log\", command: \"/log\", description: \"View system logs\" },\n      ]},\n    ];\n    \n    res.json(predefinedCommands);\n  });\n\n  // Generate and download login page files\n  app.get(\"/api/login-templates/:id/download\", requireAuth, async (req: AuthenticatedRequest, res) => {\n    try {\n      const { id } = req.params;\n      const tenantId = getSessionTenantId(req);\n      if (!tenantId) {\n        return res.status(400).json({ error: \"Tenant context required\" });\n      }\n      \n      const template = await storage.getLoginPageTemplate(id);\n      if (!template || template.tenantId !== tenantId) {\n        return res.status(404).json({ error: \"Template not found\" });\n      }\n      \n      const tenant = await storage.getTenant(tenantId);\n      const config = template.config || {};\n      \n      const loginHtml = generateLoginPageHtml(config, tenant);\n      \n      res.setHeader(\"Content-Type\", \"text/html\");\n      res.setHeader(\"Content-Disposition\", `attachment; filename=\"login.html\"`);\n      res.send(loginHtml);\n    } catch (error) {\n      console.error(\"Error generating login page:\", error);\n      res.status(500).json({ error: \"Failed to generate login page\" });\n    }\n  });\n\n  return httpServer;\n}\n\n// Initialize default tenant with sample data\nasync function initializeDefaultTenant(): Promise<string> {\n  try {\n    // Try to find demo tenant by subdomain\n    let tenant = await storage.getTenantBySubdomain(\"demo\");\n    \n    if (!tenant) {\n      // Create default tenant\n      tenant = await storage.createTenant({\n        name: \"MnetiFi Demo\",\n        subdomain: \"demo\",\n      });\n      \n      console.log(\"Created default tenant:\", tenant.id);\n    }\n\n    // Check if we have sample plans\n    const plans = await storage.getPlans(tenant.id);\n    if (plans.length === 0) {\n      // Create sample plans\n      await storage.createPlan({\n        tenantId: tenant.id,\n        name: \"30 Minutes\",\n        description: \"Quick access for light browsing\",\n        price: 10,\n        durationSeconds: 1800,\n        uploadLimit: \"1M\",\n        downloadLimit: \"2M\",\n        simultaneousUse: 1,\n        sortOrder: 1,\n      });\n\n      await storage.createPlan({\n        tenantId: tenant.id,\n        name: \"1 Hour\",\n        description: \"Standard browsing session\",\n        price: 20,\n        durationSeconds: 3600,\n        uploadLimit: \"2M\",\n        downloadLimit: \"5M\",\n        simultaneousUse: 1,\n        sortOrder: 2,\n      });\n\n      await storage.createPlan({\n        tenantId: tenant.id,\n        name: \"Daily Pass\",\n        description: \"Full day unlimited access\",\n        price: 100,\n        durationSeconds: 86400,\n        uploadLimit: \"5M\",\n        downloadLimit: \"10M\",\n        simultaneousUse: 2,\n        sortOrder: 3,\n      });\n\n      await storage.createPlan({\n        tenantId: tenant.id,\n        name: \"Weekly Pass\",\n        description: \"Best value for regular users\",\n        price: 500,\n        durationSeconds: 604800,\n        uploadLimit: \"10M\",\n        downloadLimit: \"20M\",\n        simultaneousUse: 3,\n        sortOrder: 4,\n      });\n\n      console.log(\"Created sample plans\");\n    }\n\n    // Check if we have sample walled garden entries\n    const walledGardens = await storage.getWalledGardens(tenant.id);\n    if (walledGardens.length === 0) {\n      // Create default walled garden entries for M-Pesa\n      await storage.createWalledGarden({\n        tenantId: tenant.id,\n        domain: \"safaricom.co.ke\",\n        description: \"M-Pesa main domain\",\n      });\n\n      await storage.createWalledGarden({\n        tenantId: tenant.id,\n        domain: \"sandbox.safaricom.co.ke\",\n        description: \"M-Pesa sandbox for testing\",\n      });\n\n      await storage.createWalledGarden({\n        tenantId: tenant.id,\n        domain: \"api.safaricom.co.ke\",\n        description: \"M-Pesa API endpoint\",\n      });\n\n      console.log(\"Created sample walled garden entries\");\n    }\n\n    // Check if we have an admin user\n    const adminUser = await storage.getUserByUsername(\"admin\");\n    if (!adminUser) {\n      await storage.createUser({\n        tenantId: tenant.id,\n        username: \"admin\",\n        password: \"admin123\",\n        email: \"admin@mnetifi.local\",\n        role: \"admin\",\n      });\n      console.log(\"Created default admin user (username: admin, password: admin123)\");\n    }\n\n    return tenant.id;\n  } catch (error) {\n    console.error(\"Error initializing default tenant:\", error);\n    throw error;\n  }\n}\n","path":null,"size_bytes":192404,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route, Redirect } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { DashboardLayout } from \"@/layouts/dashboard-layout\";\nimport { SuperAdminLayout } from \"@/layouts/superadmin-layout\";\nimport { TechLayout } from \"@/layouts/tech-layout\";\nimport { SettingsLayout } from \"@/layouts/settings-layout\";\nimport LandingPage from \"@/pages/landing\";\nimport CaptivePortal from \"@/pages/captive-portal\";\nimport CustomerPortal from \"@/pages/customer-portal\";\nimport LoginPage from \"@/pages/login\";\nimport RegisterPage from \"@/pages/register\";\nimport ForgotPasswordPage from \"@/pages/forgot-password\";\nimport VerifyEmailPage from \"@/pages/verify-email\";\nimport SuperAdminLoginPage from \"@/pages/superadmin-login\";\nimport SuperAdminForgotPasswordPage from \"@/pages/superadmin-forgot-password\";\nimport SuperAdminRegisterPage from \"@/pages/superadmin-register\";\nimport Dashboard from \"@/pages/dashboard\";\nimport PlansPage from \"@/pages/plans\";\nimport PPPoEPlansPage from \"@/pages/pppoe-plans\";\nimport StaticPlansPage from \"@/pages/static-plans\";\nimport HotspotPlansPage from \"@/pages/hotspot-plans\";\nimport HotspotsPage from \"@/pages/hotspots\";\nimport TransactionsPage from \"@/pages/transactions\";\nimport WalledGardenPage from \"@/pages/walled-garden-page\";\nimport WifiUsersPage from \"@/pages/wifi-users\";\nimport CustomerDetailsPage from \"@/pages/customer-details\";\nimport TicketsPage from \"@/pages/tickets\";\nimport ReconciliationPage from \"@/pages/reconciliation\";\nimport ProfileSettingsPage from \"@/pages/settings/profile\";\nimport PaymentGatewayPage from \"@/pages/settings/payment-gateway\";\nimport HotspotSettingsPage from \"@/pages/settings/hotspot-settings\";\nimport BackupRestorePage from \"@/pages/settings/backup-restore\";\nimport MikroTikImportPage from \"@/pages/settings/mikrotik-import\";\nimport ClearCachePage from \"@/pages/settings/clear-cache\";\nimport SmsCampaignsPage from \"@/pages/sms-campaigns\";\nimport NetworkMonitoringPage from \"@/pages/network-monitoring\";\nimport RouterTerminalPage from \"@/pages/router-terminal\";\nimport VouchersPage from \"@/pages/vouchers\";\nimport ReportsPage from \"@/pages/reports\";\nimport SuperAdminDashboard from \"@/pages/superadmin-dashboard\";\nimport SuperAdminTenantsPage from \"@/pages/superadmin-tenants\";\nimport SuperAdminTenantDetailsPage from \"@/pages/superadmin-tenant-details\";\nimport SuperAdminUsersPage from \"@/pages/superadmin-users\";\nimport SuperAdminSmsSettingsPage from \"@/pages/superadmin-sms-settings\";\nimport TechDashboard from \"@/pages/tech-dashboard\";\nimport TechPPPoEUsersPage from \"@/pages/tech-pppoe-users\";\nimport TechStaticUsersPage from \"@/pages/tech-static-users\";\nimport ZonesPage from \"@/pages/zones\";\nimport ChatPage from \"@/pages/chat\";\nimport LoyaltyPage from \"@/pages/loyalty\";\nimport SecuritySettingsPage from \"@/pages/security-settings\";\nimport VoucherVerifyPage from \"@/pages/voucher-verify\";\nimport UpgradePage from \"@/pages/upgrade\";\nimport PortalDesignerPage from \"@/pages/portal-designer\";\nimport NotFound from \"@/pages/not-found\";\n\nfunction Router() {\n  return (\n    <Switch>\n      {/* Landing Page - Official Website */}\n      <Route path=\"/\" component={LandingPage} />\n      \n      {/* Captive Portal - Public facing */}\n      <Route path=\"/portal\" component={CaptivePortal} />\n      \n      {/* Voucher Verification - Public facing */}\n      <Route path=\"/verify-voucher\" component={VoucherVerifyPage} />\n      \n      {/* Customer Portal - Self-service for WiFi users */}\n      <Route path=\"/my-account\" component={CustomerPortal} />\n      \n      {/* Auth Pages */}\n      <Route path=\"/login\" component={LoginPage} />\n      <Route path=\"/register\" component={RegisterPage} />\n      <Route path=\"/verify-email\" component={VerifyEmailPage} />\n      <Route path=\"/forgot-password\" component={ForgotPasswordPage} />\n\n      {/* Dashboard Routes - Admin area */}\n      <Route path=\"/dashboard\">\n        {() => (\n          <DashboardLayout>\n            <Dashboard />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/plans\">\n        {() => (\n          <DashboardLayout>\n            <PlansPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/pppoe-plans\">\n        {() => (\n          <DashboardLayout>\n            <PPPoEPlansPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/static-plans\">\n        {() => (\n          <DashboardLayout>\n            <StaticPlansPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/hotspot-plans\">\n        {() => (\n          <DashboardLayout>\n            <HotspotPlansPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/portal-designer\">\n        {() => (\n          <DashboardLayout>\n            <PortalDesignerPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/hotspots\">\n        {() => (\n          <DashboardLayout>\n            <HotspotsPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/transactions\">\n        {() => (\n          <DashboardLayout>\n            <TransactionsPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/walled-garden\">\n        {() => (\n          <DashboardLayout>\n            <WalledGardenPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/wifi-users\">\n        {() => (\n          <DashboardLayout>\n            <WifiUsersPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/wifi-users/:id\">\n        {() => (\n          <DashboardLayout>\n            <CustomerDetailsPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/tickets\">\n        {() => (\n          <DashboardLayout>\n            <TicketsPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/reconciliation\">\n        {() => (\n          <DashboardLayout>\n            <ReconciliationPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/settings\">\n        {() => <Redirect to=\"/dashboard/settings/profile\" />}\n      </Route>\n      <Route path=\"/dashboard/settings/profile\">\n        {() => (\n          <DashboardLayout>\n            <SettingsLayout>\n              <ProfileSettingsPage />\n            </SettingsLayout>\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/settings/hotspot-settings\">\n        {() => (\n          <DashboardLayout>\n            <SettingsLayout>\n              <HotspotSettingsPage />\n            </SettingsLayout>\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/settings/payment-gateway\">\n        {() => (\n          <DashboardLayout>\n            <SettingsLayout>\n              <PaymentGatewayPage />\n            </SettingsLayout>\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/settings/backup-restore\">\n        {() => (\n          <DashboardLayout>\n            <SettingsLayout>\n              <BackupRestorePage />\n            </SettingsLayout>\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/settings/mikrotik-import\">\n        {() => (\n          <DashboardLayout>\n            <SettingsLayout>\n              <MikroTikImportPage />\n            </SettingsLayout>\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/settings/clear-cache\">\n        {() => (\n          <DashboardLayout>\n            <SettingsLayout>\n              <ClearCachePage />\n            </SettingsLayout>\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/sms-campaigns\">\n        {() => (\n          <DashboardLayout>\n            <SmsCampaignsPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/network-monitoring\">\n        {() => (\n          <DashboardLayout>\n            <NetworkMonitoringPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/router-terminal\">\n        {() => (\n          <DashboardLayout>\n            <RouterTerminalPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/vouchers\">\n        {() => (\n          <DashboardLayout>\n            <VouchersPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/reports\">\n        {() => (\n          <DashboardLayout>\n            <ReportsPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/zones\">\n        {() => (\n          <DashboardLayout>\n            <ZonesPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/chat\">\n        {() => (\n          <DashboardLayout>\n            <ChatPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/loyalty\">\n        {() => (\n          <DashboardLayout>\n            <LoyaltyPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/security\">\n        {() => (\n          <DashboardLayout>\n            <SecuritySettingsPage />\n          </DashboardLayout>\n        )}\n      </Route>\n      <Route path=\"/dashboard/upgrade\">\n        {() => (\n          <DashboardLayout>\n            <UpgradePage />\n          </DashboardLayout>\n        )}\n      </Route>\n\n      {/* Super Admin Auth Pages */}\n      <Route path=\"/superadmin/login\" component={SuperAdminLoginPage} />\n      <Route path=\"/superadmin/register\" component={SuperAdminRegisterPage} />\n      <Route path=\"/superadmin/forgot-password\" component={SuperAdminForgotPasswordPage} />\n\n      {/* Super Admin Routes */}\n      <Route path=\"/superadmin\">\n        {() => (\n          <SuperAdminLayout>\n            <SuperAdminDashboard />\n          </SuperAdminLayout>\n        )}\n      </Route>\n      <Route path=\"/superadmin/tenants\">\n        {() => (\n          <SuperAdminLayout>\n            <SuperAdminTenantsPage />\n          </SuperAdminLayout>\n        )}\n      </Route>\n      <Route path=\"/superadmin/tenants/:id\">\n        {() => (\n          <SuperAdminLayout>\n            <SuperAdminTenantDetailsPage />\n          </SuperAdminLayout>\n        )}\n      </Route>\n      <Route path=\"/superadmin/users\">\n        {() => (\n          <SuperAdminLayout>\n            <SuperAdminUsersPage />\n          </SuperAdminLayout>\n        )}\n      </Route>\n      <Route path=\"/superadmin/sms-settings\">\n        {() => (\n          <SuperAdminLayout>\n            <SuperAdminSmsSettingsPage />\n          </SuperAdminLayout>\n        )}\n      </Route>\n\n      {/* Tech Portal Routes */}\n      <Route path=\"/tech\">\n        {() => (\n          <TechLayout>\n            <TechDashboard />\n          </TechLayout>\n        )}\n      </Route>\n      <Route path=\"/tech/pppoe-users\">\n        {() => (\n          <TechLayout>\n            <TechPPPoEUsersPage />\n          </TechLayout>\n        )}\n      </Route>\n      <Route path=\"/tech/static-users\">\n        {() => (\n          <TechLayout>\n            <TechStaticUsersPage />\n          </TechLayout>\n        )}\n      </Route>\n      <Route path=\"/tech/customers\">\n        {() => (\n          <TechLayout>\n            <WifiUsersPage />\n          </TechLayout>\n        )}\n      </Route>\n\n      {/* Fallback to 404 */}\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <TooltipProvider>\n        <Toaster />\n        <Router />\n      </TooltipProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":11849,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/components/app-sidebar.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { useState } from \"react\";\nimport {\n  LayoutDashboard,\n  CreditCard,\n  Wifi,\n  Globe,\n  Receipt,\n  Settings,\n  LogOut,\n  ChevronRight,\n  ChevronDown,\n  Users,\n  Ticket,\n  FileCheck,\n  MessageSquare,\n  Activity,\n  Key,\n  Router,\n  Terminal,\n  BarChart3,\n  MapPin,\n  Star,\n  Crown,\n  Lock,\n} from \"lucide-react\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n} from \"@/components/ui/sidebar\";\nimport { MnetiFiLogo } from \"./mnetifi-logo\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\nimport { TierFeatures } from \"@shared/schema\";\n\ninterface AppSidebarProps {\n  onLogout?: () => void;\n  subscriptionTier?: string;\n}\n\ninterface MenuItem {\n  title: string;\n  url: string;\n  icon: typeof LayoutDashboard;\n  featureKey?: string;\n  subItems?: { title: string; url: string; icon: typeof LayoutDashboard; featureKey?: string }[];\n}\n\nconst menuItems: MenuItem[] = [\n  {\n    title: \"Dashboard\",\n    url: \"/dashboard\",\n    icon: LayoutDashboard,\n    featureKey: \"dashboard\",\n  },\n  {\n    title: \"Customers\",\n    url: \"/dashboard/wifi-users\",\n    icon: Users,\n    featureKey: \"wifi-users\",\n  },\n  {\n    title: \"Plans\",\n    url: \"/dashboard/plans\",\n    icon: CreditCard,\n    featureKey: \"hotspot-plans\",\n    subItems: [\n      { title: \"Hotspot Plans\", url: \"/dashboard/hotspot-plans\", icon: Wifi, featureKey: \"hotspot-plans\" },\n      { title: \"PPPoE Plans\", url: \"/dashboard/pppoe-plans\", icon: Router, featureKey: \"pppoe-plans\" },\n      { title: \"Static IP Plans\", url: \"/dashboard/static-plans\", icon: Globe, featureKey: \"static-plans\" },\n    ],\n  },\n  {\n    title: \"Hotspots\",\n    url: \"/dashboard/hotspots\",\n    icon: Wifi,\n    featureKey: \"hotspots\",\n  },\n  {\n    title: \"Transactions\",\n    url: \"/dashboard/transactions\",\n    icon: Receipt,\n    featureKey: \"transactions\",\n  },\n  {\n    title: \"SMS Campaigns\",\n    url: \"/dashboard/sms-campaigns\",\n    icon: MessageSquare,\n    featureKey: \"sms-campaigns\",\n  },\n  {\n    title: \"Network Monitoring\",\n    url: \"/dashboard/network-monitoring\",\n    icon: Activity,\n    featureKey: \"network-monitoring\",\n  },\n  {\n    title: \"Router Terminal\",\n    url: \"/dashboard/router-terminal\",\n    icon: Terminal,\n    featureKey: \"network-monitoring\",\n  },\n  {\n    title: \"Vouchers\",\n    url: \"/dashboard/vouchers\",\n    icon: Key,\n    featureKey: \"vouchers\",\n  },\n  {\n    title: \"Tickets\",\n    url: \"/dashboard/tickets\",\n    icon: Ticket,\n    featureKey: \"tickets\",\n  },\n  {\n    title: \"Reconciliation\",\n    url: \"/dashboard/reconciliation\",\n    icon: FileCheck,\n    featureKey: \"reconciliation\",\n  },\n  {\n    title: \"Reports\",\n    url: \"/dashboard/reports\",\n    icon: BarChart3,\n    featureKey: \"reports\",\n  },\n  {\n    title: \"Walled Garden\",\n    url: \"/dashboard/walled-garden\",\n    icon: Globe,\n    featureKey: \"walled-garden\",\n  },\n  {\n    title: \"Zones\",\n    url: \"/dashboard/zones\",\n    icon: MapPin,\n    featureKey: \"zones\",\n  },\n  {\n    title: \"Chat\",\n    url: \"/dashboard/chat\",\n    icon: MessageSquare,\n    featureKey: \"chat\",\n  },\n  {\n    title: \"Loyalty Points\",\n    url: \"/dashboard/loyalty\",\n    icon: Star,\n    featureKey: \"loyalty\",\n  },\n];\n\nconst settingsItems = [\n  {\n    title: \"Settings\",\n    url: \"/dashboard/settings\",\n    icon: Settings,\n    featureKey: \"settings\",\n  },\n];\n\nexport function AppSidebar({ onLogout, subscriptionTier = \"BASIC\" }: AppSidebarProps) {\n  const [location] = useLocation();\n  \n  const tier = subscriptionTier as keyof typeof TierFeatures;\n  const allowedFeatures = TierFeatures[tier] || TierFeatures.BASIC;\n  \n  const hasFeatureAccess = (featureKey?: string) => {\n    if (!featureKey) return true;\n    return allowedFeatures.includes(featureKey as any);\n  };\n\n  const filterMenuItems = (items: MenuItem[]) => {\n    return items.map(item => {\n      if (item.subItems) {\n        const filteredSubItems = item.subItems.filter(sub => hasFeatureAccess(sub.featureKey));\n        if (filteredSubItems.length === 0) return null;\n        \n        const hasAnyPremiumSub = item.subItems.some(sub => !hasFeatureAccess(sub.featureKey));\n        return {\n          ...item,\n          subItems: item.subItems.map(sub => ({\n            ...sub,\n            isLocked: !hasFeatureAccess(sub.featureKey),\n          })),\n        };\n      }\n      return {\n        ...item,\n        isLocked: !hasFeatureAccess(item.featureKey),\n      };\n    }).filter((item): item is NonNullable<typeof item> => {\n      if (!item) return false;\n      if (item.subItems) {\n        return item.subItems.some(sub => !(sub as any).isLocked);\n      }\n      return !(item as any).isLocked;\n    });\n  };\n\n  const filteredMenuItems = filterMenuItems(menuItems);\n  \n  const getAutoExpandedItems = () => {\n    return filteredMenuItems\n      .filter(item => item.subItems?.some(sub => location === sub.url))\n      .map(item => item.title);\n  };\n  \n  const [expandedItems, setExpandedItems] = useState<string[]>(getAutoExpandedItems);\n\n  const toggleExpand = (title: string) => {\n    setExpandedItems(prev => \n      prev.includes(title) \n        ? prev.filter(t => t !== title)\n        : [...prev, title]\n    );\n  };\n\n  const isSubItemActive = (item: MenuItem) => {\n    return item.subItems?.some(sub => location === sub.url) || false;\n  };\n  \n  const isExpanded = (item: MenuItem) => {\n    return expandedItems.includes(item.title) || isSubItemActive(item);\n  };\n\n  const isBasicTier = subscriptionTier === \"BASIC\";\n\n  return (\n    <Sidebar className=\"border-r border-white/10 bg-sidebar/50 backdrop-blur-xl\">\n      <SidebarHeader className=\"p-4 border-b border-white/10\">\n        <Link href=\"/dashboard\">\n          <MnetiFiLogo size=\"md\" />\n        </Link>\n        {isBasicTier && (\n          <Badge className=\"mt-2 bg-cyan-500/20 text-cyan-400 border-0\">\n            Free Trial\n          </Badge>\n        )}\n        {!isBasicTier && (\n          <Badge className=\"mt-2 bg-gradient-to-r from-purple-500/20 to-pink-500/20 text-purple-400 border-0\">\n            <Crown size={12} className=\"mr-1\" />\n            Premium\n          </Badge>\n        )}\n      </SidebarHeader>\n\n      <SidebarContent className=\"px-2\">\n        <SidebarGroup>\n          <SidebarGroupLabel className=\"text-xs uppercase tracking-wider text-muted-foreground px-3 py-2\">\n            Management\n          </SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {filteredMenuItems.map((item) => {\n                const isActive = location === item.url || \n                  (item.url !== \"/dashboard\" && location.startsWith(item.url) && !item.subItems);\n                const hasSubItems = item.subItems && item.subItems.length > 0;\n                const itemIsExpanded = isExpanded(item);\n                \n                return (\n                  <SidebarMenuItem key={item.title}>\n                    {hasSubItems ? (\n                      <>\n                        <SidebarMenuButton\n                          onClick={() => toggleExpand(item.title)}\n                          className={cn(\n                            \"w-full transition-all duration-200\",\n                            (isActive || isSubItemActive(item)) && \"bg-white/10 text-white\"\n                          )}\n                          data-testid={`nav-${item.title.toLowerCase().replace(/\\s+/g, \"-\")}`}\n                        >\n                          <item.icon size={18} className={(isActive || isSubItemActive(item)) ? \"text-cyan-400\" : \"\"} />\n                          <span>{item.title}</span>\n                          {itemIsExpanded ? (\n                            <ChevronDown size={14} className=\"ml-auto text-muted-foreground\" />\n                          ) : (\n                            <ChevronRight size={14} className=\"ml-auto text-muted-foreground\" />\n                          )}\n                        </SidebarMenuButton>\n                        {itemIsExpanded && (\n                          <div className=\"ml-4 mt-1 space-y-1\">\n                            {item.subItems?.map((subItem) => {\n                              const isSubActive = location === subItem.url;\n                              const isLocked = (subItem as any).isLocked;\n                              \n                              if (isLocked) {\n                                return (\n                                  <SidebarMenuButton\n                                    key={subItem.title}\n                                    className=\"w-full text-sm opacity-50 cursor-not-allowed\"\n                                    data-testid={`nav-${subItem.title.toLowerCase().replace(/\\s+/g, \"-\")}-locked`}\n                                  >\n                                    <Lock size={14} className=\"text-muted-foreground\" />\n                                    <span>{subItem.title}</span>\n                                    <Badge variant=\"outline\" className=\"ml-auto text-[10px] px-1 py-0 border-purple-500/50 text-purple-400\">\n                                      Premium\n                                    </Badge>\n                                  </SidebarMenuButton>\n                                );\n                              }\n                              \n                              return (\n                                <SidebarMenuButton\n                                  key={subItem.title}\n                                  asChild\n                                  className={cn(\n                                    \"w-full transition-all duration-200 text-sm\",\n                                    isSubActive && \"bg-white/10 text-white\"\n                                  )}\n                                  data-testid={`nav-${subItem.title.toLowerCase().replace(/\\s+/g, \"-\")}`}\n                                >\n                                  <Link href={subItem.url}>\n                                    <subItem.icon size={16} className={isSubActive ? \"text-cyan-400\" : \"\"} />\n                                    <span>{subItem.title}</span>\n                                  </Link>\n                                </SidebarMenuButton>\n                              );\n                            })}\n                          </div>\n                        )}\n                      </>\n                    ) : (\n                      <SidebarMenuButton\n                        asChild\n                        className={cn(\n                          \"w-full transition-all duration-200\",\n                          isActive && \"bg-white/10 text-white\"\n                        )}\n                        data-testid={`nav-${item.title.toLowerCase().replace(/\\s+/g, \"-\")}`}\n                      >\n                        <Link href={item.url}>\n                          <item.icon size={18} className={isActive ? \"text-cyan-400\" : \"\"} />\n                          <span>{item.title}</span>\n                          {isActive && (\n                            <ChevronRight size={14} className=\"ml-auto text-muted-foreground\" />\n                          )}\n                        </Link>\n                      </SidebarMenuButton>\n                    )}\n                  </SidebarMenuItem>\n                );\n              })}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n\n        <SidebarGroup>\n          <SidebarGroupLabel className=\"text-xs uppercase tracking-wider text-muted-foreground px-3 py-2\">\n            System\n          </SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {settingsItems.map((item) => {\n                const isActive = location === item.url;\n                \n                return (\n                  <SidebarMenuItem key={item.title}>\n                    <SidebarMenuButton\n                      asChild\n                      className={cn(\n                        \"w-full transition-all duration-200\",\n                        isActive && \"bg-white/10 text-white\"\n                      )}\n                      data-testid={`nav-${item.title.toLowerCase().replace(/\\s+/g, \"-\")}`}\n                    >\n                      <Link href={item.url}>\n                        <item.icon size={18} className={isActive ? \"text-cyan-400\" : \"\"} />\n                        <span>{item.title}</span>\n                      </Link>\n                    </SidebarMenuButton>\n                  </SidebarMenuItem>\n                );\n              })}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n\n        {isBasicTier && (\n          <SidebarGroup>\n            <div className=\"mx-2 p-3 rounded-lg bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/20\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Crown size={16} className=\"text-purple-400\" />\n                <span className=\"text-sm font-medium text-white\">Upgrade to Premium</span>\n              </div>\n              <p className=\"text-xs text-muted-foreground mb-3\">\n                Unlock PPPoE, Static IP, Technicians, and more features.\n              </p>\n              <Link href=\"/dashboard/upgrade\">\n                <button className=\"w-full py-2 px-3 text-xs font-medium rounded-md bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:from-purple-600 hover:to-pink-600 transition-colors\">\n                  Upgrade Now\n                </button>\n              </Link>\n            </div>\n          </SidebarGroup>\n        )}\n      </SidebarContent>\n\n      <SidebarFooter className=\"p-4 border-t border-white/10\">\n        <SidebarMenu>\n          <SidebarMenuItem>\n            <SidebarMenuButton\n              onClick={onLogout}\n              className=\"w-full text-muted-foreground hover:text-destructive transition-colors\"\n              data-testid=\"nav-logout\"\n            >\n              <LogOut size={18} />\n              <span>Log Out</span>\n            </SidebarMenuButton>\n          </SidebarMenuItem>\n        </SidebarMenu>\n      </SidebarFooter>\n    </Sidebar>\n  );\n}\n","path":null,"size_bytes":14110,"size_tokens":null},"DEPLOYMENT.md":{"content":"# MnetiFi WiFi Billing - Deployment Guide\n\n## Overview\n\nMnetiFi is a **cloud-based SaaS platform** for ISP WiFi billing. ISPs don't install anything on their routers directly - they connect their MikroTik routers to your cloud platform via API.\n\n---\n\n## Deploying to Render.com\n\n### Step 1: Push Code to GitHub\n\n```bash\ngit init\ngit add .\ngit commit -m \"Initial commit\"\ngit remote add origin https://github.com/YOUR_USERNAME/mnetifi-wifi-billing.git\ngit push -u origin main\n```\n\n### Step 2: Deploy Using Blueprint (Recommended)\n\n1. Go to [Render Dashboard](https://dashboard.render.com)\n2. Click **New** > **Blueprint**\n3. Connect your GitHub repository\n4. Render will detect `render.yaml` and create:\n   - A PostgreSQL database (`mnetifi-db`)\n   - A web service (`mnetifi-wifi-billing`)\n5. Click **Apply**\n\n### Step 3: Configure Environment Variables\n\nAfter deployment, go to your web service > **Environment** tab.\n\n**Note:** The following are automatically configured by Render's blueprint:\n- `DATABASE_URL` - Auto-bound from your managed PostgreSQL database\n- `SESSION_SECRET` - Auto-generated secure random value\n\n#### Required Manual Configuration\n\nAdd the following secret via the Render dashboard **Environment** > **Secret Files** or as environment variables:\n\n| Variable | Description | How to Get |\n|----------|-------------|------------|\n| `SUPERADMIN_SETUP_KEY` | Secret key for creating super admin | Generate locally (see below), then add via Render dashboard |\n\n#### M-Pesa Integration (Required for Payments)\n\n| Variable | Description |\n|----------|-------------|\n| `MPESA_CONSUMER_KEY` | Your Safaricom API consumer key |\n| `MPESA_CONSUMER_SECRET` | Your Safaricom API consumer secret |\n| `MPESA_PASSKEY` | Your Lipa na M-Pesa passkey |\n| `MPESA_SHORTCODE` | Your M-Pesa paybill/till number |\n| `MPESA_CALLBACK_URL` | `https://your-app.onrender.com/api/mpesa/callback` |\n\n#### SMS Integration (Optional)\n\n| Variable | Description |\n|----------|-------------|\n| `SMS_PROVIDER` | `africas_talking`, `twilio`, or `mock` |\n| `SMS_API_KEY` | API key from your SMS provider |\n| `SMS_USERNAME` | Username for Africa's Talking |\n\n### Step 4: Initialize Database\n\nThe database schema needs to be pushed after first deployment. Choose one option:\n\n**Option A: Local execution (Recommended)**\n```bash\n# Copy DATABASE_URL from Render dashboard > Database > Connection\nexport DATABASE_URL=\"your-render-database-url\"\nnpm run db:push\n```\n\n**Option B: One-off job on Render**\n1. Create a one-off job in Render with command: `npm run db:push`\n2. Set the same environment variables as your web service\n3. Run the job once\n\n**Note:** Render Shell doesn't have dependencies installed by default, so running `npm run db:push` directly in the shell won't work.\n\n### Step 5: Create Super Admin Account\n\n1. Visit: `https://your-app.onrender.com/superadmin/register`\n2. Enter username, email, password\n3. Enter your `SUPERADMIN_SETUP_KEY`\n4. Click Register\n\n---\n\n## Generating a Secure SUPERADMIN_SETUP_KEY\n\nRun one of these commands on your computer:\n\n**Linux/Mac:**\n```bash\nopenssl rand -base64 32\n```\n\n**Windows PowerShell:**\n```powershell\n[Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Maximum 256 }))\n```\n\n**Example output:** `xw2oWrOSb7ddCIuZ8hjOiLnSwCSiYwm5vfoOiKF1sik=`\n\n**IMPORTANT:**\n- Never share this key publicly\n- Store it securely in a password manager\n- This key is only used once during initial setup\n- After creating super admin, you can remove it from environment variables\n\n---\n\n## How ISPs Access Your Service\n\n### Architecture\n\n```\n[ISP's MikroTik Router] <---> [MnetiFi Cloud Platform] <---> [End Customer]\n         |                              |\n    REST API                       Web Dashboard\n    Connection                     & Captive Portal\n```\n\n### ISP Onboarding Process\n\n1. **ISP Registration:** ISP visits your platform and signs up for 24-hour free trial\n2. **Router Configuration:** ISP configures their MikroTik router to connect to MnetiFi\n3. **Dashboard Access:** ISP logs into their dashboard to manage plans, users, billing\n4. **Customer Access:** End customers connect to WiFi and see captive portal for payment\n\n### What ISPs Configure on Their Router\n\n1. **Enable REST API** on MikroTik router\n2. **Configure Hotspot Server** with external RADIUS\n3. **Point RADIUS** to MnetiFi's RADIUS server\n4. **Allow firewall rules** for MnetiFi communication\n\n### Data Flow\n\n1. Customer connects to ISP's WiFi hotspot\n2. Router redirects to MnetiFi captive portal\n3. Customer selects plan and pays via M-Pesa\n4. MnetiFi sends RADIUS CoA to router\n5. Router grants internet access to customer\n\n---\n\n## Alternative Deployment: Railway.app\n\n1. Create Railway account at [railway.app](https://railway.app)\n2. Create new project from GitHub\n3. Add PostgreSQL database\n4. Set environment variables (same as Render)\n5. Deploy\n\n---\n\n## Alternative Deployment: Self-Hosted (VPS)\n\n### Requirements\n- Ubuntu 20.04+ or similar Linux\n- Node.js 20+\n- PostgreSQL 14+\n- Nginx (reverse proxy)\n- SSL certificate (Let's Encrypt)\n\n### Setup Steps\n\n```bash\n# Install Node.js 20\ncurl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -\nsudo apt install -y nodejs\n\n# Install PostgreSQL\nsudo apt install -y postgresql\n\n# Clone your repo\ngit clone https://github.com/YOUR_USERNAME/mnetifi-wifi-billing.git\ncd mnetifi-wifi-billing\n\n# Install dependencies\nnpm install\n\n# Build for production\nnpm run build\n\n# Set environment variables\nexport DATABASE_URL=\"postgresql://user:password@localhost:5432/mnetifi\"\nexport NODE_ENV=\"production\"\nexport SESSION_SECRET=\"your-random-secret\"\nexport SUPERADMIN_SETUP_KEY=\"your-setup-key\"\n\n# Push database schema\nnpm run db:push\n\n# Start the server\nnpm run start\n```\n\n### Nginx Configuration\n\n```nginx\nserver {\n    listen 80;\n    server_name your-domain.com;\n    return 301 https://$server_name$request_uri;\n}\n\nserver {\n    listen 443 ssl;\n    server_name your-domain.com;\n\n    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;\n\n    location / {\n        proxy_pass http://localhost:5000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host $host;\n        proxy_cache_bypass $http_upgrade;\n    }\n}\n```\n\n### Process Manager (PM2)\n\n```bash\n# Install PM2\nnpm install -g pm2\n\n# Start with PM2\npm2 start npm --name \"mnetifi\" -- run start\n\n# Auto-start on reboot\npm2 startup\npm2 save\n```\n\n---\n\n## Verification\n\nAfter deployment, verify:\n\n1. Visit `https://your-app.onrender.com` - should show landing page\n2. Visit `https://your-app.onrender.com/api/health` - should return `{\"status\":\"healthy\"}`\n3. Visit `https://your-app.onrender.com/login` - should show ISP login\n4. Visit `https://your-app.onrender.com/superadmin/login` - should show super admin login\n\n---\n\n## Render Free Tier Notes\n\n- Service spins down after 15 minutes of inactivity\n- First request after spin-down takes 30-60 seconds (cold start)\n- For production, use **Starter plan** ($7/month) for always-on service\n- Database free tier has 256MB limit\n\n---\n\n## Troubleshooting\n\n### Build Fails\n- Check Node version is `>=20.0.0`\n- Ensure all dependencies are in `package.json`\n\n### Database Connection Issues\n- Verify `DATABASE_URL` includes `?sslmode=require` for external databases\n- Check database is running and accessible\n\n### 502 Errors\n- Check Render logs for startup errors\n- Verify environment variables are set correctly\n\n### M-Pesa Not Working\n- Verify callback URL is publicly accessible\n- Check M-Pesa credentials are correct\n- Ensure you're using production credentials for live environment\n\n---\n\n## Local Testing (Production Build)\n\n```bash\n# Build the app\nnpm run build\n\n# Start production server\nnpm run start\n```\n\nApp will be available at `http://localhost:5000`\n","path":null,"size_bytes":7900,"size_tokens":null},"server/storage.ts":{"content":"import { \n  tenants, hotspots, plans, transactions, walledGardens, users, wifiUsers, tickets, smsCampaigns, wallets, walletTransactions, vouchers, voucherBatches,\n  zones, auditLogs, chatMessages, loyaltyPoints, loyaltyTransactions, loginAttempts, routerBackups, loginPageTemplates,\n  type Tenant, type InsertTenant,\n  type Hotspot, type InsertHotspot,\n  type Plan, type InsertPlan,\n  type Transaction, type InsertTransaction,\n  type WalledGarden, type InsertWalledGarden,\n  type User, type InsertUser,\n  type WifiUser, type InsertWifiUser,\n  type Ticket, type InsertTicket,\n  type SmsCampaign, type InsertSmsCampaign,\n  type Wallet, type InsertWallet,\n  type WalletTransaction, type InsertWalletTransaction,\n  type Voucher, type InsertVoucher,\n  type VoucherBatch, type InsertVoucherBatch,\n  type Zone, type InsertZone,\n  type AuditLog, type InsertAuditLog,\n  type ChatMessage, type InsertChatMessage,\n  type LoyaltyPoints, type InsertLoyaltyPoints,\n  type LoyaltyTransaction, type InsertLoyaltyTransaction,\n  type LoginAttempt, type InsertLoginAttempt,\n  type RouterBackup, type InsertRouterBackup,\n  type LoginPageTemplate, type InsertLoginPageTemplate,\n  WalletTransactionType,\n  VoucherStatus,\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, desc, and, gte, lte, sql, inArray } from \"drizzle-orm\";\n\nexport interface IStorage {\n  // Tenant operations\n  getTenant(id: string): Promise<Tenant | undefined>;\n  getTenantBySubdomain(subdomain: string): Promise<Tenant | undefined>;\n  createTenant(tenant: InsertTenant): Promise<Tenant>;\n  updateTenant(id: string, data: Partial<InsertTenant>): Promise<Tenant | undefined>;\n\n  // Hotspot operations\n  getHotspots(tenantId: string): Promise<Hotspot[]>;\n  getHotspot(id: string): Promise<Hotspot | undefined>;\n  getHotspotForTenant(id: string, tenantId: string): Promise<Hotspot | undefined>;\n  createHotspot(hotspot: InsertHotspot): Promise<Hotspot>;\n  updateHotspot(id: string, data: Partial<InsertHotspot>): Promise<Hotspot | undefined>;\n  deleteHotspot(id: string): Promise<boolean>;\n\n  // Plan operations\n  getPlans(tenantId: string): Promise<Plan[]>;\n  getActivePlans(tenantId: string): Promise<Plan[]>;\n  getPlan(id: string): Promise<Plan | undefined>;\n  createPlan(plan: InsertPlan): Promise<Plan>;\n  updatePlan(id: string, data: Partial<InsertPlan>): Promise<Plan | undefined>;\n  deletePlan(id: string): Promise<boolean>;\n\n  // Transaction operations\n  getTransactions(tenantId: string): Promise<Transaction[]>;\n  getRecentTransactions(tenantId: string, limit?: number): Promise<Transaction[]>;\n  getTransaction(id: string): Promise<Transaction | undefined>;\n  getTransactionByCheckoutRequestId(checkoutRequestId: string): Promise<Transaction | undefined>;\n  getTransactionsByWifiUserId(wifiUserId: string): Promise<Transaction[]>;\n  createTransaction(transaction: InsertTransaction): Promise<Transaction>;\n  updateTransaction(id: string, data: Partial<InsertTransaction>): Promise<Transaction | undefined>;\n\n  // Walled Garden operations\n  getWalledGardens(tenantId: string): Promise<WalledGarden[]>;\n  getWalledGarden(id: string): Promise<WalledGarden | undefined>;\n  createWalledGarden(walledGarden: InsertWalledGarden): Promise<WalledGarden>;\n  deleteWalledGarden(id: string): Promise<boolean>;\n\n  // User operations\n  getUser(id: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  getUserByResetToken(token: string): Promise<User | undefined>;\n  getUserByEmailVerificationToken(token: string): Promise<User | undefined>;\n  getTechnicians(tenantId: string): Promise<User[]>;\n  createUser(user: InsertUser): Promise<User>;\n  updateUser(id: string, data: Partial<InsertUser & { resetToken?: string | null; resetTokenExpiry?: Date | null; emailVerificationToken?: string | null; emailVerificationExpiry?: Date | null; emailVerified?: boolean }>): Promise<User | undefined>;\n  getAllTenants(): Promise<Tenant[]>;\n\n  // WiFi User operations\n  getWifiUsers(tenantId: string): Promise<WifiUser[]>;\n  getWifiUser(id: string): Promise<WifiUser | undefined>;\n  getWifiUserByPhone(tenantId: string, phoneNumber: string): Promise<WifiUser | undefined>;\n  createWifiUser(wifiUser: InsertWifiUser): Promise<WifiUser>;\n  updateWifiUser(id: string, data: Partial<InsertWifiUser>): Promise<WifiUser | undefined>;\n  deleteWifiUser(id: string): Promise<boolean>;\n  getExpiringWifiUsers(tenantId: string, daysAhead: number): Promise<WifiUser[]>;\n  \n  // Ticket operations\n  getTickets(tenantId: string): Promise<Ticket[]>;\n  getTicket(id: string): Promise<Ticket | undefined>;\n  getTicketsByWifiUser(wifiUserId: string): Promise<Ticket[]>;\n  getOpenTickets(tenantId: string): Promise<Ticket[]>;\n  createTicket(ticket: InsertTicket): Promise<Ticket>;\n  updateTicket(id: string, data: Partial<InsertTicket>): Promise<Ticket | undefined>;\n  closeTicket(id: string, resolutionNotes: string): Promise<Ticket | undefined>;\n\n  // Dashboard stats\n  getDashboardStats(tenantId: string): Promise<{\n    totalRevenue: number;\n    totalTransactions: number;\n    successfulTransactions: number;\n    pendingTransactions: number;\n    failedTransactions: number;\n    activeHotspots: number;\n    activeWifiUsers: number;\n    openTickets: number;\n    expiringUsers: WifiUser[];\n    recentTransactions: Transaction[];\n  }>;\n\n  // Mark all expired users\n  markExpiredUsers(): Promise<number>;\n  \n  // Mark stale pending transactions as failed\n  markStaleTransactionsAsFailed(): Promise<number>;\n\n  // Voucher operations\n  getVouchers(tenantId: string): Promise<Voucher[]>;\n  getVoucher(id: string): Promise<Voucher | undefined>;\n  getVoucherByCode(tenantId: string, code: string): Promise<Voucher | undefined>;\n  createVoucher(voucher: InsertVoucher): Promise<Voucher>;\n  createVoucherBatch(batch: InsertVoucherBatch, voucherCodes: string[]): Promise<{ batch: VoucherBatch; vouchers: Voucher[] }>;\n  updateVoucher(id: string, data: Partial<InsertVoucher>): Promise<Voucher | undefined>;\n  redeemVoucher(id: string, wifiUserId: string, macAddress?: string): Promise<Voucher | undefined>;\n  getVoucherBatches(tenantId: string): Promise<VoucherBatch[]>;\n  getVoucherBatch(id: string): Promise<VoucherBatch | undefined>;\n  getVouchersByBatch(batchId: string): Promise<Voucher[]>;\n  getVouchersByPhone(tenantId: string, phoneNumber: string): Promise<(Voucher & { planName?: string })[]>;\n  deleteVoucher(id: string): Promise<boolean>;\n\n  // Router Backup operations\n  getRouterBackups(tenantId: string, hotspotId: string): Promise<RouterBackup[]>;\n  getRouterBackup(id: string): Promise<RouterBackup | undefined>;\n  createRouterBackup(backup: InsertRouterBackup): Promise<RouterBackup>;\n  deleteRouterBackup(id: string): Promise<boolean>;\n\n  // Login Page Template operations\n  getLoginPageTemplates(tenantId: string): Promise<LoginPageTemplate[]>;\n  getLoginPageTemplate(id: string): Promise<LoginPageTemplate | undefined>;\n  createLoginPageTemplate(template: InsertLoginPageTemplate): Promise<LoginPageTemplate>;\n  updateLoginPageTemplate(id: string, data: Partial<InsertLoginPageTemplate>): Promise<LoginPageTemplate | undefined>;\n  deleteLoginPageTemplate(id: string): Promise<boolean>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // Tenant operations\n  async getTenant(id: string): Promise<Tenant | undefined> {\n    const [tenant] = await db.select().from(tenants).where(eq(tenants.id, id));\n    return tenant || undefined;\n  }\n\n  async getTenantBySubdomain(subdomain: string): Promise<Tenant | undefined> {\n    const [tenant] = await db.select().from(tenants).where(eq(tenants.subdomain, subdomain));\n    return tenant || undefined;\n  }\n\n  async createTenant(tenant: InsertTenant): Promise<Tenant> {\n    const [created] = await db.insert(tenants).values(tenant as any).returning();\n    return created;\n  }\n\n  async updateTenant(id: string, data: Partial<InsertTenant>): Promise<Tenant | undefined> {\n    const [updated] = await db.update(tenants).set(data as any).where(eq(tenants.id, id)).returning();\n    return updated || undefined;\n  }\n\n  // Hotspot operations\n  async getHotspots(tenantId: string): Promise<Hotspot[]> {\n    return db.select().from(hotspots).where(eq(hotspots.tenantId, tenantId));\n  }\n\n  async getHotspot(id: string): Promise<Hotspot | undefined> {\n    const [hotspot] = await db.select().from(hotspots).where(eq(hotspots.id, id));\n    return hotspot || undefined;\n  }\n\n  async getHotspotForTenant(id: string, tenantId: string): Promise<Hotspot | undefined> {\n    const [hotspot] = await db.select().from(hotspots).where(\n      and(eq(hotspots.id, id), eq(hotspots.tenantId, tenantId))\n    );\n    return hotspot || undefined;\n  }\n\n  async createHotspot(hotspot: InsertHotspot): Promise<Hotspot> {\n    const [created] = await db.insert(hotspots).values(hotspot).returning();\n    return created;\n  }\n\n  async updateHotspot(id: string, data: Partial<InsertHotspot>): Promise<Hotspot | undefined> {\n    const [updated] = await db.update(hotspots).set(data).where(eq(hotspots.id, id)).returning();\n    return updated || undefined;\n  }\n\n  async deleteHotspot(id: string): Promise<boolean> {\n    const result = await db.delete(hotspots).where(eq(hotspots.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Plan operations\n  async getPlans(tenantId: string): Promise<Plan[]> {\n    return db.select().from(plans).where(eq(plans.tenantId, tenantId)).orderBy(plans.sortOrder);\n  }\n\n  async getActivePlans(tenantId: string): Promise<Plan[]> {\n    return db.select().from(plans).where(\n      and(eq(plans.tenantId, tenantId), eq(plans.isActive, true))\n    ).orderBy(plans.sortOrder);\n  }\n\n  async getPlan(id: string): Promise<Plan | undefined> {\n    const [plan] = await db.select().from(plans).where(eq(plans.id, id));\n    return plan || undefined;\n  }\n\n  async createPlan(plan: InsertPlan): Promise<Plan> {\n    const [created] = await db.insert(plans).values(plan).returning();\n    return created;\n  }\n\n  async updatePlan(id: string, data: Partial<InsertPlan>): Promise<Plan | undefined> {\n    const [updated] = await db.update(plans).set(data).where(eq(plans.id, id)).returning();\n    return updated || undefined;\n  }\n\n  async deletePlan(id: string): Promise<boolean> {\n    const result = await db.delete(plans).where(eq(plans.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Transaction operations\n  async getTransactions(tenantId: string): Promise<Transaction[]> {\n    return db.select().from(transactions)\n      .where(eq(transactions.tenantId, tenantId))\n      .orderBy(desc(transactions.createdAt));\n  }\n\n  async getRecentTransactions(tenantId: string, limit: number = 10): Promise<Transaction[]> {\n    return db.select().from(transactions)\n      .where(eq(transactions.tenantId, tenantId))\n      .orderBy(desc(transactions.createdAt))\n      .limit(limit);\n  }\n\n  async getTransaction(id: string): Promise<Transaction | undefined> {\n    const [transaction] = await db.select().from(transactions).where(eq(transactions.id, id));\n    return transaction || undefined;\n  }\n\n  async getTransactionByCheckoutRequestId(checkoutRequestId: string): Promise<Transaction | undefined> {\n    const [transaction] = await db.select().from(transactions)\n      .where(eq(transactions.checkoutRequestId, checkoutRequestId));\n    return transaction || undefined;\n  }\n\n  async getTransactionsByWifiUserId(wifiUserId: string): Promise<Transaction[]> {\n    return db.select().from(transactions)\n      .where(eq(transactions.wifiUserId, wifiUserId))\n      .orderBy(desc(transactions.createdAt));\n  }\n\n  async createTransaction(transaction: InsertTransaction): Promise<Transaction> {\n    const [created] = await db.insert(transactions).values(transaction).returning();\n    return created;\n  }\n\n  async updateTransaction(id: string, data: Partial<InsertTransaction>): Promise<Transaction | undefined> {\n    const [updated] = await db.update(transactions)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(transactions.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  // Walled Garden operations\n  async getWalledGardens(tenantId: string): Promise<WalledGarden[]> {\n    return db.select().from(walledGardens).where(eq(walledGardens.tenantId, tenantId));\n  }\n\n  async getWalledGarden(id: string): Promise<WalledGarden | undefined> {\n    const [wg] = await db.select().from(walledGardens).where(eq(walledGardens.id, id));\n    return wg || undefined;\n  }\n\n  async createWalledGarden(walledGarden: InsertWalledGarden): Promise<WalledGarden> {\n    const [created] = await db.insert(walledGardens).values(walledGarden).returning();\n    return created;\n  }\n\n  async deleteWalledGarden(id: string): Promise<boolean> {\n    const result = await db.delete(walledGardens).where(eq(walledGardens.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // User operations\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user || undefined;\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.username, username));\n    return user || undefined;\n  }\n\n  async createUser(user: InsertUser): Promise<User> {\n    const [created] = await db.insert(users).values(user).returning();\n    return created;\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.email, email));\n    return user || undefined;\n  }\n\n  async getUserByResetToken(token: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.resetToken, token));\n    return user || undefined;\n  }\n\n  async getUserByEmailVerificationToken(token: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.emailVerificationToken, token));\n    return user || undefined;\n  }\n\n  async getTechnicians(tenantId: string): Promise<User[]> {\n    return db.select().from(users).where(\n      and(\n        eq(users.tenantId, tenantId),\n        eq(users.role, \"tech\"),\n        eq(users.isActive, true)\n      )\n    );\n  }\n\n  async updateUser(id: string, data: Partial<InsertUser & { resetToken?: string | null; resetTokenExpiry?: Date | null; emailVerificationToken?: string | null; emailVerificationExpiry?: Date | null; emailVerified?: boolean }>): Promise<User | undefined> {\n    const [updated] = await db.update(users).set(data as any).where(eq(users.id, id)).returning();\n    return updated || undefined;\n  }\n\n  async deleteUser(id: string): Promise<boolean> {\n    const result = await db.delete(users).where(eq(users.id, id)).returning();\n    return result.length > 0;\n  }\n\n  async getAllAdminUsers(): Promise<(User & { tenantName?: string })[]> {\n    const allUsers = await db.select().from(users).orderBy(desc(users.createdAt));\n    const allTenants = await db.select().from(tenants);\n    \n    return allUsers.map(user => ({\n      ...user,\n      tenantName: user.tenantId \n        ? allTenants.find(t => t.id === user.tenantId)?.name \n        : undefined\n    }));\n  }\n\n  async getAllTenants(): Promise<Tenant[]> {\n    return db.select().from(tenants).orderBy(desc(tenants.createdAt));\n  }\n\n  // WiFi User operations\n  async getWifiUsers(tenantId: string): Promise<WifiUser[]> {\n    return db.select().from(wifiUsers)\n      .where(eq(wifiUsers.tenantId, tenantId))\n      .orderBy(desc(wifiUsers.createdAt));\n  }\n\n  async getWifiUser(id: string): Promise<WifiUser | undefined> {\n    const [wifiUser] = await db.select().from(wifiUsers).where(eq(wifiUsers.id, id));\n    return wifiUser || undefined;\n  }\n\n  async getWifiUserByPhone(tenantId: string, phoneNumber: string): Promise<WifiUser | undefined> {\n    const [wifiUser] = await db.select().from(wifiUsers)\n      .where(and(eq(wifiUsers.tenantId, tenantId), eq(wifiUsers.phoneNumber, phoneNumber)));\n    return wifiUser || undefined;\n  }\n\n  async createWifiUser(wifiUser: InsertWifiUser): Promise<WifiUser> {\n    const [created] = await db.insert(wifiUsers).values(wifiUser).returning();\n    return created;\n  }\n\n  async updateWifiUser(id: string, data: Partial<InsertWifiUser>): Promise<WifiUser | undefined> {\n    const [updated] = await db.update(wifiUsers)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(wifiUsers.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  async deleteWifiUser(id: string): Promise<boolean> {\n    const result = await db.delete(wifiUsers).where(eq(wifiUsers.id, id)).returning();\n    return result.length > 0;\n  }\n\n  async getExpiringWifiUsers(tenantId: string, daysAhead: number): Promise<WifiUser[]> {\n    const now = new Date();\n    const futureDate = new Date();\n    futureDate.setDate(futureDate.getDate() + daysAhead);\n    \n    return db.select().from(wifiUsers)\n      .where(and(\n        eq(wifiUsers.tenantId, tenantId),\n        eq(wifiUsers.status, \"ACTIVE\"),\n        gte(wifiUsers.expiryTime, now),\n        lte(wifiUsers.expiryTime, futureDate)\n      ))\n      .orderBy(wifiUsers.expiryTime);\n  }\n\n  // Ticket operations\n  async getTickets(tenantId: string): Promise<Ticket[]> {\n    return db.select().from(tickets)\n      .where(eq(tickets.tenantId, tenantId))\n      .orderBy(desc(tickets.createdAt));\n  }\n\n  async getTicket(id: string): Promise<Ticket | undefined> {\n    const [ticket] = await db.select().from(tickets).where(eq(tickets.id, id));\n    return ticket || undefined;\n  }\n\n  async getTicketsByWifiUser(wifiUserId: string): Promise<Ticket[]> {\n    return db.select().from(tickets)\n      .where(eq(tickets.wifiUserId, wifiUserId))\n      .orderBy(desc(tickets.createdAt));\n  }\n\n  async getOpenTickets(tenantId: string): Promise<Ticket[]> {\n    return db.select().from(tickets)\n      .where(and(\n        eq(tickets.tenantId, tenantId),\n        sql`${tickets.status} IN ('OPEN', 'IN_PROGRESS')`\n      ))\n      .orderBy(desc(tickets.createdAt));\n  }\n\n  async createTicket(ticket: InsertTicket): Promise<Ticket> {\n    const [created] = await db.insert(tickets).values(ticket).returning();\n    return created;\n  }\n\n  async updateTicket(id: string, data: Partial<InsertTicket>): Promise<Ticket | undefined> {\n    const [updated] = await db.update(tickets)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(tickets.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  async closeTicket(id: string, resolutionNotes: string): Promise<Ticket | undefined> {\n    const [updated] = await db.update(tickets)\n      .set({ \n        status: \"CLOSED\", \n        resolutionNotes, \n        closedAt: new Date(),\n        updatedAt: new Date() \n      })\n      .where(eq(tickets.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  // Dashboard stats\n  async getDashboardStats(tenantId: string) {\n    const allTransactions = await this.getTransactions(tenantId);\n    const activeHotspotsList = await db.select().from(hotspots)\n      .where(and(eq(hotspots.tenantId, tenantId), eq(hotspots.isActive, true)));\n    const recentTransactionsList = await this.getRecentTransactions(tenantId, 5);\n    \n    const activeWifiUsersList = await db.select().from(wifiUsers)\n      .where(and(eq(wifiUsers.tenantId, tenantId), eq(wifiUsers.status, \"ACTIVE\")));\n    const openTicketsList = await this.getOpenTickets(tenantId);\n    const expiringUsersList = await this.getExpiringWifiUsers(tenantId, 5);\n\n    const successfulTransactions = allTransactions.filter(t => t.status === \"COMPLETED\");\n    const pendingTransactions = allTransactions.filter(t => t.status === \"PENDING\");\n    const failedTransactions = allTransactions.filter(t => t.status === \"FAILED\");\n\n    const totalRevenue = successfulTransactions.reduce((sum, t) => sum + t.amount, 0);\n\n    return {\n      totalRevenue,\n      totalTransactions: allTransactions.length,\n      successfulTransactions: successfulTransactions.length,\n      pendingTransactions: pendingTransactions.length,\n      failedTransactions: failedTransactions.length,\n      activeHotspots: activeHotspotsList.length,\n      activeWifiUsers: activeWifiUsersList.length,\n      openTickets: openTicketsList.length,\n      expiringUsers: expiringUsersList,\n      recentTransactions: recentTransactionsList,\n    };\n  }\n\n  // Reconciliation Report\n  async getReconciliationReport(tenantId: string, startDate?: Date, endDate?: Date) {\n    let query = db.select().from(transactions)\n      .where(eq(transactions.tenantId, tenantId));\n    \n    const allTransactions = await query.orderBy(desc(transactions.createdAt));\n    \n    const filtered = allTransactions.filter(t => {\n      if (!t.createdAt) return true;\n      const txDate = new Date(t.createdAt);\n      if (startDate && txDate < startDate) return false;\n      if (endDate && txDate > endDate) return false;\n      return true;\n    });\n\n    const matched = filtered.filter(t => t.reconciliationStatus === \"MATCHED\");\n    const unmatched = filtered.filter(t => t.reconciliationStatus === \"UNMATCHED\");\n    const manualReview = filtered.filter(t => t.reconciliationStatus === \"MANUAL_REVIEW\");\n    const pending = filtered.filter(t => t.reconciliationStatus === \"PENDING\");\n\n    const matchRate = filtered.length > 0 ? (matched.length / filtered.length) * 100 : 0;\n\n    return {\n      summary: {\n        totalTransactions: filtered.length,\n        matchedCount: matched.length,\n        unmatchedCount: unmatched.length,\n        manualReviewCount: manualReview.length,\n        pendingCount: pending.length,\n        matchRate: matchRate,\n        matchedAmount: matched.reduce((sum, t) => sum + t.amount, 0),\n        unmatchedAmount: unmatched.reduce((sum, t) => sum + t.amount, 0),\n      },\n      transactions: filtered.slice(0, 50).map(t => ({\n        id: t.id,\n        amount: t.amount,\n        status: t.status,\n        reconciliationStatus: t.reconciliationStatus,\n        mpesaReceiptNumber: t.mpesaReceiptNumber,\n        createdAt: t.createdAt?.toISOString() || '',\n      })),\n    };\n  }\n\n  // Financial Report\n  async getFinancialReport(tenantId: string, startDate?: Date, endDate?: Date) {\n    const allTransactions = await this.getTransactions(tenantId);\n    \n    const filtered = allTransactions.filter(t => {\n      if (!t.createdAt) return true;\n      const txDate = new Date(t.createdAt);\n      if (startDate && txDate < startDate) return false;\n      if (endDate && txDate > endDate) return false;\n      return true;\n    });\n\n    const completed = filtered.filter(t => t.status === \"COMPLETED\");\n    const failed = filtered.filter(t => t.status === \"FAILED\");\n    const pending = filtered.filter(t => t.status === \"PENDING\");\n\n    const dailyRevenue: Record<string, number> = {};\n    const planRevenue: Record<string, { name: string; amount: number; count: number }> = {};\n\n    for (const tx of completed) {\n      const date = tx.createdAt ? new Date(tx.createdAt).toISOString().split(\"T\")[0] : \"unknown\";\n      dailyRevenue[date] = (dailyRevenue[date] || 0) + tx.amount;\n      \n      if (tx.planId) {\n        if (!planRevenue[tx.planId]) {\n          planRevenue[tx.planId] = { name: tx.planId, amount: 0, count: 0 };\n        }\n        planRevenue[tx.planId].amount += tx.amount;\n        planRevenue[tx.planId].count += 1;\n      }\n    }\n\n    return {\n      summary: {\n        totalRevenue: completed.reduce((sum, t) => sum + t.amount, 0),\n        totalTransactions: filtered.length,\n        successfulTransactions: completed.length,\n        failedTransactions: failed.length,\n        pendingTransactions: pending.length,\n        averageTransactionValue: completed.length > 0 \n          ? Math.round(completed.reduce((sum, t) => sum + t.amount, 0) / completed.length)\n          : 0,\n      },\n      dailyRevenue: Object.entries(dailyRevenue)\n        .map(([date, amount]) => ({ date, amount }))\n        .sort((a, b) => a.date.localeCompare(b.date)),\n      planRevenue: Object.values(planRevenue)\n        .sort((a, b) => b.amount - a.amount),\n    };\n  }\n\n  // User Activity Report\n  async getUserActivityReport(tenantId: string) {\n    const allUsers = await this.getWifiUsers(tenantId);\n    const now = new Date();\n    \n    const active = allUsers.filter(u => u.status === \"ACTIVE\");\n    const expired = allUsers.filter(u => u.status === \"EXPIRED\");\n    const suspended = allUsers.filter(u => u.status === \"SUSPENDED\");\n    \n    const expiringIn24h = allUsers.filter(u => {\n      if (!u.expiryTime || u.status !== \"ACTIVE\") return false;\n      const expiry = new Date(u.expiryTime);\n      const diff = expiry.getTime() - now.getTime();\n      return diff > 0 && diff <= 24 * 60 * 60 * 1000;\n    });\n\n    const expiringIn48h = allUsers.filter(u => {\n      if (!u.expiryTime || u.status !== \"ACTIVE\") return false;\n      const expiry = new Date(u.expiryTime);\n      const diff = expiry.getTime() - now.getTime();\n      return diff > 24 * 60 * 60 * 1000 && diff <= 48 * 60 * 60 * 1000;\n    });\n\n    const expiringIn5Days = allUsers.filter(u => {\n      if (!u.expiryTime || u.status !== \"ACTIVE\") return false;\n      const expiry = new Date(u.expiryTime);\n      const diff = expiry.getTime() - now.getTime();\n      return diff > 0 && diff <= 5 * 24 * 60 * 60 * 1000;\n    });\n\n    const byAccountType = {\n      hotspot: allUsers.filter(u => u.accountType === \"HOTSPOT\").length,\n      pppoe: allUsers.filter(u => u.accountType === \"PPPOE\").length,\n      static: allUsers.filter(u => u.accountType === \"STATIC\").length,\n    };\n\n    return {\n      summary: {\n        totalUsers: allUsers.length,\n        activeUsers: active.length,\n        expiredUsers: expired.length,\n        suspendedUsers: suspended.length,\n        expiringIn24h: expiringIn24h.length,\n        expiringIn48h: expiringIn48h.length,\n        expiringIn5Days: expiringIn5Days.length,\n      },\n      byAccountType,\n      expiringUsers: expiringIn5Days.slice(0, 20).map(u => ({\n        id: u.id,\n        username: u.username || u.phoneNumber,\n        phoneNumber: u.phoneNumber,\n        expiryTime: u.expiryTime?.toISOString() || '',\n      })),\n    };\n  }\n\n  // Transactions by date range\n  async getTransactionsByDateRange(tenantId: string, startDate: Date, endDate: Date): Promise<Transaction[]> {\n    return db.select().from(transactions)\n      .where(and(\n        eq(transactions.tenantId, tenantId),\n        gte(transactions.createdAt, startDate),\n        lte(transactions.createdAt, endDate)\n      ))\n      .orderBy(desc(transactions.createdAt));\n  }\n\n  // Update tenant SaaS billing status\n  async updateTenantBillingStatus(id: string, status: string): Promise<Tenant | undefined> {\n    const [updated] = await db.update(tenants)\n      .set({ saasBillingStatus: status })\n      .where(eq(tenants.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  // Mark all expired users as EXPIRED status\n  async markExpiredUsers(): Promise<number> {\n    const now = new Date();\n    const result = await db.update(wifiUsers)\n      .set({ status: \"EXPIRED\", updatedAt: now })\n      .where(and(\n        eq(wifiUsers.status, \"ACTIVE\"),\n        lte(wifiUsers.expiryTime, now)\n      ))\n      .returning();\n    return result.length;\n  }\n\n  // Mark stale pending transactions as failed (older than 5 minutes)\n  async markStaleTransactionsAsFailed(): Promise<number> {\n    const now = new Date();\n    const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);\n    const result = await db.update(transactions)\n      .set({ \n        status: \"FAILED\", \n        statusDescription: \"Transaction timed out\",\n        reconciliationStatus: \"UNMATCHED\",\n        updatedAt: now \n      })\n      .where(and(\n        eq(transactions.status, \"PENDING\"),\n        lte(transactions.createdAt, fiveMinutesAgo)\n      ))\n      .returning();\n    return result.length;\n  }\n\n  // ============== SUPER ADMIN METHODS ==============\n\n  // Get all tenants with enhanced stats\n  async getAllTenantsWithStats(): Promise<(Tenant & { \n    userCount: number; \n    transactionCount: number;\n    revenueThisMonth: number;\n  })[]> {\n    const allTenants = await db.select().from(tenants).orderBy(desc(tenants.createdAt));\n    \n    const tenantsWithStats = await Promise.all(allTenants.map(async (tenant) => {\n      const userCount = await db.select({ count: sql<number>`count(*)` })\n        .from(wifiUsers)\n        .where(eq(wifiUsers.tenantId, tenant.id));\n      \n      const startOfMonth = new Date();\n      startOfMonth.setDate(1);\n      startOfMonth.setHours(0, 0, 0, 0);\n      \n      const monthlyTransactions = await db.select({\n        count: sql<number>`count(*)`,\n        revenue: sql<number>`COALESCE(SUM(CASE WHEN status = 'COMPLETED' THEN amount ELSE 0 END), 0)`\n      })\n        .from(transactions)\n        .where(and(\n          eq(transactions.tenantId, tenant.id),\n          gte(transactions.createdAt, startOfMonth)\n        ));\n\n      return {\n        ...tenant,\n        userCount: Number(userCount[0]?.count || 0),\n        transactionCount: Number(monthlyTransactions[0]?.count || 0),\n        revenueThisMonth: Number(monthlyTransactions[0]?.revenue || 0),\n      };\n    }));\n\n    return tenantsWithStats;\n  }\n\n  // Get platform-wide analytics for super admin\n  async getPlatformAnalytics(): Promise<{\n    totalTenants: number;\n    activeTenants: number;\n    trialTenants: number;\n    suspendedTenants: number;\n    totalUsers: number;\n    totalRevenue: number;\n    revenueThisMonth: number;\n    revenueLastMonth: number;\n    transactionsToday: number;\n    newTenantsThisMonth: number;\n  }> {\n    const allTenants = await db.select().from(tenants);\n    \n    const now = new Date();\n    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n    const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);\n    const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);\n    const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n\n    const totalUsers = await db.select({ count: sql<number>`count(*)` }).from(wifiUsers);\n    \n    const allTimeRevenue = await db.select({ \n      total: sql<number>`COALESCE(SUM(CASE WHEN status = 'COMPLETED' THEN amount ELSE 0 END), 0)` \n    }).from(transactions);\n\n    const thisMonthRevenue = await db.select({ \n      total: sql<number>`COALESCE(SUM(CASE WHEN status = 'COMPLETED' THEN amount ELSE 0 END), 0)` \n    }).from(transactions).where(gte(transactions.createdAt, startOfMonth));\n\n    const lastMonthRevenue = await db.select({ \n      total: sql<number>`COALESCE(SUM(CASE WHEN status = 'COMPLETED' THEN amount ELSE 0 END), 0)` \n    }).from(transactions).where(and(\n      gte(transactions.createdAt, startOfLastMonth),\n      lte(transactions.createdAt, endOfLastMonth)\n    ));\n\n    const todayTransactions = await db.select({ count: sql<number>`count(*)` })\n      .from(transactions)\n      .where(gte(transactions.createdAt, startOfToday));\n\n    const newTenantsThisMonth = allTenants.filter(t => \n      t.createdAt && t.createdAt >= startOfMonth\n    ).length;\n\n    return {\n      totalTenants: allTenants.length,\n      activeTenants: allTenants.filter(t => t.saasBillingStatus === 'ACTIVE').length,\n      trialTenants: allTenants.filter(t => t.saasBillingStatus === 'TRIAL').length,\n      suspendedTenants: allTenants.filter(t => t.saasBillingStatus === 'SUSPENDED' || t.saasBillingStatus === 'BLOCKED').length,\n      totalUsers: Number(totalUsers[0]?.count || 0),\n      totalRevenue: Number(allTimeRevenue[0]?.total || 0),\n      revenueThisMonth: Number(thisMonthRevenue[0]?.total || 0),\n      revenueLastMonth: Number(lastMonthRevenue[0]?.total || 0),\n      transactionsToday: Number(todayTransactions[0]?.count || 0),\n      newTenantsThisMonth,\n    };\n  }\n\n  // Update tenant tier and subscription\n  async updateTenantSubscription(id: string, data: {\n    tier?: string;\n    saasBillingStatus?: string;\n    trialExpiresAt?: Date | null;\n    subscriptionExpiresAt?: Date | null;\n  }): Promise<Tenant | undefined> {\n    // Map 'tier' to 'subscriptionTier' for the database column\n    const updateData: any = {};\n    if (data.tier !== undefined) {\n      updateData.subscriptionTier = data.tier;\n    }\n    if (data.saasBillingStatus !== undefined) {\n      updateData.saasBillingStatus = data.saasBillingStatus;\n    }\n    if (data.trialExpiresAt !== undefined) {\n      updateData.trialExpiresAt = data.trialExpiresAt;\n    }\n    if (data.subscriptionExpiresAt !== undefined) {\n      updateData.subscriptionExpiresAt = data.subscriptionExpiresAt;\n    }\n    \n    const [updated] = await db.update(tenants)\n      .set(updateData)\n      .where(eq(tenants.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  // Get users by role\n  async getUsersByRole(role: string): Promise<User[]> {\n    return db.select().from(users).where(eq(users.role, role));\n  }\n\n  // Get all users for a tenant\n  async getUsersByTenant(tenantId: string): Promise<User[]> {\n    return db.select().from(users).where(eq(users.tenantId, tenantId));\n  }\n\n  // Get customer details with transactions and stats\n  async getCustomerDetails(customerId: string): Promise<{\n    customer: WifiUser;\n    currentPlan: Plan | null;\n    currentHotspot: Hotspot | null;\n    transactions: (Transaction & { planName: string | null })[];\n    stats: {\n      totalSpent: number;\n      totalTransactions: number;\n      successfulPayments: number;\n      failedPayments: number;\n      daysSinceRegistration: number;\n      averagePayment: number;\n    };\n  } | null> {\n    const customer = await this.getWifiUser(customerId);\n    if (!customer) {\n      return null;\n    }\n\n    let currentPlan: Plan | null = null;\n    if (customer.currentPlanId) {\n      currentPlan = await this.getPlan(customer.currentPlanId) || null;\n    }\n\n    let currentHotspot: Hotspot | null = null;\n    if (customer.currentHotspotId) {\n      currentHotspot = await this.getHotspot(customer.currentHotspotId) || null;\n    }\n\n    const customerTransactions = await db.select()\n      .from(transactions)\n      .where(eq(transactions.userPhone, customer.phoneNumber))\n      .orderBy(desc(transactions.createdAt));\n\n    const allPlans = await this.getPlans(customer.tenantId);\n    const plansMap = new Map(allPlans.map(p => [p.id, p]));\n\n    const transactionsWithPlanNames = customerTransactions.map(tx => ({\n      ...tx,\n      planName: tx.planId ? plansMap.get(tx.planId)?.name || null : null,\n    }));\n\n    const completedTransactions = customerTransactions.filter(t => t.status === \"COMPLETED\");\n    const failedTransactions = customerTransactions.filter(t => t.status === \"FAILED\");\n    const totalSpent = completedTransactions.reduce((sum, t) => sum + t.amount, 0);\n    \n    const daysSinceRegistration = customer.createdAt \n      ? Math.floor((Date.now() - new Date(customer.createdAt).getTime()) / (1000 * 60 * 60 * 24))\n      : 0;\n\n    return {\n      customer,\n      currentPlan,\n      currentHotspot,\n      transactions: transactionsWithPlanNames,\n      stats: {\n        totalSpent,\n        totalTransactions: customerTransactions.length,\n        successfulPayments: completedTransactions.length,\n        failedPayments: failedTransactions.length,\n        daysSinceRegistration,\n        averagePayment: completedTransactions.length > 0 \n          ? Math.round(totalSpent / completedTransactions.length) \n          : 0,\n      },\n    };\n  }\n\n  // Check if any superadmin exists\n  async hasSuperAdmin(): Promise<boolean> {\n    const superadmins = await db.select()\n      .from(users)\n      .where(eq(users.role, \"superadmin\"));\n    return superadmins.length > 0;\n  }\n\n  // Mark expired ISP trials as suspended\n  async markExpiredTrials(): Promise<number> {\n    const now = new Date();\n    const result = await db.update(tenants)\n      .set({ \n        saasBillingStatus: \"SUSPENDED\",\n      })\n      .where(and(\n        eq(tenants.saasBillingStatus, \"TRIAL\"),\n        lte(tenants.trialExpiresAt, now)\n      ))\n      .returning();\n    return result.length;\n  }\n\n  // Get tenants with expiring trials\n  async getExpiringTrials(hoursAhead: number = 24): Promise<Tenant[]> {\n    const now = new Date();\n    const futureTime = new Date(now.getTime() + hoursAhead * 60 * 60 * 1000);\n    return db.select()\n      .from(tenants)\n      .where(and(\n        eq(tenants.saasBillingStatus, \"TRIAL\"),\n        gte(tenants.trialExpiresAt, now),\n        lte(tenants.trialExpiresAt, futureTime)\n      ));\n  }\n\n  // SMS Campaign operations\n  async getSmsCampaigns(tenantId: string): Promise<SmsCampaign[]> {\n    return db.select()\n      .from(smsCampaigns)\n      .where(eq(smsCampaigns.tenantId, tenantId))\n      .orderBy(desc(smsCampaigns.createdAt));\n  }\n\n  async createSmsCampaign(campaign: InsertSmsCampaign): Promise<SmsCampaign> {\n    const [created] = await db.insert(smsCampaigns).values(campaign as any).returning();\n    return created;\n  }\n\n  async updateSmsCampaign(id: string, data: Partial<InsertSmsCampaign>): Promise<SmsCampaign | undefined> {\n    const [updated] = await db.update(smsCampaigns).set(data as any).where(eq(smsCampaigns.id, id)).returning();\n    return updated || undefined;\n  }\n\n  // Safe update method that only allows updating status-related fields\n  async updateSmsCampaignStatus(id: string, sentCount: number, failedCount: number): Promise<SmsCampaign | undefined> {\n    const status = failedCount > 0 && sentCount === 0 ? \"failed\" : \"completed\";\n    const [updated] = await db.update(smsCampaigns)\n      .set({ \n        sentCount, \n        failedCount, \n        status \n      } as any)\n      .where(eq(smsCampaigns.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  // Get WiFi users by IDs\n  async getWifiUsersByIds(tenantId: string, ids: string[]): Promise<WifiUser[]> {\n    if (ids.length === 0) return [];\n    return db.select()\n      .from(wifiUsers)\n      .where(and(\n        eq(wifiUsers.tenantId, tenantId),\n        inArray(wifiUsers.id, ids)\n      ));\n  }\n\n  // ============== WALLET OPERATIONS ==============\n\n  async getWallet(wifiUserId: string): Promise<Wallet | undefined> {\n    const [wallet] = await db.select()\n      .from(wallets)\n      .where(eq(wallets.wifiUserId, wifiUserId));\n    return wallet || undefined;\n  }\n\n  async getWalletByTenantAndUser(tenantId: string, wifiUserId: string): Promise<Wallet | undefined> {\n    const [wallet] = await db.select()\n      .from(wallets)\n      .where(and(\n        eq(wallets.tenantId, tenantId),\n        eq(wallets.wifiUserId, wifiUserId)\n      ));\n    return wallet || undefined;\n  }\n\n  async createWallet(wallet: InsertWallet): Promise<Wallet> {\n    const [created] = await db.insert(wallets).values(wallet as any).returning();\n    return created;\n  }\n\n  async getOrCreateWallet(tenantId: string, wifiUserId: string): Promise<Wallet> {\n    let wallet = await this.getWalletByTenantAndUser(tenantId, wifiUserId);\n    if (!wallet) {\n      wallet = await this.createWallet({\n        tenantId,\n        wifiUserId,\n        balance: 0,\n        totalDeposited: 0,\n        totalSpent: 0,\n        isActive: true,\n      });\n    }\n    return wallet;\n  }\n\n  async updateWalletBalance(walletId: string, newBalance: number): Promise<Wallet | undefined> {\n    const [updated] = await db.update(wallets)\n      .set({ \n        balance: newBalance,\n        updatedAt: new Date(),\n      })\n      .where(eq(wallets.id, walletId))\n      .returning();\n    return updated || undefined;\n  }\n\n  async addWalletTransaction(transaction: InsertWalletTransaction): Promise<WalletTransaction> {\n    const [created] = await db.insert(walletTransactions).values(transaction as any).returning();\n    return created;\n  }\n\n  async getWalletTransactions(walletId: string, limit: number = 50): Promise<WalletTransaction[]> {\n    return db.select()\n      .from(walletTransactions)\n      .where(eq(walletTransactions.walletId, walletId))\n      .orderBy(desc(walletTransactions.createdAt))\n      .limit(limit);\n  }\n\n  async depositToWallet(\n    tenantId: string, \n    wifiUserId: string, \n    amount: number, \n    description: string,\n    referenceId?: string,\n    referenceType?: string\n  ): Promise<{ wallet: Wallet; transaction: WalletTransaction }> {\n    const wallet = await this.getOrCreateWallet(tenantId, wifiUserId);\n    const newBalance = wallet.balance + amount;\n    \n    await db.update(wallets)\n      .set({\n        balance: newBalance,\n        totalDeposited: wallet.totalDeposited + amount,\n        updatedAt: new Date(),\n      })\n      .where(eq(wallets.id, wallet.id));\n\n    const transaction = await this.addWalletTransaction({\n      walletId: wallet.id,\n      tenantId,\n      type: WalletTransactionType.DEPOSIT,\n      amount,\n      balanceAfter: newBalance,\n      description,\n      referenceId,\n      referenceType,\n    });\n\n    const updatedWallet = await this.getWallet(wifiUserId);\n    return { wallet: updatedWallet!, transaction };\n  }\n\n  async deductFromWallet(\n    tenantId: string,\n    wifiUserId: string,\n    amount: number,\n    description: string,\n    referenceId?: string,\n    referenceType?: string\n  ): Promise<{ success: boolean; wallet?: Wallet; transaction?: WalletTransaction; error?: string }> {\n    const wallet = await this.getWalletByTenantAndUser(tenantId, wifiUserId);\n    \n    if (!wallet) {\n      return { success: false, error: \"Wallet not found\" };\n    }\n\n    if (wallet.balance < amount) {\n      return { success: false, error: \"Insufficient wallet balance\" };\n    }\n\n    const newBalance = wallet.balance - amount;\n    \n    await db.update(wallets)\n      .set({\n        balance: newBalance,\n        totalSpent: wallet.totalSpent + amount,\n        updatedAt: new Date(),\n      })\n      .where(eq(wallets.id, wallet.id));\n\n    const transaction = await this.addWalletTransaction({\n      walletId: wallet.id,\n      tenantId,\n      type: WalletTransactionType.PAYMENT,\n      amount: -amount,\n      balanceAfter: newBalance,\n      description,\n      referenceId,\n      referenceType,\n    });\n\n    const updatedWallet = await this.getWallet(wifiUserId);\n    return { success: true, wallet: updatedWallet, transaction };\n  }\n\n  async creditExcessToWallet(\n    tenantId: string,\n    wifiUserId: string,\n    amount: number,\n    description: string,\n    referenceId?: string\n  ): Promise<{ wallet: Wallet; transaction: WalletTransaction }> {\n    const wallet = await this.getOrCreateWallet(tenantId, wifiUserId);\n    const newBalance = wallet.balance + amount;\n    \n    await db.update(wallets)\n      .set({\n        balance: newBalance,\n        totalDeposited: wallet.totalDeposited + amount,\n        updatedAt: new Date(),\n      })\n      .where(eq(wallets.id, wallet.id));\n\n    const transaction = await this.addWalletTransaction({\n      walletId: wallet.id,\n      tenantId,\n      type: WalletTransactionType.EXCESS,\n      amount,\n      balanceAfter: newBalance,\n      description,\n      referenceId,\n      referenceType: \"transaction\",\n    });\n\n    const updatedWallet = await this.getWallet(wifiUserId);\n    return { wallet: updatedWallet!, transaction };\n  }\n\n  async getWalletsByTenant(tenantId: string): Promise<Wallet[]> {\n    return db.select()\n      .from(wallets)\n      .where(eq(wallets.tenantId, tenantId))\n      .orderBy(desc(wallets.balance));\n  }\n\n  // Voucher operations\n  async getVouchers(tenantId: string): Promise<Voucher[]> {\n    return db.select()\n      .from(vouchers)\n      .where(eq(vouchers.tenantId, tenantId))\n      .orderBy(desc(vouchers.createdAt));\n  }\n\n  async getVoucher(id: string): Promise<Voucher | undefined> {\n    const [voucher] = await db.select().from(vouchers).where(eq(vouchers.id, id));\n    return voucher || undefined;\n  }\n\n  async getVoucherByCode(tenantId: string, code: string): Promise<Voucher | undefined> {\n    const [voucher] = await db.select()\n      .from(vouchers)\n      .where(and(eq(vouchers.tenantId, tenantId), eq(vouchers.code, code)));\n    return voucher || undefined;\n  }\n\n  async createVoucher(voucher: InsertVoucher): Promise<Voucher> {\n    const [created] = await db.insert(vouchers).values(voucher).returning();\n    return created;\n  }\n\n  async createVoucherBatch(batch: InsertVoucherBatch, voucherCodes: string[]): Promise<{ batch: VoucherBatch; vouchers: Voucher[] }> {\n    const [createdBatch] = await db.insert(voucherBatches).values(batch).returning();\n    \n    const voucherInserts: InsertVoucher[] = voucherCodes.map(code => ({\n      tenantId: batch.tenantId,\n      batchId: createdBatch.id,\n      planId: batch.planId,\n      code,\n      status: VoucherStatus.AVAILABLE,\n      validFrom: batch.validFrom,\n      validUntil: batch.validUntil,\n    }));\n\n    const createdVouchers = await db.insert(vouchers).values(voucherInserts).returning();\n    return { batch: createdBatch, vouchers: createdVouchers };\n  }\n\n  async updateVoucher(id: string, data: Partial<InsertVoucher>): Promise<Voucher | undefined> {\n    const [updated] = await db.update(vouchers).set(data).where(eq(vouchers.id, id)).returning();\n    return updated || undefined;\n  }\n\n  async redeemVoucher(id: string, wifiUserId: string, macAddress?: string): Promise<Voucher | undefined> {\n    const voucher = await this.getVoucher(id);\n    if (!voucher || voucher.status !== VoucherStatus.AVAILABLE) {\n      return undefined;\n    }\n\n    const plan = await this.getPlan(voucher.planId);\n    if (!plan) {\n      return undefined;\n    }\n\n    const now = new Date();\n    const expiresAt = new Date(now.getTime() + plan.durationSeconds * 1000);\n\n    const [updated] = await db.update(vouchers)\n      .set({\n        status: VoucherStatus.USED,\n        usedBy: wifiUserId,\n        usedAt: now,\n        macAddress,\n        expiresAt,\n      })\n      .where(eq(vouchers.id, id))\n      .returning();\n\n    if (updated && updated.batchId) {\n      await db.update(voucherBatches)\n        .set({ usedCount: sql`${voucherBatches.usedCount} + 1` })\n        .where(eq(voucherBatches.id, updated.batchId));\n    }\n\n    return updated || undefined;\n  }\n\n  async getVoucherBatches(tenantId: string): Promise<VoucherBatch[]> {\n    return db.select()\n      .from(voucherBatches)\n      .where(eq(voucherBatches.tenantId, tenantId))\n      .orderBy(desc(voucherBatches.createdAt));\n  }\n\n  async getVoucherBatch(id: string): Promise<VoucherBatch | undefined> {\n    const [batch] = await db.select().from(voucherBatches).where(eq(voucherBatches.id, id));\n    return batch || undefined;\n  }\n\n  async getVouchersByBatch(batchId: string): Promise<Voucher[]> {\n    return db.select()\n      .from(vouchers)\n      .where(eq(vouchers.batchId, batchId))\n      .orderBy(vouchers.code);\n  }\n\n  async getVouchersByPhone(tenantId: string, phoneNumber: string): Promise<(Voucher & { planName?: string })[]> {\n    const wifiUser = await db.select().from(wifiUsers)\n      .where(and(\n        eq(wifiUsers.tenantId, tenantId),\n        eq(wifiUsers.phoneNumber, phoneNumber)\n      ))\n      .limit(1);\n    \n    if (!wifiUser.length) {\n      return [];\n    }\n\n    const userVouchers = await db.select({\n      id: vouchers.id,\n      tenantId: vouchers.tenantId,\n      batchId: vouchers.batchId,\n      planId: vouchers.planId,\n      code: vouchers.code,\n      status: vouchers.status,\n      usedBy: vouchers.usedBy,\n      usedAt: vouchers.usedAt,\n      macAddress: vouchers.macAddress,\n      expiresAt: vouchers.expiresAt,\n      validFrom: vouchers.validFrom,\n      validUntil: vouchers.validUntil,\n      createdAt: vouchers.createdAt,\n      planName: plans.name,\n    })\n      .from(vouchers)\n      .leftJoin(plans, eq(vouchers.planId, plans.id))\n      .where(and(\n        eq(vouchers.tenantId, tenantId),\n        eq(vouchers.usedBy, wifiUser[0].id)\n      ))\n      .orderBy(desc(vouchers.usedAt));\n\n    return userVouchers.map(v => ({\n      ...v,\n      planName: v.planName ?? undefined,\n    }));\n  }\n\n  async deleteVoucher(id: string): Promise<boolean> {\n    const result = await db.delete(vouchers).where(eq(vouchers.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Zone operations\n  async getZones(tenantId: string): Promise<Zone[]> {\n    return db.select().from(zones).where(eq(zones.tenantId, tenantId)).orderBy(zones.name);\n  }\n\n  async getZone(id: string): Promise<Zone | undefined> {\n    const [zone] = await db.select().from(zones).where(eq(zones.id, id));\n    return zone || undefined;\n  }\n\n  async createZone(zone: InsertZone): Promise<Zone> {\n    const [created] = await db.insert(zones).values(zone).returning();\n    return created;\n  }\n\n  async updateZone(id: string, data: Partial<InsertZone>): Promise<Zone | undefined> {\n    const [updated] = await db.update(zones).set(data).where(eq(zones.id, id)).returning();\n    return updated || undefined;\n  }\n\n  async deleteZone(id: string): Promise<boolean> {\n    const result = await db.delete(zones).where(eq(zones.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Audit log operations\n  async getAuditLogs(tenantId: string, limit = 100): Promise<AuditLog[]> {\n    return db.select().from(auditLogs)\n      .where(eq(auditLogs.tenantId, tenantId))\n      .orderBy(desc(auditLogs.createdAt))\n      .limit(limit);\n  }\n\n  async createAuditLog(log: InsertAuditLog): Promise<AuditLog> {\n    const [created] = await db.insert(auditLogs).values(log).returning();\n    return created;\n  }\n\n  // Chat operations\n  async getChatMessages(tenantId: string, wifiUserId: string): Promise<ChatMessage[]> {\n    return db.select().from(chatMessages)\n      .where(and(\n        eq(chatMessages.tenantId, tenantId),\n        eq(chatMessages.wifiUserId, wifiUserId)\n      ))\n      .orderBy(chatMessages.createdAt);\n  }\n\n  async getUnreadChats(tenantId: string): Promise<{ wifiUserId: string; count: number }[]> {\n    const result = await db.select({\n      wifiUserId: chatMessages.wifiUserId,\n      count: sql<number>`count(*)::int`,\n    })\n      .from(chatMessages)\n      .where(and(\n        eq(chatMessages.tenantId, tenantId),\n        eq(chatMessages.isFromCustomer, true),\n        eq(chatMessages.isRead, false)\n      ))\n      .groupBy(chatMessages.wifiUserId);\n    return result.filter(r => r.wifiUserId !== null) as { wifiUserId: string; count: number }[];\n  }\n\n  async createChatMessage(message: InsertChatMessage): Promise<ChatMessage> {\n    const [created] = await db.insert(chatMessages).values(message).returning();\n    return created;\n  }\n\n  async markMessagesAsRead(tenantId: string, wifiUserId: string): Promise<void> {\n    await db.update(chatMessages)\n      .set({ isRead: true })\n      .where(and(\n        eq(chatMessages.tenantId, tenantId),\n        eq(chatMessages.wifiUserId, wifiUserId),\n        eq(chatMessages.isFromCustomer, true)\n      ));\n  }\n\n  // Loyalty points operations\n  async getLoyaltyPoints(tenantId: string, wifiUserId: string): Promise<LoyaltyPoints | undefined> {\n    const [loyalty] = await db.select().from(loyaltyPoints)\n      .where(and(\n        eq(loyaltyPoints.tenantId, tenantId),\n        eq(loyaltyPoints.wifiUserId, wifiUserId)\n      ));\n    return loyalty || undefined;\n  }\n\n  async getOrCreateLoyaltyPoints(tenantId: string, wifiUserId: string): Promise<LoyaltyPoints> {\n    let loyalty = await this.getLoyaltyPoints(tenantId, wifiUserId);\n    if (!loyalty) {\n      const [created] = await db.insert(loyaltyPoints).values({\n        tenantId,\n        wifiUserId,\n        points: 0,\n        totalEarned: 0,\n        totalRedeemed: 0,\n      }).returning();\n      loyalty = created;\n    }\n    return loyalty;\n  }\n\n  async addLoyaltyPoints(tenantId: string, wifiUserId: string, points: number, description?: string, referenceId?: string): Promise<LoyaltyPoints> {\n    const loyalty = await this.getOrCreateLoyaltyPoints(tenantId, wifiUserId);\n    \n    const [updated] = await db.update(loyaltyPoints)\n      .set({\n        points: sql`${loyaltyPoints.points} + ${points}`,\n        totalEarned: sql`${loyaltyPoints.totalEarned} + ${points}`,\n        lastEarnedAt: new Date(),\n      })\n      .where(eq(loyaltyPoints.id, loyalty.id))\n      .returning();\n\n    await db.insert(loyaltyTransactions).values({\n      tenantId,\n      loyaltyId: loyalty.id,\n      type: \"EARNED\",\n      points,\n      description,\n      referenceId,\n    });\n\n    return updated;\n  }\n\n  async redeemLoyaltyPoints(tenantId: string, wifiUserId: string, points: number, description?: string): Promise<LoyaltyPoints | null> {\n    const loyalty = await this.getLoyaltyPoints(tenantId, wifiUserId);\n    if (!loyalty || loyalty.points < points) {\n      return null;\n    }\n\n    const [updated] = await db.update(loyaltyPoints)\n      .set({\n        points: sql`${loyaltyPoints.points} - ${points}`,\n        totalRedeemed: sql`${loyaltyPoints.totalRedeemed} + ${points}`,\n      })\n      .where(eq(loyaltyPoints.id, loyalty.id))\n      .returning();\n\n    await db.insert(loyaltyTransactions).values({\n      tenantId,\n      loyaltyId: loyalty.id,\n      type: \"REDEEMED\",\n      points: -points,\n      description,\n    });\n\n    return updated;\n  }\n\n  async getLoyaltyTransactions(loyaltyId: string): Promise<LoyaltyTransaction[]> {\n    return db.select().from(loyaltyTransactions)\n      .where(eq(loyaltyTransactions.loyaltyId, loyaltyId))\n      .orderBy(desc(loyaltyTransactions.createdAt));\n  }\n\n  // Login attempt operations\n  async recordLoginAttempt(attempt: InsertLoginAttempt): Promise<LoginAttempt> {\n    const [created] = await db.insert(loginAttempts).values(attempt).returning();\n    return created;\n  }\n\n  async getRecentLoginAttempts(username: string, minutes = 15): Promise<LoginAttempt[]> {\n    const since = new Date(Date.now() - minutes * 60 * 1000);\n    return db.select().from(loginAttempts)\n      .where(and(\n        eq(loginAttempts.username, username),\n        gte(loginAttempts.createdAt, since)\n      ))\n      .orderBy(desc(loginAttempts.createdAt));\n  }\n\n  async countFailedLoginAttempts(username: string, minutes = 15): Promise<number> {\n    const attempts = await this.getRecentLoginAttempts(username, minutes);\n    return attempts.filter(a => !a.success).length;\n  }\n\n  // Router Backup operations\n  async getRouterBackups(tenantId: string, hotspotId: string): Promise<RouterBackup[]> {\n    return db.select().from(routerBackups)\n      .where(and(\n        eq(routerBackups.tenantId, tenantId),\n        eq(routerBackups.hotspotId, hotspotId)\n      ))\n      .orderBy(desc(routerBackups.createdAt));\n  }\n\n  async getRouterBackup(id: string): Promise<RouterBackup | undefined> {\n    const [backup] = await db.select().from(routerBackups).where(eq(routerBackups.id, id));\n    return backup || undefined;\n  }\n\n  async createRouterBackup(backup: InsertRouterBackup): Promise<RouterBackup> {\n    const [created] = await db.insert(routerBackups).values(backup).returning();\n    return created;\n  }\n\n  async deleteRouterBackup(id: string): Promise<boolean> {\n    const result = await db.delete(routerBackups).where(eq(routerBackups.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // Login Page Template operations\n  async getLoginPageTemplates(tenantId: string): Promise<LoginPageTemplate[]> {\n    return db.select().from(loginPageTemplates)\n      .where(eq(loginPageTemplates.tenantId, tenantId))\n      .orderBy(desc(loginPageTemplates.createdAt));\n  }\n\n  async getLoginPageTemplate(id: string): Promise<LoginPageTemplate | undefined> {\n    const [template] = await db.select().from(loginPageTemplates).where(eq(loginPageTemplates.id, id));\n    return template || undefined;\n  }\n\n  async createLoginPageTemplate(template: InsertLoginPageTemplate): Promise<LoginPageTemplate> {\n    const [created] = await db.insert(loginPageTemplates).values(template).returning();\n    return created;\n  }\n\n  async updateLoginPageTemplate(id: string, data: Partial<InsertLoginPageTemplate>): Promise<LoginPageTemplate | undefined> {\n    const [updated] = await db.update(loginPageTemplates)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(loginPageTemplates.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  async deleteLoginPageTemplate(id: string): Promise<boolean> {\n    const result = await db.delete(loginPageTemplates).where(eq(loginPageTemplates.id, id)).returning();\n    return result.length > 0;\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":55941,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* MnetiFi Glassmorphism Dark Theme - Vaultic Inspired */\n:root {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  \n  /* Deep Navy Base */\n  --background: 222 47% 11%;\n  --foreground: 210 40% 98%;\n  \n  /* Glassmorphism Borders */\n  --border: 217 33% 17%;\n  \n  /* Glass Card Surface */\n  --card: 222 47% 13%;\n  --card-foreground: 210 40% 98%;\n  --card-border: 217 33% 20%;\n  \n  /* Sidebar - Glass Panel */\n  --sidebar: 222 47% 12%;\n  --sidebar-foreground: 210 40% 98%;\n  --sidebar-border: 217 33% 18%;\n  --sidebar-primary: 189 94% 43%;\n  --sidebar-primary-foreground: 210 40% 98%;\n  --sidebar-accent: 222 30% 18%;\n  --sidebar-accent-foreground: 210 40% 98%;\n  --sidebar-ring: 189 94% 43%;\n  \n  /* Popover - Glass Surface */\n  --popover: 222 47% 14%;\n  --popover-foreground: 210 40% 98%;\n  --popover-border: 217 33% 22%;\n  \n  /* Primary - Cyan Accent */\n  --primary: 189 94% 43%;\n  --primary-foreground: 222 47% 11%;\n  \n  /* Secondary - Glass Muted */\n  --secondary: 217 33% 17%;\n  --secondary-foreground: 210 40% 98%;\n  \n  /* Muted Text */\n  --muted: 215 20% 20%;\n  --muted-foreground: 215 20% 65%;\n  \n  /* Accent - Subtle Glass */\n  --accent: 217 33% 18%;\n  --accent-foreground: 210 40% 98%;\n  \n  /* Destructive - Magenta */\n  --destructive: 330 85% 60%;\n  --destructive-foreground: 210 40% 98%;\n  \n  /* Input - Recessed Style */\n  --input: 222 47% 8%;\n  \n  /* Ring - Cyan Focus */\n  --ring: 189 94% 43%;\n  \n  /* Charts */\n  --chart-1: 189 94% 50%;\n  --chart-2: 263 70% 50%;\n  --chart-3: 330 85% 60%;\n  --chart-4: 217 91% 60%;\n  --chart-5: 173 58% 39%;\n  \n  --font-sans: Inter, Plus Jakarta Sans, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, monospace;\n  --radius: .5rem;\n  \n  /* Glass Shadows */\n  --shadow-2xs: 0px 2px 0px 0px hsl(222 47% 5% / 0.20);\n  --shadow-xs: 0px 2px 0px 0px hsl(222 47% 5% / 0.25);\n  --shadow-sm: 0px 2px 0px 0px hsl(222 47% 5% / 0.25), 0px 1px 2px -1px hsl(222 47% 5% / 0.30);\n  --shadow: 0px 2px 0px 0px hsl(222 47% 5% / 0.25), 0px 1px 2px -1px hsl(222 47% 5% / 0.30);\n  --shadow-md: 0px 2px 0px 0px hsl(222 47% 5% / 0.30), 0px 2px 4px -1px hsl(222 47% 5% / 0.35);\n  --shadow-lg: 0px 2px 0px 0px hsl(222 47% 5% / 0.35), 0px 4px 6px -1px hsl(222 47% 5% / 0.40);\n  --shadow-xl: 0px 2px 0px 0px hsl(222 47% 5% / 0.40), 0px 8px 10px -1px hsl(222 47% 5% / 0.45);\n  --shadow-2xl: 0px 2px 0px 0px hsl(222 47% 5% / 0.50);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n  /* Border Color Fallbacks */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --primary-border: hsl(var(--primary));\n  --secondary-border: hsl(var(--secondary));\n  --muted-border: hsl(var(--muted));\n  --accent-border: hsl(var(--accent));\n  --destructive-border: hsl(var(--destructive));\n}\n\n/* Force dark mode always for MnetiFi */\n.dark,\nhtml {\n  color-scheme: dark;\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  html {\n    @apply dark;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n    background-color: #0f172a;\n  }\n}\n\n@layer components {\n  /* Mesh Gradient Background */\n  .mesh-bg {\n    position: fixed;\n    inset: 0;\n    z-index: -1;\n    background-color: #0f172a;\n    overflow: hidden;\n  }\n\n  .mesh-bg::before {\n    content: \"\";\n    position: absolute;\n    width: 150%;\n    height: 150%;\n    top: -25%;\n    left: -25%;\n    background: \n      radial-gradient(ellipse at 20% 20%, rgba(124, 58, 237, 0.35) 0%, transparent 50%),\n      radial-gradient(ellipse at 80% 20%, rgba(6, 182, 212, 0.3) 0%, transparent 50%),\n      radial-gradient(ellipse at 60% 80%, rgba(236, 72, 153, 0.3) 0%, transparent 50%),\n      radial-gradient(ellipse at 10% 70%, rgba(59, 130, 246, 0.25) 0%, transparent 45%);\n    animation: mesh-drift 45s ease-in-out infinite;\n  }\n\n  @keyframes mesh-drift {\n    0%, 100% {\n      transform: translate(0, 0) rotate(0deg);\n    }\n    25% {\n      transform: translate(3%, 2%) rotate(1deg);\n    }\n    50% {\n      transform: translate(-2%, 4%) rotate(-1deg);\n    }\n    75% {\n      transform: translate(4%, -2%) rotate(0.5deg);\n    }\n  }\n\n  /* Glass Panel */\n  .glass-panel {\n    background: rgba(255, 255, 255, 0.05);\n    backdrop-filter: blur(16px) saturate(180%);\n    -webkit-backdrop-filter: blur(16px) saturate(180%);\n    border-radius: 24px;\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-top-color: rgba(255, 255, 255, 0.2);\n    border-left-color: rgba(255, 255, 255, 0.15);\n    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);\n  }\n\n  /* Glass Panel Hover */\n  .glass-panel-hover {\n    transition: all 0.3s ease;\n  }\n\n  .glass-panel-hover:hover {\n    background: rgba(255, 255, 255, 0.08);\n    transform: translateY(-4px);\n    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);\n  }\n\n  /* Glass Input - Recessed Style */\n  .glass-input {\n    background: rgba(0, 0, 0, 0.3);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: 12px;\n    transition: all 0.2s ease;\n  }\n\n  .glass-input:focus {\n    border-color: rgba(255, 255, 255, 0.3);\n    box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);\n    outline: none;\n  }\n\n  .glass-input::placeholder {\n    color: rgba(255, 255, 255, 0.3);\n  }\n\n  /* Gradient Text */\n  .gradient-text {\n    background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);\n    -webkit-background-clip: text;\n    -webkit-text-fill-color: transparent;\n    background-clip: text;\n  }\n\n  .gradient-text-accent {\n    background: linear-gradient(135deg, #7c3aed 0%, #ec4899 100%);\n    -webkit-background-clip: text;\n    -webkit-text-fill-color: transparent;\n    background-clip: text;\n  }\n\n  /* Gradient Button */\n  .gradient-btn {\n    background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);\n    border: none;\n    border-radius: 16px;\n    color: white;\n    font-weight: 600;\n    transition: all 0.2s ease;\n    position: relative;\n    overflow: hidden;\n  }\n\n  .gradient-btn::before {\n    content: \"\";\n    position: absolute;\n    inset: 0;\n    background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 50%);\n    opacity: 0;\n    transition: opacity 0.2s ease;\n  }\n\n  .gradient-btn:hover::before {\n    opacity: 1;\n  }\n\n  .gradient-btn:active {\n    transform: scale(0.98);\n  }\n\n  /* M-Pesa Button */\n  .mpesa-btn {\n    background: linear-gradient(135deg, #4BB617 0%, #5fd423 100%);\n    border: none;\n    border-radius: 16px;\n    color: white;\n    font-weight: 600;\n    transition: all 0.2s ease;\n    box-shadow: 0 4px 20px rgba(75, 182, 23, 0.3);\n  }\n\n  .mpesa-btn:hover {\n    box-shadow: 0 6px 30px rgba(75, 182, 23, 0.4);\n    transform: translateY(-2px);\n  }\n\n  .mpesa-btn:active {\n    transform: scale(0.98) translateY(0);\n  }\n\n  /* Status Indicators */\n  .status-pending {\n    animation: pulse-purple 2s ease-in-out infinite;\n  }\n\n  @keyframes pulse-purple {\n    0%, 100% {\n      box-shadow: 0 0 10px rgba(124, 58, 237, 0.4);\n    }\n    50% {\n      box-shadow: 0 0 20px rgba(124, 58, 237, 0.7);\n    }\n  }\n\n  .status-completed {\n    box-shadow: 0 0 15px rgba(6, 182, 212, 0.4);\n  }\n\n  .status-failed {\n    box-shadow: 0 0 15px rgba(236, 72, 153, 0.4);\n  }\n\n  /* Scrollbar Styling */\n  ::-webkit-scrollbar {\n    width: 8px;\n    height: 8px;\n  }\n\n  ::-webkit-scrollbar-track {\n    background: rgba(255, 255, 255, 0.05);\n    border-radius: 4px;\n  }\n\n  ::-webkit-scrollbar-thumb {\n    background: rgba(255, 255, 255, 0.1);\n    border-radius: 4px;\n  }\n\n  ::-webkit-scrollbar-thumb:hover {\n    background: rgba(255, 255, 255, 0.2);\n  }\n\n  /* Mobile Fallback for Glass */\n  @supports not (backdrop-filter: blur(16px)) {\n    .glass-panel {\n      background: rgba(15, 23, 42, 0.95);\n    }\n  }\n}\n\n@layer utilities {\n  /* Hide ugly search cancel button in Chrome */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  .no-default-hover-elevate {}\n  .no-default-active-elevate {}\n\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    border-radius: inherit;\n    z-index: -1;\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    border-radius: inherit;\n    z-index: 999;\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after {\n    inset: -1px;\n  }\n\n  /* Text hierarchy utilities */\n  .text-primary-content {\n    color: #FFFFFF;\n  }\n\n  .text-secondary-content {\n    color: #94a3b8;\n  }\n\n  .text-tertiary-content {\n    color: rgba(255, 255, 255, 0.5);\n  }\n}\n","path":null,"size_bytes":10022,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\n\nconst isReplit = process.env.REPL_ID !== undefined;\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    ...(isReplit\n      ? [\n          await import(\"@replit/vite-plugin-runtime-error-modal\").then((m) =>\n            m.default(),\n          ),\n          ...(process.env.NODE_ENV !== \"production\"\n            ? [\n                await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n                  m.cartographer(),\n                ),\n                await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n                  m.devBanner(),\n                ),\n              ]\n            : []),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1216,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/components/status-badge.tsx":{"content":"import { cn } from \"@/lib/utils\";\nimport { motion } from \"framer-motion\";\nimport { Check, X, Loader2 } from \"lucide-react\";\nimport type { TransactionStatusType } from \"@shared/schema\";\n\ninterface StatusBadgeProps {\n  status: TransactionStatusType;\n  size?: \"sm\" | \"md\" | \"lg\";\n  showIcon?: boolean;\n  className?: string;\n}\n\nexport function StatusBadge({\n  status,\n  size = \"md\",\n  showIcon = true,\n  className,\n}: StatusBadgeProps) {\n  const sizeClasses = {\n    sm: \"px-2 py-0.5 text-xs gap-1\",\n    md: \"px-3 py-1 text-sm gap-1.5\",\n    lg: \"px-4 py-1.5 text-base gap-2\",\n  };\n\n  const iconSizes = {\n    sm: 12,\n    md: 14,\n    lg: 16,\n  };\n\n  const statusConfig = {\n    PENDING: {\n      bg: \"bg-purple-500/20\",\n      text: \"text-purple-300\",\n      border: \"border-purple-500/30\",\n      icon: <Loader2 size={iconSizes[size]} className=\"animate-spin\" />,\n      label: \"Pending\",\n      glow: \"shadow-glow-purple\",\n    },\n    COMPLETED: {\n      bg: \"bg-cyan-500/20\",\n      text: \"text-cyan-300\",\n      border: \"border-cyan-500/30\",\n      icon: <Check size={iconSizes[size]} />,\n      label: \"Completed\",\n      glow: \"shadow-glow\",\n    },\n    FAILED: {\n      bg: \"bg-pink-500/20\",\n      text: \"text-pink-300\",\n      border: \"border-pink-500/30\",\n      icon: <X size={iconSizes[size]} />,\n      label: \"Failed\",\n      glow: \"shadow-glow-magenta\",\n    },\n  };\n\n  const config = statusConfig[status];\n\n  return (\n    <motion.span\n      className={cn(\n        \"inline-flex items-center font-medium rounded-full border\",\n        sizeClasses[size],\n        config.bg,\n        config.text,\n        config.border,\n        status === \"PENDING\" && \"animate-pulse\",\n        className\n      )}\n      initial={{ scale: 0.9, opacity: 0 }}\n      animate={{ scale: 1, opacity: 1 }}\n      transition={{ type: \"spring\", stiffness: 500, damping: 30 }}\n      data-testid={`status-badge-${status.toLowerCase()}`}\n    >\n      {showIcon && config.icon}\n      <span>{config.label}</span>\n    </motion.span>\n  );\n}\n\n// Status indicator dot\ninterface StatusDotProps {\n  status: TransactionStatusType;\n  size?: \"sm\" | \"md\" | \"lg\";\n  pulse?: boolean;\n}\n\nexport function StatusDot({ status, size = \"md\", pulse = true }: StatusDotProps) {\n  const sizeClasses = {\n    sm: \"w-2 h-2\",\n    md: \"w-3 h-3\",\n    lg: \"w-4 h-4\",\n  };\n\n  const statusColors = {\n    PENDING: \"bg-purple-400\",\n    COMPLETED: \"bg-cyan-400\",\n    FAILED: \"bg-pink-400\",\n  };\n\n  return (\n    <span className=\"relative flex\">\n      {pulse && status === \"PENDING\" && (\n        <span\n          className={cn(\n            \"absolute inline-flex h-full w-full rounded-full opacity-75 animate-ping\",\n            statusColors[status]\n          )}\n        />\n      )}\n      <span\n        className={cn(\n          \"relative inline-flex rounded-full\",\n          sizeClasses[size],\n          statusColors[status]\n        )}\n        data-testid={`status-dot-${status.toLowerCase()}`}\n      />\n    </span>\n  );\n}\n","path":null,"size_bytes":2931,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1383,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"server/services/payment-worker.ts":{"content":"import { jobQueue } from \"./job-queue\";\nimport { MpesaService } from \"./mpesa\";\nimport { createMikrotikService, MikrotikService } from \"./mikrotik\";\nimport { storage } from \"../storage\";\nimport { JobType, TransactionStatus, ReconciliationStatus, WifiUserStatus, WalletTransactionType } from \"@shared/schema\";\nimport type { Job, Tenant, Plan, WifiUser } from \"@shared/schema\";\n\nexport class PaymentWorker {\n  private isRunning = false;\n  private pollInterval: ReturnType<typeof setInterval> | null = null;\n  private stuckJobInterval: ReturnType<typeof setInterval> | null = null;\n  private expiryCheckInterval: ReturnType<typeof setInterval> | null = null;\n  private trialCheckInterval: ReturnType<typeof setInterval> | null = null;\n  private expiryWarningInterval: ReturnType<typeof setInterval> | null = null;\n  private readonly POLL_INTERVAL_MS = 5000;\n  private readonly STUCK_CHECK_INTERVAL_MS = 60000;\n  private readonly EXPIRY_CHECK_INTERVAL_MS = 30000;\n  private readonly TRIAL_CHECK_INTERVAL_MS = 60000; // Check trials every minute\n  private readonly EXPIRY_WARNING_INTERVAL_MS = 300000; // Check for expiry warnings every 5 minutes\n  private notifiedUsers: Set<string> = new Set(); // Track users already notified to avoid duplicates\n\n  start(): void {\n    if (this.isRunning) {\n      console.log(\"[PaymentWorker] Already running\");\n      return;\n    }\n\n    this.isRunning = true;\n    console.log(\"[PaymentWorker] Started - polling every\", this.POLL_INTERVAL_MS / 1000, \"seconds\");\n\n    this.pollInterval = setInterval(async () => {\n      await this.processNextJob();\n    }, this.POLL_INTERVAL_MS);\n\n    this.stuckJobInterval = setInterval(async () => {\n      await this.resetStuckJobs();\n    }, this.STUCK_CHECK_INTERVAL_MS);\n\n    this.expiryCheckInterval = setInterval(async () => {\n      await this.checkAndMarkExpiredUsers();\n    }, this.EXPIRY_CHECK_INTERVAL_MS);\n\n    this.trialCheckInterval = setInterval(async () => {\n      await this.checkAndExpireTrials();\n    }, this.TRIAL_CHECK_INTERVAL_MS);\n\n    this.expiryWarningInterval = setInterval(async () => {\n      await this.sendExpiryWarnings();\n    }, this.EXPIRY_WARNING_INTERVAL_MS);\n\n    this.processNextJob();\n    this.checkAndMarkExpiredUsers();\n    this.checkAndExpireTrials();\n    this.sendExpiryWarnings();\n  }\n\n  private async resetStuckJobs(): Promise<void> {\n    try {\n      const count = await jobQueue.resetStuckJobs(15);\n      if (count > 0) {\n        console.log(`[PaymentWorker] Reset ${count} stuck jobs`);\n      }\n    } catch (error) {\n      console.error(\"[PaymentWorker] Error resetting stuck jobs:\", error);\n    }\n  }\n\n  stop(): void {\n    if (this.pollInterval) {\n      clearInterval(this.pollInterval);\n      this.pollInterval = null;\n    }\n    if (this.stuckJobInterval) {\n      clearInterval(this.stuckJobInterval);\n      this.stuckJobInterval = null;\n    }\n    if (this.expiryCheckInterval) {\n      clearInterval(this.expiryCheckInterval);\n      this.expiryCheckInterval = null;\n    }\n    if (this.trialCheckInterval) {\n      clearInterval(this.trialCheckInterval);\n      this.trialCheckInterval = null;\n    }\n    if (this.expiryWarningInterval) {\n      clearInterval(this.expiryWarningInterval);\n      this.expiryWarningInterval = null;\n    }\n    this.isRunning = false;\n    console.log(\"[PaymentWorker] Stopped\");\n  }\n\n  private async checkAndExpireTrials(): Promise<void> {\n    try {\n      const expiredCount = await storage.markExpiredTrials();\n      if (expiredCount > 0) {\n        console.log(`[PaymentWorker] Suspended ${expiredCount} ISP(s) with expired trials`);\n      }\n    } catch (error) {\n      console.error(\"[PaymentWorker] Error checking expired trials:\", error);\n    }\n  }\n\n  private async checkAndMarkExpiredUsers(): Promise<void> {\n    try {\n      const expiredCount = await storage.markExpiredUsers();\n      if (expiredCount > 0) {\n        console.log(`[PaymentWorker] Marked ${expiredCount} users as expired`);\n      }\n      \n      const staleTxCount = await storage.markStaleTransactionsAsFailed();\n      if (staleTxCount > 0) {\n        console.log(`[PaymentWorker] Marked ${staleTxCount} stale transactions as failed`);\n      }\n    } catch (error) {\n      console.error(\"[PaymentWorker] Error checking expired users:\", error);\n    }\n  }\n\n  private async sendExpiryWarnings(): Promise<void> {\n    try {\n      // Get all active tenants\n      const allTenants = await storage.getAllTenants();\n      const activeTenants = allTenants.filter((t: Tenant) => t.saasBillingStatus === \"ACTIVE\" || t.saasBillingStatus === \"TRIAL\");\n      \n      for (const tenant of activeTenants) {\n        // Get users expiring within 24 hours\n        const expiringUsers = await storage.getExpiringWifiUsers(tenant.id, 1); // 1 day\n        \n        for (const user of expiringUsers) {\n          // Skip if already notified\n          const notificationKey = `${user.id}_24h`;\n          if (this.notifiedUsers.has(notificationKey)) {\n            continue;\n          }\n\n          // Calculate hours remaining\n          const hoursRemaining = user.expiryTime \n            ? Math.max(0, Math.ceil((new Date(user.expiryTime).getTime() - Date.now()) / (1000 * 60 * 60)))\n            : 0;\n\n          // Only send if expiring within 24 hours\n          if (hoursRemaining <= 24 && hoursRemaining > 0) {\n            try {\n              // Import SMS service dynamically to avoid circular deps\n              const { getSmsService } = await import(\"./sms\");\n              const smsService = getSmsService();\n              \n              const result = await smsService.sendExpiryReminder(user, hoursRemaining);\n              \n              if (result.success) {\n                console.log(`[PaymentWorker] Sent expiry warning to ${user.phoneNumber} (${hoursRemaining}h remaining)`);\n                this.notifiedUsers.add(notificationKey);\n                \n                // Clean up old notification keys after 48 hours\n                setTimeout(() => {\n                  this.notifiedUsers.delete(notificationKey);\n                }, 48 * 60 * 60 * 1000);\n              } else {\n                console.warn(`[PaymentWorker] Failed to send expiry warning to ${user.phoneNumber}: ${result.error}`);\n              }\n            } catch (smsError) {\n              console.error(`[PaymentWorker] SMS error for ${user.phoneNumber}:`, smsError);\n            }\n          }\n        }\n      }\n    } catch (error) {\n      console.error(\"[PaymentWorker] Error sending expiry warnings:\", error);\n    }\n  }\n\n  private async processNextJob(): Promise<void> {\n    try {\n      const job = await jobQueue.getNextJob();\n      if (!job) return;\n\n      console.log(`[PaymentWorker] Processing job ${job.id} (${job.type})`);\n\n      switch (job.type) {\n        case JobType.PAYMENT_STATUS_CHECK:\n          await this.handlePaymentStatusCheck(job);\n          break;\n        case JobType.USER_EXPIRY_CHECK:\n          await this.handleUserExpiryCheck(job);\n          break;\n        case JobType.RECONCILIATION:\n          await this.handleReconciliation(job);\n          break;\n        case JobType.SMS_NOTIFICATION:\n          await this.handleSmsNotification(job);\n          break;\n        default:\n          console.warn(`[PaymentWorker] Unknown job type: ${job.type}`);\n          await jobQueue.markFailed(job.id, `Unknown job type: ${job.type}`);\n      }\n    } catch (error) {\n      console.error(\"[PaymentWorker] Error processing job:\", error);\n    }\n  }\n\n  private async handlePaymentStatusCheck(job: Job): Promise<void> {\n    const { transactionId, checkoutRequestId } = job.payload as {\n      transactionId: string;\n      checkoutRequestId: string;\n    };\n\n    try {\n      const transaction = await storage.getTransaction(transactionId);\n      if (!transaction) {\n        await jobQueue.markFailed(job.id, \"Transaction not found\");\n        return;\n      }\n\n      if (transaction.status === TransactionStatus.COMPLETED) {\n        console.log(`[PaymentWorker] Transaction ${transactionId} already completed`);\n        await jobQueue.markCompleted(job.id);\n        return;\n      }\n\n      if (!job.tenantId) {\n        await jobQueue.markFailed(job.id, \"No tenant ID for job\");\n        return;\n      }\n\n      const tenant = await storage.getTenant(job.tenantId);\n      if (!tenant) {\n        await jobQueue.markFailed(job.id, \"Tenant not found\");\n        return;\n      }\n\n      if (!tenant.mpesaConsumerKey || !tenant.mpesaConsumerSecret) {\n        console.log(`[PaymentWorker] No M-Pesa credentials configured - simulating payment for demo`);\n        \n        const attempts = job.attempts ?? 0;\n        if (attempts >= 2) {\n          const shouldFail = Math.random() < 0.1;\n          \n          if (shouldFail) {\n            await storage.updateTransaction(transactionId, {\n              status: TransactionStatus.FAILED,\n              reconciliationStatus: ReconciliationStatus.UNMATCHED,\n              statusDescription: \"Payment cancelled by user (simulated)\",\n            });\n            console.log(`[PaymentWorker] Transaction ${transactionId} failed (simulated)`);\n          } else {\n            const receiptNumber = `SIM${Date.now()}`;\n            await storage.updateTransaction(transactionId, {\n              status: TransactionStatus.COMPLETED,\n              mpesaReceiptNumber: receiptNumber,\n              reconciliationStatus: ReconciliationStatus.MATCHED,\n              statusDescription: \"Payment confirmed (simulated)\",\n            });\n            await this.activateUserAfterPayment(transaction.tenantId, transaction);\n            console.log(`[PaymentWorker] Transaction ${transactionId} completed (simulated)`);\n          }\n          await jobQueue.markCompleted(job.id);\n        } else {\n          await jobQueue.markFailed(job.id, \"Waiting for payment confirmation...\");\n        }\n        return;\n      }\n\n      const mpesa = new MpesaService(tenant, true);\n      const result = await mpesa.queryTransactionStatus(checkoutRequestId);\n\n      if (result.ResultCode === \"0\") {\n        await storage.updateTransaction(transactionId, {\n          status: TransactionStatus.COMPLETED,\n          reconciliationStatus: ReconciliationStatus.MATCHED,\n          statusDescription: result.ResultDesc,\n        });\n\n        await this.activateUserAfterPayment(transaction.tenantId, transaction);\n\n        console.log(`[PaymentWorker] Transaction ${transactionId} completed successfully`);\n        await jobQueue.markCompleted(job.id);\n      } else if (result.ResultCode === \"1032\") {\n        await storage.updateTransaction(transactionId, {\n          status: TransactionStatus.FAILED,\n          statusDescription: \"Transaction cancelled by user\",\n        });\n        await jobQueue.markCompleted(job.id);\n      } else {\n        await jobQueue.markFailed(job.id, `Query returned: ${result.ResultDesc}`);\n      }\n    } catch (error) {\n      const message = error instanceof Error ? error.message : \"Unknown error\";\n      console.error(`[PaymentWorker] Payment check failed: ${message}`);\n      await jobQueue.markFailed(job.id, message);\n    }\n  }\n\n  private async activateUserAfterPayment(tenantId: string, transaction: any): Promise<void> {\n    try {\n      if (!transaction.planId) return;\n\n      const plan = await storage.getPlan(transaction.planId);\n      if (!plan) return;\n\n      let wifiUser = transaction.wifiUserId\n        ? await storage.getWifiUser(transaction.wifiUserId)\n        : await storage.getWifiUserByPhone(tenantId, transaction.userPhone);\n\n      if (!wifiUser) {\n        wifiUser = await storage.createWifiUser({\n          tenantId,\n          phoneNumber: transaction.userPhone,\n          accountType: \"HOTSPOT\",\n          currentPlanId: plan.id,\n          macAddress: transaction.macAddress || null,\n          status: WifiUserStatus.ACTIVE,\n          expiryTime: new Date(Date.now() + plan.durationSeconds * 1000),\n        });\n        console.log(`[PaymentWorker] Created new WiFi user for ${transaction.userPhone}`);\n      } else {\n        const newExpiry = new Date(Date.now() + plan.durationSeconds * 1000);\n        await storage.updateWifiUser(wifiUser.id, {\n          currentPlanId: plan.id,\n          status: WifiUserStatus.ACTIVE,\n          expiryTime: newExpiry,\n        });\n        console.log(`[PaymentWorker] Updated WiFi user ${wifiUser.id} with new expiry`);\n      }\n\n      await storage.updateTransaction(transaction.id, {\n        wifiUserId: wifiUser.id,\n        expiresAt: wifiUser.expiryTime,\n      });\n\n      // Handle excess payments - credit to wallet\n      const excessAmount = transaction.amount - plan.price;\n      if (excessAmount > 0 && wifiUser) {\n        try {\n          await storage.creditExcessToWallet(\n            tenantId,\n            wifiUser.id,\n            excessAmount,\n            `Excess payment credited from transaction ${transaction.mpesaReceiptNumber || transaction.id}`,\n            transaction.id\n          );\n          console.log(`[PaymentWorker] Credited KES ${excessAmount} excess to wallet for user ${wifiUser.id}`);\n        } catch (walletError) {\n          console.error(\"[PaymentWorker] Error crediting excess to wallet:\", walletError);\n        }\n      }\n\n      // Activate user on MikroTik router\n      await this.activateUserOnRouter(tenantId, wifiUser, plan);\n    } catch (error) {\n      console.error(\"[PaymentWorker] Error activating user:\", error);\n    }\n  }\n\n  private async activateUserOnRouter(tenantId: string, wifiUser: WifiUser, plan: Plan): Promise<boolean> {\n    try {\n      // Get hotspots for this tenant\n      const hotspots = await storage.getHotspots(tenantId);\n      if (!hotspots || hotspots.length === 0) {\n        console.log(`[PaymentWorker] No hotspots configured for tenant ${tenantId} - skipping router activation`);\n        return false;\n      }\n\n      // Use the user's current hotspot or the first available one\n      const hotspot = wifiUser.currentHotspotId \n        ? hotspots.find(h => h.id === wifiUser.currentHotspotId) || hotspots[0]\n        : hotspots[0];\n\n      const mikrotik = await createMikrotikService(hotspot);\n      if (!mikrotik) {\n        console.log(`[PaymentWorker] MikroTik service not available for hotspot ${hotspot.locationName}`);\n        return false;\n      }\n\n      // Only generate new credentials if user doesn't have them\n      const username = wifiUser.username || wifiUser.phoneNumber.replace(/\\+/g, '');\n      const password = wifiUser.password || Math.random().toString(36).substring(2, 10);\n      const needsCredentialUpdate = !wifiUser.username || !wifiUser.password;\n\n      // Build rate limit string from plan\n      const rateLimit = MikrotikService.buildRateLimit(plan);\n\n      // Handle based on plan/account type\n      const accountType = plan.planType || wifiUser.accountType || \"HOTSPOT\";\n      let result;\n      \n      switch (accountType) {\n        case \"PPPOE\":\n          // Create profile with rate limit first (if it doesn't exist)\n          await mikrotik.createUserProfile(plan.name, rateLimit, plan.durationSeconds);\n          result = await mikrotik.addPPPoEUser(\n            username,\n            password,\n            \"pppoe\",\n            plan.name\n          );\n          break;\n          \n        case \"STATIC\":\n          // For static IP, add ARP/MAC binding\n          if (wifiUser.macAddress && wifiUser.ipAddress) {\n            result = await mikrotik.addStaticBinding(\n              wifiUser.macAddress,\n              wifiUser.ipAddress,\n              `Static IP for ${username}, Plan: ${plan.name}`\n            );\n          } else {\n            console.log(`[PaymentWorker] Static IP user ${username} missing MAC or IP address`);\n            return false;\n          }\n          break;\n          \n        default: // HOTSPOT\n          result = await mikrotik.addHotspotUser(\n            username,\n            password,\n            plan.name,\n            `Plan: ${plan.name}, Phone: ${wifiUser.phoneNumber}`\n          );\n          break;\n      }\n\n      if (result.success) {\n        // Only update credentials if they were newly generated\n        if (needsCredentialUpdate) {\n          await storage.updateWifiUser(wifiUser.id, {\n            username,\n            password,\n            currentHotspotId: hotspot.id,\n          });\n        }\n        console.log(`[PaymentWorker] Successfully activated ${username} (${accountType}) on router ${hotspot.locationName}`);\n        return true;\n      } else {\n        console.error(`[PaymentWorker] Failed to activate user on router: ${result.error}`);\n        return false;\n      }\n    } catch (error) {\n      console.error(\"[PaymentWorker] Error activating user on router:\", error);\n      return false;\n    }\n  }\n\n  private async handleUserExpiryCheck(job: Job): Promise<void> {\n    const { userId } = job.payload as { userId: string };\n\n    try {\n      const user = await storage.getWifiUser(userId);\n      if (!user) {\n        await jobQueue.markCompleted(job.id);\n        return;\n      }\n\n      if (user.expiryTime && new Date(user.expiryTime) < new Date()) {\n        await storage.updateWifiUser(userId, {\n          status: WifiUserStatus.EXPIRED,\n        });\n        console.log(`[PaymentWorker] User ${userId} marked as expired`);\n      }\n\n      await jobQueue.markCompleted(job.id);\n    } catch (error) {\n      const message = error instanceof Error ? error.message : \"Unknown error\";\n      await jobQueue.markFailed(job.id, message);\n    }\n  }\n\n  private async handleReconciliation(job: Job): Promise<void> {\n    try {\n      if (!job.tenantId) {\n        await jobQueue.markFailed(job.id, \"No tenant ID\");\n        return;\n      }\n\n      const transactions = await storage.getTransactions(job.tenantId);\n      const pendingReconciliation = transactions.filter(\n        (t) => t.reconciliationStatus === ReconciliationStatus.PENDING\n      );\n\n      for (const tx of pendingReconciliation) {\n        if (tx.status === TransactionStatus.COMPLETED && tx.mpesaReceiptNumber) {\n          await storage.updateTransaction(tx.id, {\n            reconciliationStatus: ReconciliationStatus.MATCHED,\n          });\n        } else if (tx.status === TransactionStatus.FAILED) {\n          await storage.updateTransaction(tx.id, {\n            reconciliationStatus: ReconciliationStatus.UNMATCHED,\n          });\n        }\n      }\n\n      console.log(`[PaymentWorker] Reconciled ${pendingReconciliation.length} transactions`);\n      await jobQueue.markCompleted(job.id);\n    } catch (error) {\n      const message = error instanceof Error ? error.message : \"Unknown error\";\n      await jobQueue.markFailed(job.id, message);\n    }\n  }\n\n  private async handleSmsNotification(job: Job): Promise<void> {\n    const { phoneNumber, message } = job.payload as {\n      phoneNumber: string;\n      message: string;\n    };\n\n    try {\n      console.log(`[PaymentWorker] SMS to ${phoneNumber}: ${message}`);\n      await jobQueue.markCompleted(job.id);\n    } catch (error) {\n      const message = error instanceof Error ? error.message : \"Unknown error\";\n      await jobQueue.markFailed(job.id, message);\n    }\n  }\n}\n\nexport const paymentWorker = new PaymentWorker();\n","path":null,"size_bytes":19015,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"client/src/pages/plans.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Plus, Clock, Upload, Download, Users, Smartphone, X, Settings } from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput, GlassTextarea } from \"@/components/glass-input\";\nimport { PlanCard, PlanCardSkeleton } from \"@/components/plan-card\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { cn } from \"@/lib/utils\";\nimport type { Plan, InsertPlan } from \"@shared/schema\";\n\nexport default function PlansPage() {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingPlan, setEditingPlan] = useState<Plan | null>(null);\n\n  // Form state\n  const [formData, setFormData] = useState<Partial<InsertPlan>>({\n    name: \"\",\n    description: \"\",\n    price: 0,\n    durationSeconds: 3600,\n    uploadLimit: \"\",\n    downloadLimit: \"\",\n    simultaneousUse: 1,\n    maxDevices: 1,\n  });\n\n  // Fetch plans\n  const { data: plans, isLoading } = useQuery<Plan[]>({\n    queryKey: [\"/api/plans\"],\n  });\n\n  // Create/Update mutation\n  const saveMutation = useMutation({\n    mutationFn: async (data: Partial<InsertPlan>) => {\n      if (editingPlan) {\n        return apiRequest(\"PATCH\", `/api/plans/${editingPlan.id}`, data);\n      }\n      return apiRequest(\"POST\", \"/api/plans\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/plans\"] });\n      toast({\n        title: editingPlan ? \"Plan Updated\" : \"Plan Created\",\n        description: `The plan has been ${editingPlan ? \"updated\" : \"created\"} successfully.`,\n      });\n      handleCloseDialog();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save plan\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Delete mutation\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/plans/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/plans\"] });\n      toast({\n        title: \"Plan Deleted\",\n        description: \"The plan has been deleted successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to delete plan\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleOpenDialog = (plan?: Plan) => {\n    if (plan) {\n      setEditingPlan(plan);\n      setFormData({\n        name: plan.name,\n        description: plan.description || \"\",\n        price: plan.price,\n        durationSeconds: plan.durationSeconds,\n        uploadLimit: plan.uploadLimit || \"\",\n        downloadLimit: plan.downloadLimit || \"\",\n        simultaneousUse: plan.simultaneousUse || 1,\n        maxDevices: plan.maxDevices || 1,\n      });\n    } else {\n      setEditingPlan(null);\n      setFormData({\n        name: \"\",\n        description: \"\",\n        price: 0,\n        durationSeconds: 3600,\n        uploadLimit: \"\",\n        downloadLimit: \"\",\n        simultaneousUse: 1,\n        maxDevices: 1,\n      });\n    }\n    setIsDialogOpen(true);\n  };\n\n  const handleCloseDialog = () => {\n    setIsDialogOpen(false);\n    setEditingPlan(null);\n    setFormData({\n      name: \"\",\n      description: \"\",\n      price: 0,\n      durationSeconds: 3600,\n      uploadLimit: \"\",\n      downloadLimit: \"\",\n      simultaneousUse: 1,\n      maxDevices: 1,\n    });\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    saveMutation.mutate(formData);\n  };\n\n  const durationPresets = [\n    { label: \"30 min\", seconds: 1800 },\n    { label: \"1 hour\", seconds: 3600 },\n    { label: \"3 hours\", seconds: 10800 },\n    { label: \"1 day\", seconds: 86400 },\n    { label: \"7 days\", seconds: 604800 },\n    { label: \"30 days\", seconds: 2592000 },\n  ];\n\n  const [isCustomDuration, setIsCustomDuration] = useState(false);\n  const [customDurationValue, setCustomDurationValue] = useState(1);\n  const [customDurationUnit, setCustomDurationUnit] = useState<\"minutes\" | \"hours\" | \"days\" | \"months\">(\"hours\");\n\n  const durationUnitMultipliers = {\n    minutes: 60,\n    hours: 3600,\n    days: 86400,\n    months: 2592000,\n  };\n\n  const handleCustomDurationChange = (value: number, unit: \"minutes\" | \"hours\" | \"days\" | \"months\") => {\n    setCustomDurationValue(value);\n    setCustomDurationUnit(unit);\n    setIsCustomDuration(true);\n    const seconds = value * durationUnitMultipliers[unit];\n    setFormData({ ...formData, durationSeconds: seconds });\n  };\n\n  const handlePresetClick = (seconds: number) => {\n    setIsCustomDuration(false);\n    setFormData({ ...formData, durationSeconds: seconds });\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"plans-page\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">Plans</h1>\n          <p className=\"text-muted-foreground\">\n            Manage Wi-Fi subscription plans and pricing\n          </p>\n        </div>\n        <Button\n          className=\"gradient-btn\"\n          onClick={() => handleOpenDialog()}\n          data-testid=\"button-add-plan\"\n        >\n          <Plus size={18} className=\"mr-2\" />\n          Add Plan\n        </Button>\n      </div>\n\n      {/* Plans Grid */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n        {isLoading ? (\n          <>\n            <PlanCardSkeleton />\n            <PlanCardSkeleton />\n            <PlanCardSkeleton />\n          </>\n        ) : plans && plans.length > 0 ? (\n          <AnimatePresence mode=\"popLayout\">\n            {plans.map((plan) => (\n              <motion.div\n                key={plan.id}\n                layout\n                initial={{ opacity: 0, scale: 0.95 }}\n                animate={{ opacity: 1, scale: 1 }}\n                exit={{ opacity: 0, scale: 0.95 }}\n              >\n                <PlanCard\n                  plan={plan}\n                  onSelect={() => handleOpenDialog(plan)}\n                  showDetails\n                />\n              </motion.div>\n            ))}\n          </AnimatePresence>\n        ) : (\n          <GlassPanel className=\"col-span-full text-center py-12\">\n            <Clock size={48} className=\"mx-auto mb-4 text-muted-foreground opacity-50\" />\n            <p className=\"text-muted-foreground mb-4\">No plans created yet</p>\n            <Button\n              className=\"gradient-btn\"\n              onClick={() => handleOpenDialog()}\n              data-testid=\"button-create-first-plan\"\n            >\n              Create Your First Plan\n            </Button>\n          </GlassPanel>\n        )}\n      </div>\n\n      {/* Create/Edit Dialog */}\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"glass-panel border-white/10 max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"text-xl font-bold text-white\">\n              {editingPlan ? \"Edit Plan\" : \"Create New Plan\"}\n            </DialogTitle>\n          </DialogHeader>\n\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\n            <GlassInput\n              label=\"Plan Name\"\n              placeholder=\"e.g., Basic, Premium, Unlimited\"\n              value={formData.name}\n              onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n              required\n              data-testid=\"input-plan-name\"\n            />\n\n            <GlassTextarea\n              label=\"Description\"\n              placeholder=\"Brief description of this plan\"\n              value={formData.description || \"\"}\n              onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n              data-testid=\"input-plan-description\"\n            />\n\n            <GlassInput\n              label=\"Price (KES)\"\n              type=\"number\"\n              placeholder=\"0\"\n              value={formData.price?.toString() || \"\"}\n              onChange={(e) => setFormData({ ...formData, price: parseInt(e.target.value) || 0 })}\n              required\n              data-testid=\"input-plan-price\"\n            />\n\n            {/* Duration presets */}\n            <div className=\"space-y-3\">\n              <label className=\"text-sm font-medium uppercase tracking-wider text-muted-foreground\">\n                Duration\n              </label>\n              <div className=\"flex flex-wrap gap-2\">\n                {durationPresets.map((preset) => (\n                  <button\n                    key={preset.seconds}\n                    type=\"button\"\n                    onClick={() => handlePresetClick(preset.seconds)}\n                    className={cn(\n                      \"px-3 py-1.5 rounded-lg text-sm font-medium transition-all\",\n                      formData.durationSeconds === preset.seconds && !isCustomDuration\n                        ? \"bg-cyan-500/20 text-cyan-400 border border-cyan-500/30\"\n                        : \"bg-white/5 text-muted-foreground border border-white/10 hover:bg-white/10\"\n                    )}\n                    data-testid={`duration-preset-${preset.seconds}`}\n                  >\n                    {preset.label}\n                  </button>\n                ))}\n                <button\n                  type=\"button\"\n                  onClick={() => setIsCustomDuration(true)}\n                  className={cn(\n                    \"px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-1\",\n                    isCustomDuration\n                      ? \"bg-purple-500/20 text-purple-400 border border-purple-500/30\"\n                      : \"bg-white/5 text-muted-foreground border border-white/10 hover:bg-white/10\"\n                  )}\n                  data-testid=\"duration-custom-button\"\n                >\n                  <Settings size={14} />\n                  Custom\n                </button>\n              </div>\n\n              {isCustomDuration && (\n                <div className=\"flex gap-3 items-end p-3 rounded-lg bg-purple-500/10 border border-purple-500/20\">\n                  <div className=\"flex-1\">\n                    <label className=\"text-xs text-muted-foreground mb-1 block\">Value</label>\n                    <input\n                      type=\"number\"\n                      min={1}\n                      value={customDurationValue}\n                      onChange={(e) => handleCustomDurationChange(parseInt(e.target.value) || 1, customDurationUnit)}\n                      className=\"w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-purple-500/50\"\n                      data-testid=\"input-custom-duration-value\"\n                    />\n                  </div>\n                  <div className=\"flex-1\">\n                    <label className=\"text-xs text-muted-foreground mb-1 block\">Unit</label>\n                    <Select\n                      value={customDurationUnit}\n                      onValueChange={(value: \"minutes\" | \"hours\" | \"days\" | \"months\") => handleCustomDurationChange(customDurationValue, value)}\n                    >\n                      <SelectTrigger \n                        className=\"bg-white/5 border-white/10\" \n                        data-testid=\"select-custom-duration-unit\"\n                      >\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"minutes\">Minutes</SelectItem>\n                        <SelectItem value=\"hours\">Hours</SelectItem>\n                        <SelectItem value=\"days\">Days</SelectItem>\n                        <SelectItem value=\"months\">Months</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  <div className=\"text-sm text-purple-400 whitespace-nowrap\">\n                    = {formData.durationSeconds ? Math.round(formData.durationSeconds / 60) : 0} min\n                  </div>\n                </div>\n              )}\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <GlassInput\n                label=\"Upload Limit\"\n                placeholder=\"e.g., 2M\"\n                value={formData.uploadLimit || \"\"}\n                onChange={(e) => setFormData({ ...formData, uploadLimit: e.target.value })}\n                icon={<Upload size={16} />}\n                data-testid=\"input-plan-upload\"\n              />\n              <GlassInput\n                label=\"Download Limit\"\n                placeholder=\"e.g., 5M\"\n                value={formData.downloadLimit || \"\"}\n                onChange={(e) => setFormData({ ...formData, downloadLimit: e.target.value })}\n                icon={<Download size={16} />}\n                data-testid=\"input-plan-download\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <GlassInput\n                label=\"Simultaneous Sessions\"\n                type=\"number\"\n                min={1}\n                max={10}\n                value={formData.simultaneousUse?.toString() || \"1\"}\n                onChange={(e) => setFormData({ ...formData, simultaneousUse: parseInt(e.target.value) || 1 })}\n                icon={<Users size={16} />}\n                data-testid=\"input-plan-devices\"\n              />\n              <GlassInput\n                label=\"Max Devices per Voucher\"\n                type=\"number\"\n                min={1}\n                max={20}\n                value={formData.maxDevices?.toString() || \"1\"}\n                onChange={(e) => setFormData({ ...formData, maxDevices: parseInt(e.target.value) || 1 })}\n                icon={<Smartphone size={16} />}\n                data-testid=\"input-plan-max-devices\"\n              />\n            </div>\n\n            <div className=\"flex gap-3 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                onClick={handleCloseDialog}\n                className=\"flex-1\"\n                data-testid=\"button-cancel\"\n              >\n                Cancel\n              </Button>\n              {editingPlan && (\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  onClick={() => {\n                    deleteMutation.mutate(editingPlan.id);\n                    handleCloseDialog();\n                  }}\n                  className=\"text-destructive hover:text-destructive\"\n                  data-testid=\"button-delete-plan\"\n                >\n                  Delete\n                </Button>\n              )}\n              <Button\n                type=\"submit\"\n                className=\"flex-1 gradient-btn\"\n                disabled={saveMutation.isPending}\n                data-testid=\"button-save-plan\"\n              >\n                {saveMutation.isPending ? \"Saving...\" : editingPlan ? \"Update Plan\" : \"Create Plan\"}\n              </Button>\n            </div>\n          </form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":15491,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/pages/login.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { motion } from \"framer-motion\";\nimport { User, Lock, Loader2, ArrowRight, Building2, Shield, ArrowLeft } from \"lucide-react\";\nimport { MeshBackground } from \"@/components/mesh-background\";\nimport { MnetiFiLogo } from \"@/components/mnetifi-logo\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Link } from \"wouter\";\nimport { InputOTP, InputOTPGroup, InputOTPSlot } from \"@/components/ui/input-otp\";\n\nexport default function LoginPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [username, setUsername] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n  const [requires2FA, setRequires2FA] = useState(false);\n  const [userId2FA, setUserId2FA] = useState<string | null>(null);\n  const [twoFactorCode, setTwoFactorCode] = useState(\"\");\n\n  useEffect(() => {\n    const session = localStorage.getItem(\"admin_session\");\n    if (session) {\n      try {\n        const sessionData = JSON.parse(session);\n        const lastActivity = new Date(sessionData.lastActivity).getTime();\n        const now = Date.now();\n        const tenMinutes = 10 * 60 * 1000;\n        \n        if (now - lastActivity < tenMinutes) {\n          setLocation(\"/dashboard\");\n        } else {\n          localStorage.removeItem(\"admin_session\");\n        }\n      } catch {\n        localStorage.removeItem(\"admin_session\");\n      }\n    }\n  }, [setLocation]);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsLoading(true);\n\n    try {\n      const response = await fetch(\"/api/auth/login\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ username, password }),\n      });\n\n      const data = await response.json();\n\n      if (response.ok) {\n        // Check if 2FA is required\n        if (data.requiresTwoFactor) {\n          setRequires2FA(true);\n          setUserId2FA(data.userId);\n          toast({\n            title: \"Two-Factor Authentication\",\n            description: \"Please enter your authentication code\",\n          });\n        } else {\n          localStorage.setItem(\"admin_session\", JSON.stringify({\n            user: data.user,\n            lastActivity: new Date().toISOString(),\n            subscriptionTier: data.subscriptionTier || \"BASIC\",\n            trialExpiresAt: data.trialExpiresAt || null,\n          }));\n          toast({\n            title: \"Welcome back!\",\n            description: `Logged in as ${data.user.username}`,\n          });\n          setLocation(\"/dashboard\");\n        }\n      } else {\n        toast({\n          title: \"Login Failed\",\n          description: data.error || \"Invalid credentials\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      toast({\n        title: \"Login Failed\",\n        description: \"Unable to connect to server\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handle2FAVerify = async () => {\n    if (twoFactorCode.length !== 6 || !userId2FA) return;\n    \n    setIsLoading(true);\n    try {\n      const response = await fetch(\"/api/auth/2fa/login-verify\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ userId: userId2FA, code: twoFactorCode }),\n      });\n\n      const data = await response.json();\n\n      if (response.ok && data.success) {\n        localStorage.setItem(\"admin_session\", JSON.stringify({\n          user: data.user,\n          lastActivity: new Date().toISOString(),\n          subscriptionTier: data.subscriptionTier || \"BASIC\",\n          trialExpiresAt: data.trialExpiresAt || null,\n        }));\n        toast({\n          title: \"Welcome back!\",\n          description: `Logged in as ${data.user.username}`,\n        });\n        setLocation(\"/dashboard\");\n      } else {\n        toast({\n          title: \"Verification Failed\",\n          description: data.error || \"Invalid code\",\n          variant: \"destructive\",\n        });\n        setTwoFactorCode(\"\");\n      }\n    } catch (error) {\n      toast({\n        title: \"Verification Failed\",\n        description: \"Unable to verify code\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleBack = () => {\n    setRequires2FA(false);\n    setUserId2FA(null);\n    setTwoFactorCode(\"\");\n  };\n\n  return (\n    <>\n      <MeshBackground />\n      <div className=\"min-h-screen flex items-center justify-center p-4 relative z-10\">\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.5 }}\n          className=\"w-full max-w-md\"\n        >\n          <GlassPanel size=\"lg\" className=\"text-center\">\n            {requires2FA ? (\n              <>\n                <div className=\"mb-8\">\n                  <div className=\"w-16 h-16 mx-auto mb-4 rounded-full bg-cyan-500/20 flex items-center justify-center\">\n                    <Shield className=\"w-8 h-8 text-cyan-400\" />\n                  </div>\n                  <h1 className=\"text-2xl font-bold text-white mb-2\">Two-Factor Authentication</h1>\n                  <p className=\"text-muted-foreground\">\n                    Enter the 6-digit code from your authenticator app\n                  </p>\n                </div>\n\n                <div className=\"space-y-6\">\n                  <div className=\"flex justify-center\">\n                    <InputOTP\n                      maxLength={6}\n                      value={twoFactorCode}\n                      onChange={setTwoFactorCode}\n                      onComplete={handle2FAVerify}\n                      data-testid=\"input-2fa-code\"\n                    >\n                      <InputOTPGroup>\n                        <InputOTPSlot index={0} />\n                        <InputOTPSlot index={1} />\n                        <InputOTPSlot index={2} />\n                        <InputOTPSlot index={3} />\n                        <InputOTPSlot index={4} />\n                        <InputOTPSlot index={5} />\n                      </InputOTPGroup>\n                    </InputOTP>\n                  </div>\n\n                  <Button\n                    type=\"button\"\n                    className=\"w-full gradient-btn\"\n                    onClick={handle2FAVerify}\n                    disabled={isLoading || twoFactorCode.length !== 6}\n                    data-testid=\"button-verify-2fa\"\n                  >\n                    {isLoading ? (\n                      <>\n                        <Loader2 size={18} className=\"mr-2 animate-spin\" />\n                        Verifying...\n                      </>\n                    ) : (\n                      <>\n                        <Shield size={18} className=\"mr-2\" />\n                        Verify Code\n                      </>\n                    )}\n                  </Button>\n\n                  <Button\n                    type=\"button\"\n                    variant=\"ghost\"\n                    className=\"w-full text-muted-foreground\"\n                    onClick={handleBack}\n                    data-testid=\"button-back-login\"\n                  >\n                    <ArrowLeft size={18} className=\"mr-2\" />\n                    Back to Login\n                  </Button>\n                </div>\n              </>\n            ) : (\n              <>\n            <div className=\"mb-8\">\n              <MnetiFiLogo size=\"lg\" className=\"mx-auto mb-4\" />\n              <div className=\"flex items-center justify-center gap-2 mb-2\">\n                <Badge variant=\"outline\" className=\"bg-cyan-500/20 text-cyan-400 border-0\">\n                  <Building2 size={12} className=\"mr-1\" />\n                  ISP Portal\n                </Badge>\n              </div>\n              <h1 className=\"text-2xl font-bold text-white mb-2\">ISP Admin Login</h1>\n              <p className=\"text-muted-foreground\">\n                Sign in to manage your WiFi business\n              </p>\n            </div>\n\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <GlassInput\n                label=\"Username\"\n                placeholder=\"Enter your username\"\n                value={username}\n                onChange={(e) => setUsername(e.target.value)}\n                required\n                icon={<User size={16} />}\n                data-testid=\"input-username\"\n              />\n\n              <GlassInput\n                label=\"Password\"\n                type=\"password\"\n                placeholder=\"Enter your password\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                required\n                icon={<Lock size={16} />}\n                data-testid=\"input-password\"\n              />\n\n              <Button\n                type=\"submit\"\n                className=\"w-full gradient-btn\"\n                disabled={isLoading}\n                data-testid=\"button-login\"\n              >\n                {isLoading ? (\n                  <>\n                    <Loader2 size={18} className=\"mr-2 animate-spin\" />\n                    Signing in...\n                  </>\n                ) : (\n                  <>\n                    Sign In to Dashboard\n                    <ArrowRight size={18} className=\"ml-2\" />\n                  </>\n                )}\n              </Button>\n            </form>\n\n            <div className=\"mt-4 text-center\">\n              <Link \n                href=\"/forgot-password\" \n                className=\"text-sm text-cyan-400 hover:text-cyan-300 transition-colors\"\n                data-testid=\"link-forgot-password\"\n              >\n                Forgot your password?\n              </Link>\n            </div>\n\n            <div className=\"mt-6 pt-6 border-t border-white/10 space-y-3\">\n              <p className=\"text-sm text-muted-foreground\">\n                New ISP?{\" \"}\n                <Link \n                  href=\"/register\" \n                  className=\"text-cyan-400 hover:text-cyan-300 transition-colors font-medium\"\n                  data-testid=\"link-register\"\n                >\n                  Register your business\n                </Link>\n              </p>\n              <p className=\"text-sm text-muted-foreground\">\n                Need WiFi access?{\" \"}\n                <Link href=\"/\" className=\"text-cyan-400 hover:text-cyan-300 transition-colors\">\n                  Go to the WiFi portal\n                </Link>\n              </p>\n            </div>\n\n            <div className=\"mt-4 pt-4 border-t border-white/10\">\n              <p className=\"text-xs text-muted-foreground\">\n                Platform Administrator?{\" \"}\n                <Link \n                  href=\"/superadmin/login\" \n                  className=\"text-pink-400 hover:text-pink-300 transition-colors font-medium\"\n                  data-testid=\"link-superadmin\"\n                >\n                  Super Admin Login\n                </Link>\n              </p>\n            </div>\n            </>\n            )}\n          </GlassPanel>\n        </motion.div>\n      </div>\n    </>\n  );\n}\n","path":null,"size_bytes":11376,"size_tokens":null},"client/src/hooks/use-session.ts":{"content":"import { useEffect, useCallback, useState } from \"react\";\nimport { useLocation } from \"wouter\";\n\nconst SESSION_KEY = \"admin_session\";\nconst SESSION_TIMEOUT = 10 * 60 * 1000;\n\ninterface SessionUser {\n  id: string;\n  username: string;\n  role: string;\n  tenantId?: string;\n  email?: string;\n}\n\ninterface Session {\n  user: SessionUser;\n  lastActivity: string;\n  subscriptionTier?: string;\n  trialExpiresAt?: string;\n}\n\nexport function useSession() {\n  const [, setLocation] = useLocation();\n  const [user, setUser] = useState<SessionUser | null>(null);\n  const [subscriptionTier, setSubscriptionTier] = useState<string>(\"BASIC\");\n  const [trialExpiresAt, setTrialExpiresAt] = useState<string | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  const checkSession = useCallback(() => {\n    const sessionStr = localStorage.getItem(SESSION_KEY);\n    if (!sessionStr) {\n      setUser(null);\n      setIsLoading(false);\n      return false;\n    }\n\n    try {\n      const session: Session = JSON.parse(sessionStr);\n      const lastActivity = new Date(session.lastActivity).getTime();\n      const now = Date.now();\n\n      if (now - lastActivity >= SESSION_TIMEOUT) {\n        localStorage.removeItem(SESSION_KEY);\n        setUser(null);\n        setIsLoading(false);\n        return false;\n      }\n\n      setUser(session.user);\n      setSubscriptionTier(session.subscriptionTier || \"BASIC\");\n      setTrialExpiresAt(session.trialExpiresAt || null);\n      setIsLoading(false);\n      return true;\n    } catch {\n      localStorage.removeItem(SESSION_KEY);\n      setUser(null);\n      setIsLoading(false);\n      return false;\n    }\n  }, []);\n\n  const updateActivity = useCallback(() => {\n    const sessionStr = localStorage.getItem(SESSION_KEY);\n    if (sessionStr) {\n      try {\n        const session: Session = JSON.parse(sessionStr);\n        session.lastActivity = new Date().toISOString();\n        localStorage.setItem(SESSION_KEY, JSON.stringify(session));\n      } catch {\n        // Invalid session\n      }\n    }\n  }, []);\n\n  const logout = useCallback(() => {\n    localStorage.removeItem(SESSION_KEY);\n    setUser(null);\n    setLocation(\"/login\");\n  }, [setLocation]);\n\n  useEffect(() => {\n    checkSession();\n\n    const activityEvents = [\"mousedown\", \"keydown\", \"scroll\", \"touchstart\"];\n    \n    const handleActivity = () => {\n      updateActivity();\n    };\n\n    activityEvents.forEach((event) => {\n      document.addEventListener(event, handleActivity);\n    });\n\n    const intervalId = setInterval(() => {\n      if (!checkSession()) {\n        setLocation(\"/login\");\n      }\n    }, 30000);\n\n    return () => {\n      activityEvents.forEach((event) => {\n        document.removeEventListener(event, handleActivity);\n      });\n      clearInterval(intervalId);\n    };\n  }, [checkSession, updateActivity, setLocation]);\n\n  return { user, isLoading, logout, checkSession, updateActivity, subscriptionTier, trialExpiresAt };\n}\n\nexport function useRequireAuth() {\n  const { user, isLoading, logout, updateActivity, subscriptionTier, trialExpiresAt } = useSession();\n  const [, setLocation] = useLocation();\n\n  useEffect(() => {\n    if (!isLoading && !user) {\n      setLocation(\"/login\");\n    }\n  }, [user, isLoading, setLocation]);\n\n  return { user, isLoading, logout, updateActivity, subscriptionTier, trialExpiresAt };\n}\n","path":null,"size_bytes":3318,"size_tokens":null},"client/src/pages/register.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useLocation, Link } from \"wouter\";\nimport { motion } from \"framer-motion\";\nimport { User, Lock, Mail, Building2, Loader2, ArrowRight, ArrowLeft, Check, Wifi, CreditCard, Building, Phone, X, Crown, Zap, Shield, Users } from \"lucide-react\";\nimport { SiPaypal } from \"react-icons/si\";\nimport { MeshBackground } from \"@/components/mesh-background\";\nimport { MnetiFiLogo, MpesaLogo } from \"@/components/mnetifi-logo\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Progress } from \"@/components/ui/progress\";\n\ninterface PasswordStrength {\n  score: number;\n  label: string;\n  color: string;\n  requirements: {\n    minLength: boolean;\n    hasUppercase: boolean;\n    hasLowercase: boolean;\n    hasNumber: boolean;\n    hasSpecial: boolean;\n  };\n}\n\nfunction checkPasswordStrength(password: string): PasswordStrength {\n  const requirements = {\n    minLength: password.length >= 8,\n    hasUppercase: /[A-Z]/.test(password),\n    hasLowercase: /[a-z]/.test(password),\n    hasNumber: /[0-9]/.test(password),\n    hasSpecial: /[!@#$%^&*(),.?\":{}|<>]/.test(password),\n  };\n\n  const score = Object.values(requirements).filter(Boolean).length;\n\n  let label = \"Very Weak\";\n  let color = \"bg-red-500\";\n\n  if (score === 5) {\n    label = \"Strong\";\n    color = \"bg-green-500\";\n  } else if (score === 4) {\n    label = \"Good\";\n    color = \"bg-cyan-500\";\n  } else if (score === 3) {\n    label = \"Fair\";\n    color = \"bg-yellow-500\";\n  } else if (score === 2) {\n    label = \"Weak\";\n    color = \"bg-orange-500\";\n  }\n\n  return { score, label, color, requirements };\n}\n\ntype SubscriptionTier = \"BASIC\" | \"PREMIUM\" | null;\ntype PaymentMethod = \"MPESA\" | \"BANK\" | \"PAYPAL\" | null;\n\nconst tierFeatures = {\n  BASIC: [\n    \"Hotspot User Management\",\n    \"Hotspot Plan Management\",\n    \"Transaction History\",\n    \"Walled Garden Config\",\n    \"Basic Dashboard\",\n    \"Captive Portal\",\n  ],\n  PREMIUM: [\n    \"Everything in Basic, plus:\",\n    \"PPPoE User Management\",\n    \"Static IP Management\",\n    \"Technician Accounts\",\n    \"SMS Campaigns\",\n    \"Customer Chat\",\n    \"Loyalty Points System\",\n    \"Advanced Reports\",\n    \"Priority Support\",\n  ],\n};\n\nexport default function RegisterPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [step, setStep] = useState(1);\n  const [isLoading, setIsLoading] = useState(false);\n  const [registrationComplete, setRegistrationComplete] = useState(false);\n  \n  const [businessName, setBusinessName] = useState(\"\");\n  const [subdomain, setSubdomain] = useState(\"\");\n  const [username, setUsername] = useState(\"\");\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [selectedTier, setSelectedTier] = useState<SubscriptionTier>(null);\n  const [paymentMethod, setPaymentMethod] = useState<PaymentMethod>(null);\n  const [phoneNumber, setPhoneNumber] = useState(\"\");\n\n  const passwordStrength = useMemo(() => checkPasswordStrength(password), [password]);\n\n  const validateStep1 = () => {\n    if (!businessName.trim()) {\n      toast({\n        title: \"Business name required\",\n        description: \"Please enter your ISP business name\",\n        variant: \"destructive\",\n      });\n      return false;\n    }\n    if (!subdomain.trim()) {\n      toast({\n        title: \"Subdomain required\",\n        description: \"Please choose a subdomain for your portal\",\n        variant: \"destructive\",\n      });\n      return false;\n    }\n    if (!/^[a-z0-9-]+$/.test(subdomain)) {\n      toast({\n        title: \"Invalid subdomain\",\n        description: \"Subdomain can only contain lowercase letters, numbers, and hyphens\",\n        variant: \"destructive\",\n      });\n      return false;\n    }\n    return true;\n  };\n\n  const validateStep2 = () => {\n    if (!username.trim()) {\n      toast({\n        title: \"Username required\",\n        description: \"Please enter a username\",\n        variant: \"destructive\",\n      });\n      return false;\n    }\n    if (!email.trim()) {\n      toast({\n        title: \"Email required\",\n        description: \"Please enter your email address\",\n        variant: \"destructive\",\n      });\n      return false;\n    }\n    if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) {\n      toast({\n        title: \"Invalid email\",\n        description: \"Please enter a valid email address\",\n        variant: \"destructive\",\n      });\n      return false;\n    }\n    const { requirements } = passwordStrength;\n    if (!requirements.minLength || !requirements.hasUppercase || !requirements.hasLowercase || !requirements.hasNumber || !requirements.hasSpecial) {\n      toast({\n        title: \"Password too weak\",\n        description: \"Password must be at least 8 characters and include uppercase, lowercase, number, and special character\",\n        variant: \"destructive\",\n      });\n      return false;\n    }\n    if (password !== confirmPassword) {\n      toast({\n        title: \"Passwords don't match\",\n        description: \"Please make sure your passwords match\",\n        variant: \"destructive\",\n      });\n      return false;\n    }\n    return true;\n  };\n\n  const validateStep3 = () => {\n    if (!selectedTier) {\n      toast({\n        title: \"Plan required\",\n        description: \"Please select a subscription plan\",\n        variant: \"destructive\",\n      });\n      return false;\n    }\n    if (selectedTier === \"PREMIUM\") {\n      if (!paymentMethod) {\n        toast({\n          title: \"Payment method required\",\n          description: \"Please select a payment method for the premium plan\",\n          variant: \"destructive\",\n        });\n        return false;\n      }\n      if (paymentMethod === \"MPESA\" && !phoneNumber.trim()) {\n        toast({\n          title: \"Phone number required\",\n          description: \"Please enter your M-Pesa phone number\",\n          variant: \"destructive\",\n        });\n        return false;\n      }\n    }\n    return true;\n  };\n\n  const handleNext = () => {\n    if (step === 1 && validateStep1()) {\n      setStep(2);\n    } else if (step === 2 && validateStep2()) {\n      setStep(3);\n    }\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!validateStep3()) return;\n    \n    setIsLoading(true);\n\n    try {\n      const response = await fetch(\"/api/auth/register\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          businessName,\n          subdomain,\n          username,\n          email,\n          password,\n          subscriptionTier: selectedTier,\n          paymentMethod: selectedTier === \"PREMIUM\" ? paymentMethod : undefined,\n          phoneNumber: selectedTier === \"PREMIUM\" && paymentMethod === \"MPESA\" ? phoneNumber : undefined,\n        }),\n      });\n\n      const data = await response.json();\n\n      if (response.ok) {\n        if (selectedTier === \"BASIC\") {\n          localStorage.setItem(\"admin_session\", JSON.stringify({\n            user: data.user,\n            lastActivity: new Date().toISOString(),\n          }));\n          toast({\n            title: \"Welcome to MnetiFi!\",\n            description: \"Your 24-hour free trial has started. Enjoy exploring!\",\n          });\n          setLocation(\"/dashboard\");\n        } else if (data.requiresEmailVerification) {\n          setRegistrationComplete(true);\n        } else {\n          toast({\n            title: \"Account Created!\",\n            description: \"You can now log in to your account.\",\n          });\n          setLocation(\"/login\");\n        }\n      } else {\n        toast({\n          title: \"Registration Failed\",\n          description: data.error || \"Unable to create account\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      toast({\n        title: \"Registration Failed\",\n        description: \"Unable to connect to server\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  if (registrationComplete) {\n    return (\n      <>\n        <MeshBackground />\n        <div className=\"min-h-screen flex items-center justify-center p-4 relative z-10\">\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ duration: 0.5 }}\n            className=\"w-full max-w-md\"\n          >\n            <GlassPanel size=\"lg\" className=\"text-center\">\n              <div className=\"mb-6\">\n                <div className=\"w-20 h-20 mx-auto mb-6 rounded-full bg-cyan-500/20 flex items-center justify-center\">\n                  <Mail size={40} className=\"text-cyan-400\" />\n                </div>\n                <h1 className=\"text-2xl font-bold text-white mb-2\" data-testid=\"text-verify-title\">\n                  Verify Your Email\n                </h1>\n                <p className=\"text-muted-foreground mb-4\">\n                  We've sent a verification link to:\n                </p>\n                <p className=\"text-cyan-400 font-medium mb-6\" data-testid=\"text-email-sent\">\n                  {email}\n                </p>\n              </div>\n\n              <div className=\"p-4 rounded-xl bg-white/5 border border-white/10 mb-6 text-left\">\n                <h3 className=\"font-medium text-white mb-2\">Next Steps:</h3>\n                <ol className=\"text-sm text-muted-foreground space-y-2\">\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-cyan-400 font-medium\">1.</span>\n                    Check your inbox for the verification email\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-cyan-400 font-medium\">2.</span>\n                    Click the verification link to activate your account\n                  </li>\n                  <li className=\"flex items-start gap-2\">\n                    <span className=\"text-cyan-400 font-medium\">3.</span>\n                    Complete your premium subscription payment\n                  </li>\n                </ol>\n              </div>\n\n              <p className=\"text-xs text-muted-foreground mb-4\">\n                Didn't receive the email? Check your spam folder or{\" \"}\n                <button \n                  className=\"text-cyan-400 hover:underline\"\n                  onClick={async () => {\n                    try {\n                      const res = await fetch(\"/api/auth/resend-verification\", {\n                        method: \"POST\",\n                        headers: { \"Content-Type\": \"application/json\" },\n                        body: JSON.stringify({ email }),\n                      });\n                      if (res.ok) {\n                        toast({ title: \"Verification email resent!\", description: \"Check your inbox\" });\n                      } else {\n                        const data = await res.json();\n                        toast({ title: \"Error\", description: data.error, variant: \"destructive\" });\n                      }\n                    } catch {\n                      toast({ title: \"Error\", description: \"Failed to resend email\", variant: \"destructive\" });\n                    }\n                  }}\n                  data-testid=\"button-resend-verification\"\n                >\n                  click here to resend\n                </button>\n              </p>\n\n              <Link href=\"/login\">\n                <Button variant=\"outline\" className=\"w-full border-white/20\" data-testid=\"link-back-to-login\">\n                  <ArrowLeft size={16} className=\"mr-2\" />\n                  Back to Login\n                </Button>\n              </Link>\n            </GlassPanel>\n          </motion.div>\n        </div>\n      </>\n    );\n  }\n\n  return (\n    <>\n      <MeshBackground />\n      <div className=\"min-h-screen flex items-center justify-center p-4 relative z-10\">\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.5 }}\n          className=\"w-full max-w-2xl\"\n        >\n          <GlassPanel size=\"lg\" className=\"text-center\">\n            <div className=\"mb-8\">\n              <MnetiFiLogo size=\"lg\" className=\"mx-auto mb-4\" />\n              <div className=\"flex items-center justify-center gap-2 mb-2\">\n                <Badge variant=\"outline\" className=\"bg-cyan-500/20 text-cyan-400 border-0\">\n                  <Wifi size={12} className=\"mr-1\" />\n                  ISP Registration\n                </Badge>\n              </div>\n              <h1 className=\"text-2xl font-bold text-white mb-2\">Register Your ISP Business</h1>\n              <p className=\"text-muted-foreground\">\n                {step === 3 ? \"Choose your plan\" : \"Start your 24-hour free trial\"}\n              </p>\n            </div>\n\n            <div className=\"flex items-center justify-center gap-2 mb-6\">\n              <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${\n                step >= 1 ? 'bg-cyan-500 text-white' : 'bg-white/10 text-muted-foreground'\n              }`}>\n                {step > 1 ? <Check size={16} /> : '1'}\n              </div>\n              <div className={`w-8 h-0.5 ${step > 1 ? 'bg-cyan-500' : 'bg-white/10'}`} />\n              <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${\n                step >= 2 ? 'bg-cyan-500 text-white' : 'bg-white/10 text-muted-foreground'\n              }`}>\n                {step > 2 ? <Check size={16} /> : '2'}\n              </div>\n              <div className={`w-8 h-0.5 ${step > 2 ? 'bg-cyan-500' : 'bg-white/10'}`} />\n              <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${\n                step >= 3 ? 'bg-cyan-500 text-white' : 'bg-white/10 text-muted-foreground'\n              }`}>\n                3\n              </div>\n            </div>\n\n            {step === 1 ? (\n              <form onSubmit={(e) => { e.preventDefault(); handleNext(); }} className=\"space-y-4 max-w-md mx-auto\">\n                <GlassInput\n                  label=\"Business Name\"\n                  placeholder=\"Your ISP business name\"\n                  value={businessName}\n                  onChange={(e) => setBusinessName(e.target.value)}\n                  required\n                  icon={<Building2 size={16} />}\n                  data-testid=\"input-business-name\"\n                />\n\n                <div className=\"space-y-2\">\n                  <GlassInput\n                    label=\"Subdomain\"\n                    placeholder=\"your-isp\"\n                    value={subdomain}\n                    onChange={(e) => setSubdomain(e.target.value.toLowerCase().replace(/[^a-z0-9-]/g, ''))}\n                    required\n                    data-testid=\"input-subdomain\"\n                  />\n                  <p className=\"text-xs text-muted-foreground text-left\">\n                    Your portal will be: <span className=\"text-cyan-400\">{subdomain || 'your-isp'}.mnetifi.com</span>\n                  </p>\n                </div>\n\n                <Button\n                  type=\"submit\"\n                  className=\"w-full gradient-btn\"\n                  data-testid=\"button-next\"\n                >\n                  Next Step\n                  <ArrowRight size={18} className=\"ml-2\" />\n                </Button>\n              </form>\n            ) : step === 2 ? (\n              <form onSubmit={(e) => { e.preventDefault(); handleNext(); }} className=\"space-y-4 max-w-md mx-auto\">\n                <GlassInput\n                  label=\"Admin Username\"\n                  placeholder=\"Choose a username\"\n                  value={username}\n                  onChange={(e) => setUsername(e.target.value)}\n                  required\n                  icon={<User size={16} />}\n                  data-testid=\"input-username\"\n                />\n\n                <GlassInput\n                  label=\"Email Address\"\n                  type=\"email\"\n                  placeholder=\"your@email.com\"\n                  value={email}\n                  onChange={(e) => setEmail(e.target.value)}\n                  required\n                  icon={<Mail size={16} />}\n                  data-testid=\"input-email\"\n                />\n\n                <GlassInput\n                  label=\"Password\"\n                  type=\"password\"\n                  placeholder=\"Create a strong password\"\n                  value={password}\n                  onChange={(e) => setPassword(e.target.value)}\n                  required\n                  icon={<Lock size={16} />}\n                  data-testid=\"input-password\"\n                />\n                \n                {password && (\n                  <div className=\"space-y-2 text-left\">\n                    <div className=\"flex items-center justify-between text-xs\">\n                      <span className=\"text-muted-foreground\">Password strength:</span>\n                      <span className={`font-medium ${\n                        passwordStrength.score >= 4 ? 'text-green-400' : \n                        passwordStrength.score >= 3 ? 'text-yellow-400' : 'text-red-400'\n                      }`}>\n                        {passwordStrength.label}\n                      </span>\n                    </div>\n                    <Progress \n                      value={(passwordStrength.score / 5) * 100} \n                      className=\"h-1.5\"\n                    />\n                    <div className=\"grid grid-cols-2 gap-1 text-xs\">\n                      <div className={`flex items-center gap-1 ${passwordStrength.requirements.minLength ? 'text-green-400' : 'text-muted-foreground'}`}>\n                        {passwordStrength.requirements.minLength ? <Check size={12} /> : <X size={12} />}\n                        8+ characters\n                      </div>\n                      <div className={`flex items-center gap-1 ${passwordStrength.requirements.hasUppercase ? 'text-green-400' : 'text-muted-foreground'}`}>\n                        {passwordStrength.requirements.hasUppercase ? <Check size={12} /> : <X size={12} />}\n                        Uppercase\n                      </div>\n                      <div className={`flex items-center gap-1 ${passwordStrength.requirements.hasLowercase ? 'text-green-400' : 'text-muted-foreground'}`}>\n                        {passwordStrength.requirements.hasLowercase ? <Check size={12} /> : <X size={12} />}\n                        Lowercase\n                      </div>\n                      <div className={`flex items-center gap-1 ${passwordStrength.requirements.hasNumber ? 'text-green-400' : 'text-muted-foreground'}`}>\n                        {passwordStrength.requirements.hasNumber ? <Check size={12} /> : <X size={12} />}\n                        Number\n                      </div>\n                      <div className={`flex items-center gap-1 ${passwordStrength.requirements.hasSpecial ? 'text-green-400' : 'text-muted-foreground'}`}>\n                        {passwordStrength.requirements.hasSpecial ? <Check size={12} /> : <X size={12} />}\n                        Special char\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                <GlassInput\n                  label=\"Confirm Password\"\n                  type=\"password\"\n                  placeholder=\"Confirm your password\"\n                  value={confirmPassword}\n                  onChange={(e) => setConfirmPassword(e.target.value)}\n                  required\n                  icon={<Lock size={16} />}\n                  data-testid=\"input-confirm-password\"\n                />\n\n                <div className=\"flex gap-3\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    className=\"flex-1 border-white/20\"\n                    onClick={() => setStep(1)}\n                    data-testid=\"button-back\"\n                  >\n                    <ArrowLeft size={18} className=\"mr-2\" />\n                    Back\n                  </Button>\n                  <Button\n                    type=\"submit\"\n                    className=\"flex-1 gradient-btn\"\n                    data-testid=\"button-next-step2\"\n                  >\n                    Next Step\n                    <ArrowRight size={18} className=\"ml-2\" />\n                  </Button>\n                </div>\n              </form>\n            ) : (\n              <form onSubmit={handleSubmit} className=\"space-y-6\">\n                <div className=\"grid md:grid-cols-2 gap-4\">\n                  <button\n                    type=\"button\"\n                    onClick={() => {\n                      setSelectedTier(\"BASIC\");\n                      setPaymentMethod(null);\n                    }}\n                    className={`p-6 rounded-xl border transition-all text-left ${\n                      selectedTier === \"BASIC\"\n                        ? \"border-cyan-500 bg-cyan-500/10 ring-2 ring-cyan-500/30\"\n                        : \"border-white/10 bg-white/5 hover:bg-white/10\"\n                    }`}\n                    data-testid=\"button-tier-basic\"\n                  >\n                    <div className=\"flex items-center gap-3 mb-4\">\n                      <div className=\"w-12 h-12 rounded-full bg-cyan-500/20 flex items-center justify-center\">\n                        <Zap size={24} className=\"text-cyan-400\" />\n                      </div>\n                      <div>\n                        <h3 className=\"font-bold text-white text-lg\">Basic</h3>\n                        <Badge className=\"bg-green-500/20 text-green-400 border-0\">\n                          Free 24hr Trial\n                        </Badge>\n                      </div>\n                    </div>\n                    <div className=\"mb-4\">\n                      <p className=\"text-2xl font-bold text-white\">Ksh 0</p>\n                      <p className=\"text-xs text-muted-foreground\">for 24 hours</p>\n                    </div>\n                    <ul className=\"space-y-2\">\n                      {tierFeatures.BASIC.map((feature, i) => (\n                        <li key={i} className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                          <Check size={14} className=\"text-cyan-400 flex-shrink-0\" />\n                          {feature}\n                        </li>\n                      ))}\n                    </ul>\n                    {selectedTier === \"BASIC\" && (\n                      <div className=\"mt-4 p-3 rounded-lg bg-cyan-500/20 text-center\">\n                        <Check size={20} className=\"text-cyan-400 mx-auto\" />\n                        <p className=\"text-sm text-cyan-400 font-medium\">Selected</p>\n                      </div>\n                    )}\n                  </button>\n\n                  <button\n                    type=\"button\"\n                    onClick={() => setSelectedTier(\"PREMIUM\")}\n                    className={`p-6 rounded-xl border transition-all text-left relative ${\n                      selectedTier === \"PREMIUM\"\n                        ? \"border-purple-500 bg-purple-500/10 ring-2 ring-purple-500/30\"\n                        : \"border-white/10 bg-white/5 hover:bg-white/10\"\n                    }`}\n                    data-testid=\"button-tier-premium\"\n                  >\n                    <div className=\"absolute -top-3 right-4\">\n                      <Badge className=\"bg-gradient-to-r from-purple-500 to-pink-500 text-white border-0\">\n                        <Crown size={12} className=\"mr-1\" />\n                        Recommended\n                      </Badge>\n                    </div>\n                    <div className=\"flex items-center gap-3 mb-4\">\n                      <div className=\"w-12 h-12 rounded-full bg-purple-500/20 flex items-center justify-center\">\n                        <Crown size={24} className=\"text-purple-400\" />\n                      </div>\n                      <div>\n                        <h3 className=\"font-bold text-white text-lg\">Premium</h3>\n                        <Badge className=\"bg-purple-500/20 text-purple-400 border-0\">\n                          Full Access\n                        </Badge>\n                      </div>\n                    </div>\n                    <div className=\"mb-4\">\n                      <p className=\"text-2xl font-bold text-white\">Ksh 2,500</p>\n                      <p className=\"text-xs text-muted-foreground\">per month</p>\n                    </div>\n                    <ul className=\"space-y-2\">\n                      {tierFeatures.PREMIUM.map((feature, i) => (\n                        <li key={i} className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                          <Check size={14} className=\"text-purple-400 flex-shrink-0\" />\n                          {feature}\n                        </li>\n                      ))}\n                    </ul>\n                    {selectedTier === \"PREMIUM\" && (\n                      <div className=\"mt-4 p-3 rounded-lg bg-purple-500/20 text-center\">\n                        <Check size={20} className=\"text-purple-400 mx-auto\" />\n                        <p className=\"text-sm text-purple-400 font-medium\">Selected</p>\n                      </div>\n                    )}\n                  </button>\n                </div>\n\n                {selectedTier === \"PREMIUM\" && (\n                  <div className=\"space-y-4 max-w-md mx-auto\">\n                    <p className=\"text-sm text-muted-foreground\">\n                      Choose your payment method:\n                    </p>\n                    \n                    <div className=\"space-y-3\">\n                      <button\n                        type=\"button\"\n                        onClick={() => setPaymentMethod(\"MPESA\")}\n                        className={`w-full p-4 rounded-xl border transition-all flex items-center gap-4 ${\n                          paymentMethod === \"MPESA\"\n                            ? \"border-green-500 bg-green-500/10\"\n                            : \"border-white/10 bg-white/5 hover:bg-white/10\"\n                        }`}\n                        data-testid=\"button-payment-mpesa\"\n                      >\n                        <div className=\"w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center\">\n                          <MpesaLogo size={24} />\n                        </div>\n                        <div className=\"flex-1 text-left\">\n                          <p className=\"font-semibold text-white\">M-Pesa</p>\n                          <p className=\"text-xs text-muted-foreground\">Pay instantly via STK Push</p>\n                        </div>\n                        {paymentMethod === \"MPESA\" && (\n                          <Check size={20} className=\"text-green-400\" />\n                        )}\n                      </button>\n\n                      <button\n                        type=\"button\"\n                        onClick={() => setPaymentMethod(\"BANK\")}\n                        className={`w-full p-4 rounded-xl border transition-all flex items-center gap-4 ${\n                          paymentMethod === \"BANK\"\n                            ? \"border-cyan-500 bg-cyan-500/10\"\n                            : \"border-white/10 bg-white/5 hover:bg-white/10\"\n                        }`}\n                        data-testid=\"button-payment-bank\"\n                      >\n                        <div className=\"w-10 h-10 rounded-full bg-cyan-500/20 flex items-center justify-center\">\n                          <Building size={20} className=\"text-cyan-400\" />\n                        </div>\n                        <div className=\"flex-1 text-left\">\n                          <p className=\"font-semibold text-white\">Bank Transfer</p>\n                          <p className=\"text-xs text-muted-foreground\">Pay via bank deposit</p>\n                        </div>\n                        {paymentMethod === \"BANK\" && (\n                          <Check size={20} className=\"text-cyan-400\" />\n                        )}\n                      </button>\n                    </div>\n\n                    {paymentMethod === \"MPESA\" && (\n                      <GlassInput\n                        label=\"M-Pesa Phone Number\"\n                        placeholder=\"254712345678\"\n                        value={phoneNumber}\n                        onChange={(e) => setPhoneNumber(e.target.value.replace(/[^0-9]/g, ''))}\n                        required\n                        icon={<Phone size={16} />}\n                        data-testid=\"input-phone-number\"\n                      />\n                    )}\n                  </div>\n                )}\n\n                <div className=\"flex gap-3 max-w-md mx-auto\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    className=\"flex-1 border-white/20\"\n                    onClick={() => setStep(2)}\n                    data-testid=\"button-back-step3\"\n                  >\n                    <ArrowLeft size={18} className=\"mr-2\" />\n                    Back\n                  </Button>\n                  <Button\n                    type=\"submit\"\n                    className={`flex-1 ${\n                      selectedTier === \"PREMIUM\" \n                        ? \"bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600\" \n                        : \"gradient-btn\"\n                    }`}\n                    disabled={isLoading || !selectedTier}\n                    data-testid=\"button-create-account\"\n                  >\n                    {isLoading ? (\n                      <>\n                        <Loader2 size={18} className=\"mr-2 animate-spin\" />\n                        Creating...\n                      </>\n                    ) : (\n                      <>\n                        {selectedTier === \"BASIC\" ? \"Start Free Trial\" : \"Create Account\"}\n                        <ArrowRight size={18} className=\"ml-2\" />\n                      </>\n                    )}\n                  </Button>\n                </div>\n              </form>\n            )}\n\n            <div className=\"mt-6 pt-6 border-t border-white/10 max-w-md mx-auto\">\n              <p className=\"text-sm text-muted-foreground\">\n                Already have an account?{\" \"}\n                <Link \n                  href=\"/login\" \n                  className=\"text-cyan-400 hover:text-cyan-300 transition-colors font-medium\"\n                  data-testid=\"link-login\"\n                >\n                  Sign in here\n                </Link>\n              </p>\n            </div>\n          </GlassPanel>\n        </motion.div>\n      </div>\n    </>\n  );\n}\n","path":null,"size_bytes":30758,"size_tokens":null},"client/src/pages/forgot-password.tsx":{"content":"import { useState } from \"react\";\nimport { Link } from \"wouter\";\nimport { motion } from \"framer-motion\";\nimport { Mail, Loader2, ArrowRight, ArrowLeft, Check, KeyRound, Building2 } from \"lucide-react\";\nimport { MeshBackground } from \"@/components/mesh-background\";\nimport { MnetiFiLogo } from \"@/components/mnetifi-logo\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function ForgotPasswordPage() {\n  const { toast } = useToast();\n  const [step, setStep] = useState<'request' | 'sent'>('request');\n  const [isLoading, setIsLoading] = useState(false);\n  const [email, setEmail] = useState(\"\");\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!email.trim()) {\n      toast({\n        title: \"Email required\",\n        description: \"Please enter your email address\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) {\n      toast({\n        title: \"Invalid email\",\n        description: \"Please enter a valid email address\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsLoading(true);\n\n    try {\n      const response = await fetch(\"/api/auth/forgot-password\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ email }),\n      });\n\n      const data = await response.json();\n\n      if (response.ok) {\n        setStep('sent');\n        toast({\n          title: \"Reset link sent\",\n          description: \"Check your email for password reset instructions\",\n        });\n      } else {\n        toast({\n          title: \"Request Failed\",\n          description: data.error || \"Unable to process request\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      toast({\n        title: \"Request Failed\",\n        description: \"Unable to connect to server\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <>\n      <MeshBackground />\n      <div className=\"min-h-screen flex items-center justify-center p-4 relative z-10\">\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.5 }}\n          className=\"w-full max-w-md\"\n        >\n          <GlassPanel size=\"lg\" className=\"text-center\">\n            <div className=\"mb-8\">\n              <MnetiFiLogo size=\"lg\" className=\"mx-auto mb-4\" />\n              <div className=\"flex items-center justify-center gap-2 mb-2\">\n                <Badge variant=\"outline\" className=\"bg-cyan-500/20 text-cyan-400 border-0\">\n                  <Building2 size={12} className=\"mr-1\" />\n                  ISP Portal\n                </Badge>\n              </div>\n              <h1 className=\"text-2xl font-bold text-white mb-2\">\n                {step === 'request' ? 'ISP Password Reset' : 'Check Your Email'}\n              </h1>\n              <p className=\"text-muted-foreground\">\n                {step === 'request' \n                  ? 'Enter your ISP admin email to receive a reset link' \n                  : 'We sent you password reset instructions'}\n              </p>\n            </div>\n\n            {step === 'request' ? (\n              <form onSubmit={handleSubmit} className=\"space-y-4\">\n                <GlassInput\n                  label=\"Email Address\"\n                  type=\"email\"\n                  placeholder=\"Enter your ISP admin email\"\n                  value={email}\n                  onChange={(e) => setEmail(e.target.value)}\n                  required\n                  icon={<Mail size={16} />}\n                  data-testid=\"input-email\"\n                />\n\n                <Button\n                  type=\"submit\"\n                  className=\"w-full gradient-btn\"\n                  disabled={isLoading}\n                  data-testid=\"button-send-reset\"\n                >\n                  {isLoading ? (\n                    <>\n                      <Loader2 size={18} className=\"mr-2 animate-spin\" />\n                      Sending...\n                    </>\n                  ) : (\n                    <>\n                      Send Reset Link\n                      <ArrowRight size={18} className=\"ml-2\" />\n                    </>\n                  )}\n                </Button>\n              </form>\n            ) : (\n              <div className=\"space-y-6\">\n                <div className=\"w-16 h-16 mx-auto rounded-full bg-cyan-500/20 flex items-center justify-center\">\n                  <Check size={32} className=\"text-cyan-400\" />\n                </div>\n                \n                <div className=\"space-y-2\">\n                  <p className=\"text-white/80\">\n                    We sent a password reset link to:\n                  </p>\n                  <p className=\"text-cyan-400 font-medium\">\n                    {email}\n                  </p>\n                </div>\n\n                <div className=\"p-4 rounded-lg bg-white/5 text-left\">\n                  <p className=\"text-sm text-muted-foreground\">\n                    <KeyRound size={14} className=\"inline mr-2\" />\n                    The link will expire in 1 hour. If you don't see the email, check your spam folder.\n                  </p>\n                </div>\n\n                <Button\n                  onClick={() => { setStep('request'); setEmail(''); }}\n                  variant=\"outline\"\n                  className=\"w-full border-white/20\"\n                  data-testid=\"button-try-again\"\n                >\n                  <ArrowLeft size={18} className=\"mr-2\" />\n                  Try a different email\n                </Button>\n              </div>\n            )}\n\n            <div className=\"mt-6 pt-6 border-t border-white/10\">\n              <p className=\"text-sm text-muted-foreground\">\n                Remember your password?{\" \"}\n                <Link \n                  href=\"/login\" \n                  className=\"text-cyan-400 hover:text-cyan-300 transition-colors font-medium\"\n                  data-testid=\"link-login\"\n                >\n                  Back to ISP login\n                </Link>\n              </p>\n            </div>\n\n            <div className=\"mt-4 pt-4 border-t border-white/10\">\n              <p className=\"text-xs text-muted-foreground\">\n                Platform Administrator?{\" \"}\n                <Link \n                  href=\"/superadmin/forgot-password\" \n                  className=\"text-pink-400 hover:text-pink-300 transition-colors font-medium\"\n                >\n                  Super Admin Password Reset\n                </Link>\n              </p>\n            </div>\n          </GlassPanel>\n        </motion.div>\n      </div>\n    </>\n  );\n}\n","path":null,"size_bytes":6895,"size_tokens":null},"client/src/pages/superadmin-tenants.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { motion } from \"framer-motion\";\nimport {\n  Building2,\n  Search,\n  Filter,\n  MoreVertical,\n  Play,\n  Pause,\n  Ban,\n  CheckCircle,\n  Clock,\n  Users,\n  DollarSign,\n  Calendar,\n  Eye,\n} from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n  DropdownMenuSeparator,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { format } from \"date-fns\";\n\ninterface TenantWithStats {\n  id: string;\n  name: string;\n  subdomain: string;\n  tier: string;\n  isActive: boolean;\n  saasBillingStatus: string;\n  trialExpiresAt: string | null;\n  subscriptionExpiresAt: string | null;\n  createdAt: string;\n  userCount: number;\n  transactionCount: number;\n  revenueThisMonth: number;\n}\n\nexport default function SuperAdminTenantsPage() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState<string>(\"all\");\n  const [tierFilter, setTierFilter] = useState<string>(\"all\");\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n\n  const { data: tenants, isLoading } = useQuery<TenantWithStats[]>({\n    queryKey: [\"/api/superadmin/tenants\"],\n  });\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async ({ id, isActive, saasBillingStatus }: { \n      id: string; \n      isActive?: boolean; \n      saasBillingStatus?: string \n    }) => {\n      return apiRequest(\"PATCH\", `/api/superadmin/tenants/${id}/status`, {\n        isActive,\n        saasBillingStatus,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/superadmin/tenants\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/superadmin/analytics\"] });\n      toast({\n        title: \"Tenant Updated\",\n        description: \"The tenant status has been updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Update Failed\",\n        description: error.message || \"Failed to update tenant status\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateTierMutation = useMutation({\n    mutationFn: async ({ id, tier }: { id: string; tier: string }) => {\n      return apiRequest(\"PATCH\", `/api/superadmin/tenants/${id}/subscription`, {\n        tier,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/superadmin/tenants\"] });\n      toast({\n        title: \"Tier Updated\",\n        description: \"The tenant tier has been updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Update Failed\",\n        description: error.message || \"Failed to update tenant tier\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat(\"en-KE\", {\n      style: \"currency\",\n      currency: \"KES\",\n      minimumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  const getStatusBadge = (status: string) => {\n    const statusConfig: Record<string, { bg: string; text: string; label: string }> = {\n      ACTIVE: { bg: \"bg-cyan-500/20\", text: \"text-cyan-400\", label: \"Active\" },\n      TRIAL: { bg: \"bg-purple-500/20\", text: \"text-purple-400\", label: \"Trial\" },\n      SUSPENDED: { bg: \"bg-amber-500/20\", text: \"text-amber-400\", label: \"Suspended\" },\n      BLOCKED: { bg: \"bg-red-500/20\", text: \"text-red-400\", label: \"Blocked\" },\n      PENDING: { bg: \"bg-slate-500/20\", text: \"text-slate-400\", label: \"Pending\" },\n    };\n    const config = statusConfig[status] || statusConfig.PENDING;\n    return (\n      <Badge variant=\"outline\" className={`${config.bg} ${config.text} border-0`}>\n        {config.label}\n      </Badge>\n    );\n  };\n\n  const getTierBadge = (tier: string) => {\n    const tierConfig: Record<string, { bg: string; text: string }> = {\n      TRIAL: { bg: \"bg-purple-500/20\", text: \"text-purple-400\" },\n      TIER_1: { bg: \"bg-cyan-500/20\", text: \"text-cyan-400\" },\n      TIER_2: { bg: \"bg-pink-500/20\", text: \"text-pink-400\" },\n    };\n    const config = tierConfig[tier] || tierConfig.TRIAL;\n    return (\n      <Badge variant=\"outline\" className={`${config.bg} ${config.text} border-0`}>\n        {tier.replace(\"_\", \" \")}\n      </Badge>\n    );\n  };\n\n  const filteredTenants = tenants?.filter((tenant) => {\n    const matchesSearch =\n      tenant.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      tenant.subdomain.toLowerCase().includes(searchQuery.toLowerCase());\n    const matchesStatus = statusFilter === \"all\" || tenant.saasBillingStatus === statusFilter;\n    const matchesTier = tierFilter === \"all\" || tenant.tier === tierFilter;\n    return matchesSearch && matchesStatus && matchesTier;\n  });\n\n  const handleActivate = (tenant: TenantWithStats) => {\n    updateStatusMutation.mutate({\n      id: tenant.id,\n      isActive: true,\n      saasBillingStatus: \"ACTIVE\",\n    });\n  };\n\n  const handleSuspend = (tenant: TenantWithStats) => {\n    updateStatusMutation.mutate({\n      id: tenant.id,\n      isActive: false,\n      saasBillingStatus: \"SUSPENDED\",\n    });\n  };\n\n  const handleBlock = (tenant: TenantWithStats) => {\n    updateStatusMutation.mutate({\n      id: tenant.id,\n      isActive: false,\n      saasBillingStatus: \"BLOCKED\",\n    });\n  };\n\n  const handleChangeTier = (tenantId: string, tier: string) => {\n    updateTierMutation.mutate({ id: tenantId, tier });\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"superadmin-tenants-page\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">Tenant Management</h1>\n          <p className=\"text-muted-foreground\">\n            Manage all tenants, their subscriptions, and access.\n          </p>\n        </div>\n      </div>\n\n      <GlassPanel size=\"sm\">\n        <div className=\"flex items-center gap-4 flex-wrap\">\n          <div className=\"relative flex-1 min-w-[200px]\">\n            <Search size={18} className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" />\n            <Input\n              placeholder=\"Search tenants...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"pl-10 bg-white/5 border-white/10\"\n              data-testid=\"input-search-tenants\"\n            />\n          </div>\n          <Select value={statusFilter} onValueChange={setStatusFilter}>\n            <SelectTrigger className=\"w-[150px] bg-white/5 border-white/10\" data-testid=\"select-status-filter\">\n              <SelectValue placeholder=\"Status\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Status</SelectItem>\n              <SelectItem value=\"ACTIVE\">Active</SelectItem>\n              <SelectItem value=\"TRIAL\">Trial</SelectItem>\n              <SelectItem value=\"SUSPENDED\">Suspended</SelectItem>\n              <SelectItem value=\"BLOCKED\">Blocked</SelectItem>\n            </SelectContent>\n          </Select>\n          <Select value={tierFilter} onValueChange={setTierFilter}>\n            <SelectTrigger className=\"w-[150px] bg-white/5 border-white/10\" data-testid=\"select-tier-filter\">\n              <SelectValue placeholder=\"Tier\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Tiers</SelectItem>\n              <SelectItem value=\"TRIAL\">Trial</SelectItem>\n              <SelectItem value=\"TIER_1\">Tier 1</SelectItem>\n              <SelectItem value=\"TIER_2\">Tier 2</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      </GlassPanel>\n\n      <GlassPanel size=\"md\">\n        {isLoading ? (\n          <div className=\"space-y-4\">\n            {[1, 2, 3, 4, 5].map((i) => (\n              <div key={i} className=\"animate-pulse flex items-center gap-4 p-4 rounded-lg bg-white/5\">\n                <div className=\"w-12 h-12 rounded-full bg-white/10\" />\n                <div className=\"flex-1 space-y-2\">\n                  <div className=\"h-4 bg-white/10 rounded w-1/4\" />\n                  <div className=\"h-3 bg-white/10 rounded w-1/6\" />\n                </div>\n                <div className=\"h-6 w-16 bg-white/10 rounded\" />\n                <div className=\"h-6 w-16 bg-white/10 rounded\" />\n                <div className=\"h-8 w-8 bg-white/10 rounded\" />\n              </div>\n            ))}\n          </div>\n        ) : filteredTenants && filteredTenants.length > 0 ? (\n          <div className=\"space-y-3\">\n            {filteredTenants.map((tenant, index) => (\n              <motion.div\n                key={tenant.id}\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: index * 0.05 }}\n                className=\"flex items-center gap-4 p-4 rounded-lg border bg-white/5 border-white/10\"\n                data-testid={`tenant-card-${tenant.id}`}\n              >\n                <div className=\"w-12 h-12 rounded-full bg-gradient-to-br from-cyan-500/20 to-purple-500/20 flex items-center justify-center flex-shrink-0\">\n                  <Building2 size={20} className=\"text-cyan-400\" />\n                </div>\n\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-center gap-2 flex-wrap\">\n                    <p className=\"font-semibold text-white\">{tenant.name}</p>\n                    {getTierBadge(tenant.tier)}\n                    {getStatusBadge(tenant.saasBillingStatus)}\n                  </div>\n                  <p className=\"text-sm text-muted-foreground\">{tenant.subdomain}</p>\n                </div>\n\n                <div className=\"hidden md:flex items-center gap-6\">\n                  <div className=\"text-center\">\n                    <div className=\"flex items-center gap-1 text-muted-foreground\">\n                      <Users size={14} />\n                      <span className=\"text-xs\">Users</span>\n                    </div>\n                    <p className=\"font-semibold text-white\">{tenant.userCount}</p>\n                  </div>\n                  <div className=\"text-center\">\n                    <div className=\"flex items-center gap-1 text-muted-foreground\">\n                      <DollarSign size={14} />\n                      <span className=\"text-xs\">Revenue</span>\n                    </div>\n                    <p className=\"font-semibold text-white\">{formatCurrency(tenant.revenueThisMonth)}</p>\n                  </div>\n                  <div className=\"text-center\">\n                    <div className=\"flex items-center gap-1 text-muted-foreground\">\n                      <Calendar size={14} />\n                      <span className=\"text-xs\">Created</span>\n                    </div>\n                    <p className=\"text-sm text-white\">\n                      {format(new Date(tenant.createdAt), \"MMM d, yyyy\")}\n                    </p>\n                  </div>\n                </div>\n\n                <DropdownMenu>\n                  <DropdownMenuTrigger asChild>\n                    <Button variant=\"ghost\" size=\"icon\" data-testid={`button-tenant-actions-${tenant.id}`}>\n                      <MoreVertical size={18} />\n                    </Button>\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent align=\"end\">\n                    <DropdownMenuItem \n                      onClick={() => setLocation(`/superadmin/tenants/${tenant.id}`)}\n                      data-testid={`action-view-${tenant.id}`}\n                    >\n                      <Eye size={16} className=\"mr-2\" />\n                      View Details\n                    </DropdownMenuItem>\n                    <DropdownMenuSeparator />\n                    {tenant.saasBillingStatus !== \"ACTIVE\" && (\n                      <DropdownMenuItem \n                        onClick={() => handleActivate(tenant)}\n                        data-testid={`action-activate-${tenant.id}`}\n                      >\n                        <CheckCircle size={16} className=\"mr-2 text-cyan-400\" />\n                        Activate\n                      </DropdownMenuItem>\n                    )}\n                    {tenant.saasBillingStatus !== \"SUSPENDED\" && (\n                      <DropdownMenuItem \n                        onClick={() => handleSuspend(tenant)}\n                        data-testid={`action-suspend-${tenant.id}`}\n                      >\n                        <Pause size={16} className=\"mr-2 text-amber-400\" />\n                        Suspend\n                      </DropdownMenuItem>\n                    )}\n                    {tenant.saasBillingStatus !== \"BLOCKED\" && (\n                      <DropdownMenuItem \n                        onClick={() => handleBlock(tenant)}\n                        data-testid={`action-block-${tenant.id}`}\n                      >\n                        <Ban size={16} className=\"mr-2 text-red-400\" />\n                        Block\n                      </DropdownMenuItem>\n                    )}\n                    <DropdownMenuSeparator />\n                    <DropdownMenuItem \n                      onClick={() => handleChangeTier(tenant.id, \"TRIAL\")}\n                      disabled={tenant.tier === \"TRIAL\"}\n                      data-testid={`action-tier-trial-${tenant.id}`}\n                    >\n                      Set to Trial\n                    </DropdownMenuItem>\n                    <DropdownMenuItem \n                      onClick={() => handleChangeTier(tenant.id, \"TIER_1\")}\n                      disabled={tenant.tier === \"TIER_1\"}\n                      data-testid={`action-tier-1-${tenant.id}`}\n                    >\n                      Set to Tier 1\n                    </DropdownMenuItem>\n                    <DropdownMenuItem \n                      onClick={() => handleChangeTier(tenant.id, \"TIER_2\")}\n                      disabled={tenant.tier === \"TIER_2\"}\n                      data-testid={`action-tier-2-${tenant.id}`}\n                    >\n                      Set to Tier 2\n                    </DropdownMenuItem>\n                  </DropdownMenuContent>\n                </DropdownMenu>\n              </motion.div>\n            ))}\n          </div>\n        ) : (\n          <div className=\"text-center py-12 text-muted-foreground\">\n            <Building2 size={48} className=\"mx-auto mb-4 opacity-50\" />\n            <p>No tenants found</p>\n            {(searchQuery || statusFilter !== \"all\" || tierFilter !== \"all\") && (\n              <p className=\"text-sm mt-1\">Try adjusting your filters</p>\n            )}\n          </div>\n        )}\n      </GlassPanel>\n    </div>\n  );\n}\n","path":null,"size_bytes":15058,"size_tokens":null},"server/middleware/rbac.ts":{"content":"import type { Request, Response, NextFunction } from \"express\";\nimport { UserRole, type UserRoleValue, SubscriptionTier, TierFeatures } from \"@shared/schema\";\nimport { storage } from \"../storage\";\n\ndeclare module \"express-session\" {\n  interface SessionData {\n    user?: {\n      id: string;\n      username: string;\n      role: UserRoleValue;\n      tenantId?: string | null;\n      email?: string | null;\n    };\n    subscriptionTier?: string;\n    trialExpiresAt?: string | null;\n  }\n}\n\nexport interface AuthenticatedRequest extends Request {\n  user?: {\n    id: string;\n    username: string;\n    role: UserRoleValue;\n    tenantId?: string | null;\n    email?: string | null;\n  };\n}\n\nconst roleHierarchy: Record<UserRoleValue, number> = {\n  [UserRole.SUPERADMIN]: 3,\n  [UserRole.ADMIN]: 2,\n  [UserRole.TECH]: 1,\n};\n\nexport function requireAuth(req: Request, res: Response, next: NextFunction) {\n  if (!req.session?.user) {\n    return res.status(401).json({ error: \"Authentication required\" });\n  }\n  (req as AuthenticatedRequest).user = req.session.user;\n  next();\n}\n\nexport function requireRole(...allowedRoles: UserRoleValue[]) {\n  return (req: Request, res: Response, next: NextFunction) => {\n    if (!req.session?.user) {\n      return res.status(401).json({ error: \"Authentication required\" });\n    }\n\n    const userRole = req.session.user.role as UserRoleValue;\n    \n    if (!allowedRoles.includes(userRole)) {\n      return res.status(403).json({ \n        error: \"Access denied\",\n        message: `This action requires one of the following roles: ${allowedRoles.join(\", \")}`\n      });\n    }\n\n    (req as AuthenticatedRequest).user = req.session.user;\n    next();\n  };\n}\n\nexport function requireMinRole(minRole: UserRoleValue) {\n  return (req: Request, res: Response, next: NextFunction) => {\n    if (!req.session?.user) {\n      return res.status(401).json({ error: \"Authentication required\" });\n    }\n\n    const userRole = req.session.user.role as UserRoleValue;\n    const userRoleLevel = roleHierarchy[userRole] || 0;\n    const requiredRoleLevel = roleHierarchy[minRole] || 0;\n\n    if (userRoleLevel < requiredRoleLevel) {\n      return res.status(403).json({ \n        error: \"Access denied\",\n        message: `This action requires ${minRole} role or higher`\n      });\n    }\n\n    (req as AuthenticatedRequest).user = req.session.user;\n    next();\n  };\n}\n\nexport const requireSuperAdmin = requireRole(UserRole.SUPERADMIN);\nexport const requireAdmin = requireMinRole(UserRole.ADMIN);\nexport const requireTech = requireMinRole(UserRole.TECH);\n\nexport function requireTenantAccess(req: Request, res: Response, next: NextFunction) {\n  if (!req.session?.user) {\n    return res.status(401).json({ error: \"Authentication required\" });\n  }\n\n  const userRole = req.session.user.role as UserRoleValue;\n  \n  if (userRole === UserRole.SUPERADMIN) {\n    (req as AuthenticatedRequest).user = req.session.user;\n    return next();\n  }\n\n  if (!req.session.user.tenantId) {\n    return res.status(403).json({ \n      error: \"Access denied\",\n      message: \"User is not associated with any tenant\"\n    });\n  }\n\n  (req as AuthenticatedRequest).user = req.session.user;\n  next();\n}\n\n// Helper function to get tenant ID from session\nexport function getSessionTenantId(req: Request): string | null {\n  return req.session?.user?.tenantId || null;\n}\n\n// Combined middleware that requires auth AND tenant access, returns tenantId\nexport function requireAuthWithTenant(req: Request, res: Response, next: NextFunction) {\n  if (!req.session?.user) {\n    return res.status(401).json({ error: \"Authentication required\" });\n  }\n\n  const userRole = req.session.user.role as UserRoleValue;\n  \n  // Superadmins can access any tenant - they should provide tenantId in query/body\n  if (userRole === UserRole.SUPERADMIN) {\n    (req as AuthenticatedRequest).user = req.session.user;\n    return next();\n  }\n\n  if (!req.session.user.tenantId) {\n    return res.status(403).json({ \n      error: \"Access denied\",\n      message: \"User is not associated with any tenant\"\n    });\n  }\n\n  (req as AuthenticatedRequest).user = req.session.user;\n  next();\n}\n\n// Middleware to require PREMIUM subscription tier\nexport async function requirePremium(req: Request, res: Response, next: NextFunction) {\n  if (!req.session?.user) {\n    return res.status(401).json({ error: \"Authentication required\" });\n  }\n\n  const userRole = req.session.user.role as UserRoleValue;\n  \n  // Superadmins bypass subscription checks\n  if (userRole === UserRole.SUPERADMIN) {\n    (req as AuthenticatedRequest).user = req.session.user;\n    return next();\n  }\n\n  const tenantId = req.session.user.tenantId;\n  if (!tenantId) {\n    return res.status(403).json({ \n      error: \"Access denied\",\n      message: \"User is not associated with any tenant\"\n    });\n  }\n\n  try {\n    const tenant = await storage.getTenant(tenantId);\n    if (!tenant) {\n      return res.status(404).json({ error: \"Tenant not found\" });\n    }\n\n    const now = new Date();\n    const isPremium = tenant.subscriptionTier === SubscriptionTier.PREMIUM;\n    const isTrialActive = tenant.trialExpiresAt && new Date(tenant.trialExpiresAt) > now;\n    \n    // Subscription is active if:\n    // - No expiration set (null = indefinite for legacy/admin-created tenants)\n    // - Expiration date is in the future\n    const isSubscriptionActive = !tenant.subscriptionExpiresAt || new Date(tenant.subscriptionExpiresAt) > now;\n\n    // Allow access if:\n    // 1. Any tier during active trial period (trial gives full access)\n    // 2. Premium tier with active (or no) subscription expiry\n    if (isTrialActive) {\n      (req as AuthenticatedRequest).user = req.session.user;\n      return next();\n    }\n\n    if (isPremium && isSubscriptionActive) {\n      (req as AuthenticatedRequest).user = req.session.user;\n      return next();\n    }\n\n    // Subscription required\n    return res.status(403).json({ \n      error: \"Premium subscription required\",\n      message: \"This feature requires an active Premium subscription. Please upgrade to continue.\",\n      upgradeUrl: \"/dashboard/upgrade\"\n    });\n  } catch (error) {\n    console.error(\"Error checking subscription:\", error);\n    return res.status(500).json({ error: \"Failed to verify subscription\" });\n  }\n}\n\n// Middleware to require a specific feature based on subscription tier\nexport function requireFeature(featureName: string) {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    if (!req.session?.user) {\n      return res.status(401).json({ error: \"Authentication required\" });\n    }\n\n    const userRole = req.session.user.role as UserRoleValue;\n    \n    // Superadmins bypass feature checks\n    if (userRole === UserRole.SUPERADMIN) {\n      (req as AuthenticatedRequest).user = req.session.user;\n      return next();\n    }\n\n    const tenantId = req.session.user.tenantId;\n    if (!tenantId) {\n      return res.status(403).json({ \n        error: \"Access denied\",\n        message: \"User is not associated with any tenant\"\n      });\n    }\n\n    try {\n      const tenant = await storage.getTenant(tenantId);\n      if (!tenant) {\n        return res.status(404).json({ error: \"Tenant not found\" });\n      }\n\n      const now = new Date();\n      const isTrialActive = tenant.trialExpiresAt && new Date(tenant.trialExpiresAt) > now;\n      \n      // Subscription is active if no expiration set (legacy) or expiration is in future\n      const isSubscriptionActive = !tenant.subscriptionExpiresAt || new Date(tenant.subscriptionExpiresAt) > now;\n      \n      // During trial, allow all features\n      if (isTrialActive) {\n        (req as AuthenticatedRequest).user = req.session.user;\n        return next();\n      }\n\n      // Check if the feature is available for this tier\n      const tier = (tenant.subscriptionTier || SubscriptionTier.BASIC) as keyof typeof TierFeatures;\n      const allowedFeatures = TierFeatures[tier] || TierFeatures.BASIC;\n      \n      // Check if feature is in the allowed list for this tier AND subscription is active\n      if (allowedFeatures.includes(featureName as any) && isSubscriptionActive) {\n        (req as AuthenticatedRequest).user = req.session.user;\n        return next();\n      }\n\n      // Check if feature is PREMIUM-only (in PREMIUM but not in BASIC)\n      const isPremiumFeature = TierFeatures.PREMIUM.includes(featureName as any) && \n                               !TierFeatures.BASIC.includes(featureName as any);\n\n      return res.status(403).json({ \n        error: isPremiumFeature ? \"Premium subscription required\" : \"Feature not available\",\n        message: isPremiumFeature \n          ? `This feature requires a Premium subscription. Please upgrade to continue.`\n          : \"This feature is not available on your subscription plan.\",\n        upgradeUrl: \"/dashboard/upgrade\"\n      });\n    } catch (error) {\n      console.error(\"Error checking feature access:\", error);\n      return res.status(500).json({ error: \"Failed to verify feature access\" });\n    }\n  };\n}\n","path":null,"size_bytes":8947,"size_tokens":null},"DEVELOPMENT_ROADMAP.md":{"content":"# MnetiFi WiFi Billing Platform - Development Roadmap\n\n**Last Updated:** December 5, 2025  \n**Status:** Feature Analysis & Prioritization Complete\n\n---\n\n## EXECUTIVE SUMMARY\n\nThis document analyzes the proposed features from competitor platforms (Netpap, Kivipay, Cute Profit, Hotspot Kenya) and maps them against MnetiFi's current implementation. Features are prioritized based on business impact, technical complexity, and market competitiveness.\n\n---\n\n## FEATURE ANALYSIS: IMPLEMENTED vs. PROPOSED\n\n### Legend\n-  **Fully Implemented** - Ready for production\n-  **Partially Implemented** - Backend exists, needs UI or enhancement\n-  **Not Implemented** - Needs full development\n\n---\n\n### 1. BILLING & INVOICING\n\n| Feature | Status | Notes |\n|---------|--------|-------|\n| M-Pesa STK Push |  | Full integration with Daraja API |\n| Prepaid billing (Hotspot) |  | Working with automatic expiry |\n| Postpaid billing (PPPoE/Static) |  | Schema ready, needs monthly cycle |\n| Automated payment reminders |  | SMS service ready, scheduler needed |\n| Service suspension/reconnection |  | Auto-suspend on expiry |\n| Burst rates/QoS |  | Full burst support in plans |\n| Data caps/FUP |  | Not implemented |\n| Discount/coupon codes |  | Not implemented |\n| Wallet system |  | Not implemented |\n| Invoice generation |  | Not implemented |\n| Export to Excel |  | Not implemented |\n\n### 2. CUSTOMER MANAGEMENT\n\n| Feature | Status | Notes |\n|---------|--------|-------|\n| WiFi user CRUD |  | Full management UI |\n| Customer self-service portal |  | Captive portal only, no account view |\n| Support ticketing |  | Full ticket management |\n| Customer grouping/segmentation |  | Not implemented |\n| Lead tracking |  | Not implemented |\n\n### 3. NETWORK MANAGEMENT\n\n| Feature | Status | Notes |\n|---------|--------|-------|\n| Hotspot management |  | Full NAS device management |\n| PPPoE user management |  | Supported via account type |\n| Static IP management |  | Supported via account type |\n| MikroTik API integration |  | Full RouterOS API service |\n| RADIUS CoA support |  | Disconnect/rate-limit updates |\n| Remote router monitoring |  | API exists, no UI dashboard |\n| Router config backup |  | Not implemented |\n| Remote router reboot |  | API ready, no UI |\n| TR-069 device management |  | Not implemented |\n| Network topology mapping |  | Not implemented |\n\n### 4. HOTSPOT-SPECIFIC FEATURES\n\n| Feature | Status | Notes |\n|---------|--------|-------|\n| Captive portal |  | Glassmorphic mobile-first design |\n| Walled garden domains |  | Configurable pre-auth domains |\n| Session inactivity logout |  | 15-min timeout not implemented |\n| Device limit per voucher |  | `simultaneousUse` in schema, not enforced |\n| Voucher system |  | Not implemented |\n\n### 5. NOTIFICATIONS & COMMUNICATION\n\n| Feature | Status | Notes |\n|---------|--------|-------|\n| SMS notifications |  | Service ready, not fully integrated |\n| Bulk SMS campaigns |  | Not implemented |\n| Email notifications |  | Job type exists, no service |\n| WhatsApp integration |  | Not implemented |\n| In-app support chat |  | Not implemented |\n\n### 6. REPORTING & ANALYTICS\n\n| Feature | Status | Notes |\n|---------|--------|-------|\n| Revenue reports |  | Financial endpoint exists |\n| Reconciliation reports |  | Full M-Pesa matching |\n| Expiring users alerts |  | Dashboard widget |\n| User activity reports |  | Endpoint exists |\n| Unit economics (Churn/LTV) |  | Not implemented |\n| Hotspot analytics |  | Basic data, no graphs |\n| Real-time bandwidth graphs |  | Not implemented |\n\n### 7. MULTI-TENANT & ACCESS CONTROL\n\n| Feature | Status | Notes |\n|---------|--------|-------|\n| Multi-tenant isolation |  | Full tenant separation |\n| ISP admin login |  | Working authentication |\n| Super admin console |  | Not implemented |\n| Tech accounts (limited role) |  | Role field exists, no enforcement |\n| ISP tiered pricing |  | Schema ready, no billing UI |\n| RBAC (Role-Based Access) |  | Basic role field, no permissions |\n\n### 8. WHITE LABELING & CUSTOMIZATION\n\n| Feature | Status | Notes |\n|---------|--------|-------|\n| ISP branding (logo/colors) |  | Schema ready, no UI |\n| Custom subdomains |  | Field exists, not functional |\n| Captive portal theming |  | Fixed design only |\n\n### 9. VALUE-ADDED FEATURES\n\n| Feature | Status | Notes |\n|---------|--------|-------|\n| Referral program |  | Not implemented |\n| Guest passes/trials |  | Can create short plans, no trial mode |\n| Compensation module |  | Not implemented |\n| Reseller management |  | Not implemented |\n| Stock/inventory |  | Not implemented |\n\n---\n\n## PRIORITIZED DEVELOPMENT PHASES\n\nBased on business impact, market competitiveness, and technical dependencies:\n\n---\n\n### PHASE 1: CORE BUSINESS FEATURES (High Priority)\n**Timeline:** 2-3 weeks  \n**Impact:** Critical for SaaS monetization and competitive parity\n\n#### 1.1 Super Admin Console\n**Priority:** CRITICAL  \n**Effort:** Medium  \n**Dependencies:** None\n\n**Tasks:**\n- [ ] Create super admin authentication (separate from ISP login)\n- [ ] Build tenant listing page with status, revenue metrics\n- [ ] Implement tenant suspend/activate functionality\n- [ ] Platform-wide analytics dashboard (total revenue, active ISPs, MRR)\n- [ ] ISP account search and filtering\n\n**API Endpoints Needed:**\n```\nGET    /api/superadmin/tenants\nGET    /api/superadmin/tenants/:id\nPATCH  /api/superadmin/tenants/:id/status\nGET    /api/superadmin/analytics\nGET    /api/superadmin/revenue\n```\n\n#### 1.2 ISP Tiered Billing Automation\n**Priority:** CRITICAL  \n**Effort:** Medium  \n**Dependencies:** Super Admin Console\n\n**Tasks:**\n- [ ] Implement 24-hour free trial auto-expiry\n- [ ] Tier 1 vs Tier 2 feature gating middleware\n- [ ] ISP subscription payment tracking\n- [ ] Automated billing reminder jobs\n- [ ] ISP invoice generation\n\n**Schema Additions:**\n```typescript\n// Add to tenants table\ntier: text(\"tier\").default(\"TRIAL\"), // TRIAL, TIER_1, TIER_2\ntrialExpiresAt: timestamp(\"trial_expires_at\"),\nsubscriptionExpiresAt: timestamp(\"subscription_expires_at\"),\nmonthlyRevenue: integer(\"monthly_revenue\").default(0),\n```\n\n#### 1.3 Tech Accounts & Limited Access Panel\n**Priority:** HIGH  \n**Effort:** Medium  \n**Dependencies:** RBAC implementation\n\n**Tasks:**\n- [ ] Implement RBAC middleware (admin, tech roles)\n- [ ] Create tech login page/route\n- [ ] Build tech dashboard (limited to user management)\n- [ ] Restrict tech access to: create WiFi users, assign plans\n- [ ] Audit log for tech actions\n\n**Schema Additions:**\n```typescript\n// Permissions for RBAC\nexport const permissions = pgTable(\"permissions\", {\n  id: varchar(\"id\").primaryKey(),\n  role: text(\"role\").notNull(),\n  resource: text(\"resource\").notNull(),\n  actions: text(\"actions\").array().notNull(),\n});\n```\n\n---\n\n### PHASE 2: CUSTOMER EXPERIENCE (Medium-High Priority)\n**Timeline:** 2-3 weeks  \n**Impact:** Customer retention and self-service capabilities\n\n#### 2.1 Enhanced Customer Self-Service Portal\n**Priority:** HIGH  \n**Effort:** High  \n**Dependencies:** None\n\n**Tasks:**\n- [ ] Customer account creation with phone verification\n- [ ] Customer login page (separate from ISP)\n- [ ] View current plan and expiry countdown\n- [ ] Purchase history and receipts\n- [ ] Plan renewal button with M-Pesa\n- [ ] Usage statistics (if available from router)\n\n**New Pages:**\n```\n/customer/login\n/customer/register\n/customer/dashboard\n/customer/history\n/customer/renew\n```\n\n#### 2.2 Voucher System\n**Priority:** HIGH  \n**Effort:** Medium  \n**Dependencies:** None\n\n**Tasks:**\n- [ ] Voucher schema (code, plan, device limit, validity)\n- [ ] Bulk voucher generation UI\n- [ ] Printable voucher format (PDF/thermal)\n- [ ] Voucher redemption on captive portal\n- [ ] Voucher validity and device limit enforcement\n- [ ] Voucher usage tracking\n\n**Schema Additions:**\n```typescript\nexport const vouchers = pgTable(\"vouchers\", {\n  id: varchar(\"id\").primaryKey(),\n  tenantId: varchar(\"tenant_id\").notNull(),\n  planId: varchar(\"plan_id\").notNull(),\n  code: text(\"code\").notNull().unique(),\n  deviceLimit: integer(\"device_limit\").default(1),\n  validFrom: timestamp(\"valid_from\").defaultNow(),\n  validUntil: timestamp(\"valid_until\"),\n  usedAt: timestamp(\"used_at\"),\n  usedByMac: text(\"used_by_mac\"),\n  isActive: boolean(\"is_active\").default(true),\n});\n```\n\n#### 2.3 Interface Customization/White Labeling\n**Priority:** MEDIUM  \n**Effort:** Medium  \n**Dependencies:** None\n\n**Tasks:**\n- [ ] ISP branding settings page (logo upload, colors)\n- [ ] Apply branding to captive portal dynamically\n- [ ] Apply branding to customer portal\n- [ ] Custom subdomain routing logic\n- [ ] Store logo in file storage\n\n---\n\n### PHASE 3: NETWORK & OPERATIONS (Medium Priority)\n**Timeline:** 2-3 weeks  \n**Impact:** Operational efficiency and monitoring\n\n#### 3.1 Real-Time Monitoring Dashboard\n**Priority:** MEDIUM  \n**Effort:** High  \n**Dependencies:** MikroTik API (already implemented)\n\n**Tasks:**\n- [ ] Live bandwidth usage graphs (Recharts integration)\n- [ ] Router status indicators (online/offline)\n- [ ] Active sessions table with refresh\n- [ ] CPU/Memory utilization charts\n- [ ] WebSocket for real-time updates\n\n**New Components:**\n```\nBandwidthChart.tsx\nRouterStatusCard.tsx\nActiveSessionsTable.tsx\nResourceUtilizationGraph.tsx\n```\n\n#### 3.2 Remote Router Management UI\n**Priority:** MEDIUM  \n**Effort:** Low (API exists)  \n**Dependencies:** MikroTik API\n\n**Tasks:**\n- [ ] Router configuration backup button\n- [ ] Remote reboot button with confirmation\n- [ ] Router resource stats cards\n- [ ] Quick action buttons (disconnect user, etc.)\n\n#### 3.3 Hotspot Session Management\n**Priority:** MEDIUM  \n**Effort:** Medium  \n**Dependencies:** RADIUS integration\n\n**Tasks:**\n- [ ] 15-minute inactivity logout (configurable per plan)\n- [ ] Device limit enforcement (RADIUS accounting)\n- [ ] Session time tracking display\n- [ ] Session override for admins\n\n---\n\n### PHASE 4: COMMUNICATION & ENGAGEMENT (Medium Priority)\n**Timeline:** 1-2 weeks  \n**Impact:** Customer engagement and retention\n\n#### 4.1 Bulk SMS Campaigns\n**Priority:** MEDIUM  \n**Effort:** Medium  \n**Dependencies:** SMS Service (exists)\n\n**Tasks:**\n- [ ] SMS campaign creation UI\n- [ ] Recipient selection (all, selected, by plan)\n- [ ] Scheduled messages\n- [ ] SMS template management\n- [ ] Delivery analytics (sent, delivered, failed)\n\n**Schema Additions:**\n```typescript\nexport const smsCampaigns = pgTable(\"sms_campaigns\", {\n  id: varchar(\"id\").primaryKey(),\n  tenantId: varchar(\"tenant_id\").notNull(),\n  name: text(\"name\").notNull(),\n  message: text(\"message\").notNull(),\n  recipientFilter: jsonb(\"recipient_filter\"),\n  scheduledFor: timestamp(\"scheduled_for\"),\n  status: text(\"status\").default(\"DRAFT\"),\n  sentCount: integer(\"sent_count\").default(0),\n  deliveredCount: integer(\"delivered_count\").default(0),\n});\n```\n\n#### 4.2 Automated Notifications Enhancement\n**Priority:** HIGH  \n**Effort:** Low  \n**Dependencies:** SMS Service, Job Queue\n\n**Tasks:**\n- [ ] Payment confirmation SMS trigger\n- [ ] Expiry reminder (24h, 1h before)\n- [ ] Welcome message on first purchase\n- [ ] Service outage notification template\n- [ ] Configurable notification preferences\n\n#### 4.3 Support Chat System\n**Priority:** LOW  \n**Effort:** High  \n**Dependencies:** WebSocket infrastructure\n\n**Tasks:**\n- [ ] Chat schema (conversations, messages)\n- [ ] ISP  Super Admin chat\n- [ ] Customer  ISP chat\n- [ ] Chat history linked to tickets\n- [ ] Real-time message delivery\n\n---\n\n### PHASE 5: VALUE-ADDED FEATURES (Lower Priority)\n**Timeline:** 2-3 weeks  \n**Impact:** Differentiation and additional revenue streams\n\n#### 5.1 Referral Program\n**Priority:** LOW  \n**Effort:** Medium\n\n**Tasks:**\n- [ ] Referral code generation per customer\n- [ ] Voucher rewards configuration\n- [ ] Referral tracking dashboard\n- [ ] Referral leaderboard\n\n#### 5.2 Guest Passes/Trial Periods\n**Priority:** LOW  \n**Effort:** Low\n\n**Tasks:**\n- [ ] Configurable trial duration per ISP\n- [ ] One-time guest access generation\n- [ ] Trial user conversion tracking\n- [ ] Trial expiry notifications\n\n#### 5.3 Compensation Module\n**Priority:** LOW  \n**Effort:** Medium\n\n**Tasks:**\n- [ ] Outage detection (router offline alerts)\n- [ ] Customer compensation credit calculation\n- [ ] Automatic credit application\n- [ ] Compensation report\n\n---\n\n### PHASE 6: ADVANCED FEATURES (Future)\n**Timeline:** 3-4 weeks  \n**Impact:** Enterprise-grade capabilities\n\n#### 6.1 Stock/Inventory Management\n- [ ] Hardware tracking (routers, cables)\n- [ ] POS for hardware sales\n- [ ] Inventory alerts and reorder points\n\n#### 6.2 Advanced Reporting\n- [ ] Unit economics (Churn, LTV calculations)\n- [ ] Income statements\n- [ ] Export to Excel/PDF\n- [ ] Scheduled report emails\n\n#### 6.3 TR-069 Device Management\n- [ ] CPE auto-configuration\n- [ ] Remote device updates\n- [ ] Device provisioning\n\n#### 6.4 Network Topology Mapping\n- [ ] Visual network map\n- [ ] Device discovery\n- [ ] Link status visualization\n\n---\n\n## COMPETITOR FEATURE COMPARISON (Updated)\n\n| Feature | MnetiFi | Netpap | Kivipay | Cute Profit |\n|---------|---------|--------|---------|-------------|\n| M-Pesa Integration |  |  |  |  |\n| Multi-tenant SaaS |  |  |  | ? |\n| MikroTik API |  |  |  |  |\n| PPPoE/Static Billing |  |  |  |  |\n| Hotspot Billing |  |  |  |  |\n| RADIUS CoA |  |  | ? | ? |\n| SMS Notifications |  |  |  |  |\n| Customer Portal |  |  |  |  |\n| Super Admin |  |  |  | ? |\n| Voucher System |  |  |  |  |\n| White Labeling |  |  |  | ? |\n| Bulk SMS |  |  |  |  |\n| Referral Program |  |  | ? | ? |\n| Remote Tunnels |  |  | ? | ? |\n| Real-time Monitoring |  |  |  |  |\n\n**Legend:**  Full |  Partial |  Missing | ? Unknown\n\n---\n\n## RECOMMENDED NEXT STEPS\n\n### Immediate Priority (This Sprint)\n1. **Super Admin Console** - Critical for platform monetization\n2. **Tech Accounts with RBAC** - Competitive feature gap\n3. **Automated SMS Notifications** - Quick win, backend exists\n\n### Short-term (Next 2 Sprints)\n4. **Customer Self-Service Portal** - Major competitive gap\n5. **Voucher System** - High demand feature\n6. **Real-Time Monitoring Dashboard** - Differentiation opportunity\n\n### Medium-term (Next Quarter)\n7. **Bulk SMS Campaigns** - Revenue opportunity for Tier 2\n8. **White Labeling UI** - Enterprise feature\n9. **Compensation Module** - Customer satisfaction\n\n---\n\n## TECHNICAL DEBT & IMPROVEMENTS\n\n1. **Add comprehensive test coverage** - Unit and integration tests\n2. **Implement proper logging** - Structured logging with correlation IDs\n3. **Add rate limiting** - Protect API endpoints\n4. **Implement caching** - Redis for session and frequently accessed data\n5. **Add API documentation** - OpenAPI/Swagger specification\n\n---\n\n## CONCLUSION\n\nMnetiFi has a solid foundation with core billing, network integration, and multi-tenant architecture. The primary gaps are in:\n\n1. **SaaS monetization** (Super Admin, Tiered Billing)\n2. **Customer self-service** (Portal, Vouchers)\n3. **Operational tools** (Real-time monitoring, Bulk SMS)\n\nAddressing Phase 1 and Phase 2 features will bring MnetiFi to competitive parity with Netpap and Kivipay.\n","path":null,"size_bytes":15423,"size_tokens":null},"client/src/layouts/superadmin-layout.tsx":{"content":"import { useEffect } from \"react\";\nimport { useLocation, Link } from \"wouter\";\nimport { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { MeshBackground } from \"@/components/mesh-background\";\nimport { useRequireAuth } from \"@/hooks/use-session\";\nimport { Loader2, Building2, LayoutDashboard, Users, LogOut, Shield, UserCog, MessageSquare } from \"lucide-react\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupLabel,\n  SidebarGroupContent,\n  SidebarMenu,\n  SidebarMenuItem,\n  SidebarMenuButton,\n  SidebarFooter,\n  SidebarHeader,\n} from \"@/components/ui/sidebar\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface SuperAdminLayoutProps {\n  children: React.ReactNode;\n}\n\nconst menuItems = [\n  { title: \"Dashboard\", url: \"/superadmin\", icon: LayoutDashboard },\n  { title: \"Tenants\", url: \"/superadmin/tenants\", icon: Building2 },\n  { title: \"Users\", url: \"/superadmin/users\", icon: UserCog },\n  { title: \"SMS Settings\", url: \"/superadmin/sms-settings\", icon: MessageSquare },\n];\n\nfunction SuperAdminSidebar({ onLogout }: { onLogout: () => void }) {\n  const [location] = useLocation();\n\n  return (\n    <Sidebar>\n      <SidebarHeader className=\"p-4 border-b border-white/10\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"p-2 rounded-lg bg-gradient-to-br from-cyan-500/20 to-purple-500/20\">\n            <Shield size={20} className=\"text-cyan-400\" />\n          </div>\n          <div>\n            <h2 className=\"font-bold text-white\">Super Admin</h2>\n            <p className=\"text-xs text-muted-foreground\">Platform Control</p>\n          </div>\n        </div>\n      </SidebarHeader>\n\n      <SidebarContent>\n        <SidebarGroup>\n          <SidebarGroupLabel>Platform</SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {menuItems.map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton\n                    asChild\n                    data-active={location === item.url}\n                    className=\"data-[active=true]:bg-sidebar-accent\"\n                  >\n                    <Link href={item.url} data-testid={`nav-${item.title.toLowerCase()}`}>\n                      <item.icon size={18} />\n                      <span>{item.title}</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n      </SidebarContent>\n\n      <SidebarFooter className=\"p-4 border-t border-white/10\">\n        <Link href=\"/dashboard\">\n          <Button variant=\"outline\" size=\"sm\" className=\"w-full mb-2\" data-testid=\"button-switch-to-tenant\">\n            <Building2 size={16} className=\"mr-2\" />\n            Tenant Dashboard\n          </Button>\n        </Link>\n        <Button \n          variant=\"ghost\" \n          size=\"sm\" \n          className=\"w-full justify-start text-muted-foreground\" \n          onClick={onLogout}\n          data-testid=\"button-logout\"\n        >\n          <LogOut size={16} className=\"mr-2\" />\n          Logout\n        </Button>\n      </SidebarFooter>\n    </Sidebar>\n  );\n}\n\nexport function SuperAdminLayout({ children }: SuperAdminLayoutProps) {\n  const { user, isLoading } = useRequireAuth();\n  const [, setLocation] = useLocation();\n\n  const style = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  } as React.CSSProperties;\n\n  const handleLogout = () => {\n    localStorage.removeItem(\"admin_session\");\n    setLocation(\"/superadmin/login\");\n  };\n\n  useEffect(() => {\n    if (!isLoading && !user) {\n      setLocation(\"/superadmin/login\");\n    } else if (!isLoading && user && user.role !== \"superadmin\") {\n      setLocation(\"/superadmin/login\");\n    }\n  }, [user, isLoading, setLocation]);\n\n  if (isLoading) {\n    return (\n      <>\n        <MeshBackground />\n        <div className=\"min-h-screen flex items-center justify-center\">\n          <Loader2 className=\"w-8 h-8 animate-spin text-cyan-400\" />\n        </div>\n      </>\n    );\n  }\n\n  if (!user || user.role !== \"superadmin\") {\n    return null;\n  }\n\n  return (\n    <>\n      <MeshBackground />\n      <SidebarProvider style={style}>\n        <div className=\"flex h-screen w-full relative z-10\">\n          <SuperAdminSidebar onLogout={handleLogout} />\n          <div className=\"flex flex-col flex-1 overflow-hidden\">\n            <header className=\"flex items-center gap-4 p-4 border-b border-white/10 bg-background/50 backdrop-blur-sm\">\n              <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n              <div className=\"flex-1\" />\n              <div className=\"flex items-center gap-2\">\n                <Shield size={16} className=\"text-cyan-400\" />\n                <span className=\"text-sm text-muted-foreground\">\n                  {user.username}\n                </span>\n              </div>\n            </header>\n            <main className=\"flex-1 overflow-auto\">\n              {children}\n            </main>\n          </div>\n        </div>\n      </SidebarProvider>\n    </>\n  );\n}\n","path":null,"size_bytes":5101,"size_tokens":null},"client/src/pages/superadmin-dashboard.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { motion } from \"framer-motion\";\nimport { Link } from \"wouter\";\nimport {\n  Building2,\n  Users,\n  DollarSign,\n  TrendingUp,\n  Play,\n  Pause,\n  AlertTriangle,\n  Clock,\n  CheckCircle,\n  Calendar,\n  ArrowRight,\n} from \"lucide-react\";\nimport { MetricCard, MetricCardSkeleton } from \"@/components/metric-card\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { format } from \"date-fns\";\n\ninterface PlatformAnalytics {\n  totalTenants: number;\n  activeTenants: number;\n  trialTenants: number;\n  suspendedTenants: number;\n  totalUsers: number;\n  totalRevenue: number;\n  revenueThisMonth: number;\n  revenueLastMonth: number;\n  transactionsToday: number;\n  newTenantsThisMonth: number;\n}\n\ninterface TenantWithStats {\n  id: string;\n  name: string;\n  subdomain: string;\n  tier: string;\n  isActive: boolean;\n  saasBillingStatus: string;\n  trialExpiresAt: string | null;\n  subscriptionExpiresAt: string | null;\n  createdAt: string;\n  userCount: number;\n  transactionCount: number;\n  revenueThisMonth: number;\n}\n\nexport default function SuperAdminDashboard() {\n  const { data: analytics, isLoading: analyticsLoading } = useQuery<PlatformAnalytics>({\n    queryKey: [\"/api/superadmin/analytics\"],\n  });\n\n  const { data: tenants, isLoading: tenantsLoading } = useQuery<TenantWithStats[]>({\n    queryKey: [\"/api/superadmin/tenants\"],\n  });\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat(\"en-KE\", {\n      style: \"currency\",\n      currency: \"KES\",\n      minimumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  const getRevenueGrowth = () => {\n    if (!analytics?.revenueLastMonth) return 0;\n    return Math.round(\n      ((analytics.revenueThisMonth - analytics.revenueLastMonth) / analytics.revenueLastMonth) * 100\n    );\n  };\n\n  const getStatusBadge = (status: string) => {\n    const statusConfig: Record<string, { bg: string; text: string; label: string }> = {\n      ACTIVE: { bg: \"bg-cyan-500/20\", text: \"text-cyan-400\", label: \"Active\" },\n      TRIAL: { bg: \"bg-purple-500/20\", text: \"text-purple-400\", label: \"Trial\" },\n      SUSPENDED: { bg: \"bg-amber-500/20\", text: \"text-amber-400\", label: \"Suspended\" },\n      BLOCKED: { bg: \"bg-red-500/20\", text: \"text-red-400\", label: \"Blocked\" },\n      PENDING: { bg: \"bg-slate-500/20\", text: \"text-slate-400\", label: \"Pending\" },\n    };\n    const config = statusConfig[status] || statusConfig.PENDING;\n    return (\n      <Badge variant=\"outline\" className={`${config.bg} ${config.text} border-0`}>\n        {config.label}\n      </Badge>\n    );\n  };\n\n  const getTierBadge = (tier: string) => {\n    const tierConfig: Record<string, { bg: string; text: string }> = {\n      TRIAL: { bg: \"bg-purple-500/20\", text: \"text-purple-400\" },\n      TIER_1: { bg: \"bg-cyan-500/20\", text: \"text-cyan-400\" },\n      TIER_2: { bg: \"bg-pink-500/20\", text: \"text-pink-400\" },\n    };\n    const config = tierConfig[tier] || tierConfig.TRIAL;\n    return (\n      <Badge variant=\"outline\" className={`${config.bg} ${config.text} border-0`}>\n        {tier.replace(\"_\", \" \")}\n      </Badge>\n    );\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"superadmin-dashboard-page\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">Platform Overview</h1>\n          <p className=\"text-muted-foreground\">\n            Monitor and manage all tenants across the platform.\n          </p>\n        </div>\n        <Link href=\"/superadmin/tenants\">\n          <Button data-testid=\"button-manage-tenants\">\n            Manage Tenants\n            <ArrowRight size={16} className=\"ml-2\" />\n          </Button>\n        </Link>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4\">\n        {analyticsLoading ? (\n          <>\n            <MetricCardSkeleton />\n            <MetricCardSkeleton />\n            <MetricCardSkeleton />\n            <MetricCardSkeleton />\n            <MetricCardSkeleton />\n          </>\n        ) : (\n          <>\n            <MetricCard\n              title=\"Total Tenants\"\n              value={analytics?.totalTenants || 0}\n              icon={<Building2 size={24} />}\n              gradient=\"primary\"\n            />\n            <MetricCard\n              title=\"Platform Revenue\"\n              value={formatCurrency(analytics?.totalRevenue || 0)}\n              icon={<DollarSign size={24} />}\n              trend={getRevenueGrowth() !== 0 ? { value: getRevenueGrowth(), label: \"vs last month\" } : undefined}\n              gradient=\"mpesa\"\n            />\n            <MetricCard\n              title=\"This Month\"\n              value={formatCurrency(analytics?.revenueThisMonth || 0)}\n              icon={<TrendingUp size={24} />}\n            />\n            <MetricCard\n              title=\"Total Users\"\n              value={analytics?.totalUsers || 0}\n              icon={<Users size={24} />}\n              gradient=\"accent\"\n            />\n            <MetricCard\n              title=\"Today's Transactions\"\n              value={analytics?.transactionsToday || 0}\n              icon={<Calendar size={24} />}\n            />\n          </>\n        )}\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <motion.div\n          className=\"flex items-center gap-4 p-4 rounded-xl bg-cyan-500/10 border border-cyan-500/20\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.1 }}\n          data-testid=\"status-active-tenants\"\n        >\n          <div className=\"p-3 rounded-full bg-cyan-500/20\">\n            <CheckCircle size={24} className=\"text-cyan-400\" />\n          </div>\n          <div>\n            <p className=\"text-sm text-muted-foreground\">Active</p>\n            <p className=\"text-2xl font-bold text-white\">\n              {analytics?.activeTenants || 0}\n            </p>\n          </div>\n        </motion.div>\n\n        <motion.div\n          className=\"flex items-center gap-4 p-4 rounded-xl bg-purple-500/10 border border-purple-500/20\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.2 }}\n          data-testid=\"status-trial-tenants\"\n        >\n          <div className=\"p-3 rounded-full bg-purple-500/20\">\n            <Clock size={24} className=\"text-purple-400\" />\n          </div>\n          <div>\n            <p className=\"text-sm text-muted-foreground\">On Trial</p>\n            <p className=\"text-2xl font-bold text-white\">\n              {analytics?.trialTenants || 0}\n            </p>\n          </div>\n        </motion.div>\n\n        <motion.div\n          className=\"flex items-center gap-4 p-4 rounded-xl bg-amber-500/10 border border-amber-500/20\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.3 }}\n          data-testid=\"status-suspended-tenants\"\n        >\n          <div className=\"p-3 rounded-full bg-amber-500/20\">\n            <Pause size={24} className=\"text-amber-400\" />\n          </div>\n          <div>\n            <p className=\"text-sm text-muted-foreground\">Suspended</p>\n            <p className=\"text-2xl font-bold text-white\">\n              {analytics?.suspendedTenants || 0}\n            </p>\n          </div>\n        </motion.div>\n\n        <motion.div\n          className=\"flex items-center gap-4 p-4 rounded-xl bg-green-500/10 border border-green-500/20\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.4 }}\n          data-testid=\"status-new-tenants\"\n        >\n          <div className=\"p-3 rounded-full bg-green-500/20\">\n            <Play size={24} className=\"text-green-400\" />\n          </div>\n          <div>\n            <p className=\"text-sm text-muted-foreground\">New This Month</p>\n            <p className=\"text-2xl font-bold text-white\">\n              {analytics?.newTenantsThisMonth || 0}\n            </p>\n          </div>\n        </motion.div>\n      </div>\n\n      <GlassPanel size=\"md\">\n        <div className=\"flex items-center justify-between mb-4 gap-4 flex-wrap\">\n          <h2 className=\"text-lg font-semibold text-white\">Recent Tenants</h2>\n          <Link\n            href=\"/superadmin/tenants\"\n            className=\"text-sm text-cyan-400 hover:text-cyan-300 transition-colors\"\n            data-testid=\"link-view-all-tenants\"\n          >\n            View All\n          </Link>\n        </div>\n\n        {tenantsLoading ? (\n          <div className=\"space-y-3\">\n            {[1, 2, 3, 4, 5].map((i) => (\n              <div key={i} className=\"animate-pulse flex items-center gap-4 p-4 rounded-lg bg-white/5\">\n                <div className=\"w-10 h-10 rounded-full bg-white/10\" />\n                <div className=\"flex-1 space-y-2\">\n                  <div className=\"h-4 bg-white/10 rounded w-1/3\" />\n                  <div className=\"h-3 bg-white/10 rounded w-1/4\" />\n                </div>\n                <div className=\"h-6 w-16 bg-white/10 rounded\" />\n              </div>\n            ))}\n          </div>\n        ) : tenants && tenants.length > 0 ? (\n          <div className=\"space-y-3\">\n            {tenants.slice(0, 5).map((tenant) => (\n              <motion.div\n                key={tenant.id}\n                initial={{ opacity: 0, x: -10 }}\n                animate={{ opacity: 1, x: 0 }}\n                className=\"flex items-center gap-4 p-4 rounded-lg border bg-white/5 border-white/10\"\n                data-testid={`tenant-row-${tenant.id}`}\n              >\n                <div className=\"w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500/20 to-purple-500/20 flex items-center justify-center\">\n                  <Building2 size={18} className=\"text-cyan-400\" />\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"font-medium text-white truncate\">{tenant.name}</p>\n                  <p className=\"text-xs text-muted-foreground\">{tenant.subdomain}</p>\n                </div>\n                <div className=\"flex items-center gap-2 flex-wrap justify-end\">\n                  {getTierBadge(tenant.tier)}\n                  {getStatusBadge(tenant.saasBillingStatus)}\n                </div>\n                <div className=\"text-right hidden sm:block\">\n                  <p className=\"text-sm font-medium text-white\">\n                    {formatCurrency(tenant.revenueThisMonth)}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {tenant.userCount} users\n                  </p>\n                </div>\n              </motion.div>\n            ))}\n          </div>\n        ) : (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            <Building2 size={48} className=\"mx-auto mb-4 opacity-50\" />\n            <p>No tenants found</p>\n          </div>\n        )}\n      </GlassPanel>\n    </div>\n  );\n}\n","path":null,"size_bytes":11039,"size_tokens":null},"client/src/pages/superadmin-forgot-password.tsx":{"content":"import { useState } from \"react\";\nimport { Link } from \"wouter\";\nimport { motion } from \"framer-motion\";\nimport { Mail, Loader2, ArrowRight, ArrowLeft, Check, KeyRound, ShieldCheck } from \"lucide-react\";\nimport { MeshBackground } from \"@/components/mesh-background\";\nimport { MnetiFiLogo } from \"@/components/mnetifi-logo\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function SuperAdminForgotPasswordPage() {\n  const { toast } = useToast();\n  const [step, setStep] = useState<'request' | 'sent'>('request');\n  const [isLoading, setIsLoading] = useState(false);\n  const [email, setEmail] = useState(\"\");\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!email.trim()) {\n      toast({\n        title: \"Email required\",\n        description: \"Please enter your email address\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) {\n      toast({\n        title: \"Invalid email\",\n        description: \"Please enter a valid email address\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsLoading(true);\n\n    try {\n      const response = await fetch(\"/api/auth/forgot-password\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ email }),\n      });\n\n      const data = await response.json();\n\n      if (response.ok) {\n        setStep('sent');\n        toast({\n          title: \"Reset link sent\",\n          description: \"Check your email for password reset instructions\",\n        });\n      } else {\n        toast({\n          title: \"Request Failed\",\n          description: data.error || \"Unable to process request\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      toast({\n        title: \"Request Failed\",\n        description: \"Unable to connect to server\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <>\n      <MeshBackground />\n      <div className=\"min-h-screen flex items-center justify-center p-4 relative z-10\">\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.5 }}\n          className=\"w-full max-w-md\"\n        >\n          <GlassPanel size=\"lg\" className=\"text-center\">\n            <div className=\"mb-8\">\n              <MnetiFiLogo size=\"lg\" className=\"mx-auto mb-4\" />\n              <div className=\"flex items-center justify-center gap-2 mb-2\">\n                <Badge variant=\"outline\" className=\"bg-pink-500/20 text-pink-400 border-0\">\n                  <ShieldCheck size={12} className=\"mr-1\" />\n                  Platform Administration\n                </Badge>\n              </div>\n              <h1 className=\"text-2xl font-bold text-white mb-2\">\n                {step === 'request' ? 'Super Admin Password Reset' : 'Check Your Email'}\n              </h1>\n              <p className=\"text-muted-foreground\">\n                {step === 'request' \n                  ? 'Enter your Super Admin email to receive a reset link' \n                  : 'We sent you password reset instructions'}\n              </p>\n            </div>\n\n            {step === 'request' ? (\n              <form onSubmit={handleSubmit} className=\"space-y-4\">\n                <GlassInput\n                  label=\"Email Address\"\n                  type=\"email\"\n                  placeholder=\"Enter your Super Admin email\"\n                  value={email}\n                  onChange={(e) => setEmail(e.target.value)}\n                  required\n                  icon={<Mail size={16} />}\n                  data-testid=\"input-superadmin-email\"\n                />\n\n                <Button\n                  type=\"submit\"\n                  className=\"w-full bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700\"\n                  disabled={isLoading}\n                  data-testid=\"button-send-reset\"\n                >\n                  {isLoading ? (\n                    <>\n                      <Loader2 size={18} className=\"mr-2 animate-spin\" />\n                      Sending...\n                    </>\n                  ) : (\n                    <>\n                      Send Reset Link\n                      <ArrowRight size={18} className=\"ml-2\" />\n                    </>\n                  )}\n                </Button>\n              </form>\n            ) : (\n              <div className=\"space-y-6\">\n                <div className=\"w-16 h-16 mx-auto rounded-full bg-pink-500/20 flex items-center justify-center\">\n                  <Check size={32} className=\"text-pink-400\" />\n                </div>\n                \n                <div className=\"space-y-2\">\n                  <p className=\"text-white/80\">\n                    We sent a password reset link to:\n                  </p>\n                  <p className=\"text-pink-400 font-medium\">\n                    {email}\n                  </p>\n                </div>\n\n                <div className=\"p-4 rounded-lg bg-white/5 text-left\">\n                  <p className=\"text-sm text-muted-foreground\">\n                    <KeyRound size={14} className=\"inline mr-2\" />\n                    The link will expire in 1 hour. If you don't see the email, check your spam folder.\n                  </p>\n                </div>\n\n                <Button\n                  onClick={() => { setStep('request'); setEmail(''); }}\n                  variant=\"outline\"\n                  className=\"w-full border-pink-500/30 text-pink-400 hover:bg-pink-500/10\"\n                  data-testid=\"button-try-again\"\n                >\n                  <ArrowLeft size={18} className=\"mr-2\" />\n                  Try a different email\n                </Button>\n              </div>\n            )}\n\n            <div className=\"mt-6 pt-6 border-t border-white/10\">\n              <p className=\"text-sm text-muted-foreground\">\n                Remember your password?{\" \"}\n                <Link \n                  href=\"/superadmin/login\" \n                  className=\"text-pink-400 hover:text-pink-300 transition-colors font-medium\"\n                  data-testid=\"link-superadmin-login\"\n                >\n                  Back to Super Admin login\n                </Link>\n              </p>\n            </div>\n\n            <div className=\"mt-4 pt-4 border-t border-white/10\">\n              <p className=\"text-xs text-muted-foreground\">\n                ISP Administrator?{\" \"}\n                <Link \n                  href=\"/forgot-password\" \n                  className=\"text-cyan-400 hover:text-cyan-300 transition-colors font-medium\"\n                >\n                  ISP Password Reset\n                </Link>\n              </p>\n            </div>\n          </GlassPanel>\n        </motion.div>\n      </div>\n    </>\n  );\n}\n","path":null,"size_bytes":7061,"size_tokens":null},"client/src/pages/superadmin-users.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { motion } from \"framer-motion\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useForm } from \"react-hook-form\";\nimport { z } from \"zod\";\nimport {\n  UserPlus,\n  Users,\n  Shield,\n  ShieldCheck,\n  Wrench,\n  MoreVertical,\n  Trash2,\n  Power,\n  PowerOff,\n  Mail,\n  Calendar,\n} from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n  DropdownMenuSeparator,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Form,\n  FormControl,\n  FormDescription,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { format } from \"date-fns\";\n\ninterface AdminUser {\n  id: string;\n  username: string;\n  email: string | null;\n  role: string;\n  isActive: boolean;\n  tenantId: string | null;\n  createdAt: string;\n  tenantName?: string;\n}\n\nconst createUserSchema = z.object({\n  username: z.string().min(3, \"Username must be at least 3 characters\"),\n  email: z.string().email(\"Invalid email address\"),\n  password: z.string().min(6, \"Password must be at least 6 characters\"),\n  role: z.enum([\"superadmin\", \"admin\", \"tech\"]),\n});\n\ntype CreateUserForm = z.infer<typeof createUserSchema>;\n\nexport default function SuperAdminUsersPage() {\n  const [isCreateOpen, setIsCreateOpen] = useState(false);\n  const { toast } = useToast();\n\n  const form = useForm<CreateUserForm>({\n    resolver: zodResolver(createUserSchema),\n    defaultValues: {\n      username: \"\",\n      email: \"\",\n      password: \"\",\n      role: \"superadmin\",\n    },\n  });\n\n  const { data: users, isLoading } = useQuery<AdminUser[]>({\n    queryKey: [\"/api/superadmin/users\"],\n  });\n\n  const createUserMutation = useMutation({\n    mutationFn: async (data: CreateUserForm) => {\n      return apiRequest(\"POST\", \"/api/superadmin/create-superadmin\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/superadmin/users\"] });\n      setIsCreateOpen(false);\n      form.reset();\n      toast({\n        title: \"User Created\",\n        description: \"The admin user has been created successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Creation Failed\",\n        description: error.message || \"Failed to create user\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const toggleUserMutation = useMutation({\n    mutationFn: async ({ id, isActive }: { id: string; isActive: boolean }) => {\n      return apiRequest(\"PATCH\", `/api/superadmin/users/${id}/status`, { isActive });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/superadmin/users\"] });\n      toast({\n        title: \"User Updated\",\n        description: \"The user status has been updated.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Update Failed\",\n        description: error.message || \"Failed to update user\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteUserMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/superadmin/users/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/superadmin/users\"] });\n      toast({\n        title: \"User Deleted\",\n        description: \"The user has been removed.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Delete Failed\",\n        description: error.message || \"Failed to delete user\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const getRoleIcon = (role: string) => {\n    switch (role) {\n      case \"superadmin\":\n        return <ShieldCheck size={16} className=\"text-pink-400\" />;\n      case \"admin\":\n        return <Shield size={16} className=\"text-cyan-400\" />;\n      case \"tech\":\n        return <Wrench size={16} className=\"text-amber-400\" />;\n      default:\n        return <Users size={16} />;\n    }\n  };\n\n  const getRoleBadge = (role: string) => {\n    const roleConfig: Record<string, { bg: string; text: string; label: string }> = {\n      superadmin: { bg: \"bg-pink-500/20\", text: \"text-pink-400\", label: \"Super Admin\" },\n      admin: { bg: \"bg-cyan-500/20\", text: \"text-cyan-400\", label: \"Admin\" },\n      tech: { bg: \"bg-amber-500/20\", text: \"text-amber-400\", label: \"Technician\" },\n    };\n    const config = roleConfig[role] || roleConfig.admin;\n    return (\n      <Badge variant=\"outline\" className={`${config.bg} ${config.text} border-0`}>\n        {config.label}\n      </Badge>\n    );\n  };\n\n  const onSubmit = (data: CreateUserForm) => {\n    createUserMutation.mutate(data);\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"superadmin-users-page\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">User Management</h1>\n          <p className=\"text-muted-foreground\">\n            Create and manage platform administrators and sub-admins.\n          </p>\n        </div>\n\n        <Dialog open={isCreateOpen} onOpenChange={setIsCreateOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-user\">\n              <UserPlus size={16} className=\"mr-2\" />\n              Create Admin\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"sm:max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Create Admin User</DialogTitle>\n              <DialogDescription>\n                Add a new administrator or technician to the platform.\n              </DialogDescription>\n            </DialogHeader>\n\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"username\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Username</FormLabel>\n                      <FormControl>\n                        <Input\n                          placeholder=\"johndoe\"\n                          {...field}\n                          data-testid=\"input-username\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"email\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Email</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"email\"\n                          placeholder=\"john@example.com\"\n                          {...field}\n                          data-testid=\"input-email\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"password\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Password</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"password\"\n                          placeholder=\"Minimum 6 characters\"\n                          {...field}\n                          data-testid=\"input-password\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"role\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Role</FormLabel>\n                      <Select onValueChange={field.onChange} defaultValue={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-role\">\n                            <SelectValue placeholder=\"Select a role\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"superadmin\">\n                            <div className=\"flex items-center gap-2\">\n                              <ShieldCheck size={14} className=\"text-pink-400\" />\n                              Super Admin\n                            </div>\n                          </SelectItem>\n                          <SelectItem value=\"admin\">\n                            <div className=\"flex items-center gap-2\">\n                              <Shield size={14} className=\"text-cyan-400\" />\n                              Admin\n                            </div>\n                          </SelectItem>\n                          <SelectItem value=\"tech\">\n                            <div className=\"flex items-center gap-2\">\n                              <Wrench size={14} className=\"text-amber-400\" />\n                              Technician\n                            </div>\n                          </SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormDescription>\n                        Super Admins can manage the entire platform. Admins manage their tenant. Technicians have limited access.\n                      </FormDescription>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <DialogFooter>\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={() => setIsCreateOpen(false)}\n                    data-testid=\"button-cancel\"\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    type=\"submit\"\n                    disabled={createUserMutation.isPending}\n                    data-testid=\"button-submit\"\n                  >\n                    {createUserMutation.isPending ? \"Creating...\" : \"Create User\"}\n                  </Button>\n                </DialogFooter>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <GlassPanel size=\"md\">\n        {isLoading ? (\n          <div className=\"space-y-4\">\n            {[1, 2, 3].map((i) => (\n              <div key={i} className=\"animate-pulse flex items-center gap-4 p-4 rounded-lg bg-white/5\">\n                <div className=\"w-10 h-10 rounded-full bg-white/10\" />\n                <div className=\"flex-1 space-y-2\">\n                  <div className=\"h-4 bg-white/10 rounded w-1/4\" />\n                  <div className=\"h-3 bg-white/10 rounded w-1/6\" />\n                </div>\n                <div className=\"h-6 w-20 bg-white/10 rounded\" />\n              </div>\n            ))}\n          </div>\n        ) : users && users.length > 0 ? (\n          <div className=\"space-y-3\">\n            {users.map((user, index) => (\n              <motion.div\n                key={user.id}\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: index * 0.05 }}\n                className={`flex items-center gap-4 p-4 rounded-lg border ${\n                  user.isActive\n                    ? \"bg-white/5 border-white/10\"\n                    : \"bg-red-500/5 border-red-500/20\"\n                }`}\n                data-testid={`user-row-${user.id}`}\n              >\n                <div className=\"w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500/20 to-purple-500/20 flex items-center justify-center flex-shrink-0\">\n                  {getRoleIcon(user.role)}\n                </div>\n\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-center gap-2 flex-wrap\">\n                    <p className=\"font-semibold text-white\">{user.username}</p>\n                    {getRoleBadge(user.role)}\n                    {!user.isActive && (\n                      <Badge variant=\"outline\" className=\"bg-red-500/20 text-red-400 border-0\">\n                        Disabled\n                      </Badge>\n                    )}\n                  </div>\n                  {user.email && (\n                    <div className=\"flex items-center gap-1 text-sm text-muted-foreground\">\n                      <Mail size={12} />\n                      <span>{user.email}</span>\n                    </div>\n                  )}\n                </div>\n\n                <div className=\"hidden md:flex items-center gap-4\">\n                  {user.tenantName && (\n                    <div className=\"text-center\">\n                      <p className=\"text-xs text-muted-foreground\">Tenant</p>\n                      <p className=\"text-sm text-white\">{user.tenantName}</p>\n                    </div>\n                  )}\n                  <div className=\"text-center\">\n                    <div className=\"flex items-center gap-1 text-muted-foreground\">\n                      <Calendar size={14} />\n                      <span className=\"text-xs\">Created</span>\n                    </div>\n                    <p className=\"text-sm text-white\">\n                      {format(new Date(user.createdAt), \"MMM d, yyyy\")}\n                    </p>\n                  </div>\n                </div>\n\n                <DropdownMenu>\n                  <DropdownMenuTrigger asChild>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      data-testid={`button-user-actions-${user.id}`}\n                    >\n                      <MoreVertical size={18} />\n                    </Button>\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent align=\"end\">\n                    {user.isActive ? (\n                      <DropdownMenuItem\n                        onClick={() =>\n                          toggleUserMutation.mutate({ id: user.id, isActive: false })\n                        }\n                        data-testid={`action-disable-${user.id}`}\n                      >\n                        <PowerOff size={16} className=\"mr-2 text-amber-400\" />\n                        Disable User\n                      </DropdownMenuItem>\n                    ) : (\n                      <DropdownMenuItem\n                        onClick={() =>\n                          toggleUserMutation.mutate({ id: user.id, isActive: true })\n                        }\n                        data-testid={`action-enable-${user.id}`}\n                      >\n                        <Power size={16} className=\"mr-2 text-cyan-400\" />\n                        Enable User\n                      </DropdownMenuItem>\n                    )}\n                    <DropdownMenuSeparator />\n                    <DropdownMenuItem\n                      onClick={() => deleteUserMutation.mutate(user.id)}\n                      className=\"text-red-400 focus:text-red-400\"\n                      data-testid={`action-delete-${user.id}`}\n                    >\n                      <Trash2 size={16} className=\"mr-2\" />\n                      Delete User\n                    </DropdownMenuItem>\n                  </DropdownMenuContent>\n                </DropdownMenu>\n              </motion.div>\n            ))}\n          </div>\n        ) : (\n          <div className=\"text-center py-12 text-muted-foreground\">\n            <Users size={48} className=\"mx-auto mb-4 opacity-50\" />\n            <p>No admin users found</p>\n            <p className=\"text-sm mt-1\">Create your first admin user to get started</p>\n          </div>\n        )}\n      </GlassPanel>\n    </div>\n  );\n}\n","path":null,"size_bytes":16380,"size_tokens":null},"client/src/pages/superadmin-login.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { motion } from \"framer-motion\";\nimport { User, Lock, Loader2, ArrowRight, ShieldCheck } from \"lucide-react\";\nimport { MeshBackground } from \"@/components/mesh-background\";\nimport { MnetiFiLogo } from \"@/components/mnetifi-logo\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Link } from \"wouter\";\n\nexport default function SuperAdminLoginPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [username, setUsername] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n\n  useEffect(() => {\n    const session = localStorage.getItem(\"admin_session\");\n    if (session) {\n      try {\n        const sessionData = JSON.parse(session);\n        const lastActivity = new Date(sessionData.lastActivity).getTime();\n        const now = Date.now();\n        const tenMinutes = 10 * 60 * 1000;\n        \n        if (now - lastActivity < tenMinutes && sessionData.user?.role === \"superadmin\") {\n          setLocation(\"/superadmin\");\n        } else {\n          localStorage.removeItem(\"admin_session\");\n        }\n      } catch {\n        localStorage.removeItem(\"admin_session\");\n      }\n    }\n  }, [setLocation]);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsLoading(true);\n\n    try {\n      const response = await fetch(\"/api/auth/login\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ username, password }),\n      });\n\n      const data = await response.json();\n\n      if (response.ok) {\n        if (data.user.role !== \"superadmin\") {\n          toast({\n            title: \"Access Denied\",\n            description: \"This login is for Super Admins only. Please use the ISP login.\",\n            variant: \"destructive\",\n          });\n          return;\n        }\n\n        localStorage.setItem(\"admin_session\", JSON.stringify({\n          user: data.user,\n          lastActivity: new Date().toISOString(),\n        }));\n        toast({\n          title: \"Welcome, Super Admin!\",\n          description: `Logged in as ${data.user.username}`,\n        });\n        setLocation(\"/superadmin\");\n      } else {\n        toast({\n          title: \"Login Failed\",\n          description: data.error || \"Invalid credentials\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      toast({\n        title: \"Login Failed\",\n        description: \"Unable to connect to server\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <>\n      <MeshBackground />\n      <div className=\"min-h-screen flex items-center justify-center p-4 relative z-10\">\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.5 }}\n          className=\"w-full max-w-md\"\n        >\n          <GlassPanel size=\"lg\" className=\"text-center\">\n            <div className=\"mb-8\">\n              <MnetiFiLogo size=\"lg\" className=\"mx-auto mb-4\" />\n              <div className=\"flex items-center justify-center gap-2 mb-2\">\n                <Badge variant=\"outline\" className=\"bg-pink-500/20 text-pink-400 border-0\">\n                  <ShieldCheck size={12} className=\"mr-1\" />\n                  Platform Administration\n                </Badge>\n              </div>\n              <h1 className=\"text-2xl font-bold text-white mb-2\">Super Admin Login</h1>\n              <p className=\"text-muted-foreground\">\n                Sign in to manage the MnetiFi platform\n              </p>\n            </div>\n\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <GlassInput\n                label=\"Username\"\n                placeholder=\"Enter your admin username\"\n                value={username}\n                onChange={(e) => setUsername(e.target.value)}\n                required\n                icon={<User size={16} />}\n                data-testid=\"input-superadmin-username\"\n              />\n\n              <GlassInput\n                label=\"Password\"\n                type=\"password\"\n                placeholder=\"Enter your password\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                required\n                icon={<Lock size={16} />}\n                data-testid=\"input-superadmin-password\"\n              />\n\n              <Button\n                type=\"submit\"\n                className=\"w-full bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700\"\n                disabled={isLoading}\n                data-testid=\"button-superadmin-login\"\n              >\n                {isLoading ? (\n                  <>\n                    <Loader2 size={18} className=\"mr-2 animate-spin\" />\n                    Authenticating...\n                  </>\n                ) : (\n                  <>\n                    Access Platform Console\n                    <ArrowRight size={18} className=\"ml-2\" />\n                  </>\n                )}\n              </Button>\n            </form>\n\n            <div className=\"mt-4 text-center space-y-2\">\n              <Link \n                href=\"/superadmin/forgot-password\" \n                className=\"text-sm text-pink-400 hover:text-pink-300 transition-colors block\"\n                data-testid=\"link-superadmin-forgot-password\"\n              >\n                Forgot your password?\n              </Link>\n              <Link \n                href=\"/superadmin/register\" \n                className=\"text-sm text-purple-400 hover:text-purple-300 transition-colors block\"\n                data-testid=\"link-superadmin-register\"\n              >\n                Register as Super Admin\n              </Link>\n            </div>\n\n            <div className=\"mt-6 pt-6 border-t border-white/10\">\n              <p className=\"text-sm text-muted-foreground\">\n                ISP Administrator?{\" \"}\n                <Link \n                  href=\"/login\" \n                  className=\"text-cyan-400 hover:text-cyan-300 transition-colors font-medium\"\n                  data-testid=\"link-isp-login\"\n                >\n                  Go to ISP Login\n                </Link>\n              </p>\n            </div>\n\n            <div className=\"mt-4 p-3 rounded-lg bg-pink-500/10 border border-pink-500/20 text-left\">\n              <p className=\"text-xs text-pink-200/80\">\n                <ShieldCheck size={14} className=\"inline mr-1\" />\n                This portal is for MnetiFi platform administrators only. Unauthorized access attempts are logged.\n              </p>\n            </div>\n          </GlassPanel>\n        </motion.div>\n      </div>\n    </>\n  );\n}\n","path":null,"size_bytes":6997,"size_tokens":null},"client/src/pages/superadmin-tenant-details.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useRoute, Link } from \"wouter\";\nimport { motion } from \"framer-motion\";\nimport { format } from \"date-fns\";\nimport {\n  Building2,\n  ArrowLeft,\n  Users,\n  DollarSign,\n  Calendar,\n  Clock,\n  CheckCircle,\n  Pause,\n  Ban,\n  Power,\n  RefreshCw,\n  Wifi,\n  Router,\n  CreditCard,\n  Activity,\n  TrendingUp,\n} from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { MetricCard, MetricCardSkeleton } from \"@/components/metric-card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\ninterface TenantDetails {\n  id: string;\n  name: string;\n  subdomain: string;\n  email: string | null;\n  phone: string | null;\n  tier: string;\n  isActive: boolean;\n  saasBillingStatus: string;\n  trialExpiresAt: string | null;\n  subscriptionExpiresAt: string | null;\n  monthlyRevenue: number;\n  totalUsers: number;\n  createdAt: string;\n  userCount: number;\n  transactionCount: number;\n  hotspotCount: number;\n  planCount: number;\n  revenueThisMonth: number;\n  revenueLastMonth: number;\n}\n\nexport default function SuperAdminTenantDetailsPage() {\n  const [, params] = useRoute(\"/superadmin/tenants/:id\");\n  const tenantId = params?.id;\n  const { toast } = useToast();\n\n  const { data: tenant, isLoading } = useQuery<TenantDetails>({\n    queryKey: [\"/api/superadmin/tenants\", tenantId],\n    enabled: !!tenantId,\n  });\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async ({ isActive, saasBillingStatus }: { isActive?: boolean; saasBillingStatus?: string }) => {\n      return apiRequest(\"PATCH\", `/api/superadmin/tenants/${tenantId}/status`, {\n        isActive,\n        saasBillingStatus,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/superadmin/tenants\", tenantId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/superadmin/tenants\"] });\n      toast({ title: \"Tenant Updated\", description: \"Status has been updated successfully.\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Update Failed\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateTierMutation = useMutation({\n    mutationFn: async (tier: string) => {\n      return apiRequest(\"PATCH\", `/api/superadmin/tenants/${tenantId}/subscription`, { tier });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/superadmin/tenants\", tenantId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/superadmin/tenants\"] });\n      toast({ title: \"Tier Updated\", description: \"Subscription tier has been updated.\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Update Failed\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat(\"en-KE\", {\n      style: \"currency\",\n      currency: \"KES\",\n      minimumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  const getStatusBadge = (status: string) => {\n    const config: Record<string, { bg: string; text: string; label: string }> = {\n      ACTIVE: { bg: \"bg-cyan-500/20\", text: \"text-cyan-400\", label: \"Active\" },\n      TRIAL: { bg: \"bg-purple-500/20\", text: \"text-purple-400\", label: \"Trial\" },\n      SUSPENDED: { bg: \"bg-amber-500/20\", text: \"text-amber-400\", label: \"Suspended\" },\n      BLOCKED: { bg: \"bg-red-500/20\", text: \"text-red-400\", label: \"Blocked\" },\n    };\n    const c = config[status] || config.TRIAL;\n    return <Badge variant=\"outline\" className={`${c.bg} ${c.text} border-0`}>{c.label}</Badge>;\n  };\n\n  const getTierBadge = (tier: string) => {\n    const config: Record<string, { bg: string; text: string }> = {\n      TRIAL: { bg: \"bg-purple-500/20\", text: \"text-purple-400\" },\n      TIER_1: { bg: \"bg-cyan-500/20\", text: \"text-cyan-400\" },\n      TIER_2: { bg: \"bg-pink-500/20\", text: \"text-pink-400\" },\n    };\n    const c = config[tier] || config.TRIAL;\n    return <Badge variant=\"outline\" className={`${c.bg} ${c.text} border-0`}>{tier.replace(\"_\", \" \")}</Badge>;\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <div className=\"animate-pulse h-8 w-64 bg-white/10 rounded\" />\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <MetricCardSkeleton />\n          <MetricCardSkeleton />\n          <MetricCardSkeleton />\n          <MetricCardSkeleton />\n        </div>\n      </div>\n    );\n  }\n\n  if (!tenant) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"text-center py-12\">\n          <Building2 size={48} className=\"mx-auto mb-4 opacity-50 text-muted-foreground\" />\n          <p className=\"text-muted-foreground\">Tenant not found</p>\n          <Link href=\"/superadmin/tenants\">\n            <Button variant=\"outline\" className=\"mt-4\">Back to Tenants</Button>\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  const revenueGrowth = tenant.revenueLastMonth > 0\n    ? Math.round(((tenant.revenueThisMonth - tenant.revenueLastMonth) / tenant.revenueLastMonth) * 100)\n    : 0;\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"tenant-details-page\">\n      <div className=\"flex items-center gap-4 flex-wrap\">\n        <Link href=\"/superadmin/tenants\">\n          <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-back\">\n            <ArrowLeft size={18} />\n          </Button>\n        </Link>\n        <div className=\"flex-1\">\n          <div className=\"flex items-center gap-3 flex-wrap\">\n            <h1 className=\"text-2xl font-bold text-white\">{tenant.name}</h1>\n            {getTierBadge(tenant.tier)}\n            {getStatusBadge(tenant.saasBillingStatus)}\n          </div>\n          <p className=\"text-muted-foreground\">{tenant.subdomain}</p>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <MetricCard\n          title=\"WiFi Users\"\n          value={tenant.userCount}\n          icon={<Users size={24} />}\n          gradient=\"primary\"\n        />\n        <MetricCard\n          title=\"This Month Revenue\"\n          value={formatCurrency(tenant.revenueThisMonth)}\n          icon={<DollarSign size={24} />}\n          trend={revenueGrowth !== 0 ? { value: revenueGrowth, label: \"vs last month\" } : undefined}\n          gradient=\"mpesa\"\n        />\n        <MetricCard\n          title=\"Transactions\"\n          value={tenant.transactionCount}\n          icon={<CreditCard size={24} />}\n        />\n        <MetricCard\n          title=\"Hotspots\"\n          value={tenant.hotspotCount}\n          icon={<Router size={24} />}\n          gradient=\"accent\"\n        />\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <GlassPanel size=\"md\">\n          <h2 className=\"text-lg font-semibold text-white mb-4\">Tenant Information</h2>\n          <div className=\"space-y-4\">\n            <div className=\"flex justify-between gap-4\">\n              <span className=\"text-muted-foreground\">Email</span>\n              <span className=\"text-white\">{tenant.email || \"Not set\"}</span>\n            </div>\n            <div className=\"flex justify-between gap-4\">\n              <span className=\"text-muted-foreground\">Phone</span>\n              <span className=\"text-white\">{tenant.phone || \"Not set\"}</span>\n            </div>\n            <div className=\"flex justify-between gap-4\">\n              <span className=\"text-muted-foreground\">Created</span>\n              <span className=\"text-white\">{format(new Date(tenant.createdAt), \"PPP\")}</span>\n            </div>\n            <div className=\"flex justify-between gap-4\">\n              <span className=\"text-muted-foreground\">Active Plans</span>\n              <span className=\"text-white\">{tenant.planCount}</span>\n            </div>\n            {tenant.trialExpiresAt && (\n              <div className=\"flex justify-between gap-4\">\n                <span className=\"text-muted-foreground\">Trial Expires</span>\n                <span className=\"text-amber-400\">{format(new Date(tenant.trialExpiresAt), \"PPP\")}</span>\n              </div>\n            )}\n            {tenant.subscriptionExpiresAt && (\n              <div className=\"flex justify-between gap-4\">\n                <span className=\"text-muted-foreground\">Subscription Expires</span>\n                <span className=\"text-white\">{format(new Date(tenant.subscriptionExpiresAt), \"PPP\")}</span>\n              </div>\n            )}\n          </div>\n        </GlassPanel>\n\n        <GlassPanel size=\"md\">\n          <h2 className=\"text-lg font-semibold text-white mb-4\">Quick Actions</h2>\n          <div className=\"space-y-4\">\n            <div>\n              <label className=\"text-sm text-muted-foreground mb-2 block\">Change Tier</label>\n              <Select\n                value={tenant.tier}\n                onValueChange={(tier) => updateTierMutation.mutate(tier)}\n              >\n                <SelectTrigger className=\"bg-white/5 border-white/10\" data-testid=\"select-tier\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"TRIAL\">Trial (Free)</SelectItem>\n                  <SelectItem value=\"TIER_1\">Tier 1 (Ksh 500/month)</SelectItem>\n                  <SelectItem value=\"TIER_2\">Tier 2 (Ksh 1,500/month)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"flex flex-wrap gap-2\">\n              {tenant.saasBillingStatus !== \"ACTIVE\" && (\n                <Button\n                  onClick={() => updateStatusMutation.mutate({ isActive: true, saasBillingStatus: \"ACTIVE\" })}\n                  className=\"flex-1\"\n                  disabled={updateStatusMutation.isPending}\n                  data-testid=\"button-activate\"\n                >\n                  <CheckCircle size={16} className=\"mr-2\" />\n                  Activate\n                </Button>\n              )}\n              {tenant.saasBillingStatus !== \"SUSPENDED\" && (\n                <Button\n                  variant=\"outline\"\n                  onClick={() => updateStatusMutation.mutate({ isActive: false, saasBillingStatus: \"SUSPENDED\" })}\n                  className=\"flex-1\"\n                  disabled={updateStatusMutation.isPending}\n                  data-testid=\"button-suspend\"\n                >\n                  <Pause size={16} className=\"mr-2\" />\n                  Suspend\n                </Button>\n              )}\n              {tenant.saasBillingStatus !== \"BLOCKED\" && (\n                <Button\n                  variant=\"destructive\"\n                  onClick={() => updateStatusMutation.mutate({ isActive: false, saasBillingStatus: \"BLOCKED\" })}\n                  className=\"flex-1\"\n                  disabled={updateStatusMutation.isPending}\n                  data-testid=\"button-block\"\n                >\n                  <Ban size={16} className=\"mr-2\" />\n                  Block\n                </Button>\n              )}\n            </div>\n          </div>\n        </GlassPanel>\n      </div>\n\n      <GlassPanel size=\"md\">\n        <div className=\"flex items-center justify-between mb-4 gap-4 flex-wrap\">\n          <h2 className=\"text-lg font-semibold text-white\">Revenue Overview</h2>\n          <div className=\"flex items-center gap-2\">\n            <TrendingUp size={16} className=\"text-cyan-400\" />\n            <span className=\"text-sm text-muted-foreground\">Monthly Performance</span>\n          </div>\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <motion.div\n            className=\"p-4 rounded-lg bg-white/5 border border-white/10\"\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n          >\n            <p className=\"text-sm text-muted-foreground mb-1\">This Month</p>\n            <p className=\"text-2xl font-bold text-white\">{formatCurrency(tenant.revenueThisMonth)}</p>\n          </motion.div>\n          <motion.div\n            className=\"p-4 rounded-lg bg-white/5 border border-white/10\"\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.1 }}\n          >\n            <p className=\"text-sm text-muted-foreground mb-1\">Last Month</p>\n            <p className=\"text-2xl font-bold text-white\">{formatCurrency(tenant.revenueLastMonth)}</p>\n          </motion.div>\n          <motion.div\n            className=\"p-4 rounded-lg bg-white/5 border border-white/10\"\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.2 }}\n          >\n            <p className=\"text-sm text-muted-foreground mb-1\">Growth</p>\n            <p className={`text-2xl font-bold ${revenueGrowth >= 0 ? \"text-cyan-400\" : \"text-red-400\"}`}>\n              {revenueGrowth >= 0 ? \"+\" : \"\"}{revenueGrowth}%\n            </p>\n          </motion.div>\n        </div>\n      </GlassPanel>\n    </div>\n  );\n}\n","path":null,"size_bytes":13118,"size_tokens":null},"client/src/pages/superadmin-register.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation, Link } from \"wouter\";\nimport { motion } from \"framer-motion\";\nimport { Shield, User, Mail, Lock, Eye, EyeOff, ArrowRight, CheckCircle } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\nexport default function SuperAdminRegisterPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [showPassword, setShowPassword] = useState(false);\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\n  const [isLoading, setIsLoading] = useState(false);\n  const [isSuccess, setIsSuccess] = useState(false);\n\n  const [formData, setFormData] = useState({\n    username: \"\",\n    email: \"\",\n    password: \"\",\n    confirmPassword: \"\",\n    setupKey: \"\",\n  });\n\n  const [errors, setErrors] = useState<Record<string, string>>({});\n\n  const validateForm = () => {\n    const newErrors: Record<string, string> = {};\n\n    if (!formData.username.trim()) {\n      newErrors.username = \"Username is required\";\n    } else if (formData.username.length < 3) {\n      newErrors.username = \"Username must be at least 3 characters\";\n    }\n\n    if (!formData.email.trim()) {\n      newErrors.email = \"Email is required\";\n    } else if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(formData.email)) {\n      newErrors.email = \"Please enter a valid email address\";\n    }\n\n    if (!formData.password) {\n      newErrors.password = \"Password is required\";\n    } else if (formData.password.length < 8) {\n      newErrors.password = \"Password must be at least 8 characters\";\n    }\n\n    if (formData.password !== formData.confirmPassword) {\n      newErrors.confirmPassword = \"Passwords do not match\";\n    }\n\n    if (!formData.setupKey.trim()) {\n      newErrors.setupKey = \"Setup key is required\";\n    }\n\n    setErrors(newErrors);\n    return Object.keys(newErrors).length === 0;\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n\n    if (!validateForm()) {\n      return;\n    }\n\n    setIsLoading(true);\n\n    try {\n      const response = await fetch(\"/api/auth/register-superadmin\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({\n          username: formData.username,\n          email: formData.email,\n          password: formData.password,\n          setupKey: formData.setupKey,\n        }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error || \"Registration failed\");\n      }\n\n      setIsSuccess(true);\n      toast({\n        title: \"Registration Successful\",\n        description: \"Your super admin account has been created. You can now log in.\",\n      });\n\n      setTimeout(() => {\n        setLocation(\"/superadmin/login\");\n      }, 2000);\n    } catch (error) {\n      toast({\n        title: \"Registration Failed\",\n        description: error instanceof Error ? error.message : \"Failed to create account\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  if (isSuccess) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 p-4\">\n        <motion.div\n          initial={{ opacity: 0, scale: 0.9 }}\n          animate={{ opacity: 1, scale: 1 }}\n          className=\"w-full max-w-md\"\n        >\n          <div className=\"glass-panel p-8 text-center\">\n            <motion.div\n              initial={{ scale: 0 }}\n              animate={{ scale: 1 }}\n              transition={{ type: \"spring\", delay: 0.2 }}\n              className=\"w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-br from-emerald-500/20 to-cyan-500/20 flex items-center justify-center\"\n            >\n              <CheckCircle size={40} className=\"text-emerald-400\" />\n            </motion.div>\n            <h1 className=\"text-2xl font-bold text-white mb-2\">Account Created!</h1>\n            <p className=\"text-muted-foreground mb-6\">\n              Redirecting you to the login page...\n            </p>\n            <div className=\"flex justify-center\">\n              <div className=\"w-8 h-8 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin\" />\n            </div>\n          </div>\n        </motion.div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 p-4\" data-testid=\"superadmin-register-page\">\n      <div className=\"absolute inset-0 overflow-hidden pointer-events-none\">\n        <div className=\"absolute top-1/4 left-1/4 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl\" />\n        <div className=\"absolute bottom-1/4 right-1/4 w-96 h-96 bg-cyan-500/10 rounded-full blur-3xl\" />\n      </div>\n\n      <motion.div\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.5 }}\n        className=\"w-full max-w-md relative z-10\"\n      >\n        <div className=\"text-center mb-8\">\n          <motion.div\n            initial={{ scale: 0 }}\n            animate={{ scale: 1 }}\n            transition={{ type: \"spring\", delay: 0.2 }}\n            className=\"inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-500/20 to-pink-500/20 mb-4\"\n          >\n            <Shield size={32} className=\"text-purple-400\" />\n          </motion.div>\n          <h1 className=\"text-3xl font-bold text-white mb-2\">Super Admin Registration</h1>\n          <p className=\"text-muted-foreground\">\n            Create your platform administrator account\n          </p>\n        </div>\n\n        <div className=\"glass-panel p-8\">\n          <form onSubmit={handleSubmit} className=\"space-y-5\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">\n                Username\n              </label>\n              <div className=\"relative\">\n                <User size={18} className=\"absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground\" />\n                <input\n                  type=\"text\"\n                  value={formData.username}\n                  onChange={(e) => setFormData({ ...formData, username: e.target.value })}\n                  placeholder=\"Enter username\"\n                  className={`w-full pl-12 pr-4 py-3 bg-white/5 border ${\n                    errors.username ? \"border-red-500/50\" : \"border-white/10\"\n                  } rounded-lg text-white placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-purple-500/50 transition-all`}\n                  data-testid=\"input-username\"\n                />\n              </div>\n              {errors.username && (\n                <p className=\"text-sm text-red-400\">{errors.username}</p>\n              )}\n            </div>\n\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">\n                Email\n              </label>\n              <div className=\"relative\">\n                <Mail size={18} className=\"absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground\" />\n                <input\n                  type=\"email\"\n                  value={formData.email}\n                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                  placeholder=\"admin@example.com\"\n                  className={`w-full pl-12 pr-4 py-3 bg-white/5 border ${\n                    errors.email ? \"border-red-500/50\" : \"border-white/10\"\n                  } rounded-lg text-white placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-purple-500/50 transition-all`}\n                  data-testid=\"input-email\"\n                />\n              </div>\n              {errors.email && (\n                <p className=\"text-sm text-red-400\">{errors.email}</p>\n              )}\n            </div>\n\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">\n                Password\n              </label>\n              <div className=\"relative\">\n                <Lock size={18} className=\"absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground\" />\n                <input\n                  type={showPassword ? \"text\" : \"password\"}\n                  value={formData.password}\n                  onChange={(e) => setFormData({ ...formData, password: e.target.value })}\n                  placeholder=\"Create a strong password\"\n                  className={`w-full pl-12 pr-12 py-3 bg-white/5 border ${\n                    errors.password ? \"border-red-500/50\" : \"border-white/10\"\n                  } rounded-lg text-white placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-purple-500/50 transition-all`}\n                  data-testid=\"input-password\"\n                />\n                <button\n                  type=\"button\"\n                  onClick={() => setShowPassword(!showPassword)}\n                  className=\"absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-white transition-colors\"\n                >\n                  {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}\n                </button>\n              </div>\n              {errors.password && (\n                <p className=\"text-sm text-red-400\">{errors.password}</p>\n              )}\n            </div>\n\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">\n                Confirm Password\n              </label>\n              <div className=\"relative\">\n                <Lock size={18} className=\"absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground\" />\n                <input\n                  type={showConfirmPassword ? \"text\" : \"password\"}\n                  value={formData.confirmPassword}\n                  onChange={(e) => setFormData({ ...formData, confirmPassword: e.target.value })}\n                  placeholder=\"Confirm your password\"\n                  className={`w-full pl-12 pr-12 py-3 bg-white/5 border ${\n                    errors.confirmPassword ? \"border-red-500/50\" : \"border-white/10\"\n                  } rounded-lg text-white placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-purple-500/50 transition-all`}\n                  data-testid=\"input-confirm-password\"\n                />\n                <button\n                  type=\"button\"\n                  onClick={() => setShowConfirmPassword(!showConfirmPassword)}\n                  className=\"absolute right-4 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-white transition-colors\"\n                >\n                  {showConfirmPassword ? <EyeOff size={18} /> : <Eye size={18} />}\n                </button>\n              </div>\n              {errors.confirmPassword && (\n                <p className=\"text-sm text-red-400\">{errors.confirmPassword}</p>\n              )}\n            </div>\n\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider\">\n                Setup Key\n              </label>\n              <div className=\"relative\">\n                <Shield size={18} className=\"absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground\" />\n                <input\n                  type=\"password\"\n                  value={formData.setupKey}\n                  onChange={(e) => setFormData({ ...formData, setupKey: e.target.value })}\n                  placeholder=\"Enter the platform setup key\"\n                  className={`w-full pl-12 pr-4 py-3 bg-white/5 border ${\n                    errors.setupKey ? \"border-red-500/50\" : \"border-white/10\"\n                  } rounded-lg text-white placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-purple-500/50 transition-all`}\n                  data-testid=\"input-setup-key\"\n                />\n              </div>\n              {errors.setupKey && (\n                <p className=\"text-sm text-red-400\">{errors.setupKey}</p>\n              )}\n              <p className=\"text-xs text-muted-foreground\">\n                The setup key is required to create a super admin account. Contact your system administrator if you don't have one.\n              </p>\n            </div>\n\n            <Button\n              type=\"submit\"\n              className=\"w-full gradient-btn py-6\"\n              disabled={isLoading}\n              data-testid=\"button-register\"\n            >\n              {isLoading ? (\n                <>\n                  <div className=\"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2\" />\n                  Creating Account...\n                </>\n              ) : (\n                <>\n                  Create Super Admin Account\n                  <ArrowRight size={18} className=\"ml-2\" />\n                </>\n              )}\n            </Button>\n          </form>\n\n          <div className=\"mt-6 text-center\">\n            <p className=\"text-muted-foreground\">\n              Already have an account?{\" \"}\n              <Link\n                href=\"/superadmin/login\"\n                className=\"text-purple-400 hover:text-purple-300 transition-colors\"\n                data-testid=\"link-login\"\n              >\n                Sign in\n              </Link>\n            </p>\n          </div>\n        </div>\n\n        <div className=\"mt-6 text-center\">\n          <Link\n            href=\"/login\"\n            className=\"text-sm text-muted-foreground hover:text-white transition-colors\"\n          >\n            ISP Admin Login\n          </Link>\n        </div>\n      </motion.div>\n    </div>\n  );\n}\n","path":null,"size_bytes":13868,"size_tokens":null},"client/src/pages/customer-details.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useParams, Link } from \"wouter\";\nimport { motion } from \"framer-motion\";\nimport {\n  ArrowLeft,\n  Phone,\n  Mail,\n  User,\n  Wifi,\n  Router,\n  Clock,\n  Calendar,\n  CreditCard,\n  Receipt,\n  CheckCircle,\n  XCircle,\n  AlertCircle,\n  RefreshCw,\n  Ban,\n  Play,\n  Edit,\n  Loader2,\n} from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { MetricCard, MetricCardSkeleton } from \"@/components/metric-card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { cn } from \"@/lib/utils\";\nimport { format, formatDistanceToNow } from \"date-fns\";\n\ninterface CustomerDetails {\n  id: string;\n  phoneNumber: string;\n  email: string | null;\n  fullName: string | null;\n  accountType: string;\n  status: string;\n  macAddress: string | null;\n  ipAddress: string | null;\n  username: string | null;\n  expiryTime: string | null;\n  notes: string | null;\n  createdAt: string;\n  updatedAt: string;\n  currentPlan: {\n    id: string;\n    name: string;\n    price: number;\n    durationSeconds: number;\n    uploadLimit: string | null;\n    downloadLimit: string | null;\n  } | null;\n  currentHotspot: {\n    id: string;\n    locationName: string;\n    nasIp: string;\n  } | null;\n  transactions: {\n    id: string;\n    amount: number;\n    status: string;\n    mpesaReceiptNumber: string | null;\n    createdAt: string;\n    planName: string | null;\n  }[];\n  stats: {\n    totalSpent: number;\n    totalTransactions: number;\n    successfulPayments: number;\n    failedPayments: number;\n    daysSinceRegistration: number;\n    averagePayment: number;\n  };\n}\n\nconst accountTypeLabels: Record<string, string> = {\n  HOTSPOT: \"Hotspot\",\n  PPPOE: \"PPPoE\",\n  STATIC: \"Static IP\",\n};\n\nconst statusColors: Record<string, string> = {\n  ACTIVE: \"bg-emerald-500/20 text-emerald-400 border-emerald-500/30\",\n  SUSPENDED: \"bg-amber-500/20 text-amber-400 border-amber-500/30\",\n  EXPIRED: \"bg-red-500/20 text-red-400 border-red-500/30\",\n};\n\nconst transactionStatusConfig: Record<string, { icon: typeof CheckCircle; color: string; bg: string }> = {\n  COMPLETED: { icon: CheckCircle, color: \"text-emerald-400\", bg: \"bg-emerald-500/20\" },\n  PENDING: { icon: AlertCircle, color: \"text-amber-400\", bg: \"bg-amber-500/20\" },\n  FAILED: { icon: XCircle, color: \"text-red-400\", bg: \"bg-red-500/20\" },\n};\n\nexport default function CustomerDetailsPage() {\n  const params = useParams<{ id: string }>();\n  const { toast } = useToast();\n\n  const { data: customer, isLoading, error } = useQuery<CustomerDetails>({\n    queryKey: [\"/api/wifi-users\", params.id, \"details\"],\n    queryFn: async () => {\n      const response = await fetch(`/api/wifi-users/${params.id}/details`);\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch customer details\");\n      }\n      return response.json();\n    },\n  });\n\n  const actionMutation = useMutation({\n    mutationFn: async ({ action }: { action: string }) => {\n      return apiRequest(\"POST\", `/api/wifi-users/${params.id}/${action}`, {});\n    },\n    onSuccess: (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/wifi-users\", params.id, \"details\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/wifi-users\"] });\n      const actionLabels: Record<string, string> = {\n        suspend: \"Customer suspended\",\n        activate: \"Customer activated\",\n        recharge: \"Account recharged\",\n      };\n      toast({\n        title: \"Success\",\n        description: actionLabels[variables.action] || \"Action completed successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to perform action\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat(\"en-KE\", {\n      style: \"currency\",\n      currency: \"KES\",\n      minimumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  const formatDuration = (seconds: number) => {\n    if (seconds < 3600) {\n      return `${Math.round(seconds / 60)} minutes`;\n    } else if (seconds < 86400) {\n      return `${Math.round(seconds / 3600)} hours`;\n    } else if (seconds < 604800) {\n      return `${Math.round(seconds / 86400)} days`;\n    } else {\n      return `${Math.round(seconds / 604800)} weeks`;\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6 space-y-6\" data-testid=\"customer-details-loading\">\n        <div className=\"flex items-center gap-4\">\n          <div className=\"h-10 w-24 bg-white/10 rounded animate-pulse\" />\n          <div className=\"h-8 w-64 bg-white/10 rounded animate-pulse\" />\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          <MetricCardSkeleton />\n          <MetricCardSkeleton />\n          <MetricCardSkeleton />\n          <MetricCardSkeleton />\n        </div>\n      </div>\n    );\n  }\n\n  if (error || !customer) {\n    return (\n      <div className=\"p-6\" data-testid=\"customer-details-error\">\n        <GlassPanel className=\"text-center py-12\">\n          <XCircle size={48} className=\"mx-auto mb-4 text-red-400\" />\n          <h2 className=\"text-xl font-bold text-white mb-2\">Customer Not Found</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            The customer you're looking for doesn't exist or has been deleted.\n          </p>\n          <Link href=\"/dashboard/wifi-users\">\n            <Button variant=\"outline\">\n              <ArrowLeft size={16} className=\"mr-2\" />\n              Back to Customers\n            </Button>\n          </Link>\n        </GlassPanel>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"customer-details-page\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div className=\"flex items-center gap-4\">\n          <Link href=\"/dashboard/wifi-users\">\n            <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-back\">\n              <ArrowLeft size={20} />\n            </Button>\n          </Link>\n          <div>\n            <div className=\"flex items-center gap-3 flex-wrap\">\n              <h1 className=\"text-2xl font-bold text-white\" data-testid=\"text-customer-name\">\n                {customer.fullName || customer.phoneNumber}\n              </h1>\n              <Badge\n                variant=\"outline\"\n                className={cn(\"text-sm\", statusColors[customer.status])}\n                data-testid=\"badge-customer-status\"\n              >\n                {customer.status}\n              </Badge>\n              <Badge\n                variant=\"outline\"\n                className=\"text-sm bg-blue-500/20 text-blue-400 border-blue-500/30\"\n              >\n                {accountTypeLabels[customer.accountType]}\n              </Badge>\n            </div>\n            <p className=\"text-muted-foreground mt-1\">\n              Customer since {format(new Date(customer.createdAt), \"MMMM d, yyyy\")}\n            </p>\n          </div>\n        </div>\n\n        <div className=\"flex items-center gap-2 flex-wrap\">\n          {customer.status === \"ACTIVE\" ? (\n            <Button\n              variant=\"outline\"\n              className=\"border-amber-500/30 text-amber-400 hover:bg-amber-500/20\"\n              onClick={() => actionMutation.mutate({ action: \"suspend\" })}\n              disabled={actionMutation.isPending}\n              data-testid=\"button-suspend\"\n            >\n              {actionMutation.isPending ? (\n                <Loader2 size={16} className=\"mr-2 animate-spin\" />\n              ) : (\n                <Ban size={16} className=\"mr-2\" />\n              )}\n              Suspend\n            </Button>\n          ) : (\n            <Button\n              variant=\"outline\"\n              className=\"border-emerald-500/30 text-emerald-400 hover:bg-emerald-500/20\"\n              onClick={() => actionMutation.mutate({ action: \"activate\" })}\n              disabled={actionMutation.isPending}\n              data-testid=\"button-activate\"\n            >\n              {actionMutation.isPending ? (\n                <Loader2 size={16} className=\"mr-2 animate-spin\" />\n              ) : (\n                <Play size={16} className=\"mr-2\" />\n              )}\n              Activate\n            </Button>\n          )}\n          <Button\n            className=\"gradient-btn\"\n            onClick={() => actionMutation.mutate({ action: \"recharge\" })}\n            disabled={actionMutation.isPending}\n            data-testid=\"button-recharge\"\n          >\n            <RefreshCw size={16} className=\"mr-2\" />\n            Quick Recharge\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <MetricCard\n          title=\"Total Spent\"\n          value={formatCurrency(customer.stats.totalSpent)}\n          icon={<CreditCard size={24} />}\n          gradient=\"mpesa\"\n        />\n        <MetricCard\n          title=\"Total Payments\"\n          value={customer.stats.totalTransactions}\n          icon={<Receipt size={24} />}\n          trend={{\n            value: customer.stats.successfulPayments,\n            label: \"successful\",\n          }}\n        />\n        <MetricCard\n          title=\"Avg. Payment\"\n          value={formatCurrency(customer.stats.averagePayment)}\n          icon={<CreditCard size={24} />}\n        />\n        <MetricCard\n          title=\"Days Active\"\n          value={customer.stats.daysSinceRegistration}\n          icon={<Calendar size={24} />}\n          gradient=\"accent\"\n        />\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        <div className=\"lg:col-span-1 space-y-6\">\n          <GlassPanel size=\"md\">\n            <h2 className=\"text-lg font-semibold text-white mb-4 flex items-center gap-2\">\n              <User size={20} className=\"text-cyan-400\" />\n              Customer Information\n            </h2>\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 rounded-lg bg-white/5\">\n                  <Phone size={16} className=\"text-muted-foreground\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Phone Number</p>\n                  <p className=\"text-white font-medium\" data-testid=\"text-phone\">\n                    {customer.phoneNumber}\n                  </p>\n                </div>\n              </div>\n\n              {customer.email && (\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-white/5\">\n                    <Mail size={16} className=\"text-muted-foreground\" />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Email</p>\n                    <p className=\"text-white font-medium\" data-testid=\"text-email\">\n                      {customer.email}\n                    </p>\n                  </div>\n                </div>\n              )}\n\n              {customer.username && (\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-white/5\">\n                    <User size={16} className=\"text-muted-foreground\" />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Username</p>\n                    <p className=\"text-white font-medium\">{customer.username}</p>\n                  </div>\n                </div>\n              )}\n\n              {customer.macAddress && (\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-white/5\">\n                    <Wifi size={16} className=\"text-muted-foreground\" />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">MAC Address</p>\n                    <p className=\"text-white font-medium font-mono text-sm\">\n                      {customer.macAddress}\n                    </p>\n                  </div>\n                </div>\n              )}\n\n              {customer.ipAddress && (\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 rounded-lg bg-white/5\">\n                    <Router size={16} className=\"text-muted-foreground\" />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">IP Address</p>\n                    <p className=\"text-white font-medium font-mono text-sm\">\n                      {customer.ipAddress}\n                    </p>\n                  </div>\n                </div>\n              )}\n\n              {customer.notes && (\n                <div className=\"pt-4 border-t border-white/10\">\n                  <p className=\"text-sm text-muted-foreground mb-1\">Notes</p>\n                  <p className=\"text-white text-sm\">{customer.notes}</p>\n                </div>\n              )}\n            </div>\n          </GlassPanel>\n\n          <GlassPanel size=\"md\">\n            <h2 className=\"text-lg font-semibold text-white mb-4 flex items-center gap-2\">\n              <Wifi size={20} className=\"text-cyan-400\" />\n              Current Plan\n            </h2>\n            {customer.currentPlan ? (\n              <div className=\"space-y-4\">\n                <div className=\"p-4 rounded-lg bg-gradient-to-br from-cyan-500/10 to-purple-500/10 border border-cyan-500/20\">\n                  <h3 className=\"text-lg font-semibold text-white\">\n                    {customer.currentPlan.name}\n                  </h3>\n                  <p className=\"text-2xl font-bold text-cyan-400 mt-1\">\n                    {formatCurrency(customer.currentPlan.price)}\n                  </p>\n                  <p className=\"text-sm text-muted-foreground mt-1\">\n                    {formatDuration(customer.currentPlan.durationSeconds)}\n                  </p>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"p-3 rounded-lg bg-white/5\">\n                    <p className=\"text-xs text-muted-foreground\">Upload</p>\n                    <p className=\"text-white font-medium\">\n                      {customer.currentPlan.uploadLimit || \"Unlimited\"}\n                    </p>\n                  </div>\n                  <div className=\"p-3 rounded-lg bg-white/5\">\n                    <p className=\"text-xs text-muted-foreground\">Download</p>\n                    <p className=\"text-white font-medium\">\n                      {customer.currentPlan.downloadLimit || \"Unlimited\"}\n                    </p>\n                  </div>\n                </div>\n\n                {customer.expiryTime && (\n                  <div className=\"p-3 rounded-lg bg-white/5\">\n                    <p className=\"text-xs text-muted-foreground\">Expires</p>\n                    <p\n                      className={cn(\n                        \"font-medium\",\n                        new Date(customer.expiryTime) < new Date()\n                          ? \"text-red-400\"\n                          : \"text-white\"\n                      )}\n                    >\n                      {format(new Date(customer.expiryTime), \"MMM d, yyyy HH:mm\")}\n                      <span className=\"text-muted-foreground text-sm ml-2\">\n                        ({formatDistanceToNow(new Date(customer.expiryTime), { addSuffix: true })})\n                      </span>\n                    </p>\n                  </div>\n                )}\n              </div>\n            ) : (\n              <div className=\"text-center py-6\">\n                <Wifi size={32} className=\"mx-auto mb-2 text-muted-foreground opacity-50\" />\n                <p className=\"text-muted-foreground\">No active plan</p>\n              </div>\n            )}\n          </GlassPanel>\n\n          {customer.currentHotspot && (\n            <GlassPanel size=\"md\">\n              <h2 className=\"text-lg font-semibold text-white mb-4 flex items-center gap-2\">\n                <Router size={20} className=\"text-cyan-400\" />\n                Connected Hotspot\n              </h2>\n              <div className=\"p-4 rounded-lg bg-white/5\">\n                <h3 className=\"font-semibold text-white\">\n                  {customer.currentHotspot.locationName}\n                </h3>\n                <p className=\"text-sm text-muted-foreground mt-1 font-mono\">\n                  {customer.currentHotspot.nasIp}\n                </p>\n              </div>\n            </GlassPanel>\n          )}\n        </div>\n\n        <div className=\"lg:col-span-2\">\n          <GlassPanel size=\"md\">\n            <h2 className=\"text-lg font-semibold text-white mb-4 flex items-center gap-2\">\n              <Receipt size={20} className=\"text-cyan-400\" />\n              Payment History\n            </h2>\n\n            {customer.transactions.length > 0 ? (\n              <div className=\"space-y-3\">\n                {customer.transactions.map((tx, index) => {\n                  const config = transactionStatusConfig[tx.status] || transactionStatusConfig.PENDING;\n                  const StatusIcon = config.icon;\n\n                  return (\n                    <motion.div\n                      key={tx.id}\n                      initial={{ opacity: 0, y: 10 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      transition={{ delay: index * 0.05 }}\n                      className=\"flex items-center gap-4 p-4 rounded-lg border bg-white/5 border-white/10\"\n                      data-testid={`transaction-row-${tx.id}`}\n                    >\n                      <div className={cn(\"p-2 rounded-full\", config.bg)}>\n                        <StatusIcon size={18} className={config.color} />\n                      </div>\n\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2 flex-wrap\">\n                          <p className=\"font-medium text-white\">\n                            {formatCurrency(tx.amount)}\n                          </p>\n                          <Badge\n                            variant=\"outline\"\n                            className={cn(\"text-xs\", config.bg, config.color, \"border-0\")}\n                          >\n                            {tx.status}\n                          </Badge>\n                        </div>\n                        <div className=\"flex items-center gap-3 text-sm text-muted-foreground mt-1\">\n                          {tx.planName && <span>{tx.planName}</span>}\n                          {tx.mpesaReceiptNumber && (\n                            <span className=\"font-mono text-xs\">\n                              {tx.mpesaReceiptNumber}\n                            </span>\n                          )}\n                        </div>\n                      </div>\n\n                      <div className=\"text-right\">\n                        <p className=\"text-sm text-white\">\n                          {format(new Date(tx.createdAt), \"MMM d, yyyy\")}\n                        </p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          {format(new Date(tx.createdAt), \"HH:mm\")}\n                        </p>\n                      </div>\n                    </motion.div>\n                  );\n                })}\n              </div>\n            ) : (\n              <div className=\"text-center py-12\">\n                <Receipt size={48} className=\"mx-auto mb-4 text-muted-foreground opacity-50\" />\n                <p className=\"text-muted-foreground\">No payment history yet</p>\n              </div>\n            )}\n          </GlassPanel>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":19803,"size_tokens":null},"client/src/pages/network-monitoring.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { \n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { \n  Activity, \n  Cpu, \n  HardDrive, \n  MemoryStick, \n  Network, \n  RefreshCw, \n  Power, \n  Wifi,\n  ArrowUp,\n  ArrowDown,\n  Router,\n  Clock,\n  Loader2,\n  AlertTriangle,\n  CheckCircle2,\n  Users,\n  Shield,\n  Globe,\n  Download,\n  Upload,\n  Trash2,\n  Plus,\n  Settings,\n  Eye,\n  EyeOff,\n  Save,\n  FileText,\n  Palette,\n  Zap,\n  ExternalLink,\n  RotateCcw,\n  Database,\n  Server,\n} from \"lucide-react\";\nimport { \n  LineChart, \n  Line, \n  XAxis, \n  YAxis, \n  CartesianGrid, \n  Tooltip, \n  ResponsiveContainer,\n  Area,\n  AreaChart,\n} from \"recharts\";\nimport type { Hotspot } from \"@shared/schema\";\n\ninterface RouterStats {\n  uptime: string;\n  cpuLoad: number;\n  freeMemory: number;\n  totalMemory: number;\n  freeDisk: number;\n  totalDisk: number;\n  boardName: string;\n  version: string;\n  architecture: string;\n}\n\ninterface BandwidthData {\n  time: string;\n  upload: number;\n  download: number;\n}\n\ninterface InterfaceStats {\n  name: string;\n  type: string;\n  rxBytes: number;\n  txBytes: number;\n  rxPackets: number;\n  txPackets: number;\n  running: boolean;\n  disabled: boolean;\n}\n\ninterface ActiveSession {\n  id: string;\n  user: string;\n  address: string;\n  macAddress: string;\n  uptime: string;\n  bytesIn: number;\n  bytesOut: number;\n}\n\ninterface FirewallRule {\n  \".id\": string;\n  chain: string;\n  action: string;\n  \"src-address\"?: string;\n  \"dst-address\"?: string;\n  protocol?: string;\n  \"dst-port\"?: string;\n  comment?: string;\n  disabled: string;\n}\n\ninterface IpPool {\n  \".id\": string;\n  name: string;\n  ranges: string;\n}\n\ninterface WalledGardenEntry {\n  \".id\": string;\n  \"dst-host\": string;\n  action: string;\n  comment?: string;\n}\n\ninterface RouterBackup {\n  id: string;\n  name: string;\n  type: string;\n  routerVersion?: string;\n  routerIdentity?: string;\n  createdAt: string;\n}\n\ninterface LoginTemplate {\n  id: string;\n  name: string;\n  description?: string;\n  isDefault: boolean;\n  config: Record<string, any>;\n  createdAt: string;\n}\n\ninterface ConnectionTestResult {\n  success: boolean;\n  data?: {\n    identity: any;\n    resources: any;\n    health?: any;\n    connectionTime: string;\n  };\n  error?: string;\n}\n\nexport default function NetworkMonitoringPage() {\n  const { toast } = useToast();\n  const [selectedHotspot, setSelectedHotspot] = useState<string | null>(null);\n  const [bandwidthHistory, setBandwidthHistory] = useState<BandwidthData[]>([]);\n  const [isRebooting, setIsRebooting] = useState(false);\n  const [firewallType, setFirewallType] = useState<\"filter\" | \"nat\" | \"mangle\">(\"filter\");\n  const [showNewPoolDialog, setShowNewPoolDialog] = useState(false);\n  const [newPoolName, setNewPoolName] = useState(\"\");\n  const [newPoolRanges, setNewPoolRanges] = useState(\"\");\n  const [backupName, setBackupName] = useState(\"\");\n  const [backupNotes, setBackupNotes] = useState(\"\");\n  const [showBackupDialog, setShowBackupDialog] = useState(false);\n  const [isTesting, setIsTesting] = useState(false);\n  const [connectionResult, setConnectionResult] = useState<ConnectionTestResult | null>(null);\n\n  const { data: hotspots = [], isLoading: hotspotsLoading } = useQuery<Hotspot[]>({\n    queryKey: [\"/api/hotspots\"],\n  });\n\n  const { data: routerStats, isLoading: statsLoading, refetch: refetchStats } = useQuery<RouterStats>({\n    queryKey: [\"/api/hotspots\", selectedHotspot, \"stats\"],\n    enabled: !!selectedHotspot,\n    refetchInterval: 10000,\n  });\n\n  const { data: interfaces = [], isLoading: interfacesLoading } = useQuery<InterfaceStats[]>({\n    queryKey: [\"/api/hotspots\", selectedHotspot, \"interfaces\"],\n    enabled: !!selectedHotspot,\n    refetchInterval: 5000,\n  });\n\n  const { data: activeSessions = [], isLoading: sessionsLoading, refetch: refetchSessions } = useQuery<ActiveSession[]>({\n    queryKey: [\"/api/hotspots\", selectedHotspot, \"sessions\"],\n    enabled: !!selectedHotspot,\n    refetchInterval: 10000,\n  });\n\n  const { data: firewallRules, isLoading: firewallLoading, refetch: refetchFirewall } = useQuery<{ data: FirewallRule[] }>({\n    queryKey: [\"/api/hotspots\", selectedHotspot, \"firewall\", firewallType],\n    enabled: !!selectedHotspot,\n  });\n\n  const { data: ipPools, isLoading: poolsLoading, refetch: refetchPools } = useQuery<{ data: IpPool[] }>({\n    queryKey: [\"/api/hotspots\", selectedHotspot, \"ip-pools\"],\n    enabled: !!selectedHotspot,\n  });\n\n  const { data: walledGardenRouter, isLoading: walledGardenLoading, refetch: refetchWalledGarden } = useQuery<{ data: WalledGardenEntry[] }>({\n    queryKey: [\"/api/hotspots\", selectedHotspot, \"walled-garden-router\"],\n    enabled: !!selectedHotspot,\n  });\n\n  const { data: backups = [], isLoading: backupsLoading, refetch: refetchBackups } = useQuery<RouterBackup[]>({\n    queryKey: [\"/api/hotspots\", selectedHotspot, \"backups\"],\n    enabled: !!selectedHotspot,\n  });\n\n  const { data: dhcpLeases, isLoading: leasesLoading } = useQuery<{ data: any[] }>({\n    queryKey: [\"/api/hotspots\", selectedHotspot, \"dhcp-leases\"],\n    enabled: !!selectedHotspot,\n    refetchInterval: 15000,\n  });\n\n  const { data: arpTable, isLoading: arpLoading } = useQuery<{ data: any[] }>({\n    queryKey: [\"/api/hotspots\", selectedHotspot, \"arp\"],\n    enabled: !!selectedHotspot,\n    refetchInterval: 15000,\n  });\n\n  const { data: queues, isLoading: queuesLoading } = useQuery<{ data: any[] }>({\n    queryKey: [\"/api/hotspots\", selectedHotspot, \"queues\"],\n    enabled: !!selectedHotspot,\n    refetchInterval: 10000,\n  });\n\n  const { data: loginTemplates = [], refetch: refetchTemplates } = useQuery<LoginTemplate[]>({\n    queryKey: [\"/api/login-templates\"],\n  });\n\n  useEffect(() => {\n    if (hotspots.length > 0 && !selectedHotspot) {\n      setSelectedHotspot(hotspots[0].id);\n    }\n  }, [hotspots, selectedHotspot]);\n\n  useEffect(() => {\n    if (interfaces.length > 0) {\n      const now = new Date();\n      const timeStr = now.toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\", second: \"2-digit\" });\n      const totalUpload = interfaces.reduce((sum, iface) => sum + iface.txBytes, 0);\n      const totalDownload = interfaces.reduce((sum, iface) => sum + iface.rxBytes, 0);\n      \n      setBandwidthHistory(prev => {\n        const newData = [...prev, { time: timeStr, upload: totalUpload, download: totalDownload }];\n        return newData.slice(-20);\n      });\n    }\n  }, [interfaces]);\n\n  const testConnection = async () => {\n    if (!selectedHotspot) return;\n    setIsTesting(true);\n    setConnectionResult(null);\n    try {\n      const result = await apiRequest(\"POST\", `/api/hotspots/${selectedHotspot}/test-connection`);\n      const data = await result.json();\n      setConnectionResult(data);\n      if (data.success) {\n        toast({\n          title: \"Connection Successful\",\n          description: `Connected to ${data.data?.identity?.name || \"router\"} (RouterOS ${data.data?.resources?.version || \"unknown\"})`,\n        });\n      } else {\n        toast({\n          title: \"Connection Failed\",\n          description: data.error || \"Could not connect to router\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      setConnectionResult({ success: false, error: \"Connection test failed\" });\n      toast({\n        title: \"Connection Failed\",\n        description: \"Could not connect to router\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsTesting(false);\n    }\n  };\n\n  const handleReboot = async () => {\n    if (!selectedHotspot) return;\n    setIsRebooting(true);\n    try {\n      await apiRequest(\"POST\", `/api/hotspots/${selectedHotspot}/reboot`);\n      toast({\n        title: \"Reboot Initiated\",\n        description: \"Router is rebooting. Please wait a few moments.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to reboot router\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsRebooting(false);\n    }\n  };\n\n  const disconnectSession = async (sessionId: string) => {\n    if (!selectedHotspot) return;\n    try {\n      await apiRequest(\"DELETE\", `/api/hotspots/${selectedHotspot}/sessions/${sessionId}`);\n      toast({\n        title: \"Session Disconnected\",\n        description: \"User has been disconnected\",\n      });\n      refetchSessions();\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to disconnect session\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const toggleFirewallRule = async (ruleId: string, disabled: boolean) => {\n    if (!selectedHotspot) return;\n    try {\n      await apiRequest(\"PATCH\", `/api/hotspots/${selectedHotspot}/firewall/${firewallType}/${ruleId}`, {\n        action: disabled ? \"enable\" : \"disable\",\n      });\n      toast({\n        title: disabled ? \"Rule Enabled\" : \"Rule Disabled\",\n        description: \"Firewall rule updated successfully\",\n      });\n      refetchFirewall();\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to update firewall rule\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const addIpPool = async () => {\n    if (!selectedHotspot || !newPoolName || !newPoolRanges) return;\n    try {\n      await apiRequest(\"POST\", `/api/hotspots/${selectedHotspot}/ip-pools`, {\n        name: newPoolName,\n        ranges: newPoolRanges,\n      });\n      toast({\n        title: \"IP Pool Created\",\n        description: `Pool \"${newPoolName}\" has been created`,\n      });\n      setNewPoolName(\"\");\n      setNewPoolRanges(\"\");\n      setShowNewPoolDialog(false);\n      refetchPools();\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to create IP pool\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const deleteIpPool = async (poolId: string) => {\n    if (!selectedHotspot) return;\n    try {\n      await apiRequest(\"DELETE\", `/api/hotspots/${selectedHotspot}/ip-pools/${poolId}`);\n      toast({\n        title: \"IP Pool Deleted\",\n        description: \"Pool has been removed\",\n      });\n      refetchPools();\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete IP pool\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const syncWalledGarden = async () => {\n    if (!selectedHotspot) return;\n    try {\n      const result = await apiRequest(\"POST\", `/api/hotspots/${selectedHotspot}/sync-walled-garden`);\n      const data = await result.json();\n      if (data.success) {\n        toast({\n          title: \"Walled Garden Synced\",\n          description: `Added ${data.data?.added || 0} entries to router`,\n        });\n      } else {\n        toast({\n          title: \"Sync Completed with Errors\",\n          description: `Added: ${data.data?.added || 0}, Failed: ${data.data?.failed || 0}`,\n          variant: \"destructive\",\n        });\n      }\n      refetchWalledGarden();\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to sync walled garden\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const createBackup = async () => {\n    if (!selectedHotspot) return;\n    try {\n      await apiRequest(\"POST\", `/api/hotspots/${selectedHotspot}/backup`, {\n        name: backupName || `Backup ${new Date().toLocaleString()}`,\n        notes: backupNotes,\n      });\n      toast({\n        title: \"Backup Created\",\n        description: \"Router configuration has been backed up\",\n      });\n      setBackupName(\"\");\n      setBackupNotes(\"\");\n      setShowBackupDialog(false);\n      refetchBackups();\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to create backup\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const downloadBackup = async (backupId: string, name: string) => {\n    try {\n      const response = await fetch(`/api/router-backups/${backupId}/download`, {\n        credentials: \"include\",\n      });\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = `${name}.rsc`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to download backup\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const deleteBackup = async (backupId: string) => {\n    try {\n      await apiRequest(\"DELETE\", `/api/router-backups/${backupId}`);\n      toast({\n        title: \"Backup Deleted\",\n        description: \"Backup has been removed\",\n      });\n      refetchBackups();\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete backup\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const formatBytes = (bytes: number) => {\n    if (bytes === 0) return \"0 B\";\n    const k = 1024;\n    const sizes = [\"B\", \"KB\", \"MB\", \"GB\", \"TB\"];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + \" \" + sizes[i];\n  };\n\n  const selectedHotspotData = hotspots.find(h => h.id === selectedHotspot);\n\n  if (hotspotsLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-96\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-cyan-400\" />\n      </div>\n    );\n  }\n\n  if (hotspots.length === 0) {\n    return (\n      <div className=\"flex flex-col items-center justify-center h-96 gap-4\">\n        <Router className=\"w-16 h-16 text-muted-foreground\" />\n        <h2 className=\"text-xl font-semibold\">No Hotspots Configured</h2>\n        <p className=\"text-muted-foreground text-center max-w-md\">\n          Add a hotspot with MikroTik router credentials to start monitoring your network.\n        </p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\" data-testid=\"network-monitoring-page\">\n      <div className=\"flex flex-wrap items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold\">Network Management</h1>\n          <p className=\"text-muted-foreground\">Monitor and configure your MikroTik routers</p>\n        </div>\n        \n        <div className=\"flex items-center gap-3\">\n          <Select value={selectedHotspot || \"\"} onValueChange={setSelectedHotspot}>\n            <SelectTrigger className=\"w-[220px]\" data-testid=\"select-hotspot\">\n              <SelectValue placeholder=\"Select hotspot\" />\n            </SelectTrigger>\n            <SelectContent>\n              {hotspots.map((hotspot) => (\n                <SelectItem key={hotspot.id} value={hotspot.id}>\n                  <div className=\"flex items-center gap-2\">\n                    <Router className=\"w-4 h-4\" />\n                    {hotspot.locationName}\n                  </div>\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n\n          <Button\n            variant=\"outline\"\n            size=\"icon\"\n            onClick={testConnection}\n            disabled={!selectedHotspot || isTesting}\n            data-testid=\"button-test-connection\"\n          >\n            {isTesting ? (\n              <Loader2 className=\"w-4 h-4 animate-spin\" />\n            ) : (\n              <Zap className=\"w-4 h-4\" />\n            )}\n          </Button>\n\n          <Button\n            variant=\"outline\"\n            size=\"icon\"\n            onClick={() => {\n              refetchStats();\n              refetchSessions();\n            }}\n            disabled={!selectedHotspot}\n            data-testid=\"button-refresh\"\n          >\n            <RefreshCw className=\"w-4 h-4\" />\n          </Button>\n          \n          <AlertDialog>\n            <AlertDialogTrigger asChild>\n              <Button\n                variant=\"destructive\"\n                size=\"icon\"\n                disabled={!selectedHotspot || isRebooting}\n                data-testid=\"button-reboot\"\n              >\n                {isRebooting ? (\n                  <Loader2 className=\"w-4 h-4 animate-spin\" />\n                ) : (\n                  <Power className=\"w-4 h-4\" />\n                )}\n              </Button>\n            </AlertDialogTrigger>\n            <AlertDialogContent>\n              <AlertDialogHeader>\n                <AlertDialogTitle>Reboot Router?</AlertDialogTitle>\n                <AlertDialogDescription>\n                  This will restart the router and disconnect all active sessions.\n                  The router will be unavailable for a few minutes.\n                </AlertDialogDescription>\n              </AlertDialogHeader>\n              <AlertDialogFooter>\n                <AlertDialogCancel>Cancel</AlertDialogCancel>\n                <AlertDialogAction onClick={handleReboot}>Reboot</AlertDialogAction>\n              </AlertDialogFooter>\n            </AlertDialogContent>\n          </AlertDialog>\n        </div>\n      </div>\n\n      {connectionResult && (\n        <Card className={connectionResult.success ? \"border-green-500/50 bg-green-500/5\" : \"border-red-500/50 bg-red-500/5\"}>\n          <CardContent className=\"py-4\">\n            <div className=\"flex items-center gap-3\">\n              {connectionResult.success ? (\n                <CheckCircle2 className=\"w-6 h-6 text-green-500\" />\n              ) : (\n                <AlertTriangle className=\"w-6 h-6 text-red-500\" />\n              )}\n              <div>\n                <p className=\"font-medium\">\n                  {connectionResult.success ? \"Connection Successful\" : \"Connection Failed\"}\n                </p>\n                {connectionResult.success && connectionResult.data && (\n                  <p className=\"text-sm text-muted-foreground\">\n                    {connectionResult.data.identity?.name || \"Unknown\"} | \n                    RouterOS {connectionResult.data.resources?.version || \"unknown\"} |\n                    {connectionResult.data.resources?.[\"board-name\"] || \"\"}\n                  </p>\n                )}\n                {!connectionResult.success && (\n                  <p className=\"text-sm text-muted-foreground\">{connectionResult.error}</p>\n                )}\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {selectedHotspot && (\n        <div className=\"space-y-6\">\n          {routerStats && (\n            <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4\">\n              <Card className=\"bg-card/50\">\n                <CardContent className=\"pt-4\">\n                  <div className=\"flex items-center gap-2 text-muted-foreground mb-2\">\n                    <Clock className=\"w-4 h-4\" />\n                    <span className=\"text-xs\">Uptime</span>\n                  </div>\n                  <p className=\"font-semibold text-sm truncate\" data-testid=\"text-uptime\">{routerStats.uptime}</p>\n                </CardContent>\n              </Card>\n              \n              <Card className=\"bg-card/50\">\n                <CardContent className=\"pt-4\">\n                  <div className=\"flex items-center gap-2 text-muted-foreground mb-2\">\n                    <Cpu className=\"w-4 h-4\" />\n                    <span className=\"text-xs\">CPU</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Progress value={routerStats.cpuLoad} className=\"flex-1 h-2\" />\n                    <span className=\"text-sm font-semibold\" data-testid=\"text-cpu\">{routerStats.cpuLoad}%</span>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card className=\"bg-card/50\">\n                <CardContent className=\"pt-4\">\n                  <div className=\"flex items-center gap-2 text-muted-foreground mb-2\">\n                    <MemoryStick className=\"w-4 h-4\" />\n                    <span className=\"text-xs\">Memory</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Progress \n                      value={((routerStats.totalMemory - routerStats.freeMemory) / routerStats.totalMemory) * 100} \n                      className=\"flex-1 h-2\" \n                    />\n                    <span className=\"text-sm font-semibold\" data-testid=\"text-memory\">\n                      {formatBytes(routerStats.totalMemory - routerStats.freeMemory)}\n                    </span>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card className=\"bg-card/50\">\n                <CardContent className=\"pt-4\">\n                  <div className=\"flex items-center gap-2 text-muted-foreground mb-2\">\n                    <HardDrive className=\"w-4 h-4\" />\n                    <span className=\"text-xs\">Storage</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Progress \n                      value={((routerStats.totalDisk - routerStats.freeDisk) / routerStats.totalDisk) * 100} \n                      className=\"flex-1 h-2\" \n                    />\n                    <span className=\"text-sm font-semibold\" data-testid=\"text-storage\">\n                      {formatBytes(routerStats.totalDisk - routerStats.freeDisk)}\n                    </span>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card className=\"bg-card/50\">\n                <CardContent className=\"pt-4\">\n                  <div className=\"flex items-center gap-2 text-muted-foreground mb-2\">\n                    <Server className=\"w-4 h-4\" />\n                    <span className=\"text-xs\">Board</span>\n                  </div>\n                  <p className=\"font-semibold text-sm truncate\" data-testid=\"text-board\">{routerStats.boardName}</p>\n                </CardContent>\n              </Card>\n\n              <Card className=\"bg-card/50\">\n                <CardContent className=\"pt-4\">\n                  <div className=\"flex items-center gap-2 text-muted-foreground mb-2\">\n                    <Activity className=\"w-4 h-4\" />\n                    <span className=\"text-xs\">RouterOS</span>\n                  </div>\n                  <p className=\"font-semibold text-sm truncate\" data-testid=\"text-version\">{routerStats.version}</p>\n                </CardContent>\n              </Card>\n            </div>\n          )}\n\n          <Tabs defaultValue=\"overview\" className=\"space-y-4\">\n            <TabsList className=\"grid w-full grid-cols-2 md:grid-cols-4 lg:grid-cols-7\">\n              <TabsTrigger value=\"overview\" data-testid=\"tab-overview\">Overview</TabsTrigger>\n              <TabsTrigger value=\"sessions\" data-testid=\"tab-sessions\">Sessions</TabsTrigger>\n              <TabsTrigger value=\"firewall\" data-testid=\"tab-firewall\">Firewall</TabsTrigger>\n              <TabsTrigger value=\"ip-pools\" data-testid=\"tab-ip-pools\">IP Pools</TabsTrigger>\n              <TabsTrigger value=\"walled-garden\" data-testid=\"tab-walled-garden\">Walled Garden</TabsTrigger>\n              <TabsTrigger value=\"backups\" data-testid=\"tab-backups\">Backups</TabsTrigger>\n              <TabsTrigger value=\"network\" data-testid=\"tab-network\">Network</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"overview\">\n              <div className=\"grid lg:grid-cols-2 gap-6\">\n                <Card className=\"bg-card/50\">\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <Activity className=\"w-5 h-5\" />\n                      Bandwidth History\n                    </CardTitle>\n                    <CardDescription>Network traffic over time</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"h-[300px]\">\n                      <ResponsiveContainer width=\"100%\" height=\"100%\">\n                        <AreaChart data={bandwidthHistory}>\n                          <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#333\" />\n                          <XAxis dataKey=\"time\" stroke=\"#888\" tick={{ fill: \"#888\" }} />\n                          <YAxis stroke=\"#888\" tick={{ fill: \"#888\" }} tickFormatter={(value) => formatBytes(value)} />\n                          <Tooltip \n                            contentStyle={{ backgroundColor: \"#1a1a2e\", border: \"1px solid #333\" }}\n                            formatter={(value: number) => formatBytes(value)}\n                          />\n                          <Area type=\"monotone\" dataKey=\"download\" name=\"Download\" stroke=\"#22c55e\" fill=\"#22c55e\" fillOpacity={0.3} />\n                          <Area type=\"monotone\" dataKey=\"upload\" name=\"Upload\" stroke=\"#06b6d4\" fill=\"#06b6d4\" fillOpacity={0.3} />\n                        </AreaChart>\n                      </ResponsiveContainer>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-card/50\">\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <Network className=\"w-5 h-5\" />\n                      Interfaces\n                    </CardTitle>\n                    <CardDescription>Network interface statistics</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <ScrollArea className=\"h-[300px]\">\n                      {interfacesLoading ? (\n                        <div className=\"flex items-center justify-center py-8\">\n                          <Loader2 className=\"w-6 h-6 animate-spin text-cyan-400\" />\n                        </div>\n                      ) : (\n                        <div className=\"space-y-3\">\n                          {interfaces.map((iface, index) => (\n                            <div\n                              key={index}\n                              className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\"\n                              data-testid={`interface-${index}`}\n                            >\n                              <div className=\"flex items-center gap-3\">\n                                <div className={`p-2 rounded-full ${iface.running ? \"bg-green-500/20\" : \"bg-gray-500/20\"}`}>\n                                  <Network className={`w-4 h-4 ${iface.running ? \"text-green-400\" : \"text-gray-400\"}`} />\n                                </div>\n                                <div>\n                                  <p className=\"font-medium\">{iface.name}</p>\n                                  <p className=\"text-xs text-muted-foreground\">{iface.type}</p>\n                                </div>\n                              </div>\n                              <div className=\"flex items-center gap-4 text-sm\">\n                                <div className=\"flex items-center gap-1 text-green-400\">\n                                  <ArrowDown className=\"w-3 h-3\" />\n                                  {formatBytes(iface.rxBytes)}\n                                </div>\n                                <div className=\"flex items-center gap-1 text-cyan-400\">\n                                  <ArrowUp className=\"w-3 h-3\" />\n                                  {formatBytes(iface.txBytes)}\n                                </div>\n                                <Badge variant={iface.running ? \"default\" : \"secondary\"}>\n                                  {iface.running ? \"Up\" : \"Down\"}\n                                </Badge>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                    </ScrollArea>\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"sessions\">\n              <Card className=\"bg-card/50\">\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Users className=\"w-5 h-5\" />\n                    Active Hotspot Sessions ({activeSessions.length})\n                  </CardTitle>\n                  <CardDescription>Currently connected users</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  {sessionsLoading ? (\n                    <div className=\"flex items-center justify-center py-8\">\n                      <Loader2 className=\"w-6 h-6 animate-spin text-cyan-400\" />\n                    </div>\n                  ) : activeSessions.length === 0 ? (\n                    <div className=\"flex flex-col items-center justify-center py-8 text-muted-foreground\">\n                      <Users className=\"w-8 h-8 mb-2\" />\n                      <p>No active sessions</p>\n                    </div>\n                  ) : (\n                    <ScrollArea className=\"h-[400px]\">\n                      <div className=\"space-y-2\">\n                        {activeSessions.map((session, index) => (\n                          <div\n                            key={index}\n                            className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\"\n                            data-testid={`session-${index}`}\n                          >\n                            <div className=\"flex items-center gap-3\">\n                              <div className=\"p-2 rounded-full bg-green-500/20\">\n                                <Wifi className=\"w-4 h-4 text-green-400\" />\n                              </div>\n                              <div>\n                                <p className=\"font-medium\">{session.user}</p>\n                                <p className=\"text-xs text-muted-foreground\">\n                                  {session.address} | {session.macAddress}\n                                </p>\n                              </div>\n                            </div>\n                            <div className=\"flex items-center gap-4 text-sm\">\n                              <div className=\"text-right\">\n                                <p className=\"text-xs text-muted-foreground\">Uptime</p>\n                                <p>{session.uptime}</p>\n                              </div>\n                              <div className=\"text-right\">\n                                <p className=\"text-xs text-muted-foreground\">Usage</p>\n                                <p className=\"flex items-center gap-1\">\n                                  <ArrowDown className=\"w-3 h-3 text-green-400\" />\n                                  {formatBytes(session.bytesIn)}\n                                  <ArrowUp className=\"w-3 h-3 text-cyan-400 ml-2\" />\n                                  {formatBytes(session.bytesOut)}\n                                </p>\n                              </div>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => disconnectSession(session.id)}\n                                data-testid={`button-disconnect-${index}`}\n                              >\n                                <Power className=\"w-4 h-4 text-red-400\" />\n                              </Button>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    </ScrollArea>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"firewall\">\n              <Card className=\"bg-card/50\">\n                <CardHeader>\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <CardTitle className=\"flex items-center gap-2\">\n                        <Shield className=\"w-5 h-5\" />\n                        Firewall Rules\n                      </CardTitle>\n                      <CardDescription>Manage router firewall configuration</CardDescription>\n                    </div>\n                    <Select value={firewallType} onValueChange={(v) => setFirewallType(v as any)}>\n                      <SelectTrigger className=\"w-[150px]\" data-testid=\"select-firewall-type\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"filter\">Filter Rules</SelectItem>\n                        <SelectItem value=\"nat\">NAT Rules</SelectItem>\n                        <SelectItem value=\"mangle\">Mangle Rules</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  {firewallLoading ? (\n                    <div className=\"flex items-center justify-center py-8\">\n                      <Loader2 className=\"w-6 h-6 animate-spin\" />\n                    </div>\n                  ) : (\n                    <ScrollArea className=\"h-[400px]\">\n                      <div className=\"space-y-2\">\n                        {(firewallRules?.data || []).map((rule: FirewallRule, index: number) => (\n                          <div\n                            key={rule[\".id\"]}\n                            className={`flex items-center justify-between p-3 rounded-lg ${\n                              rule.disabled === \"true\" ? \"bg-muted/30 opacity-60\" : \"bg-muted/50\"\n                            }`}\n                            data-testid={`firewall-rule-${index}`}\n                          >\n                            <div className=\"flex items-center gap-3 flex-1\">\n                              <Badge variant={rule.action === \"accept\" || rule.action === \"masquerade\" ? \"default\" : \"destructive\"}>\n                                {rule.action}\n                              </Badge>\n                              <div className=\"flex-1\">\n                                <div className=\"flex items-center gap-2 text-sm\">\n                                  <span className=\"font-medium\">Chain: {rule.chain}</span>\n                                  {rule.protocol && <Badge variant=\"outline\">{rule.protocol}</Badge>}\n                                  {rule[\"dst-port\"] && <span className=\"text-muted-foreground\">Port: {rule[\"dst-port\"]}</span>}\n                                </div>\n                                {rule.comment && (\n                                  <p className=\"text-xs text-muted-foreground mt-1\">{rule.comment}</p>\n                                )}\n                                {(rule[\"src-address\"] || rule[\"dst-address\"]) && (\n                                  <p className=\"text-xs text-muted-foreground\">\n                                    {rule[\"src-address\"] && `Src: ${rule[\"src-address\"]}`}\n                                    {rule[\"src-address\"] && rule[\"dst-address\"] && \" | \"}\n                                    {rule[\"dst-address\"] && `Dst: ${rule[\"dst-address\"]}`}\n                                  </p>\n                                )}\n                              </div>\n                            </div>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => toggleFirewallRule(rule[\".id\"], rule.disabled === \"true\")}\n                              data-testid={`button-toggle-rule-${index}`}\n                            >\n                              {rule.disabled === \"true\" ? (\n                                <Eye className=\"w-4 h-4\" />\n                              ) : (\n                                <EyeOff className=\"w-4 h-4\" />\n                              )}\n                            </Button>\n                          </div>\n                        ))}\n                      </div>\n                    </ScrollArea>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"ip-pools\">\n              <Card className=\"bg-card/50\">\n                <CardHeader>\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <CardTitle className=\"flex items-center gap-2\">\n                        <Database className=\"w-5 h-5\" />\n                        IP Address Pools\n                      </CardTitle>\n                      <CardDescription>Manage IP address pools for DHCP and hotspot</CardDescription>\n                    </div>\n                    <Dialog open={showNewPoolDialog} onOpenChange={setShowNewPoolDialog}>\n                      <DialogTrigger asChild>\n                        <Button data-testid=\"button-add-pool\">\n                          <Plus className=\"w-4 h-4 mr-2\" />\n                          Add Pool\n                        </Button>\n                      </DialogTrigger>\n                      <DialogContent>\n                        <DialogHeader>\n                          <DialogTitle>Create IP Pool</DialogTitle>\n                          <DialogDescription>\n                            Add a new IP address pool to the router\n                          </DialogDescription>\n                        </DialogHeader>\n                        <div className=\"space-y-4\">\n                          <div>\n                            <Label htmlFor=\"pool-name\">Pool Name</Label>\n                            <Input\n                              id=\"pool-name\"\n                              value={newPoolName}\n                              onChange={(e) => setNewPoolName(e.target.value)}\n                              placeholder=\"hotspot-pool\"\n                              data-testid=\"input-pool-name\"\n                            />\n                          </div>\n                          <div>\n                            <Label htmlFor=\"pool-ranges\">IP Ranges</Label>\n                            <Input\n                              id=\"pool-ranges\"\n                              value={newPoolRanges}\n                              onChange={(e) => setNewPoolRanges(e.target.value)}\n                              placeholder=\"10.0.0.2-10.0.0.254\"\n                              data-testid=\"input-pool-ranges\"\n                            />\n                          </div>\n                        </div>\n                        <DialogFooter>\n                          <Button variant=\"outline\" onClick={() => setShowNewPoolDialog(false)}>\n                            Cancel\n                          </Button>\n                          <Button onClick={addIpPool} data-testid=\"button-create-pool\">\n                            Create Pool\n                          </Button>\n                        </DialogFooter>\n                      </DialogContent>\n                    </Dialog>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  {poolsLoading ? (\n                    <div className=\"flex items-center justify-center py-8\">\n                      <Loader2 className=\"w-6 h-6 animate-spin\" />\n                    </div>\n                  ) : (\n                    <div className=\"space-y-2\">\n                      {(ipPools?.data || []).map((pool: IpPool, index: number) => (\n                        <div\n                          key={pool[\".id\"]}\n                          className=\"flex items-center justify-between p-4 rounded-lg bg-muted/50\"\n                          data-testid={`ip-pool-${index}`}\n                        >\n                          <div>\n                            <p className=\"font-medium\">{pool.name}</p>\n                            <p className=\"text-sm text-muted-foreground\">{pool.ranges}</p>\n                          </div>\n                          <AlertDialog>\n                            <AlertDialogTrigger asChild>\n                              <Button variant=\"ghost\" size=\"sm\" data-testid={`button-delete-pool-${index}`}>\n                                <Trash2 className=\"w-4 h-4 text-red-400\" />\n                              </Button>\n                            </AlertDialogTrigger>\n                            <AlertDialogContent>\n                              <AlertDialogHeader>\n                                <AlertDialogTitle>Delete IP Pool?</AlertDialogTitle>\n                                <AlertDialogDescription>\n                                  This will remove the IP pool \"{pool.name}\" from the router.\n                                </AlertDialogDescription>\n                              </AlertDialogHeader>\n                              <AlertDialogFooter>\n                                <AlertDialogCancel>Cancel</AlertDialogCancel>\n                                <AlertDialogAction onClick={() => deleteIpPool(pool[\".id\"])}>Delete</AlertDialogAction>\n                              </AlertDialogFooter>\n                            </AlertDialogContent>\n                          </AlertDialog>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"walled-garden\">\n              <Card className=\"bg-card/50\">\n                <CardHeader>\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <CardTitle className=\"flex items-center gap-2\">\n                        <Globe className=\"w-5 h-5\" />\n                        Walled Garden\n                      </CardTitle>\n                      <CardDescription>Sites accessible before login (sync from dashboard settings)</CardDescription>\n                    </div>\n                    <Button onClick={syncWalledGarden} data-testid=\"button-sync-walled-garden\">\n                      <Upload className=\"w-4 h-4 mr-2\" />\n                      Sync to Router\n                    </Button>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  {walledGardenLoading ? (\n                    <div className=\"flex items-center justify-center py-8\">\n                      <Loader2 className=\"w-6 h-6 animate-spin\" />\n                    </div>\n                  ) : (\n                    <ScrollArea className=\"h-[300px]\">\n                      <div className=\"space-y-2\">\n                        {(walledGardenRouter?.data || []).map((entry: WalledGardenEntry, index: number) => (\n                          <div\n                            key={entry[\".id\"]}\n                            className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\"\n                            data-testid={`walled-garden-${index}`}\n                          >\n                            <div className=\"flex items-center gap-3\">\n                              <Globe className=\"w-4 h-4 text-muted-foreground\" />\n                              <div>\n                                <p className=\"font-medium\">{entry[\"dst-host\"]}</p>\n                                {entry.comment && (\n                                  <p className=\"text-xs text-muted-foreground\">{entry.comment}</p>\n                                )}\n                              </div>\n                            </div>\n                            <Badge variant={entry.action === \"allow\" ? \"default\" : \"destructive\"}>\n                              {entry.action}\n                            </Badge>\n                          </div>\n                        ))}\n                        {(!walledGardenRouter?.data || walledGardenRouter.data.length === 0) && (\n                          <div className=\"flex flex-col items-center justify-center py-8 text-muted-foreground\">\n                            <Globe className=\"w-8 h-8 mb-2\" />\n                            <p>No walled garden entries on router</p>\n                            <p className=\"text-sm\">Click \"Sync to Router\" to push entries from dashboard</p>\n                          </div>\n                        )}\n                      </div>\n                    </ScrollArea>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"backups\">\n              <Card className=\"bg-card/50\">\n                <CardHeader>\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <CardTitle className=\"flex items-center gap-2\">\n                        <Save className=\"w-5 h-5\" />\n                        Router Backups\n                      </CardTitle>\n                      <CardDescription>Configuration backup history</CardDescription>\n                    </div>\n                    <Dialog open={showBackupDialog} onOpenChange={setShowBackupDialog}>\n                      <DialogTrigger asChild>\n                        <Button data-testid=\"button-create-backup\">\n                          <Plus className=\"w-4 h-4 mr-2\" />\n                          Create Backup\n                        </Button>\n                      </DialogTrigger>\n                      <DialogContent>\n                        <DialogHeader>\n                          <DialogTitle>Create Router Backup</DialogTitle>\n                          <DialogDescription>\n                            Export the current router configuration\n                          </DialogDescription>\n                        </DialogHeader>\n                        <div className=\"space-y-4\">\n                          <div>\n                            <Label htmlFor=\"backup-name\">Backup Name (optional)</Label>\n                            <Input\n                              id=\"backup-name\"\n                              value={backupName}\n                              onChange={(e) => setBackupName(e.target.value)}\n                              placeholder=\"Pre-update backup\"\n                              data-testid=\"input-backup-name\"\n                            />\n                          </div>\n                          <div>\n                            <Label htmlFor=\"backup-notes\">Notes (optional)</Label>\n                            <Textarea\n                              id=\"backup-notes\"\n                              value={backupNotes}\n                              onChange={(e) => setBackupNotes(e.target.value)}\n                              placeholder=\"Notes about this backup...\"\n                              data-testid=\"input-backup-notes\"\n                            />\n                          </div>\n                        </div>\n                        <DialogFooter>\n                          <Button variant=\"outline\" onClick={() => setShowBackupDialog(false)}>\n                            Cancel\n                          </Button>\n                          <Button onClick={createBackup} data-testid=\"button-save-backup\">\n                            Create Backup\n                          </Button>\n                        </DialogFooter>\n                      </DialogContent>\n                    </Dialog>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  {backupsLoading ? (\n                    <div className=\"flex items-center justify-center py-8\">\n                      <Loader2 className=\"w-6 h-6 animate-spin\" />\n                    </div>\n                  ) : backups.length === 0 ? (\n                    <div className=\"flex flex-col items-center justify-center py-8 text-muted-foreground\">\n                      <Save className=\"w-8 h-8 mb-2\" />\n                      <p>No backups yet</p>\n                      <p className=\"text-sm\">Create your first backup to protect your configuration</p>\n                    </div>\n                  ) : (\n                    <div className=\"space-y-2\">\n                      {backups.map((backup, index) => (\n                        <div\n                          key={backup.id}\n                          className=\"flex items-center justify-between p-4 rounded-lg bg-muted/50\"\n                          data-testid={`backup-${index}`}\n                        >\n                          <div className=\"flex items-center gap-3\">\n                            <FileText className=\"w-5 h-5 text-muted-foreground\" />\n                            <div>\n                              <p className=\"font-medium\">{backup.name}</p>\n                              <p className=\"text-xs text-muted-foreground\">\n                                {backup.routerIdentity} | RouterOS {backup.routerVersion} | {new Date(backup.createdAt).toLocaleString()}\n                              </p>\n                            </div>\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => downloadBackup(backup.id, backup.name)}\n                              data-testid={`button-download-backup-${index}`}\n                            >\n                              <Download className=\"w-4 h-4\" />\n                            </Button>\n                            <AlertDialog>\n                              <AlertDialogTrigger asChild>\n                                <Button variant=\"ghost\" size=\"sm\" data-testid={`button-delete-backup-${index}`}>\n                                  <Trash2 className=\"w-4 h-4 text-red-400\" />\n                                </Button>\n                              </AlertDialogTrigger>\n                              <AlertDialogContent>\n                                <AlertDialogHeader>\n                                  <AlertDialogTitle>Delete Backup?</AlertDialogTitle>\n                                  <AlertDialogDescription>\n                                    This backup will be permanently deleted.\n                                  </AlertDialogDescription>\n                                </AlertDialogHeader>\n                                <AlertDialogFooter>\n                                  <AlertDialogCancel>Cancel</AlertDialogCancel>\n                                  <AlertDialogAction onClick={() => deleteBackup(backup.id)}>Delete</AlertDialogAction>\n                                </AlertDialogFooter>\n                              </AlertDialogContent>\n                            </AlertDialog>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"network\">\n              <div className=\"grid lg:grid-cols-2 gap-6\">\n                <Card className=\"bg-card/50\">\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <Server className=\"w-5 h-5\" />\n                      DHCP Leases\n                    </CardTitle>\n                    <CardDescription>Active DHCP leases on the router</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    {leasesLoading ? (\n                      <div className=\"flex items-center justify-center py-8\">\n                        <Loader2 className=\"w-6 h-6 animate-spin\" />\n                      </div>\n                    ) : (\n                      <ScrollArea className=\"h-[300px]\">\n                        <div className=\"space-y-2\">\n                          {(dhcpLeases?.data || []).slice(0, 20).map((lease: any, index: number) => (\n                            <div\n                              key={lease[\".id\"]}\n                              className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\"\n                              data-testid={`dhcp-lease-${index}`}\n                            >\n                              <div>\n                                <p className=\"font-medium\">{lease.address}</p>\n                                <p className=\"text-xs text-muted-foreground\">\n                                  {lease[\"mac-address\"]} | {lease[\"host-name\"] || \"Unknown\"}\n                                </p>\n                              </div>\n                              <Badge variant={lease.status === \"bound\" ? \"default\" : \"secondary\"}>\n                                {lease.status || \"active\"}\n                              </Badge>\n                            </div>\n                          ))}\n                          {(!dhcpLeases?.data || dhcpLeases.data.length === 0) && (\n                            <p className=\"text-center text-muted-foreground py-8\">No DHCP leases</p>\n                          )}\n                        </div>\n                      </ScrollArea>\n                    )}\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-card/50\">\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <Network className=\"w-5 h-5\" />\n                      ARP Table\n                    </CardTitle>\n                    <CardDescription>MAC address to IP mappings</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    {arpLoading ? (\n                      <div className=\"flex items-center justify-center py-8\">\n                        <Loader2 className=\"w-6 h-6 animate-spin\" />\n                      </div>\n                    ) : (\n                      <ScrollArea className=\"h-[300px]\">\n                        <div className=\"space-y-2\">\n                          {(arpTable?.data || []).slice(0, 20).map((entry: any, index: number) => (\n                            <div\n                              key={entry[\".id\"]}\n                              className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\"\n                              data-testid={`arp-entry-${index}`}\n                            >\n                              <div>\n                                <p className=\"font-medium\">{entry.address}</p>\n                                <p className=\"text-xs text-muted-foreground\">\n                                  {entry[\"mac-address\"]} | {entry.interface}\n                                </p>\n                              </div>\n                              <Badge variant={entry.complete === \"true\" ? \"default\" : \"secondary\"}>\n                                {entry.complete === \"true\" ? \"Complete\" : \"Incomplete\"}\n                              </Badge>\n                            </div>\n                          ))}\n                          {(!arpTable?.data || arpTable.data.length === 0) && (\n                            <p className=\"text-center text-muted-foreground py-8\">No ARP entries</p>\n                          )}\n                        </div>\n                      </ScrollArea>\n                    )}\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-card/50 lg:col-span-2\">\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <Activity className=\"w-5 h-5\" />\n                      Simple Queues (Bandwidth Limits)\n                    </CardTitle>\n                    <CardDescription>Per-user and per-target bandwidth management</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    {queuesLoading ? (\n                      <div className=\"flex items-center justify-center py-8\">\n                        <Loader2 className=\"w-6 h-6 animate-spin\" />\n                      </div>\n                    ) : (\n                      <ScrollArea className=\"h-[200px]\">\n                        <div className=\"space-y-2\">\n                          {(queues?.data || []).map((queue: any, index: number) => (\n                            <div\n                              key={queue[\".id\"]}\n                              className=\"flex items-center justify-between p-3 rounded-lg bg-muted/50\"\n                              data-testid={`queue-${index}`}\n                            >\n                              <div>\n                                <p className=\"font-medium\">{queue.name}</p>\n                                <p className=\"text-xs text-muted-foreground\">\n                                  Target: {queue.target} | Limit: {queue[\"max-limit\"] || \"unlimited\"}\n                                </p>\n                              </div>\n                              <div className=\"flex items-center gap-4 text-sm\">\n                                <div className=\"text-green-400\">\n                                  <ArrowDown className=\"w-3 h-3 inline mr-1\" />\n                                  {queue.bytes ? formatBytes(parseInt(queue.bytes.split(\"/\")[0] || \"0\")) : \"0 B\"}\n                                </div>\n                                <div className=\"text-cyan-400\">\n                                  <ArrowUp className=\"w-3 h-3 inline mr-1\" />\n                                  {queue.bytes ? formatBytes(parseInt(queue.bytes.split(\"/\")[1] || \"0\")) : \"0 B\"}\n                                </div>\n                                <Badge variant={queue.disabled === \"true\" ? \"secondary\" : \"default\"}>\n                                  {queue.disabled === \"true\" ? \"Disabled\" : \"Active\"}\n                                </Badge>\n                              </div>\n                            </div>\n                          ))}\n                          {(!queues?.data || queues.data.length === 0) && (\n                            <p className=\"text-center text-muted-foreground py-8\">No queues configured</p>\n                          )}\n                        </div>\n                      </ScrollArea>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n          </Tabs>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":58866,"size_tokens":null},"client/src/pages/sms-campaigns.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { \n  MessageSquare, \n  Send, \n  Users, \n  Filter, \n  Clock, \n  CheckCircle2, \n  XCircle, \n  Loader2,\n  FileText,\n  History,\n  Plus,\n  Phone,\n  Smartphone\n} from \"lucide-react\";\nimport { SiWhatsapp } from \"react-icons/si\";\nimport type { WifiUser } from \"@shared/schema\";\n\ntype MessageChannel = \"sms\" | \"whatsapp\";\n\ninterface SmsTemplate {\n  id: string;\n  name: string;\n  content: string;\n  category: string;\n}\n\ninterface SmsCampaign {\n  id: string;\n  name: string;\n  message: string;\n  recipientCount: number;\n  sentCount: number;\n  failedCount: number;\n  status: \"pending\" | \"sending\" | \"completed\" | \"failed\";\n  createdAt: string;\n}\n\nconst defaultTemplates: SmsTemplate[] = [\n  {\n    id: \"welcome\",\n    name: \"Welcome Message\",\n    content: \"Welcome to {isp_name} WiFi! Your account is now active. Enjoy fast and reliable internet. Need help? Call {support_phone}.\",\n    category: \"onboarding\",\n  },\n  {\n    id: \"expiry_reminder\",\n    name: \"Expiry Reminder\",\n    content: \"Hi {customer_name}, your WiFi plan expires in {hours} hours. Recharge now to stay connected! Visit our portal or dial *123#.\",\n    category: \"reminder\",\n  },\n  {\n    id: \"payment_confirm\",\n    name: \"Payment Confirmation\",\n    content: \"Payment of Ksh {amount} received! Your {plan_name} plan is now active until {expiry_date}. Receipt: {receipt}\",\n    category: \"payment\",\n  },\n  {\n    id: \"maintenance\",\n    name: \"Maintenance Notice\",\n    content: \"Scheduled maintenance on {date} from {start_time} to {end_time}. Service may be temporarily unavailable. We apologize for any inconvenience.\",\n    category: \"announcement\",\n  },\n  {\n    id: \"promo\",\n    name: \"Promotional Offer\",\n    content: \"Special offer! Get {discount}% off on our {plan_name} plan. Use code {promo_code} before {expiry_date}. Limited time only!\",\n    category: \"marketing\",\n  },\n  {\n    id: \"reactivation\",\n    name: \"Reactivation\",\n    content: \"We miss you! Your WiFi account has been inactive. Recharge now and get {bonus} bonus data. Visit our portal to reconnect.\",\n    category: \"marketing\",\n  },\n];\n\nexport default function SmsCampaignsPage() {\n  const { toast } = useToast();\n  const [selectedUsers, setSelectedUsers] = useState<string[]>([]);\n  const [message, setMessage] = useState(\"\");\n  const [campaignName, setCampaignName] = useState(\"\");\n  const [filterStatus, setFilterStatus] = useState<string>(\"all\");\n  const [filterAccountType, setFilterAccountType] = useState<string>(\"all\");\n  const [selectAll, setSelectAll] = useState(false);\n  const [showTemplateDialog, setShowTemplateDialog] = useState(false);\n  const [channel, setChannel] = useState<MessageChannel>(\"sms\");\n\n  const { data: users = [], isLoading: usersLoading } = useQuery<WifiUser[]>({\n    queryKey: [\"/api/wifi-users\"],\n  });\n\n  const { data: campaigns = [], isLoading: campaignsLoading } = useQuery<SmsCampaign[]>({\n    queryKey: [\"/api/sms/campaigns\"],\n  });\n\n  const sendSmsMutation = useMutation({\n    mutationFn: async (data: { name: string; message: string; recipients: string[] }) => {\n      return apiRequest(\"POST\", \"/api/sms/campaigns\", data);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"SMS Campaign Started\",\n        description: \"Your SMS messages are being sent to recipients.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/sms/campaigns\"] });\n      setSelectedUsers([]);\n      setMessage(\"\");\n      setCampaignName(\"\");\n      setSelectAll(false);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to Send SMS\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const sendWhatsAppMutation = useMutation({\n    mutationFn: async (data: { name: string; message: string; recipients: string[] }) => {\n      return apiRequest(\"POST\", \"/api/whatsapp/send\", data);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"WhatsApp Messages Sent\",\n        description: \"Your WhatsApp messages are being delivered to recipients.\",\n      });\n      setSelectedUsers([]);\n      setMessage(\"\");\n      setCampaignName(\"\");\n      setSelectAll(false);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to Send WhatsApp\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const filteredUsers = users.filter((user) => {\n    if (filterStatus !== \"all\" && user.status !== filterStatus) return false;\n    if (filterAccountType !== \"all\" && user.accountType !== filterAccountType) return false;\n    return true;\n  });\n\n  const handleSelectAll = (checked: boolean) => {\n    setSelectAll(checked);\n    if (checked) {\n      setSelectedUsers(filteredUsers.map((u) => u.id));\n    } else {\n      setSelectedUsers([]);\n    }\n  };\n\n  const handleUserSelect = (userId: string, checked: boolean) => {\n    if (checked) {\n      setSelectedUsers([...selectedUsers, userId]);\n    } else {\n      setSelectedUsers(selectedUsers.filter((id) => id !== userId));\n      setSelectAll(false);\n    }\n  };\n\n  const handleTemplateSelect = (template: SmsTemplate) => {\n    setMessage(template.content);\n    setShowTemplateDialog(false);\n  };\n\n  const handleSendCampaign = () => {\n    if (!campaignName.trim()) {\n      toast({\n        title: \"Campaign Name Required\",\n        description: \"Please enter a name for this campaign.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    if (!message.trim()) {\n      toast({\n        title: \"Message Required\",\n        description: \"Please enter a message to send.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    if (selectedUsers.length === 0) {\n      toast({\n        title: \"No Recipients\",\n        description: \"Please select at least one recipient.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const campaignData = {\n      name: campaignName,\n      message,\n      recipients: selectedUsers,\n    };\n\n    if (channel === \"whatsapp\") {\n      sendWhatsAppMutation.mutate(campaignData);\n    } else {\n      sendSmsMutation.mutate(campaignData);\n    }\n  };\n\n  const isSending = sendSmsMutation.isPending || sendWhatsAppMutation.isPending;\n  const characterCount = message.length;\n  const smsCount = Math.ceil(characterCount / 160) || 1;\n  const estimatedCost = channel === \"sms\" \n    ? selectedUsers.length * smsCount * 0.7 \n    : selectedUsers.length * 1.5; // WhatsApp is typically more expensive\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-foreground\" data-testid=\"text-page-title\">\n            Messaging\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Send bulk SMS or WhatsApp messages to your customers\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Badge variant=\"outline\" className=\"text-green-500 border-green-500/30\">\n            <SiWhatsapp className=\"w-3 h-3 mr-1\" />\n            WhatsApp\n          </Badge>\n          <Badge variant=\"outline\" className=\"text-cyan-400 border-cyan-400/30\">\n            <Phone className=\"w-3 h-3 mr-1\" />\n            SMS\n          </Badge>\n        </div>\n      </div>\n\n      <Tabs defaultValue=\"compose\" className=\"space-y-6\">\n        <TabsList className=\"bg-white/5 border border-white/10\">\n          <TabsTrigger value=\"compose\" data-testid=\"tab-compose\">\n            <Send className=\"w-4 h-4 mr-2\" />\n            Compose\n          </TabsTrigger>\n          <TabsTrigger value=\"history\" data-testid=\"tab-history\">\n            <History className=\"w-4 h-4 mr-2\" />\n            History\n          </TabsTrigger>\n          <TabsTrigger value=\"templates\" data-testid=\"tab-templates\">\n            <FileText className=\"w-4 h-4 mr-2\" />\n            Templates\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"compose\" className=\"space-y-6\">\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n            {/* Recipient Selection */}\n            <Card className=\"bg-card/50 border-white/10\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Users className=\"w-5 h-5 text-cyan-400\" />\n                  Select Recipients\n                </CardTitle>\n                <CardDescription>\n                  Choose customers to receive your message\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                {/* Filters */}\n                <div className=\"flex items-center gap-4 flex-wrap\">\n                  <div className=\"flex items-center gap-2\">\n                    <Filter className=\"w-4 h-4 text-muted-foreground\" />\n                    <Select value={filterStatus} onValueChange={setFilterStatus}>\n                      <SelectTrigger className=\"w-[140px] bg-white/5 border-white/10\" data-testid=\"select-status-filter\">\n                        <SelectValue placeholder=\"Status\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"all\">All Status</SelectItem>\n                        <SelectItem value=\"ACTIVE\">Active</SelectItem>\n                        <SelectItem value=\"EXPIRED\">Expired</SelectItem>\n                        <SelectItem value=\"SUSPENDED\">Suspended</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  <Select value={filterAccountType} onValueChange={setFilterAccountType}>\n                    <SelectTrigger className=\"w-[140px] bg-white/5 border-white/10\" data-testid=\"select-type-filter\">\n                      <SelectValue placeholder=\"Type\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All Types</SelectItem>\n                      <SelectItem value=\"HOTSPOT\">Hotspot</SelectItem>\n                      <SelectItem value=\"PPPOE\">PPPoE</SelectItem>\n                      <SelectItem value=\"STATIC\">Static</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                {/* Select All */}\n                <div className=\"flex items-center gap-2 p-3 bg-white/5 rounded-md\">\n                  <Checkbox\n                    id=\"select-all\"\n                    checked={selectAll}\n                    onCheckedChange={(checked) => handleSelectAll(checked === true)}\n                    data-testid=\"checkbox-select-all\"\n                  />\n                  <Label htmlFor=\"select-all\" className=\"text-sm cursor-pointer\">\n                    Select All ({filteredUsers.length} customers)\n                  </Label>\n                </div>\n\n                {/* User List */}\n                <ScrollArea className=\"h-[300px] rounded-md border border-white/10\">\n                  {usersLoading ? (\n                    <div className=\"flex items-center justify-center p-8\">\n                      <Loader2 className=\"w-6 h-6 animate-spin text-cyan-400\" />\n                    </div>\n                  ) : filteredUsers.length === 0 ? (\n                    <div className=\"flex flex-col items-center justify-center p-8 text-muted-foreground\">\n                      <Users className=\"w-8 h-8 mb-2\" />\n                      <p>No customers found</p>\n                    </div>\n                  ) : (\n                    <div className=\"p-2 space-y-1\">\n                      {filteredUsers.map((user) => (\n                        <div\n                          key={user.id}\n                          className=\"flex items-center gap-3 p-2 rounded-md hover-elevate\"\n                          data-testid={`user-row-${user.id}`}\n                        >\n                          <Checkbox\n                            id={user.id}\n                            checked={selectedUsers.includes(user.id)}\n                            onCheckedChange={(checked) => handleUserSelect(user.id, checked === true)}\n                          />\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-sm font-medium truncate\">\n                              {user.fullName || user.phoneNumber}\n                            </p>\n                            <p className=\"text-xs text-muted-foreground\">\n                              {user.phoneNumber}\n                            </p>\n                          </div>\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            {user.accountType}\n                          </Badge>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </ScrollArea>\n\n                <div className=\"flex items-center justify-between text-sm\">\n                  <span className=\"text-muted-foreground\">\n                    {selectedUsers.length} of {filteredUsers.length} selected\n                  </span>\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Message Composition */}\n            <Card className=\"bg-card/50 border-white/10\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <MessageSquare className=\"w-5 h-5 text-cyan-400\" />\n                  Compose Message\n                </CardTitle>\n                <CardDescription>\n                  Write your message or use a template\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"campaign-name\">Campaign Name</Label>\n                  <Input\n                    id=\"campaign-name\"\n                    placeholder=\"e.g., December Promotion\"\n                    value={campaignName}\n                    onChange={(e) => setCampaignName(e.target.value)}\n                    className=\"bg-white/5 border-white/10\"\n                    data-testid=\"input-campaign-name\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Channel</Label>\n                  <div className=\"flex gap-2\">\n                    <Button\n                      type=\"button\"\n                      variant={channel === \"sms\" ? \"default\" : \"outline\"}\n                      className={`flex-1 ${channel === \"sms\" ? \"\" : \"\"}`}\n                      onClick={() => setChannel(\"sms\")}\n                      data-testid=\"button-channel-sms\"\n                    >\n                      <Phone className=\"w-4 h-4 mr-2\" />\n                      SMS\n                    </Button>\n                    <Button\n                      type=\"button\"\n                      variant={channel === \"whatsapp\" ? \"default\" : \"outline\"}\n                      className={`flex-1 ${channel === \"whatsapp\" ? \"bg-green-600 hover:bg-green-700\" : \"\"}`}\n                      onClick={() => setChannel(\"whatsapp\")}\n                      data-testid=\"button-channel-whatsapp\"\n                    >\n                      <SiWhatsapp className=\"w-4 h-4 mr-2\" />\n                      WhatsApp\n                    </Button>\n                  </div>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <Label htmlFor=\"message\">Message</Label>\n                    <Dialog open={showTemplateDialog} onOpenChange={setShowTemplateDialog}>\n                      <DialogTrigger asChild>\n                        <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-use-template\">\n                          <FileText className=\"w-4 h-4 mr-1\" />\n                          Use Template\n                        </Button>\n                      </DialogTrigger>\n                      <DialogContent className=\"max-w-2xl\">\n                        <DialogHeader>\n                          <DialogTitle>SMS Templates</DialogTitle>\n                          <DialogDescription>\n                            Select a template to start with\n                          </DialogDescription>\n                        </DialogHeader>\n                        <div className=\"grid gap-3 max-h-[400px] overflow-y-auto\">\n                          {defaultTemplates.map((template) => (\n                            <div\n                              key={template.id}\n                              className=\"p-4 rounded-lg border border-white/10 hover-elevate cursor-pointer\"\n                              onClick={() => handleTemplateSelect(template)}\n                              data-testid={`template-${template.id}`}\n                            >\n                              <div className=\"flex items-center justify-between mb-2\">\n                                <span className=\"font-medium\">{template.name}</span>\n                                <Badge variant=\"outline\" className=\"text-xs\">\n                                  {template.category}\n                                </Badge>\n                              </div>\n                              <p className=\"text-sm text-muted-foreground\">\n                                {template.content}\n                              </p>\n                            </div>\n                          ))}\n                        </div>\n                      </DialogContent>\n                    </Dialog>\n                  </div>\n                  <Textarea\n                    id=\"message\"\n                    placeholder=\"Type your message here...\"\n                    value={message}\n                    onChange={(e) => setMessage(e.target.value)}\n                    className=\"min-h-[150px] bg-white/5 border-white/10\"\n                    data-testid=\"textarea-message\"\n                  />\n                  <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n                    <span>{characterCount} characters</span>\n                    <span>{smsCount} SMS ({smsCount > 1 ? \"multipart\" : \"single\"})</span>\n                  </div>\n                </div>\n\n                {/* Cost Estimate */}\n                <Card className=\"bg-white/5 border-white/10\">\n                  <CardContent className=\"p-4\">\n                    <h4 className=\"text-sm font-medium mb-3 flex items-center gap-2\">\n                      Cost Estimate\n                      <Badge variant=\"outline\" className={channel === \"whatsapp\" ? \"text-green-500\" : \"text-cyan-400\"}>\n                        {channel === \"whatsapp\" ? <SiWhatsapp className=\"w-3 h-3 mr-1\" /> : <Phone className=\"w-3 h-3 mr-1\" />}\n                        {channel.toUpperCase()}\n                      </Badge>\n                    </h4>\n                    <div className=\"space-y-2 text-sm\">\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-muted-foreground\">Recipients</span>\n                        <span>{selectedUsers.length}</span>\n                      </div>\n                      {channel === \"sms\" && (\n                        <>\n                          <div className=\"flex justify-between\">\n                            <span className=\"text-muted-foreground\">SMS per recipient</span>\n                            <span>{smsCount}</span>\n                          </div>\n                          <div className=\"flex justify-between\">\n                            <span className=\"text-muted-foreground\">Total SMS</span>\n                            <span>{selectedUsers.length * smsCount}</span>\n                          </div>\n                        </>\n                      )}\n                      {channel === \"whatsapp\" && (\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-muted-foreground\">Total Messages</span>\n                          <span>{selectedUsers.length}</span>\n                        </div>\n                      )}\n                      <div className=\"border-t border-white/10 pt-2 flex justify-between font-medium\">\n                        <span>Estimated Cost</span>\n                        <span className={channel === \"whatsapp\" ? \"text-green-500\" : \"text-cyan-400\"}>\n                          Ksh {estimatedCost.toFixed(2)}\n                        </span>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Button\n                  className={`w-full ${channel === \"whatsapp\" ? \"bg-green-600 hover:bg-green-700\" : \"\"}`}\n                  onClick={handleSendCampaign}\n                  disabled={isSending || selectedUsers.length === 0 || !message.trim()}\n                  data-testid=\"button-send-campaign\"\n                >\n                  {isSending ? (\n                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  ) : channel === \"whatsapp\" ? (\n                    <SiWhatsapp className=\"w-4 h-4 mr-2\" />\n                  ) : (\n                    <Send className=\"w-4 h-4 mr-2\" />\n                  )}\n                  Send {channel === \"whatsapp\" ? \"WhatsApp\" : \"SMS\"} to {selectedUsers.length} Recipients\n                </Button>\n              </CardContent>\n            </Card>\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"history\">\n          <Card className=\"bg-card/50 border-white/10\">\n            <CardHeader>\n              <CardTitle>Campaign History</CardTitle>\n              <CardDescription>View past SMS campaigns and their status</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {campaignsLoading ? (\n                <div className=\"flex items-center justify-center p-8\">\n                  <Loader2 className=\"w-6 h-6 animate-spin text-cyan-400\" />\n                </div>\n              ) : campaigns.length === 0 ? (\n                <div className=\"flex flex-col items-center justify-center p-8 text-muted-foreground\">\n                  <History className=\"w-12 h-12 mb-3\" />\n                  <p className=\"text-lg font-medium\">No campaigns yet</p>\n                  <p className=\"text-sm\">Send your first campaign to see it here</p>\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {campaigns.map((campaign) => (\n                    <div\n                      key={campaign.id}\n                      className=\"p-4 rounded-lg border border-white/10 hover-elevate\"\n                      data-testid={`campaign-${campaign.id}`}\n                    >\n                      <div className=\"flex items-start justify-between gap-4\">\n                        <div className=\"flex-1 min-w-0\">\n                          <h4 className=\"font-medium\">{campaign.name}</h4>\n                          <p className=\"text-sm text-muted-foreground line-clamp-2\">\n                            {campaign.message}\n                          </p>\n                        </div>\n                        <Badge\n                          variant={\n                            campaign.status === \"completed\"\n                              ? \"default\"\n                              : campaign.status === \"failed\"\n                              ? \"destructive\"\n                              : \"outline\"\n                          }\n                        >\n                          {campaign.status === \"sending\" && (\n                            <Loader2 className=\"w-3 h-3 mr-1 animate-spin\" />\n                          )}\n                          {campaign.status === \"completed\" && (\n                            <CheckCircle2 className=\"w-3 h-3 mr-1\" />\n                          )}\n                          {campaign.status === \"failed\" && (\n                            <XCircle className=\"w-3 h-3 mr-1\" />\n                          )}\n                          {campaign.status}\n                        </Badge>\n                      </div>\n                      <div className=\"flex items-center gap-4 mt-3 text-xs text-muted-foreground\">\n                        <span className=\"flex items-center gap-1\">\n                          <Users className=\"w-3 h-3\" />\n                          {campaign.recipientCount} recipients\n                        </span>\n                        <span className=\"flex items-center gap-1\">\n                          <CheckCircle2 className=\"w-3 h-3 text-green-400\" />\n                          {campaign.sentCount} sent\n                        </span>\n                        {campaign.failedCount > 0 && (\n                          <span className=\"flex items-center gap-1\">\n                            <XCircle className=\"w-3 h-3 text-red-400\" />\n                            {campaign.failedCount} failed\n                          </span>\n                        )}\n                        <span className=\"flex items-center gap-1\">\n                          <Clock className=\"w-3 h-3\" />\n                          {new Date(campaign.createdAt).toLocaleDateString()}\n                        </span>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"templates\">\n          <Card className=\"bg-card/50 border-white/10\">\n            <CardHeader className=\"flex flex-row items-center justify-between gap-4\">\n              <div>\n                <CardTitle>Message Templates</CardTitle>\n                <CardDescription>Pre-written messages for common scenarios</CardDescription>\n              </div>\n              <Button variant=\"outline\" data-testid=\"button-create-template\">\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Create Template\n              </Button>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {defaultTemplates.map((template) => (\n                  <Card\n                    key={template.id}\n                    className=\"bg-white/5 border-white/10 hover-elevate cursor-pointer\"\n                    onClick={() => {\n                      setMessage(template.content);\n                      toast({\n                        title: \"Template Loaded\",\n                        description: `\"${template.name}\" template has been loaded.`,\n                      });\n                    }}\n                    data-testid={`template-card-${template.id}`}\n                  >\n                    <CardHeader className=\"pb-2\">\n                      <div className=\"flex items-center justify-between\">\n                        <CardTitle className=\"text-base\">{template.name}</CardTitle>\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          {template.category}\n                        </Badge>\n                      </div>\n                    </CardHeader>\n                    <CardContent>\n                      <p className=\"text-sm text-muted-foreground\">\n                        {template.content}\n                      </p>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":28210,"size_tokens":null},"client/src/pages/tech-dashboard.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { motion } from \"framer-motion\";\nimport { Link } from \"wouter\";\nimport {\n  Users,\n  Router,\n  Wifi,\n  TrendingUp,\n  Clock,\n  CheckCircle,\n  AlertTriangle,\n  Phone,\n  Plus,\n} from \"lucide-react\";\nimport { MetricCard, MetricCardSkeleton } from \"@/components/metric-card\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport type { WifiUser } from \"@shared/schema\";\nimport { format } from \"date-fns\";\n\ninterface TechDashboardStats {\n  totalPppoeUsers: number;\n  totalStaticUsers: number;\n  activeUsers: number;\n  expiringUsers: WifiUser[];\n}\n\nexport default function TechDashboard() {\n  const { data: stats, isLoading } = useQuery<TechDashboardStats>({\n    queryKey: [\"/api/tech/stats\"],\n  });\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"tech-dashboard-page\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">Technician Dashboard</h1>\n          <p className=\"text-muted-foreground\">\n            Manage PPPoE and Static IP customers\n          </p>\n        </div>\n        <div className=\"flex items-center gap-3\">\n          <Link href=\"/tech/pppoe-users\">\n            <Button className=\"gradient-btn\" data-testid=\"button-add-pppoe\">\n              <Plus size={18} className=\"mr-2\" />\n              Add PPPoE User\n            </Button>\n          </Link>\n          <Link href=\"/tech/static-users\">\n            <Button variant=\"outline\" className=\"border-white/20\" data-testid=\"button-add-static\">\n              <Plus size={18} className=\"mr-2\" />\n              Add Static IP User\n            </Button>\n          </Link>\n        </div>\n      </div>\n\n      {/* Metrics */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        {isLoading ? (\n          <>\n            <MetricCardSkeleton />\n            <MetricCardSkeleton />\n            <MetricCardSkeleton />\n            <MetricCardSkeleton />\n          </>\n        ) : (\n          <>\n            <MetricCard\n              title=\"PPPoE Users\"\n              value={stats?.totalPppoeUsers || 0}\n              icon={<Router size={24} />}\n              gradient=\"primary\"\n            />\n            <MetricCard\n              title=\"Static IP Users\"\n              value={stats?.totalStaticUsers || 0}\n              icon={<Wifi size={24} />}\n              gradient=\"accent\"\n            />\n            <MetricCard\n              title=\"Active Users\"\n              value={stats?.activeUsers || 0}\n              icon={<CheckCircle size={24} />}\n            />\n            <MetricCard\n              title=\"Expiring Soon\"\n              value={stats?.expiringUsers?.length || 0}\n              icon={<AlertTriangle size={24} />}\n            />\n          </>\n        )}\n      </div>\n\n      {/* Quick Actions */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n        {/* PPPoE Management Card */}\n        <GlassPanel size=\"md\" className=\"glass-panel-hover\">\n          <div className=\"flex items-center gap-4 mb-4\">\n            <div className=\"w-12 h-12 rounded-xl bg-cyan-500/20 flex items-center justify-center\">\n              <Router size={24} className=\"text-cyan-400\" />\n            </div>\n            <div>\n              <h2 className=\"text-lg font-semibold text-white\">PPPoE Users</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Manage broadband customers with monthly billing\n              </p>\n            </div>\n          </div>\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center justify-between p-3 rounded-lg bg-white/5\">\n              <span className=\"text-sm text-muted-foreground\">Total Users</span>\n              <span className=\"font-semibold text-white\">{stats?.totalPppoeUsers || 0}</span>\n            </div>\n            <Link href=\"/tech/pppoe-users\">\n              <Button className=\"w-full\" variant=\"outline\" data-testid=\"button-manage-pppoe\">\n                Manage PPPoE Users\n              </Button>\n            </Link>\n          </div>\n        </GlassPanel>\n\n        {/* Static IP Management Card */}\n        <GlassPanel size=\"md\" className=\"glass-panel-hover\">\n          <div className=\"flex items-center gap-4 mb-4\">\n            <div className=\"w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center\">\n              <Wifi size={24} className=\"text-purple-400\" />\n            </div>\n            <div>\n              <h2 className=\"text-lg font-semibold text-white\">Static IP Users</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Manage dedicated IP customers\n              </p>\n            </div>\n          </div>\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center justify-between p-3 rounded-lg bg-white/5\">\n              <span className=\"text-sm text-muted-foreground\">Total Users</span>\n              <span className=\"font-semibold text-white\">{stats?.totalStaticUsers || 0}</span>\n            </div>\n            <Link href=\"/tech/static-users\">\n              <Button className=\"w-full\" variant=\"outline\" data-testid=\"button-manage-static\">\n                Manage Static IP Users\n              </Button>\n            </Link>\n          </div>\n        </GlassPanel>\n      </div>\n\n      {/* Expiring Users */}\n      <GlassPanel size=\"md\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <div className=\"flex items-center gap-2\">\n            <div className=\"p-2 rounded-lg bg-amber-500/20\">\n              <AlertTriangle size={18} className=\"text-amber-400\" />\n            </div>\n            <h2 className=\"text-lg font-semibold text-white\">Expiring Soon</h2>\n          </div>\n          <Link href=\"/tech/customers\">\n            <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-view-all-customers\">\n              View All\n            </Button>\n          </Link>\n        </div>\n\n        {isLoading ? (\n          <div className=\"space-y-3\">\n            {[1, 2, 3].map((i) => (\n              <div key={i} className=\"animate-pulse flex items-center gap-3 p-3 rounded-lg bg-white/5\">\n                <div className=\"w-10 h-10 rounded-full bg-white/10\" />\n                <div className=\"flex-1 space-y-2\">\n                  <div className=\"h-4 bg-white/10 rounded w-1/3\" />\n                  <div className=\"h-3 bg-white/10 rounded w-1/2\" />\n                </div>\n              </div>\n            ))}\n          </div>\n        ) : stats?.expiringUsers && stats.expiringUsers.length > 0 ? (\n          <div className=\"space-y-3\">\n            {stats.expiringUsers.slice(0, 5).map((user) => {\n              const expiryDate = user.expiryTime ? new Date(user.expiryTime) : null;\n              const daysUntilExpiry = expiryDate\n                ? Math.ceil((expiryDate.getTime() - Date.now()) / (1000 * 60 * 60 * 24))\n                : 0;\n\n              return (\n                <motion.div\n                  key={user.id}\n                  initial={{ opacity: 0, x: -10 }}\n                  animate={{ opacity: 1, x: 0 }}\n                  className=\"flex items-center gap-3 p-3 rounded-lg bg-white/5 border border-white/10\"\n                  data-testid={`expiring-user-${user.id}`}\n                >\n                  <div className=\"w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center\">\n                    <Phone size={18} className=\"text-amber-400\" />\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"font-medium text-white truncate\">\n                      {user.fullName || user.phoneNumber}\n                    </p>\n                    <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        {user.accountType}\n                      </Badge>\n                      <span>{user.phoneNumber}</span>\n                    </div>\n                  </div>\n                  <Badge\n                    variant=\"outline\"\n                    className={`text-xs ${\n                      daysUntilExpiry <= 1\n                        ? \"bg-red-500/20 text-red-400 border-red-500/30\"\n                        : \"bg-amber-500/20 text-amber-400 border-amber-500/30\"\n                    }`}\n                  >\n                    {daysUntilExpiry <= 0 ? \"Today\" : `${daysUntilExpiry}d left`}\n                  </Badge>\n                </motion.div>\n              );\n            })}\n          </div>\n        ) : (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            <Clock size={48} className=\"mx-auto mb-4 opacity-50\" />\n            <p>No users expiring in the next 5 days</p>\n          </div>\n        )}\n      </GlassPanel>\n    </div>\n  );\n}\n","path":null,"size_bytes":8908,"size_tokens":null},"client/src/layouts/tech-layout.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { useLocation, Link } from \"wouter\";\nimport { motion } from \"framer-motion\";\nimport {\n  Users,\n  Router,\n  Wifi,\n  LogOut,\n  Menu,\n  X,\n  User,\n  Settings,\n  Wrench,\n} from \"lucide-react\";\nimport { useState } from \"react\";\nimport { MeshBackground } from \"@/components/mesh-background\";\nimport { MnetiFiLogo } from \"@/components/mnetifi-logo\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarProvider,\n  SidebarTrigger,\n  SidebarFooter,\n} from \"@/components/ui/sidebar\";\n\ninterface TechLayoutProps {\n  children: React.ReactNode;\n}\n\ninterface SessionData {\n  user: {\n    id: string;\n    username: string;\n    role: string;\n    tenantId: string;\n  };\n  tenant?: {\n    id: string;\n    name: string;\n  };\n}\n\nconst menuItems = [\n  {\n    title: \"Dashboard\",\n    url: \"/tech\",\n    icon: Wrench,\n  },\n  {\n    title: \"PPPoE Users\",\n    url: \"/tech/pppoe-users\",\n    icon: Router,\n  },\n  {\n    title: \"Static IP Users\",\n    url: \"/tech/static-users\",\n    icon: Wifi,\n  },\n  {\n    title: \"All Customers\",\n    url: \"/tech/customers\",\n    icon: Users,\n  },\n];\n\nexport function TechLayout({ children }: TechLayoutProps) {\n  const [location] = useLocation();\n\n  const { data: session } = useQuery<SessionData>({\n    queryKey: [\"/api/auth/session\"],\n  });\n\n  const handleLogout = async () => {\n    try {\n      await fetch(\"/api/auth/logout\", { method: \"POST\" });\n      window.location.href = \"/login\";\n    } catch (error) {\n      console.error(\"Logout failed:\", error);\n    }\n  };\n\n  const sidebarStyle = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  } as React.CSSProperties;\n\n  return (\n    <>\n      <MeshBackground />\n      <SidebarProvider style={sidebarStyle}>\n        <div className=\"flex h-screen w-full relative z-10\">\n          <Sidebar className=\"border-r border-white/10\">\n            <SidebarHeader className=\"p-4 border-b border-white/10\">\n              <MnetiFiLogo size=\"sm\" />\n              <Badge variant=\"outline\" className=\"mt-2 bg-amber-500/20 text-amber-400 border-amber-500/30\">\n                <Wrench size={12} className=\"mr-1\" />\n                Technician Portal\n              </Badge>\n            </SidebarHeader>\n            <SidebarContent>\n              <SidebarGroup>\n                <SidebarGroupLabel>Navigation</SidebarGroupLabel>\n                <SidebarGroupContent>\n                  <SidebarMenu>\n                    {menuItems.map((item) => (\n                      <SidebarMenuItem key={item.title}>\n                        <SidebarMenuButton\n                          asChild\n                          isActive={location === item.url}\n                        >\n                          <Link href={item.url} data-testid={`nav-${item.title.toLowerCase().replace(' ', '-')}`}>\n                            <item.icon size={18} />\n                            <span>{item.title}</span>\n                          </Link>\n                        </SidebarMenuButton>\n                      </SidebarMenuItem>\n                    ))}\n                  </SidebarMenu>\n                </SidebarGroupContent>\n              </SidebarGroup>\n            </SidebarContent>\n            <SidebarFooter className=\"p-4 border-t border-white/10\">\n              <div className=\"flex items-center gap-3 mb-4\">\n                <div className=\"w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center\">\n                  <User size={18} className=\"text-amber-400\" />\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"text-sm font-medium text-white truncate\">\n                    {session?.user?.username || \"Technician\"}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground truncate\">\n                    {session?.tenant?.name || \"Loading...\"}\n                  </p>\n                </div>\n              </div>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                className=\"w-full border-white/20\"\n                onClick={handleLogout}\n                data-testid=\"button-logout\"\n              >\n                <LogOut size={16} className=\"mr-2\" />\n                Logout\n              </Button>\n            </SidebarFooter>\n          </Sidebar>\n\n          <div className=\"flex flex-col flex-1 overflow-hidden\">\n            <header className=\"flex items-center justify-between gap-4 p-4 border-b border-white/10 bg-background/50 backdrop-blur-xl\">\n              <div className=\"flex items-center gap-4\">\n                <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n                <div>\n                  <h1 className=\"text-lg font-semibold text-white\">Technician Portal</h1>\n                  <p className=\"text-xs text-muted-foreground\">\n                    Manage PPPoE & Static IP customers\n                  </p>\n                </div>\n              </div>\n            </header>\n            <main className=\"flex-1 overflow-auto\">{children}</main>\n          </div>\n        </div>\n      </SidebarProvider>\n    </>\n  );\n}\n","path":null,"size_bytes":5295,"size_tokens":null},"client/src/pages/tech-static-users.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { motion } from \"framer-motion\";\nimport {\n  Wifi,\n  Plus,\n  Search,\n  Phone,\n  User,\n  Globe,\n  Loader2,\n  CheckCircle,\n  XCircle,\n  Clock,\n  Pencil,\n  MoreVertical,\n} from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { WifiUser, Plan } from \"@shared/schema\";\nimport { format } from \"date-fns\";\n\nexport default function TechStaticUsersPage() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingUser, setEditingUser] = useState<WifiUser | null>(null);\n  const [formData, setFormData] = useState({\n    fullName: \"\",\n    phoneNumber: \"\",\n    email: \"\",\n    ipAddress: \"\",\n    macAddress: \"\",\n    planId: \"\",\n  });\n\n  const { data: users, isLoading: usersLoading } = useQuery<WifiUser[]>({\n    queryKey: [\"/api/wifi-users\", \"STATIC\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/wifi-users?type=STATIC\");\n      if (!res.ok) throw new Error(\"Failed to fetch users\");\n      return res.json();\n    },\n  });\n\n  const { data: plans } = useQuery<Plan[]>({\n    queryKey: [\"/api/plans\", \"STATIC\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/plans?type=STATIC\");\n      if (!res.ok) throw new Error(\"Failed to fetch plans\");\n      return res.json();\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      return apiRequest(\"POST\", \"/api/wifi-users\", {\n        ...data,\n        accountType: \"STATIC\",\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/wifi-users\"] });\n      setIsDialogOpen(false);\n      resetForm();\n      toast({\n        title: \"User Created\",\n        description: \"Static IP user has been created successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create user\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: typeof formData & { id: string }) => {\n      return apiRequest(\"PATCH\", `/api/wifi-users/${data.id}`, {\n        ...data,\n        accountType: \"STATIC\",\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/wifi-users\"] });\n      setIsDialogOpen(false);\n      setEditingUser(null);\n      resetForm();\n      toast({\n        title: \"User Updated\",\n        description: \"Static IP user has been updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update user\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      fullName: \"\",\n      phoneNumber: \"\",\n      email: \"\",\n      ipAddress: \"\",\n      macAddress: \"\",\n      planId: \"\",\n    });\n  };\n\n  const handleOpenCreate = () => {\n    resetForm();\n    setEditingUser(null);\n    setIsDialogOpen(true);\n  };\n\n  const handleOpenEdit = (user: WifiUser) => {\n    setEditingUser(user);\n    setFormData({\n      fullName: user.fullName || \"\",\n      phoneNumber: user.phoneNumber,\n      email: user.email || \"\",\n      ipAddress: user.ipAddress || \"\",\n      macAddress: user.macAddress || \"\",\n      planId: user.currentPlanId || \"\",\n    });\n    setIsDialogOpen(true);\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (editingUser) {\n      updateMutation.mutate({ ...formData, id: editingUser.id });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  const filteredUsers = users?.filter((user) => {\n    const search = searchQuery.toLowerCase();\n    return (\n      user.fullName?.toLowerCase().includes(search) ||\n      user.phoneNumber.toLowerCase().includes(search) ||\n      user.ipAddress?.toLowerCase().includes(search)\n    );\n  });\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"ACTIVE\":\n        return (\n          <Badge variant=\"outline\" className=\"bg-purple-500/20 text-purple-400 border-purple-500/30\">\n            <CheckCircle size={12} className=\"mr-1\" />\n            Active\n          </Badge>\n        );\n      case \"EXPIRED\":\n        return (\n          <Badge variant=\"outline\" className=\"bg-amber-500/20 text-amber-400 border-amber-500/30\">\n            <Clock size={12} className=\"mr-1\" />\n            Expired\n          </Badge>\n        );\n      case \"SUSPENDED\":\n        return (\n          <Badge variant=\"outline\" className=\"bg-red-500/20 text-red-400 border-red-500/30\">\n            <XCircle size={12} className=\"mr-1\" />\n            Suspended\n          </Badge>\n        );\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat(\"en-KE\", {\n      style: \"currency\",\n      currency: \"KES\",\n      minimumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"tech-static-users-page\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">Static IP Users</h1>\n          <p className=\"text-muted-foreground\">\n            Manage dedicated IP customers with monthly billing\n          </p>\n        </div>\n        <Button className=\"gradient-btn\" onClick={handleOpenCreate} data-testid=\"button-add-user\">\n          <Plus size={18} className=\"mr-2\" />\n          Add Static IP User\n        </Button>\n      </div>\n\n      {/* Search */}\n      <GlassPanel size=\"sm\">\n        <div className=\"flex items-center gap-4\">\n          <div className=\"flex-1\">\n            <GlassInput\n              placeholder=\"Search by name, phone, or IP address...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              icon={<Search size={16} />}\n              data-testid=\"input-search\"\n            />\n          </div>\n        </div>\n      </GlassPanel>\n\n      {/* Users List */}\n      {usersLoading ? (\n        <div className=\"space-y-4\">\n          {[1, 2, 3].map((i) => (\n            <div key={i} className=\"animate-pulse glass-panel p-4 flex items-center gap-4\">\n              <div className=\"w-12 h-12 rounded-full bg-white/10\" />\n              <div className=\"flex-1 space-y-2\">\n                <div className=\"h-4 bg-white/10 rounded w-1/4\" />\n                <div className=\"h-3 bg-white/10 rounded w-1/3\" />\n              </div>\n            </div>\n          ))}\n        </div>\n      ) : filteredUsers && filteredUsers.length > 0 ? (\n        <div className=\"space-y-4\">\n          {filteredUsers.map((user, index) => {\n            const plan = plans?.find((p) => p.id === user.currentPlanId);\n            return (\n              <motion.div\n                key={user.id}\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: index * 0.05 }}\n              >\n                <GlassPanel size=\"sm\" className=\"flex items-center gap-4 p-4\">\n                  <div className=\"w-12 h-12 rounded-full bg-purple-500/20 flex items-center justify-center\">\n                    <Wifi size={20} className=\"text-purple-400\" />\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <p className=\"font-semibold text-white truncate\">\n                        {user.fullName || \"Unnamed User\"}\n                      </p>\n                      {getStatusBadge(user.status)}\n                    </div>\n                    <div className=\"flex items-center gap-4 text-sm text-muted-foreground flex-wrap\">\n                      <span className=\"flex items-center gap-1\">\n                        <Phone size={12} />\n                        {user.phoneNumber}\n                      </span>\n                      {user.ipAddress && (\n                        <span className=\"flex items-center gap-1\">\n                          <Globe size={12} />\n                          {user.ipAddress}\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                  <div className=\"text-right hidden sm:block\">\n                    {plan && (\n                      <p className=\"font-semibold text-white\">{plan.name}</p>\n                    )}\n                    {user.expiryTime && (\n                      <p className=\"text-xs text-muted-foreground\">\n                        Expires: {format(new Date(user.expiryTime), \"MMM d, yyyy\")}\n                      </p>\n                    )}\n                  </div>\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button size=\"icon\" variant=\"ghost\" data-testid={`button-menu-${user.id}`}>\n                        <MoreVertical size={16} />\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\">\n                      <DropdownMenuItem onClick={() => handleOpenEdit(user)}>\n                        <Pencil size={14} className=\"mr-2\" />\n                        Edit User\n                      </DropdownMenuItem>\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </GlassPanel>\n              </motion.div>\n            );\n          })}\n        </div>\n      ) : (\n        <GlassPanel size=\"lg\" className=\"text-center py-12\">\n          <Wifi size={48} className=\"mx-auto mb-4 text-muted-foreground opacity-50\" />\n          <h3 className=\"text-lg font-semibold text-white mb-2\">No Static IP Users</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            Add your first Static IP customer to get started\n          </p>\n          <Button className=\"gradient-btn\" onClick={handleOpenCreate}>\n            <Plus size={18} className=\"mr-2\" />\n            Add First User\n          </Button>\n        </GlassPanel>\n      )}\n\n      {/* Create/Edit Dialog */}\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"bg-card border-white/10\">\n          <DialogHeader>\n            <DialogTitle className=\"text-white\">\n              {editingUser ? \"Edit Static IP User\" : \"Add Static IP User\"}\n            </DialogTitle>\n          </DialogHeader>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Full Name</Label>\n                <Input\n                  placeholder=\"John Doe\"\n                  value={formData.fullName}\n                  onChange={(e) => setFormData({ ...formData, fullName: e.target.value })}\n                  required\n                  data-testid=\"input-fullname\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Phone Number</Label>\n                <Input\n                  placeholder=\"0712345678\"\n                  value={formData.phoneNumber}\n                  onChange={(e) => setFormData({ ...formData, phoneNumber: e.target.value })}\n                  required\n                  data-testid=\"input-phone\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Email (Optional)</Label>\n              <Input\n                type=\"email\"\n                placeholder=\"john@example.com\"\n                value={formData.email}\n                onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                data-testid=\"input-email\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>IP Address</Label>\n                <Input\n                  placeholder=\"192.168.1.100\"\n                  value={formData.ipAddress}\n                  onChange={(e) => setFormData({ ...formData, ipAddress: e.target.value })}\n                  required\n                  data-testid=\"input-ip\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>MAC Address (Optional)</Label>\n                <Input\n                  placeholder=\"AA:BB:CC:DD:EE:FF\"\n                  value={formData.macAddress}\n                  onChange={(e) => setFormData({ ...formData, macAddress: e.target.value })}\n                  data-testid=\"input-mac\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Select Plan</Label>\n              <Select\n                value={formData.planId}\n                onValueChange={(value) => setFormData({ ...formData, planId: value })}\n              >\n                <SelectTrigger data-testid=\"select-plan\">\n                  <SelectValue placeholder=\"Choose a plan\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {plans?.map((plan) => (\n                    <SelectItem key={plan.id} value={plan.id}>\n                      {plan.name} - {formatCurrency(plan.price)}/month\n                      {plan.speedMbps && ` (${plan.speedMbps} Mbps)`}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <DialogFooter>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => setIsDialogOpen(false)}\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                className=\"gradient-btn\"\n                disabled={createMutation.isPending || updateMutation.isPending}\n                data-testid=\"button-submit\"\n              >\n                {(createMutation.isPending || updateMutation.isPending) && (\n                  <Loader2 size={16} className=\"mr-2 animate-spin\" />\n                )}\n                {editingUser ? \"Update User\" : \"Create User\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":15070,"size_tokens":null},"client/src/pages/static-plans.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { motion } from \"framer-motion\";\nimport {\n  Wifi,\n  Plus,\n  Pencil,\n  Trash2,\n  Loader2,\n  Zap,\n  Clock,\n  Globe,\n  Smartphone,\n} from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { Plan } from \"@shared/schema\";\n\nexport default function StaticPlansPage() {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingPlan, setEditingPlan] = useState<Plan | null>(null);\n  const [formData, setFormData] = useState({\n    name: \"\",\n    description: \"\",\n    price: \"\",\n    speedMbps: \"\",\n    uploadLimit: \"\",\n    downloadLimit: \"\",\n    maxDevices: \"1\",\n  });\n\n  const { data: plans, isLoading } = useQuery<Plan[]>({\n    queryKey: [\"/api/plans?type=STATIC\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      const price = parseInt(data.price) || 0;\n      const speedMbps = parseInt(data.speedMbps) || 0;\n      const maxDevices = parseInt(data.maxDevices) || 1;\n      if (price <= 0 || speedMbps <= 0) {\n        throw new Error(\"Price and speed must be valid positive numbers\");\n      }\n      return apiRequest(\"POST\", \"/api/plans\", {\n        name: data.name,\n        description: data.description,\n        price,\n        planType: \"STATIC\",\n        speedMbps,\n        durationSeconds: 30 * 24 * 60 * 60, // 30 days\n        uploadLimit: data.uploadLimit || `${speedMbps}M`,\n        downloadLimit: data.downloadLimit || `${speedMbps}M`,\n        maxDevices,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/plans?type=STATIC\"] });\n      setIsDialogOpen(false);\n      resetForm();\n      toast({\n        title: \"Plan Created\",\n        description: \"Static IP plan has been created successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create plan\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: typeof formData & { id: string }) => {\n      const price = parseInt(data.price) || 0;\n      const speedMbps = parseInt(data.speedMbps) || 0;\n      const maxDevices = parseInt(data.maxDevices) || 1;\n      if (price <= 0 || speedMbps <= 0) {\n        throw new Error(\"Price and speed must be valid positive numbers\");\n      }\n      return apiRequest(\"PATCH\", `/api/plans/${data.id}`, {\n        name: data.name,\n        description: data.description,\n        price,\n        speedMbps,\n        uploadLimit: data.uploadLimit || `${speedMbps}M`,\n        downloadLimit: data.downloadLimit || `${speedMbps}M`,\n        maxDevices,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/plans?type=STATIC\"] });\n      setIsDialogOpen(false);\n      setEditingPlan(null);\n      resetForm();\n      toast({\n        title: \"Plan Updated\",\n        description: \"Static IP plan has been updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update plan\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/plans/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/plans?type=STATIC\"] });\n      toast({\n        title: \"Plan Deleted\",\n        description: \"Static IP plan has been deleted.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to delete plan\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      name: \"\",\n      description: \"\",\n      price: \"\",\n      speedMbps: \"\",\n      uploadLimit: \"\",\n      downloadLimit: \"\",\n      maxDevices: \"1\",\n    });\n  };\n\n  const handleOpenCreate = () => {\n    resetForm();\n    setEditingPlan(null);\n    setIsDialogOpen(true);\n  };\n\n  const handleOpenEdit = (plan: Plan) => {\n    setEditingPlan(plan);\n    setFormData({\n      name: plan.name,\n      description: plan.description || \"\",\n      price: plan.price.toString(),\n      speedMbps: plan.speedMbps?.toString() || \"\",\n      uploadLimit: plan.uploadLimit || \"\",\n      downloadLimit: plan.downloadLimit || \"\",\n      maxDevices: plan.maxDevices?.toString() || \"1\",\n    });\n    setIsDialogOpen(true);\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (editingPlan) {\n      updateMutation.mutate({ ...formData, id: editingPlan.id });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat(\"en-KE\", {\n      style: \"currency\",\n      currency: \"KES\",\n      minimumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"static-plans-page\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">Static IP Plans</h1>\n          <p className=\"text-muted-foreground\">\n            Manage dedicated IP packages with different speeds\n          </p>\n        </div>\n        <Button className=\"gradient-btn\" onClick={handleOpenCreate} data-testid=\"button-create-plan\">\n          <Plus size={18} className=\"mr-2\" />\n          Create Plan\n        </Button>\n      </div>\n\n      {/* Plans Grid */}\n      {isLoading ? (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n          {[1, 2, 3].map((i) => (\n            <div key={i} className=\"animate-pulse glass-panel p-6\">\n              <div className=\"h-6 bg-white/10 rounded w-2/3 mb-4\" />\n              <div className=\"h-10 bg-white/10 rounded w-1/2 mb-4\" />\n              <div className=\"space-y-2\">\n                <div className=\"h-4 bg-white/10 rounded w-full\" />\n                <div className=\"h-4 bg-white/10 rounded w-3/4\" />\n              </div>\n            </div>\n          ))}\n        </div>\n      ) : plans && plans.length > 0 ? (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n          {plans.map((plan, index) => (\n            <motion.div\n              key={plan.id}\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: index * 0.1 }}\n            >\n              <GlassPanel size=\"md\" className=\"relative\">\n                <div className=\"absolute top-4 right-4 flex items-center gap-2\">\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={() => handleOpenEdit(plan)}\n                    data-testid={`button-edit-plan-${plan.id}`}\n                  >\n                    <Pencil size={16} />\n                  </Button>\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={() => deleteMutation.mutate(plan.id)}\n                    data-testid={`button-delete-plan-${plan.id}`}\n                  >\n                    <Trash2 size={16} />\n                  </Button>\n                </div>\n\n                <div className=\"flex items-center gap-3 mb-4\">\n                  <div className=\"w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center\">\n                    <Wifi size={24} className=\"text-purple-400\" />\n                  </div>\n                  <div>\n                    <h3 className=\"font-semibold text-white\">{plan.name}</h3>\n                    <Badge variant=\"outline\" className=\"text-xs bg-purple-500/20 text-purple-400 border-purple-500/30\">\n                      Static IP\n                    </Badge>\n                  </div>\n                </div>\n\n                <div className=\"mb-4\">\n                  <p className=\"text-3xl font-bold gradient-text-accent\">\n                    {formatCurrency(plan.price)}\n                  </p>\n                  <p className=\"text-sm text-muted-foreground\">per month</p>\n                </div>\n\n                <div className=\"space-y-2 text-sm\">\n                  {plan.speedMbps && (\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <Zap size={14} className=\"text-purple-400\" />\n                      <span>{plan.speedMbps} Mbps Speed</span>\n                    </div>\n                  )}\n                  <div className=\"flex items-center gap-2 text-muted-foreground\">\n                    <Globe size={14} className=\"text-cyan-400\" />\n                    <span>Dedicated IP Address</span>\n                  </div>\n                  <div className=\"flex items-center gap-2 text-muted-foreground\">\n                    <Clock size={14} className=\"text-amber-400\" />\n                    <span>30 Days Validity</span>\n                  </div>\n                  {plan.description && (\n                    <p className=\"text-muted-foreground mt-2\">{plan.description}</p>\n                  )}\n                </div>\n              </GlassPanel>\n            </motion.div>\n          ))}\n        </div>\n      ) : (\n        <GlassPanel size=\"lg\" className=\"text-center py-12\">\n          <Wifi size={48} className=\"mx-auto mb-4 text-muted-foreground opacity-50\" />\n          <h3 className=\"text-lg font-semibold text-white mb-2\">No Static IP Plans</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            Create your first Static IP plan to start managing dedicated IP customers\n          </p>\n          <Button className=\"gradient-btn\" onClick={handleOpenCreate}>\n            <Plus size={18} className=\"mr-2\" />\n            Create First Plan\n          </Button>\n        </GlassPanel>\n      )}\n\n      {/* Create/Edit Dialog */}\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"bg-card border-white/10\">\n          <DialogHeader>\n            <DialogTitle className=\"text-white\">\n              {editingPlan ? \"Edit Static IP Plan\" : \"Create Static IP Plan\"}\n            </DialogTitle>\n          </DialogHeader>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label>Plan Name</Label>\n              <Input\n                placeholder=\"e.g., Business 10 Mbps\"\n                value={formData.name}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                required\n                data-testid=\"input-plan-name\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Speed (Mbps)</Label>\n                <Input\n                  type=\"number\"\n                  placeholder=\"10\"\n                  value={formData.speedMbps}\n                  onChange={(e) => setFormData({ ...formData, speedMbps: e.target.value })}\n                  required\n                  data-testid=\"input-speed\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Price (KES/month)</Label>\n                <Input\n                  type=\"number\"\n                  placeholder=\"2500\"\n                  value={formData.price}\n                  onChange={(e) => setFormData({ ...formData, price: e.target.value })}\n                  required\n                  data-testid=\"input-price\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Max Devices per Voucher</Label>\n              <div className=\"flex items-center gap-2\">\n                <Smartphone size={16} className=\"text-muted-foreground\" />\n                <Input\n                  type=\"number\"\n                  min=\"1\"\n                  max=\"20\"\n                  placeholder=\"1\"\n                  value={formData.maxDevices}\n                  onChange={(e) => setFormData({ ...formData, maxDevices: e.target.value })}\n                  data-testid=\"input-max-devices\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Description (Optional)</Label>\n              <Textarea\n                placeholder=\"Plan description...\"\n                value={formData.description}\n                onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                data-testid=\"input-description\"\n              />\n            </div>\n\n            <DialogFooter>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => setIsDialogOpen(false)}\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                className=\"gradient-btn\"\n                disabled={createMutation.isPending || updateMutation.isPending}\n                data-testid=\"button-submit-plan\"\n              >\n                {(createMutation.isPending || updateMutation.isPending) && (\n                  <Loader2 size={16} className=\"mr-2 animate-spin\" />\n                )}\n                {editingPlan ? \"Update Plan\" : \"Create Plan\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":13946,"size_tokens":null},"client/src/pages/pppoe-plans.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { motion } from \"framer-motion\";\nimport {\n  Router,\n  Plus,\n  Pencil,\n  Trash2,\n  Loader2,\n  Zap,\n  Clock,\n  Smartphone,\n  Check,\n  X,\n} from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { Plan } from \"@shared/schema\";\n\nexport default function PPPoEPlansPage() {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingPlan, setEditingPlan] = useState<Plan | null>(null);\n  const [formData, setFormData] = useState({\n    name: \"\",\n    description: \"\",\n    price: \"\",\n    speedMbps: \"\",\n    uploadLimit: \"\",\n    downloadLimit: \"\",\n    maxDevices: \"1\",\n  });\n\n  const { data: plans, isLoading } = useQuery<Plan[]>({\n    queryKey: [\"/api/plans?type=PPPOE\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      const price = parseInt(data.price) || 0;\n      const speedMbps = parseInt(data.speedMbps) || 0;\n      const maxDevices = parseInt(data.maxDevices) || 1;\n      if (price <= 0 || speedMbps <= 0) {\n        throw new Error(\"Price and speed must be valid positive numbers\");\n      }\n      return apiRequest(\"POST\", \"/api/plans\", {\n        name: data.name,\n        description: data.description,\n        price,\n        planType: \"PPPOE\",\n        speedMbps,\n        durationSeconds: 30 * 24 * 60 * 60, // 30 days\n        uploadLimit: data.uploadLimit || `${speedMbps}M`,\n        downloadLimit: data.downloadLimit || `${speedMbps}M`,\n        maxDevices,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/plans?type=PPPOE\"] });\n      setIsDialogOpen(false);\n      resetForm();\n      toast({\n        title: \"Plan Created\",\n        description: \"PPPoE plan has been created successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create plan\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: typeof formData & { id: string }) => {\n      const price = parseInt(data.price) || 0;\n      const speedMbps = parseInt(data.speedMbps) || 0;\n      const maxDevices = parseInt(data.maxDevices) || 1;\n      if (price <= 0 || speedMbps <= 0) {\n        throw new Error(\"Price and speed must be valid positive numbers\");\n      }\n      return apiRequest(\"PATCH\", `/api/plans/${data.id}`, {\n        name: data.name,\n        description: data.description,\n        price,\n        speedMbps,\n        uploadLimit: data.uploadLimit || `${speedMbps}M`,\n        downloadLimit: data.downloadLimit || `${speedMbps}M`,\n        maxDevices,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/plans?type=PPPOE\"] });\n      setIsDialogOpen(false);\n      setEditingPlan(null);\n      resetForm();\n      toast({\n        title: \"Plan Updated\",\n        description: \"PPPoE plan has been updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update plan\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/plans/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/plans?type=PPPOE\"] });\n      toast({\n        title: \"Plan Deleted\",\n        description: \"PPPoE plan has been deleted.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to delete plan\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      name: \"\",\n      description: \"\",\n      price: \"\",\n      speedMbps: \"\",\n      uploadLimit: \"\",\n      downloadLimit: \"\",\n      maxDevices: \"1\",\n    });\n  };\n\n  const handleOpenCreate = () => {\n    resetForm();\n    setEditingPlan(null);\n    setIsDialogOpen(true);\n  };\n\n  const handleOpenEdit = (plan: Plan) => {\n    setEditingPlan(plan);\n    setFormData({\n      name: plan.name,\n      description: plan.description || \"\",\n      price: plan.price.toString(),\n      speedMbps: plan.speedMbps?.toString() || \"\",\n      uploadLimit: plan.uploadLimit || \"\",\n      downloadLimit: plan.downloadLimit || \"\",\n      maxDevices: plan.maxDevices?.toString() || \"1\",\n    });\n    setIsDialogOpen(true);\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (editingPlan) {\n      updateMutation.mutate({ ...formData, id: editingPlan.id });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat(\"en-KE\", {\n      style: \"currency\",\n      currency: \"KES\",\n      minimumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"pppoe-plans-page\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">PPPoE Plans</h1>\n          <p className=\"text-muted-foreground\">\n            Manage monthly broadband packages with different speeds\n          </p>\n        </div>\n        <Button className=\"gradient-btn\" onClick={handleOpenCreate} data-testid=\"button-create-plan\">\n          <Plus size={18} className=\"mr-2\" />\n          Create Plan\n        </Button>\n      </div>\n\n      {/* Plans Grid */}\n      {isLoading ? (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n          {[1, 2, 3].map((i) => (\n            <div key={i} className=\"animate-pulse glass-panel p-6\">\n              <div className=\"h-6 bg-white/10 rounded w-2/3 mb-4\" />\n              <div className=\"h-10 bg-white/10 rounded w-1/2 mb-4\" />\n              <div className=\"space-y-2\">\n                <div className=\"h-4 bg-white/10 rounded w-full\" />\n                <div className=\"h-4 bg-white/10 rounded w-3/4\" />\n              </div>\n            </div>\n          ))}\n        </div>\n      ) : plans && plans.length > 0 ? (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n          {plans.map((plan, index) => (\n            <motion.div\n              key={plan.id}\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: index * 0.1 }}\n            >\n              <GlassPanel size=\"md\" className=\"relative\">\n                <div className=\"absolute top-4 right-4 flex items-center gap-2\">\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={() => handleOpenEdit(plan)}\n                    data-testid={`button-edit-plan-${plan.id}`}\n                  >\n                    <Pencil size={16} />\n                  </Button>\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={() => deleteMutation.mutate(plan.id)}\n                    data-testid={`button-delete-plan-${plan.id}`}\n                  >\n                    <Trash2 size={16} />\n                  </Button>\n                </div>\n\n                <div className=\"flex items-center gap-3 mb-4\">\n                  <div className=\"w-12 h-12 rounded-xl bg-cyan-500/20 flex items-center justify-center\">\n                    <Router size={24} className=\"text-cyan-400\" />\n                  </div>\n                  <div>\n                    <h3 className=\"font-semibold text-white\">{plan.name}</h3>\n                    <Badge variant=\"outline\" className=\"text-xs bg-cyan-500/20 text-cyan-400 border-cyan-500/30\">\n                      PPPoE\n                    </Badge>\n                  </div>\n                </div>\n\n                <div className=\"mb-4\">\n                  <p className=\"text-3xl font-bold gradient-text\">\n                    {formatCurrency(plan.price)}\n                  </p>\n                  <p className=\"text-sm text-muted-foreground\">per month</p>\n                </div>\n\n                <div className=\"space-y-2 text-sm\">\n                  {plan.speedMbps && (\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <Zap size={14} className=\"text-cyan-400\" />\n                      <span>{plan.speedMbps} Mbps Speed</span>\n                    </div>\n                  )}\n                  <div className=\"flex items-center gap-2 text-muted-foreground\">\n                    <Clock size={14} className=\"text-purple-400\" />\n                    <span>30 Days Validity</span>\n                  </div>\n                  {plan.description && (\n                    <p className=\"text-muted-foreground mt-2\">{plan.description}</p>\n                  )}\n                </div>\n              </GlassPanel>\n            </motion.div>\n          ))}\n        </div>\n      ) : (\n        <GlassPanel size=\"lg\" className=\"text-center py-12\">\n          <Router size={48} className=\"mx-auto mb-4 text-muted-foreground opacity-50\" />\n          <h3 className=\"text-lg font-semibold text-white mb-2\">No PPPoE Plans</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            Create your first PPPoE plan to start managing broadband customers\n          </p>\n          <Button className=\"gradient-btn\" onClick={handleOpenCreate}>\n            <Plus size={18} className=\"mr-2\" />\n            Create First Plan\n          </Button>\n        </GlassPanel>\n      )}\n\n      {/* Create/Edit Dialog */}\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"bg-card border-white/10\">\n          <DialogHeader>\n            <DialogTitle className=\"text-white\">\n              {editingPlan ? \"Edit PPPoE Plan\" : \"Create PPPoE Plan\"}\n            </DialogTitle>\n          </DialogHeader>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label>Plan Name</Label>\n              <Input\n                placeholder=\"e.g., Basic 5 Mbps\"\n                value={formData.name}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                required\n                data-testid=\"input-plan-name\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Speed (Mbps)</Label>\n                <Input\n                  type=\"number\"\n                  placeholder=\"5\"\n                  value={formData.speedMbps}\n                  onChange={(e) => setFormData({ ...formData, speedMbps: e.target.value })}\n                  required\n                  data-testid=\"input-speed\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Price (KES/month)</Label>\n                <Input\n                  type=\"number\"\n                  placeholder=\"1500\"\n                  value={formData.price}\n                  onChange={(e) => setFormData({ ...formData, price: e.target.value })}\n                  required\n                  data-testid=\"input-price\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Max Devices per Voucher</Label>\n              <div className=\"flex items-center gap-2\">\n                <Smartphone size={16} className=\"text-muted-foreground\" />\n                <Input\n                  type=\"number\"\n                  min=\"1\"\n                  max=\"20\"\n                  placeholder=\"1\"\n                  value={formData.maxDevices}\n                  onChange={(e) => setFormData({ ...formData, maxDevices: e.target.value })}\n                  data-testid=\"input-max-devices\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Description (Optional)</Label>\n              <Textarea\n                placeholder=\"Plan description...\"\n                value={formData.description}\n                onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                data-testid=\"input-description\"\n              />\n            </div>\n\n            <DialogFooter>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => setIsDialogOpen(false)}\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                className=\"gradient-btn\"\n                disabled={createMutation.isPending || updateMutation.isPending}\n                data-testid=\"button-submit-plan\"\n              >\n                {(createMutation.isPending || updateMutation.isPending) && (\n                  <Loader2 size={16} className=\"mr-2 animate-spin\" />\n                )}\n                {editingPlan ? \"Update Plan\" : \"Create Plan\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":13666,"size_tokens":null},"client/src/pages/tech-pppoe-users.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { motion } from \"framer-motion\";\nimport {\n  Router,\n  Plus,\n  Search,\n  Phone,\n  User,\n  Mail,\n  Loader2,\n  CheckCircle,\n  XCircle,\n  Clock,\n  Pencil,\n  MoreVertical,\n} from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { WifiUser, Plan } from \"@shared/schema\";\nimport { format } from \"date-fns\";\n\nexport default function TechPPPoEUsersPage() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingUser, setEditingUser] = useState<WifiUser | null>(null);\n  const [formData, setFormData] = useState({\n    fullName: \"\",\n    phoneNumber: \"\",\n    email: \"\",\n    username: \"\",\n    password: \"\",\n    planId: \"\",\n  });\n\n  const { data: users, isLoading: usersLoading } = useQuery<WifiUser[]>({\n    queryKey: [\"/api/wifi-users\", \"PPPOE\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/wifi-users?type=PPPOE\");\n      if (!res.ok) throw new Error(\"Failed to fetch users\");\n      return res.json();\n    },\n  });\n\n  const { data: plans } = useQuery<Plan[]>({\n    queryKey: [\"/api/plans\", \"PPPOE\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/plans?type=PPPOE\");\n      if (!res.ok) throw new Error(\"Failed to fetch plans\");\n      return res.json();\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      return apiRequest(\"POST\", \"/api/wifi-users\", {\n        ...data,\n        accountType: \"PPPOE\",\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/wifi-users\"] });\n      setIsDialogOpen(false);\n      resetForm();\n      toast({\n        title: \"User Created\",\n        description: \"PPPoE user has been created successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create user\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: typeof formData & { id: string }) => {\n      return apiRequest(\"PATCH\", `/api/wifi-users/${data.id}`, {\n        ...data,\n        accountType: \"PPPOE\",\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/wifi-users\"] });\n      setIsDialogOpen(false);\n      setEditingUser(null);\n      resetForm();\n      toast({\n        title: \"User Updated\",\n        description: \"PPPoE user has been updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update user\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      fullName: \"\",\n      phoneNumber: \"\",\n      email: \"\",\n      username: \"\",\n      password: \"\",\n      planId: \"\",\n    });\n  };\n\n  const handleOpenCreate = () => {\n    resetForm();\n    setEditingUser(null);\n    setIsDialogOpen(true);\n  };\n\n  const handleOpenEdit = (user: WifiUser) => {\n    setEditingUser(user);\n    setFormData({\n      fullName: user.fullName || \"\",\n      phoneNumber: user.phoneNumber,\n      email: user.email || \"\",\n      username: user.username || \"\",\n      password: \"\",\n      planId: user.currentPlanId || \"\",\n    });\n    setIsDialogOpen(true);\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (editingUser) {\n      updateMutation.mutate({ ...formData, id: editingUser.id });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  const filteredUsers = users?.filter((user) => {\n    const search = searchQuery.toLowerCase();\n    return (\n      user.fullName?.toLowerCase().includes(search) ||\n      user.phoneNumber.toLowerCase().includes(search) ||\n      user.username?.toLowerCase().includes(search)\n    );\n  });\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \"ACTIVE\":\n        return (\n          <Badge variant=\"outline\" className=\"bg-cyan-500/20 text-cyan-400 border-cyan-500/30\">\n            <CheckCircle size={12} className=\"mr-1\" />\n            Active\n          </Badge>\n        );\n      case \"EXPIRED\":\n        return (\n          <Badge variant=\"outline\" className=\"bg-amber-500/20 text-amber-400 border-amber-500/30\">\n            <Clock size={12} className=\"mr-1\" />\n            Expired\n          </Badge>\n        );\n      case \"SUSPENDED\":\n        return (\n          <Badge variant=\"outline\" className=\"bg-red-500/20 text-red-400 border-red-500/30\">\n            <XCircle size={12} className=\"mr-1\" />\n            Suspended\n          </Badge>\n        );\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat(\"en-KE\", {\n      style: \"currency\",\n      currency: \"KES\",\n      minimumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"tech-pppoe-users-page\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">PPPoE Users</h1>\n          <p className=\"text-muted-foreground\">\n            Manage broadband customers with monthly billing\n          </p>\n        </div>\n        <Button className=\"gradient-btn\" onClick={handleOpenCreate} data-testid=\"button-add-user\">\n          <Plus size={18} className=\"mr-2\" />\n          Add PPPoE User\n        </Button>\n      </div>\n\n      {/* Search */}\n      <GlassPanel size=\"sm\">\n        <div className=\"flex items-center gap-4\">\n          <div className=\"flex-1\">\n            <GlassInput\n              placeholder=\"Search by name, phone, or username...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              icon={<Search size={16} />}\n              data-testid=\"input-search\"\n            />\n          </div>\n        </div>\n      </GlassPanel>\n\n      {/* Users List */}\n      {usersLoading ? (\n        <div className=\"space-y-4\">\n          {[1, 2, 3].map((i) => (\n            <div key={i} className=\"animate-pulse glass-panel p-4 flex items-center gap-4\">\n              <div className=\"w-12 h-12 rounded-full bg-white/10\" />\n              <div className=\"flex-1 space-y-2\">\n                <div className=\"h-4 bg-white/10 rounded w-1/4\" />\n                <div className=\"h-3 bg-white/10 rounded w-1/3\" />\n              </div>\n            </div>\n          ))}\n        </div>\n      ) : filteredUsers && filteredUsers.length > 0 ? (\n        <div className=\"space-y-4\">\n          {filteredUsers.map((user, index) => {\n            const plan = plans?.find((p) => p.id === user.currentPlanId);\n            return (\n              <motion.div\n                key={user.id}\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: index * 0.05 }}\n              >\n                <GlassPanel size=\"sm\" className=\"flex items-center gap-4 p-4\">\n                  <div className=\"w-12 h-12 rounded-full bg-cyan-500/20 flex items-center justify-center\">\n                    <Router size={20} className=\"text-cyan-400\" />\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <p className=\"font-semibold text-white truncate\">\n                        {user.fullName || user.username || \"Unnamed User\"}\n                      </p>\n                      {getStatusBadge(user.status)}\n                    </div>\n                    <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n                      <span className=\"flex items-center gap-1\">\n                        <Phone size={12} />\n                        {user.phoneNumber}\n                      </span>\n                      {user.username && (\n                        <span className=\"flex items-center gap-1\">\n                          <User size={12} />\n                          {user.username}\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                  <div className=\"text-right hidden sm:block\">\n                    {plan && (\n                      <p className=\"font-semibold text-white\">{plan.name}</p>\n                    )}\n                    {user.expiryTime && (\n                      <p className=\"text-xs text-muted-foreground\">\n                        Expires: {format(new Date(user.expiryTime), \"MMM d, yyyy\")}\n                      </p>\n                    )}\n                  </div>\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button size=\"icon\" variant=\"ghost\" data-testid={`button-menu-${user.id}`}>\n                        <MoreVertical size={16} />\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\">\n                      <DropdownMenuItem onClick={() => handleOpenEdit(user)}>\n                        <Pencil size={14} className=\"mr-2\" />\n                        Edit User\n                      </DropdownMenuItem>\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </GlassPanel>\n              </motion.div>\n            );\n          })}\n        </div>\n      ) : (\n        <GlassPanel size=\"lg\" className=\"text-center py-12\">\n          <Router size={48} className=\"mx-auto mb-4 text-muted-foreground opacity-50\" />\n          <h3 className=\"text-lg font-semibold text-white mb-2\">No PPPoE Users</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            Add your first PPPoE customer to get started\n          </p>\n          <Button className=\"gradient-btn\" onClick={handleOpenCreate}>\n            <Plus size={18} className=\"mr-2\" />\n            Add First User\n          </Button>\n        </GlassPanel>\n      )}\n\n      {/* Create/Edit Dialog */}\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"bg-card border-white/10\">\n          <DialogHeader>\n            <DialogTitle className=\"text-white\">\n              {editingUser ? \"Edit PPPoE User\" : \"Add PPPoE User\"}\n            </DialogTitle>\n          </DialogHeader>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Full Name</Label>\n                <Input\n                  placeholder=\"John Doe\"\n                  value={formData.fullName}\n                  onChange={(e) => setFormData({ ...formData, fullName: e.target.value })}\n                  required\n                  data-testid=\"input-fullname\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Phone Number</Label>\n                <Input\n                  placeholder=\"0712345678\"\n                  value={formData.phoneNumber}\n                  onChange={(e) => setFormData({ ...formData, phoneNumber: e.target.value })}\n                  required\n                  data-testid=\"input-phone\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Email (Optional)</Label>\n              <Input\n                type=\"email\"\n                placeholder=\"john@example.com\"\n                value={formData.email}\n                onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                data-testid=\"input-email\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>PPPoE Username</Label>\n                <Input\n                  placeholder=\"johndoe\"\n                  value={formData.username}\n                  onChange={(e) => setFormData({ ...formData, username: e.target.value })}\n                  required\n                  data-testid=\"input-username\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>PPPoE Password</Label>\n                <Input\n                  type=\"password\"\n                  placeholder=\"\"\n                  value={formData.password}\n                  onChange={(e) => setFormData({ ...formData, password: e.target.value })}\n                  required={!editingUser}\n                  data-testid=\"input-password\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Select Plan</Label>\n              <Select\n                value={formData.planId}\n                onValueChange={(value) => setFormData({ ...formData, planId: value })}\n              >\n                <SelectTrigger data-testid=\"select-plan\">\n                  <SelectValue placeholder=\"Choose a plan\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {plans?.map((plan) => (\n                    <SelectItem key={plan.id} value={plan.id}>\n                      {plan.name} - {formatCurrency(plan.price)}/month\n                      {plan.speedMbps && ` (${plan.speedMbps} Mbps)`}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <DialogFooter>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => setIsDialogOpen(false)}\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                className=\"gradient-btn\"\n                disabled={createMutation.isPending || updateMutation.isPending}\n                data-testid=\"button-submit\"\n              >\n                {(createMutation.isPending || updateMutation.isPending) && (\n                  <Loader2 size={16} className=\"mr-2 animate-spin\" />\n                )}\n                {editingUser ? \"Update User\" : \"Create User\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":15072,"size_tokens":null},"client/src/pages/landing.tsx":{"content":"import { motion } from \"framer-motion\";\nimport { Link } from \"wouter\";\nimport {\n  Wifi,\n  Shield,\n  Zap,\n  Users,\n  BarChart3,\n  CreditCard,\n  Clock,\n  Check,\n  ArrowRight,\n  Phone,\n  Globe,\n  Server,\n  Smartphone,\n  ChevronRight,\n  Star,\n} from \"lucide-react\";\nimport { MeshBackground } from \"@/components/mesh-background\";\nimport { MnetiFiLogo } from \"@/components/mnetifi-logo\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\n\nconst features = [\n  {\n    icon: Wifi,\n    title: \"Hotspot Management\",\n    description: \"Full control over hotspot users with automated billing and session management.\",\n  },\n  {\n    icon: Server,\n    title: \"PPPoE & Static IP\",\n    description: \"Manage PPPoE and Static IP customers with monthly billing cycles.\",\n  },\n  {\n    icon: CreditCard,\n    title: \"M-Pesa Integration\",\n    description: \"Seamless M-Pesa STK Push for instant payments and automatic activation.\",\n  },\n  {\n    icon: BarChart3,\n    title: \"Real-Time Analytics\",\n    description: \"Monitor revenue, user activity, and network performance in real-time.\",\n  },\n  {\n    icon: Shield,\n    title: \"Secure & Reliable\",\n    description: \"Enterprise-grade security with 99.9% uptime guarantee.\",\n  },\n  {\n    icon: Users,\n    title: \"Multi-Tenant\",\n    description: \"Complete tenant isolation with role-based access control.\",\n  },\n];\n\nconst pricingPlans = [\n  {\n    name: \"Trial\",\n    price: \"Free\",\n    duration: \"24 hours\",\n    description: \"Try all features risk-free\",\n    features: [\n      \"Full platform access\",\n      \"Hotspot management\",\n      \"PPPoE/Static billing\",\n      \"M-Pesa integration\",\n      \"Basic support\",\n    ],\n    highlighted: false,\n  },\n  {\n    name: \"Tier 1\",\n    price: \"Ksh 500\",\n    duration: \"/month\",\n    description: \"For small ISPs\",\n    setup: \"Ksh 500 setup fee\",\n    features: [\n      \"Hotspot OR PPPoE/Static\",\n      \"Up to 500 users\",\n      \"M-Pesa integration\",\n      \"Email support\",\n      \"Basic analytics\",\n    ],\n    highlighted: false,\n  },\n  {\n    name: \"Tier 2\",\n    price: \"Ksh 1,500\",\n    duration: \"/month\",\n    description: \"For growing ISPs\",\n    features: [\n      \"All features included\",\n      \"Unlimited users\",\n      \"SMS notifications\",\n      \"Priority support\",\n      \"Advanced analytics\",\n      \"White-labeling\",\n      \"API access\",\n    ],\n    highlighted: true,\n  },\n];\n\nconst testimonials = [\n  {\n    name: \"James Kamau\",\n    role: \"CEO, FastNet ISP\",\n    content: \"MnetiFi transformed our billing operations. We've seen 40% reduction in payment collection time.\",\n    rating: 5,\n  },\n  {\n    name: \"Mary Wanjiku\",\n    role: \"Operations Manager, ConnectKE\",\n    content: \"The M-Pesa integration is seamless. Our customers love the instant activation.\",\n    rating: 5,\n  },\n  {\n    name: \"Peter Ochieng\",\n    role: \"Technical Director, WifiZone\",\n    content: \"Best WiFi billing platform in Kenya. The support team is exceptional.\",\n    rating: 5,\n  },\n];\n\nexport default function LandingPage() {\n  return (\n    <>\n      <MeshBackground />\n      <div className=\"min-h-screen relative z-10\">\n        {/* Navigation */}\n        <nav className=\"fixed top-0 left-0 right-0 z-50 bg-background/80 backdrop-blur-xl border-b border-white/10\">\n          <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n            <div className=\"flex items-center justify-between h-16 gap-4\">\n              <MnetiFiLogo size=\"sm\" />\n              <div className=\"hidden md:flex items-center gap-6\">\n                <a href=\"#features\" className=\"text-sm text-muted-foreground hover:text-white transition-colors\">\n                  Features\n                </a>\n                <a href=\"#pricing\" className=\"text-sm text-muted-foreground hover:text-white transition-colors\">\n                  Pricing\n                </a>\n                <a href=\"#testimonials\" className=\"text-sm text-muted-foreground hover:text-white transition-colors\">\n                  Testimonials\n                </a>\n              </div>\n              <div className=\"flex items-center gap-3\">\n                <Link href=\"/login\">\n                  <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-nav-login\">\n                    Login\n                  </Button>\n                </Link>\n                <Link href=\"/register\">\n                  <Button size=\"sm\" className=\"gradient-btn\" data-testid=\"button-nav-register\">\n                    Get Started\n                  </Button>\n                </Link>\n              </div>\n            </div>\n          </div>\n        </nav>\n\n        {/* Hero Section */}\n        <section className=\"pt-32 pb-20 px-4\">\n          <div className=\"max-w-7xl mx-auto\">\n            <motion.div\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ duration: 0.6 }}\n              className=\"text-center max-w-4xl mx-auto\"\n            >\n              <Badge variant=\"outline\" className=\"bg-cyan-500/20 text-cyan-400 border-cyan-500/30 mb-6\">\n                <Zap size={14} className=\"mr-1\" />\n                Kenya's Leading WiFi Billing Platform\n              </Badge>\n              <h1 className=\"text-4xl md:text-6xl font-bold text-white mb-6 leading-tight\">\n                Automate Your <span className=\"gradient-text\">WiFi Business</span> With Smart Billing\n              </h1>\n              <p className=\"text-lg md:text-xl text-muted-foreground mb-8 max-w-2xl mx-auto\">\n                Complete ISP management solution with M-Pesa integration, hotspot management, \n                PPPoE/Static billing, and real-time analytics.\n              </p>\n              <div className=\"flex flex-col sm:flex-row items-center justify-center gap-4\">\n                <Link href=\"/register\">\n                  <Button size=\"lg\" className=\"gradient-btn min-w-[200px]\" data-testid=\"button-hero-start\">\n                    Start Free Trial\n                    <ArrowRight size={18} className=\"ml-2\" />\n                  </Button>\n                </Link>\n                <a href=\"#features\">\n                  <Button size=\"lg\" variant=\"outline\" className=\"min-w-[200px] border-white/20\">\n                    Learn More\n                    <ChevronRight size={18} className=\"ml-2\" />\n                  </Button>\n                </a>\n              </div>\n              <div className=\"flex items-center justify-center gap-6 mt-8 text-sm text-muted-foreground\">\n                <div className=\"flex items-center gap-2\">\n                  <Check size={16} className=\"text-cyan-400\" />\n                  24-hour free trial\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <Check size={16} className=\"text-cyan-400\" />\n                  No credit card required\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <Check size={16} className=\"text-cyan-400\" />\n                  M-Pesa ready\n                </div>\n              </div>\n            </motion.div>\n\n            {/* Dashboard Preview */}\n            <motion.div\n              initial={{ opacity: 0, y: 40 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ duration: 0.8, delay: 0.2 }}\n              className=\"mt-16 relative\"\n            >\n              <div className=\"absolute inset-0 bg-gradient-to-t from-background via-transparent to-transparent z-10\" />\n              <div className=\"glass-panel p-4 md:p-8 max-w-5xl mx-auto\">\n                <div className=\"aspect-video bg-gradient-to-br from-cyan-500/10 to-purple-500/10 rounded-xl flex items-center justify-center border border-white/10\">\n                  <div className=\"text-center p-8\">\n                    <Wifi size={64} className=\"text-cyan-400 mx-auto mb-4\" />\n                    <p className=\"text-xl font-semibold text-white\">Powerful Dashboard</p>\n                    <p className=\"text-muted-foreground\">Real-time insights at your fingertips</p>\n                  </div>\n                </div>\n              </div>\n            </motion.div>\n          </div>\n        </section>\n\n        {/* Stats Section */}\n        <section className=\"py-16 px-4 border-y border-white/10 bg-white/5\">\n          <div className=\"max-w-7xl mx-auto\">\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-8\">\n              {[\n                { value: \"500+\", label: \"Active ISPs\" },\n                { value: \"100K+\", label: \"End Users\" },\n                { value: \"99.9%\", label: \"Uptime\" },\n                { value: \"24/7\", label: \"Support\" },\n              ].map((stat, index) => (\n                <motion.div\n                  key={stat.label}\n                  initial={{ opacity: 0, y: 20 }}\n                  whileInView={{ opacity: 1, y: 0 }}\n                  viewport={{ once: true }}\n                  transition={{ delay: index * 0.1 }}\n                  className=\"text-center\"\n                >\n                  <p className=\"text-3xl md:text-4xl font-bold gradient-text\">{stat.value}</p>\n                  <p className=\"text-muted-foreground mt-1\">{stat.label}</p>\n                </motion.div>\n              ))}\n            </div>\n          </div>\n        </section>\n\n        {/* Features Section */}\n        <section id=\"features\" className=\"py-20 px-4\">\n          <div className=\"max-w-7xl mx-auto\">\n            <motion.div\n              initial={{ opacity: 0, y: 20 }}\n              whileInView={{ opacity: 1, y: 0 }}\n              viewport={{ once: true }}\n              className=\"text-center mb-16\"\n            >\n              <Badge variant=\"outline\" className=\"bg-purple-500/20 text-purple-400 border-purple-500/30 mb-4\">\n                Features\n              </Badge>\n              <h2 className=\"text-3xl md:text-4xl font-bold text-white mb-4\">\n                Everything You Need to Run Your ISP\n              </h2>\n              <p className=\"text-muted-foreground max-w-2xl mx-auto\">\n                From hotspot management to PPPoE billing, we've got all the tools you need to grow your business.\n              </p>\n            </motion.div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n              {features.map((feature, index) => (\n                <motion.div\n                  key={feature.title}\n                  initial={{ opacity: 0, y: 20 }}\n                  whileInView={{ opacity: 1, y: 0 }}\n                  viewport={{ once: true }}\n                  transition={{ delay: index * 0.1 }}\n                  className=\"glass-panel glass-panel-hover p-6\"\n                >\n                  <div className=\"w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500/20 to-blue-500/20 flex items-center justify-center mb-4\">\n                    <feature.icon size={24} className=\"text-cyan-400\" />\n                  </div>\n                  <h3 className=\"text-lg font-semibold text-white mb-2\">{feature.title}</h3>\n                  <p className=\"text-muted-foreground text-sm\">{feature.description}</p>\n                </motion.div>\n              ))}\n            </div>\n          </div>\n        </section>\n\n        {/* Pricing Section */}\n        <section id=\"pricing\" className=\"py-20 px-4 bg-white/5\">\n          <div className=\"max-w-7xl mx-auto\">\n            <motion.div\n              initial={{ opacity: 0, y: 20 }}\n              whileInView={{ opacity: 1, y: 0 }}\n              viewport={{ once: true }}\n              className=\"text-center mb-16\"\n            >\n              <Badge variant=\"outline\" className=\"bg-cyan-500/20 text-cyan-400 border-cyan-500/30 mb-4\">\n                Pricing\n              </Badge>\n              <h2 className=\"text-3xl md:text-4xl font-bold text-white mb-4\">\n                Simple, Transparent Pricing\n              </h2>\n              <p className=\"text-muted-foreground max-w-2xl mx-auto\">\n                Start with a free trial and upgrade as you grow. No hidden fees.\n              </p>\n            </motion.div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6 max-w-5xl mx-auto\">\n              {pricingPlans.map((plan, index) => (\n                <motion.div\n                  key={plan.name}\n                  initial={{ opacity: 0, y: 20 }}\n                  whileInView={{ opacity: 1, y: 0 }}\n                  viewport={{ once: true }}\n                  transition={{ delay: index * 0.1 }}\n                  className={`glass-panel p-6 relative ${\n                    plan.highlighted ? \"border-cyan-500/50 ring-1 ring-cyan-500/30\" : \"\"\n                  }`}\n                >\n                  {plan.highlighted && (\n                    <Badge className=\"absolute -top-3 left-1/2 -translate-x-1/2 bg-cyan-500 text-white\">\n                      Most Popular\n                    </Badge>\n                  )}\n                  <div className=\"text-center mb-6\">\n                    <h3 className=\"text-xl font-semibold text-white mb-2\">{plan.name}</h3>\n                    <div className=\"flex items-end justify-center gap-1\">\n                      <span className=\"text-4xl font-bold gradient-text\">{plan.price}</span>\n                      <span className=\"text-muted-foreground mb-1\">{plan.duration}</span>\n                    </div>\n                    <p className=\"text-sm text-muted-foreground mt-2\">{plan.description}</p>\n                    {plan.setup && (\n                      <p className=\"text-xs text-cyan-400 mt-1\">{plan.setup}</p>\n                    )}\n                  </div>\n                  <ul className=\"space-y-3 mb-6\">\n                    {plan.features.map((feature) => (\n                      <li key={feature} className=\"flex items-center gap-2 text-sm\">\n                        <Check size={16} className=\"text-cyan-400 shrink-0\" />\n                        <span className=\"text-muted-foreground\">{feature}</span>\n                      </li>\n                    ))}\n                  </ul>\n                  <Link href=\"/register\">\n                    <Button\n                      className={`w-full ${plan.highlighted ? \"gradient-btn\" : \"\"}`}\n                      variant={plan.highlighted ? \"default\" : \"outline\"}\n                      data-testid={`button-pricing-${plan.name.toLowerCase().replace(' ', '-')}`}\n                    >\n                      Get Started\n                    </Button>\n                  </Link>\n                </motion.div>\n              ))}\n            </div>\n          </div>\n        </section>\n\n        {/* Testimonials Section */}\n        <section id=\"testimonials\" className=\"py-20 px-4\">\n          <div className=\"max-w-7xl mx-auto\">\n            <motion.div\n              initial={{ opacity: 0, y: 20 }}\n              whileInView={{ opacity: 1, y: 0 }}\n              viewport={{ once: true }}\n              className=\"text-center mb-16\"\n            >\n              <Badge variant=\"outline\" className=\"bg-purple-500/20 text-purple-400 border-purple-500/30 mb-4\">\n                Testimonials\n              </Badge>\n              <h2 className=\"text-3xl md:text-4xl font-bold text-white mb-4\">\n                Trusted by ISPs Across Kenya\n              </h2>\n              <p className=\"text-muted-foreground max-w-2xl mx-auto\">\n                See what our customers have to say about MnetiFi.\n              </p>\n            </motion.div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n              {testimonials.map((testimonial, index) => (\n                <motion.div\n                  key={testimonial.name}\n                  initial={{ opacity: 0, y: 20 }}\n                  whileInView={{ opacity: 1, y: 0 }}\n                  viewport={{ once: true }}\n                  transition={{ delay: index * 0.1 }}\n                  className=\"glass-panel p-6\"\n                >\n                  <div className=\"flex items-center gap-1 mb-4\">\n                    {[...Array(testimonial.rating)].map((_, i) => (\n                      <Star key={i} size={16} className=\"text-amber-400 fill-amber-400\" />\n                    ))}\n                  </div>\n                  <p className=\"text-muted-foreground mb-4\">\"{testimonial.content}\"</p>\n                  <div>\n                    <p className=\"font-semibold text-white\">{testimonial.name}</p>\n                    <p className=\"text-sm text-muted-foreground\">{testimonial.role}</p>\n                  </div>\n                </motion.div>\n              ))}\n            </div>\n          </div>\n        </section>\n\n        {/* CTA Section */}\n        <section className=\"py-20 px-4\">\n          <div className=\"max-w-4xl mx-auto\">\n            <motion.div\n              initial={{ opacity: 0, y: 20 }}\n              whileInView={{ opacity: 1, y: 0 }}\n              viewport={{ once: true }}\n              className=\"glass-panel p-8 md:p-12 text-center\"\n            >\n              <h2 className=\"text-3xl md:text-4xl font-bold text-white mb-4\">\n                Ready to Transform Your ISP Business?\n              </h2>\n              <p className=\"text-muted-foreground mb-8 max-w-xl mx-auto\">\n                Join hundreds of ISPs who have automated their billing with MnetiFi. \n                Start your free trial today.\n              </p>\n              <div className=\"flex flex-col sm:flex-row items-center justify-center gap-4\">\n                <Link href=\"/register\">\n                  <Button size=\"lg\" className=\"gradient-btn min-w-[200px]\" data-testid=\"button-cta-start\">\n                    Start Free Trial\n                    <ArrowRight size={18} className=\"ml-2\" />\n                  </Button>\n                </Link>\n                <Link href=\"/login\">\n                  <Button size=\"lg\" variant=\"outline\" className=\"min-w-[200px] border-white/20\">\n                    Sign In\n                  </Button>\n                </Link>\n              </div>\n            </motion.div>\n          </div>\n        </section>\n\n        {/* Footer */}\n        <footer className=\"border-t border-white/10 py-12 px-4\">\n          <div className=\"max-w-7xl mx-auto\">\n            <div className=\"grid grid-cols-1 md:grid-cols-4 gap-8\">\n              <div className=\"md:col-span-2\">\n                <MnetiFiLogo size=\"md\" className=\"mb-4\" />\n                <p className=\"text-sm text-muted-foreground max-w-sm\">\n                  Kenya's leading WiFi billing platform for ISPs. Automate your business \n                  with M-Pesa integration, hotspot management, and real-time analytics.\n                </p>\n              </div>\n              <div>\n                <h4 className=\"font-semibold text-white mb-4\">Quick Links</h4>\n                <ul className=\"space-y-2 text-sm\">\n                  <li>\n                    <a href=\"#features\" className=\"text-muted-foreground hover:text-white transition-colors\">\n                      Features\n                    </a>\n                  </li>\n                  <li>\n                    <a href=\"#pricing\" className=\"text-muted-foreground hover:text-white transition-colors\">\n                      Pricing\n                    </a>\n                  </li>\n                  <li>\n                    <Link href=\"/login\" className=\"text-muted-foreground hover:text-white transition-colors\">\n                      Login\n                    </Link>\n                  </li>\n                  <li>\n                    <Link href=\"/register\" className=\"text-muted-foreground hover:text-white transition-colors\">\n                      Register\n                    </Link>\n                  </li>\n                </ul>\n              </div>\n              <div>\n                <h4 className=\"font-semibold text-white mb-4\">Contact</h4>\n                <ul className=\"space-y-2 text-sm\">\n                  <li className=\"flex items-center gap-2 text-muted-foreground\">\n                    <Phone size={14} />\n                    +254 700 000 000\n                  </li>\n                  <li className=\"flex items-center gap-2 text-muted-foreground\">\n                    <Globe size={14} />\n                    support@mnetifi.com\n                  </li>\n                </ul>\n              </div>\n            </div>\n            <div className=\"mt-8 pt-8 border-t border-white/10 text-center text-sm text-muted-foreground\">\n              <p>&copy; {new Date().getFullYear()} MnetiFi. All rights reserved.</p>\n            </div>\n          </div>\n        </footer>\n      </div>\n    </>\n  );\n}\n","path":null,"size_bytes":20306,"size_tokens":null},"client/src/pages/customer-portal.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { \n  User, \n  Wifi, \n  CreditCard, \n  Clock, \n  Calendar, \n  ArrowUpRight, \n  CheckCircle, \n  XCircle,\n  RefreshCw,\n  Phone,\n  Mail,\n  LogOut,\n  Loader2,\n  Shield,\n  Zap,\n  Settings,\n  Save,\n  ToggleLeft,\n  ToggleRight\n} from \"lucide-react\";\nimport { Switch } from \"@/components/ui/switch\";\nimport type { WifiUser, Plan, Transaction } from \"@shared/schema\";\n\ninterface CustomerData {\n  user: WifiUser;\n  plan: Plan | null;\n  transactions: Transaction[];\n  hotspotName: string;\n  sessionToken?: string;\n}\n\ninterface CustomerSettings {\n  email: string;\n  fullName: string;\n  phoneNumber: string;\n  paymentPhone: string;\n  autoRenew: boolean;\n}\n\nexport default function CustomerPortal() {\n  const [isLoggedIn, setIsLoggedIn] = useState(false);\n  const [customerData, setCustomerData] = useState<CustomerData | null>(null);\n  const [phoneNumber, setPhoneNumber] = useState(\"\");\n  const [verificationCode, setVerificationCode] = useState(\"\");\n  const [step, setStep] = useState<\"phone\" | \"verify\" | \"dashboard\">(\"phone\");\n  const [verificationSent, setVerificationSent] = useState(false);\n  const [activeTab, setActiveTab] = useState(\"overview\");\n  const [settings, setSettings] = useState<CustomerSettings>({\n    email: \"\",\n    fullName: \"\",\n    phoneNumber: \"\",\n    paymentPhone: \"\",\n    autoRenew: false,\n  });\n  const { toast } = useToast();\n\n  const { data: plans } = useQuery<Plan[]>({\n    queryKey: [\"/api/plans\"],\n    enabled: isLoggedIn,\n  });\n\n  const { data: settingsData, refetch: refetchSettings } = useQuery<CustomerSettings>({\n    queryKey: [\"/api/customer/settings\", customerData?.user?.id],\n    queryFn: async () => {\n      if (!customerData?.user?.id || !customerData?.sessionToken) {\n        throw new Error(\"Not authenticated\");\n      }\n      const response = await fetch(`/api/customer/settings/${customerData.user.id}?sessionToken=${customerData.sessionToken}`);\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch settings\");\n      }\n      return response.json();\n    },\n    enabled: isLoggedIn && !!customerData?.user?.id && !!customerData?.sessionToken,\n  });\n\n  useEffect(() => {\n    if (settingsData) {\n      setSettings(settingsData);\n    }\n  }, [settingsData]);\n\n  const saveSettingsMutation = useMutation({\n    mutationFn: async (data: Partial<CustomerSettings>) => {\n      const response = await apiRequest(\"PATCH\", \"/api/customer/settings\", {\n        userId: customerData?.user?.id,\n        sessionToken: customerData?.sessionToken,\n        ...data,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Settings saved\",\n        description: \"Your payment preferences have been updated.\",\n      });\n      refetchSettings();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save settings\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const requestOtpMutation = useMutation({\n    mutationFn: async (phone: string) => {\n      return apiRequest(\"POST\", \"/api/customer/request-otp\", { phoneNumber: phone });\n    },\n    onSuccess: () => {\n      setVerificationSent(true);\n      setStep(\"verify\");\n      toast({\n        title: \"Verification code sent\",\n        description: \"Check your phone for the verification code.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to send verification code\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const verifyOtpMutation = useMutation({\n    mutationFn: async (data: { phoneNumber: string; code: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/customer/verify-otp\", data);\n      return response.json();\n    },\n    onSuccess: (data) => {\n      setCustomerData(data);\n      setIsLoggedIn(true);\n      setStep(\"dashboard\");\n      toast({\n        title: \"Welcome back!\",\n        description: \"You are now logged in to your account.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Invalid verification code\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const renewPlanMutation = useMutation({\n    mutationFn: async (planId: string) => {\n      const response = await apiRequest(\"POST\", \"/api/customer/renew\", { planId });\n      return response.json();\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"M-Pesa payment initiated\",\n        description: \"Please check your phone and enter your M-Pesa PIN to complete payment.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to initiate payment\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleRequestOtp = () => {\n    if (!phoneNumber || phoneNumber.length < 10) {\n      toast({\n        title: \"Invalid phone number\",\n        description: \"Please enter a valid phone number\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    requestOtpMutation.mutate(phoneNumber);\n  };\n\n  const handleVerifyOtp = () => {\n    if (!verificationCode || verificationCode.length < 4) {\n      toast({\n        title: \"Invalid code\",\n        description: \"Please enter the verification code\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    verifyOtpMutation.mutate({ phoneNumber, code: verificationCode });\n  };\n\n  const handleLogout = () => {\n    setIsLoggedIn(false);\n    setCustomerData(null);\n    setPhoneNumber(\"\");\n    setVerificationCode(\"\");\n    setStep(\"phone\");\n    setVerificationSent(false);\n  };\n\n  const formatDate = (date: Date | string | null) => {\n    if (!date) return \"N/A\";\n    return new Date(date).toLocaleDateString(\"en-KE\", {\n      year: \"numeric\",\n      month: \"short\",\n      day: \"numeric\",\n    });\n  };\n\n  const formatCurrency = (amount: number) => {\n    return `KES ${amount.toLocaleString()}`;\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"active\":\n        return \"bg-green-500/20 text-green-400 border-green-500/30\";\n      case \"expired\":\n        return \"bg-red-500/20 text-red-400 border-red-500/30\";\n      case \"pending\":\n        return \"bg-yellow-500/20 text-yellow-400 border-yellow-500/30\";\n      case \"suspended\":\n        return \"bg-orange-500/20 text-orange-400 border-orange-500/30\";\n      default:\n        return \"bg-gray-500/20 text-gray-400 border-gray-500/30\";\n    }\n  };\n\n  const getDaysRemaining = () => {\n    if (!customerData?.user?.expiryTime) return 0;\n    const now = new Date();\n    const expiry = new Date(customerData.user.expiryTime);\n    const diff = Math.ceil((expiry.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n    return Math.max(0, diff);\n  };\n  \n  const formatDuration = (durationSeconds: number) => {\n    if (durationSeconds < 3600) {\n      return `${Math.floor(durationSeconds / 60)} minutes`;\n    } else if (durationSeconds < 86400) {\n      return `${Math.floor(durationSeconds / 3600)} hours`;\n    } else {\n      return `${Math.floor(durationSeconds / 86400)} days`;\n    }\n  };\n\n  if (!isLoggedIn) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4\">\n        <div className=\"absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiMyMGIyYWEiIGZpbGwtb3BhY2l0eT0iMC4wMyI+PGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMiIvPjwvZz48L2c+PC9zdmc+')] opacity-50\"></div>\n        \n        <Card className=\"w-full max-w-md bg-slate-800/90 backdrop-blur-xl border-slate-700/50 relative z-10\">\n          <CardHeader className=\"text-center\">\n            <div className=\"mx-auto w-16 h-16 rounded-full bg-gradient-to-r from-cyan-500 to-purple-500 flex items-center justify-center mb-4\">\n              <Wifi size={32} className=\"text-white\" />\n            </div>\n            <CardTitle className=\"text-2xl font-bold bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent\">\n              Customer Portal\n            </CardTitle>\n            <CardDescription className=\"text-slate-400\">\n              Manage your WiFi subscription\n            </CardDescription>\n          </CardHeader>\n          \n          <CardContent className=\"space-y-6\">\n            {step === \"phone\" && (\n              <>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"phone\" className=\"text-slate-300\">Phone Number</Label>\n                  <div className=\"relative\">\n                    <Phone className=\"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400\" size={18} />\n                    <Input\n                      id=\"phone\"\n                      type=\"tel\"\n                      placeholder=\"07XX XXX XXX\"\n                      value={phoneNumber}\n                      onChange={(e) => setPhoneNumber(e.target.value)}\n                      className=\"pl-10 bg-slate-700/50 border-slate-600 text-white placeholder:text-slate-500\"\n                      data-testid=\"input-customer-phone\"\n                    />\n                  </div>\n                  <p className=\"text-xs text-slate-500\">Enter your registered phone number</p>\n                </div>\n                \n                <Button\n                  onClick={handleRequestOtp}\n                  className=\"w-full bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600\"\n                  disabled={requestOtpMutation.isPending}\n                  data-testid=\"button-request-otp\"\n                >\n                  {requestOtpMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"mr-2 animate-spin\" size={18} />\n                      Sending...\n                    </>\n                  ) : (\n                    <>\n                      Continue\n                      <ArrowUpRight className=\"ml-2\" size={18} />\n                    </>\n                  )}\n                </Button>\n              </>\n            )}\n\n            {step === \"verify\" && (\n              <>\n                <div className=\"text-center mb-4\">\n                  <p className=\"text-slate-300\">We sent a code to</p>\n                  <p className=\"text-cyan-400 font-semibold\">{phoneNumber}</p>\n                </div>\n                \n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"code\" className=\"text-slate-300\">Verification Code</Label>\n                  <Input\n                    id=\"code\"\n                    type=\"text\"\n                    placeholder=\"Enter 4-digit code\"\n                    value={verificationCode}\n                    onChange={(e) => setVerificationCode(e.target.value)}\n                    className=\"text-center text-2xl tracking-widest bg-slate-700/50 border-slate-600 text-white\"\n                    maxLength={6}\n                    data-testid=\"input-verification-code\"\n                  />\n                </div>\n                \n                <Button\n                  onClick={handleVerifyOtp}\n                  className=\"w-full bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600\"\n                  disabled={verifyOtpMutation.isPending}\n                  data-testid=\"button-verify-otp\"\n                >\n                  {verifyOtpMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"mr-2 animate-spin\" size={18} />\n                      Verifying...\n                    </>\n                  ) : (\n                    <>\n                      Verify\n                      <CheckCircle className=\"ml-2\" size={18} />\n                    </>\n                  )}\n                </Button>\n                \n                <Button\n                  variant=\"ghost\"\n                  className=\"w-full text-slate-400 hover:text-white\"\n                  onClick={() => {\n                    setStep(\"phone\");\n                    setVerificationCode(\"\");\n                  }}\n                  data-testid=\"button-back-to-phone\"\n                >\n                  Change phone number\n                </Button>\n              </>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900\">\n      <div className=\"absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiMyMGIyYWEiIGZpbGwtb3BhY2l0eT0iMC4wMyI+PGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMiIvPjwvZz48L2c+PC9zdmc+')] opacity-50\"></div>\n      \n      <header className=\"relative z-10 border-b border-slate-700/50 bg-slate-800/50 backdrop-blur-xl\">\n        <div className=\"max-w-6xl mx-auto px-4 py-4 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"w-10 h-10 rounded-lg bg-gradient-to-r from-cyan-500 to-purple-500 flex items-center justify-center\">\n              <Wifi size={20} className=\"text-white\" />\n            </div>\n            <div>\n              <h1 className=\"font-bold text-white\">WiFi Portal</h1>\n              <p className=\"text-xs text-slate-400\">{customerData?.hotspotName || \"Customer Portal\"}</p>\n            </div>\n          </div>\n          \n          <div className=\"flex items-center gap-4\">\n            <div className=\"text-right\">\n              <p className=\"text-sm text-white font-medium\">{customerData?.user?.username}</p>\n              <p className=\"text-xs text-slate-400\">{customerData?.user?.phoneNumber}</p>\n            </div>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={handleLogout}\n              className=\"text-slate-400 hover:text-white\"\n              data-testid=\"button-logout\"\n            >\n              <LogOut size={20} />\n            </Button>\n          </div>\n        </div>\n      </header>\n\n      <main className=\"relative z-10 max-w-6xl mx-auto px-4 py-8\">\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n          <TabsList className=\"mb-6 bg-slate-800/90 border border-slate-700/50\">\n            <TabsTrigger value=\"overview\" className=\"data-[state=active]:bg-cyan-500/20 data-[state=active]:text-cyan-400\" data-testid=\"tab-overview\">\n              <Wifi size={16} className=\"mr-2\" />\n              Overview\n            </TabsTrigger>\n            <TabsTrigger value=\"settings\" className=\"data-[state=active]:bg-cyan-500/20 data-[state=active]:text-cyan-400\" data-testid=\"tab-settings\">\n              <Settings size={16} className=\"mr-2\" />\n              Payment Settings\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"overview\">\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n          <div className=\"lg:col-span-2 space-y-6\">\n            <Card className=\"bg-slate-800/90 backdrop-blur-xl border-slate-700/50\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <CardTitle className=\"text-xl text-white\">Account Status</CardTitle>\n                    <CardDescription className=\"text-slate-400\">Your current subscription details</CardDescription>\n                  </div>\n                  <Badge className={getStatusColor(customerData?.user?.status || \"pending\")}>\n                    {customerData?.user?.status?.toUpperCase() || \"UNKNOWN\"}\n                  </Badge>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                  <div className=\"p-4 rounded-lg bg-slate-700/50\">\n                    <div className=\"flex items-center gap-2 text-slate-400 mb-1\">\n                      <Shield size={16} />\n                      <span className=\"text-xs\">Plan</span>\n                    </div>\n                    <p className=\"text-lg font-semibold text-white\">\n                      {customerData?.plan?.name || \"No Plan\"}\n                    </p>\n                  </div>\n                  \n                  <div className=\"p-4 rounded-lg bg-slate-700/50\">\n                    <div className=\"flex items-center gap-2 text-slate-400 mb-1\">\n                      <Clock size={16} />\n                      <span className=\"text-xs\">Days Left</span>\n                    </div>\n                    <p className=\"text-lg font-semibold text-white\">\n                      {getDaysRemaining()} days\n                    </p>\n                  </div>\n                  \n                  <div className=\"p-4 rounded-lg bg-slate-700/50\">\n                    <div className=\"flex items-center gap-2 text-slate-400 mb-1\">\n                      <Calendar size={16} />\n                      <span className=\"text-xs\">Expires</span>\n                    </div>\n                    <p className=\"text-lg font-semibold text-white\">\n                      {formatDate(customerData?.user?.expiryTime || null)}\n                    </p>\n                  </div>\n                  \n                  <div className=\"p-4 rounded-lg bg-slate-700/50\">\n                    <div className=\"flex items-center gap-2 text-slate-400 mb-1\">\n                      <Zap size={16} />\n                      <span className=\"text-xs\">Speed</span>\n                    </div>\n                    <p className=\"text-lg font-semibold text-white\">\n                      {customerData?.plan?.downloadLimit || \"N/A\"}\n                    </p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/90 backdrop-blur-xl border-slate-700/50\">\n              <CardHeader>\n                <CardTitle className=\"text-xl text-white\">Transaction History</CardTitle>\n                <CardDescription className=\"text-slate-400\">Your recent payments</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-3\">\n                  {(!customerData?.transactions || customerData.transactions.length === 0) ? (\n                    <div className=\"text-center py-8 text-slate-400\">\n                      <CreditCard size={48} className=\"mx-auto mb-3 opacity-50\" />\n                      <p>No transactions yet</p>\n                    </div>\n                  ) : (\n                    customerData.transactions.slice(0, 10).map((tx) => (\n                      <div\n                        key={tx.id}\n                        className=\"flex items-center justify-between p-4 rounded-lg bg-slate-700/30 hover:bg-slate-700/50 transition-colors\"\n                        data-testid={`transaction-row-${tx.id}`}\n                      >\n                        <div className=\"flex items-center gap-3\">\n                          <div className={`p-2 rounded-lg ${\n                            tx.status === \"completed\" \n                              ? \"bg-green-500/20 text-green-400\" \n                              : tx.status === \"pending\" \n                              ? \"bg-yellow-500/20 text-yellow-400\" \n                              : \"bg-red-500/20 text-red-400\"\n                          }`}>\n                            {tx.status === \"completed\" ? (\n                              <CheckCircle size={20} />\n                            ) : tx.status === \"pending\" ? (\n                              <RefreshCw size={20} />\n                            ) : (\n                              <XCircle size={20} />\n                            )}\n                          </div>\n                          <div>\n                            <p className=\"font-medium text-white\">Plan Purchase</p>\n                            <p className=\"text-xs text-slate-400\">\n                              {formatDate(tx.createdAt)} - {tx.mpesaReceiptNumber || \"Processing\"}\n                            </p>\n                          </div>\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"font-semibold text-white\">{formatCurrency(tx.amount)}</p>\n                          <Badge variant=\"outline\" className={`text-xs ${\n                            tx.status === \"completed\" \n                              ? \"border-green-500/30 text-green-400\" \n                              : tx.status === \"pending\" \n                              ? \"border-yellow-500/30 text-yellow-400\" \n                              : \"border-red-500/30 text-red-400\"\n                          }`}>\n                            {tx.status}\n                          </Badge>\n                        </div>\n                      </div>\n                    ))\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <div className=\"space-y-6\">\n            <Card className=\"bg-gradient-to-br from-cyan-500/20 to-purple-500/20 backdrop-blur-xl border-cyan-500/30\">\n              <CardHeader>\n                <CardTitle className=\"text-white\">Quick Actions</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                <Button\n                  className=\"w-full bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600\"\n                  onClick={() => customerData?.plan && renewPlanMutation.mutate(customerData.plan.id)}\n                  disabled={!customerData?.plan || renewPlanMutation.isPending}\n                  data-testid=\"button-renew-plan\"\n                >\n                  {renewPlanMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"mr-2 animate-spin\" size={18} />\n                      Processing...\n                    </>\n                  ) : (\n                    <>\n                      <RefreshCw className=\"mr-2\" size={18} />\n                      Renew Current Plan\n                    </>\n                  )}\n                </Button>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/90 backdrop-blur-xl border-slate-700/50\">\n              <CardHeader>\n                <CardTitle className=\"text-white\">Available Plans</CardTitle>\n                <CardDescription className=\"text-slate-400\">Upgrade or change your plan</CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                {plans?.map((plan) => (\n                  <div\n                    key={plan.id}\n                    className={`p-4 rounded-lg border transition-colors ${\n                      customerData?.plan?.id === plan.id\n                        ? \"bg-cyan-500/10 border-cyan-500/50\"\n                        : \"bg-slate-700/30 border-slate-600/50 hover:border-cyan-500/30\"\n                    }`}\n                    data-testid={`plan-card-${plan.id}`}\n                  >\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <h4 className=\"font-semibold text-white\">{plan.name}</h4>\n                      {customerData?.plan?.id === plan.id && (\n                        <Badge className=\"bg-cyan-500/20 text-cyan-400 border-cyan-500/30\">\n                          Current\n                        </Badge>\n                      )}\n                    </div>\n                    <p className=\"text-sm text-slate-400 mb-2\">{formatDuration(plan.durationSeconds)} - {plan.downloadLimit}</p>\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-xl font-bold text-cyan-400\">{formatCurrency(plan.price)}</span>\n                      {customerData?.plan?.id !== plan.id && (\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => renewPlanMutation.mutate(plan.id)}\n                          disabled={renewPlanMutation.isPending}\n                          className=\"border-cyan-500/50 text-cyan-400 hover:bg-cyan-500/10\"\n                          data-testid={`button-buy-plan-${plan.id}`}\n                        >\n                          Buy Now\n                        </Button>\n                      )}\n                    </div>\n                  </div>\n                ))}\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/90 backdrop-blur-xl border-slate-700/50\">\n              <CardHeader>\n                <CardTitle className=\"text-white\">Need Help?</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                <a\n                  href=\"tel:+254700000000\"\n                  className=\"flex items-center gap-3 p-3 rounded-lg bg-slate-700/30 hover:bg-slate-700/50 transition-colors text-slate-300\"\n                  data-testid=\"link-support-phone\"\n                >\n                  <Phone size={18} className=\"text-cyan-400\" />\n                  <span>Call Support</span>\n                </a>\n                <a\n                  href=\"mailto:support@example.com\"\n                  className=\"flex items-center gap-3 p-3 rounded-lg bg-slate-700/30 hover:bg-slate-700/50 transition-colors text-slate-300\"\n                  data-testid=\"link-support-email\"\n                >\n                  <Mail size={18} className=\"text-cyan-400\" />\n                  <span>Email Support</span>\n                </a>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n          </TabsContent>\n\n          <TabsContent value=\"settings\">\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n              <Card className=\"bg-slate-800/90 backdrop-blur-xl border-slate-700/50\">\n                <CardHeader>\n                  <CardTitle className=\"text-xl text-white flex items-center gap-2\">\n                    <CreditCard size={20} className=\"text-cyan-400\" />\n                    Payment Settings\n                  </CardTitle>\n                  <CardDescription className=\"text-slate-400\">\n                    Manage your M-Pesa payment preferences\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"paymentPhone\" className=\"text-slate-300\">M-Pesa Payment Phone</Label>\n                    <div className=\"relative\">\n                      <Phone className=\"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400\" size={18} />\n                      <Input\n                        id=\"paymentPhone\"\n                        type=\"tel\"\n                        placeholder=\"07XX XXX XXX\"\n                        value={settings.paymentPhone}\n                        onChange={(e) => setSettings({ ...settings, paymentPhone: e.target.value })}\n                        className=\"pl-10 bg-slate-700/50 border-slate-600 text-white placeholder:text-slate-500\"\n                        data-testid=\"input-payment-phone\"\n                      />\n                    </div>\n                    <p className=\"text-xs text-slate-500\">\n                      This number will receive M-Pesa payment prompts for renewals\n                    </p>\n                  </div>\n\n                  <div className=\"flex items-center justify-between p-4 rounded-lg bg-slate-700/30\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"p-2 rounded-lg bg-cyan-500/20\">\n                        <RefreshCw size={18} className=\"text-cyan-400\" />\n                      </div>\n                      <div>\n                        <p className=\"text-white font-medium\">Auto-Renewal</p>\n                        <p className=\"text-xs text-slate-400\">\n                          Automatically renew your plan before expiry\n                        </p>\n                      </div>\n                    </div>\n                    <Switch\n                      checked={settings.autoRenew}\n                      onCheckedChange={(checked) => setSettings({ ...settings, autoRenew: checked })}\n                      data-testid=\"switch-auto-renew\"\n                    />\n                  </div>\n\n                  <Button\n                    onClick={() => saveSettingsMutation.mutate({\n                      paymentPhone: settings.paymentPhone,\n                      autoRenew: settings.autoRenew,\n                    })}\n                    className=\"w-full bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600\"\n                    disabled={saveSettingsMutation.isPending}\n                    data-testid=\"button-save-payment-settings\"\n                  >\n                    {saveSettingsMutation.isPending ? (\n                      <>\n                        <Loader2 className=\"mr-2 animate-spin\" size={18} />\n                        Saving...\n                      </>\n                    ) : (\n                      <>\n                        <Save className=\"mr-2\" size={18} />\n                        Save Payment Settings\n                      </>\n                    )}\n                  </Button>\n                </CardContent>\n              </Card>\n\n              <Card className=\"bg-slate-800/90 backdrop-blur-xl border-slate-700/50\">\n                <CardHeader>\n                  <CardTitle className=\"text-xl text-white flex items-center gap-2\">\n                    <User size={20} className=\"text-cyan-400\" />\n                    Profile Information\n                  </CardTitle>\n                  <CardDescription className=\"text-slate-400\">\n                    Update your personal information\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"fullName\" className=\"text-slate-300\">Full Name</Label>\n                    <Input\n                      id=\"fullName\"\n                      type=\"text\"\n                      placeholder=\"Enter your full name\"\n                      value={settings.fullName}\n                      onChange={(e) => setSettings({ ...settings, fullName: e.target.value })}\n                      className=\"bg-slate-700/50 border-slate-600 text-white placeholder:text-slate-500\"\n                      data-testid=\"input-full-name\"\n                    />\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"email\" className=\"text-slate-300\">Email Address</Label>\n                    <div className=\"relative\">\n                      <Mail className=\"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400\" size={18} />\n                      <Input\n                        id=\"email\"\n                        type=\"email\"\n                        placeholder=\"your@email.com\"\n                        value={settings.email}\n                        onChange={(e) => setSettings({ ...settings, email: e.target.value })}\n                        className=\"pl-10 bg-slate-700/50 border-slate-600 text-white placeholder:text-slate-500\"\n                        data-testid=\"input-email\"\n                      />\n                    </div>\n                    <p className=\"text-xs text-slate-500\">\n                      Receive payment receipts and notifications\n                    </p>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label className=\"text-slate-300\">Registered Phone</Label>\n                    <div className=\"p-3 rounded-lg bg-slate-700/30 border border-slate-600\">\n                      <div className=\"flex items-center gap-2\">\n                        <Phone size={16} className=\"text-slate-400\" />\n                        <span className=\"text-white\">{customerData?.user?.phoneNumber}</span>\n                        <Badge variant=\"outline\" className=\"ml-auto border-cyan-500/30 text-cyan-400 text-xs\">\n                          Verified\n                        </Badge>\n                      </div>\n                    </div>\n                    <p className=\"text-xs text-slate-500\">\n                      Contact support to change your registered phone\n                    </p>\n                  </div>\n\n                  <Button\n                    onClick={() => saveSettingsMutation.mutate({\n                      fullName: settings.fullName,\n                      email: settings.email,\n                    })}\n                    className=\"w-full bg-gradient-to-r from-cyan-500 to-purple-500 hover:from-cyan-600 hover:to-purple-600\"\n                    disabled={saveSettingsMutation.isPending}\n                    data-testid=\"button-save-profile\"\n                  >\n                    {saveSettingsMutation.isPending ? (\n                      <>\n                        <Loader2 className=\"mr-2 animate-spin\" size={18} />\n                        Saving...\n                      </>\n                    ) : (\n                      <>\n                        <Save className=\"mr-2\" size={18} />\n                        Save Profile\n                      </>\n                    )}\n                  </Button>\n                </CardContent>\n              </Card>\n            </div>\n          </TabsContent>\n        </Tabs>\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":34080,"size_tokens":null},"client/src/pages/verify-email.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation, Link } from \"wouter\";\nimport { motion } from \"framer-motion\";\nimport { Mail, CheckCircle, XCircle, Loader2, RefreshCw } from \"lucide-react\";\nimport { MeshBackground } from \"@/components/mesh-background\";\nimport { MnetiFiLogo } from \"@/components/mnetifi-logo\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function VerifyEmailPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [isVerifying, setIsVerifying] = useState(true);\n  const [isVerified, setIsVerified] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [resendEmail, setResendEmail] = useState(\"\");\n  const [isResending, setIsResending] = useState(false);\n\n  useEffect(() => {\n    const verifyEmail = async () => {\n      const params = new URLSearchParams(window.location.search);\n      const token = params.get(\"token\");\n\n      if (!token) {\n        setIsVerifying(false);\n        setError(\"No verification token provided\");\n        return;\n      }\n\n      try {\n        const response = await fetch(\"/api/auth/verify-email\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ token }),\n        });\n\n        const data = await response.json();\n\n        if (response.ok) {\n          setIsVerified(true);\n          toast({\n            title: \"Email Verified\",\n            description: \"Your email has been verified successfully. You can now log in.\",\n          });\n        } else {\n          setError(data.error || \"Verification failed\");\n        }\n      } catch (err) {\n        setError(\"Unable to connect to server\");\n      } finally {\n        setIsVerifying(false);\n      }\n    };\n\n    verifyEmail();\n  }, [toast]);\n\n  const handleResendVerification = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!resendEmail.trim()) {\n      toast({\n        title: \"Email required\",\n        description: \"Please enter your email address\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsResending(true);\n\n    try {\n      const response = await fetch(\"/api/auth/resend-verification\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ email: resendEmail }),\n      });\n\n      const data = await response.json();\n\n      if (response.ok) {\n        toast({\n          title: \"Verification Email Sent\",\n          description: \"If the email exists, a new verification link has been sent.\",\n        });\n        setResendEmail(\"\");\n      } else {\n        toast({\n          title: \"Error\",\n          description: data.error || \"Failed to resend verification email\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (err) {\n      toast({\n        title: \"Error\",\n        description: \"Unable to connect to server\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsResending(false);\n    }\n  };\n\n  return (\n    <>\n      <MeshBackground />\n      <div className=\"min-h-screen flex items-center justify-center p-4 relative z-10\">\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.5 }}\n          className=\"w-full max-w-md\"\n        >\n          <GlassPanel size=\"lg\" className=\"text-center\">\n            <div className=\"mb-8\">\n              <MnetiFiLogo size=\"lg\" className=\"mx-auto mb-4\" />\n              <Badge variant=\"outline\" className=\"bg-cyan-500/20 text-cyan-400 border-0 mb-4\">\n                <Mail size={12} className=\"mr-1\" />\n                Email Verification\n              </Badge>\n            </div>\n\n            {isVerifying ? (\n              <div className=\"py-8\">\n                <Loader2 size={48} className=\"mx-auto text-cyan-400 animate-spin mb-4\" />\n                <h2 className=\"text-xl font-semibold text-white mb-2\">Verifying your email...</h2>\n                <p className=\"text-muted-foreground\">Please wait while we verify your email address.</p>\n              </div>\n            ) : isVerified ? (\n              <div className=\"py-8\">\n                <div className=\"w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center mx-auto mb-4\">\n                  <CheckCircle size={32} className=\"text-green-400\" />\n                </div>\n                <h2 className=\"text-xl font-semibold text-white mb-2\">Email Verified!</h2>\n                <p className=\"text-muted-foreground mb-6\">\n                  Your email has been verified successfully. You can now log in to your account.\n                </p>\n                <Button\n                  onClick={() => setLocation(\"/login\")}\n                  className=\"w-full gradient-btn\"\n                  data-testid=\"button-go-to-login\"\n                >\n                  Go to Login\n                </Button>\n              </div>\n            ) : (\n              <div className=\"py-4\">\n                <div className=\"w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center mx-auto mb-4\">\n                  <XCircle size={32} className=\"text-red-400\" />\n                </div>\n                <h2 className=\"text-xl font-semibold text-white mb-2\">Verification Failed</h2>\n                <p className=\"text-muted-foreground mb-6\">{error}</p>\n\n                <div className=\"border-t border-white/10 pt-6\">\n                  <p className=\"text-sm text-muted-foreground mb-4\">\n                    Need a new verification link? Enter your email below:\n                  </p>\n                  <form onSubmit={handleResendVerification} className=\"space-y-4\">\n                    <GlassInput\n                      label=\"Email Address\"\n                      type=\"email\"\n                      placeholder=\"your@email.com\"\n                      value={resendEmail}\n                      onChange={(e) => setResendEmail(e.target.value)}\n                      icon={<Mail size={16} />}\n                      data-testid=\"input-resend-email\"\n                    />\n                    <Button\n                      type=\"submit\"\n                      className=\"w-full\"\n                      variant=\"outline\"\n                      disabled={isResending}\n                      data-testid=\"button-resend-verification\"\n                    >\n                      {isResending ? (\n                        <>\n                          <Loader2 size={18} className=\"mr-2 animate-spin\" />\n                          Sending...\n                        </>\n                      ) : (\n                        <>\n                          <RefreshCw size={18} className=\"mr-2\" />\n                          Resend Verification Email\n                        </>\n                      )}\n                    </Button>\n                  </form>\n                </div>\n              </div>\n            )}\n\n            <div className=\"mt-6 pt-6 border-t border-white/10\">\n              <p className=\"text-sm text-muted-foreground\">\n                Already verified?{\" \"}\n                <Link \n                  href=\"/login\" \n                  className=\"text-cyan-400 hover:text-cyan-300 transition-colors font-medium\"\n                  data-testid=\"link-login\"\n                >\n                  Sign in here\n                </Link>\n              </p>\n            </div>\n          </GlassPanel>\n        </motion.div>\n      </div>\n    </>\n  );\n}\n","path":null,"size_bytes":7626,"size_tokens":null},"client/src/lib/export-utils.ts":{"content":"import { format } from \"date-fns\";\n\nexport function exportToCSV<T extends Record<string, any>>(\n  data: T[],\n  columns: { key: keyof T; header: string; formatter?: (value: any, row: T) => string }[],\n  filename: string\n): void {\n  if (!data || data.length === 0) {\n    return;\n  }\n\n  const headers = columns.map((col) => col.header);\n  \n  const rows = data.map((row) =>\n    columns.map((col) => {\n      const value = row[col.key];\n      const formatted = col.formatter ? col.formatter(value, row) : value;\n      const stringValue = formatted != null ? String(formatted) : \"\";\n      return `\"${stringValue.replace(/\"/g, '\"\"')}\"`;\n    })\n  );\n\n  const csvContent = [\n    headers.join(\",\"),\n    ...rows.map((row) => row.join(\",\"))\n  ].join(\"\\n\");\n\n  const blob = new Blob([csvContent], { type: \"text/csv;charset=utf-8;\" });\n  const url = URL.createObjectURL(blob);\n  const link = document.createElement(\"a\");\n  link.setAttribute(\"href\", url);\n  link.setAttribute(\"download\", `${filename}_${format(new Date(), \"yyyy-MM-dd_HHmm\")}.csv`);\n  document.body.appendChild(link);\n  link.click();\n  document.body.removeChild(link);\n  URL.revokeObjectURL(url);\n}\n","path":null,"size_bytes":1149,"size_tokens":null},"client/src/pages/vouchers.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Plus, Ticket, Copy, Check, Search, Filter, Printer } from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Plan, Voucher, VoucherBatch } from \"@shared/schema\";\n\nfunction formatDuration(seconds: number): string {\n  if (seconds < 3600) return `${Math.floor(seconds / 60)} min`;\n  if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours`;\n  return `${Math.floor(seconds / 86400)} days`;\n}\n\nfunction formatDate(date: string | Date | null): string {\n  if (!date) return \"-\";\n  return new Date(date).toLocaleDateString(\"en-US\", {\n    year: \"numeric\",\n    month: \"short\",\n    day: \"numeric\",\n  });\n}\n\nfunction VoucherBatchCard({ batch, plans, onViewVouchers }: { \n  batch: VoucherBatch; \n  plans: Plan[];\n  onViewVouchers: (batchId: string) => void;\n}) {\n  const plan = plans.find(p => p.id === batch.planId);\n  const usedPercentage = batch.quantity > 0 ? (batch.usedCount / batch.quantity) * 100 : 0;\n  \n  return (\n    <motion.div\n      layout\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      exit={{ opacity: 0, scale: 0.9 }}\n    >\n      <GlassPanel className=\"p-4 space-y-4\">\n        <div className=\"flex items-center justify-between gap-2\">\n          <div className=\"flex items-center gap-2\">\n            <div className=\"w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center\">\n              <Ticket className=\"w-5 h-5 text-primary\" />\n            </div>\n            <div>\n              <h3 className=\"font-semibold text-foreground\" data-testid={`batch-name-${batch.id}`}>{batch.name}</h3>\n              <p className=\"text-xs text-muted-foreground\">{batch.prefix ? `Prefix: ${batch.prefix}` : \"No prefix\"}</p>\n            </div>\n          </div>\n          <Badge variant={usedPercentage === 100 ? \"secondary\" : \"default\"} className=\"text-xs\">\n            {batch.usedCount}/{batch.quantity} used\n          </Badge>\n        </div>\n        \n        <div className=\"space-y-2\">\n          <div className=\"flex justify-between text-sm\">\n            <span className=\"text-muted-foreground\">Plan:</span>\n            <span className=\"font-medium\">{plan?.name || \"Unknown\"}</span>\n          </div>\n          <div className=\"flex justify-between text-sm\">\n            <span className=\"text-muted-foreground\">Duration:</span>\n            <span className=\"font-medium\">{plan ? formatDuration(plan.durationSeconds) : \"-\"}</span>\n          </div>\n          <div className=\"flex justify-between text-sm\">\n            <span className=\"text-muted-foreground\">Valid Until:</span>\n            <span className=\"font-medium\">{formatDate(batch.validUntil)}</span>\n          </div>\n        </div>\n\n        <div className=\"w-full bg-secondary rounded-full h-2\">\n          <div \n            className=\"bg-primary h-2 rounded-full transition-all\" \n            style={{ width: `${usedPercentage}%` }}\n          />\n        </div>\n\n        <Button \n          variant=\"outline\" \n          size=\"sm\" \n          className=\"w-full\"\n          onClick={() => onViewVouchers(batch.id)}\n          data-testid={`button-view-vouchers-${batch.id}`}\n        >\n          View Vouchers\n        </Button>\n      </GlassPanel>\n    </motion.div>\n  );\n}\n\nfunction VoucherRow({ voucher, plan, onCopy }: { \n  voucher: Voucher; \n  plan?: Plan;\n  onCopy: (code: string) => void;\n}) {\n  const [copied, setCopied] = useState(false);\n  \n  const handleCopy = () => {\n    onCopy(voucher.code);\n    setCopied(true);\n    setTimeout(() => setCopied(false), 2000);\n  };\n\n  const statusColors: Record<string, string> = {\n    AVAILABLE: \"bg-green-500/20 text-green-400\",\n    USED: \"bg-gray-500/20 text-gray-400\",\n    EXPIRED: \"bg-red-500/20 text-red-400\",\n    DISABLED: \"bg-yellow-500/20 text-yellow-400\",\n  };\n  \n  return (\n    <TableRow>\n      <TableCell className=\"font-mono font-semibold\" data-testid={`voucher-code-${voucher.id}`}>\n        {voucher.code}\n      </TableCell>\n      <TableCell>\n        <Badge className={statusColors[voucher.status] || \"\"}>\n          {voucher.status}\n        </Badge>\n      </TableCell>\n      <TableCell>{plan?.name || \"-\"}</TableCell>\n      <TableCell>{formatDate(voucher.usedAt)}</TableCell>\n      <TableCell>{formatDate(voucher.expiresAt)}</TableCell>\n      <TableCell>\n        <Button \n          variant=\"ghost\" \n          size=\"icon\"\n          onClick={handleCopy}\n          data-testid={`button-copy-${voucher.id}`}\n        >\n          {copied ? <Check size={16} className=\"text-green-400\" /> : <Copy size={16} />}\n        </Button>\n      </TableCell>\n    </TableRow>\n  );\n}\n\nexport default function VouchersPage() {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [isVoucherListOpen, setIsVoucherListOpen] = useState(false);\n  const [selectedBatchId, setSelectedBatchId] = useState<string | null>(null);\n  const [statusFilter, setStatusFilter] = useState<string>(\"all\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const [formData, setFormData] = useState({\n    name: \"\",\n    planId: \"\",\n    quantity: 10,\n    prefix: \"\",\n    validUntil: \"\",\n  });\n\n  const { data: batches, isLoading: batchesLoading } = useQuery<VoucherBatch[]>({\n    queryKey: [\"/api/voucher-batches\"],\n  });\n\n  const { data: plans } = useQuery<Plan[]>({\n    queryKey: [\"/api/plans\"],\n  });\n\n  const { data: batchVouchers } = useQuery<Voucher[]>({\n    queryKey: [\"/api/voucher-batches\", selectedBatchId, \"vouchers\"],\n    queryFn: async () => {\n      if (!selectedBatchId) return [];\n      const res = await fetch(`/api/voucher-batches/${selectedBatchId}/vouchers`);\n      if (!res.ok) throw new Error(\"Failed to fetch vouchers\");\n      return res.json();\n    },\n    enabled: !!selectedBatchId,\n  });\n\n  const createBatchMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      return apiRequest(\"POST\", \"/api/voucher-batches\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/voucher-batches\"] });\n      toast({\n        title: \"Vouchers Created\",\n        description: `Successfully created ${formData.quantity} vouchers.`,\n      });\n      handleCloseDialog();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create vouchers\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleOpenDialog = () => {\n    setFormData({\n      name: \"\",\n      planId: \"\",\n      quantity: 10,\n      prefix: \"\",\n      validUntil: \"\",\n    });\n    setIsDialogOpen(true);\n  };\n\n  const handleCloseDialog = () => {\n    setIsDialogOpen(false);\n    setFormData({\n      name: \"\",\n      planId: \"\",\n      quantity: 10,\n      prefix: \"\",\n      validUntil: \"\",\n    });\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!formData.name || !formData.planId || formData.quantity < 1) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Please fill in all required fields\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    createBatchMutation.mutate(formData);\n  };\n\n  const handleViewVouchers = (batchId: string) => {\n    setSelectedBatchId(batchId);\n    setIsVoucherListOpen(true);\n  };\n\n  const handleCloseVoucherList = () => {\n    setIsVoucherListOpen(false);\n    setSelectedBatchId(null);\n  };\n\n  const handleCopyCode = (code: string) => {\n    navigator.clipboard.writeText(code);\n    toast({\n      title: \"Copied\",\n      description: `Voucher code ${code} copied to clipboard`,\n    });\n  };\n\n  const handlePrintVouchers = () => {\n    if (!batchVouchers || !selectedBatchId) return;\n    const batch = batches?.find(b => b.id === selectedBatchId);\n    const plan = plans?.find(p => p.id === batch?.planId);\n    \n    const printContent = batchVouchers\n      .filter(v => v.status === \"AVAILABLE\")\n      .map(v => `Code: ${v.code} | Plan: ${plan?.name || \"N/A\"}`)\n      .join(\"\\n\");\n    \n    const printWindow = window.open(\"\", \"_blank\");\n    if (printWindow) {\n      printWindow.document.write(`\n        <html>\n          <head><title>Voucher Codes - ${batch?.name}</title></head>\n          <body style=\"font-family: monospace; padding: 20px;\">\n            <h2>${batch?.name} - Voucher Codes</h2>\n            <pre>${printContent}</pre>\n          </body>\n        </html>\n      `);\n      printWindow.document.close();\n      printWindow.print();\n    }\n  };\n\n  const filteredVouchers = batchVouchers?.filter(v => {\n    if (statusFilter !== \"all\" && v.status !== statusFilter) return false;\n    if (searchQuery && !v.code.toLowerCase().includes(searchQuery.toLowerCase())) return false;\n    return true;\n  });\n\n  const quantityPresets = [10, 25, 50, 100, 200, 500];\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"vouchers-page\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-foreground\">Vouchers</h1>\n          <p className=\"text-muted-foreground\">\n            Generate and manage WiFi access codes\n          </p>\n        </div>\n        <Button\n          className=\"gradient-btn\"\n          onClick={handleOpenDialog}\n          data-testid=\"button-create-batch\"\n        >\n          <Plus size={18} className=\"mr-2\" />\n          Generate Vouchers\n        </Button>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\n        {batchesLoading ? (\n          Array.from({ length: 4 }).map((_, i) => (\n            <GlassPanel key={i} className=\"p-4 h-48 animate-pulse\">\n              <div className=\"h-full bg-muted/20 rounded-lg\" />\n            </GlassPanel>\n          ))\n        ) : batches && batches.length > 0 ? (\n          <AnimatePresence mode=\"popLayout\">\n            {batches.map(batch => (\n              <VoucherBatchCard \n                key={batch.id} \n                batch={batch} \n                plans={plans || []}\n                onViewVouchers={handleViewVouchers}\n              />\n            ))}\n          </AnimatePresence>\n        ) : (\n          <GlassPanel className=\"col-span-full p-12 text-center\">\n            <Ticket size={48} className=\"mx-auto text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-medium text-foreground mb-2\">No vouchers yet</h3>\n            <p className=\"text-muted-foreground mb-4\">\n              Generate your first batch of WiFi access vouchers\n            </p>\n            <Button onClick={handleOpenDialog} data-testid=\"button-create-first-batch\">\n              <Plus size={18} className=\"mr-2\" />\n              Generate Vouchers\n            </Button>\n          </GlassPanel>\n        )}\n      </div>\n\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Generate Vouchers</DialogTitle>\n          </DialogHeader>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Batch Name</label>\n              <GlassInput\n                placeholder=\"e.g., Weekend Promo, School Term 1\"\n                value={formData.name}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                data-testid=\"input-batch-name\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Select Plan</label>\n              <Select\n                value={formData.planId}\n                onValueChange={(value) => setFormData({ ...formData, planId: value })}\n              >\n                <SelectTrigger data-testid=\"select-plan\">\n                  <SelectValue placeholder=\"Choose a plan\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {plans?.map(plan => (\n                    <SelectItem key={plan.id} value={plan.id}>\n                      {plan.name} - KES {plan.price} ({formatDuration(plan.durationSeconds)})\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Quantity</label>\n              <div className=\"flex flex-wrap gap-2 mb-2\">\n                {quantityPresets.map(qty => (\n                  <Button\n                    key={qty}\n                    type=\"button\"\n                    variant={formData.quantity === qty ? \"default\" : \"outline\"}\n                    size=\"sm\"\n                    onClick={() => setFormData({ ...formData, quantity: qty })}\n                    data-testid={`button-qty-${qty}`}\n                  >\n                    {qty}\n                  </Button>\n                ))}\n              </div>\n              <GlassInput\n                type=\"number\"\n                min=\"1\"\n                max=\"1000\"\n                value={formData.quantity}\n                onChange={(e) => setFormData({ ...formData, quantity: parseInt(e.target.value) || 1 })}\n                data-testid=\"input-quantity\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Code Prefix (Optional)</label>\n              <GlassInput\n                placeholder=\"e.g., WIFI, PROMO\"\n                value={formData.prefix}\n                onChange={(e) => setFormData({ ...formData, prefix: e.target.value.toUpperCase() })}\n                maxLength={6}\n                data-testid=\"input-prefix\"\n              />\n              <p className=\"text-xs text-muted-foreground\">Vouchers will look like: {formData.prefix || \"ABC\"}-XXXXXXXX</p>\n            </div>\n\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Valid Until (Optional)</label>\n              <GlassInput\n                type=\"date\"\n                value={formData.validUntil}\n                onChange={(e) => setFormData({ ...formData, validUntil: e.target.value })}\n                data-testid=\"input-valid-until\"\n              />\n            </div>\n\n            <div className=\"flex gap-2 pt-4\">\n              <Button type=\"button\" variant=\"outline\" className=\"flex-1\" onClick={handleCloseDialog}>\n                Cancel\n              </Button>\n              <Button \n                type=\"submit\" \n                className=\"flex-1 gradient-btn\" \n                disabled={createBatchMutation.isPending}\n                data-testid=\"button-submit-batch\"\n              >\n                {createBatchMutation.isPending ? \"Creating...\" : \"Generate Vouchers\"}\n              </Button>\n            </div>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={isVoucherListOpen} onOpenChange={setIsVoucherListOpen}>\n        <DialogContent className=\"sm:max-w-3xl max-h-[80vh]\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center justify-between gap-2 flex-wrap\">\n              <span>Voucher Codes</span>\n              <Button variant=\"outline\" size=\"sm\" onClick={handlePrintVouchers} data-testid=\"button-print\">\n                <Printer size={16} className=\"mr-2\" />\n                Print Available\n              </Button>\n            </DialogTitle>\n          </DialogHeader>\n          \n          <div className=\"flex items-center gap-2 mb-4 flex-wrap\">\n            <div className=\"flex-1 min-w-[200px]\">\n              <div className=\"relative\">\n                <Search size={16} className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" />\n                <GlassInput\n                  placeholder=\"Search codes...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-10\"\n                  data-testid=\"input-search-vouchers\"\n                />\n              </div>\n            </div>\n            <Select value={statusFilter} onValueChange={setStatusFilter}>\n              <SelectTrigger className=\"w-40\" data-testid=\"select-status-filter\">\n                <Filter size={16} className=\"mr-2\" />\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Status</SelectItem>\n                <SelectItem value=\"AVAILABLE\">Available</SelectItem>\n                <SelectItem value=\"USED\">Used</SelectItem>\n                <SelectItem value=\"EXPIRED\">Expired</SelectItem>\n                <SelectItem value=\"DISABLED\">Disabled</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"overflow-auto max-h-[400px]\">\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Code</TableHead>\n                  <TableHead>Status</TableHead>\n                  <TableHead>Plan</TableHead>\n                  <TableHead>Used At</TableHead>\n                  <TableHead>Expires</TableHead>\n                  <TableHead></TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {filteredVouchers?.map(voucher => {\n                  const plan = plans?.find(p => p.id === voucher.planId);\n                  return (\n                    <VoucherRow \n                      key={voucher.id} \n                      voucher={voucher} \n                      plan={plan}\n                      onCopy={handleCopyCode}\n                    />\n                  );\n                })}\n              </TableBody>\n            </Table>\n            {filteredVouchers?.length === 0 && (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                No vouchers found\n              </div>\n            )}\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":18533,"size_tokens":null},"client/src/pages/hotspot-plans.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { motion } from \"framer-motion\";\nimport {\n  Wifi,\n  Plus,\n  Pencil,\n  Trash2,\n  Loader2,\n  Clock,\n  Smartphone,\n  Upload,\n  Download,\n  Palette,\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { Plan } from \"@shared/schema\";\n\nexport default function HotspotPlansPage() {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingPlan, setEditingPlan] = useState<Plan | null>(null);\n  const [formData, setFormData] = useState({\n    name: \"\",\n    description: \"\",\n    price: \"\",\n    durationSeconds: \"3600\",\n    uploadLimit: \"\",\n    downloadLimit: \"\",\n    maxDevices: \"1\",\n  });\n\n  const { data: plans, isLoading } = useQuery<Plan[]>({\n    queryKey: [\"/api/plans?type=HOTSPOT\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      const price = parseInt(data.price) || 0;\n      const durationSeconds = parseInt(data.durationSeconds) || 3600;\n      const maxDevices = parseInt(data.maxDevices) || 1;\n      if (price <= 0) {\n        throw new Error(\"Price must be a valid positive number\");\n      }\n      return apiRequest(\"POST\", \"/api/plans\", {\n        name: data.name,\n        description: data.description,\n        price,\n        planType: \"HOTSPOT\",\n        durationSeconds,\n        uploadLimit: data.uploadLimit || undefined,\n        downloadLimit: data.downloadLimit || undefined,\n        maxDevices,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/plans?type=HOTSPOT\"] });\n      setIsDialogOpen(false);\n      resetForm();\n      toast({\n        title: \"Plan Created\",\n        description: \"Hotspot plan has been created successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create plan\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: typeof formData & { id: string }) => {\n      const price = parseInt(data.price) || 0;\n      const durationSeconds = parseInt(data.durationSeconds) || 3600;\n      const maxDevices = parseInt(data.maxDevices) || 1;\n      if (price <= 0) {\n        throw new Error(\"Price must be a valid positive number\");\n      }\n      return apiRequest(\"PATCH\", `/api/plans/${data.id}`, {\n        name: data.name,\n        description: data.description,\n        price,\n        durationSeconds,\n        uploadLimit: data.uploadLimit || undefined,\n        downloadLimit: data.downloadLimit || undefined,\n        maxDevices,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/plans?type=HOTSPOT\"] });\n      setIsDialogOpen(false);\n      setEditingPlan(null);\n      resetForm();\n      toast({\n        title: \"Plan Updated\",\n        description: \"Hotspot plan has been updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update plan\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/plans/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/plans?type=HOTSPOT\"] });\n      toast({\n        title: \"Plan Deleted\",\n        description: \"Hotspot plan has been deleted.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to delete plan\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      name: \"\",\n      description: \"\",\n      price: \"\",\n      durationSeconds: \"3600\",\n      uploadLimit: \"\",\n      downloadLimit: \"\",\n      maxDevices: \"1\",\n    });\n  };\n\n  const handleOpenCreate = () => {\n    resetForm();\n    setEditingPlan(null);\n    setIsDialogOpen(true);\n  };\n\n  const handleOpenEdit = (plan: Plan) => {\n    setEditingPlan(plan);\n    setFormData({\n      name: plan.name,\n      description: plan.description || \"\",\n      price: plan.price.toString(),\n      durationSeconds: plan.durationSeconds.toString(),\n      uploadLimit: plan.uploadLimit || \"\",\n      downloadLimit: plan.downloadLimit || \"\",\n      maxDevices: plan.maxDevices?.toString() || \"1\",\n    });\n    setIsDialogOpen(true);\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (editingPlan) {\n      updateMutation.mutate({ ...formData, id: editingPlan.id });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat(\"en-KE\", {\n      style: \"currency\",\n      currency: \"KES\",\n      minimumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  const formatDuration = (seconds: number) => {\n    if (seconds < 3600) return `${Math.floor(seconds / 60)} min`;\n    if (seconds < 86400) return `${Math.floor(seconds / 3600)} hour${seconds >= 7200 ? \"s\" : \"\"}`;\n    return `${Math.floor(seconds / 86400)} day${seconds >= 172800 ? \"s\" : \"\"}`;\n  };\n\n  const durationPresets = [\n    { label: \"30 min\", value: \"1800\" },\n    { label: \"1 hour\", value: \"3600\" },\n    { label: \"3 hours\", value: \"10800\" },\n    { label: \"1 day\", value: \"86400\" },\n    { label: \"7 days\", value: \"604800\" },\n    { label: \"30 days\", value: \"2592000\" },\n  ];\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"hotspot-plans-page\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white\">Hotspot Plans</h1>\n          <p className=\"text-muted-foreground\">\n            Manage time-based WiFi packages for captive portal customers\n          </p>\n        </div>\n        <div className=\"flex items-center gap-3\">\n          <Link href=\"/dashboard/portal-designer\">\n            <Button variant=\"outline\" className=\"gap-2\" data-testid=\"button-design-portal\">\n              <Palette size={18} />\n              Design Portal\n            </Button>\n          </Link>\n          <Button className=\"gradient-btn\" onClick={handleOpenCreate} data-testid=\"button-create-plan\">\n            <Plus size={18} className=\"mr-2\" />\n            Create Plan\n          </Button>\n        </div>\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n          {[1, 2, 3].map((i) => (\n            <div key={i} className=\"animate-pulse glass-panel p-6\">\n              <div className=\"h-6 bg-white/10 rounded w-2/3 mb-4\" />\n              <div className=\"h-10 bg-white/10 rounded w-1/2 mb-4\" />\n              <div className=\"space-y-2\">\n                <div className=\"h-4 bg-white/10 rounded w-full\" />\n                <div className=\"h-4 bg-white/10 rounded w-3/4\" />\n              </div>\n            </div>\n          ))}\n        </div>\n      ) : plans && plans.length > 0 ? (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n          {plans.map((plan, index) => (\n            <motion.div\n              key={plan.id}\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: index * 0.1 }}\n            >\n              <GlassPanel size=\"md\" className=\"relative\">\n                <div className=\"absolute top-4 right-4 flex items-center gap-2\">\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={() => handleOpenEdit(plan)}\n                    data-testid={`button-edit-plan-${plan.id}`}\n                  >\n                    <Pencil size={16} />\n                  </Button>\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={() => deleteMutation.mutate(plan.id)}\n                    data-testid={`button-delete-plan-${plan.id}`}\n                  >\n                    <Trash2 size={16} />\n                  </Button>\n                </div>\n\n                <div className=\"flex items-center gap-3 mb-4\">\n                  <div className=\"w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center\">\n                    <Wifi size={24} className=\"text-green-400\" />\n                  </div>\n                  <div>\n                    <h3 className=\"font-semibold text-white\">{plan.name}</h3>\n                    <Badge variant=\"outline\" className=\"text-xs bg-green-500/20 text-green-400 border-green-500/30\">\n                      Hotspot\n                    </Badge>\n                  </div>\n                </div>\n\n                <div className=\"mb-4\">\n                  <p className=\"text-3xl font-bold gradient-text\">\n                    {formatCurrency(plan.price)}\n                  </p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    for {formatDuration(plan.durationSeconds)}\n                  </p>\n                </div>\n\n                <div className=\"space-y-2 text-sm\">\n                  <div className=\"flex items-center gap-2 text-muted-foreground\">\n                    <Clock size={14} className=\"text-green-400\" />\n                    <span>{formatDuration(plan.durationSeconds)} validity</span>\n                  </div>\n                  {plan.uploadLimit && (\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <Upload size={14} className=\"text-cyan-400\" />\n                      <span>{plan.uploadLimit} upload</span>\n                    </div>\n                  )}\n                  {plan.downloadLimit && (\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <Download size={14} className=\"text-purple-400\" />\n                      <span>{plan.downloadLimit} download</span>\n                    </div>\n                  )}\n                  {plan.maxDevices && plan.maxDevices > 1 && (\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <Smartphone size={14} className=\"text-amber-400\" />\n                      <span>{plan.maxDevices} devices</span>\n                    </div>\n                  )}\n                  {plan.description && (\n                    <p className=\"text-muted-foreground mt-2\">{plan.description}</p>\n                  )}\n                </div>\n              </GlassPanel>\n            </motion.div>\n          ))}\n        </div>\n      ) : (\n        <GlassPanel size=\"lg\" className=\"text-center py-12\">\n          <Wifi size={48} className=\"mx-auto mb-4 text-muted-foreground opacity-50\" />\n          <h3 className=\"text-lg font-semibold text-white mb-2\">No Hotspot Plans</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            Create your first hotspot plan to start accepting payments\n          </p>\n          <Button className=\"gradient-btn\" onClick={handleOpenCreate}>\n            <Plus size={18} className=\"mr-2\" />\n            Create First Plan\n          </Button>\n        </GlassPanel>\n      )}\n\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"bg-card border-white/10\">\n          <DialogHeader>\n            <DialogTitle className=\"text-white\">\n              {editingPlan ? \"Edit Hotspot Plan\" : \"Create Hotspot Plan\"}\n            </DialogTitle>\n          </DialogHeader>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label>Plan Name</Label>\n              <Input\n                placeholder=\"e.g., Daily WiFi\"\n                value={formData.name}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                required\n                data-testid=\"input-plan-name\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Duration</Label>\n                <Select\n                  value={formData.durationSeconds}\n                  onValueChange={(value) => setFormData({ ...formData, durationSeconds: value })}\n                >\n                  <SelectTrigger data-testid=\"select-duration\">\n                    <SelectValue placeholder=\"Select duration\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {durationPresets.map((preset) => (\n                      <SelectItem key={preset.value} value={preset.value}>\n                        {preset.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Price (KES)</Label>\n                <Input\n                  type=\"number\"\n                  placeholder=\"50\"\n                  value={formData.price}\n                  onChange={(e) => setFormData({ ...formData, price: e.target.value })}\n                  required\n                  data-testid=\"input-price\"\n                />\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Upload Limit (e.g., 2M)</Label>\n                <Input\n                  placeholder=\"2M\"\n                  value={formData.uploadLimit}\n                  onChange={(e) => setFormData({ ...formData, uploadLimit: e.target.value })}\n                  data-testid=\"input-upload-limit\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Download Limit (e.g., 5M)</Label>\n                <Input\n                  placeholder=\"5M\"\n                  value={formData.downloadLimit}\n                  onChange={(e) => setFormData({ ...formData, downloadLimit: e.target.value })}\n                  data-testid=\"input-download-limit\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Max Devices per Voucher</Label>\n              <div className=\"flex items-center gap-2\">\n                <Smartphone size={16} className=\"text-muted-foreground\" />\n                <Input\n                  type=\"number\"\n                  min=\"1\"\n                  max=\"20\"\n                  placeholder=\"1\"\n                  value={formData.maxDevices}\n                  onChange={(e) => setFormData({ ...formData, maxDevices: e.target.value })}\n                  data-testid=\"input-max-devices\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Description (Optional)</Label>\n              <Textarea\n                placeholder=\"Plan description...\"\n                value={formData.description}\n                onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                data-testid=\"input-description\"\n              />\n            </div>\n\n            <DialogFooter>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => setIsDialogOpen(false)}\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                className=\"gradient-btn\"\n                disabled={createMutation.isPending || updateMutation.isPending}\n                data-testid=\"button-submit-plan\"\n              >\n                {(createMutation.isPending || updateMutation.isPending) && (\n                  <Loader2 size={16} className=\"mr-2 animate-spin\" />\n                )}\n                {editingPlan ? \"Update Plan\" : \"Create Plan\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":16560,"size_tokens":null},"client/src/pages/reports.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { \n  BarChart3, \n  Download, \n  TrendingUp, \n  Users, \n  CreditCard, \n  FileCheck,\n  Calendar,\n  AlertTriangle,\n  CheckCircle,\n  Clock,\n  Loader2\n} from \"lucide-react\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\n\ninterface FinancialReport {\n  summary: {\n    totalRevenue: number;\n    totalTransactions: number;\n    successfulTransactions: number;\n    failedTransactions: number;\n    pendingTransactions: number;\n    averageTransactionValue: number;\n  };\n  dailyRevenue: Array<{ date: string; amount: number }>;\n  planRevenue: Array<{ name: string; amount: number; count: number }>;\n}\n\ninterface ReconciliationReport {\n  summary: {\n    totalTransactions: number;\n    matchedCount: number;\n    unmatchedCount: number;\n    manualReviewCount: number;\n    pendingCount: number;\n    matchRate: number;\n  };\n  transactions: Array<{\n    id: string;\n    amount: number;\n    status: string;\n    reconciliationStatus: string;\n    mpesaReceiptNumber: string | null;\n    createdAt: string;\n  }>;\n}\n\ninterface UserActivityReport {\n  summary: {\n    totalUsers: number;\n    activeUsers: number;\n    expiredUsers: number;\n    suspendedUsers: number;\n    expiringIn24h: number;\n    expiringIn48h: number;\n  };\n  expiringUsers: Array<{\n    id: string;\n    username: string;\n    expiryTime: string;\n    phoneNumber: string;\n  }>;\n}\n\nexport default function ReportsPage() {\n  const [activeTab, setActiveTab] = useState(\"financial\");\n  const [startDate, setStartDate] = useState(() => {\n    const date = new Date();\n    date.setDate(date.getDate() - 30);\n    return date.toISOString().split(\"T\")[0];\n  });\n  const [endDate, setEndDate] = useState(() => new Date().toISOString().split(\"T\")[0]);\n\n  const { data: financialReport, isLoading: financialLoading } = useQuery<FinancialReport>({\n    queryKey: [\"/api/reports/financial\", startDate, endDate],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (startDate) params.append(\"startDate\", startDate);\n      if (endDate) params.append(\"endDate\", endDate);\n      const res = await fetch(`/api/reports/financial?${params}`);\n      if (!res.ok) throw new Error(\"Failed to fetch financial report\");\n      return res.json();\n    },\n  });\n\n  const { data: reconciliationReport, isLoading: reconciliationLoading } = useQuery<ReconciliationReport>({\n    queryKey: [\"/api/reports/reconciliation\", startDate, endDate],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (startDate) params.append(\"startDate\", startDate);\n      if (endDate) params.append(\"endDate\", endDate);\n      const res = await fetch(`/api/reports/reconciliation?${params}`);\n      if (!res.ok) throw new Error(\"Failed to fetch reconciliation report\");\n      return res.json();\n    },\n  });\n\n  const { data: userActivityReport, isLoading: userActivityLoading } = useQuery<UserActivityReport>({\n    queryKey: [\"/api/reports/user-activity\"],\n  });\n\n  const formatCurrency = (amount: number) => `KES ${amount.toLocaleString()}`;\n\n  const formatCSVValue = (val: unknown): string => {\n    if (val === null || val === undefined) return \"\";\n    if (val instanceof Date) return val.toISOString();\n    if (typeof val === \"object\") return JSON.stringify(val);\n    const strVal = String(val);\n    if (strVal.includes(\",\") || strVal.includes('\"') || strVal.includes(\"\\n\")) {\n      return `\"${strVal.replace(/\"/g, '\"\"')}\"`;\n    }\n    return strVal;\n  };\n\n  const exportToCSV = (data: Record<string, unknown>[], filename: string) => {\n    if (!data || data.length === 0) return;\n    \n    const headers = Object.keys(data[0]);\n    const csvContent = [\n      headers.join(\",\"),\n      ...data.map(row => headers.map(h => formatCSVValue(row[h])).join(\",\"))\n    ].join(\"\\n\");\n    \n    const blob = new Blob([csvContent], { type: \"text/csv;charset=utf-8;\" });\n    const link = document.createElement(\"a\");\n    link.href = URL.createObjectURL(blob);\n    link.download = `${filename}_${new Date().toISOString().split(\"T\")[0]}.csv`;\n    link.click();\n  };\n\n  const exportToExcel = (data: Record<string, unknown>[], filename: string) => {\n    if (!data || data.length === 0) return;\n    \n    const headers = Object.keys(data[0]);\n    const escapeXml = (val: unknown): string => {\n      if (val === null || val === undefined) return \"\";\n      return String(val).replace(/&/g, \"&amp;\").replace(/</g, \"&lt;\").replace(/>/g, \"&gt;\");\n    };\n    \n    const rows = data.map(row => \n      `<Row>${headers.map(h => {\n        const val = row[h];\n        const cellType = typeof val === \"number\" ? \"Number\" : \"String\";\n        return `<Cell><Data ss:Type=\"${cellType}\">${escapeXml(val)}</Data></Cell>`;\n      }).join(\"\")}</Row>`\n    ).join(\"\\n\");\n    \n    const xmlContent = `<?xml version=\"1.0\"?>\n<?mso-application progid=\"Excel.Sheet\"?>\n<Workbook xmlns=\"urn:schemas-microsoft-com:office:spreadsheet\"\n xmlns:ss=\"urn:schemas-microsoft-com:office:spreadsheet\">\n<Worksheet ss:Name=\"Report\">\n<Table>\n<Row>${headers.map(h => `<Cell><Data ss:Type=\"String\">${escapeXml(h)}</Data></Cell>`).join(\"\")}</Row>\n${rows}\n</Table>\n</Worksheet>\n</Workbook>`;\n    \n    const blob = new Blob([xmlContent], { type: \"application/vnd.ms-excel\" });\n    const link = document.createElement(\"a\");\n    link.href = URL.createObjectURL(blob);\n    link.download = `${filename}_${new Date().toISOString().split(\"T\")[0]}.xls`;\n    link.click();\n  };\n\n  type ExportFormat = \"csv\" | \"excel\";\n  const [exportFormat, setExportFormat] = useState<ExportFormat>(\"csv\");\n\n  const exportData = (data: Record<string, unknown>[], filename: string) => {\n    if (exportFormat === \"excel\") {\n      exportToExcel(data, filename);\n    } else {\n      exportToCSV(data, filename);\n    }\n  };\n\n  const exportFinancialReport = () => {\n    if (!financialReport) return;\n    \n    const data = financialReport.dailyRevenue.map(d => ({\n      Date: d.date,\n      Revenue: d.amount,\n    }));\n    exportToCSV(data, \"financial_report\");\n  };\n\n  const exportPlanPerformance = () => {\n    if (!financialReport) return;\n    \n    const data = financialReport.planRevenue.map((p, idx) => ({\n      Plan: p.name || `Plan ${idx + 1}`,\n      Revenue: p.amount,\n      Transactions: p.count,\n    }));\n    exportToCSV(data, \"plan_performance\");\n  };\n\n  const exportReconciliation = () => {\n    if (!reconciliationReport) return;\n    \n    const data = reconciliationReport.transactions.map(t => ({\n      ID: t.id,\n      Amount: t.amount,\n      Status: t.status,\n      ReconciliationStatus: t.reconciliationStatus,\n      MpesaReceipt: t.mpesaReceiptNumber || \"\",\n      Date: t.createdAt,\n    }));\n    exportToCSV(data, \"reconciliation_report\");\n  };\n\n  const exportUserActivity = () => {\n    if (!userActivityReport) return;\n    \n    const data = userActivityReport.expiringUsers.map(u => ({\n      Username: u.username,\n      Phone: u.phoneNumber,\n      ExpiryDate: u.expiryTime,\n    }));\n    exportToCSV(data, \"expiring_users\");\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex flex-wrap items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-foreground\" data-testid=\"text-page-title\">\n            Reports & Analytics\n          </h1>\n          <p className=\"text-muted-foreground\">\n            View revenue reports, user activity, and reconciliation status\n          </p>\n        </div>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Calendar size={18} />\n            Date Range Filter\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex flex-wrap items-end gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"startDate\">Start Date</Label>\n              <Input\n                id=\"startDate\"\n                type=\"date\"\n                value={startDate}\n                onChange={(e) => setStartDate(e.target.value)}\n                data-testid=\"input-start-date\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"endDate\">End Date</Label>\n              <Input\n                id=\"endDate\"\n                type=\"date\"\n                value={endDate}\n                onChange={(e) => setEndDate(e.target.value)}\n                data-testid=\"input-end-date\"\n              />\n            </div>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                const today = new Date();\n                const thirtyDaysAgo = new Date();\n                thirtyDaysAgo.setDate(today.getDate() - 30);\n                setStartDate(thirtyDaysAgo.toISOString().split(\"T\")[0]);\n                setEndDate(today.toISOString().split(\"T\")[0]);\n              }}\n              data-testid=\"button-last-30-days\"\n            >\n              Last 30 Days\n            </Button>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                const today = new Date();\n                const sevenDaysAgo = new Date();\n                sevenDaysAgo.setDate(today.getDate() - 7);\n                setStartDate(sevenDaysAgo.toISOString().split(\"T\")[0]);\n                setEndDate(today.toISOString().split(\"T\")[0]);\n              }}\n              data-testid=\"button-last-7-days\"\n            >\n              Last 7 Days\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList className=\"bg-card border\">\n          <TabsTrigger value=\"financial\" className=\"gap-2\" data-testid=\"tab-financial\">\n            <TrendingUp size={16} />\n            Revenue\n          </TabsTrigger>\n          <TabsTrigger value=\"plans\" className=\"gap-2\" data-testid=\"tab-plans\">\n            <BarChart3 size={16} />\n            Plan Performance\n          </TabsTrigger>\n          <TabsTrigger value=\"users\" className=\"gap-2\" data-testid=\"tab-users\">\n            <Users size={16} />\n            User Activity\n          </TabsTrigger>\n          <TabsTrigger value=\"reconciliation\" className=\"gap-2\" data-testid=\"tab-reconciliation\">\n            <FileCheck size={16} />\n            Reconciliation\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"financial\" className=\"space-y-4\">\n          {financialLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"animate-spin mr-2\" />\n              Loading financial report...\n            </div>\n          ) : financialReport ? (\n            <>\n              <div className=\"flex justify-end\">\n                <Button onClick={exportFinancialReport} variant=\"outline\" data-testid=\"button-export-financial\">\n                  <Download size={16} className=\"mr-2\" />\n                  Export CSV\n                </Button>\n              </div>\n              \n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription>Total Revenue</CardDescription>\n                    <CardTitle className=\"text-2xl\" data-testid=\"text-total-revenue\">\n                      {formatCurrency(financialReport.summary.totalRevenue)}\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription>Total Transactions</CardDescription>\n                    <CardTitle className=\"text-2xl\" data-testid=\"text-total-transactions\">\n                      {financialReport.summary.totalTransactions}\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription>Completed</CardDescription>\n                    <CardTitle className=\"text-2xl text-green-600\" data-testid=\"text-completed-transactions\">\n                      {financialReport.summary.successfulTransactions}\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription>Avg. Transaction</CardDescription>\n                    <CardTitle className=\"text-2xl\" data-testid=\"text-avg-transaction\">\n                      {formatCurrency(financialReport.summary.averageTransactionValue)}\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n              </div>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle>Daily Revenue</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {financialReport.dailyRevenue.length > 0 ? (\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead>Date</TableHead>\n                          <TableHead className=\"text-right\">Revenue</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {financialReport.dailyRevenue.map((day) => (\n                          <TableRow key={day.date} data-testid={`row-revenue-${day.date}`}>\n                            <TableCell>{new Date(day.date).toLocaleDateString()}</TableCell>\n                            <TableCell className=\"text-right font-medium\">\n                              {formatCurrency(day.amount)}\n                            </TableCell>\n                          </TableRow>\n                        ))}\n                      </TableBody>\n                    </Table>\n                  ) : (\n                    <p className=\"text-center text-muted-foreground py-8\">\n                      No revenue data for selected period\n                    </p>\n                  )}\n                </CardContent>\n              </Card>\n            </>\n          ) : (\n            <p className=\"text-center text-muted-foreground py-8\">\n              No financial data available\n            </p>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"plans\" className=\"space-y-4\">\n          {financialLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"animate-spin mr-2\" />\n              Loading plan performance...\n            </div>\n          ) : financialReport?.planRevenue ? (\n            <>\n              <div className=\"flex justify-end\">\n                <Button onClick={exportPlanPerformance} variant=\"outline\" data-testid=\"button-export-plans\">\n                  <Download size={16} className=\"mr-2\" />\n                  Export CSV\n                </Button>\n              </div>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle>Plan Performance</CardTitle>\n                  <CardDescription>Revenue and transaction count by plan</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  {financialReport.planRevenue.length > 0 ? (\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead>Plan Name</TableHead>\n                          <TableHead className=\"text-right\">Transactions</TableHead>\n                          <TableHead className=\"text-right\">Revenue</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {financialReport.planRevenue.map((plan, idx) => (\n                          <TableRow key={plan.name || idx} data-testid={`row-plan-${idx}`}>\n                            <TableCell className=\"font-medium\">{plan.name}</TableCell>\n                            <TableCell className=\"text-right\">{plan.count}</TableCell>\n                            <TableCell className=\"text-right font-medium\">\n                              {formatCurrency(plan.amount)}\n                            </TableCell>\n                          </TableRow>\n                        ))}\n                      </TableBody>\n                    </Table>\n                  ) : (\n                    <p className=\"text-center text-muted-foreground py-8\">\n                      No plan data for selected period\n                    </p>\n                  )}\n                </CardContent>\n              </Card>\n            </>\n          ) : (\n            <p className=\"text-center text-muted-foreground py-8\">\n              No plan data available\n            </p>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"users\" className=\"space-y-4\">\n          {userActivityLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"animate-spin mr-2\" />\n              Loading user activity...\n            </div>\n          ) : userActivityReport ? (\n            <>\n              <div className=\"flex justify-end\">\n                <Button onClick={exportUserActivity} variant=\"outline\" data-testid=\"button-export-users\">\n                  <Download size={16} className=\"mr-2\" />\n                  Export Expiring Users\n                </Button>\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription>Total Users</CardDescription>\n                    <CardTitle className=\"text-2xl\" data-testid=\"text-total-users\">\n                      {userActivityReport.summary.totalUsers}\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription>Active Users</CardDescription>\n                    <CardTitle className=\"text-2xl text-green-600\" data-testid=\"text-active-users\">\n                      {userActivityReport.summary.activeUsers}\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription>Expired Users</CardDescription>\n                    <CardTitle className=\"text-2xl text-red-600\" data-testid=\"text-expired-users\">\n                      {userActivityReport.summary.expiredUsers}\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n              </div>\n\n              <Card className=\"border-amber-500/50\">\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2 text-amber-600\">\n                    <AlertTriangle size={18} />\n                    Expiring Soon\n                  </CardTitle>\n                  <CardDescription>\n                    {userActivityReport.summary.expiringIn24h} users expiring in 24h, \n                    {\" \"}{userActivityReport.summary.expiringIn48h} in 48h\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  {userActivityReport.expiringUsers.length > 0 ? (\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead>Username</TableHead>\n                          <TableHead>Phone</TableHead>\n                          <TableHead>Expiry Date</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {userActivityReport.expiringUsers.slice(0, 10).map((user) => (\n                          <TableRow key={user.id} data-testid={`row-expiring-${user.id}`}>\n                            <TableCell className=\"font-medium\">{user.username}</TableCell>\n                            <TableCell>{user.phoneNumber}</TableCell>\n                            <TableCell>\n                              {new Date(user.expiryTime).toLocaleString()}\n                            </TableCell>\n                          </TableRow>\n                        ))}\n                      </TableBody>\n                    </Table>\n                  ) : (\n                    <p className=\"text-center text-muted-foreground py-8\">\n                      No users expiring soon\n                    </p>\n                  )}\n                </CardContent>\n              </Card>\n            </>\n          ) : (\n            <p className=\"text-center text-muted-foreground py-8\">\n              No user activity data available\n            </p>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"reconciliation\" className=\"space-y-4\">\n          {reconciliationLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"animate-spin mr-2\" />\n              Loading reconciliation report...\n            </div>\n          ) : reconciliationReport ? (\n            <>\n              <div className=\"flex justify-end\">\n                <Button onClick={exportReconciliation} variant=\"outline\" data-testid=\"button-export-reconciliation\">\n                  <Download size={16} className=\"mr-2\" />\n                  Export CSV\n                </Button>\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription>Total Transactions</CardDescription>\n                    <CardTitle className=\"text-2xl\" data-testid=\"text-recon-total\">\n                      {reconciliationReport.summary.totalTransactions}\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription className=\"flex items-center gap-1\">\n                      <CheckCircle size={14} className=\"text-green-600\" />\n                      Matched\n                    </CardDescription>\n                    <CardTitle className=\"text-2xl text-green-600\" data-testid=\"text-recon-matched\">\n                      {reconciliationReport.summary.matchedCount}\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription className=\"flex items-center gap-1\">\n                      <AlertTriangle size={14} className=\"text-amber-600\" />\n                      Needs Review\n                    </CardDescription>\n                    <CardTitle className=\"text-2xl text-amber-600\" data-testid=\"text-recon-review\">\n                      {reconciliationReport.summary.manualReviewCount}\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription className=\"flex items-center gap-1\">\n                      <Clock size={14} className=\"text-blue-600\" />\n                      Pending\n                    </CardDescription>\n                    <CardTitle className=\"text-2xl text-blue-600\" data-testid=\"text-recon-pending\">\n                      {reconciliationReport.summary.pendingCount}\n                    </CardTitle>\n                  </CardHeader>\n                </Card>\n              </div>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle>Match Rate</CardTitle>\n                  <CardDescription>\n                    {reconciliationReport.summary.matchRate.toFixed(1)}% of transactions matched\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"w-full bg-muted rounded-full h-4\">\n                    <div \n                      className=\"bg-green-600 h-4 rounded-full transition-all\"\n                      style={{ width: `${reconciliationReport.summary.matchRate}%` }}\n                    />\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle>Recent Transactions</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {reconciliationReport.transactions.length > 0 ? (\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead>Date</TableHead>\n                          <TableHead>Amount</TableHead>\n                          <TableHead>Receipt</TableHead>\n                          <TableHead>Status</TableHead>\n                          <TableHead>Reconciliation</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {reconciliationReport.transactions.slice(0, 10).map((tx) => (\n                          <TableRow key={tx.id} data-testid={`row-recon-${tx.id}`}>\n                            <TableCell>\n                              {new Date(tx.createdAt).toLocaleDateString()}\n                            </TableCell>\n                            <TableCell className=\"font-medium\">\n                              {formatCurrency(tx.amount)}\n                            </TableCell>\n                            <TableCell className=\"text-muted-foreground\">\n                              {tx.mpesaReceiptNumber || \"-\"}\n                            </TableCell>\n                            <TableCell>\n                              <Badge variant={tx.status === \"COMPLETED\" ? \"default\" : \"secondary\"}>\n                                {tx.status}\n                              </Badge>\n                            </TableCell>\n                            <TableCell>\n                              <Badge \n                                variant={tx.reconciliationStatus === \"MATCHED\" ? \"default\" : \"outline\"}\n                                className={\n                                  tx.reconciliationStatus === \"MATCHED\" \n                                    ? \"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400\" \n                                    : tx.reconciliationStatus === \"MANUAL_REVIEW\"\n                                    ? \"bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400\"\n                                    : \"\"\n                                }\n                              >\n                                {tx.reconciliationStatus}\n                              </Badge>\n                            </TableCell>\n                          </TableRow>\n                        ))}\n                      </TableBody>\n                    </Table>\n                  ) : (\n                    <p className=\"text-center text-muted-foreground py-8\">\n                      No transactions for selected period\n                    </p>\n                  )}\n                </CardContent>\n              </Card>\n            </>\n          ) : (\n            <p className=\"text-center text-muted-foreground py-8\">\n              No reconciliation data available\n            </p>\n          )}\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":27675,"size_tokens":null},"server/services/whatsapp.ts":{"content":"import type { Tenant, WifiUser, Plan, Transaction } from \"@shared/schema\";\n\ninterface WhatsAppResult {\n  success: boolean;\n  messageId?: string;\n  error?: string;\n}\n\ninterface WhatsAppConfig {\n  provider: \"meta\" | \"twilio\" | \"mock\";\n  apiKey?: string;\n  phoneNumberId?: string;\n  businessAccountId?: string;\n}\n\nexport class WhatsAppService {\n  private config: WhatsAppConfig;\n  private tenant: Tenant;\n\n  constructor(tenant: Tenant, config?: WhatsAppConfig) {\n    this.tenant = tenant;\n    this.config = config || { provider: \"mock\" };\n  }\n\n  async sendMessage(phoneNumber: string, message: string): Promise<WhatsAppResult> {\n    const formattedPhone = this.formatPhoneNumber(phoneNumber);\n    \n    console.log(`[WhatsApp] Sending to ${formattedPhone}: ${message.substring(0, 50)}...`);\n\n    switch (this.config.provider) {\n      case \"meta\":\n        return this.sendViaMeta(formattedPhone, message);\n      case \"twilio\":\n        return this.sendViaTwilio(formattedPhone, message);\n      case \"mock\":\n      default:\n        return this.sendMock(formattedPhone, message);\n    }\n  }\n\n  private async sendViaMeta(phone: string, message: string): Promise<WhatsAppResult> {\n    try {\n      const accessToken = this.config.apiKey;\n      const phoneNumberId = this.config.phoneNumberId;\n      \n      if (!accessToken || !phoneNumberId) {\n        return { success: false, error: \"Meta WhatsApp API credentials not configured\" };\n      }\n\n      const url = `https://graph.facebook.com/v18.0/${phoneNumberId}/messages`;\n      \n      const response = await fetch(url, {\n        method: \"POST\",\n        headers: {\n          \"Authorization\": `Bearer ${accessToken}`,\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({\n          messaging_product: \"whatsapp\",\n          recipient_type: \"individual\",\n          to: phone.replace(\"+\", \"\"),\n          type: \"text\",\n          text: {\n            preview_url: false,\n            body: message,\n          },\n        }),\n      });\n\n      const data = await response.json();\n      \n      if (data.messages?.[0]?.id) {\n        console.log(`[WhatsApp] Meta message sent: ${data.messages[0].id}`);\n        return { \n          success: true, \n          messageId: data.messages[0].id \n        };\n      }\n\n      console.error(\"[WhatsApp] Meta API error:\", data);\n      return { \n        success: false, \n        error: data.error?.message || \"Failed to send WhatsApp message\" \n      };\n    } catch (error) {\n      console.error(\"[WhatsApp] Meta request error:\", error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : \"Meta WhatsApp request failed\",\n      };\n    }\n  }\n\n  private async sendViaTwilio(phone: string, message: string): Promise<WhatsAppResult> {\n    try {\n      const accountSid = this.config.apiKey;\n      const authToken = this.config.phoneNumberId;\n      const fromNumber = this.config.businessAccountId || \"+14155238886\";\n\n      if (!accountSid || !authToken) {\n        return { success: false, error: \"Twilio WhatsApp credentials not configured\" };\n      }\n\n      const url = `https://api.twilio.com/2010-04-01/Accounts/${accountSid}/Messages.json`;\n      const auth = Buffer.from(`${accountSid}:${authToken}`).toString(\"base64\");\n      \n      const formData = new URLSearchParams();\n      formData.append(\"To\", `whatsapp:${phone}`);\n      formData.append(\"From\", `whatsapp:${fromNumber}`);\n      formData.append(\"Body\", message);\n\n      const response = await fetch(url, {\n        method: \"POST\",\n        headers: {\n          \"Authorization\": `Basic ${auth}`,\n          \"Content-Type\": \"application/x-www-form-urlencoded\",\n        },\n        body: formData.toString(),\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json();\n        console.error(\"[WhatsApp] Twilio error:\", errorData);\n        return {\n          success: false,\n          error: errorData.message || `Twilio API error: ${response.status}`,\n        };\n      }\n\n      const data = await response.json();\n      console.log(`[WhatsApp] Twilio message sent: ${data.sid}`);\n      \n      return {\n        success: true,\n        messageId: data.sid,\n      };\n    } catch (error) {\n      console.error(\"[WhatsApp] Twilio request error:\", error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : \"Twilio WhatsApp request failed\",\n      };\n    }\n  }\n\n  private async sendMock(phone: string, message: string): Promise<WhatsAppResult> {\n    console.log(`[WhatsApp Mock] To: ${phone}`);\n    console.log(`[WhatsApp Mock] Message: ${message}`);\n    \n    return { \n      success: true, \n      messageId: `WA_MOCK_${Date.now()}_${Math.random().toString(36).substring(7)}` \n    };\n  }\n\n  private formatPhoneNumber(phone: string): string {\n    let cleaned = phone.replace(/\\D/g, \"\");\n    \n    if (cleaned.startsWith(\"0\")) {\n      cleaned = \"254\" + cleaned.slice(1);\n    } else if (cleaned.startsWith(\"+\")) {\n      cleaned = cleaned.slice(1);\n    } else if (!cleaned.startsWith(\"254\")) {\n      cleaned = \"254\" + cleaned;\n    }\n\n    return \"+\" + cleaned;\n  }\n\n  async sendPaymentConfirmation(user: WifiUser, transaction: Transaction, plan: Plan): Promise<WhatsAppResult> {\n    const message = `*MnetiFi WiFi - Payment Received*\\n\\nAmount: Ksh ${transaction.amount}\\nPlan: ${plan.name}\\nDuration: ${this.formatDuration(plan.durationSeconds)}\\nReceipt: ${transaction.mpesaReceiptNumber || \"Processing\"}\\n\\nThank you for your payment!`;\n    \n    return this.sendMessage(user.phoneNumber, message);\n  }\n\n  async sendExpiryReminder(user: WifiUser, hoursRemaining: number): Promise<WhatsAppResult> {\n    const message = `*MnetiFi WiFi - Expiry Reminder*\\n\\nYour WiFi plan expires in *${hoursRemaining} hours*.\\n\\nRecharge now to stay connected! Visit our portal or dial *123# to purchase a new plan.`;\n    \n    return this.sendMessage(user.phoneNumber, message);\n  }\n\n  async sendExpiryNotification(user: WifiUser): Promise<WhatsAppResult> {\n    const message = `*MnetiFi WiFi - Plan Expired*\\n\\nYour WiFi plan has expired.\\n\\nRecharge now to restore your connection. Visit our portal or dial *123# to purchase a new plan.`;\n    \n    return this.sendMessage(user.phoneNumber, message);\n  }\n\n  async sendVoucherCode(phoneNumber: string, code: string, planName: string, duration: string): Promise<WhatsAppResult> {\n    const message = `*MnetiFi WiFi - Your Access Code*\\n\\nVoucher Code: *${code}*\\nPlan: ${planName}\\nValidity: ${duration}\\n\\nConnect to our hotspot and enter this code to get started.`;\n    \n    return this.sendMessage(phoneNumber, message);\n  }\n\n  async sendWelcome(user: WifiUser): Promise<WhatsAppResult> {\n    const message = `*Welcome to MnetiFi WiFi!*\\n\\nYour account has been created successfully.\\n\\nConnect to our hotspot and select a plan to get started. Need help? Reply to this message or call our support line.`;\n    \n    return this.sendMessage(user.phoneNumber, message);\n  }\n\n  async sendSuspensionNotice(user: WifiUser, reason: string): Promise<WhatsAppResult> {\n    const message = `*MnetiFi WiFi - Account Suspended*\\n\\nYour WiFi account has been suspended.\\n\\nReason: ${reason}\\n\\nPlease contact support for assistance.`;\n    \n    return this.sendMessage(user.phoneNumber, message);\n  }\n\n  async sendReactivationNotice(user: WifiUser): Promise<WhatsAppResult> {\n    const message = `*MnetiFi WiFi - Account Reactivated*\\n\\nYour WiFi account has been reactivated.\\n\\nYou can now connect and browse. Thank you for your patience!`;\n    \n    return this.sendMessage(user.phoneNumber, message);\n  }\n\n  private formatDuration(seconds: number): string {\n    if (seconds < 3600) {\n      return `${Math.round(seconds / 60)} minutes`;\n    } else if (seconds < 86400) {\n      return `${Math.round(seconds / 3600)} hours`;\n    } else if (seconds < 604800) {\n      return `${Math.round(seconds / 86400)} days`;\n    } else {\n      return `${Math.round(seconds / 604800)} weeks`;\n    }\n  }\n}\n\nexport function createWhatsAppService(tenant: Tenant, config?: WhatsAppConfig): WhatsAppService {\n  return new WhatsAppService(tenant, config);\n}\n\nexport const WhatsAppTemplates = {\n  paymentConfirmation: (amount: number, planName: string, duration: string, receipt: string) =>\n    `*MnetiFi WiFi - Payment Received*\\n\\nAmount: Ksh ${amount}\\nPlan: ${planName}\\nDuration: ${duration}\\nReceipt: ${receipt}\\n\\nThank you!`,\n  \n  expiryReminder: (hours: number) =>\n    `*MnetiFi WiFi - Expiry Reminder*\\n\\nYour plan expires in *${hours} hours*. Recharge now!`,\n  \n  expiryNotification: () =>\n    `*MnetiFi WiFi - Plan Expired*\\n\\nYour plan has expired. Recharge to reconnect.`,\n  \n  voucherCode: (code: string, planName: string, duration: string) =>\n    `*MnetiFi WiFi - Access Code*\\n\\nCode: *${code}*\\nPlan: ${planName}\\nValidity: ${duration}`,\n  \n  welcome: () =>\n    `*Welcome to MnetiFi WiFi!*\\n\\nConnect to our hotspot and select a plan to get started.`,\n};\n","path":null,"size_bytes":8915,"size_tokens":null},"client/src/pages/voucher-verify.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Ticket, Search, CheckCircle, XCircle, Clock, AlertCircle, ArrowLeft, Wifi } from \"lucide-react\";\nimport { MeshBackground } from \"@/components/mesh-background\";\nimport { MnetiFiLogo } from \"@/components/mnetifi-logo\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Link } from \"wouter\";\nimport type { Tenant } from \"@shared/schema\";\n\ninterface VoucherVerificationResult {\n  valid: boolean;\n  code: string;\n  status: \"available\" | \"used\" | \"expired\" | \"not_yet_valid\" | \"not_found\";\n  statusMessage: string;\n  plan: {\n    name: string;\n    price: number;\n    durationSeconds: number;\n    speedLimit?: string;\n  } | null;\n  validFrom: string | null;\n  validUntil: string | null;\n  usedAt: string | null;\n  usedBy: string | null;\n  error?: string;\n}\n\ninterface BrandingConfig {\n  logo?: string;\n  primaryColor?: string;\n  secondaryColor?: string;\n}\n\nfunction formatDuration(seconds: number): string {\n  if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes`;\n  if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours`;\n  const days = Math.floor(seconds / 86400);\n  return `${days} day${days > 1 ? \"s\" : \"\"}`;\n}\n\nfunction formatDate(date: string | null): string {\n  if (!date) return \"-\";\n  return new Date(date).toLocaleDateString(\"en-US\", {\n    year: \"numeric\",\n    month: \"short\",\n    day: \"numeric\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n  });\n}\n\nfunction StatusIcon({ status }: { status: string }) {\n  switch (status) {\n    case \"available\":\n      return <CheckCircle className=\"w-16 h-16 text-green-400\" />;\n    case \"used\":\n      return <XCircle className=\"w-16 h-16 text-red-400\" />;\n    case \"expired\":\n      return <Clock className=\"w-16 h-16 text-amber-400\" />;\n    case \"not_yet_valid\":\n      return <AlertCircle className=\"w-16 h-16 text-blue-400\" />;\n    case \"not_found\":\n      return <AlertCircle className=\"w-16 h-16 text-gray-400\" />;\n    default:\n      return <Ticket className=\"w-16 h-16 text-gray-400\" />;\n  }\n}\n\nfunction StatusBadge({ status }: { status: string }) {\n  const variants: Record<string, \"default\" | \"secondary\" | \"destructive\" | \"outline\"> = {\n    available: \"default\",\n    used: \"destructive\",\n    expired: \"secondary\",\n    not_yet_valid: \"outline\",\n    not_found: \"secondary\",\n  };\n  \n  const labels: Record<string, string> = {\n    available: \"Valid\",\n    used: \"Used\",\n    expired: \"Expired\",\n    not_yet_valid: \"Not Yet Valid\",\n    not_found: \"Not Found\",\n  };\n\n  return (\n    <Badge variant={variants[status] || \"outline\"} className=\"text-sm px-3 py-1\">\n      {labels[status] || status}\n    </Badge>\n  );\n}\n\nexport default function VoucherVerifyPage() {\n  const { toast } = useToast();\n  const [voucherCode, setVoucherCode] = useState(\"\");\n  const [isVerifying, setIsVerifying] = useState(false);\n  const [result, setResult] = useState<VoucherVerificationResult | null>(null);\n  const [hasSearched, setHasSearched] = useState(false);\n\n  const { data: tenant } = useQuery<Tenant>({\n    queryKey: [\"/api/portal/tenant\"],\n  });\n\n  const branding: BrandingConfig = useMemo(() => {\n    const config = tenant?.brandingConfig || {};\n    return {\n      logo: config.logo || \"\",\n      primaryColor: config.primaryColor || \"#22d3ee\",\n      secondaryColor: config.secondaryColor || \"#a855f7\",\n    };\n  }, [tenant]);\n\n  const gradientStyle = useMemo(() => ({\n    background: `linear-gradient(135deg, ${branding.primaryColor}, ${branding.secondaryColor})`,\n  }), [branding]);\n\n  const handleVerify = async () => {\n    if (!voucherCode.trim()) {\n      toast({\n        title: \"Enter Voucher Code\",\n        description: \"Please enter a voucher code to verify\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsVerifying(true);\n    setHasSearched(true);\n    \n    try {\n      const response = await fetch(`/api/portal/verify-voucher/${encodeURIComponent(voucherCode.trim())}`);\n      \n      if (response.ok) {\n        const data = await response.json();\n        setResult(data);\n      } else if (response.status === 404) {\n        setResult({\n          valid: false,\n          code: voucherCode.toUpperCase(),\n          status: \"not_found\",\n          statusMessage: \"Voucher not found. Please check the code and try again.\",\n          plan: null,\n          validFrom: null,\n          validUntil: null,\n          usedAt: null,\n          usedBy: null,\n          error: \"not_found\",\n        });\n      } else {\n        try {\n          const errorData = await response.json();\n          if (errorData.status) {\n            setResult({\n              valid: false,\n              code: voucherCode.toUpperCase(),\n              status: errorData.status,\n              statusMessage: errorData.statusMessage || errorData.error || \"Voucher is not available.\",\n              plan: errorData.plan || null,\n              validFrom: errorData.validFrom || null,\n              validUntil: errorData.validUntil || null,\n              usedAt: errorData.usedAt || null,\n              usedBy: errorData.usedBy || null,\n              error: errorData.error,\n            });\n          } else {\n            throw new Error(errorData.error || \"Verification failed\");\n          }\n        } catch {\n          toast({\n            title: \"Verification Failed\",\n            description: \"Unable to verify voucher. Please try again.\",\n            variant: \"destructive\",\n          });\n          setResult(null);\n        }\n      }\n    } catch {\n      toast({\n        title: \"Verification Failed\",\n        description: \"Unable to verify voucher. Please try again.\",\n        variant: \"destructive\",\n      });\n      setResult(null);\n    } finally {\n      setIsVerifying(false);\n    }\n  };\n\n  const handleReset = () => {\n    setVoucherCode(\"\");\n    setResult(null);\n    setHasSearched(false);\n  };\n\n  return (\n    <div className=\"min-h-screen relative overflow-hidden\">\n      <MeshBackground />\n      \n      <div className=\"relative z-10 flex flex-col items-center justify-center min-h-screen p-4\">\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          className=\"w-full max-w-lg\"\n        >\n          <div className=\"flex flex-col items-center mb-8\">\n            {branding.logo ? (\n              <img \n                src={branding.logo} \n                alt=\"Logo\" \n                className=\"h-12 mb-4 object-contain\"\n              />\n            ) : (\n              <MnetiFiLogo size=\"lg\" className=\"mb-4\" />\n            )}\n            <h1 className=\"text-2xl font-bold text-foreground text-center\">\n              Voucher Verification\n            </h1>\n            <p className=\"text-muted-foreground text-center mt-2\">\n              Check if your voucher code is valid before use\n            </p>\n          </div>\n\n          <GlassPanel className=\"p-6 space-y-6\">\n            <div className=\"space-y-4\">\n              <div className=\"relative\">\n                <GlassInput\n                  placeholder=\"Enter voucher code (e.g., ABC123)\"\n                  value={voucherCode}\n                  onChange={(e) => setVoucherCode(e.target.value.toUpperCase())}\n                  className=\"text-center text-lg font-mono tracking-wider\"\n                  disabled={isVerifying}\n                  data-testid=\"input-voucher-code\"\n                  onKeyDown={(e) => e.key === \"Enter\" && handleVerify()}\n                />\n              </div>\n\n              <Button\n                onClick={handleVerify}\n                disabled={isVerifying || !voucherCode.trim()}\n                className=\"w-full\"\n                style={gradientStyle}\n                data-testid=\"button-verify-voucher\"\n              >\n                {isVerifying ? (\n                  <>\n                    <motion.div\n                      animate={{ rotate: 360 }}\n                      transition={{ duration: 1, repeat: Infinity, ease: \"linear\" }}\n                      className=\"w-5 h-5 border-2 border-white border-t-transparent rounded-full mr-2\"\n                    />\n                    Verifying...\n                  </>\n                ) : (\n                  <>\n                    <Search className=\"w-5 h-5 mr-2\" />\n                    Verify Voucher\n                  </>\n                )}\n              </Button>\n            </div>\n\n            <AnimatePresence mode=\"wait\">\n              {hasSearched && result && (\n                <motion.div\n                  initial={{ opacity: 0, y: 20 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  exit={{ opacity: 0, y: -20 }}\n                  className=\"space-y-4\"\n                >\n                  <div className=\"flex flex-col items-center text-center py-4\">\n                    <StatusIcon status={result.status} />\n                    <h3 className=\"text-xl font-bold mt-4 text-foreground\" data-testid=\"text-voucher-code\">\n                      {result.code}\n                    </h3>\n                    <StatusBadge status={result.status} />\n                    <p className=\"text-muted-foreground mt-2\" data-testid=\"text-status-message\">\n                      {result.statusMessage}\n                    </p>\n                  </div>\n\n                  {result.valid && result.plan && (\n                    <Card className=\"bg-background/50 border-border/50\">\n                      <CardContent className=\"p-4 space-y-3\">\n                        <div className=\"flex items-center gap-2 text-foreground\">\n                          <Wifi className=\"w-5 h-5 text-primary\" />\n                          <span className=\"font-semibold\">Plan Details</span>\n                        </div>\n                        <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                          <span className=\"text-muted-foreground\">Plan Name:</span>\n                          <span className=\"font-medium text-foreground\" data-testid=\"text-plan-name\">{result.plan.name}</span>\n                          \n                          <span className=\"text-muted-foreground\">Duration:</span>\n                          <span className=\"font-medium text-foreground\" data-testid=\"text-plan-duration\">\n                            {formatDuration(result.plan.durationSeconds)}\n                          </span>\n                          \n                          <span className=\"text-muted-foreground\">Price:</span>\n                          <span className=\"font-medium text-foreground\" data-testid=\"text-plan-price\">\n                            KES {result.plan.price}\n                          </span>\n                          \n                          {result.plan.speedLimit && (\n                            <>\n                              <span className=\"text-muted-foreground\">Speed:</span>\n                              <span className=\"font-medium text-foreground\">{result.plan.speedLimit}</span>\n                            </>\n                          )}\n                        </div>\n                        \n                        {(result.validFrom || result.validUntil) && (\n                          <div className=\"pt-2 border-t border-border/50 grid grid-cols-2 gap-2 text-sm\">\n                            {result.validFrom && (\n                              <>\n                                <span className=\"text-muted-foreground\">Valid From:</span>\n                                <span className=\"text-foreground\">{formatDate(result.validFrom)}</span>\n                              </>\n                            )}\n                            {result.validUntil && (\n                              <>\n                                <span className=\"text-muted-foreground\">Valid Until:</span>\n                                <span className=\"text-foreground\">{formatDate(result.validUntil)}</span>\n                              </>\n                            )}\n                          </div>\n                        )}\n                      </CardContent>\n                    </Card>\n                  )}\n\n                  {result.status === \"used\" && result.usedAt && (\n                    <Card className=\"bg-destructive/10 border-destructive/20\">\n                      <CardContent className=\"p-4 text-sm space-y-1\">\n                        <p className=\"text-muted-foreground\">\n                          Used on: <span className=\"text-foreground\">{formatDate(result.usedAt)}</span>\n                        </p>\n                        {result.usedBy && (\n                          <p className=\"text-muted-foreground\">\n                            Used by: <span className=\"text-foreground\">{result.usedBy}</span>\n                          </p>\n                        )}\n                      </CardContent>\n                    </Card>\n                  )}\n\n                  <div className=\"flex gap-2\">\n                    <Button\n                      variant=\"outline\"\n                      onClick={handleReset}\n                      className=\"flex-1\"\n                      data-testid=\"button-check-another\"\n                    >\n                      Check Another\n                    </Button>\n                    {result.valid && (\n                      <Link href=\"/captive-portal\" className=\"flex-1\">\n                        <Button \n                          className=\"w-full\" \n                          style={gradientStyle}\n                          data-testid=\"button-use-voucher\"\n                        >\n                          Use Voucher\n                        </Button>\n                      </Link>\n                    )}\n                  </div>\n                </motion.div>\n              )}\n            </AnimatePresence>\n          </GlassPanel>\n\n          <div className=\"mt-6 text-center\">\n            <Link href=\"/captive-portal\">\n              <Button variant=\"ghost\" className=\"text-muted-foreground\" data-testid=\"link-back-to-portal\">\n                <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                Back to Portal\n              </Button>\n            </Link>\n          </div>\n        </motion.div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":14380,"size_tokens":null},"client/src/pages/chat.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { MessageSquare, Send, User, Headphones, Search } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { ChatMessage, WifiUser } from \"@shared/schema\";\n\ninterface UnreadChat {\n  wifiUserId: string;\n  wifiUserName: string;\n  wifiUserPhone: string;\n  unreadCount: number;\n  lastMessage: string;\n  lastMessageAt: string;\n}\n\nexport default function ChatPage() {\n  const { toast } = useToast();\n  const [selectedUser, setSelectedUser] = useState<string | null>(null);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [newMessage, setNewMessage] = useState(\"\");\n\n  const { data: unreadChats, isLoading: loadingUnread } = useQuery<UnreadChat[]>({\n    queryKey: [\"/api/chat-unread\"],\n  });\n\n  const { data: wifiUsers, isLoading: loadingUsers } = useQuery<WifiUser[]>({\n    queryKey: [\"/api/wifi-users\"],\n  });\n\n  const { data: messages, isLoading: loadingMessages } = useQuery<ChatMessage[]>({\n    queryKey: [\"/api/chat\", selectedUser],\n    enabled: !!selectedUser,\n  });\n\n  const sendMessageMutation = useMutation({\n    mutationFn: async (message: string) => {\n      return apiRequest(\"POST\", `/api/chat/${selectedUser}`, { message });\n    },\n    onSuccess: () => {\n      setNewMessage(\"\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat\", selectedUser] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat-unread\"] });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to send message\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSendMessage = () => {\n    if (!newMessage.trim() || !selectedUser) return;\n    sendMessageMutation.mutate(newMessage);\n  };\n\n  const filteredUsers = wifiUsers?.filter(user => \n    user.fullName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    user.phoneNumber?.includes(searchQuery)\n  ) || [];\n\n  const getUnreadCount = (userId: string) => {\n    return unreadChats?.find(c => c.wifiUserId === userId)?.unreadCount || 0;\n  };\n\n  const selectedUserData = wifiUsers?.find(u => u.id === selectedUser);\n\n  return (\n    <div className=\"flex h-full gap-4 p-4\">\n      <Card className=\"w-80 flex flex-col\">\n        <CardHeader className=\"pb-3\">\n          <CardTitle className=\"flex items-center gap-2 text-lg\">\n            <MessageSquare className=\"h-5 w-5\" />\n            Conversations\n          </CardTitle>\n          <div className=\"relative mt-2\">\n            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n            <Input\n              placeholder=\"Search customers...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"pl-9\"\n              data-testid=\"input-search-chat\"\n            />\n          </div>\n        </CardHeader>\n        <CardContent className=\"flex-1 p-0\">\n          <ScrollArea className=\"h-[calc(100vh-280px)]\">\n            {loadingUsers || loadingUnread ? (\n              <div className=\"space-y-2 p-4\">\n                {[1, 2, 3].map(i => (\n                  <Skeleton key={i} className=\"h-16 w-full\" />\n                ))}\n              </div>\n            ) : (\n              <div className=\"space-y-1 p-2\">\n                {filteredUsers.map((user) => {\n                  const unreadCount = getUnreadCount(user.id);\n                  const isSelected = selectedUser === user.id;\n                  return (\n                    <button\n                      key={user.id}\n                      onClick={() => setSelectedUser(user.id)}\n                      className={`w-full p-3 rounded-md text-left transition-colors ${\n                        isSelected \n                          ? \"bg-primary/10 border border-primary/20\" \n                          : \"hover-elevate\"\n                      }`}\n                      data-testid={`chat-user-${user.id}`}\n                    >\n                      <div className=\"flex items-center justify-between gap-2\">\n                        <div className=\"flex items-center gap-2 min-w-0\">\n                          <div className=\"w-8 h-8 rounded-full bg-muted flex items-center justify-center flex-shrink-0\">\n                            <User className=\"h-4 w-4\" />\n                          </div>\n                          <div className=\"min-w-0\">\n                            <p className=\"font-medium truncate text-sm\">\n                              {user.fullName || \"Unknown\"}\n                            </p>\n                            <p className=\"text-xs text-muted-foreground truncate\">\n                              {user.phoneNumber}\n                            </p>\n                          </div>\n                        </div>\n                        {unreadCount > 0 && (\n                          <Badge variant=\"default\" className=\"flex-shrink-0\">\n                            {unreadCount}\n                          </Badge>\n                        )}\n                      </div>\n                    </button>\n                  );\n                })}\n                {filteredUsers.length === 0 && (\n                  <p className=\"text-center text-muted-foreground py-8 text-sm\">\n                    No customers found\n                  </p>\n                )}\n              </div>\n            )}\n          </ScrollArea>\n        </CardContent>\n      </Card>\n\n      <Card className=\"flex-1 flex flex-col\">\n        {selectedUser ? (\n          <>\n            <CardHeader className=\"border-b pb-3\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"w-10 h-10 rounded-full bg-muted flex items-center justify-center\">\n                  <User className=\"h-5 w-5\" />\n                </div>\n                <div>\n                  <CardTitle className=\"text-lg\">\n                    {selectedUserData?.fullName || \"Customer\"}\n                  </CardTitle>\n                  <p className=\"text-sm text-muted-foreground\">\n                    {selectedUserData?.phoneNumber}\n                  </p>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent className=\"flex-1 p-0 flex flex-col\">\n              <ScrollArea className=\"flex-1 p-4\">\n                {loadingMessages ? (\n                  <div className=\"space-y-4\">\n                    {[1, 2, 3].map(i => (\n                      <Skeleton key={i} className=\"h-16 w-3/4\" />\n                    ))}\n                  </div>\n                ) : messages && messages.length > 0 ? (\n                  <div className=\"space-y-4\">\n                    {messages.map((msg) => (\n                      <div\n                        key={msg.id}\n                        className={`flex ${msg.isFromCustomer ? \"justify-start\" : \"justify-end\"}`}\n                      >\n                        <div\n                          className={`max-w-[70%] rounded-lg p-3 ${\n                            msg.isFromCustomer\n                              ? \"bg-muted\"\n                              : \"bg-primary text-primary-foreground\"\n                          }`}\n                        >\n                          <div className=\"flex items-center gap-2 mb-1\">\n                            {msg.isFromCustomer ? (\n                              <User className=\"h-3 w-3\" />\n                            ) : (\n                              <Headphones className=\"h-3 w-3\" />\n                            )}\n                            <span className=\"text-xs opacity-70\">\n                              {msg.isFromCustomer ? \"Customer\" : \"Support\"}\n                            </span>\n                          </div>\n                          <p className=\"text-sm\">{msg.message}</p>\n                          <p className=\"text-xs opacity-50 mt-1\">\n                            {msg.createdAt && format(new Date(msg.createdAt), \"MMM d, h:mm a\")}\n                          </p>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <div className=\"flex flex-col items-center justify-center h-full text-muted-foreground\">\n                    <MessageSquare className=\"h-12 w-12 mb-2 opacity-50\" />\n                    <p>No messages yet</p>\n                    <p className=\"text-sm\">Start a conversation with this customer</p>\n                  </div>\n                )}\n              </ScrollArea>\n              <div className=\"p-4 border-t\">\n                <div className=\"flex gap-2\">\n                  <Input\n                    placeholder=\"Type your message...\"\n                    value={newMessage}\n                    onChange={(e) => setNewMessage(e.target.value)}\n                    onKeyDown={(e) => e.key === \"Enter\" && handleSendMessage()}\n                    data-testid=\"input-chat-message\"\n                  />\n                  <Button\n                    onClick={handleSendMessage}\n                    disabled={!newMessage.trim() || sendMessageMutation.isPending}\n                    data-testid=\"button-send-message\"\n                  >\n                    <Send className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              </div>\n            </CardContent>\n          </>\n        ) : (\n          <div className=\"flex flex-col items-center justify-center h-full text-muted-foreground\">\n            <MessageSquare className=\"h-16 w-16 mb-4 opacity-50\" />\n            <h3 className=\"text-lg font-medium\">Select a conversation</h3>\n            <p className=\"text-sm\">Choose a customer from the list to view messages</p>\n          </div>\n        )}\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":10131,"size_tokens":null},"client/src/pages/zones.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Plus, MapPin, Edit2, Trash2, X } from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput, GlassTextarea } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Zone, InsertZone } from \"@shared/schema\";\n\nexport default function ZonesPage() {\n  const { toast } = useToast();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingZone, setEditingZone] = useState<Zone | null>(null);\n  const [deleteZone, setDeleteZone] = useState<Zone | null>(null);\n\n  const [formData, setFormData] = useState<Partial<InsertZone>>({\n    name: \"\",\n    description: \"\",\n    isActive: true,\n  });\n\n  const { data: zones, isLoading } = useQuery<Zone[]>({\n    queryKey: [\"/api/zones\"],\n  });\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: Partial<InsertZone>) => {\n      if (editingZone) {\n        return apiRequest(\"PATCH\", `/api/zones/${editingZone.id}`, data);\n      }\n      return apiRequest(\"POST\", \"/api/zones\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/zones\"] });\n      toast({\n        title: editingZone ? \"Zone Updated\" : \"Zone Created\",\n        description: `The zone has been ${editingZone ? \"updated\" : \"created\"} successfully.`,\n      });\n      handleCloseDialog();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save zone\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/zones/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/zones\"] });\n      toast({\n        title: \"Zone Deleted\",\n        description: \"The zone has been deleted successfully.\",\n      });\n      setDeleteZone(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to delete zone\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleOpenDialog = (zone?: Zone) => {\n    if (zone) {\n      setEditingZone(zone);\n      setFormData({\n        name: zone.name,\n        description: zone.description || \"\",\n        isActive: zone.isActive ?? true,\n      });\n    } else {\n      setEditingZone(null);\n      setFormData({\n        name: \"\",\n        description: \"\",\n        isActive: true,\n      });\n    }\n    setIsDialogOpen(true);\n  };\n\n  const handleCloseDialog = () => {\n    setIsDialogOpen(false);\n    setEditingZone(null);\n    setFormData({\n      name: \"\",\n      description: \"\",\n      isActive: true,\n    });\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!formData.name?.trim()) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Zone name is required\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    saveMutation.mutate(formData);\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl font-bold\" data-testid=\"text-page-title\">Zones</h1>\n          <p className=\"text-muted-foreground\">\n            Organize customers and technicians by geographic or logical areas\n          </p>\n        </div>\n        <Button onClick={() => handleOpenDialog()} data-testid=\"button-add-zone\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Add Zone\n        </Button>\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i} className=\"animate-pulse\">\n              <CardHeader>\n                <div className=\"h-5 bg-muted rounded w-1/2\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"h-4 bg-muted rounded w-3/4\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : zones && zones.length > 0 ? (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          <AnimatePresence>\n            {zones.map((zone) => (\n              <motion.div\n                key={zone.id}\n                initial={{ opacity: 0, y: 20 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -20 }}\n              >\n                <Card className=\"hover-elevate\" data-testid={`card-zone-${zone.id}`}>\n                  <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <MapPin className=\"h-5 w-5 text-primary\" />\n                      <CardTitle className=\"text-lg\">{zone.name}</CardTitle>\n                    </div>\n                    <Badge variant={zone.isActive ? \"default\" : \"secondary\"}>\n                      {zone.isActive ? \"Active\" : \"Inactive\"}\n                    </Badge>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-sm text-muted-foreground mb-4\">\n                      {zone.description || \"No description\"}\n                    </p>\n                    <div className=\"flex gap-2\">\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => handleOpenDialog(zone)}\n                        data-testid={`button-edit-zone-${zone.id}`}\n                      >\n                        <Edit2 className=\"h-4 w-4 mr-1\" />\n                        Edit\n                      </Button>\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => setDeleteZone(zone)}\n                        data-testid={`button-delete-zone-${zone.id}`}\n                      >\n                        <Trash2 className=\"h-4 w-4 mr-1\" />\n                        Delete\n                      </Button>\n                    </div>\n                  </CardContent>\n                </Card>\n              </motion.div>\n            ))}\n          </AnimatePresence>\n        </div>\n      ) : (\n        <GlassPanel className=\"p-8 text-center\">\n          <MapPin className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n          <h3 className=\"text-lg font-medium mb-2\">No Zones Created</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            Create zones to organize your customers and technicians by location or area.\n          </p>\n          <Button onClick={() => handleOpenDialog()} data-testid=\"button-create-first-zone\">\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Create Your First Zone\n          </Button>\n        </GlassPanel>\n      )}\n\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>\n              {editingZone ? \"Edit Zone\" : \"Create New Zone\"}\n            </DialogTitle>\n          </DialogHeader>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div>\n              <label className=\"text-sm font-medium mb-1 block\">Zone Name</label>\n              <GlassInput\n                placeholder=\"e.g., Downtown Area, Zone A\"\n                value={formData.name || \"\"}\n                onChange={(e) =>\n                  setFormData({ ...formData, name: e.target.value })\n                }\n                data-testid=\"input-zone-name\"\n              />\n            </div>\n            <div>\n              <label className=\"text-sm font-medium mb-1 block\">Description</label>\n              <GlassTextarea\n                placeholder=\"Describe this zone (optional)\"\n                value={formData.description || \"\"}\n                onChange={(e) =>\n                  setFormData({ ...formData, description: e.target.value })\n                }\n                data-testid=\"input-zone-description\"\n              />\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <input\n                type=\"checkbox\"\n                id=\"isActive\"\n                checked={formData.isActive ?? true}\n                onChange={(e) =>\n                  setFormData({ ...formData, isActive: e.target.checked })\n                }\n                className=\"h-4 w-4\"\n                data-testid=\"input-zone-active\"\n              />\n              <label htmlFor=\"isActive\" className=\"text-sm\">Active</label>\n            </div>\n            <div className=\"flex gap-2 justify-end\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={handleCloseDialog}\n                data-testid=\"button-cancel\"\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={saveMutation.isPending}\n                data-testid=\"button-save-zone\"\n              >\n                {saveMutation.isPending ? \"Saving...\" : editingZone ? \"Update Zone\" : \"Create Zone\"}\n              </Button>\n            </div>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={!!deleteZone} onOpenChange={() => setDeleteZone(null)}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Zone</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to delete the zone \"{deleteZone?.name}\"? \n              This action cannot be undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete\">Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => deleteZone && deleteMutation.mutate(deleteZone.id)}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":10802,"size_tokens":null},"client/src/pages/security-settings.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Shield, ShieldCheck, ShieldOff, Loader2, QrCode, Key, Copy, Eye, EyeOff } from \"lucide-react\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { InputOTP, InputOTPGroup, InputOTPSlot } from \"@/components/ui/input-otp\";\n\nexport default function SecuritySettingsPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [is2FAEnabled, setIs2FAEnabled] = useState(false);\n  const [isLoading, setIsLoading] = useState(true);\n  const [setupDialogOpen, setSetupDialogOpen] = useState(false);\n  const [disableDialogOpen, setDisableDialogOpen] = useState(false);\n  const [qrCode, setQrCode] = useState<string | null>(null);\n  const [secret, setSecret] = useState<string | null>(null);\n  const [verificationCode, setVerificationCode] = useState(\"\");\n  const [disablePassword, setDisablePassword] = useState(\"\");\n  const [disableCode, setDisableCode] = useState(\"\");\n  const [showSecret, setShowSecret] = useState(false);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  useEffect(() => {\n    const session = localStorage.getItem(\"admin_session\");\n    if (!session) {\n      setLocation(\"/login\");\n      return;\n    }\n    fetch2FAStatus();\n  }, [setLocation]);\n\n  const fetch2FAStatus = async () => {\n    try {\n      const response = await fetch(\"/api/auth/2fa/status\");\n      if (response.ok) {\n        const data = await response.json();\n        setIs2FAEnabled(data.enabled);\n      }\n    } catch (error) {\n      console.error(\"Failed to fetch 2FA status:\", error);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleSetup2FA = async () => {\n    setIsSubmitting(true);\n    try {\n      const response = await fetch(\"/api/auth/2fa/setup\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        setQrCode(data.qrCode);\n        setSecret(data.secret);\n        setSetupDialogOpen(true);\n      } else {\n        const data = await response.json();\n        toast({\n          title: \"Setup Failed\",\n          description: data.error || \"Failed to set up 2FA\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to connect to server\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  const handleVerify2FA = async () => {\n    if (verificationCode.length !== 6) return;\n    \n    setIsSubmitting(true);\n    try {\n      const response = await fetch(\"/api/auth/2fa/verify\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ code: verificationCode }),\n      });\n\n      if (response.ok) {\n        toast({\n          title: \"2FA Enabled\",\n          description: \"Two-factor authentication is now active on your account\",\n        });\n        setIs2FAEnabled(true);\n        setSetupDialogOpen(false);\n        setQrCode(null);\n        setSecret(null);\n        setVerificationCode(\"\");\n      } else {\n        const data = await response.json();\n        toast({\n          title: \"Verification Failed\",\n          description: data.error || \"Invalid code\",\n          variant: \"destructive\",\n        });\n        setVerificationCode(\"\");\n      }\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to verify code\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  const handleDisable2FA = async () => {\n    if (!disablePassword || disableCode.length !== 6) return;\n    \n    setIsSubmitting(true);\n    try {\n      const response = await fetch(\"/api/auth/2fa/disable\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ password: disablePassword, code: disableCode }),\n      });\n\n      if (response.ok) {\n        toast({\n          title: \"2FA Disabled\",\n          description: \"Two-factor authentication has been removed from your account\",\n        });\n        setIs2FAEnabled(false);\n        setDisableDialogOpen(false);\n        setDisablePassword(\"\");\n        setDisableCode(\"\");\n      } else {\n        const data = await response.json();\n        toast({\n          title: \"Failed to Disable\",\n          description: data.error || \"Invalid credentials\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to disable 2FA\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  const copySecret = () => {\n    if (secret) {\n      navigator.clipboard.writeText(secret);\n      toast({\n        title: \"Copied\",\n        description: \"Secret key copied to clipboard\",\n      });\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container max-w-4xl mx-auto p-6\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-2xl font-bold\" data-testid=\"text-security-title\">Security Settings</h1>\n        <p className=\"text-muted-foreground\">Manage your account security preferences</p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className={`p-2 rounded-lg ${is2FAEnabled ? 'bg-green-500/10' : 'bg-muted'}`}>\n                {is2FAEnabled ? (\n                  <ShieldCheck className=\"w-6 h-6 text-green-500\" />\n                ) : (\n                  <Shield className=\"w-6 h-6 text-muted-foreground\" />\n                )}\n              </div>\n              <div>\n                <CardTitle className=\"text-lg\">Two-Factor Authentication</CardTitle>\n                <CardDescription>\n                  Add an extra layer of security to your account\n                </CardDescription>\n              </div>\n            </div>\n            <Badge variant={is2FAEnabled ? \"default\" : \"secondary\"} data-testid=\"badge-2fa-status\">\n              {is2FAEnabled ? \"Enabled\" : \"Disabled\"}\n            </Badge>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-4\">\n            <p className=\"text-sm text-muted-foreground\">\n              Two-factor authentication adds an additional layer of security to your account by requiring \n              a verification code from your authenticator app whenever you sign in.\n            </p>\n            \n            {is2FAEnabled ? (\n              <Button\n                variant=\"destructive\"\n                onClick={() => setDisableDialogOpen(true)}\n                disabled={isSubmitting}\n                data-testid=\"button-disable-2fa\"\n              >\n                <ShieldOff className=\"w-4 h-4 mr-2\" />\n                Disable 2FA\n              </Button>\n            ) : (\n              <Button\n                onClick={handleSetup2FA}\n                disabled={isSubmitting}\n                data-testid=\"button-enable-2fa\"\n              >\n                {isSubmitting ? (\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                ) : (\n                  <ShieldCheck className=\"w-4 h-4 mr-2\" />\n                )}\n                Enable 2FA\n              </Button>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      <Dialog open={setupDialogOpen} onOpenChange={setSetupDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <QrCode className=\"w-5 h-5\" />\n              Set Up Two-Factor Authentication\n            </DialogTitle>\n            <DialogDescription>\n              Scan the QR code with your authenticator app (Google Authenticator, Authy, etc.)\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-6 py-4\">\n            {qrCode && (\n              <div className=\"flex justify-center\">\n                <div className=\"bg-white p-4 rounded-lg\">\n                  <img src={qrCode} alt=\"2FA QR Code\" className=\"w-48 h-48\" data-testid=\"img-2fa-qr\" />\n                </div>\n              </div>\n            )}\n            \n            {secret && (\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm text-muted-foreground\">\n                  Or enter this secret key manually:\n                </Label>\n                <div className=\"flex items-center gap-2\">\n                  <Input\n                    value={showSecret ? secret : \"\"}\n                    readOnly\n                    className=\"font-mono text-sm\"\n                    data-testid=\"input-2fa-secret\"\n                  />\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={() => setShowSecret(!showSecret)}\n                    data-testid=\"button-toggle-secret\"\n                  >\n                    {showSecret ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\n                  </Button>\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={copySecret}\n                    data-testid=\"button-copy-secret\"\n                  >\n                    <Copy className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n              </div>\n            )}\n            \n            <div className=\"space-y-2\">\n              <Label>Enter the 6-digit verification code from your app:</Label>\n              <div className=\"flex justify-center\">\n                <InputOTP\n                  maxLength={6}\n                  value={verificationCode}\n                  onChange={setVerificationCode}\n                  data-testid=\"input-2fa-verify-code\"\n                >\n                  <InputOTPGroup>\n                    <InputOTPSlot index={0} />\n                    <InputOTPSlot index={1} />\n                    <InputOTPSlot index={2} />\n                    <InputOTPSlot index={3} />\n                    <InputOTPSlot index={4} />\n                    <InputOTPSlot index={5} />\n                  </InputOTPGroup>\n                </InputOTP>\n              </div>\n            </div>\n          </div>\n          \n          <DialogFooter>\n            <Button\n              variant=\"ghost\"\n              onClick={() => setSetupDialogOpen(false)}\n              disabled={isSubmitting}\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleVerify2FA}\n              disabled={isSubmitting || verificationCode.length !== 6}\n              data-testid=\"button-confirm-2fa\"\n            >\n              {isSubmitting ? (\n                <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n              ) : (\n                <Key className=\"w-4 h-4 mr-2\" />\n              )}\n              Verify & Enable\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={disableDialogOpen} onOpenChange={setDisableDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2 text-destructive\">\n              <ShieldOff className=\"w-5 h-5\" />\n              Disable Two-Factor Authentication\n            </DialogTitle>\n            <DialogDescription>\n              To disable 2FA, please confirm your password and enter a verification code.\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Password</Label>\n              <Input\n                type=\"password\"\n                value={disablePassword}\n                onChange={(e) => setDisablePassword(e.target.value)}\n                placeholder=\"Enter your password\"\n                data-testid=\"input-disable-password\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label>Verification Code</Label>\n              <div className=\"flex justify-center\">\n                <InputOTP\n                  maxLength={6}\n                  value={disableCode}\n                  onChange={setDisableCode}\n                  data-testid=\"input-disable-code\"\n                >\n                  <InputOTPGroup>\n                    <InputOTPSlot index={0} />\n                    <InputOTPSlot index={1} />\n                    <InputOTPSlot index={2} />\n                    <InputOTPSlot index={3} />\n                    <InputOTPSlot index={4} />\n                    <InputOTPSlot index={5} />\n                  </InputOTPGroup>\n                </InputOTP>\n              </div>\n            </div>\n          </div>\n          \n          <DialogFooter>\n            <Button\n              variant=\"ghost\"\n              onClick={() => setDisableDialogOpen(false)}\n              disabled={isSubmitting}\n            >\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={handleDisable2FA}\n              disabled={isSubmitting || !disablePassword || disableCode.length !== 6}\n              data-testid=\"button-confirm-disable-2fa\"\n            >\n              {isSubmitting ? (\n                <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n              ) : (\n                <ShieldOff className=\"w-4 h-4 mr-2\" />\n              )}\n              Disable 2FA\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":14302,"size_tokens":null},"client/src/pages/loyalty.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Star, Plus, Minus, Search, User, TrendingUp, Gift, History } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport type { WifiUser, LoyaltyPoints, LoyaltyTransaction } from \"@shared/schema\";\n\nexport default function LoyaltyPage() {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedUser, setSelectedUser] = useState<WifiUser | null>(null);\n  const [pointsToAdd, setPointsToAdd] = useState(\"\");\n  const [pointsToRedeem, setPointsToRedeem] = useState(\"\");\n  const [addReason, setAddReason] = useState(\"\");\n  const [redeemReason, setRedeemReason] = useState(\"\");\n  const [addDialogOpen, setAddDialogOpen] = useState(false);\n  const [redeemDialogOpen, setRedeemDialogOpen] = useState(false);\n\n  const { data: wifiUsers, isLoading: loadingUsers } = useQuery<WifiUser[]>({\n    queryKey: [\"/api/wifi-users\"],\n  });\n\n  const { data: loyaltyData, isLoading: loadingLoyalty } = useQuery<LoyaltyPoints>({\n    queryKey: [\"/api/loyalty\", selectedUser?.id],\n    enabled: !!selectedUser?.id,\n  });\n\n  const { data: transactions, isLoading: loadingTransactions } = useQuery<LoyaltyTransaction[]>({\n    queryKey: [\"/api/loyalty\", selectedUser?.id, \"transactions\"],\n    enabled: !!selectedUser?.id,\n  });\n\n  const addPointsMutation = useMutation({\n    mutationFn: async ({ points, reason }: { points: number; reason: string }) => {\n      return apiRequest(\"POST\", `/api/loyalty/${selectedUser?.id}/add`, { points, reason });\n    },\n    onSuccess: () => {\n      toast({ title: \"Success\", description: \"Points added successfully\" });\n      setPointsToAdd(\"\");\n      setAddReason(\"\");\n      setAddDialogOpen(false);\n      queryClient.invalidateQueries({ queryKey: [\"/api/loyalty\", selectedUser?.id] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/loyalty\", selectedUser?.id, \"transactions\"] });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"Failed to add points\", variant: \"destructive\" });\n    },\n  });\n\n  const redeemPointsMutation = useMutation({\n    mutationFn: async ({ points, reason }: { points: number; reason: string }) => {\n      return apiRequest(\"POST\", `/api/loyalty/${selectedUser?.id}/redeem`, { points, reason });\n    },\n    onSuccess: () => {\n      toast({ title: \"Success\", description: \"Points redeemed successfully\" });\n      setPointsToRedeem(\"\");\n      setRedeemReason(\"\");\n      setRedeemDialogOpen(false);\n      queryClient.invalidateQueries({ queryKey: [\"/api/loyalty\", selectedUser?.id] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/loyalty\", selectedUser?.id, \"transactions\"] });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"Failed to redeem points\", variant: \"destructive\" });\n    },\n  });\n\n  const filteredUsers = wifiUsers?.filter(user =>\n    user.fullName?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    user.phoneNumber?.includes(searchQuery)\n  ) || [];\n\n  const handleAddPoints = () => {\n    const points = parseInt(pointsToAdd);\n    if (isNaN(points) || points <= 0) {\n      toast({ title: \"Error\", description: \"Please enter a valid number of points\", variant: \"destructive\" });\n      return;\n    }\n    addPointsMutation.mutate({ points, reason: addReason || \"Manual addition\" });\n  };\n\n  const handleRedeemPoints = () => {\n    const points = parseInt(pointsToRedeem);\n    if (isNaN(points) || points <= 0) {\n      toast({ title: \"Error\", description: \"Please enter a valid number of points\", variant: \"destructive\" });\n      return;\n    }\n    if (points > (loyaltyData?.points || 0)) {\n      toast({ title: \"Error\", description: \"Insufficient points balance\", variant: \"destructive\" });\n      return;\n    }\n    redeemPointsMutation.mutate({ points, reason: redeemReason || \"Manual redemption\" });\n  };\n\n  return (\n    <div className=\"flex h-full gap-4 p-4\">\n      <Card className=\"w-80 flex flex-col\">\n        <CardHeader className=\"pb-3\">\n          <CardTitle className=\"flex items-center gap-2 text-lg\">\n            <Star className=\"h-5 w-5\" />\n            Customers\n          </CardTitle>\n          <div className=\"relative mt-2\">\n            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n            <Input\n              placeholder=\"Search customers...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"pl-9\"\n              data-testid=\"input-search-loyalty\"\n            />\n          </div>\n        </CardHeader>\n        <CardContent className=\"flex-1 p-0\">\n          <ScrollArea className=\"h-[calc(100vh-280px)]\">\n            {loadingUsers ? (\n              <div className=\"space-y-2 p-4\">\n                {[1, 2, 3].map(i => (\n                  <Skeleton key={i} className=\"h-16 w-full\" />\n                ))}\n              </div>\n            ) : (\n              <div className=\"space-y-1 p-2\">\n                {filteredUsers.map((user) => {\n                  const isSelected = selectedUser?.id === user.id;\n                  return (\n                    <button\n                      key={user.id}\n                      onClick={() => setSelectedUser(user)}\n                      className={`w-full p-3 rounded-md text-left transition-colors ${\n                        isSelected\n                          ? \"bg-primary/10 border border-primary/20\"\n                          : \"hover-elevate\"\n                      }`}\n                      data-testid={`loyalty-user-${user.id}`}\n                    >\n                      <div className=\"flex items-center gap-2\">\n                        <div className=\"w-8 h-8 rounded-full bg-muted flex items-center justify-center flex-shrink-0\">\n                          <User className=\"h-4 w-4\" />\n                        </div>\n                        <div className=\"min-w-0\">\n                          <p className=\"font-medium truncate text-sm\">\n                            {user.fullName || \"Unknown\"}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground truncate\">\n                            {user.phoneNumber}\n                          </p>\n                        </div>\n                      </div>\n                    </button>\n                  );\n                })}\n                {filteredUsers.length === 0 && (\n                  <p className=\"text-center text-muted-foreground py-8 text-sm\">\n                    No customers found\n                  </p>\n                )}\n              </div>\n            )}\n          </ScrollArea>\n        </CardContent>\n      </Card>\n\n      <div className=\"flex-1 flex flex-col gap-4\">\n        {selectedUser ? (\n          <>\n            <div className=\"grid grid-cols-3 gap-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardDescription>Current Balance</CardDescription>\n                  <CardTitle className=\"text-3xl flex items-center gap-2\">\n                    <Star className=\"h-6 w-6 text-yellow-500\" />\n                    {loadingLoyalty ? <Skeleton className=\"h-9 w-20\" /> : loyaltyData?.points || 0}\n                  </CardTitle>\n                </CardHeader>\n              </Card>\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardDescription>Total Earned</CardDescription>\n                  <CardTitle className=\"text-3xl flex items-center gap-2\">\n                    <TrendingUp className=\"h-6 w-6 text-green-500\" />\n                    {loadingLoyalty ? <Skeleton className=\"h-9 w-20\" /> : loyaltyData?.totalEarned || 0}\n                  </CardTitle>\n                </CardHeader>\n              </Card>\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardDescription>Total Redeemed</CardDescription>\n                  <CardTitle className=\"text-3xl flex items-center gap-2\">\n                    <Gift className=\"h-6 w-6 text-purple-500\" />\n                    {loadingLoyalty ? <Skeleton className=\"h-9 w-20\" /> : loyaltyData?.totalRedeemed || 0}\n                  </CardTitle>\n                </CardHeader>\n              </Card>\n            </div>\n\n            <Card className=\"flex-1\">\n              <CardHeader className=\"flex flex-row items-center justify-between gap-4\">\n                <div>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <User className=\"h-5 w-5\" />\n                    {selectedUser.fullName || \"Customer\"}\n                  </CardTitle>\n                  <CardDescription>{selectedUser.phoneNumber}</CardDescription>\n                </div>\n                <div className=\"flex gap-2\">\n                  <Dialog open={addDialogOpen} onOpenChange={setAddDialogOpen}>\n                    <DialogTrigger asChild>\n                      <Button variant=\"outline\" data-testid=\"button-add-points\">\n                        <Plus className=\"h-4 w-4 mr-2\" />\n                        Add Points\n                      </Button>\n                    </DialogTrigger>\n                    <DialogContent>\n                      <DialogHeader>\n                        <DialogTitle>Add Loyalty Points</DialogTitle>\n                        <DialogDescription>\n                          Add points to {selectedUser.fullName || \"this customer\"}'s account\n                        </DialogDescription>\n                      </DialogHeader>\n                      <div className=\"space-y-4 pt-4\">\n                        <div>\n                          <label className=\"text-sm font-medium\">Points to Add</label>\n                          <Input\n                            type=\"number\"\n                            placeholder=\"Enter points\"\n                            value={pointsToAdd}\n                            onChange={(e) => setPointsToAdd(e.target.value)}\n                            data-testid=\"input-add-points\"\n                          />\n                        </div>\n                        <div>\n                          <label className=\"text-sm font-medium\">Reason (optional)</label>\n                          <Input\n                            placeholder=\"e.g., Referral bonus, Promotion\"\n                            value={addReason}\n                            onChange={(e) => setAddReason(e.target.value)}\n                            data-testid=\"input-add-reason\"\n                          />\n                        </div>\n                        <Button\n                          onClick={handleAddPoints}\n                          disabled={addPointsMutation.isPending}\n                          className=\"w-full\"\n                          data-testid=\"button-confirm-add\"\n                        >\n                          {addPointsMutation.isPending ? \"Adding...\" : \"Add Points\"}\n                        </Button>\n                      </div>\n                    </DialogContent>\n                  </Dialog>\n\n                  <Dialog open={redeemDialogOpen} onOpenChange={setRedeemDialogOpen}>\n                    <DialogTrigger asChild>\n                      <Button variant=\"outline\" data-testid=\"button-redeem-points\">\n                        <Minus className=\"h-4 w-4 mr-2\" />\n                        Redeem Points\n                      </Button>\n                    </DialogTrigger>\n                    <DialogContent>\n                      <DialogHeader>\n                        <DialogTitle>Redeem Loyalty Points</DialogTitle>\n                        <DialogDescription>\n                          Redeem points from {selectedUser.fullName || \"this customer\"}'s account.\n                          Current balance: {loyaltyData?.points || 0} points\n                        </DialogDescription>\n                      </DialogHeader>\n                      <div className=\"space-y-4 pt-4\">\n                        <div>\n                          <label className=\"text-sm font-medium\">Points to Redeem</label>\n                          <Input\n                            type=\"number\"\n                            placeholder=\"Enter points\"\n                            value={pointsToRedeem}\n                            onChange={(e) => setPointsToRedeem(e.target.value)}\n                            max={loyaltyData?.points || 0}\n                            data-testid=\"input-redeem-points\"\n                          />\n                        </div>\n                        <div>\n                          <label className=\"text-sm font-medium\">Reason (optional)</label>\n                          <Input\n                            placeholder=\"e.g., Free day pass, Discount applied\"\n                            value={redeemReason}\n                            onChange={(e) => setRedeemReason(e.target.value)}\n                            data-testid=\"input-redeem-reason\"\n                          />\n                        </div>\n                        <Button\n                          onClick={handleRedeemPoints}\n                          disabled={redeemPointsMutation.isPending}\n                          className=\"w-full\"\n                          data-testid=\"button-confirm-redeem\"\n                        >\n                          {redeemPointsMutation.isPending ? \"Redeeming...\" : \"Redeem Points\"}\n                        </Button>\n                      </div>\n                    </DialogContent>\n                  </Dialog>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"flex items-center gap-2 mb-4\">\n                  <History className=\"h-5 w-5\" />\n                  <h3 className=\"font-medium\">Transaction History</h3>\n                </div>\n                {loadingTransactions ? (\n                  <div className=\"space-y-2\">\n                    {[1, 2, 3].map(i => (\n                      <Skeleton key={i} className=\"h-12 w-full\" />\n                    ))}\n                  </div>\n                ) : transactions && transactions.length > 0 ? (\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Date</TableHead>\n                        <TableHead>Type</TableHead>\n                        <TableHead>Points</TableHead>\n                        <TableHead>Reason</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {transactions.map((tx) => (\n                        <TableRow key={tx.id}>\n                          <TableCell className=\"text-sm\">\n                            {tx.createdAt && format(new Date(tx.createdAt), \"MMM d, yyyy h:mm a\")}\n                          </TableCell>\n                          <TableCell>\n                            <Badge variant={tx.type === \"earn\" ? \"default\" : \"secondary\"}>\n                              {tx.type === \"earn\" ? \"Earned\" : \"Redeemed\"}\n                            </Badge>\n                          </TableCell>\n                          <TableCell className={tx.type === \"earn\" ? \"text-green-500\" : \"text-red-500\"}>\n                            {tx.type === \"earn\" ? \"+\" : \"-\"}{tx.points}\n                          </TableCell>\n                          <TableCell className=\"text-muted-foreground text-sm\">\n                            {tx.description || \"-\"}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                ) : (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <History className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                    <p>No transactions yet</p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </>\n        ) : (\n          <Card className=\"flex-1 flex items-center justify-center\">\n            <div className=\"text-center text-muted-foreground\">\n              <Star className=\"h-16 w-16 mx-auto mb-4 opacity-50\" />\n              <h3 className=\"text-lg font-medium\">Select a customer</h3>\n              <p className=\"text-sm\">Choose a customer to view and manage their loyalty points</p>\n            </div>\n          </Card>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":17000,"size_tokens":null},"client/src/pages/upgrade.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation, Link } from \"wouter\";\nimport { motion } from \"framer-motion\";\nimport { Crown, Check, Zap, Shield, Users, BarChart3, MessageSquare, Router, Globe, ArrowRight, Phone, Building, Clock, AlertTriangle } from \"lucide-react\";\nimport { SiPaypal } from \"react-icons/si\";\nimport { MeshBackground } from \"@/components/mesh-background\";\nimport { MnetiFiLogo, MpesaLogo } from \"@/components/mnetifi-logo\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useRequireAuth } from \"@/hooks/use-session\";\nimport { DashboardLayout } from \"@/layouts/dashboard-layout\";\n\ntype PaymentMethod = \"MPESA\" | \"BANK\" | \"PAYPAL\" | null;\n\nconst premiumFeatures = [\n  { icon: Router, title: \"PPPoE Management\", description: \"Full PPPoE user and billing management\" },\n  { icon: Globe, title: \"Static IP Billing\", description: \"Assign and bill static IP addresses\" },\n  { icon: Users, title: \"Technician Accounts\", description: \"Create sub-accounts for your field technicians\" },\n  { icon: MessageSquare, title: \"SMS Campaigns\", description: \"Send bulk SMS to your customers\" },\n  { icon: Shield, title: \"Advanced Security\", description: \"Two-factor authentication and audit logs\" },\n  { icon: BarChart3, title: \"Advanced Reports\", description: \"Detailed revenue and usage analytics\" },\n];\n\nconst pricingTiers = [\n  { duration: \"1 Month\", price: 2999, perMonth: 2999, popular: false },\n  { duration: \"3 Months\", price: 7999, perMonth: 2666, popular: true },\n  { duration: \"6 Months\", price: 14999, perMonth: 2500, popular: false },\n  { duration: \"1 Year\", price: 24999, perMonth: 2083, popular: false },\n];\n\nexport default function UpgradePage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const { user, subscriptionTier, trialExpiresAt } = useRequireAuth();\n  const [selectedDuration, setSelectedDuration] = useState(1);\n  const [paymentMethod, setPaymentMethod] = useState<PaymentMethod>(null);\n  const [phoneNumber, setPhoneNumber] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n\n  const isTrialExpired = trialExpiresAt && new Date(trialExpiresAt) < new Date();\n  const isPremium = subscriptionTier === \"PREMIUM\";\n\n  const handleUpgrade = async () => {\n    if (!paymentMethod) {\n      toast({\n        title: \"Payment method required\",\n        description: \"Please select a payment method\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (paymentMethod === \"MPESA\" && !phoneNumber.trim()) {\n      toast({\n        title: \"Phone number required\",\n        description: \"Please enter your M-Pesa phone number\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsLoading(true);\n\n    try {\n      const response = await fetch(\"/api/subscription/upgrade\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          durationMonths: pricingTiers[selectedDuration].duration.includes(\"Year\") ? 12 : parseInt(pricingTiers[selectedDuration].duration),\n          paymentMethod,\n          phoneNumber: paymentMethod === \"MPESA\" ? phoneNumber : undefined,\n          amount: pricingTiers[selectedDuration].price,\n        }),\n      });\n\n      const data = await response.json();\n\n      if (response.ok) {\n        if (paymentMethod === \"MPESA\" && data.checkoutRequestId) {\n          toast({\n            title: \"Payment initiated\",\n            description: \"Please check your phone for the M-Pesa prompt\",\n          });\n        } else {\n          toast({\n            title: \"Upgrade request submitted\",\n            description: \"You will be notified once payment is confirmed\",\n          });\n        }\n        \n        const sessionStr = localStorage.getItem(\"admin_session\");\n        if (sessionStr) {\n          const session = JSON.parse(sessionStr);\n          session.subscriptionTier = \"PREMIUM\";\n          session.subscriptionExpiresAt = data.subscriptionExpiresAt;\n          localStorage.setItem(\"admin_session\", JSON.stringify(session));\n        }\n        \n        setLocation(\"/dashboard\");\n      } else {\n        toast({\n          title: \"Upgrade failed\",\n          description: data.error || \"Unable to process upgrade\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      toast({\n        title: \"Upgrade failed\",\n        description: \"Unable to connect to server\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  if (isPremium) {\n    return (\n      <DashboardLayout>\n        <div className=\"p-6\">\n          <GlassPanel className=\"max-w-2xl mx-auto text-center py-12\">\n            <div className=\"w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-r from-purple-500/20 to-pink-500/20 flex items-center justify-center\">\n              <Crown size={40} className=\"text-purple-400\" />\n            </div>\n            <h1 className=\"text-3xl font-bold text-white mb-4\">You're Already Premium!</h1>\n            <p className=\"text-muted-foreground mb-6\">\n              You have full access to all MnetiFi features. Thank you for your subscription.\n            </p>\n            <Link href=\"/dashboard\">\n              <Button className=\"gradient-btn\">\n                Go to Dashboard\n                <ArrowRight size={16} className=\"ml-2\" />\n              </Button>\n            </Link>\n          </GlassPanel>\n        </div>\n      </DashboardLayout>\n    );\n  }\n\n  return (\n    <DashboardLayout>\n      <div className=\"p-6\">\n        <div className=\"max-w-6xl mx-auto\">\n          {isTrialExpired && (\n            <motion.div\n              initial={{ opacity: 0, y: -20 }}\n              animate={{ opacity: 1, y: 0 }}\n              className=\"mb-6\"\n            >\n              <div className=\"p-4 rounded-xl bg-red-500/10 border border-red-500/20 flex items-center gap-4\">\n                <div className=\"w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0\">\n                  <AlertTriangle size={24} className=\"text-red-400\" />\n                </div>\n                <div>\n                  <h3 className=\"font-semibold text-white\" data-testid=\"text-trial-expired\">Your Free Trial Has Expired</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Upgrade to Premium to continue accessing your dashboard and managing your WiFi business.\n                  </p>\n                </div>\n              </div>\n            </motion.div>\n          )}\n\n          <div className=\"text-center mb-8\">\n            <Badge className=\"mb-4 bg-gradient-to-r from-purple-500/20 to-pink-500/20 text-purple-400 border-0\">\n              <Crown size={12} className=\"mr-1\" />\n              Upgrade to Premium\n            </Badge>\n            <h1 className=\"text-3xl font-bold text-white mb-2\">Unlock All Features</h1>\n            <p className=\"text-muted-foreground max-w-xl mx-auto\">\n              Get access to PPPoE, Static IP management, Technician accounts, SMS campaigns, and much more.\n            </p>\n          </div>\n\n          <div className=\"grid lg:grid-cols-2 gap-8 mb-8\">\n            <GlassPanel>\n              <h2 className=\"text-xl font-semibold text-white mb-6 flex items-center gap-2\">\n                <Zap size={20} className=\"text-cyan-400\" />\n                Premium Features\n              </h2>\n              <div className=\"grid gap-4\">\n                {premiumFeatures.map((feature, i) => (\n                  <div key={i} className=\"flex items-start gap-4 p-3 rounded-lg bg-white/5\">\n                    <div className=\"w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center flex-shrink-0\">\n                      <feature.icon size={20} className=\"text-purple-400\" />\n                    </div>\n                    <div>\n                      <h3 className=\"font-medium text-white\">{feature.title}</h3>\n                      <p className=\"text-sm text-muted-foreground\">{feature.description}</p>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </GlassPanel>\n\n            <div className=\"space-y-6\">\n              <GlassPanel>\n                <h2 className=\"text-xl font-semibold text-white mb-4 flex items-center gap-2\">\n                  <Clock size={20} className=\"text-cyan-400\" />\n                  Select Duration\n                </h2>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  {pricingTiers.map((tier, i) => (\n                    <button\n                      key={i}\n                      onClick={() => setSelectedDuration(i)}\n                      className={`p-4 rounded-xl border transition-all text-left relative ${\n                        selectedDuration === i\n                          ? \"border-purple-500 bg-purple-500/10 ring-2 ring-purple-500/30\"\n                          : \"border-white/10 bg-white/5 hover:bg-white/10\"\n                      }`}\n                      data-testid={`button-duration-${i}`}\n                    >\n                      {tier.popular && (\n                        <Badge className=\"absolute -top-2 -right-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-[10px] border-0\">\n                          Popular\n                        </Badge>\n                      )}\n                      <p className=\"font-semibold text-white\">{tier.duration}</p>\n                      <p className=\"text-xl font-bold text-purple-400\">Ksh {tier.price.toLocaleString()}</p>\n                      <p className=\"text-xs text-muted-foreground\">Ksh {tier.perMonth}/month</p>\n                    </button>\n                  ))}\n                </div>\n              </GlassPanel>\n\n              <GlassPanel>\n                <h2 className=\"text-xl font-semibold text-white mb-4\">Payment Method</h2>\n                <div className=\"space-y-3\">\n                  <button\n                    onClick={() => setPaymentMethod(\"MPESA\")}\n                    className={`w-full p-4 rounded-xl border flex items-center gap-4 transition-all ${\n                      paymentMethod === \"MPESA\"\n                        ? \"border-green-500 bg-green-500/10\"\n                        : \"border-white/10 bg-white/5 hover:bg-white/10\"\n                    }`}\n                    data-testid=\"button-payment-mpesa\"\n                  >\n                    <MpesaLogo size={32} />\n                    <div className=\"text-left\">\n                      <p className=\"font-medium text-white\">M-Pesa</p>\n                      <p className=\"text-xs text-muted-foreground\">Pay via Lipa Na M-Pesa</p>\n                    </div>\n                    {paymentMethod === \"MPESA\" && <Check size={20} className=\"ml-auto text-green-400\" />}\n                  </button>\n\n                  <button\n                    onClick={() => setPaymentMethod(\"BANK\")}\n                    className={`w-full p-4 rounded-xl border flex items-center gap-4 transition-all ${\n                      paymentMethod === \"BANK\"\n                        ? \"border-cyan-500 bg-cyan-500/10\"\n                        : \"border-white/10 bg-white/5 hover:bg-white/10\"\n                    }`}\n                    data-testid=\"button-payment-bank\"\n                  >\n                    <div className=\"w-8 h-8 rounded-full bg-cyan-500/20 flex items-center justify-center\">\n                      <Building size={18} className=\"text-cyan-400\" />\n                    </div>\n                    <div className=\"text-left\">\n                      <p className=\"font-medium text-white\">Bank Transfer</p>\n                      <p className=\"text-xs text-muted-foreground\">Direct bank deposit</p>\n                    </div>\n                    {paymentMethod === \"BANK\" && <Check size={20} className=\"ml-auto text-cyan-400\" />}\n                  </button>\n\n                  <button\n                    onClick={() => setPaymentMethod(\"PAYPAL\")}\n                    className={`w-full p-4 rounded-xl border flex items-center gap-4 transition-all ${\n                      paymentMethod === \"PAYPAL\"\n                        ? \"border-blue-500 bg-blue-500/10\"\n                        : \"border-white/10 bg-white/5 hover:bg-white/10\"\n                    }`}\n                    data-testid=\"button-payment-paypal\"\n                  >\n                    <div className=\"w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center\">\n                      <SiPaypal size={18} className=\"text-blue-400\" />\n                    </div>\n                    <div className=\"text-left\">\n                      <p className=\"font-medium text-white\">PayPal</p>\n                      <p className=\"text-xs text-muted-foreground\">Pay with PayPal or card</p>\n                    </div>\n                    {paymentMethod === \"PAYPAL\" && <Check size={20} className=\"ml-auto text-blue-400\" />}\n                  </button>\n                </div>\n\n                {paymentMethod === \"MPESA\" && (\n                  <div className=\"mt-4\">\n                    <GlassInput\n                      label=\"M-Pesa Phone Number\"\n                      placeholder=\"254712345678\"\n                      value={phoneNumber}\n                      onChange={(e) => setPhoneNumber(e.target.value)}\n                      icon={<Phone size={16} />}\n                      data-testid=\"input-mpesa-phone\"\n                    />\n                  </div>\n                )}\n\n                {paymentMethod === \"BANK\" && (\n                  <div className=\"mt-4 p-4 rounded-lg bg-white/5 text-sm\">\n                    <p className=\"font-medium text-white mb-2\">Bank Details:</p>\n                    <p className=\"text-muted-foreground\">Bank: Equity Bank Kenya</p>\n                    <p className=\"text-muted-foreground\">Account: 0123456789012</p>\n                    <p className=\"text-muted-foreground\">Name: MnetiFi Limited</p>\n                    <p className=\"text-xs text-cyan-400 mt-2\">Upload proof of payment after transfer</p>\n                  </div>\n                )}\n\n                <div className=\"mt-6 pt-4 border-t border-white/10\">\n                  <div className=\"flex justify-between items-center mb-4\">\n                    <span className=\"text-muted-foreground\">Total Amount:</span>\n                    <span className=\"text-2xl font-bold text-white\">\n                      Ksh {pricingTiers[selectedDuration].price.toLocaleString()}\n                    </span>\n                  </div>\n                  <Button\n                    onClick={handleUpgrade}\n                    disabled={isLoading || !paymentMethod}\n                    className=\"w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600\"\n                    data-testid=\"button-upgrade\"\n                  >\n                    {isLoading ? \"Processing...\" : \"Upgrade Now\"}\n                    <ArrowRight size={16} className=\"ml-2\" />\n                  </Button>\n                </div>\n              </GlassPanel>\n            </div>\n          </div>\n        </div>\n      </div>\n    </DashboardLayout>\n  );\n}\n","path":null,"size_bytes":15191,"size_tokens":null},"client/src/pages/settings/notifications.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { MessageSquare, Save, Eye, EyeOff } from \"lucide-react\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Tenant } from \"@shared/schema\";\n\nexport default function NotificationsPage() {\n  const { toast } = useToast();\n  const [showSecrets, setShowSecrets] = useState(false);\n\n  const { data: tenant, isLoading } = useQuery<Tenant>({\n    queryKey: [\"/api/tenant\"],\n  });\n\n  const [formData, setFormData] = useState({\n    smsProvider: \"mock\",\n    smsApiKey: \"\",\n    smsUsername: \"\",\n    smsSenderId: \"\",\n  });\n\n  useEffect(() => {\n    if (tenant) {\n      setFormData({\n        smsProvider: tenant.smsProvider || \"mock\",\n        smsApiKey: tenant.smsApiKey || \"\",\n        smsUsername: tenant.smsUsername || \"\",\n        smsSenderId: tenant.smsSenderId || \"\",\n      });\n    }\n  }, [tenant]);\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      return apiRequest(\"PATCH\", \"/api/tenant\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tenant\"] });\n      toast({\n        title: \"Settings Saved\",\n        description: \"Your notification settings have been updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save settings\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    saveMutation.mutate(formData);\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"settings-notifications-page\">\n      <div>\n        <h1 className=\"text-2xl font-bold text-white\">Notifications</h1>\n        <p className=\"text-muted-foreground\">\n          Configure SMS provider for customer notifications and campaigns\n        </p>\n      </div>\n\n      <form onSubmit={handleSubmit} className=\"space-y-6\">\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center justify-between mb-6\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 rounded-lg bg-orange-500/20\">\n                <MessageSquare size={20} className=\"text-orange-400\" />\n              </div>\n              <div>\n                <h2 className=\"text-lg font-semibold text-white\">SMS Integration</h2>\n                <p className=\"text-sm text-muted-foreground\">\n                  Configure SMS provider for customer notifications and campaigns\n                </p>\n              </div>\n            </div>\n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => setShowSecrets(!showSecrets)}\n              data-testid=\"button-toggle-sms-secrets\"\n            >\n              {showSecrets ? (\n                <>\n                  <EyeOff size={16} className=\"mr-2\" />\n                  Hide\n                </>\n              ) : (\n                <>\n                  <Eye size={16} className=\"mr-2\" />\n                  Show\n                </>\n              )}\n            </Button>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            <div className=\"space-y-2\">\n              <Label className=\"text-muted-foreground\">SMS Provider</Label>\n              <Select \n                value={formData.smsProvider} \n                onValueChange={(value) => setFormData({ ...formData, smsProvider: value })}\n              >\n                <SelectTrigger className=\"glass-input\" data-testid=\"select-sms-provider\">\n                  <SelectValue placeholder=\"Select provider\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"mock\">Mock (Testing)</SelectItem>\n                  <SelectItem value=\"africas_talking\">Africa's Talking</SelectItem>\n                  <SelectItem value=\"twilio\">Twilio</SelectItem>\n                </SelectContent>\n              </Select>\n              <p className=\"text-xs text-muted-foreground\">\n                Use Mock for testing, Africa's Talking for production in Kenya\n              </p>\n            </div>\n\n            <GlassInput\n              label=\"Sender ID\"\n              placeholder=\"YOURCOMPANY\"\n              value={formData.smsSenderId}\n              onChange={(e) => setFormData({ ...formData, smsSenderId: e.target.value })}\n              data-testid=\"input-sms-sender-id\"\n            />\n\n            <GlassInput\n              label=\"API Key\"\n              type={showSecrets ? \"text\" : \"password\"}\n              placeholder=\"Your SMS API Key\"\n              value={formData.smsApiKey}\n              onChange={(e) => setFormData({ ...formData, smsApiKey: e.target.value })}\n              data-testid=\"input-sms-api-key\"\n            />\n\n            <GlassInput\n              label=\"Username\"\n              placeholder=\"sandbox or your username\"\n              value={formData.smsUsername}\n              onChange={(e) => setFormData({ ...formData, smsUsername: e.target.value })}\n              data-testid=\"input-sms-username\"\n            />\n          </div>\n\n          <div className=\"mt-4 p-4 rounded-xl bg-orange-500/10 border border-orange-500/20\">\n            <p className=\"text-sm text-muted-foreground\">\n              For Africa's Talking, get your credentials from the{\" \"}\n              <a\n                href=\"https://africastalking.com/\"\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"text-cyan-400 hover:text-cyan-300\"\n              >\n                Africa's Talking Dashboard\n              </a>\n              . Use \"sandbox\" as username for testing. SMS campaigns are available for Tier 2 subscribers.\n            </p>\n          </div>\n        </GlassPanel>\n\n        <div className=\"flex justify-end\">\n          <Button\n            type=\"submit\"\n            className=\"gradient-btn px-8\"\n            disabled={saveMutation.isPending}\n            data-testid=\"button-save-notifications\"\n          >\n            <Save size={18} className=\"mr-2\" />\n            {saveMutation.isPending ? \"Saving...\" : \"Save Notification Settings\"}\n          </Button>\n        </div>\n      </form>\n    </div>\n  );\n}\n","path":null,"size_bytes":6645,"size_tokens":null},"client/src/pages/settings/clear-cache.tsx":{"content":"import { useState } from \"react\";\nimport { Trash2, RefreshCw, Database, FileText, Image } from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { Button } from \"@/components/ui/button\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function ClearCachePage() {\n  const { toast } = useToast();\n  const [isClearing, setIsClearing] = useState(false);\n\n  const [options, setOptions] = useState({\n    sessionCache: true,\n    queryCache: true,\n    imageCache: false,\n    allCache: false,\n  });\n\n  const handleClearCache = async () => {\n    setIsClearing(true);\n    try {\n      await new Promise(resolve => setTimeout(resolve, 1500));\n      \n      const cleared = [];\n      if (options.sessionCache || options.allCache) cleared.push(\"session cache\");\n      if (options.queryCache || options.allCache) cleared.push(\"query cache\");\n      if (options.imageCache || options.allCache) cleared.push(\"image cache\");\n      \n      toast({\n        title: \"Cache Cleared\",\n        description: `Successfully cleared: ${cleared.join(\", \")}.`,\n      });\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to clear cache. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsClearing(false);\n    }\n  };\n\n  const handleToggleOption = (key: keyof typeof options) => {\n    if (key === \"allCache\") {\n      const newValue = !options.allCache;\n      setOptions({\n        sessionCache: newValue,\n        queryCache: newValue,\n        imageCache: newValue,\n        allCache: newValue,\n      });\n    } else {\n      setOptions({\n        ...options,\n        [key]: !options[key],\n        allCache: false,\n      });\n    }\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"settings-clear-cache-page\">\n      <div>\n        <h1 className=\"text-2xl font-bold text-white\">Clear Cache</h1>\n        <p className=\"text-muted-foreground\">\n          Clear application cache to free up space and fix display issues\n        </p>\n      </div>\n\n      <GlassPanel size=\"md\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <div className=\"p-2 rounded-lg bg-red-500/20\">\n            <Trash2 size={20} className=\"text-red-400\" />\n          </div>\n          <div>\n            <h2 className=\"text-lg font-semibold text-white\">Cache Options</h2>\n            <p className=\"text-sm text-muted-foreground\">\n              Select which caches to clear\n            </p>\n          </div>\n        </div>\n\n        <div className=\"space-y-4\">\n          <div className=\"flex items-center justify-between p-4 rounded-lg bg-white/5 border border-white/10\">\n            <div className=\"flex items-center gap-3\">\n              <Database size={20} className=\"text-cyan-400\" />\n              <div>\n                <Label className=\"text-white\">Session Cache</Label>\n                <p className=\"text-xs text-muted-foreground\">\n                  Clear user session data\n                </p>\n              </div>\n            </div>\n            <Switch\n              checked={options.sessionCache}\n              onCheckedChange={() => handleToggleOption(\"sessionCache\")}\n              data-testid=\"switch-session-cache\"\n            />\n          </div>\n\n          <div className=\"flex items-center justify-between p-4 rounded-lg bg-white/5 border border-white/10\">\n            <div className=\"flex items-center gap-3\">\n              <FileText size={20} className=\"text-purple-400\" />\n              <div>\n                <Label className=\"text-white\">Query Cache</Label>\n                <p className=\"text-xs text-muted-foreground\">\n                  Clear API response cache\n                </p>\n              </div>\n            </div>\n            <Switch\n              checked={options.queryCache}\n              onCheckedChange={() => handleToggleOption(\"queryCache\")}\n              data-testid=\"switch-query-cache\"\n            />\n          </div>\n\n          <div className=\"flex items-center justify-between p-4 rounded-lg bg-white/5 border border-white/10\">\n            <div className=\"flex items-center gap-3\">\n              <Image size={20} className=\"text-green-400\" />\n              <div>\n                <Label className=\"text-white\">Image Cache</Label>\n                <p className=\"text-xs text-muted-foreground\">\n                  Clear cached images and thumbnails\n                </p>\n              </div>\n            </div>\n            <Switch\n              checked={options.imageCache}\n              onCheckedChange={() => handleToggleOption(\"imageCache\")}\n              data-testid=\"switch-image-cache\"\n            />\n          </div>\n\n          <div className=\"flex items-center justify-between p-4 rounded-lg bg-orange-500/10 border border-orange-500/20\">\n            <div className=\"flex items-center gap-3\">\n              <RefreshCw size={20} className=\"text-orange-400\" />\n              <div>\n                <Label className=\"text-white\">Clear All Cache</Label>\n                <p className=\"text-xs text-muted-foreground\">\n                  Clear all cached data at once\n                </p>\n              </div>\n            </div>\n            <Switch\n              checked={options.allCache}\n              onCheckedChange={() => handleToggleOption(\"allCache\")}\n              data-testid=\"switch-all-cache\"\n            />\n          </div>\n        </div>\n\n        <div className=\"mt-6\">\n          <Button\n            onClick={handleClearCache}\n            disabled={isClearing || (!options.sessionCache && !options.queryCache && !options.imageCache && !options.allCache)}\n            className=\"w-full\"\n            variant=\"destructive\"\n            data-testid=\"button-clear-cache\"\n          >\n            <Trash2 size={18} className=\"mr-2\" />\n            {isClearing ? \"Clearing Cache...\" : \"Clear Selected Cache\"}\n          </Button>\n        </div>\n\n        <div className=\"mt-4 p-4 rounded-xl bg-blue-500/10 border border-blue-500/20\">\n          <p className=\"text-sm text-muted-foreground\">\n            Clearing cache is safe and will not delete your data. It may temporarily slow down the application while caches are rebuilt.\n          </p>\n        </div>\n      </GlassPanel>\n    </div>\n  );\n}\n","path":null,"size_bytes":6294,"size_tokens":null},"client/src/pages/router-terminal.tsx":{"content":"import { useState, useRef, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Terminal, Send, Trash2, Copy, Router, ChevronDown, ChevronRight, AlertTriangle, CheckCircle, XCircle } from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport type { Hotspot } from \"@shared/schema\";\n\ninterface CommandResult {\n  id: string;\n  command: string;\n  output: any;\n  success: boolean;\n  error?: string;\n  timestamp: string;\n}\n\ninterface PredefinedCommand {\n  label: string;\n  command: string;\n  description: string;\n}\n\ninterface CommandCategory {\n  category: string;\n  commands: PredefinedCommand[];\n}\n\nexport default function RouterTerminalPage() {\n  const { toast } = useToast();\n  const [selectedRouter, setSelectedRouter] = useState<string>(\"\");\n  const [command, setCommand] = useState(\"\");\n  const [history, setHistory] = useState<CommandResult[]>([]);\n  const [expandedCategories, setExpandedCategories] = useState<string[]>([\"System\", \"Hotspot\"]);\n  const terminalRef = useRef<HTMLDivElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n\n  // Fetch routers (hotspots)\n  const { data: routers } = useQuery<Hotspot[]>({\n    queryKey: [\"/api/hotspots\"],\n  });\n\n  // Fetch predefined commands\n  const { data: predefinedCommands } = useQuery<CommandCategory[]>({\n    queryKey: [\"/api/terminal/commands\"],\n  });\n\n  // Execute command mutation\n  const executeMutation = useMutation({\n    mutationFn: async ({ hotspotId, command }: { hotspotId: string; command: string }) => {\n      return apiRequest(\"POST\", \"/api/terminal/execute\", { hotspotId, command });\n    },\n    onSuccess: (data: any) => {\n      const result: CommandResult = {\n        id: Date.now().toString(),\n        command: data.command,\n        output: data.output || data.error,\n        success: data.success,\n        error: data.error,\n        timestamp: data.timestamp || new Date().toISOString(),\n      };\n      setHistory((prev) => [...prev, result]);\n      setCommand(\"\");\n    },\n    onError: (error: Error) => {\n      const result: CommandResult = {\n        id: Date.now().toString(),\n        command,\n        output: null,\n        success: false,\n        error: error.message || \"Failed to execute command\",\n        timestamp: new Date().toISOString(),\n      };\n      setHistory((prev) => [...prev, result]);\n      toast({\n        title: \"Command Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Auto-scroll terminal\n  useEffect(() => {\n    if (terminalRef.current) {\n      terminalRef.current.scrollTop = terminalRef.current.scrollHeight;\n    }\n  }, [history]);\n\n  const handleExecute = (e?: React.FormEvent) => {\n    e?.preventDefault();\n    if (!selectedRouter) {\n      toast({\n        title: \"Select a Router\",\n        description: \"Please select a router before executing commands\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    if (!command.trim()) return;\n    \n    executeMutation.mutate({ hotspotId: selectedRouter, command: command.trim() });\n  };\n\n  const handleQuickCommand = (cmd: string) => {\n    if (!selectedRouter) {\n      toast({\n        title: \"Select a Router\",\n        description: \"Please select a router before executing commands\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    executeMutation.mutate({ hotspotId: selectedRouter, command: cmd });\n  };\n\n  const clearHistory = () => {\n    setHistory([]);\n  };\n\n  const copyOutput = (output: any) => {\n    const text = typeof output === \"object\" ? JSON.stringify(output, null, 2) : String(output);\n    navigator.clipboard.writeText(text);\n    toast({\n      title: \"Copied\",\n      description: \"Output copied to clipboard\",\n    });\n  };\n\n  const toggleCategory = (category: string) => {\n    setExpandedCategories((prev) =>\n      prev.includes(category)\n        ? prev.filter((c) => c !== category)\n        : [...prev, category]\n    );\n  };\n\n  const formatOutput = (output: any): string => {\n    if (!output) return \"No output\";\n    if (typeof output === \"string\") return output;\n    if (Array.isArray(output)) {\n      if (output.length === 0) return \"Empty result\";\n      return JSON.stringify(output, null, 2);\n    }\n    return JSON.stringify(output, null, 2);\n  };\n\n  const selectedRouterName = routers?.find((r) => r.id === selectedRouter)?.locationName || \"No router selected\";\n\n  return (\n    <div className=\"p-6 h-full flex flex-col gap-6\" data-testid=\"router-terminal-page\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-white flex items-center gap-2\">\n            <Terminal size={28} className=\"text-cyan-400\" />\n            RouterOS Terminal\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Execute MikroTik RouterOS commands directly on your routers\n          </p>\n        </div>\n        \n        <div className=\"flex items-center gap-3\">\n          <Select value={selectedRouter} onValueChange={setSelectedRouter}>\n            <SelectTrigger className=\"w-[220px] bg-white/5 border-white/10\" data-testid=\"select-router\">\n              <Router size={16} className=\"mr-2 text-cyan-400\" />\n              <SelectValue placeholder=\"Select Router\" />\n            </SelectTrigger>\n            <SelectContent>\n              {routers?.map((router) => (\n                <SelectItem key={router.id} value={router.id}>\n                  {router.locationName}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          \n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={clearHistory}\n            disabled={history.length === 0}\n            data-testid=\"button-clear-terminal\"\n          >\n            <Trash2 size={16} className=\"mr-2\" />\n            Clear\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"flex-1 flex gap-6 min-h-0\">\n        {/* Command Sidebar */}\n        <div className=\"w-72 flex-shrink-0\">\n          <GlassPanel className=\"h-full overflow-auto\">\n            <h3 className=\"text-sm font-semibold text-white mb-4 flex items-center gap-2\">\n              Quick Commands\n            </h3>\n            \n            <div className=\"space-y-2\">\n              {predefinedCommands?.map((category) => (\n                <Collapsible\n                  key={category.category}\n                  open={expandedCategories.includes(category.category)}\n                  onOpenChange={() => toggleCategory(category.category)}\n                >\n                  <CollapsibleTrigger className=\"flex items-center gap-2 w-full p-2 rounded-lg hover:bg-white/5 text-left\">\n                    {expandedCategories.includes(category.category) ? (\n                      <ChevronDown size={14} className=\"text-muted-foreground\" />\n                    ) : (\n                      <ChevronRight size={14} className=\"text-muted-foreground\" />\n                    )}\n                    <span className=\"text-sm font-medium text-white\">{category.category}</span>\n                    <Badge variant=\"secondary\" className=\"ml-auto text-xs\">\n                      {category.commands.length}\n                    </Badge>\n                  </CollapsibleTrigger>\n                  <CollapsibleContent className=\"pl-6 space-y-1\">\n                    {category.commands.map((cmd, idx) => (\n                      <button\n                        key={idx}\n                        onClick={() => handleQuickCommand(cmd.command)}\n                        className=\"w-full text-left p-2 rounded-lg hover:bg-white/10 transition-colors group\"\n                        disabled={executeMutation.isPending || !selectedRouter}\n                        data-testid={`quick-cmd-${category.category}-${idx}`}\n                      >\n                        <div className=\"text-sm text-cyan-400 group-hover:text-cyan-300\">\n                          {cmd.label}\n                        </div>\n                        <div className=\"text-xs text-muted-foreground truncate\">\n                          {cmd.description}\n                        </div>\n                      </button>\n                    ))}\n                  </CollapsibleContent>\n                </Collapsible>\n              ))}\n            </div>\n          </GlassPanel>\n        </div>\n\n        {/* Terminal Area */}\n        <div className=\"flex-1 flex flex-col min-h-0\">\n          <GlassPanel className=\"flex-1 flex flex-col min-h-0 p-0 overflow-hidden\">\n            {/* Terminal Header */}\n            <div className=\"flex items-center gap-2 px-4 py-2 border-b border-white/10 bg-black/20\">\n              <div className=\"flex gap-1.5\">\n                <div className=\"w-3 h-3 rounded-full bg-red-500/80\" />\n                <div className=\"w-3 h-3 rounded-full bg-yellow-500/80\" />\n                <div className=\"w-3 h-3 rounded-full bg-green-500/80\" />\n              </div>\n              <span className=\"text-xs text-muted-foreground ml-2\">\n                {selectedRouterName}\n              </span>\n              {selectedRouter && (\n                <Badge variant=\"outline\" className=\"ml-auto text-xs\">\n                  Connected\n                </Badge>\n              )}\n            </div>\n\n            {/* Terminal Output */}\n            <div\n              ref={terminalRef}\n              className=\"flex-1 overflow-auto p-4 font-mono text-sm bg-black/40\"\n              onClick={() => inputRef.current?.focus()}\n            >\n              {history.length === 0 ? (\n                <div className=\"text-muted-foreground text-center py-8\">\n                  <Terminal size={48} className=\"mx-auto mb-4 opacity-30\" />\n                  <p>Select a router and start executing commands</p>\n                  <p className=\"text-xs mt-2\">Use quick commands on the left or type your own below</p>\n                </div>\n              ) : (\n                history.map((result) => (\n                  <div key={result.id} className=\"mb-4\">\n                    {/* Command line */}\n                    <div className=\"flex items-center gap-2 text-cyan-400\">\n                      <span className=\"text-green-400\">[admin@MikroTik]</span>\n                      <span className=\"text-white\">&gt;</span>\n                      <span>{result.command}</span>\n                    </div>\n                    \n                    {/* Output */}\n                    <div className=\"mt-1 pl-4 relative group\">\n                      {result.success ? (\n                        <pre className=\"text-green-300 whitespace-pre-wrap overflow-x-auto text-xs\">\n                          {formatOutput(result.output)}\n                        </pre>\n                      ) : (\n                        <div className=\"flex items-start gap-2 text-red-400\">\n                          <XCircle size={14} className=\"mt-0.5 flex-shrink-0\" />\n                          <span className=\"text-xs\">{result.error || \"Command failed\"}</span>\n                        </div>\n                      )}\n                      \n                      {/* Copy button */}\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        className=\"absolute top-0 right-0 opacity-0 group-hover:opacity-100 transition-opacity\"\n                        onClick={() => copyOutput(result.output || result.error)}\n                      >\n                        <Copy size={12} />\n                      </Button>\n                    </div>\n                    \n                    {/* Timestamp */}\n                    <div className=\"text-xs text-muted-foreground mt-1 pl-4\">\n                      {new Date(result.timestamp).toLocaleTimeString()}\n                    </div>\n                  </div>\n                ))\n              )}\n              \n              {executeMutation.isPending && (\n                <div className=\"flex items-center gap-2 text-yellow-400 animate-pulse\">\n                  <span className=\"text-green-400\">[admin@MikroTik]</span>\n                  <span className=\"text-white\">&gt;</span>\n                  <span>{command}</span>\n                  <span className=\"ml-2\">Executing...</span>\n                </div>\n              )}\n            </div>\n\n            {/* Command Input */}\n            <form onSubmit={handleExecute} className=\"flex items-center gap-2 p-3 border-t border-white/10 bg-black/30\">\n              <span className=\"text-green-400 font-mono text-sm\">[admin@MikroTik]</span>\n              <span className=\"text-white font-mono\">&gt;</span>\n              <Input\n                ref={inputRef}\n                value={command}\n                onChange={(e) => setCommand(e.target.value)}\n                placeholder={selectedRouter ? \"Enter RouterOS command...\" : \"Select a router first\"}\n                className=\"flex-1 bg-transparent border-none focus-visible:ring-0 font-mono text-sm text-white placeholder:text-muted-foreground\"\n                disabled={!selectedRouter || executeMutation.isPending}\n                data-testid=\"input-command\"\n              />\n              <Button\n                type=\"submit\"\n                size=\"sm\"\n                disabled={!selectedRouter || !command.trim() || executeMutation.isPending}\n                className=\"gradient-btn\"\n                data-testid=\"button-execute\"\n              >\n                <Send size={14} className=\"mr-1\" />\n                Execute\n              </Button>\n            </form>\n          </GlassPanel>\n\n          {/* Warning Banner */}\n          <div className=\"mt-3 flex items-start gap-2 p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/20\">\n            <AlertTriangle size={16} className=\"text-yellow-400 flex-shrink-0 mt-0.5\" />\n            <p className=\"text-xs text-yellow-200/80\">\n              Commands are executed directly on the router. Some dangerous commands are blocked for security.\n              Always verify commands before execution. Changes may affect network connectivity.\n            </p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":14572,"size_tokens":null},"client/src/pages/settings/backup-restore.tsx":{"content":"import { useState } from \"react\";\nimport { Database, Download, Upload, Clock, AlertTriangle } from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { Button } from \"@/components/ui/button\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function BackupRestorePage() {\n  const { toast } = useToast();\n  const [isBackingUp, setIsBackingUp] = useState(false);\n  const [isRestoring, setIsRestoring] = useState(false);\n\n  const handleBackup = async () => {\n    setIsBackingUp(true);\n    try {\n      toast({\n        title: \"Backup Started\",\n        description: \"Your database backup is being created...\",\n      });\n      await new Promise(resolve => setTimeout(resolve, 2000));\n      toast({\n        title: \"Backup Complete\",\n        description: \"Your database has been backed up successfully.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Backup Failed\",\n        description: \"Failed to create backup. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsBackingUp(false);\n    }\n  };\n\n  const handleRestore = async () => {\n    setIsRestoring(true);\n    try {\n      toast({\n        title: \"Restore Started\",\n        description: \"Your database is being restored...\",\n      });\n      await new Promise(resolve => setTimeout(resolve, 2000));\n      toast({\n        title: \"Restore Complete\",\n        description: \"Your database has been restored successfully.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Restore Failed\",\n        description: \"Failed to restore backup. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsRestoring(false);\n    }\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"settings-backup-restore-page\">\n      <div>\n        <h1 className=\"text-2xl font-bold text-white\">Backup & Restore</h1>\n        <p className=\"text-muted-foreground\">\n          Manage database backups and restore points\n        </p>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center gap-3 mb-6\">\n            <div className=\"p-2 rounded-lg bg-cyan-500/20\">\n              <Download size={20} className=\"text-cyan-400\" />\n            </div>\n            <div>\n              <h2 className=\"text-lg font-semibold text-white\">Create Backup</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Export your database to a backup file\n              </p>\n            </div>\n          </div>\n\n          <div className=\"space-y-4\">\n            <div className=\"p-4 rounded-xl bg-white/5 border border-white/10\">\n              <div className=\"flex items-center gap-2 text-muted-foreground text-sm mb-2\">\n                <Clock size={14} />\n                <span>Last backup: Never</span>\n              </div>\n              <p className=\"text-xs text-muted-foreground\">\n                Creating a backup will export all your data including users, plans, transactions, and settings.\n              </p>\n            </div>\n\n            <Button\n              className=\"w-full gradient-btn\"\n              onClick={handleBackup}\n              disabled={isBackingUp}\n              data-testid=\"button-create-backup\"\n            >\n              <Download size={18} className=\"mr-2\" />\n              {isBackingUp ? \"Creating Backup...\" : \"Create Backup\"}\n            </Button>\n          </div>\n        </GlassPanel>\n\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center gap-3 mb-6\">\n            <div className=\"p-2 rounded-lg bg-orange-500/20\">\n              <Upload size={20} className=\"text-orange-400\" />\n            </div>\n            <div>\n              <h2 className=\"text-lg font-semibold text-white\">Restore Backup</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Restore your database from a backup file\n              </p>\n            </div>\n          </div>\n\n          <div className=\"space-y-4\">\n            <div className=\"p-4 rounded-xl bg-orange-500/10 border border-orange-500/20\">\n              <div className=\"flex items-center gap-2 text-orange-400 text-sm mb-2\">\n                <AlertTriangle size={14} />\n                <span>Warning</span>\n              </div>\n              <p className=\"text-xs text-muted-foreground\">\n                Restoring a backup will replace all current data. This action cannot be undone.\n              </p>\n            </div>\n\n            <Button\n              variant=\"outline\"\n              className=\"w-full\"\n              onClick={handleRestore}\n              disabled={isRestoring}\n              data-testid=\"button-restore-backup\"\n            >\n              <Upload size={18} className=\"mr-2\" />\n              {isRestoring ? \"Restoring...\" : \"Select Backup File\"}\n            </Button>\n          </div>\n        </GlassPanel>\n      </div>\n\n      <GlassPanel size=\"md\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <div className=\"p-2 rounded-lg bg-purple-500/20\">\n            <Database size={20} className=\"text-purple-400\" />\n          </div>\n          <div>\n            <h2 className=\"text-lg font-semibold text-white\">Backup History</h2>\n            <p className=\"text-sm text-muted-foreground\">\n              View and manage previous backups\n            </p>\n          </div>\n        </div>\n\n        <div className=\"text-center py-8\">\n          <Database size={48} className=\"mx-auto mb-4 text-muted-foreground opacity-50\" />\n          <p className=\"text-muted-foreground\">No backups available yet</p>\n          <p className=\"text-xs text-muted-foreground mt-2\">\n            Create your first backup to see it listed here\n          </p>\n        </div>\n      </GlassPanel>\n    </div>\n  );\n}\n","path":null,"size_bytes":5786,"size_tokens":null},"client/src/pages/settings/hotspot-settings.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Wifi, Server, Shield, Save, Eye, EyeOff } from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Tenant } from \"@shared/schema\";\n\nexport default function HotspotSettingsPage() {\n  const { toast } = useToast();\n  const [showSecrets, setShowSecrets] = useState(false);\n\n  const { data: tenant, isLoading } = useQuery<Tenant>({\n    queryKey: [\"/api/tenant\"],\n  });\n\n  const [formData, setFormData] = useState({\n    radiusServer: \"\",\n    radiusSecret: \"\",\n    radiusPort: \"1812\",\n    radiusAcctPort: \"1813\",\n    nasIdentifier: \"\",\n    coaEnabled: false,\n    coaPort: \"3799\",\n  });\n\n  useEffect(() => {\n    if (tenant) {\n      const hotspotConfig = (tenant as any).hotspotConfig || {};\n      setFormData({\n        radiusServer: hotspotConfig.radiusServer || \"\",\n        radiusSecret: hotspotConfig.radiusSecret || \"\",\n        radiusPort: hotspotConfig.radiusPort || \"1812\",\n        radiusAcctPort: hotspotConfig.radiusAcctPort || \"1813\",\n        nasIdentifier: hotspotConfig.nasIdentifier || \"\",\n        coaEnabled: hotspotConfig.coaEnabled || false,\n        coaPort: hotspotConfig.coaPort || \"3799\",\n      });\n    }\n  }, [tenant]);\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      return apiRequest(\"PATCH\", \"/api/tenant\", {\n        hotspotConfig: data,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tenant\"] });\n      toast({\n        title: \"Settings Saved\",\n        description: \"Your hotspot settings have been updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save settings\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    saveMutation.mutate(formData);\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"settings-hotspot-page\">\n      <div>\n        <h1 className=\"text-2xl font-bold text-white\">Hotspot Settings</h1>\n        <p className=\"text-muted-foreground\">\n          Configure RADIUS server and NAS settings for your hotspots\n        </p>\n      </div>\n\n      <form onSubmit={handleSubmit} className=\"space-y-6\">\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center justify-between mb-6\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 rounded-lg bg-blue-500/20\">\n                <Server size={20} className=\"text-blue-400\" />\n              </div>\n              <div>\n                <h2 className=\"text-lg font-semibold text-white\">RADIUS Server Configuration</h2>\n                <p className=\"text-sm text-muted-foreground\">\n                  Configure your RADIUS server connection\n                </p>\n              </div>\n            </div>\n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => setShowSecrets(!showSecrets)}\n              data-testid=\"button-toggle-radius-secrets\"\n            >\n              {showSecrets ? (\n                <>\n                  <EyeOff size={16} className=\"mr-2\" />\n                  Hide\n                </>\n              ) : (\n                <>\n                  <Eye size={16} className=\"mr-2\" />\n                  Show\n                </>\n              )}\n            </Button>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            <GlassInput\n              label=\"RADIUS Server IP/Hostname\"\n              placeholder=\"radius.example.com or 192.168.1.100\"\n              value={formData.radiusServer}\n              onChange={(e) => setFormData({ ...formData, radiusServer: e.target.value })}\n              icon={<Server size={16} />}\n              data-testid=\"input-radius-server\"\n            />\n            <GlassInput\n              label=\"RADIUS Secret\"\n              type={showSecrets ? \"text\" : \"password\"}\n              placeholder=\"Your RADIUS shared secret\"\n              value={formData.radiusSecret}\n              onChange={(e) => setFormData({ ...formData, radiusSecret: e.target.value })}\n              icon={<Shield size={16} />}\n              data-testid=\"input-radius-secret\"\n            />\n            <GlassInput\n              label=\"Authentication Port\"\n              placeholder=\"1812\"\n              value={formData.radiusPort}\n              onChange={(e) => setFormData({ ...formData, radiusPort: e.target.value })}\n              data-testid=\"input-radius-port\"\n            />\n            <GlassInput\n              label=\"Accounting Port\"\n              placeholder=\"1813\"\n              value={formData.radiusAcctPort}\n              onChange={(e) => setFormData({ ...formData, radiusAcctPort: e.target.value })}\n              data-testid=\"input-radius-acct-port\"\n            />\n          </div>\n        </GlassPanel>\n\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center gap-3 mb-6\">\n            <div className=\"p-2 rounded-lg bg-cyan-500/20\">\n              <Wifi size={20} className=\"text-cyan-400\" />\n            </div>\n            <div>\n              <h2 className=\"text-lg font-semibold text-white\">NAS Configuration</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Network Access Server settings\n              </p>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            <GlassInput\n              label=\"NAS Identifier\"\n              placeholder=\"Your NAS identifier\"\n              value={formData.nasIdentifier}\n              onChange={(e) => setFormData({ ...formData, nasIdentifier: e.target.value })}\n              data-testid=\"input-nas-identifier\"\n            />\n\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between p-4 rounded-lg bg-white/5 border border-white/10\">\n                <div>\n                  <Label className=\"text-white\">Enable CoA (Change of Authorization)</Label>\n                  <p className=\"text-xs text-muted-foreground\">\n                    Allow dynamic session disconnection\n                  </p>\n                </div>\n                <Switch\n                  checked={formData.coaEnabled}\n                  onCheckedChange={(checked) => setFormData({ ...formData, coaEnabled: checked })}\n                  data-testid=\"switch-coa-enabled\"\n                />\n              </div>\n\n              {formData.coaEnabled && (\n                <GlassInput\n                  label=\"CoA Port\"\n                  placeholder=\"3799\"\n                  value={formData.coaPort}\n                  onChange={(e) => setFormData({ ...formData, coaPort: e.target.value })}\n                  data-testid=\"input-coa-port\"\n                />\n              )}\n            </div>\n          </div>\n\n          <div className=\"mt-4 p-4 rounded-xl bg-blue-500/10 border border-blue-500/20\">\n            <p className=\"text-sm text-muted-foreground\">\n              These settings apply to all hotspots by default. Individual hotspots can override these settings in the Hotspots management page.\n            </p>\n          </div>\n        </GlassPanel>\n\n        <div className=\"flex justify-end\">\n          <Button\n            type=\"submit\"\n            className=\"gradient-btn px-8\"\n            disabled={saveMutation.isPending}\n            data-testid=\"button-save-hotspot-settings\"\n          >\n            <Save size={18} className=\"mr-2\" />\n            {saveMutation.isPending ? \"Saving...\" : \"Save Hotspot Settings\"}\n          </Button>\n        </div>\n      </form>\n    </div>\n  );\n}\n","path":null,"size_bytes":8079,"size_tokens":null},"client/src/layouts/settings-layout.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { \n  Building2, \n  Wifi, \n  CreditCard, \n  Database, \n  Upload, \n  Trash2,\n  ChevronLeft\n} from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface SettingsLayoutProps {\n  children: React.ReactNode;\n}\n\nconst settingsMenuItems = [\n  {\n    title: \"Profile\",\n    href: \"/dashboard/settings/profile\",\n    icon: Building2,\n    description: \"Organization & branding\",\n  },\n  {\n    title: \"Hotspot Settings\",\n    href: \"/dashboard/settings/hotspot-settings\",\n    icon: Wifi,\n    description: \"NAS & RADIUS configuration\",\n  },\n  {\n    title: \"Payment Gateway\",\n    href: \"/dashboard/settings/payment-gateway\",\n    icon: CreditCard,\n    description: \"M-Pesa integration\",\n  },\n  {\n    title: \"Backup & Restore\",\n    href: \"/dashboard/settings/backup-restore\",\n    icon: Database,\n    description: \"Database management\",\n  },\n  {\n    title: \"MikroTik Import\",\n    href: \"/dashboard/settings/mikrotik-import\",\n    icon: Upload,\n    description: \"Import users from router\",\n  },\n  {\n    title: \"Clear Cache\",\n    href: \"/dashboard/settings/clear-cache\",\n    icon: Trash2,\n    description: \"Clear application cache\",\n  },\n];\n\nexport function SettingsLayout({ children }: SettingsLayoutProps) {\n  const [location] = useLocation();\n\n  return (\n    <div className=\"flex h-full\" data-testid=\"settings-layout\">\n      <aside className=\"w-64 border-r border-white/10 bg-background/30 backdrop-blur-sm flex-shrink-0\">\n        <div className=\"p-4 border-b border-white/10\">\n          <Link href=\"/dashboard\">\n            <Button variant=\"ghost\" size=\"sm\" className=\"gap-2 text-muted-foreground\" data-testid=\"button-back-dashboard\">\n              <ChevronLeft size={16} />\n              Back to Dashboard\n            </Button>\n          </Link>\n        </div>\n        <div className=\"p-4\">\n          <h2 className=\"text-lg font-semibold text-white mb-1\">Settings</h2>\n          <p className=\"text-sm text-muted-foreground\">Manage your configuration</p>\n        </div>\n        <nav className=\"px-2 pb-4\">\n          {settingsMenuItems.map((item) => {\n            const isActive = location === item.href;\n            return (\n              <Link key={item.href} href={item.href}>\n                <div\n                  className={cn(\n                    \"flex items-center gap-3 px-3 py-3 rounded-lg mb-1 transition-colors cursor-pointer\",\n                    isActive\n                      ? \"bg-cyan-500/20 text-cyan-400\"\n                      : \"text-muted-foreground hover:bg-white/5 hover:text-white\"\n                  )}\n                  data-testid={`settings-nav-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}\n                >\n                  <item.icon size={20} className={isActive ? \"text-cyan-400\" : \"\"} />\n                  <div className=\"flex-1 min-w-0\">\n                    <p className={cn(\"text-sm font-medium\", isActive && \"text-cyan-400\")}>\n                      {item.title}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground truncate\">\n                      {item.description}\n                    </p>\n                  </div>\n                </div>\n              </Link>\n            );\n          })}\n        </nav>\n      </aside>\n      <main className=\"flex-1 overflow-auto\">\n        {children}\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":3380,"size_tokens":null},"client/src/pages/settings/payment-gateway.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Key, Save, Eye, EyeOff, Shield, Phone, CreditCard, Building2, Smartphone, Crown, Lock } from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n} from \"@/components/ui/dialog\";\nimport {\n  InputOTP,\n  InputOTPGroup,\n  InputOTPSlot,\n} from \"@/components/ui/input-otp\";\nimport { cn } from \"@/lib/utils\";\nimport type { Tenant } from \"@shared/schema\";\n\ntype MpesaType = \"TILL\" | \"PAYBILL\";\n\nexport default function PaymentGatewayPage() {\n  const { toast } = useToast();\n  const [showSecrets, setShowSecrets] = useState(false);\n  const [isOtpDialogOpen, setIsOtpDialogOpen] = useState(false);\n  const [otpValue, setOtpValue] = useState(\"\");\n  const [phoneHint, setPhoneHint] = useState(\"\");\n  const [isVerified, setIsVerified] = useState(false);\n  const [verificationToken, setVerificationToken] = useState<string | null>(null);\n\n  const { data: tenant, isLoading } = useQuery<Tenant>({\n    queryKey: [\"/api/tenant\"],\n  });\n\n  const [formData, setFormData] = useState({\n    mpesaShortcode: \"\",\n    mpesaPasskey: \"\",\n    mpesaConsumerKey: \"\",\n    mpesaConsumerSecret: \"\",\n    mpesaType: \"PAYBILL\" as MpesaType,\n  });\n\n  useEffect(() => {\n    if (tenant) {\n      setFormData({\n        mpesaShortcode: tenant.mpesaShortcode || \"\",\n        mpesaPasskey: tenant.mpesaPasskey || \"\",\n        mpesaConsumerKey: tenant.mpesaConsumerKey || \"\",\n        mpesaConsumerSecret: tenant.mpesaConsumerSecret || \"\",\n        mpesaType: ((tenant as any).mpesaType as MpesaType) || \"PAYBILL\",\n      });\n    }\n  }, [tenant]);\n\n  const sendOtpMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/settings/otp/send\", {});\n    },\n    onSuccess: (data: any) => {\n      setPhoneHint(data.phoneHint || \"\");\n      setIsOtpDialogOpen(true);\n      toast({\n        title: \"OTP Sent\",\n        description: \"A verification code has been sent to your phone.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to send OTP\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const verifyOtpMutation = useMutation({\n    mutationFn: async (otp: string) => {\n      return apiRequest(\"POST\", \"/api/settings/otp/verify\", { otp });\n    },\n    onSuccess: (data: any) => {\n      setIsVerified(true);\n      setVerificationToken(data.token);\n      setIsOtpDialogOpen(false);\n      setOtpValue(\"\");\n      toast({\n        title: \"Verified\",\n        description: \"You can now edit payment settings.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Verification Failed\",\n        description: error.message || \"Invalid OTP\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      return apiRequest(\"PATCH\", \"/api/tenant\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tenant\"] });\n      toast({\n        title: \"Settings Saved\",\n        description: \"Your M-Pesa settings have been updated successfully.\",\n      });\n      setIsVerified(false);\n      setVerificationToken(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save settings\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleVerifyClick = () => {\n    sendOtpMutation.mutate();\n  };\n\n  const handleOtpComplete = (value: string) => {\n    if (value.length === 6) {\n      verifyOtpMutation.mutate(value);\n    }\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!isVerified) {\n      toast({\n        title: \"Verification Required\",\n        description: \"Please verify your identity before saving changes.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    saveMutation.mutate(formData);\n  };\n\n  const premiumPaymentOptions = [\n    {\n      name: \"Airtel Money\",\n      description: \"Accept payments via Airtel Money\",\n      icon: Smartphone,\n      color: \"text-red-400\",\n      bgColor: \"bg-red-500/20\",\n    },\n    {\n      name: \"PayPal\",\n      description: \"International payments via PayPal\",\n      icon: CreditCard,\n      color: \"text-blue-400\",\n      bgColor: \"bg-blue-500/20\",\n    },\n    {\n      name: \"Bank Transfer\",\n      description: \"Direct bank transfer payments\",\n      icon: Building2,\n      color: \"text-emerald-400\",\n      bgColor: \"bg-emerald-500/20\",\n    },\n  ];\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"settings-payment-gateway-page\">\n      <div>\n        <h1 className=\"text-2xl font-bold text-white\">Payment Gateway</h1>\n        <p className=\"text-muted-foreground\">\n          Configure M-Pesa and other payment integrations\n        </p>\n      </div>\n\n      <form onSubmit={handleSubmit} className=\"space-y-6\">\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center justify-between mb-6\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-2 rounded-lg bg-green-500/20\">\n                <Key size={20} className=\"text-green-400\" />\n              </div>\n              <div>\n                <h2 className=\"text-lg font-semibold text-white\">M-Pesa Integration</h2>\n                <p className=\"text-sm text-muted-foreground\">\n                  Safaricom Daraja API credentials\n                </p>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              {isVerified ? (\n                <Badge className=\"bg-emerald-500/20 text-emerald-400 border-0\">\n                  <Shield size={12} className=\"mr-1\" />\n                  Verified\n                </Badge>\n              ) : (\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={handleVerifyClick}\n                  disabled={sendOtpMutation.isPending}\n                  data-testid=\"button-verify-otp\"\n                >\n                  <Shield size={16} className=\"mr-2\" />\n                  {sendOtpMutation.isPending ? \"Sending...\" : \"Verify to Edit\"}\n                </Button>\n              )}\n              {isVerified && (\n                <Button\n                  type=\"button\"\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => setShowSecrets(!showSecrets)}\n                  data-testid=\"button-toggle-secrets\"\n                >\n                  {showSecrets ? (\n                    <>\n                      <EyeOff size={16} className=\"mr-2\" />\n                      Hide\n                    </>\n                  ) : (\n                    <>\n                      <Eye size={16} className=\"mr-2\" />\n                      Show\n                    </>\n                  )}\n                </Button>\n              )}\n            </div>\n          </div>\n\n          <div className=\"mb-6\">\n            <label className=\"text-sm font-medium uppercase tracking-wider text-muted-foreground block mb-3\">\n              Account Type\n            </label>\n            <div className=\"flex gap-3\">\n              <button\n                type=\"button\"\n                disabled={!isVerified}\n                onClick={() => setFormData({ ...formData, mpesaType: \"TILL\" })}\n                className={cn(\n                  \"flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-all\",\n                  formData.mpesaType === \"TILL\"\n                    ? \"bg-cyan-500/20 text-cyan-400 border border-cyan-500/30\"\n                    : \"bg-white/5 text-muted-foreground border border-white/10\",\n                  !isVerified && \"opacity-50 cursor-not-allowed\"\n                )}\n                data-testid=\"button-mpesa-till\"\n              >\n                Till Number\n              </button>\n              <button\n                type=\"button\"\n                disabled={!isVerified}\n                onClick={() => setFormData({ ...formData, mpesaType: \"PAYBILL\" })}\n                className={cn(\n                  \"flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-all\",\n                  formData.mpesaType === \"PAYBILL\"\n                    ? \"bg-cyan-500/20 text-cyan-400 border border-cyan-500/30\"\n                    : \"bg-white/5 text-muted-foreground border border-white/10\",\n                  !isVerified && \"opacity-50 cursor-not-allowed\"\n                )}\n                data-testid=\"button-mpesa-paybill\"\n              >\n                Paybill\n              </button>\n            </div>\n          </div>\n\n          <div className={cn(\"grid grid-cols-1 md:grid-cols-2 gap-6\", !isVerified && \"opacity-50 pointer-events-none\")}>\n            <GlassInput\n              label={formData.mpesaType === \"TILL\" ? \"Till Number\" : \"Business Shortcode\"}\n              placeholder={formData.mpesaType === \"TILL\" ? \"123456\" : \"174379\"}\n              value={formData.mpesaShortcode}\n              onChange={(e) => setFormData({ ...formData, mpesaShortcode: e.target.value })}\n              disabled={!isVerified}\n              data-testid=\"input-shortcode\"\n            />\n            <GlassInput\n              label=\"Passkey\"\n              type={showSecrets ? \"text\" : \"password\"}\n              placeholder=\"Your Passkey\"\n              value={formData.mpesaPasskey}\n              onChange={(e) => setFormData({ ...formData, mpesaPasskey: e.target.value })}\n              disabled={!isVerified}\n              data-testid=\"input-passkey\"\n            />\n            <GlassInput\n              label=\"Consumer Key\"\n              type={showSecrets ? \"text\" : \"password\"}\n              placeholder=\"Your Consumer Key\"\n              value={formData.mpesaConsumerKey}\n              onChange={(e) => setFormData({ ...formData, mpesaConsumerKey: e.target.value })}\n              disabled={!isVerified}\n              data-testid=\"input-consumer-key\"\n            />\n            <GlassInput\n              label=\"Consumer Secret\"\n              type={showSecrets ? \"text\" : \"password\"}\n              placeholder=\"Your Consumer Secret\"\n              value={formData.mpesaConsumerSecret}\n              onChange={(e) => setFormData({ ...formData, mpesaConsumerSecret: e.target.value })}\n              disabled={!isVerified}\n              data-testid=\"input-consumer-secret\"\n            />\n          </div>\n\n          <div className=\"mt-4 p-4 rounded-xl bg-purple-500/10 border border-purple-500/20\">\n            <p className=\"text-sm text-muted-foreground\">\n              Get your M-Pesa credentials from the{\" \"}\n              <a\n                href=\"https://developer.safaricom.co.ke/\"\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"text-cyan-400 hover:text-cyan-300\"\n              >\n                Safaricom Developer Portal\n              </a>\n              . Use sandbox credentials for testing.\n            </p>\n          </div>\n        </GlassPanel>\n\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center gap-3 mb-6\">\n            <div className=\"p-2 rounded-lg bg-purple-500/20\">\n              <Crown size={20} className=\"text-purple-400\" />\n            </div>\n            <div>\n              <h2 className=\"text-lg font-semibold text-white\">Premium Payment Options</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Upgrade to Premium to unlock additional payment methods\n              </p>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            {premiumPaymentOptions.map((option) => (\n              <div\n                key={option.name}\n                className=\"relative p-4 rounded-xl bg-white/5 border border-white/10 opacity-50 pointer-events-none\"\n                data-testid={`premium-option-${option.name.toLowerCase().replace(/\\s+/g, \"-\")}`}\n              >\n                <Badge\n                  className=\"absolute top-2 right-2 bg-purple-500/20 text-purple-400 border-0\"\n                >\n                  <Lock size={10} className=\"mr-1\" />\n                  Premium\n                </Badge>\n                <div className={cn(\"p-2 rounded-lg w-fit mb-3\", option.bgColor)}>\n                  <option.icon size={20} className={option.color} />\n                </div>\n                <h3 className=\"font-medium text-white mb-1\">{option.name}</h3>\n                <p className=\"text-xs text-muted-foreground\">{option.description}</p>\n              </div>\n            ))}\n          </div>\n        </GlassPanel>\n\n        <div className=\"flex justify-end\">\n          <Button\n            type=\"submit\"\n            className=\"gradient-btn px-8\"\n            disabled={saveMutation.isPending || !isVerified}\n            data-testid=\"button-save-payment\"\n          >\n            <Save size={18} className=\"mr-2\" />\n            {saveMutation.isPending ? \"Saving...\" : \"Save Payment Settings\"}\n          </Button>\n        </div>\n      </form>\n\n      <Dialog open={isOtpDialogOpen} onOpenChange={setIsOtpDialogOpen}>\n        <DialogContent className=\"glass-panel border-white/10 max-w-sm\">\n          <DialogHeader>\n            <DialogTitle className=\"text-xl font-bold text-white flex items-center gap-2\">\n              <Shield size={20} className=\"text-cyan-400\" />\n              Verify Your Identity\n            </DialogTitle>\n            <DialogDescription className=\"text-muted-foreground\">\n              Enter the 6-digit code sent to {phoneHint || \"your phone\"}\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"flex flex-col items-center gap-6 py-4\">\n            <InputOTP\n              maxLength={6}\n              value={otpValue}\n              onChange={(value) => {\n                setOtpValue(value);\n                if (value.length === 6) {\n                  handleOtpComplete(value);\n                }\n              }}\n              data-testid=\"input-otp\"\n            >\n              <InputOTPGroup>\n                <InputOTPSlot index={0} />\n                <InputOTPSlot index={1} />\n                <InputOTPSlot index={2} />\n                <InputOTPSlot index={3} />\n                <InputOTPSlot index={4} />\n                <InputOTPSlot index={5} />\n              </InputOTPGroup>\n            </InputOTP>\n\n            <div className=\"flex flex-col gap-2 w-full\">\n              <Button\n                onClick={() => verifyOtpMutation.mutate(otpValue)}\n                disabled={otpValue.length !== 6 || verifyOtpMutation.isPending}\n                className=\"w-full gradient-btn\"\n                data-testid=\"button-confirm-otp\"\n              >\n                {verifyOtpMutation.isPending ? \"Verifying...\" : \"Verify Code\"}\n              </Button>\n              <Button\n                variant=\"ghost\"\n                onClick={() => sendOtpMutation.mutate()}\n                disabled={sendOtpMutation.isPending}\n                className=\"w-full\"\n                data-testid=\"button-resend-otp\"\n              >\n                <Phone size={16} className=\"mr-2\" />\n                {sendOtpMutation.isPending ? \"Sending...\" : \"Resend Code\"}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":15657,"size_tokens":null},"client/src/pages/settings/profile.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { motion } from \"framer-motion\";\nimport { Building2, Palette, Save, Upload, Wifi, Globe, Mail, Phone } from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { Tenant } from \"@shared/schema\";\n\nconst defaultColors = {\n  cyan: \"#22d3ee\",\n  purple: \"#a855f7\",\n  green: \"#22c55e\",\n  blue: \"#3b82f6\",\n  orange: \"#f97316\",\n  pink: \"#ec4899\",\n};\n\nexport default function ProfileSettingsPage() {\n  const { toast } = useToast();\n\n  const { data: tenant, isLoading } = useQuery<Tenant>({\n    queryKey: [\"/api/tenant\"],\n  });\n\n  const [formData, setFormData] = useState({\n    name: \"\",\n    subdomain: \"\",\n    website: \"\",\n    email: \"\",\n    phone: \"\",\n  });\n\n  const [brandingData, setBrandingData] = useState({\n    logo: \"\",\n    primaryColor: \"#22d3ee\",\n    secondaryColor: \"#a855f7\",\n  });\n\n  useEffect(() => {\n    if (tenant) {\n      setFormData({\n        name: tenant.name || \"\",\n        subdomain: tenant.subdomain || \"\",\n        website: tenant.website || \"\",\n        email: tenant.email || \"\",\n        phone: tenant.phone || \"\",\n      });\n      const branding = tenant.brandingConfig || {};\n      setBrandingData({\n        logo: branding.logo || \"\",\n        primaryColor: branding.primaryColor || \"#22d3ee\",\n        secondaryColor: branding.secondaryColor || \"#a855f7\",\n      });\n    }\n  }, [tenant]);\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: { formData: typeof formData; brandingData: typeof brandingData }) => {\n      return apiRequest(\"PATCH\", \"/api/tenant\", {\n        ...data.formData,\n        brandingConfig: data.brandingData,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tenant\"] });\n      toast({\n        title: \"Settings Saved\",\n        description: \"Your profile settings have been updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save settings\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    saveMutation.mutate({ formData, brandingData });\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"settings-profile-page\">\n      <div>\n        <h1 className=\"text-2xl font-bold text-white\">Profile Settings</h1>\n        <p className=\"text-muted-foreground\">\n          Configure your organization details and branding\n        </p>\n      </div>\n\n      <form onSubmit={handleSubmit} className=\"space-y-6\">\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center gap-3 mb-6\">\n            <div className=\"p-2 rounded-lg bg-cyan-500/20\">\n              <Building2 size={20} className=\"text-cyan-400\" />\n            </div>\n            <div>\n              <h2 className=\"text-lg font-semibold text-white\">Organization</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Basic information about your organization\n              </p>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            <GlassInput\n              label=\"Organization Name\"\n              placeholder=\"Your Company Name\"\n              value={formData.name}\n              onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n              data-testid=\"input-org-name\"\n            />\n            <div className=\"space-y-2\">\n              <GlassInput\n                label=\"Subdomain\"\n                placeholder=\"yourcompany\"\n                value={formData.subdomain}\n                onChange={(e) => setFormData({ ...formData, subdomain: e.target.value })}\n                data-testid=\"input-subdomain\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Your portal will be: <span className=\"text-cyan-400\">{formData.subdomain || 'yourcompany'}.mnetifi.com</span>\n              </p>\n            </div>\n            <GlassInput\n              label=\"Website\"\n              placeholder=\"https://www.yourcompany.com\"\n              value={formData.website}\n              onChange={(e) => setFormData({ ...formData, website: e.target.value })}\n              icon={<Globe size={16} />}\n              data-testid=\"input-website\"\n            />\n            <GlassInput\n              label=\"Email Address\"\n              placeholder=\"info@yourcompany.com\"\n              value={formData.email}\n              onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n              icon={<Mail size={16} />}\n              data-testid=\"input-email\"\n            />\n            <GlassInput\n              label=\"Phone Number\"\n              placeholder=\"+254 700 123 456\"\n              value={formData.phone}\n              onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n              icon={<Phone size={16} />}\n              data-testid=\"input-phone\"\n            />\n          </div>\n        </GlassPanel>\n\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center gap-3 mb-6\">\n            <div className=\"p-2 rounded-lg bg-purple-500/20\">\n              <Palette size={20} className=\"text-purple-400\" />\n            </div>\n            <div>\n              <h2 className=\"text-lg font-semibold text-white\">Branding & Customization</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Customize how your captive portal appears to customers\n              </p>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            <div className=\"space-y-2\">\n              <Label className=\"text-muted-foreground\">Logo URL</Label>\n              <GlassInput\n                placeholder=\"https://example.com/logo.png\"\n                value={brandingData.logo}\n                onChange={(e) => setBrandingData({ ...brandingData, logo: e.target.value })}\n                icon={<Upload size={16} />}\n                data-testid=\"input-logo-url\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Enter a URL to your logo image (recommended: 200x60px PNG)\n              </p>\n            </div>\n\n            <div className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label className=\"text-muted-foreground\">Primary Color</Label>\n                <div className=\"flex items-center gap-3\">\n                  <input\n                    type=\"color\"\n                    value={brandingData.primaryColor}\n                    onChange={(e) => setBrandingData({ ...brandingData, primaryColor: e.target.value })}\n                    className=\"w-12 h-9 rounded-md border border-white/10 bg-transparent cursor-pointer\"\n                    data-testid=\"input-primary-color\"\n                  />\n                  <div className=\"flex gap-2\">\n                    {Object.entries(defaultColors).map(([name, color]) => (\n                      <button\n                        key={name}\n                        type=\"button\"\n                        onClick={() => setBrandingData({ ...brandingData, primaryColor: color })}\n                        className=\"w-6 h-6 rounded-full border-2 border-white/20 transition-transform hover:scale-110\"\n                        style={{ backgroundColor: color }}\n                        title={name}\n                        data-testid={`color-preset-${name}`}\n                      />\n                    ))}\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label className=\"text-muted-foreground\">Secondary Color</Label>\n                <div className=\"flex items-center gap-3\">\n                  <input\n                    type=\"color\"\n                    value={brandingData.secondaryColor}\n                    onChange={(e) => setBrandingData({ ...brandingData, secondaryColor: e.target.value })}\n                    className=\"w-12 h-9 rounded-md border border-white/10 bg-transparent cursor-pointer\"\n                    data-testid=\"input-secondary-color\"\n                  />\n                  <div className=\"flex gap-2\">\n                    {Object.entries(defaultColors).map(([name, color]) => (\n                      <button\n                        key={name}\n                        type=\"button\"\n                        onClick={() => setBrandingData({ ...brandingData, secondaryColor: color })}\n                        className=\"w-6 h-6 rounded-full border-2 border-white/20 transition-transform hover:scale-110\"\n                        style={{ backgroundColor: color }}\n                        title={name}\n                        data-testid={`color-secondary-preset-${name}`}\n                      />\n                    ))}\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"mt-6 p-6 rounded-xl bg-mesh-navy/50 border border-white/5\">\n            <p className=\"text-xs text-muted-foreground mb-4 text-center\">Captive Portal Preview</p>\n            <motion.div\n              className=\"text-center\"\n              initial={{ opacity: 0, scale: 0.95 }}\n              animate={{ opacity: 1, scale: 1 }}\n            >\n              {brandingData.logo ? (\n                <img\n                  src={brandingData.logo}\n                  alt=\"Logo\"\n                  className=\"h-12 mx-auto mb-4 object-contain\"\n                  onError={(e) => {\n                    e.currentTarget.style.display = 'none';\n                  }}\n                />\n              ) : (\n                <div className=\"flex items-center justify-center gap-2 mb-4\">\n                  <div\n                    className=\"w-10 h-10 rounded-xl flex items-center justify-center\"\n                    style={{ backgroundColor: `${brandingData.primaryColor}20` }}\n                  >\n                    <Wifi size={24} style={{ color: brandingData.primaryColor }} />\n                  </div>\n                  <span\n                    className=\"text-2xl font-bold\"\n                    style={{\n                      background: `linear-gradient(135deg, ${brandingData.primaryColor}, ${brandingData.secondaryColor})`,\n                      WebkitBackgroundClip: 'text',\n                      WebkitTextFillColor: 'transparent',\n                    }}\n                  >\n                    {formData.name || \"Your ISP\"}\n                  </span>\n                </div>\n              )}\n              <p className=\"text-muted-foreground text-sm\">\n                Connect to {formData.name || \"Your Organization\"} Wi-Fi\n              </p>\n              <button\n                type=\"button\"\n                className=\"mt-4 px-6 py-2 rounded-xl text-white font-medium transition-all\"\n                style={{\n                  background: `linear-gradient(135deg, ${brandingData.primaryColor}, ${brandingData.secondaryColor})`,\n                }}\n              >\n                Select Plan\n              </button>\n            </motion.div>\n          </div>\n        </GlassPanel>\n\n        <div className=\"flex justify-end\">\n          <Button\n            type=\"submit\"\n            className=\"gradient-btn px-8\"\n            disabled={saveMutation.isPending}\n            data-testid=\"button-save-profile\"\n          >\n            <Save size={18} className=\"mr-2\" />\n            {saveMutation.isPending ? \"Saving...\" : \"Save Profile\"}\n          </Button>\n        </div>\n      </form>\n    </div>\n  );\n}\n","path":null,"size_bytes":11844,"size_tokens":null},"client/src/pages/settings/mikrotik-import.tsx":{"content":"import { useState } from \"react\";\nimport { Upload, Server, Users, FileText, CheckCircle } from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function MikroTikImportPage() {\n  const { toast } = useToast();\n  const [isConnecting, setIsConnecting] = useState(false);\n  const [isImporting, setIsImporting] = useState(false);\n\n  const [formData, setFormData] = useState({\n    routerIp: \"\",\n    username: \"\",\n    password: \"\",\n    port: \"8728\",\n  });\n\n  const handleConnect = async () => {\n    if (!formData.routerIp || !formData.username || !formData.password) {\n      toast({\n        title: \"Missing Information\",\n        description: \"Please fill in all router connection details.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsConnecting(true);\n    try {\n      await new Promise(resolve => setTimeout(resolve, 2000));\n      toast({\n        title: \"Connection Successful\",\n        description: \"Successfully connected to MikroTik router.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Connection Failed\",\n        description: \"Failed to connect to router. Please check your credentials.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsConnecting(false);\n    }\n  };\n\n  const handleImport = async () => {\n    setIsImporting(true);\n    try {\n      await new Promise(resolve => setTimeout(resolve, 3000));\n      toast({\n        title: \"Import Complete\",\n        description: \"Users have been imported from your MikroTik router.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Import Failed\",\n        description: \"Failed to import users. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsImporting(false);\n    }\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"settings-mikrotik-import-page\">\n      <div>\n        <h1 className=\"text-2xl font-bold text-white\">MikroTik Import</h1>\n        <p className=\"text-muted-foreground\">\n          Import users and settings from your MikroTik router\n        </p>\n      </div>\n\n      <GlassPanel size=\"md\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <div className=\"p-2 rounded-lg bg-blue-500/20\">\n            <Server size={20} className=\"text-blue-400\" />\n          </div>\n          <div>\n            <h2 className=\"text-lg font-semibold text-white\">Router Connection</h2>\n            <p className=\"text-sm text-muted-foreground\">\n              Connect to your MikroTik router via API\n            </p>\n          </div>\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n          <GlassInput\n            label=\"Router IP Address\"\n            placeholder=\"192.168.88.1\"\n            value={formData.routerIp}\n            onChange={(e) => setFormData({ ...formData, routerIp: e.target.value })}\n            icon={<Server size={16} />}\n            data-testid=\"input-router-ip\"\n          />\n          <GlassInput\n            label=\"API Port\"\n            placeholder=\"8728\"\n            value={formData.port}\n            onChange={(e) => setFormData({ ...formData, port: e.target.value })}\n            data-testid=\"input-router-port\"\n          />\n          <GlassInput\n            label=\"Username\"\n            placeholder=\"admin\"\n            value={formData.username}\n            onChange={(e) => setFormData({ ...formData, username: e.target.value })}\n            data-testid=\"input-router-username\"\n          />\n          <GlassInput\n            label=\"Password\"\n            type=\"password\"\n            placeholder=\"Router password\"\n            value={formData.password}\n            onChange={(e) => setFormData({ ...formData, password: e.target.value })}\n            data-testid=\"input-router-password\"\n          />\n        </div>\n\n        <div className=\"mt-6 flex gap-4\">\n          <Button\n            onClick={handleConnect}\n            disabled={isConnecting}\n            className=\"gradient-btn\"\n            data-testid=\"button-connect-router\"\n          >\n            <Server size={18} className=\"mr-2\" />\n            {isConnecting ? \"Connecting...\" : \"Connect to Router\"}\n          </Button>\n        </div>\n      </GlassPanel>\n\n      <GlassPanel size=\"md\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <div className=\"p-2 rounded-lg bg-cyan-500/20\">\n            <Upload size={20} className=\"text-cyan-400\" />\n          </div>\n          <div>\n            <h2 className=\"text-lg font-semibold text-white\">Import Options</h2>\n            <p className=\"text-sm text-muted-foreground\">\n              Select what to import from your router\n            </p>\n          </div>\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <div className=\"p-4 rounded-xl bg-white/5 border border-white/10 text-center\">\n            <Users size={32} className=\"mx-auto mb-3 text-cyan-400\" />\n            <h3 className=\"font-medium text-white mb-1\">Hotspot Users</h3>\n            <p className=\"text-xs text-muted-foreground\">\n              Import all hotspot users\n            </p>\n          </div>\n          <div className=\"p-4 rounded-xl bg-white/5 border border-white/10 text-center\">\n            <FileText size={32} className=\"mx-auto mb-3 text-purple-400\" />\n            <h3 className=\"font-medium text-white mb-1\">User Profiles</h3>\n            <p className=\"text-xs text-muted-foreground\">\n              Import user profiles/plans\n            </p>\n          </div>\n          <div className=\"p-4 rounded-xl bg-white/5 border border-white/10 text-center\">\n            <CheckCircle size={32} className=\"mx-auto mb-3 text-green-400\" />\n            <h3 className=\"font-medium text-white mb-1\">Active Sessions</h3>\n            <p className=\"text-xs text-muted-foreground\">\n              Import active sessions\n            </p>\n          </div>\n        </div>\n\n        <div className=\"mt-6\">\n          <Button\n            onClick={handleImport}\n            disabled={isImporting}\n            variant=\"outline\"\n            className=\"w-full\"\n            data-testid=\"button-import-users\"\n          >\n            <Upload size={18} className=\"mr-2\" />\n            {isImporting ? \"Importing Users...\" : \"Start Import\"}\n          </Button>\n        </div>\n\n        <div className=\"mt-4 p-4 rounded-xl bg-blue-500/10 border border-blue-500/20\">\n          <p className=\"text-sm text-muted-foreground\">\n            Make sure your MikroTik router has the API service enabled and that you have admin access. \n            The import process will not affect your router configuration.\n          </p>\n        </div>\n      </GlassPanel>\n    </div>\n  );\n}\n","path":null,"size_bytes":6789,"size_tokens":null},"client/src/pages/portal-designer.tsx":{"content":"import { useState, useEffect, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Palette, \n  Image, \n  Type, \n  Phone, \n  Mail, \n  Save, \n  Eye, \n  Sparkles,\n  Wifi,\n  Check,\n  ArrowLeft,\n  Upload,\n  Monitor,\n  Smartphone,\n  MessageSquare\n} from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput, GlassTextarea } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Link } from \"wouter\";\nimport type { Tenant, Plan } from \"@shared/schema\";\n\ninterface BrandingConfig {\n  logo?: string;\n  primaryColor?: string;\n  secondaryColor?: string;\n  tagline?: string;\n  welcomeMessage?: string;\n  supportEmail?: string;\n  supportPhone?: string;\n  footerText?: string;\n  showPoweredBy?: boolean;\n  cardStyle?: 'glass' | 'solid' | 'gradient';\n  animationsEnabled?: boolean;\n  backgroundGradient?: string;\n}\n\nconst defaultColors = {\n  cyan: \"#22d3ee\",\n  purple: \"#a855f7\",\n  green: \"#22c55e\",\n  blue: \"#3b82f6\",\n  orange: \"#f97316\",\n  pink: \"#ec4899\",\n};\n\nconst gradientPresets = [\n  { name: \"Ocean\", value: \"linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #0f172a 100%)\" },\n  { name: \"Midnight\", value: \"linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%)\" },\n  { name: \"Sunset\", value: \"linear-gradient(135deg, #1a0a1e 0%, #2d1b3d 50%, #1a1a2e 100%)\" },\n  { name: \"Forest\", value: \"linear-gradient(135deg, #0a1a14 0%, #1a2e22 50%, #0f1a14 100%)\" },\n];\n\nexport default function PortalDesignerPage() {\n  const { toast } = useToast();\n  const [previewDevice, setPreviewDevice] = useState<'desktop' | 'mobile'>('mobile');\n  \n  const { data: tenant, isLoading } = useQuery<Tenant>({\n    queryKey: [\"/api/tenant\"],\n  });\n\n  const { data: plans } = useQuery<Plan[]>({\n    queryKey: [\"/api/plans?type=HOTSPOT\"],\n  });\n\n  const [branding, setBranding] = useState<BrandingConfig>({\n    logo: \"\",\n    primaryColor: \"#22d3ee\",\n    secondaryColor: \"#a855f7\",\n    tagline: \"\",\n    welcomeMessage: \"Connect to Wi-Fi\",\n    supportEmail: \"\",\n    supportPhone: \"\",\n    footerText: \"\",\n    showPoweredBy: true,\n    cardStyle: \"glass\",\n    animationsEnabled: true,\n    backgroundGradient: gradientPresets[0].value,\n  });\n\n  useEffect(() => {\n    if (tenant?.brandingConfig) {\n      const config = tenant.brandingConfig;\n      setBranding({\n        logo: config.logo || \"\",\n        primaryColor: config.primaryColor || \"#22d3ee\",\n        secondaryColor: config.secondaryColor || \"#a855f7\",\n        tagline: config.tagline || \"\",\n        welcomeMessage: config.welcomeMessage || \"Connect to Wi-Fi\",\n        supportEmail: config.supportEmail || \"\",\n        supportPhone: config.supportPhone || \"\",\n        footerText: config.footerText || \"\",\n        showPoweredBy: config.showPoweredBy ?? true,\n        cardStyle: config.cardStyle || \"glass\",\n        animationsEnabled: config.animationsEnabled ?? true,\n        backgroundGradient: config.backgroundGradient || gradientPresets[0].value,\n      });\n    }\n  }, [tenant]);\n\n  const saveMutation = useMutation({\n    mutationFn: async (brandingConfig: BrandingConfig) => {\n      return apiRequest(\"PATCH\", \"/api/tenant\", { brandingConfig });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tenant\"] });\n      toast({\n        title: \"Design Saved\",\n        description: \"Your captive portal design has been published successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to save design\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSave = () => {\n    saveMutation.mutate(branding);\n  };\n\n  const gradientStyle = useMemo(() => ({\n    background: `linear-gradient(135deg, ${branding.primaryColor}, ${branding.secondaryColor})`,\n  }), [branding.primaryColor, branding.secondaryColor]);\n\n  const samplePlans = plans?.filter(p => p.isActive).slice(0, 3) || [\n    { id: \"1\", name: \"1 Hour\", price: 20, durationSeconds: 3600 },\n    { id: \"2\", name: \"Daily\", price: 50, durationSeconds: 86400 },\n    { id: \"3\", name: \"Weekly\", price: 300, durationSeconds: 604800 },\n  ];\n\n  const formatPrice = (amount: number) => {\n    return new Intl.NumberFormat(\"en-KE\", {\n      style: \"currency\",\n      currency: \"KES\",\n      minimumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  const formatDuration = (seconds: number): string => {\n    if (seconds < 3600) return `${Math.floor(seconds / 60)} min`;\n    if (seconds < 86400) return `${Math.floor(seconds / 3600)} hrs`;\n    return `${Math.floor(seconds / 86400)} days`;\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-screen\">\n        <div className=\"animate-spin w-8 h-8 border-2 border-primary border-t-transparent rounded-full\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"portal-designer-page\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div className=\"flex items-center gap-4\">\n          <Link href=\"/dashboard/hotspot-plans\">\n            <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-back-to-plans\">\n              <ArrowLeft size={20} />\n            </Button>\n          </Link>\n          <div>\n            <h1 className=\"text-2xl font-bold text-white\">Portal Designer</h1>\n            <p className=\"text-muted-foreground\">\n              Design your captive portal with live preview\n            </p>\n          </div>\n        </div>\n        <div className=\"flex items-center gap-3\">\n          <div className=\"flex items-center gap-1 p-1 rounded-lg bg-white/5 border border-white/10\">\n            <Button\n              variant={previewDevice === 'mobile' ? 'secondary' : 'ghost'}\n              size=\"sm\"\n              onClick={() => setPreviewDevice('mobile')}\n              data-testid=\"button-preview-mobile\"\n            >\n              <Smartphone size={16} />\n            </Button>\n            <Button\n              variant={previewDevice === 'desktop' ? 'secondary' : 'ghost'}\n              size=\"sm\"\n              onClick={() => setPreviewDevice('desktop')}\n              data-testid=\"button-preview-desktop\"\n            >\n              <Monitor size={16} />\n            </Button>\n          </div>\n          <Button\n            onClick={handleSave}\n            disabled={saveMutation.isPending}\n            className=\"gap-2\"\n            style={gradientStyle}\n            data-testid=\"button-publish-design\"\n          >\n            <Save size={18} />\n            {saveMutation.isPending ? \"Publishing...\" : \"Publish Design\"}\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <div className=\"space-y-6\">\n          <Tabs defaultValue=\"branding\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-4 bg-white/5\">\n              <TabsTrigger value=\"branding\" className=\"gap-2 text-xs sm:text-sm\" data-testid=\"tab-branding\">\n                <Palette size={14} />\n                <span className=\"hidden sm:inline\">Brand</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"content\" className=\"gap-2 text-xs sm:text-sm\" data-testid=\"tab-content\">\n                <Type size={14} />\n                <span className=\"hidden sm:inline\">Content</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"contact\" className=\"gap-2 text-xs sm:text-sm\" data-testid=\"tab-contact\">\n                <Phone size={14} />\n                <span className=\"hidden sm:inline\">Contact</span>\n              </TabsTrigger>\n              <TabsTrigger value=\"style\" className=\"gap-2 text-xs sm:text-sm\" data-testid=\"tab-style\">\n                <Sparkles size={14} />\n                <span className=\"hidden sm:inline\">Style</span>\n              </TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"branding\" className=\"mt-4\">\n              <GlassPanel size=\"md\" className=\"space-y-6\">\n                <div className=\"flex items-center gap-3 mb-4\">\n                  <div className=\"p-2 rounded-lg bg-cyan-500/20\">\n                    <Image size={18} className=\"text-cyan-400\" />\n                  </div>\n                  <div>\n                    <h3 className=\"font-semibold text-white\">Logo & Colors</h3>\n                    <p className=\"text-sm text-muted-foreground\">Upload your logo and set brand colors</p>\n                  </div>\n                </div>\n\n                <div className=\"space-y-4\">\n                  <div className=\"space-y-2\">\n                    <Label className=\"text-muted-foreground\">Logo URL</Label>\n                    <GlassInput\n                      placeholder=\"https://yoursite.com/logo.png\"\n                      value={branding.logo}\n                      onChange={(e) => setBranding({ ...branding, logo: e.target.value })}\n                      icon={<Upload size={16} />}\n                      data-testid=\"input-logo-url\"\n                    />\n                    <p className=\"text-xs text-muted-foreground\">\n                      Recommended: 200x60px transparent PNG\n                    </p>\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label className=\"text-muted-foreground\">Primary Color</Label>\n                      <div className=\"flex items-center gap-2\">\n                        <input\n                          type=\"color\"\n                          value={branding.primaryColor}\n                          onChange={(e) => setBranding({ ...branding, primaryColor: e.target.value })}\n                          className=\"w-10 h-10 rounded-lg border border-white/10 bg-transparent cursor-pointer\"\n                          data-testid=\"input-primary-color\"\n                        />\n                        <div className=\"flex gap-1 flex-wrap\">\n                          {Object.entries(defaultColors).slice(0, 3).map(([name, color]) => (\n                            <button\n                              key={name}\n                              type=\"button\"\n                              onClick={() => setBranding({ ...branding, primaryColor: color })}\n                              className=\"w-6 h-6 rounded-full border-2 border-white/20 transition-transform hover:scale-110\"\n                              style={{ backgroundColor: color }}\n                              title={name}\n                              data-testid={`color-primary-${name}`}\n                            />\n                          ))}\n                        </div>\n                      </div>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label className=\"text-muted-foreground\">Secondary Color</Label>\n                      <div className=\"flex items-center gap-2\">\n                        <input\n                          type=\"color\"\n                          value={branding.secondaryColor}\n                          onChange={(e) => setBranding({ ...branding, secondaryColor: e.target.value })}\n                          className=\"w-10 h-10 rounded-lg border border-white/10 bg-transparent cursor-pointer\"\n                          data-testid=\"input-secondary-color\"\n                        />\n                        <div className=\"flex gap-1 flex-wrap\">\n                          {Object.entries(defaultColors).slice(3).map(([name, color]) => (\n                            <button\n                              key={name}\n                              type=\"button\"\n                              onClick={() => setBranding({ ...branding, secondaryColor: color })}\n                              className=\"w-6 h-6 rounded-full border-2 border-white/20 transition-transform hover:scale-110\"\n                              style={{ backgroundColor: color }}\n                              title={name}\n                              data-testid={`color-secondary-${name}`}\n                            />\n                          ))}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </GlassPanel>\n            </TabsContent>\n\n            <TabsContent value=\"content\" className=\"mt-4\">\n              <GlassPanel size=\"md\" className=\"space-y-6\">\n                <div className=\"flex items-center gap-3 mb-4\">\n                  <div className=\"p-2 rounded-lg bg-purple-500/20\">\n                    <Type size={18} className=\"text-purple-400\" />\n                  </div>\n                  <div>\n                    <h3 className=\"font-semibold text-white\">Text Content</h3>\n                    <p className=\"text-sm text-muted-foreground\">Customize your portal messages</p>\n                  </div>\n                </div>\n\n                <div className=\"space-y-4\">\n                  <GlassInput\n                    label=\"Tagline\"\n                    placeholder=\"Fast & Reliable WiFi\"\n                    value={branding.tagline}\n                    onChange={(e) => setBranding({ ...branding, tagline: e.target.value })}\n                    data-testid=\"input-tagline\"\n                  />\n\n                  <GlassInput\n                    label=\"Welcome Message\"\n                    placeholder=\"Connect to Wi-Fi\"\n                    value={branding.welcomeMessage}\n                    onChange={(e) => setBranding({ ...branding, welcomeMessage: e.target.value })}\n                    data-testid=\"input-welcome-message\"\n                  />\n\n                  <GlassTextarea\n                    label=\"Footer Text\"\n                    placeholder=\"Thank you for choosing our WiFi service...\"\n                    value={branding.footerText}\n                    onChange={(e) => setBranding({ ...branding, footerText: e.target.value })}\n                    data-testid=\"input-footer-text\"\n                  />\n                </div>\n              </GlassPanel>\n            </TabsContent>\n\n            <TabsContent value=\"contact\" className=\"mt-4\">\n              <GlassPanel size=\"md\" className=\"space-y-6\">\n                <div className=\"flex items-center gap-3 mb-4\">\n                  <div className=\"p-2 rounded-lg bg-green-500/20\">\n                    <MessageSquare size={18} className=\"text-green-400\" />\n                  </div>\n                  <div>\n                    <h3 className=\"font-semibold text-white\">Support Contact</h3>\n                    <p className=\"text-sm text-muted-foreground\">Display contact info for customer support</p>\n                  </div>\n                </div>\n\n                <div className=\"space-y-4\">\n                  <GlassInput\n                    label=\"Support Email\"\n                    placeholder=\"support@yourcompany.com\"\n                    value={branding.supportEmail}\n                    onChange={(e) => setBranding({ ...branding, supportEmail: e.target.value })}\n                    icon={<Mail size={16} />}\n                    data-testid=\"input-support-email\"\n                  />\n\n                  <GlassInput\n                    label=\"Support Phone\"\n                    placeholder=\"+254 700 123 456\"\n                    value={branding.supportPhone}\n                    onChange={(e) => setBranding({ ...branding, supportPhone: e.target.value })}\n                    icon={<Phone size={16} />}\n                    data-testid=\"input-support-phone\"\n                  />\n                </div>\n              </GlassPanel>\n            </TabsContent>\n\n            <TabsContent value=\"style\" className=\"mt-4\">\n              <GlassPanel size=\"md\" className=\"space-y-6\">\n                <div className=\"flex items-center gap-3 mb-4\">\n                  <div className=\"p-2 rounded-lg bg-orange-500/20\">\n                    <Sparkles size={18} className=\"text-orange-400\" />\n                  </div>\n                  <div>\n                    <h3 className=\"font-semibold text-white\">Visual Style</h3>\n                    <p className=\"text-sm text-muted-foreground\">Configure animations and effects</p>\n                  </div>\n                </div>\n\n                <div className=\"space-y-6\">\n                  <div className=\"space-y-3\">\n                    <Label className=\"text-muted-foreground\">Card Style</Label>\n                    <div className=\"grid grid-cols-3 gap-2\">\n                      {(['glass', 'solid', 'gradient'] as const).map((style) => (\n                        <button\n                          key={style}\n                          type=\"button\"\n                          onClick={() => setBranding({ ...branding, cardStyle: style })}\n                          className={`p-3 rounded-xl border transition-all text-sm capitalize ${\n                            branding.cardStyle === style\n                              ? 'border-primary bg-primary/10 text-primary'\n                              : 'border-white/10 bg-white/5 text-muted-foreground hover:border-white/20'\n                          }`}\n                          data-testid={`card-style-${style}`}\n                        >\n                          {style}\n                        </button>\n                      ))}\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-3\">\n                    <Label className=\"text-muted-foreground\">Background Theme</Label>\n                    <div className=\"grid grid-cols-2 gap-2\">\n                      {gradientPresets.map((preset) => (\n                        <button\n                          key={preset.name}\n                          type=\"button\"\n                          onClick={() => setBranding({ ...branding, backgroundGradient: preset.value })}\n                          className={`p-3 rounded-xl border transition-all text-sm ${\n                            branding.backgroundGradient === preset.value\n                              ? 'border-primary ring-2 ring-primary/20'\n                              : 'border-white/10 hover:border-white/20'\n                          }`}\n                          style={{ background: preset.value }}\n                          data-testid={`bg-theme-${preset.name.toLowerCase()}`}\n                        >\n                          <span className=\"text-white/80\">{preset.name}</span>\n                        </button>\n                      ))}\n                    </div>\n                  </div>\n\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <Label className=\"text-white\">Enable Animations</Label>\n                      <p className=\"text-xs text-muted-foreground\">Smooth transitions and effects</p>\n                    </div>\n                    <Switch\n                      checked={branding.animationsEnabled}\n                      onCheckedChange={(checked) => setBranding({ ...branding, animationsEnabled: checked })}\n                      data-testid=\"switch-animations\"\n                    />\n                  </div>\n\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <Label className=\"text-white\">Show \"Powered by MnetiFi\"</Label>\n                      <p className=\"text-xs text-muted-foreground\">Display attribution in footer</p>\n                    </div>\n                    <Switch\n                      checked={branding.showPoweredBy}\n                      onCheckedChange={(checked) => setBranding({ ...branding, showPoweredBy: checked })}\n                      data-testid=\"switch-powered-by\"\n                    />\n                  </div>\n                </div>\n              </GlassPanel>\n            </TabsContent>\n          </Tabs>\n        </div>\n\n        <div className=\"lg:sticky lg:top-6\">\n          <GlassPanel size=\"sm\" className=\"mb-4\">\n            <div className=\"flex items-center justify-between gap-2\">\n              <div className=\"flex items-center gap-2\">\n                <Eye size={16} className=\"text-muted-foreground\" />\n                <span className=\"text-sm text-muted-foreground\">Live Preview</span>\n              </div>\n              <span className=\"text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400\">\n                {previewDevice === 'mobile' ? 'Mobile' : 'Desktop'}\n              </span>\n            </div>\n          </GlassPanel>\n\n          <div \n            className={`relative rounded-2xl overflow-hidden border border-white/10 ${\n              previewDevice === 'mobile' ? 'max-w-[375px] mx-auto' : 'w-full'\n            }`}\n            style={{ \n              background: branding.backgroundGradient,\n              minHeight: previewDevice === 'mobile' ? '667px' : '500px'\n            }}\n          >\n            <div className=\"absolute inset-0 overflow-hidden\">\n              <div className=\"absolute -top-1/2 -left-1/2 w-[800px] h-[800px] rounded-full opacity-30 blur-3xl\"\n                style={{ background: `radial-gradient(circle, ${branding.primaryColor}30 0%, transparent 70%)` }} \n              />\n              <div className=\"absolute -bottom-1/2 -right-1/2 w-[600px] h-[600px] rounded-full opacity-20 blur-3xl\"\n                style={{ background: `radial-gradient(circle, ${branding.secondaryColor}30 0%, transparent 70%)` }}\n              />\n            </div>\n\n            <div className=\"relative p-6 h-full flex flex-col\">\n              <AnimatePresence mode=\"wait\">\n                <motion.div\n                  key=\"preview-content\"\n                  initial={branding.animationsEnabled ? { opacity: 0, y: 20 } : false}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ duration: 0.5 }}\n                  className=\"flex-1\"\n                >\n                  <div \n                    className={`p-6 rounded-2xl ${\n                      branding.cardStyle === 'glass' \n                        ? 'bg-white/10 backdrop-blur-xl border border-white/20' \n                        : branding.cardStyle === 'solid'\n                        ? 'bg-slate-900/90 border border-white/10'\n                        : ''\n                    }`}\n                    style={branding.cardStyle === 'gradient' ? {\n                      background: `linear-gradient(135deg, ${branding.primaryColor}20, ${branding.secondaryColor}20)`,\n                      border: '1px solid rgba(255,255,255,0.1)'\n                    } : {}}\n                  >\n                    <div className=\"text-center mb-6\">\n                      {branding.logo ? (\n                        <img\n                          src={branding.logo}\n                          alt=\"Logo\"\n                          className=\"h-10 mx-auto mb-3 object-contain\"\n                          onError={(e) => { e.currentTarget.style.display = 'none'; }}\n                        />\n                      ) : (\n                        <div className=\"flex items-center justify-center gap-2 mb-3\">\n                          <div\n                            className=\"w-8 h-8 rounded-lg flex items-center justify-center\"\n                            style={{ backgroundColor: `${branding.primaryColor}20` }}\n                          >\n                            <Wifi size={18} style={{ color: branding.primaryColor }} />\n                          </div>\n                          <span\n                            className=\"text-xl font-bold\"\n                            style={{\n                              background: `linear-gradient(135deg, ${branding.primaryColor}, ${branding.secondaryColor})`,\n                              WebkitBackgroundClip: 'text',\n                              WebkitTextFillColor: 'transparent',\n                            }}\n                          >\n                            {tenant?.name || \"Your ISP\"}\n                          </span>\n                        </div>\n                      )}\n                      \n                      {branding.tagline && (\n                        <p className=\"text-white/60 text-sm mb-1\">{branding.tagline}</p>\n                      )}\n                      <p className=\"text-white/80 text-sm\">{branding.welcomeMessage || \"Connect to Wi-Fi\"}</p>\n                    </div>\n\n                    <div className=\"space-y-3 mb-6\">\n                      <p className=\"text-xs text-white/50 uppercase tracking-wider\">Choose Your Plan</p>\n                      {samplePlans.map((plan, index) => (\n                        <motion.div\n                          key={plan.id}\n                          initial={branding.animationsEnabled ? { opacity: 0, x: -20 } : false}\n                          animate={{ opacity: 1, x: 0 }}\n                          transition={{ delay: index * 0.1 }}\n                          className={`p-3 rounded-xl cursor-pointer transition-all ${\n                            branding.cardStyle === 'glass'\n                              ? 'bg-white/5 hover:bg-white/10 border border-white/10'\n                              : branding.cardStyle === 'solid'\n                              ? 'bg-slate-800/50 hover:bg-slate-800/70 border border-white/5'\n                              : 'hover:bg-white/5 border border-white/10'\n                          }`}\n                        >\n                          <div className=\"flex items-center justify-between gap-2\">\n                            <div>\n                              <p className=\"text-white text-sm font-medium\">{plan.name}</p>\n                              <p className=\"text-white/50 text-xs\">{formatDuration(plan.durationSeconds)}</p>\n                            </div>\n                            <span\n                              className=\"text-lg font-bold\"\n                              style={{\n                                background: `linear-gradient(135deg, ${branding.primaryColor}, ${branding.secondaryColor})`,\n                                WebkitBackgroundClip: 'text',\n                                WebkitTextFillColor: 'transparent',\n                              }}\n                            >\n                              {formatPrice(plan.price)}\n                            </span>\n                          </div>\n                        </motion.div>\n                      ))}\n                    </div>\n\n                    <motion.button\n                      whileHover={branding.animationsEnabled ? { scale: 1.02 } : undefined}\n                      whileTap={branding.animationsEnabled ? { scale: 0.98 } : undefined}\n                      className=\"w-full py-3 rounded-xl text-white font-medium transition-all\"\n                      style={gradientStyle}\n                    >\n                      <span className=\"flex items-center justify-center gap-2\">\n                        <Check size={18} />\n                        Select Plan\n                      </span>\n                    </motion.button>\n                  </div>\n\n                  {(branding.supportEmail || branding.supportPhone) && (\n                    <div className=\"mt-4 text-center\">\n                      <p className=\"text-white/40 text-xs mb-1\">Need help?</p>\n                      <div className=\"flex items-center justify-center gap-3 text-xs\">\n                        {branding.supportEmail && (\n                          <span className=\"flex items-center gap-1 text-white/60\">\n                            <Mail size={12} />\n                            {branding.supportEmail}\n                          </span>\n                        )}\n                        {branding.supportPhone && (\n                          <span className=\"flex items-center gap-1 text-white/60\">\n                            <Phone size={12} />\n                            {branding.supportPhone}\n                          </span>\n                        )}\n                      </div>\n                    </div>\n                  )}\n\n                  {branding.footerText && (\n                    <p className=\"mt-4 text-center text-white/40 text-xs\">\n                      {branding.footerText}\n                    </p>\n                  )}\n\n                  {branding.showPoweredBy && (\n                    <p className=\"mt-4 text-center text-white/30 text-xs\">\n                      Powered by MnetiFi\n                    </p>\n                  )}\n                </motion.div>\n              </AnimatePresence>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":28701,"size_tokens":null},"client/src/pages/superadmin-sms-settings.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { \n  MessageSquare, \n  Send, \n  RefreshCw, \n  CheckCircle2, \n  XCircle,\n  Coins,\n  Phone\n} from \"lucide-react\";\nimport { GlassPanel } from \"@/components/glass-panel\";\nimport { GlassInput } from \"@/components/glass-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\ninterface SmsBalance {\n  success: boolean;\n  balance?: string;\n  error?: string;\n}\n\ninterface SmsTestResult {\n  success: boolean;\n  messageId?: string;\n  cost?: string;\n  balance?: string;\n  error?: string;\n}\n\nexport default function SuperAdminSmsSettingsPage() {\n  const { toast } = useToast();\n  const [testPhone, setTestPhone] = useState(\"\");\n\n  const { data: balance, isLoading: balanceLoading, refetch: refetchBalance } = useQuery<SmsBalance>({\n    queryKey: [\"/api/superadmin/sms/balance\"],\n  });\n\n  const testSmsMutation = useMutation({\n    mutationFn: async (phone: string) => {\n      const response = await apiRequest(\"POST\", \"/api/superadmin/sms/test\", { phone });\n      return response.json() as Promise<SmsTestResult>;\n    },\n    onSuccess: (data) => {\n      if (data.success) {\n        toast({\n          title: \"Test SMS Sent\",\n          description: `Message ID: ${data.messageId}. Cost: ${data.cost} credits.`,\n        });\n        refetchBalance();\n      } else {\n        toast({\n          title: \"SMS Failed\",\n          description: data.error || \"Failed to send test SMS\",\n          variant: \"destructive\",\n        });\n      }\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to send test SMS\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleTestSms = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!testPhone) {\n      toast({\n        title: \"Error\",\n        description: \"Please enter a phone number\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    testSmsMutation.mutate(testPhone);\n  };\n\n  // SMS is configured if we can get a successful balance response from the server\n  const isConfigured = balance?.success === true;\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"superadmin-sms-settings-page\">\n      <div>\n        <h1 className=\"text-2xl font-bold text-white\">SMS Settings</h1>\n        <p className=\"text-muted-foreground\">\n          Platform SMS configuration for OTP verification and notifications\n        </p>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center gap-3 mb-6\">\n            <div className=\"p-2 rounded-lg bg-cyan-500/20\">\n              <MessageSquare size={20} className=\"text-cyan-400\" />\n            </div>\n            <div>\n              <h2 className=\"text-lg font-semibold text-white\">SMS Provider Status</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Mobitech Technologies Integration\n              </p>\n            </div>\n          </div>\n\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between p-4 rounded-xl bg-white/5 border border-white/10\">\n              <div className=\"flex items-center gap-3\">\n                <span className=\"text-muted-foreground\">Provider</span>\n              </div>\n              <Badge className=\"bg-cyan-500/20 text-cyan-400 border-0\">\n                Mobitech Technologies\n              </Badge>\n            </div>\n\n            <div className=\"flex items-center justify-between p-4 rounded-xl bg-white/5 border border-white/10\">\n              <div className=\"flex items-center gap-3\">\n                <span className=\"text-muted-foreground\">Sender Name</span>\n              </div>\n              <Badge className=\"bg-purple-500/20 text-purple-400 border-0\">\n                MNETIFI\n              </Badge>\n            </div>\n\n            <div className=\"flex items-center justify-between p-4 rounded-xl bg-white/5 border border-white/10\">\n              <div className=\"flex items-center gap-3\">\n                <span className=\"text-muted-foreground\">Status</span>\n              </div>\n              {balanceLoading ? (\n                <Badge className=\"bg-gray-500/20 text-gray-400 border-0\">\n                  <RefreshCw size={12} className=\"mr-1 animate-spin\" />\n                  Checking...\n                </Badge>\n              ) : balance?.success ? (\n                <Badge className=\"bg-green-500/20 text-green-400 border-0\">\n                  <CheckCircle2 size={12} className=\"mr-1\" />\n                  Connected\n                </Badge>\n              ) : (\n                <Badge className=\"bg-red-500/20 text-red-400 border-0\">\n                  <XCircle size={12} className=\"mr-1\" />\n                  Not Configured\n                </Badge>\n              )}\n            </div>\n          </div>\n        </GlassPanel>\n\n        <GlassPanel size=\"md\">\n          <div className=\"flex items-center gap-3 mb-6\">\n            <div className=\"p-2 rounded-lg bg-green-500/20\">\n              <Coins size={20} className=\"text-green-400\" />\n            </div>\n            <div>\n              <h2 className=\"text-lg font-semibold text-white\">SMS Credits</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                Current account balance\n              </p>\n            </div>\n          </div>\n\n          <div className=\"flex flex-col items-center justify-center py-8\">\n            {balanceLoading ? (\n              <RefreshCw size={32} className=\"animate-spin text-muted-foreground\" />\n            ) : balance?.success ? (\n              <>\n                <div className=\"text-4xl font-bold text-white mb-2\">\n                  {parseFloat(balance.balance || \"0\").toLocaleString()}\n                </div>\n                <p className=\"text-muted-foreground\">Available Credits</p>\n              </>\n            ) : (\n              <>\n                <XCircle size={32} className=\"text-red-400 mb-2\" />\n                <p className=\"text-muted-foreground text-center\">\n                  {balance?.error || \"API key not configured\"}\n                </p>\n              </>\n            )}\n          </div>\n\n          <Button\n            variant=\"outline\"\n            className=\"w-full\"\n            onClick={() => refetchBalance()}\n            disabled={balanceLoading}\n            data-testid=\"button-refresh-balance\"\n          >\n            <RefreshCw size={16} className={`mr-2 ${balanceLoading ? \"animate-spin\" : \"\"}`} />\n            Refresh Balance\n          </Button>\n        </GlassPanel>\n      </div>\n\n      <GlassPanel size=\"md\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <div className=\"p-2 rounded-lg bg-orange-500/20\">\n            <Send size={20} className=\"text-orange-400\" />\n          </div>\n          <div>\n            <h2 className=\"text-lg font-semibold text-white\">Test SMS</h2>\n            <p className=\"text-sm text-muted-foreground\">\n              Send a test message to verify the integration\n            </p>\n          </div>\n        </div>\n\n        <form onSubmit={handleTestSms} className=\"space-y-4\">\n          <div className=\"flex gap-4\">\n            <div className=\"flex-1\">\n              <GlassInput\n                label=\"Phone Number\"\n                placeholder=\"+254 7XX XXX XXX\"\n                value={testPhone}\n                onChange={(e) => setTestPhone(e.target.value)}\n                icon={<Phone size={16} />}\n                data-testid=\"input-test-phone\"\n              />\n            </div>\n            <div className=\"flex items-end\">\n              <Button\n                type=\"submit\"\n                className=\"gradient-btn\"\n                disabled={testSmsMutation.isPending || !balance?.success}\n                data-testid=\"button-send-test-sms\"\n              >\n                <Send size={16} className=\"mr-2\" />\n                {testSmsMutation.isPending ? \"Sending...\" : \"Send Test\"}\n              </Button>\n            </div>\n          </div>\n\n          <div className=\"p-4 rounded-xl bg-cyan-500/10 border border-cyan-500/20\">\n            <p className=\"text-sm text-muted-foreground\">\n              This will send a test OTP message to the specified phone number. \n              SMS credits will be deducted from your balance.\n            </p>\n          </div>\n        </form>\n      </GlassPanel>\n\n      <GlassPanel size=\"md\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <div className=\"p-2 rounded-lg bg-purple-500/20\">\n            <MessageSquare size={20} className=\"text-purple-400\" />\n          </div>\n          <div>\n            <h2 className=\"text-lg font-semibold text-white\">SMS Use Cases</h2>\n            <p className=\"text-sm text-muted-foreground\">\n              Automated SMS notifications for ISP accounts\n            </p>\n          </div>\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          <div className=\"p-4 rounded-xl bg-white/5 border border-white/10\">\n            <h3 className=\"font-medium text-white mb-2\">OTP Verification</h3>\n            <p className=\"text-sm text-muted-foreground\">\n              Two-factor authentication codes for ISP admin login and sensitive operations\n            </p>\n          </div>\n\n          <div className=\"p-4 rounded-xl bg-white/5 border border-white/10\">\n            <h3 className=\"font-medium text-white mb-2\">Payment Confirmations</h3>\n            <p className=\"text-sm text-muted-foreground\">\n              Subscription payment receipts and billing confirmations for ISPs\n            </p>\n          </div>\n\n          <div className=\"p-4 rounded-xl bg-white/5 border border-white/10\">\n            <h3 className=\"font-medium text-white mb-2\">Subscription Reminders</h3>\n            <p className=\"text-sm text-muted-foreground\">\n              Expiry warnings for ISP accounts before their subscription ends\n            </p>\n          </div>\n\n          <div className=\"p-4 rounded-xl bg-white/5 border border-white/10\">\n            <h3 className=\"font-medium text-white mb-2\">Account Notifications</h3>\n            <p className=\"text-sm text-muted-foreground\">\n              Suspension notices, reactivation confirmations, and important updates\n            </p>\n          </div>\n        </div>\n      </GlassPanel>\n\n      <GlassPanel size=\"md\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <div className=\"p-2 rounded-lg bg-yellow-500/20\">\n            <RefreshCw size={20} className=\"text-yellow-400\" />\n          </div>\n          <div>\n            <h2 className=\"text-lg font-semibold text-white\">Delivery Reports Webhook</h2>\n            <p className=\"text-sm text-muted-foreground\">\n              Configure Mobitech to send delivery reports\n            </p>\n          </div>\n        </div>\n\n        <div className=\"space-y-4\">\n          <div className=\"p-4 rounded-xl bg-white/5 border border-white/10\">\n            <p className=\"text-sm text-muted-foreground mb-2\">Webhook URL:</p>\n            <code className=\"block p-3 rounded-lg bg-black/30 text-cyan-400 text-sm break-all\">\n              {typeof window !== 'undefined' ? `${window.location.origin}/api/webhooks/sms/delivery` : '/api/webhooks/sms/delivery'}\n            </code>\n          </div>\n\n          <div className=\"p-4 rounded-xl bg-yellow-500/10 border border-yellow-500/20\">\n            <p className=\"text-sm text-muted-foreground\">\n              Configure this webhook URL in your Mobitech Technologies dashboard to receive \n              real-time delivery reports for sent messages.\n            </p>\n          </div>\n        </div>\n      </GlassPanel>\n    </div>\n  );\n}\n","path":null,"size_bytes":11797,"size_tokens":null}},"version":2}